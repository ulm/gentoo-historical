<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/java/Attic/tiger-faq.xml,v 1.19 2006/04/23 23:44:13 nichoj Exp $ -->

<guide link="/proj/en/java/tiger-faq.xml" lang="en">
<title>Gentoo Java 1.5 FAQ</title>

<author title="Author">
  <mail link="nichoj@gentoo.org">Joshua Nichols</mail>
</author>

<author title="Author">
  <mail link="karltk@gentoo.org">Karl Trygve Kalleberg</mail>
</author>

<abstract>
This FAQ covers issues related to Java 1.5 support on Gentoo.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.0</version>
<date>2006-04-23</date>

<chapter>
<title>Why is Java 1.5 still hard-masked?</title>
<section>
<body>

<p>
  Java 1.5 is still hard masked because there are a number of issues which 
  make it unsafe to use a 1.5 JDK as your system VM.
</p>

<p>
  The first issue with Java 1.5 is backwards compatibility. If 
  you compile packages with a 1.5 JDK, the default behavior is that 
  the compiled classes can only be used in a 1.5 or above VM.
</p>

<p>
  The Java team is working on a solution to this which will compile classes for the lowest possible VM, as is detailed below.
</p>

<p>
  The other significant issue is that there are packages which are not 
  compatible with JDK 1.5, as they currently exist in the portage tree. For 
  example, several abstract classes and interfaces now have new abstract 
  methods in 1.5. This means that packages would need to be patched to 
  override these abstract methods. Failing that, you could also try using 
  1.4 to compile the offending package.  However, due to the backwards 
  compatibility problem mentioned above, you wouldn't be able to use 
  external libraries, because they were compiled only for 1.5.
</p>

</body>
</section>
</chapter>


<chapter>
<title>How can I safely use Java 1.5 without breaking my system?</title>
<section>
<body>
 <p>
   As discussed already, you should not use a 1.5 JDK as your system VM. 
   However, it is safe to use as your user's VM.
 </p>

  <note>
    If you plan on using Java 1.5, we suggest you try the overlay described in 
    the next section.
  </note>

  <p>
    The first step is to emerge sun-jdk-1.5 and any 1.4 JDK, if you have not 
    already done so.
  </p>

<pre caption="Emerge JDKs"><comment>You need to unmask sun-jdk-1.5 first.</comment>
# echo "=dev-java/sun-jdk-1.5*" >> /etc/portage/package.unmask
# echo "=dev-java/sun-jdk-1.5*" >> /etc/portage/package.keywords
# emerge =sun-jdk-1.5*
<comment>Now emerge a 1.4 JDK. We'll use blackdown in this case.</comment>
# emerge =blackdown-jdk-1.4*
</pre>

<p>
  The next step is to ensure that your system VM is set to a 1.4 JDK.
</p>

<pre caption="Set system VM"><comment>Use java-config to list installed VMs</comment>
# java-config -L
[sun-jdk-1.5.0.05] "Sun JDK 1.5.0.05" (/etc/env.d/java/20sun-jdk-1.5.0.05)
[kaffe-1.1.6] "Kaffe 1.1.6" (/etc/env.d/java/20kaffe-1.1.6)
[blackdown-jdk-1.4.2.02] "Blackdown JDK 1.4.2.02" (/etc/env.d/java/20blackdown-jdk-1.4.2.02)

<comment>Set the system VM to use the 1.4 JDK</comment>
# java-config -S blackdown-jdk-1.4.2.02
System Virtual Machine set
You may want to update your enviroment by running:
        "/usr/sbin/env-update &amp;&amp; source /etc/profile"
# /usr/sbin/env-update &amp;&amp; source /etc/profile
</pre>

  <p>
    Now we need to setup your user VM to sun-jdk-1.5
  </p>

<pre caption="Set user VM"><comment>Use java-config to list installed VMs</comment>
$ java-config -L
[sun-jdk-1.5.0.05] "Sun JDK 1.5.0.05" (/etc/env.d/java/20sun-jdk-1.5.0.05)
[kaffe-1.1.6] "Kaffe 1.1.6" (/etc/env.d/java/20kaffe-1.1.6)
[blackdown-jdk-1.4.2.02] "Blackdown JDK 1.4.2.02" (/etc/env.d/java/20blackdown-jdk-1.4.2.02)

<comment>Set the user VM to sun-jdk-1.5</comment>
$ java-config -s sun-jdk-1.5.0.05
Env files in /home/someuser/.gentoo updated. Source these in your shell's profile.

<comment>Adjust your bash_profile to load Java settings at login</comment>
$ echo "source ~/.gentoo/java-env" >> ~/.bash_profile
<comment>Update the environment of the current terminal</comment>
$ source ~/.gentoo/java-env
</pre>

  <warn>
    Be careful when updating your 1.5 JDK! A current limitation of the current 
    system is that whenever you emerge a JDK, that JDK will be set as the 
    system VM.
  </warn>
</body>
</section>
</chapter>

<chapter>
<title>Is there any work being done to support 1.5 JDK as a system VM?</title>
<section>
<body>
  <p>
    The good news is that work is that support for 1.5 is coming. 
    Some major changes are needed to get Java 1.5 unmasked, and Thomas Mathijs (axxo) 
    has done a huge amount of work to this end in his overlay.
  </p>

  <p>
    Now that work on axxo-overlay is complete, we are working on a new overlay,
    migration-overlay, which provides us with a way to transition from the old 
    system to the new system.
  </p>

  <p>
    The most significant improvements include:
  </p>
  <ul>
    <li>
      Merge-time VM switching (<uri link="http://bugs.gentoo.org/86900">
      #86900</uri>)
    </li>
    <li>
      Merge-time build.xml rewriting (<uri link="http://bugs.gentoo.org/86903">
      #86903</uri>)
    </li>
    <li>
      A new version of java-config.
    </li>
    <li>
      Uses symlinks instead of PATH hacks to choose between user/system VM, 
      which is more flexible.
    </li>
    <li>
      Removal of jikes USE flag, so you can now easily choose between 
      javac, eclipse-ecj, or jikes
    </li>
  </ul>

  <p>
    The most up-to-date documentation for using migration-overlay is
    maintained <uri link="https://projects.gentooexperimental.org/expj/wiki/Using_migration-overlay">here</uri>.
  </p>

  <p>
    The Java documentation has been updated for the usage of this new overlay,
    and is available at:
  </p>

  <ul>
    <li><uri link="http://gentooexperimental.org/svn/java/axxo-overlay/README/docs/java-user.html">User Guide</uri></li>
    <li><uri link="http://gentooexperimental.org/svn/java/axxo-overlay/README/docs/java-devel.html">Developer Guide</uri></li>
  </ul>

  <p>
    Additional material can be found at the following, under the 
    'Migration' section:
  </p>

  <ul>
    <li><uri link="https://projects.gentooexperimental.org/expj/">The ExpJ Wiki</uri></li>
  </ul>

  <p>
    <mail link="java@gentoo.org">We</mail> would really appreciate 
    any comments/suggestions/fixes/patches for this overlay.
  </p>

</body>
</section>

<section>
<title>Why do I need to update portage?</title>
<body>
  <p>
    We need 'phase hooks' provided by newer releases of portage. Basically, 
    these allow you to define functions which get called before each phase 
    (ie src_unpack, src_compile, src_install). The use of these hooks allows 
    us to ensure the right JDK is being used at build-time. 
  </p>
</body>
</section>

<section>
<title>
  Why does digest validation of ebuilds from the overlay fail sometimes?
</title>
<body> 
  <p>
    Sometimes the developers forget to regenerate digest after making 
    changes to the overlay, so the validation fails. You can get around 
    this by using FEATURES="-strict" or running ebuild manifest yourself.
  </p>
</body>
</section>

<section>
<title>When will this be merged into the Portage tree?</title>
<body>
  <p>
    As the overlay needs hooks in Portage, the earliest time we are able
    to deliver to stable users is after 2.0.55 or 2.1 is stable. 
    We've taken a number of measures that will allow us to first 
    introduce these changes into ~arch, before hitting arch.
  </p>

  <p>
    As far as when it will enter ~arch, we do not have a specific timeline. 
    We only have limited manpower to work on the migration, and we want to 
    ensure all the kinks of been worked out. So essentially, it will be ready 
    when it is ready.
  </p>
</body>
</section>

<section>
<title>Where can I find the latest news about the progress of this overlay?</title>
<body>
  <p>
    We recommend you join the 'gentoo-java' mailing list. Any late breaking 
    news will be announced at least there. Details on joining can be found 
    <uri link="http://www.gentoo.org/main/en/lists.xml">here</uri>.
  </p>
</body>
</section>

</chapter>

<chapter>
<title>
  So I went and broke my system by using a 1.5 JDK... how do I fix it?
</title>
<section>
<body>
  <p>
    We recommend people that have been using a 1.5 JDK for a system VM switch 
    over to the migration-overlay. The instructions for using it describe how 
    to make sure everything gets recompiled with a 1.4 JDK.
  </p>
</body>
</section>
</chapter>

</guide>

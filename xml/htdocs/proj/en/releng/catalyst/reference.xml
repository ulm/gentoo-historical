<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>
<!DOCTYPE project SYSTEM "/dtd/project.dtd">
<guide link="/proj/en/releng/catalyst/reference.xml">
<title>Catalyst Reference Manual</title>
<author title="Author"><mail link="drobbins@gentoo.org">
Daniel Robbins</mail>
</author>

<abstract>
Catalyst reference manual, covering (nearly) every aspect of catalyst configuration.
</abstract>

<version>1.0</version>
<date>11 Jan 2004</date>

<chapter>
<title>Introduction</title>
<section>
<body>
<p>This document is intended to be a complete reference for all catalyst targets, spec file options, and all
other aspects of catalyst.</p>
</body>
</section>
</chapter>

<chapter>
	<title>Catalyst target and spec reference</title>
	<section>
	<title>Stage1 Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>stage1</c></p>
	<p><b>Target description:</b> A stage1 tarball, the base component used for building up a Gentoo system.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot, and a stage2 or stage3 "seed" tarball to set up the chroot environment.</p>
	
	<p>The stage1 target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>stage1</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	</table>
	</body>
	</section>
	
	<section>
	<title>Stage2 Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>stage2</c></p>
	<p><b>Target description:</b> A stage2 tarball, a "bootstrapped" version of the stage1 tarball.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot and a stage1 seed tarball.</p>
	
	<p>The stage2 target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>stage2</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	</table>
	</body>
	</section>
	
	<section>
	<title>Stage3 Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>stage3</c></p>
	<p><b>Target description:</b> A stage3 tarball, containing nearly all of a Gentoo Linux base system.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot and a stage2 seed tarball.</p>
	
	<p>The stage3 target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>stage3</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	</table>
	</body>
	</section>

	<section>
	<title>GRP Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>grp</c></p>
	<p><b>Target description:</b> A GRP package set. GRP stands for 'Gentoo Reference Platform' and consists of a set of packages and source tarballs,
	grouped into (optionally) separate directories for easy integration into installation CDs.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot and a stage3 seed tarball.</p>
	
	<p>The GRP target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>grp</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>grp</c></ti><ti>required</ti><ti>list</ti></tr>
	<tr><ti><c>grp/use</c></ti><ti>required</ti><ti>list</ti></tr>
	<tr><ti><c>grp/[grp:x]/type</c></ti><ti>required</ti><ti>string (<c>pkgset</c> or <c>srcset</c>)</ti></tr>
	<tr><ti><c>grp/[grp:x]/packages</c></ti><ti>required</ti><ti>list</ti></tr>
	</table>
	<p><b>Usage notes:</b> The <c>grp</c> variable should define the various sets of packages or sources being built. For example, <c>grp</c> could
	be defined as <c>cd1 cd2 src</c>. Then, for each item (such as <c>cd1</c>, for example) in your <c>grp</c> setting, you will need a <c>grp/cd1/type</c> setting
	which specifies either <c>pkgset</c> or <c>srcset</c> as an argument. If <c>cd1</c> is set up as a <c>pkgset</c>, then the packages
	that you specify will be compiled into <c>.tbz2</c> files and stored in <path>[storedir]/builds/[rel_type]-[mainarch]-[rel_version]/cd1/</path>.
	If <c>cd1</c> is set up as a <c>srcset</c>, then the sources for all the specified packages for <c>cd1</c> will be downloaded and stored in 
	<path>[storedir]/builds/[rel_type]-[mainarch]-[rel_version]/cd1/</path>. And, the specification of the actual packages would be recorded
	in the <c>grp/cd1/packages</c> variable. Every GRP spec file should also have a <c>grp/use</c> setting that should specify all <c>USE</c>
	variables that should be enabled for this GRP set. Here is an example snippet from a GRP spec file:</p>
	<pre caption="GRP spec file snippet">
grp: cd1 cd2 src
grp/use:
	gtk2 gnome kde qt bonobo cdr directfb yada yada yada
grp/cd1/type: pkgset
grp/cd1/packages:
	iptables
	gpm
	rp-pppoe
grp/cd2/type: pkgset
grp/cd2/packages:
	apache
	evolution
	emacs
grp/src/type: srcset
grp/src/packages:
	pcmcia-cs
	wireless-tools
	nvidia-kernel
	nvidia-glx
	</pre>
	</body>
	</section>

	<section>
	<title>Tinderbox Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>tinderbox</c></p>
	<p><b>Target description:</b> The tinderbox is a QA target used to build-test a series of packages.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot and a stage3 seed tarball.</p>
	
	<p>The tinderbox target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>tinderbox</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>tinderbox/use</c></ti><ti>required</ti><ti>list</ti></tr>
	<tr><ti><c>tinderbox/packages</c></ti><ti>required</ti><ti>list</ti></tr>
	</table>

	<p><b>Usage:</b> Here's how the tinderbox works. The specified seed tarball is used to set up the chroot
	environment. Then, <c>rsync</c> is used to create a pristine backup of the chroot environment. The firrst package
	specified in <c>tinderbox/packages</c> is merged, using the <c>USE</c> settings specified in <c>tinderbox/use</c>.
	Provided it builds correctly, catalyst uses <c>rsync</c> to restore the chroot environment to its original pristine
	state.  Then, each successive package specified in <c>tinderbox/packages</c> is merged; each merge is followed by
	a "return to original state" <c>rsync</c> step.</p>

	<p>Because of the "return to original state" <c>rsync</c> step, the tinderbox can detect errors in dependencies
	in certain packages. For a package to compile successfully, it must depend on everything it needs to compile cleanly
	from a pristine stage3 tarball. Also, this tinderbox testing is actually very efficient when <c>pkgcache</c> is enabled
	in <path>/etc/catalyst.conf</path>, because pre-built packages will be used to satisfy any dependencies. This means
	that CPU-hungry builds like <path>xfree</path> will be compiled only once each tinderbox run, provided that <c>pkgcache</c>
	is enabled.</p>

	<p>The tinderbox will continue to build through the complete list of packages specified in <c>tinderbox/packages</c>,
	even if some packages don't build. A build log is created and stored in <path>[storedir]/tmp/[rel_type]-[mainarch]-[rel_version]/[subarch]-tinderbox-[version_stamp]/tmp/tinderbox.log</path>. If a package builds correctly, a line will be recorded in this file that contains the name of the package as specified in <c>tinderbox/packages</c>. If a package does not build correctly, a line will be recorded in this file that contains the name of the package, preceded by a "<c>! </c>". Please note that failures of earlier packages may cause later package builds to fail.</p>

	<p>Besides the <path>/tmp/tinderbox.log</path> file created inside the chroot directory, the tinderbox performs no logging. To log the build
	process, use the <c>script</c> command along with <c>catalyst</c>, as follows:</p>
	<pre caption="Using script with catalyst to log the build process">
# <c>script</c>
Script started, file is typescript
# <c>catalyst -f /foo/bar/oni.spec</c>
# <c>exit</c> Script done, file is typescript
</pre>
	<p>Then, view the <path>typescript</path> file in the current directory for a full log of the build process.</p>
	</body>
	</section>

	<section>
	<title>Livecd-stage1 Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>livecd-stage1</c></p>
	<p><b>Target description:</b> The first preliminary target of LiveCD building, basically a tarball containing a stage3 plus several packages.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot and a stage3 seed tarball.</p>
	
	<p>The livecd-stage1 target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>livecd-stage1</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>livecd-stage1/use</c></ti><ti>required</ti><ti>list</ti></tr>
	<tr><ti><c>livecd-stage1/packages</c></ti><ti>required</ti><ti>list</ti></tr>
	</table>

	<p><b>Usage notes:</b> If you intend to distribute your LiveCD to the general public, please use a reasonably generic seed stage3 so that your
	LiveCD will run on a wide variety of systems. Set <c>livecd-stage1/packages</c> to specify the packages you would like included on your LiveCD,
	and <c>livecd-stage1/use</c> to the <c>USE</c> settings that should be used when building said packages.</p>
	</body>
	</section>

	<section>
	<title>Livecd-stage2 Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>livecd-stage2</c></p>
	<p><b>Target description:</b> The second preliminary target of LiveCD building, containing a livecd-stage1 plus kernel and initrd sets
	to be used for booting the CD image.</p>
	<p><b>Requirements for building:</b> A Portage tree snapshot and a livecd-stage1 seed tarball.</p>
	
	<p>The livecd-stage2 target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>livecd-stage1</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>boot/kernel</c></ti><ti>required</ti><ti>list</ti></tr>
	<tr><ti><c>boot/kernel/[boot/kernel:x]/sources</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>boot/kernel/[boot/kernel:x]/config</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>livecd/runscript</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>livecd/archscript</c></ti><ti>required</ti><ti>string</ti></tr>
	</table>

	<p><b>runscripts and archscripts:</b> The <c>livecd/runscript</c> and <c>livecd/archscript</c> variables point to 
	shell scripts that handle various chores that require direct shell interaction. For the purposes of the 
	<c>livecd-stage2</c> target, the archscript and runscript are used to build kernel(s) for the LiveCD.</p>
	
	<p>The reason why we have two scripts (runscript and archscript) are so that we can properly separate steps
	arch-independent from arch-specific steps. For example, kernel building is typically handled by genkernel,
	which provides a generic and arch-independent interface for kernel and initrd-building. Because the interface
	is generic in nature, it can be placed in the runscript, which in turn can be shared between all architectures.</p>

	<p><b>run target details:</b> When the livecd-stage2 target runs, the livecd-stage1 tarball specified is unpacked to a chroot
	directory. Then, the <c>run</c> target of the <c>archscript</c> is executed, which typically doesn't do anything except call
	the generic
	<c>run</c> target of the arch-independent <c>runscript</c>. The <c>run</c> target of the runscript is responsible for
	building kernels, and does this by using the <path>sys-kernel/genkernel</path> package, which it merges in the
	chroot, and then calls, passing each kernel configuration you specify in the spec file as an argument. The resultant
	kernels and initrds are stored in the <path>/tmp/binaries</path> directory inside the chroot, which is actually a
	bind-mount that maps to <path>[storedir]/builds/[rel_type]-[mainarch]-[rel_version]/livecd-stage2-[subarch]-[version_stamp]/binaries/</path>.
	The <c>livecd-stage3</c> target will "pull" from this directory and place the already-built kernels and initrds on the LiveCD in the
	proper place.</p>
	
	<p><b>Usage notes:</b> The most
	recent unmasked version of genkernel will be merged by the runscript; please make sure that version 3.0.1 or later of genkernel is unmasked in your 
	Portage tree snapshot.</p>
	
	<p><b>Using the kernel-related variables in the spec file:</b> For each name in the <c>boot/kernel</c> variable in the spec file (such as <c>gentoo</c>, for example), this target will
	use <c>genkernel</c> to build a kernel and initrd. With the example <c>boot/kernel</c> entry of <c>gentoo</c>, catalyst
	will use the <c>boot/kernel/gentoo/sources</c> setting to determine what kernel sources to merge for this particular
	kernel build (an example setting would be <c>=sys-kernel/gentoo-dev-sources-2.6.0</c>.) Then, the kernel config pointed
	to by <c>boot/kernel/gentoo/config</c> will be copied into the chroot and used to build said kernel. Here is an example
	snippet from a livecd-stage2 spec file that tells catalyst to build two kernel/initrd sets, one called <c>gentoo</c> and
	another called <c>smp</c>:
	</p>
	<pre caption="Livecd-stage2 spec snippet">
boot/kernel: gentoo smp
boot/kernel/gentoo/sources: =sys-kernel/gentoo-dev-sources-2.6.0
boot/kernel/gentoo/config: /path/to/gentoo.config
boot/kernel/gentoo/sources: =sys-kernel/special-smp-sources-2.6.0
boot/kernel/gentoo/config: /path/to/smp.config
	</pre>
	<p>Using two scripts eases maintenance and synchronizing improvements to LiveCDs between architectures. You can
	find example runscripts and archscripts in the <path>examples/livecd/runscript</path> directory in the catalyst
	source tree.</p>
	
	</body>
	</section>
<section>
	<title>Livecd-stage3 Target Reference</title>
	<body>
	<p><b>Target name:</b> <c>livecd-stage3</c></p>
	<p><b>Target description:</b> The third target of LiveCD building, used to create the final runtime boot
	image and a working skeleton ISO tree.</p>
	
	<p><b>Requirements for building:</b> A livecd-stage2 seed tarball.</p>
	
	<p>The livecd-stage3 target uses the following settings:</p>
	<table>
	<tr><th>variable</th><th>usage</th><th>format</th></tr>
	<tr><ti><c>subarch</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>version_stamp</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>target</c></ti><ti>required</ti><ti><c>livecd-stage1</c></ti></tr>
	<tr><ti><c>rel_type</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>rel_version</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>snapshot</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>source_subpath</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>boot/kernel</c></ti><ti>required</ti><ti>list</ti></tr>
	<tr><ti><c>boot/kernel/[boot/kernel:x]/sources</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>boot/kernel/[boot/kernel:x]/config</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>livecd/archscript</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>livecd/runscript</c></ti><ti>required</ti><ti>string</ti></tr>
	<tr><ti><c>livecd/empty</c></ti><ti>optional</ti><ti>list</ti></tr>
	<tr><ti><c>livecd/rm</c></ti><ti>optional</ti><ti>list</ti></tr>
	<tr><ti><c>livecd/unmerge</c></ti><ti>optional</ti><ti>list</ti></tr>
	</table>
	
	</body>
	</section>
</chapter>
</guide>

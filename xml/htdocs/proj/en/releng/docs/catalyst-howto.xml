<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/releng/docs/Attic/catalyst-howto.xml,v 1.2 2004/04/09 01:59:46 zhen Exp $ -->
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">


<guide link="/proj/en/releng/docs/cascading-profiles.xml">
<title>Catalyst HOWTO</title>

<author title="Author">
	<mail link="zhen@gentoo.org">John Davis</mail>
</author>

<abstract>
	The purpose of this guide is to explain how to use Catalyst to
	build custom LiveCDs, stages, and other release components.
</abstract>

<license/>

<version>DRAFT</version>
<date>08 April 2004</date>

<chapter>
	<title>Introduction</title>
	
	<section>
		<title>What is Catalyst?</title>
		<body>
			<p>Some of you may be asking, "what is Catalyst?". Simply put,
			Catalyst is the Gentoo Release Engineering Team's release metatool.
			The releng team uses Catalyst to build everything from stages to LiveCDs,
			along with some other things in between. So what does this have to do with
			you as the user? Choice is a hallmark of the Gentoo experience. Everything
			that Gentoo does allows for the user to make the final choice. Gentoo does not lock
			you into a specific GUI, like KDE or GNOME, we let you choose. With Catalyst, 
			Gentoo no longer locks you into what you use to create the soul of your system.
			Catalyst provides the end to the means of complete customization by allowing
			you to customize the very installation media that is used to install Gentoo.
			If you want to change what is in the installation stages or create your
			own bootable LiveCDs then Catalyst is what you have been waiting for. </p>
		</body>
	</section>

	<section>
		<title>Goals of this Guide</title>
		<body>
			<p>Coupled with the <uri link="/proj/en/releng/catalyst/reference.xml">Catalyst Reference Manual</uri>,
			this guide will provide all of the information and tools needed to get started
			building release media using Catalyst. The following topics will be covered: </p>

			<ul>
				<li>Catalyst installation and setup</li>
				<li>The Basics - snapshots and specfiles</li>
				<li>Building installation stages</li>
				<li>Advanced stage customization - tweaking the system profile</li>
				<li>Building bootable LiveCDs</li>
				<li>Advanced LiveCD customization - GUI LiveCDs</li>
				<li>Building PackageCDs</li>
				<li>Setting up a Tinderbox</li>
			</ul>

			<p>This document, like Catalyst, is under heavy development. If there are any feature requests
			or bugs with either, please report them to the <uri link="http://bugs.gentoo.org">Gentoo Bug Database</uri>. 
			</p>
		</body>
	</section>

</chapter>

<chapter>
	<title>Installation</title>
	<section>
		<title>Catalyst Installation</title>
		<body>
			<p>Catalyst is simple to install; simply run <c>emerge catalyst</c> as root from your command line: </p>
			<pre caption="Emerging Catalyst">
<c># emerge catalyst</c>
			</pre>

			<p>If you have access to Gentoo CVS, you can find the latest and greatest CVS version
			of catalyst at <path>gentoo/src/catalyst</path>. </p>

		</body>
	</section>

	<section>
		<title>Catalyst Setup</title>
		<body>
			<p>Once Catalyst is installed, the first thing that you will want to do is edit 
			<path>/etc/catalyst/catalyst.conf</path>. The default <i>catalyst.conf</i> will be
			similar to the following: </p>

			<pre caption="Example catalyst.conf">
# Copyright 1999-2004 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/releng/docs/Attic/catalyst-howto.xml,v 1.2 2004/04/09 01:59:46 zhen Exp $

# Simple desriptions of catalyst settings. Please refer to the online
# documentation for more information.

# distdir specifies where your distfiles are located. This setting should
# work fine for most default installations.
distdir="/usr/portage/distfiles"

# options set different build-time options for catalyst. Some examples are:
# ccache = enables build time ccache support (highly recommended)
# pkgcache = keeps a tbz2 of every built package (useful if your build stops prematurely)
# distcc = enable distcc support for building. You have to set distcc_hosts in your spec file.
options="ccache pkgcache"

# sharedir specifies where all of the catalyst runtime executables are. Most users do
# not need to change this.
sharedir="/usr/lib/catalyst"

# envscript allows users to set options such as http proxies, MAKEOPTS, GENTOO_MIRRORS,
# or any other environment variables needed for building.
# The envscript file sets environment variables like so:
# export FOO="bar"

#envscript="/root/catalyst-env.sh"
			</pre>
			
			<ul>
				<li><b>distdir</b> is the directory where your distfiles are kept (the default is
				fine for most Gentoo systems).</li>
				<li><b>options</b> accepts <i>ccache</i>, <i>pkgcache</i>, and <i>distcc</i> as valid keys.
				<i>ccache</i> and <i>pkgcache</i> are highly recommended for most systems, and <i>distcc</i>
				is recommended if distcc is already available on the network. For a more complete listing
				of each options key, please consult the
				<uri link="/proj/en/releng/catalyst/reference.xml">Catalyst Reference Manual</uri>. </li>
				<li><b>sharedir</b> is the location of the Catalyst runtime. It is not recommended
				that this be changed unless you know absolutely sure what you are doing. </li>
				<li><b>envscript</b> can be set to a script where certain environment variables, http proxies
				for example, can be set.</li>
			</ul>

			<p>An example <i>envscript</i> could look like the following: </p>
			
			<pre caption="Example envscript">
# my envscript
export GENTOO_MIRRORS="http://gentoo.mirrors.pair.com"
export MAKEOPTS="-j4"
			</pre>

			<note>Do not set CFLAGS, CXXFLAGS, LDFLAGS, CHOST, or any other compilation specific
			environment variables in the envscript as it may have undesired effects on the building process.
			</note>

			<p>After editing <path>/etc/catalyst/catalyst.conf</path> to your liking, sit back, relax, and
			read on grasshopper. If you are interested in researching what each option does in depth,
			the <uri link="/proj/en/releng/catalyst/reference.xml">Catalyst Reference Manual</uri> is a great
			place to start. </p>
			
			<note>If you keep your Catalyst config file in a location other than
			<path>/etc/catalyst/catalyst.conf</path>, you will have to set the environment
			variable <i>clst_conf</i> to the location of your Catalyst config file. This can be done
			like so: <c>export clst_conf="/path/to/my/catalyst_config"</c>. </note>
			
		</body>
	</section>
</chapter>

<chapter>
	<title>The Basics - Specfiles and Snapshots</title>
	<section>
		<title>Catalyst Specfiles</title>
		<body>
			<p>Catalyst without a specfile is possible, but only if you have an affinity for carpal tunnel
			syndrome. For example, if you wanted to build a stage1 installation tarball, you would have to call
			Catalyst with the following options via the command line: </p>
			
			<pre caption="Using Catalyst the long way">
# catalyst subarch=x86 version_stamp=20040403 target=stage1 profile=default-x86-2004.0 rel_type=default snapshot=20040403 source_subpath=default-x86-2004.0/stage2-x86-20040218
			</pre>

			<p>I think that you catch my drift. Now, the same can be accomplished using a specfile for that stage1
			installation stage: </p>

			<pre caption="Using Catalyst with a spec file">
# catalyst -f x86-stage1.spec

<codenote>below is the contents of x86-stage1.spec</codenote>

subarch: x86
version_stamp: 20040403
target: stage1
profile: default-x86-2004.0
rel_type: default
snapshot: 20040403
source_subpath: default-x86-2004.0/stage2-x86-20040218
			</pre>
	
			<p>So what do all of these mean? Again, more indepth information can be found in the
			<uri link="/proj/en/releng/catalyst/reference.xml">Catalyst Reference Manual</uri>. A quick
			synopsis is as follows: </p>
			
			<table>
				<tr>
					<th>Variable</th>
					<th>Definition</th>
				</tr>
				<tr>
					<ti>subarch</ti>
					<ti>The subarch that is being built. Examples are x86, athlon-xp, or sparc64</ti>
				</tr>
				<tr>
					<ti>version_stamp</ti>
					<ti>A version stamp that uniqely identifies the build. Can be a date, such as 20040403,
					or a version identifier, such as 2004.1</ti>
				</tr>
				<tr>
					<ti>target</ti>
					<ti>What target Catalyst is to build</ti>
				</tr>
				<tr>
					<ti>profile</ti>
					<ti>What system profile Catalyst uses to build the media. It can take values such as default-x86-2004.0
					or default-linux/x86/2004.0.</ti>
				</tr>
				<tr>
					<ti>rel_type</ti>
					<ti>The type of build that Catalyst should do. Most of the time it will be default,
					but it could also be hardened or selinux for their respective buildtypes</ti>
				</tr>
				<tr>
					<ti>snapshot</ti>
					<ti>Specifies which Portage snapshot Catalyst will use</ti>
				</tr>
				<tr>
					<ti>source_subpath</ti>
					<ti>Where Catalyst can find the seed stage for the target to be built.</ti>
				</tr>
			</table>
			
			<p>Those options make up the core of any specfile. Different targets will require some more
			specialized options stacked on top of the default options, most notably the GRP, livecd-stage1, and
			livecd-stage2 targets. Each of those targets and their specfiles will be covered in their respective
			parts of this guide. </p>

			<p>There do exist some global, but not required, specfile options. The most recent version
			of Catalyst only includes one at this time, and it is for distcc build support.
			The <i>distcc_hosts</i> option specifies which hosts distcc should use for distributed
			building: </p>

			<pre caption="distcc_hosts specfile option">
distcc_hosts: 127.0.0.1 192.168.0.2 192.168.0.3 192.168.0.4/3
			</pre>

			<p>Ok, so now we have the specfile basics. Next, add a generous heaping of Portage snapshot,
			and preheat your CPU to 350. </p>
			
		</body>
	</section>

	<section>
		<title>Portage Snapshots</title>
		<body>
			<p>Instead of using your live Portage tree, commonly found in <path>/usr/portage/profiles</path>,
			Catalyst opts to use something called a Portage snapshot. A Portage snapshot is simply
			a compressed tarball snapshot of your Portage tree. The advantage of using a a Portage
			snapshot over a live tree is portability. Using snapshots makes it much easier to duplicate
			builds across machines since all that is needed is the applicable spec file and the Portage
			snapshot used in the build. </p>

			<p>Creation of the Portage snapshot is rather straightforward. Before creating the snapshot,
			make sure that you have tweaked the tree to your liking (e.g. marking an ebuild stable).
			There are two ways to create a snapshot. One way is straight from the command line: </p>

			<pre caption="Portage snapshot creation from the command line">
# catalyst target=snapshot version_stamp=20040408
			</pre>

			<p>The other way is to use a specfile: </p>

			<pre caption="Portage snapshot creation using a specfile">
<codenote>specfile contents</codenote>

target: snapshot
version_stamp: 20040408

<codenote>using catalyst to call the specfile</codenote>

catalyst -f snapshot.spec
			</pre>

			<p>Specfiles are covered, Portage snapshots are covered, so now its time to build. </p>
		</body>
	</section>
	
</chapter>

<chapter>
	<title>Installation Stages</title>

	<section>
		<title>Overview</title>
		<body>
			
			<p>Installation stages comprise the core of any Gentoo Linux system. The ability to customize
			and create a set of installation stages is godlike in the realm of Gentoo, and with
			Catalyst, its easy. </p>

		</body>
	</section>

	<section>
		<title>Building a Stage1 Installation Tarball</title>
		<body>

			<p>placeholder</p>
		</body>
	</section>

</chapter>

</guide>

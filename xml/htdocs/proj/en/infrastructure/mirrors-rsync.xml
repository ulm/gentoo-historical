<?xml version='1.0' encoding="UTF-8"?>
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link = "/proj/en/infrastructure/sshkeys.xml">
<title>Instructions for administering our rsync mirror system.</title>
<author title="Author">
    <mail link="klieber@gentoo.org">Kurt Lieber</mail>
</author>
<abstract>
This guide documents how to administer our rsync mirroring system, including setting up, deleting and changing rsync mirrors. 
</abstract>
<version>0.9</version>
<date>08 July, 2003</date>
<chapter>
<title>Creating a new rsync mirror</title>
<section>
<title>Abstract</title>
<body>
<p>
Setting up a new rsync mirror involves the following steps:
</p>
<ul>
	<li>Acknowledging the bug on bugzilla</li>
	<li>Adding a probationary entry for the rsync mirror in the iptables ruleset for rsync1.us.gentoo.org</li>
	<li>Testing the mirror for a period of time to ensure consistency</li>
	<li>Creating records in DNS for the new mirror</li>
	<li>Setting up the Directional DNS services in UltraDNS for the new mirror</li>
</ul>
</body>
</section>
<section>
<title>Bugzilla</title>
<body>
<p>
The first step in creating a new rsync mirror is for the user to file a bug on <uri link="http://bugs.gentoo.org">http://bugs.gentoo.org</uri>.  From there, the mirror admin should acknowledge the bug and verify that the following information was provided as part of the initial report:
</p>
<ul>
	<li>server name</li>
	<li>IP address of the mirror</li>
	<li>contact information of the server administrator</li>
	<li>maximum number of concurrent connections allowed</li>
	<li>server specs, including CPU, RAM and connection speed to the internet</li>
	<li>any other requirements listed on the <uri link="/doc/en/rsync.xml">Rsync Mirrors Policy</uri> document</li>
</ul>
<p>
If part of the information is missing, please request it as a follow-up to the bug.  Then, continue to the next step.
</p>
</body>
</section>
<section>
<title>Probationary Period</title>
<body>
<p>
New rsync mirror candidates need to go through a probationary period of at least 48 hours and preferably 96 hours where their server is checked periodically for timely updates with rsync1.us.gentoo.org.  To set this up, the mirror admin must modify the iptables ruleset on rsync1.us.gentoo.org.  ssh into rsync1.us.gentoo.org and perform the following operations:
</p>
<pre caption="Use vim and sudo to edit /etc/init.d/rsync">
# <c>sudo /usr/bin/vim /etc/init.d/rsync</c>
</pre>
<pre caption="Look for the Testing section and add the new mirror there">
#######
#
# TESTING MIRRORS
# PUT MIRRORS THAT ARE IN THE TESTING PHASE HERE
# MAKE SURE TO REFERENCE THE BUGZILLA # SO WE CAN TRACK THEM
#
######

        #bug #12345
	     addMirror 192.168.1.1
</pre>
<note>Each entry should consist of at least two lines; a comment that references the bug number and the actual access entry.  The access line <b>must</b> take the form of <c>addMirror &lt;ip address&gt;</c></note>
<p>
You must also manually add the rule to the existing iptables ruleset:
</p>
<pre caption="Adding the entry to the existing itpables ruleset using sudo">
# <c>sudo /sbin/iptables -A tcp_packets -p TCP -s &lt;ip address&gt; --dport 873 -j tcp_allowed</c>
</pre>
<p>
From there, monitor the rsync mirror over the next 48-96 hours to ensure it is updating on :00 and :30 intervals.  If the mirror shows inconsistencies of any type, report them on the bug entry and work with the server admin to resolve them if possible.
</p>
<note>
A "TODO" item is to write a script that will automate the monitoring process during the probationary period.
</note>
</body>
</section>
<section>
<title>Adding DNS entries</title>
<body>
<p>
After the mirror candidate has passed the probationary period, the mirror admin should create DNS entries for the mirror.  Each mirror needs 5 distinct DNS records:
</p>
<ul>
	<li>The master rsync record. This can be an A record or a CNAME.  ex: <c>rsync5.us.gentoo.org</c></li>
	<li>A TXT record containing the contact information of the server admin.  ex:<c>"Joe Admin &lt;joe@user.com&gt;"</c></li>
	<li>The appropriate entry in the <c>rsync.gentoo.org</c> rotation</li>
	<li>The appropriate entry in the country-code rotation. ex: <c>rsync.uk.gentoo.org</c></li>
	<li>The appropriate entry in the continent-code rotation.  ex: <c>rsync.namerica.gentoo.org</c></li>
</ul>
<impo>
To ensure we can quickly and easily remove problematic rsync mirrors from our rotations, new entries should be created with a TTL of no longer than 20 minutes.
</impo>
<impo>
DNS round robin rotations do <b>not</b> support the use of CNAMEs in rotations.  Any record in a round robin rotation must be an A record.
</impo>
<note>
Because <c>rsync.gentoo.org</c> as well as <c>rsync.europe.gentoo.org</c>, <c>rsync.us.gentoo.org</c> and <c>rsync.namerica.gentoo.org</c> are getting full, mirror admins should use their discretion when adding servers to these rotations.  In general, only servers which support at least 25 users, have a 10Mbps connection to the internet and are on a server with sufficient resources should be added to these rotations.
</note>
<p>
To create the entries, log into <uri link="https://www.ultradns.net">UltraDNS</uri> using the mirror administration account information and create the records via the web interface.
</p>
</body>
</section>
<section>
<title>Adding Directional DNS</title>
<body>
<p>
For the master rsync.gentoo.org rotation, we use Directional DNS to "target" specific sets of mirrors at users based on the location of their IP address.  While it is easiest to think of this feature as geo-location, it actually relies more on the user's network connection and its proximity to the various UltraDNS servers.  To enable the Directional DNS service, follow these steps:
</p>
<ul>
	<li>Log into the <uri link="https://www.ultradns.net">UltraDNS</uri> administrative interface</li>
	<li>Select the <c>rsync.gentoo.org</c> domain</li>
	<li>Locate the record for which you wish to set up Directional DNS capabilities</li>
	<li>Click on the spinning globe (either grey or blue) for that entry.  A pop-up screen will result</li>
	<li>Select the servers for which UltraDNS should return that record as a result.  They should be geographically close to the physical location of the machine</li>
	<li>Click <c>finished</c> to close out of the Directional DNS screen</li>
</ul>
<impo>
Mirror administrators should periodically ensure that rsync.gentoo.org does not return too many records for any one particular set.  When there are more than approximately 22 records returned as part of a round robin set, it becomes larger than what UDP can handle.  This causes DNS to failover and try TCP instead.  This causes problems with users who have TCP port 53 blocked.
</impo>
</body>
</section>
<section>
<title>Updating the iptables access list</title>
<body>
<p>
Once the mirror candidate is up and functioning, the mirror administrator should update the entry in the rsync1.us.gentoo.org iptables access list to reflect the change.
</p>
<pre caption="Use vim and sudo to edit /etc/init.d/rsync">
# <c>sudo /usr/bin/vim /etc/init.d/rsync</c>
</pre>
<pre caption="Move the entry in the Testing Mirrors section to the appropriate part of the file">
#######
#
# TESTING MIRRORS
# PUT MIRRORS THAT ARE IN THE TESTING PHASE HERE
# MAKE SURE TO REFERENCE THE BUGZILLA # SO WE CAN TRACK THEM
#
######

        #bug #12345
         addMirror 192.168.1.1
<codenote>delete the entry above and move it to the appropriate section below</codenote>
[snip]

# .us RSYNC MIRRORS

        # rsync5.us     "Joe Admin &lt;joe@admin.com&gt;"
		addMirror 192.168.1.1

</pre>
<note>Each entry should consist of at least two lines; a comment that references the server administrator and their email address as well as a line containing the actual access entry.  The access line <b>must</b> take the form of <c>addMirror &lt;ip address&gt;</c></note>
</body>
</section>
</chapter>
<chapter>
<title>Updating an rsync mirror</title>
<body>
<p>
Updating an rsync mirror involves many of the same steps above, except there is no probationary period and the existing records are simply changed, rather than new records being added.
</p>
</body>
</chapter>
<chapter>
<title>Deleting an rsync mirror</title>
<body>
<p>
To delete an rsync mirror, simply complete the following steps:
</p>
<ul>
	<li>Delete the entry in /etc/init.d/rsync on rsync1.us.gentoo.org</li>
	<li>Manually delete the iptables entry on rsync1.us.gentoo.org</li>
	<li>Delete all 5 records in UltraDNS</li>
</ul>
<pre caption="Deleting the entry from the existing itpables ruleset using sudo">
# <c>sudo /sbin/iptables -D tcp_packets -p TCP -s &lt;ip address&gt;</c>
</pre>
</body>
</chapter>
</guide>

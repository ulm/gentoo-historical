<?xml version='1.0' encoding="UTF-8"?>
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link = "/proj/en/infrastructure/server-standards.xml">
<title>Server Standards for the Gentoo Infrastructure project</title>
<author title="Author">
    <mail link="klieber@gentoo.org">Kurt Lieber</mail>
</author>
<author title="Contributor">
    <mail link="solar@gentoo.org">solar</mail>
</author>
<abstract>
This guide documents the various standards, packages and requirements that the Gentoo Infrastructure team has set for its servers.
</abstract>
<version>$Id: server-standards.xml,v 1.13 2004/04/20 00:03:51 solar Exp $</version>
<date>2 April, 2004</date>

<chapter>
<title>Gentoo Infrastructure Server Standards and Guidelines</title>
<section>
<title>Common packages across all servers</title>
<body>
<p>
The following packages are required to be emerged on all Gentoo infrastructure servers:
</p>
<ul>
	<li><c>net-dns/bind-tools</c></li>        
	<li><c>net-misc/cfengine</c></li>        
	<li><c>app-portage/gentoolkit</c></li>        
	<li><c>net-firewall/iptables</c></li>
	<li><c>net-misc/keychain</c></li>
	<li><c>sys-apps/lsof</c></li>
	<li><c>dev-libs/openssl</c></li>
	<li><c>net-analyzer/nagios-nrpe-1.8</c></li>
	<li><c>net-analyzer/net-snmp</c></li>
	<li><c>net-misc/ntp</c></li>        
	<li><c>dev-util/strace</c></li>
	<li><c>net-misc/stunnel</c></li>
	<li><c>app-admin/sudo</c></li>
	<li><c>app-admin/syslog-ng</c></li>        
	<li><c>net-analyzer/tcptraceroute</c></li>
	<li><c>app-editors/vim</c></li>
	<li><c>sys-kernel/grsec-sources</c></li>
	<li><c>sys-apps/vixie-cron</c></li>
</ul>
<note>Portage will want to install version 2.0 of nagios-nrpe, please use version 1.8 instead. Version 2.0 is not backwards compatible with 1.8. Please: echo ">=net-analyzer/nagios-nrpe-2.0" >/etc/portage/package.mask before installing nagios-nrpe.</note>
<note>Trying to emerge nagios-nrpe while still in the chroot might cause some compile errors, please wait to emerge nagios-nrpe until after you have a clean reboot and out of the chroot jail.</note>
</body>
</section>
<section>
<title>Common services across all servers</title>
<body>
<p>
The following services are required to be configured and operational on all Gentoo infrastructure servers.  Click on a link to learn more about requirements and sample configuration files for each service: 
</p>
<ul>
	<li><uri link="/proj/en/infrastructure/config-ntp.xml">NTP</uri> - network time protocol</li>
	<li>cfengine - system administration tool and language</li>
	<li><uri link="/proj/en/infrastructure/config-ssh.xml">SSH</uri> - secure shell</li>
	<li><uri link="/proj/en/infrastructure/firewall/server-firewall.xml">iptables</uri> - linux firewall</li>
</ul>
</body>
</section>
<section>
<title>Forbidden services across all servers</title>
<body>
<p>
The following services may never be installed and/or running on any Gentoo Infrastructure server without prior approval by the Gentoo Infrastructure project manager: 
</p>
<ul>
	<li>telnetd</li>
	<li>pop3</li>
	<li>imap</li>
	<li>ssh protocol &lt; 2</li>
	<li>fingerd</li>
	<li>identd</li>
	<li>rsh</li>
</ul>
<note>The above list is not all-inclusive and only documents the most common forbidden services.  In general, any network daemon which transmits data in an unencrypted or insecure fashion, or is otherwise considered a security risk, is forbidden from running on any Gentoo Infrastructure servers unless explicitly authorized.  The one exception to this rule is HTTP using apache.</note>
</body>
</section>

<section>
<title>Settings in /etc/make.conf</title>
<body>
<p>
Servers should be configured to use the following settings in /etc/make.conf:
</p>
<ul>
<li><c>USE="-* ncurses ssl crypt berkdb tcpd pam xml perl python pic snmp mmx"</c></li>
<li><c>FEATURES="sandbox sfperms strict buildpkg"</c> (all servers)</li>
<li><c>CFLAGS="-march=athlon-xp -O2 -pipe -fstack-protector -fPIC"</c> (for Athlon XP servers)</li>
<li><c>CFLAGS="-march=pentium3 -O2 -pipe -fstack-protector -fPIC"</c> (for Pentium III servers)</li>
<li><c>CFLAGS="-march=pentium4 -O2 -pipe -fstack-protector -fPIC"</c> (for Pentium IV servers)</li>
<li><c>LDFLAGS="-pie"</c> (all servers &gt;=gcc-3.3.2 This allows us to build Position Independent Executables to take advantage <uri link="http://pax.grsecurity.net/docs/aslr.txt">PaX ASLR</uri></li>
</ul>
<note>USE flags may be adjusted as necessary depending on the requirements of the individual server.  Care should always be taken to ensure a minimal set of USE flags are used on all servers.</note>
<note>Sometimes the mmx USE flag can conflict with some of the existing mmx assembly thats used in various multimedia applications that are portage. If you notice this happening try USE="-mmx" and/or appending CFLAGS="-fomit-frame-pointer" In addition seek the help of a developer if needed.</note>
<impo>CFLAGS="-fforce-addr" is under review and may be added in the near future.</impo>

<p>Because of the marginal difference between -O2 and -O3, we have elected to choose stability over performance when selecting CFLAGS.  Also, to assist with debugging, -fomit-frame-pointer should not be used.</p>
</body>
</section>

<section>
<title>Settings in /etc/fstab</title>
<body>
<p>
Servers should use either ext3 or reiserfs for all partitions, with the exception of /boot, which may use ext2.  Additionally, the / partition <b>must</b> be mounted with <c>atime</c> <b>enabled</b>.  This means you need to remove <c>noatime</c> from the / entry. 
</p>
</body>
</section>

<section>
<title>Miscellaneous Settings</title>
<body>
<p>
Gentoo Infrastructure servers should have the following settings applied:
</p>
<pre caption="/etc/sysctl.conf">
net.ipv4.tcp_ecn = 0
kernel.hostname = &lt;hostname&gt; 
kernel.domainname = gentoo.org
kernel.grsecurity.altered_pings = 1
kernel.grsecurity.audit_chdir = 0
kernel.grsecurity.audit_gid = 10 
kernel.grsecurity.audit_group = 0
kernel.grsecurity.audit_ipc = 0
kernel.grsecurity.audit_mount = 1
kernel.grsecurity.chroot_caps = 1
kernel.grsecurity.chroot_deny_chmod = 1
kernel.grsecurity.chroot_deny_chroot = 1
kernel.grsecurity.chroot_deny_fchdir = 1
kernel.grsecurity.chroot_deny_mknod = 1
kernel.grsecurity.chroot_deny_mount = 1
kernel.grsecurity.chroot_deny_pivot = 1
kernel.grsecurity.chroot_deny_shmat = 1
kernel.grsecurity.chroot_deny_sysctl = 1
kernel.grsecurity.chroot_deny_unix = 1
kernel.grsecurity.chroot_enforce_chdir = 1
kernel.grsecurity.chroot_execlog = 0
kernel.grsecurity.chroot_findtask = 1
kernel.grsecurity.chroot_restrict_nice = 1
kernel.grsecurity.dmesg = 1
kernel.grsecurity.exec_logging = 0
kernel.grsecurity.execve_limiting = 1
kernel.grsecurity.fifo_restrictions = 1
kernel.grsecurity.forkfail_logging = 1
kernel.grsecurity.linking_restrictions = 1
kernel.grsecurity.rand_ip_ids = 1
kernel.grsecurity.rand_isns = 1
kernel.grsecurity.rand_pids = 1
kernel.grsecurity.rand_rpc = 0
kernel.grsecurity.rand_tcp_src_ports = 1
kernel.grsecurity.signal_logging = 1
kernel.grsecurity.timechange_logging = 1
kernel.grsecurity.tpe = 0
kernel.grsecurity.tpe_gid = 0
kernel.grsecurity.tpe_restrict_all = 0
</pre>
<pre caption="All servers should be set to UTC time">
ln -sf /usr/share/zoneinfo/UTC /etc/localtime
</pre>
<pre caption="GRSecurity Settings">
#
# Grsecurity
#
CONFIG_GRKERNSEC=y
CONFIG_CRYPTO=y
CONFIG_CRYPTO_SHA256=y
# CONFIG_GRKERNSEC_LOW is not set
# CONFIG_GRKERNSEC_MID is not set
# CONFIG_GRKERNSEC_HI is not set
CONFIG_GRKERNSEC_CUSTOM=y

#
# PaX Control
#
# CONFIG_GRKERNSEC_PAX_SOFTMODE is not set
CONFIG_GRKERNSEC_PAX_EI_PAX=y
CONFIG_GRKERNSEC_PAX_PT_PAX_FLAGS=y
CONFIG_GRKERNSEC_PAX_NO_ACL_FLAGS=y
# CONFIG_GRKERNSEC_PAX_HAVE_ACL_FLAGS is not set
# CONFIG_GRKERNSEC_PAX_HOOK_ACL_FLAGS is not set

#
# Address Space Protection
#
CONFIG_GRKERNSEC_PAX_NOEXEC=y
# CONFIG_GRKERNSEC_PAX_PAGEEXEC is not set
CONFIG_GRKERNSEC_PAX_SEGMEXEC=y
# CONFIG_GRKERNSEC_PAX_EMUTRAMP is not set
CONFIG_GRKERNSEC_PAX_MPROTECT=y
# CONFIG_GRKERNSEC_PAX_NOELFRELOCS is not set
CONFIG_GRKERNSEC_PAX_ASLR=y
CONFIG_GRKERNSEC_PAX_RANDUSTACK=y
CONFIG_GRKERNSEC_PAX_RANDMMAP=y
CONFIG_GRKERNSEC_PAX_RANDEXEC=y
# CONFIG_GRKERNSEC_KMEM is not set
# CONFIG_GRKERNSEC_IO is not set
CONFIG_GRKERNSEC_PROC_MEMMAP=y
CONFIG_GRKERNSEC_HIDESYM=y

#
# Role Based Access Control Options
#
CONFIG_GRKERNSEC_ACL_HIDEKERN=y
CONFIG_GRKERNSEC_ACL_MAXTRIES=3
CONFIG_GRKERNSEC_ACL_TIMEOUT=30

#
# Filesystem Protections
#
CONFIG_GRKERNSEC_PROC=y
# CONFIG_GRKERNSEC_PROC_USER is not set
CONFIG_GRKERNSEC_PROC_USERGROUP=y
CONFIG_GRKERNSEC_PROC_GID=10
CONFIG_GRKERNSEC_PROC_ADD=y
CONFIG_GRKERNSEC_LINK=y
CONFIG_GRKERNSEC_FIFO=y
CONFIG_GRKERNSEC_CHROOT=y
CONFIG_GRKERNSEC_CHROOT_MOUNT=y
CONFIG_GRKERNSEC_CHROOT_DOUBLE=y
CONFIG_GRKERNSEC_CHROOT_PIVOT=y
CONFIG_GRKERNSEC_CHROOT_CHDIR=y
CONFIG_GRKERNSEC_CHROOT_CHMOD=y
CONFIG_GRKERNSEC_CHROOT_FCHDIR=y
CONFIG_GRKERNSEC_CHROOT_MKNOD=y
CONFIG_GRKERNSEC_CHROOT_SHMAT=y
CONFIG_GRKERNSEC_CHROOT_UNIX=y
CONFIG_GRKERNSEC_CHROOT_FINDTASK=y
CONFIG_GRKERNSEC_CHROOT_NICE=y
CONFIG_GRKERNSEC_CHROOT_SYSCTL=y
CONFIG_GRKERNSEC_CHROOT_CAPS=y

#
# Kernel Auditing
#
# CONFIG_GRKERNSEC_AUDIT_GROUP is not set
CONFIG_GRKERNSEC_EXECLOG=y
CONFIG_GRKERNSEC_RESLOG=y
CONFIG_GRKERNSEC_CHROOT_EXECLOG=y
CONFIG_GRKERNSEC_AUDIT_CHDIR=y
CONFIG_GRKERNSEC_AUDIT_MOUNT=y
CONFIG_GRKERNSEC_AUDIT_IPC=y
CONFIG_GRKERNSEC_SIGNAL=y
CONFIG_GRKERNSEC_FORKFAIL=y
CONFIG_GRKERNSEC_TIME=y
CONFIG_GRKERNSEC_PROC_IPADDR=y
CONFIG_GRKERNSEC_AUDIT_TEXTREL=y

#
# Executable Protections
#
CONFIG_GRKERNSEC_EXECVE=y
CONFIG_GRKERNSEC_DMESG=y
CONFIG_GRKERNSEC_RANDPID=y
CONFIG_GRKERNSEC_TPE=y
CONFIG_GRKERNSEC_TPE_ALL=y
CONFIG_GRKERNSEC_TPE_GID=100

#
# Network Protections
#
CONFIG_GRKERNSEC_RANDNET=y
CONFIG_GRKERNSEC_RANDISN=y
CONFIG_GRKERNSEC_RANDID=y
CONFIG_GRKERNSEC_RANDSRC=y
CONFIG_GRKERNSEC_RANDRPC=y
# CONFIG_GRKERNSEC_SOCKET is not set

#
# Sysctl support
#
CONFIG_GRKERNSEC_SYSCTL=y

#
# Logging options
#
CONFIG_GRKERNSEC_FLOODTIME=10
CONFIG_GRKERNSEC_FLOODBURST=4
</pre>

<note>mileage may very with CONFIG_GRKERNSEC_KMEM</note>
<impo>Ensure that the hardware clock on the server is set to the correct time in UTC format as well.  Use <c>hwclock</c> to adjust.</impo>

</body>
</section>
</chapter>
</guide>

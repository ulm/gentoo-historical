<?xml version='1.0' encoding="utf-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->
  
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/hardened/selinux/Attic/hb-selinux-conv-reboot2.xml,v 1.11 2010/06/25 16:07:19 pebenito Exp $ -->

<sections>
<version>2.2</version>
<date>2009-12-15</date>

<section><title>Merge SELinux Packages</title>
<subsection>
<body>
<p>Merge the libraries, utilities and base-policy.  The policy version may need
   be adjusted, refer to the SELinux Overview
   for more information on policy versions.  Then load the policy.</p>

<pre caption="Merge base SELinux packages and policy">
# <i>emerge -1 checkpolicy policycoreutils</i>
# <i>FEATURES=-selinux emerge -1 selinux-base-policy</i>
</pre>
<note>
The "FEATURES=-selinux" part of the emerge command should only be used on the above command.
It is required to merge selinux-base-policy (only for the first time) as the portage SELinux features require both policycoreutils and selinux-base-policy otherwise portage will fail.
</note>
</body></subsection>
</section>

<section><title>Choose the policy type</title>
<body>
<p>
New in 2006.1, users now have the choice between the strict policy and the
targeted policy.
</p>
<p>
In the strict policy, all processes are confined.
If you are familiar with pre 2006.1 Gentoo SELinux policy, that policy was a strict policy.
Strict policy is suggested for servers.
Gentoo does not support the strict policy on desktops.
</p>
<p>
The targeted policy differs with strict, as only network-facing services are
confined and local users are unconfined.  Gentoo only supports desktops with
the targeted policy.  This policy can also be used on servers.
</p>
<p>
Edit the /etc/selinux/config file to set the policy type.
</p>
<pre caption="/etc/selinux/config contents">
# This file controls the state of SELinux on the system on boot.

# SELINUX can take one of these three values:
#       enforcing - SELinux security policy is enforced.
#       permissive - SELinux prints warnings instead of enforcing.
#       disabled - No SELinux policy is loaded.
SELINUX=permissive <comment>(This should be set permissive for the remainder of the install)</comment>

# SELINUXTYPE can take one of these two values:
#       targeted - Only targeted network daemons are protected.
#       strict - Full SELinux protection.
SELINUXTYPE=strict <comment>(Set this as strict or targeted)</comment>
</pre>
</body>
</section>

<section><title>Merge SELinux-patched packages</title>
<subsection><body>
<p>
  There are several system packages that have SELinux patches.  These patches
  provide a variety of additional SELinux functionality, such as displaying
  file contexts.
</p>
<pre caption="Remerge Packages">
# <i>emerge -1 sysvinit pam coreutils findutils openssh procps psmisc shadow util-linux python-selinux</i>
</pre>
<note>
  If you find that you can't use portage due to a errors like these:
  !!! 'module' object has no attribute 'secure_rename' or
  AttributeError: 'module' object has no attribute 'getcontext', this is
  a portage bug, where it can't handle a missing python-selinux.  Merge it
  with "FEATURES=-selinux emerge python-selinux" to fix the problem.  See
  bug <uri link="http://bugs.gentoo.org/show_bug.cgi?id=122517">#122517</uri>
  for more information.
</note>
<p>There are other packages that have SELinux patches, but are optional.  These
should be remerged if they are already installed, so the SELinux patches are
applied:</p>
<ul>
<li>app-admin/logrotate</li>
<li>sys-apps/fcron</li>
<li>sys-apps/vixie-cron</li>
<li>sys-fs/device-mapper</li>
<li>sys-fs/udev</li>
<li>sys-libs/pwdb</li>
</ul>
<note>
  Fcron and Vixie-cron are the only crons with SELinux support.
</note>
<note>The above packages are NOT an exhaustive list; they are only the most
common ones.  In general, any package installed on the system which has the
selinux USE flag should be remerged.  To see which packages may need to be
merged, you can:
emerge -upDN world

Since changing to the selinux profile has changed your USE flags, the above
will get everything that is listening to the selinux USE flag.  It will
probably also get some other stuff as well.  To actually remerge everything,
simply remove the 'p', or manually specify the packages you want to remerge.
</note>
</body></subsection>
</section>

<section><title>Merge Application Policies</title>
<subsection><body>
<p>
  In future, when merging a package, the policy will be set as a dependency so
  that it is merged first; however, since the system is being converted, policy
  for currently installed packages must be merged.  The selinux-base-policy
  already covers most packages in the system profile.
</p>
<p>
  Look in the <c>/usr/portage/sec-policy</c>, it has several entries, each which
  represent a policy.  The naming scheme is selinux-PKGNAME, where PKGNAME is
  the name of the package that the policy is associated.  For example, the
  selinux-apache package is the SELinux policy package for net-www/apache.
  Merge each of the needed policy packages and then load the policy.
  If you are converting a desktop, make sure to include the selinux-desktop policy package.
</p>
<pre caption="Example Merge of Apache and BIND policies">
# <i>ls /usr/portage/sec-policy</i>
<comment>(many directories listed)</comment>

# <i>emerge -1 selinux-apache selinux-bind</i>
</pre>
</body></subsection>
</section>

<section><title>Label Filesystems</title>
<subsection><body>
<p>
  Before you can relabel the rest of the filesystems, you need to first relabel
  /dev.  Strictly speaking, this is only necessary if you aren't using a static
  /dev.  However, as the vast majority of current and new systems are going to
  be built with udev, this probably means you are using udev as well.  There
  are a lot of different ways to get at this problem, but the steps below are
  easy to do and work.
</p>
  <pre caption="Relabel /dev">
<i># mkdir /mnt/gentoo
# mount -o bind / /mnt/gentoo
# setfiles -r /mnt/gentoo /etc/selinux/{strict,targeted}/contexts/files/file_contexts /mnt/gentoo/dev
# umount /mnt/gentoo
</i>
  </pre>
  <note>Remember to select one of {strict,targeted} above based on your
 enforcement mode.</note>
<p>
  Now label the filesystems.  This gives each of the files in the filesystems
  a security label.  Keeping these labels consistent is important.
</p>
<pre caption="Label filesystems">
# <i>rlpkg -a -r</i>
</pre>
<warn>
  There is a known issue with older versions of GRUB
  not being able to read symlinks that have been labeled.
  Please make sure you have at least GRUB 0.94 installed.
  Also rerun GRUB and reinstall it into the MBR to ensure
  the updated code is in use.
  You do have a LiveCD handy, right?
</warn>
<pre caption="Reinstall GRUB on the MBR (GRUB users only)">
# <i>grub</i>

grub> root (hd0,0) <comment>(Your boot partition)</comment>
grub> setup (hd0) <comment>(Where the boot record is installed; here, it is the MBR)</comment>
</pre>
<p>
  If you've installed Gentoo using the hardened sources, then you'll need to
  tell SELinux that you are using the hardened tool-chain with ssp.  You do
  this by setting an SELinux global boolean 
</p>
<pre caption="SELinux global_ssp">
<i>setsebool -P global_ssp on</i>
</pre>
<note>Make sure you use the -P flag, or the setting won't survive the reboot,
and you'll likely see a lot of errors relating to /dev/null and /dev/random
</note>
</body></subsection>
</section>

<section><title>Final reboot</title>
<subsection><body>
<p>Reboot.  Log in, then relabel again to ensure all files
are labeled correctly (some files may have been created during shutdown and
reboot)</p>
<pre caption="Relabel">
# <i>rlpkg -a -r</i>
</pre>
<note>
  It is strongly suggested to <uri link="http://www.gentoo.org/main/en/lists.xml">subscribe</uri>
  to the gentoo-hardened mail list.  It is generally a low traffic list, and 
  SELinux announcements are made there.
</note>
<p>
  SELinux is now installed!
</p>
</body></subsection>
</section>

</sections>

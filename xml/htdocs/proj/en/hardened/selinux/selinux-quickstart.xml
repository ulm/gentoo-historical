<?xml version='1.0' encoding="utf-8"?>
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<guide link="/proj/en/hardened/selinux/selinux-quickstart.xml">
<title>Gentoo SELinux Quick Start Guide</title>
<author title="Author">
  <mail link="pebenito@gentoo.org">Chris PeBenito</mail>
</author>
<author title="Author">
  <mail link="klasikahl@gentoo.org">Zack Gilburd</mail>
</author>
<author title="Editor">
  <mail link="method@gentoo.org">Joshua Brindle</mail>
</author>
<abstract>
This will provide instructions for getting an SELinux installation running
on a machine with an existing Gentoo installation.
</abstract>
<license/>
<version>4.0</version>
<date>24 April 2004</date>

<chapter><title>Introduction</title>
<section>
<body>
<p>
  This guide contains information on converting a standard (default) profile
  Gentoo machine to SELinux.  It is strongly suggested that users read the
  <uri link="http://www.gentoo.org/proj/en/hardened/selinux/selinux-policy.xml">Policy Overview</uri>,
  which is an overview of SELinux and its concepts.  Also refer to the
  <uri link="http://www.gentoo.org/proj/en/hardened/selinux/selinux-faq.xml">HOWTO and FAQ</uri>.
</p>
</body>
</section>
</chapter>

<chapter><title>Converting a Preexisting Standard Gentoo Installation</title>
<section><title>Initial Preparations</title>
<body>

<warn>SELinux is only supported on servers.  Workstation support
will happen in the future.</warn>

<warn>SELinux is only supported on ext2/3 and XFS.  Other filesystems
lack the complete extended attribute support.  This should change
in the future.</warn>

<impo>As always, keep a LiveCD at hand in case things go wrong.</impo>

<p>First switch your profile to the SELinux profile for your architecture:</p>

<pre caption="Switch profiles">
# <i>rm -f /etc/make.profile</i>

<comment>x86:</comment>
# <i>ln -sf /usr/portage/profiles/selinux/2004.1/x86 /etc/make.profile</i>
<comment>PPC:</comment>
# <i>ln -sf /usr/portage/profiles/selinux/2004.1/ppc /etc/make.profile</i>
<comment>SPARC64:</comment>
# <i>ln -sf /usr/portage/profiles/selinux/2004.1/sparc64 /etc/make.profile</i>
</pre>

<impo>The SELinux profile has significanly fewer USE flags asserted than
the default profile.  Use <c>emerge info</c> to see if any use flags
need to be reenabled in make.conf.</impo>

<note>It is not necessary to add selinux to your USE flags in make.conf.
The SELinux profile already does this for you.
</note>

<note>
  You may encounter this message from portage: "!!! SELinux module not found.
  Please verify that it was installed."  This is normal, and will be fixed
  later in the conversion process.
</note>

<p>
  We will start by emerging some essential packages.  Glibc must first be
  recompiled with newer linux headers.
</p>

<p>
  First check which version of linux-headers are installed.
</p>

<pre caption="Check linux-headers version">
# <i>emerge -s linux-headers</i>
<comment>or if you have gentoolkit installed:</comment>
# <i>qpkg -I -v linux-headers</i>
</pre>

<p>
  If the linux-headers version is older than 2.4.20, newer headers must be merged.
</p>

<pre caption="Merge newer headers">
# <i>emerge \>=sys-kernel/linux-headers-2.4.20</i>
</pre>

<p>
  Now, if you have merged new headers, or you are unsure if your glibc was
  compiled with newer headers, you must recompile glibc.
</p>

<pre caption="Recompile glibc">
# <i>emerge glibc</i>
</pre>

<impo>
  This is a critical operation.  Glibc must be compiled with newer linux-headers,
  otherwise some operations will malfunction.
</impo>

<p>Now merge an appropriate kernel.  Any 2.6 kernel is usable.  x86 systems can
   also use selinux-sources or hardened-sources, which are 2.4 kernels.  The
   suggested kernel is hardened-dev-sources.
</p>

<pre caption="Merge an appropriate kernel">
<comment>Any 2.6 kernel</comment>
# <i>emerge hardened-dev-sources</i>

<comment>x86-only 2.4 kernels:</comment>
# <i>emerge selinux-sources</i>
<comment>Or</comment>
# <i>emerge hardened-sources</i>
</pre>
<p>The kernel must  be compiled with security module support, SELinux support,
devpts, and extended attribute security labels.  Refer to the main installation
guide for futher kernel options.</p>

<pre caption="Location and required options under menuconfig">
<comment>Under "Code maturity level options"</comment>
[*] Prompt for development and/or incomplete code/drivers

<comment>Under "File systems"</comment>
&lt;*&gt; Second extended fs support
[*]   Ext2 extended attributes
[ ]     Ext2 POSIX Access Control Lists
[*]     Ext2 Security Labels
&lt;*&gt; Ext3 journalling file system support
[*]   Ext3 extended attributes
[ ]     Ext3 POSIX Access Control Lists
[*]     Ext3 Security labels
&lt;*&gt; XFS filesystem support
[ ]   Realtime support (EXPERIMENTAL)
[ ]   Quota support
[ ]   ACL support
[*]   Security Labels

[ ] /dev file system support (EXPERIMENTAL)
[*] /dev/pts file system for Unix98 PTYs
[*]   /dev/pts Extended Attributes
[*]     /dev/pts Security Labels    

<comment>Under "Security options"</comment>
[*] Enable different security models
[ ] Socket and Networking Security Hooks
&lt;*&gt; Capabilities Support
[*] NSA SELinux Support
[ ]   NSA SELinux boot parameter
[*]   NSA SELinux Development Support
[ ]   NSA SELinux MLS policy (EXPERIMENTAL)
</pre>
<p>
  The extended attribute security labels must be turned on for devpts and
  your filesystem(s).  Devfs is no longer usable in SELinux, and can be
  turned off.
</p>
<note>
  The available options may vary slightly depending on if a 2.4 or 2.6 kernel
  is being used.  The other extended attribute options should be turned off.
</note>

<p>Now compile and install the kernel and modules, but do not reboot.
Devpts and selinuxfs must also be enabled to mount at boot.  Add this to /etc/fstab:</p>
<pre caption="Fstab settings for devpts and selinuxfs">
none	/dev/pts	devpts		gid=5,mode=620	0	0
none	/selinux	selinuxfs	defaults	0	0
</pre>

<p>
The command line option <c>gentoo=nodevfs</c> must be added to the kernel
command line, so the init scripts do not attempt to mount devfs.
</p>
<pre caption="Example bootloader entries">
<comment>x86: GRUB</comment>
title=linux
root (hd0,0)
kernel /bzImage root=/dev/hda3 <i>gentoo=nodevfs</i>

<comment>x86: LILO</comment>
image=/boot/bzImage
	label=linux
	read-only
	root=/dev/hda3
	<i>append="gentoo=nodevfs"</i>

<comment>PPC: yaboot</comment>
image=/boot/bzImage
	label=linux
	read-only
	root=/dev/hda3
	<i>append="gentoo=nodevfs"</i>

<comment>SPARC64: SILO</comment>
image = /vmlinux
        label = linux
        root = /dev/sda2
        <i>append="gentoo=nodevfs"</i>
</pre>
<p>
  We need to make some directories before we reboot.
</p>
<pre caption="Making Required Directories">
# <i>mkdir /selinux</i>
# <i>mkdir /sys</i>
</pre>
<p>Now reboot with the new SELinux kernel.</p>

</body>
</section>
<section><title>Merge SELinux Packages</title>
<body>
<p>Merge the libraries, utilities and base-policy.  The policy version may need
   be adjusted, refer to the <uri link="http://www.gentoo.org/proj/en/hardened/selinux/selinux-policy.xml#doc_chap6">Policy Overview</uri>
   for more information on policy versions.  Then load the policy.</p>

<pre caption="Merge base SELinux packages and policy">
# <i>emerge libselinux checkpolicy policycoreutils</i>
# <i>emerge selinux-base-policy</i>

# <i>cd /etc/security/selinux/src/policy</i>
<comment>Adjust the policy version now, if needed.</comment>
# <i>make load</i>
</pre>

<p>Merge SELinux-patched packages:</p>

<pre># <i>emerge baselayout pam coreutils findutils openssh pam-login procps psmisc shadow util-linux python-selinux</i></pre>

<p>There are other packages that have SELinux patches, but are optional.  These
should be remerged if they are already installed, so the SELinux patches are
applied:</p>
<p>app-admin/logrotate<br/>
sys-apps/vixie-cron (currently the only cron patched for SELinux)<br/>
sys-libs/pwdb</p>

<p>Now label the filesystems.</p>

<pre>
# <i>cd /etc/security/selinux/src/policy</i>
# <i>make relabel</i>
</pre>
<warn><c>x86:</c>
  There is a known issue with older versions of GRUB
  not being able to read symlinks that have been labeled.
  Please make sure you have at least GRUB 0.94 installed.
  Also rerun GRUB and reinstall it into the MBR to ensure
  the updated code is in use.
  You do have a LiveCD handy, right?
</warn>

<pre caption="Reinstall GRUB on the MBR (x86 GRUB users only)">
# <i>grub</i>

grub> root (hd0,0) <comment>(Your boot partition)</comment>
grub> setup (hd0) <comment>(Where the boot record is installed; here, it is the MBR)</comment>
</pre>
</body>
</section>
<section><title>Final reboot</title>
<body>
<p>Reboot.  Relabel again to ensure all files
are labeled correctly (some files may have been created during shutdown and
reboot)</p>
<pre caption="Relabel">
# <i>cd /etc/security/selinux/src/policy</i>
# <i>make relabel</i>
</pre>
<note>
  It is strongly suggested to <uri link="http://www.gentoo.org/main/en/lists.xml">subscribe</uri>
  to the gentoo-hardened mail list.  It is generally a low traffic list, and 
  SELinux announcements are made there.
</note>
</body>
</section>
</chapter>

<!--
<chapter>
	<title>
		Conversion to the 2.6 SELinux API (x86 only)
	</title>
	<section><title>Converting an old API SELinux Installation</title>
	<body>
<warn>The new API only supports ext2/3 and XFS.  Other filesystems
lack the complete extended attribute support.  This should change
in the future.</warn>
	<p>
		SELinux is available in 2.6 kernels; however, it does not use the
		same API as the old (selinux-small/libsecure) 2.4 SELinux.  
		This new API has been backported to 2.4 in newer selinux-sources
		and hardened-sources kernels.  This chapter
		of the Quick Start Guide describes the conversion
		of a old API SELinux machine to the new API.  Please read the
		entire chapter before starting.
	</p>
	<impo>
		As always, keep a LiveCD at hand in case things go wrong.
	</impo>
	</body></section>
	<section>
		<title>
			Beginning the Conversion
		</title>
		<body>
			<p>
				We will start by emerging some essential packages.
				Glibc must first be recompiled
				with newer linux headers.
			</p>

<note>It is suggested to be in permissive mode.</note>

			<p>
				First check which version of linux-headers are
				installed.
			</p>

<pre caption="Check linux-headers version">
# <c>emerge -s linux-headers</c>
<comment>or if you have gentoolkit installed:</comment>
# <c>qpkg -I -v linux-headers</c>
</pre>

			<p>
				If the linux-headers version is older than 2.4.20,
				newer headers must be merged.
			</p>

<pre caption="Merge newer headers">
# <c>emerge \>=sys-kernel/linux-headers-2.4.20</c>
</pre>

			<p>
				Now, if you have merged new headers, or you are
				unsure if your glibc was compiled with newer
				headers, you must recompile glibc.
			</p>

<pre caption="Recompile glibc">
# <c>emerge glibc</c>
</pre>

			<impo>
				This is a critical operation.
				Glibc must be compiled with newer linux-headers,
				otherwise some operations will malfunction.
			</impo>

			<p>
				These packages contain the equivalent of the old
				selinux-small.  Do not unmerge selinux-small yet.
			</p>

<pre caption="Installing the New Packages">
# <c>emerge sys-libs/libselinux</c>
# <c>emerge sys-apps/checkpolicy</c>
# <c>emerge sys-apps/policycoreutils</c>
</pre>
			<p>
				Now you should either move, or remove your old SELinux policy (/etc/security/selinux/src/policy) and then emerge the new policy.
			</p>
<pre caption="Emerging the New Policy">
# <c>emerge \>=sec-policy/selinux-base-policy-20030817</c>
</pre>
		</body>
	</section>
	<section>
		<title>
			Compiling and Installing the New Kernel
		</title>
		<body>
			<p>
				We will first emerge a kernel that contains the new API.
			</p>
<pre caption="Emerging the Kernel">
<comment>Use one of the following commands.</comment>
# <c>emerge \>=selinux-sources-2.4.21-r2</c>
<comment>Or</comment>
# <c>emerge \>=hardened-sources-2.4.22</c>
<comment>Or</comment>
# <c>emerge \>=development-sources-2.6.0_beta3</c>
<comment>Or</comment>
# <c>emerge \>=mm-sources-2.6.0_beta3</c>
</pre>
			<p>
				Now we must configure the kernel.
			</p>
<pre caption="Location and required options under menuconfig">
<comment>Under "Code maturity level options"</comment>
[*] Prompt for development and/or incomplete code/drivers

<comment>Under "File systems"</comment>
&lt;*&gt; Second extended fs support
[*]   Ext2 extended attributes
[ ]     Ext2 POSIX Access Control Lists
[*]     Ext2 Security Labels
&lt;*&gt; Ext3 journalling file system support
[*]   Ext3 extended attributes
[ ]     Ext3 POSIX Access Control Lists
[*]     Ext3 security labels
&lt;*&gt; XFS filesystem support
[ ]   Realtime support (EXPERIMENTAL)
[ ]   Quota support
[ ]   ACL support
[*]   Security Labels

[ ] /dev file system support (EXPERIMENTAL)
[*] /dev/pts file system for Unix98 PTYs
[*]   /dev/pts Extended Attributes
[*]     /dev/pts Security Labels    

<comment>Under "Security options"</comment>
[*] Enable different security models
[ ] Socket and Networking Security Hooks
&lt;*&gt; Capabilities Support
[*] NSA SELinux Support
[ ]   NSA SELinux boot parameter
[*]   NSA SELinux Development Support
[ ]   NSA SELinux MLS policy (EXPERIMENTAL)
</pre>
<p>
  The extended attribute security labels must be turned on for devpts and
  your filesystem(s).  Devfs is no longer usable in SELinux, and can be
  turned off.
</p>

			<note>
				The available options may vary slightly depending on
				if a 2.4 or 2.6 kernel is being used.  The other
				extended attribute options should be turned off.
			</note>

<pre caption="Compile and Install the Kernel">
<comment>For 2.4 kernels:</comment>
# <c>make dep &amp;&amp; make clean bzImage modules modules_install</c>

<comment>For 2.6 kernels:</comment>
# <c>make clean bzImage modules modules_install</c>

<comment>For both versions:</comment>
<comment>if necessary, mount your boot partition.</comment>
# <c>mount /boot</c>
# <c>cp arch/i386/boot/bzImage /boot</c>
</pre>
		</body>
	</section>
	<section>
		<title>Reboot Preperations</title>
		<body>
			<p>
				We need to make some directories before we reboot.
			</p>
<pre caption="Making Required Directories">
# <c>mkdir /selinux</c>
# <c>mkdir /sys</c>
</pre>
			<p>
				Now, we need to add a line to our fstab:
			</p>
<pre caption="/etc/fstab">
# <c>nano -w /etc/fstab</c>
<comment>Add the following line.</comment>
none	/selinux	selinuxfs	defaults	0	0
</pre>
			<p>
				Now the bootloader will have to be configured.
				The command line option
				<i>gentoo=nodevfs</i> must be added to the kernel
				command line, so the init scripts do not attempt
				to mount devfs.
			</p>
<pre caption="Example GRUB entry">
title=linux
root (hd0,0)
kernel /bzImage root=/dev/hda3 <c>gentoo=nodevfs</c>
</pre>
<pre caption="Example LILO entry">
image=/boot/bzImage
	label=linux
	read-only
	root=/dev/hda3
	<c>append="gentoo=nodevfs"</c>
</pre>
			<p>
				You may now <c>reboot</c>.
			</p>
		</body>
	</section>
	<section>
		<title>Post-Reboot</title>
		<body>
			<p>
				Several packages need to be re-emerged.
			</p>
<pre caption="Re-emerge the Following Packages">
sys-libs/pam
sys-libs/pwdb
sys-apps/baselayout
sys-apps/coreutils
sys-apps/findutils
sys-apps/procps
sys-apps/psmisc
sys-apps/util-linux
sys-apps/pam-login
sys-apps/shadow
sys-apps/tar
net-misc/openssh
dev-python/python-selinux

<comment>The following are optional packages that must be re-emerged if you use them.</comment>
app-admin/logrotate
dev-util/strace
sys-apps/vixie-cron
sys-apps/stat
</pre>
			<p>
				Now all packages have been recompiled with the
				new API.  Now the old API can finally be unmerged.
			</p>
<pre caption="Unmerge selinux-small">
# <c>emerge unmerge selinux-small</c>
</pre>
		</body>
	</section>
	<section>
		<title>
			Relabeling and Final Reboot
		</title>
		<body>
			<p>
				As a one-time process, the filesystem must be relabled, the computer rebooted, then the filesystem relabled once again.
			</p>
			<warn>
				There is a known issue with older versions of GRUB
				not being able to read symlinks that have been labeled.
				Please make sure you have at least GRUB 0.94 installed.
				Also rerun GRUB and reinstall it into the MBR to ensure
				the updated code is in use.
				You do have a LiveCD handy, right?
			</warn>
<pre caption="Reinstall GRUB on the MBR (GRUB users only)">
# <c>grub</c>
                                                                                                        
grub> root (hd0,0) <comment>(Your boot partition)</comment>
grub> setup (hd0) <comment>(Where the boot record is installed; here, it is the MBR)</comment>
</pre>

<pre caption="Relabeling">
# <c>cd /etc/security/selinux/src/policy</c>
# <c>make relabel</c>

<comment>Reboot</comment>

# <c>cd /etc/security/selinux/src/policy</c>
# <c>make relabel</c>
</pre>
			<p>
				The conversion is complete.  When policy is
				added or changed, remember to load policy and relabel, or
				rlpkg the affected packages.
			</p>
<note>
  It is strongly suggested to <uri link="http://www.gentoo.org/main/en/lists.xml">subscribe</uri>
  to the gentoo-hardened mail list.  It is generally a low traffic list, and
  SELinux announcements are made there.
</note>
		</body>
	</section>
</chapter> -->
</guide>

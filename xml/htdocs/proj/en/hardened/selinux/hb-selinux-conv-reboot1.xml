<?xml version='1.0' encoding="utf-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->
 
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/hardened/selinux/Attic/hb-selinux-conv-reboot1.xml,v 1.10 2010/06/25 16:07:19 pebenito Exp $ -->

<sections>
<version>2.0</version>
<date>2007-07-22</date>

<section><title>Merge a SELinux Kernel</title>
<subsection><body>
<p>Merge an appropriate kernel.  A 2.6 kernel is required.  The
   suggested kernel is hardened-sources.
</p>

<note>2.6.28-r9 is the current hardened release version at the time of this writing,
  and all instructions in this document assume at least this version.</note>

<warn>Kernels 2.6.14 and 2.6.15 should not be used by XFS users as they
  have bugs in the SELinux XFS support.</warn>
 
<pre caption="Merge an appropriate kernel">
<comment>Any 2.6 kernel</comment>
# <i>emerge hardened-sources</i>
</pre>
</body></subsection>
</section>

<section><title>Compile the Kernel with SELinux Options</title>
<subsection><body>
<p>The kernel must  be compiled with security module support, SELinux support,
devpts, and extended attribute security labels.  Refer to the main installation
guide for futher kernel options.</p>

<note>
The available options may vary slightly depending on the kernel version
being used.  In particular, Btrfs first became available with the 2.6.29
kernel, and the /dev/pts and tmpfs Extended Attributs and Security Labels
options were obsoleted in kernel 2.6.13 (they are now enabled by default).
"Default Linux Capabilies" under "Security options" was obsoleted in the
2.6.26 kernel (it is now enabled by default).

XFS always enables security labeling, so there is no additional option
to set for this file system

Ext4 should work, but is NOT well tested at the time of this writing!

Any extended attribute options not specifically enabled below should be turned
off.
</note>

<pre caption="Location and required options under menuconfig">
<comment>Under "General setup"</comment>
[*] Prompt for development and/or incomplete code/drivers
[*] Auditing support
[*]   Enable system-call auditing support

<comment>Under "File systems"</comment>
&lt;*&gt; Second extended fs support <comment>(If using ext2)</comment>
[*]   Ext2 extended attributes
[ ]     Ext2 POSIX Access Control Lists
[*]     Ext2 Security Labels
[ ]   Ext2 Execute in place support
&lt;*&gt; Ext3 journalling file system support <comment>(If using ext3)</comment>
[*]   Ext3 extended attributes
[ ]     Ext3 POSIX Access Control Lists
[*]     Ext3 Security labels
&lt;*&gt; The Extended 4 (ext4) filesystem <comment>(If using ext4)</comment>
[ ]   Enable ext4dev compatibility 
[*]   Ext4 extended attrributes
[ ]     Ext4 POSIX Access Control Lists
[*]     Ext4 Security Labels
&lt;*&gt; JFS filesystem support <comment>(If using JFS)</comment>
[ ]   JFS POSIX Access Control Lists
[*]   JFS Security Labels
[ ]   JFS debugging
[ ]   JFS statistics
&lt;*&gt; XFS filesystem support <comment>(If using XFS)</comment>
[ ]   XFS Quota support
[ ]   XFS POSIX ACL support
[ ]   XFS Realtime subvolume support (EXPERIMENTAL)
[ ]   XFS Debugging Support
&lt;*&gt; Btrfs filesystem (EXPERIMENTAL) Unstable disk format <comment>(if
using Btrfs)</comment>
[ ]   Btrfs POSIX Access Control Lists (NEW)
<comment>Under "Pseudo filesystems (via "File systems")</comment>
[ ] /dev file system support (EXPERIMENTAL)
[*]   /dev/pts Extended Attributes
[*]     /dev/pts Security Labels
[*] Virtual memory file system support (former shm fs)
[*]   tmpfs Extended Attributes
[*]     tmpfs Security Labels

<comment>Under "Security options"</comment>
[*] Enable different security models
[*]   Socket and Networking Security Hooks
&lt;*&gt;   Default Linux Capabilities
[*] NSA SELinux Support
[ ]   NSA SELinux boot parameter
[ ]   NSA SELinux runtime disable
[*]   NSA SELinux Development Support
[ ]   NSA SELinux AVC Statistics
(1)   NSA SELinux checkreqprot default value
[ ]   NSA SELinux enable new secmark network controls by default
[ ]   NSA SELinux maximum supported policy format version
</pre>

<p>
  The extended attribute security labels must be turned on for devpts and
  your filesystem(s).  Devfs is not usable in SELinux, and should be
  turned off.  Not all options exist on older 2.6 kernels,
  such as Auditing support, and runtime disable.  In newer kernels,
  the extended attributes support for proc and the virtual memory fs (tmpfs)
  are enabled by default; thus, no options will appear in menuconfig.
</p>

<note>It is recommended to configure PaX if you are using harded-sources (also
recommended).  More information about Pax can be found in the <uri link="http://www.gentoo.org/proj/en/hardened/pax-quickstart.xml">Hardened Gentoo
PaX Quickstart Guide</uri>.
</note>

<warn>
  Do not enable the SELinux MLS policy option if its available, as it is
  not supported, and will cause your machine to not start.
</warn>

<p>
  Now compile and install the kernel and modules, but do not reboot.
</p>
</body></subsection>
</section>

<section><title>Update fstab</title>
<subsection><body>
<p>
  SElinuxfs must also be enabled to mount at boot.
  Add this to /etc/fstab:
</p>
<pre caption="Fstab settings for selinuxfs">
none	/selinux	selinuxfs	defaults	0	0
</pre>
</body></subsection>
</section>

<section><title>Configure Baselayout</title>
<subsection><body>
<p>
SELinux does not support devfs.  You must configure baselayout to
use either static device nodes or udev.  If using udev, the
device tarball must be disabled.  Edit the /etc/conf.d/rc file.
Set RC_DEVICES to static or udev, and RC_DEVICE_TARBALL to no.
If you have several custom device nodes, static is suggested,
otherwise udev is suggested (udev is the default at the time of this writing).
For more information on udev, consult the <uri link="/doc/en/udev-guide.xml">Gentoo UDEV Guide</uri>.
</p>
<pre caption="Init script configuration">
# Use this variable to control the /dev management behavior.
#  auto   - let the scripts figure out what's best at boot
#  devfs  - use devfs (requires sys-fs/devfsd)
#  udev   - use udev (requires sys-fs/udev)
#  static - let the user manage /dev

RC_DEVICES="<comment>udev</comment>"

# UDEV OPTION:
# Set to "yes" if you want to save /dev to a tarball on shutdown
# and restore it on startup.  This is useful if you have a lot of
# custom device nodes that udev does not handle/know about.

RC_DEVICE_TARBALL="<comment>no</comment>"
</pre>
</body></subsection>
</section>

<section><title>Reboot</title>
<subsection><body>
<p>
  We need to make some directories before we reboot.
</p>
<pre caption="Making Required Directories">
# <i>mkdir /selinux</i>
# <i>mkdir /sys</i>
</pre>
<p>
  Now reboot.
</p>
</body></subsection>
</section>
</sections>

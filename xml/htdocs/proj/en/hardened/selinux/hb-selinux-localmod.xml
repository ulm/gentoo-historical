<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/hardened/selinux/Attic/hb-selinux-localmod.xml,v 1.1 2006/10/15 20:32:39 pebenito Exp $ -->

<sections>
<version>1.0</version>
<date>2006-10-15</date>

<section><title>Introduction</title>
<subsection><body>
<p>
  This guide discusses how to set up a policy module for local additions
  of rules to the policy.
</p>
</body></subsection>
</section>

<section><title>Preparation</title>
<subsection><body>
<p>
  Copy the example Makefile from the selinux-base-policy doc directory to the
  directory that will be used for building the policy.  It is suggested that
  /root be used.  The places that the <c>semodule</c> tool can read policy
  modules includes sysadm home directories.
</p>
<pre caption="">
# <i>zcat /usr/share/doc/selinux-base-policy-20061008/Makefile.example.gz > /root/Makefile</i>
</pre>
</body></subsection>
</section>

<section><title>Write a TE file</title>
<subsection><body>
<p>
  In a policy module, most policy statements are usable in modules.
  There are a few extra statements that must be added for proper operation.
</p>
<pre caption="Example local.te">
policy_module(local,1.0)

require {
	type sysadm_su_t, newrole_t;
}
allow sysadm_su_t newrole_t:process sigchld;
</pre>
<p>
  In addition to the basic allow rule, it has a couple statements required
  by policy modules.  The first is a policy_module() macro that has the
  name of the module, and the module's version.  It also has a require
  block.  This block specifies all types that are required for this module
  to function.  All types used in the module must either be declared in the
  module or required by this module.
</p>
</body></subsection>
</section>

<section><title>Write a FC File (optional)</title>
<subsection><body>
<p>
  The file contexts file is optional and has the same syntax as as always.
</p>
<pre caption="Example local.fc">
/opt/myprogs/mybin	--	system_u:object_r:bin_t
</pre>
<p>
  Types used in the file context file should be required or declared in
  the TE file.
</p>
</body></subsection>
</section>

<section><title>Compile Policy Modules</title>
<subsection><body>
<p>
  Simply run <c>make</c> to build all modules in the directory.  The module
  will be compiled for the current policy as specified by /etc/selinux/config.
</p>
<pre caption="">
# <i>make</i>
Compiling strict local module
/usr/bin/checkmodule:  loading policy configuration from tmp/local.tmp
/usr/bin/checkmodule:  policy configuration loaded
/usr/bin/checkmodule:  writing binary representation (version 6) to tmp/local.mod
Creating strict local.pp policy package
</pre>
<p>
  To build the module for a policy other than the configured policy, use the
  <c>NAME=</c> option.
</p>
<pre caption="">
# <i>make NAME=targeted</i>
Compiling targeted local module
/usr/bin/checkmodule:  loading policy configuration from tmp/local.tmp
/usr/bin/checkmodule:  policy configuration loaded
/usr/bin/checkmodule:  writing binary representation (version 6) to tmp/local.mod
Creating targeted local.pp policy package
</pre>
</body></subsection>
</section>

<section><title>Load the Modules</title>
<subsection><body>
<p>
  The modules can be loaded into the currently configured policy simply
  by using the load target of the Makefile.
</p>
<pre caption="">
# <i>make load</i>
</pre>
<p>
  The load target also respects the <c>NAME=</c> option.  Alternatively,
  the <c>semodule</c> command can be used to load individual modules.
</p>
<pre caption="">
# <i>semodule -i local.pp</i>
</pre>
</body></subsection>
</section>

<section><title>Building Reference Policy Modules</title>
<subsection><body>
<p>
The new Gentoo policy is based on the <uri link="http://oss.tresys.com/projects/refpolicy">SELinux Reference Policy</uri>.
For more information on building a complete Reference Policy module, see the
<uri link="http://oss.tresys.com/projects/refpolicy/wiki/GettingStarted">Reference Policy Wiki</uri>.
</p>
</body></subsection>
</section>

</sections>

<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/hardened/selinux/Attic/hb-selinux-loglocal.xml,v 1.6 2006/10/11 04:48:51 pebenito Exp $ -->

<sections>
<version>1.4</version>
<date>2004-11-16</date>

<section><title>Begin Here</title>
<subsection><body>
<p>
  You must be in <c>sysadm_r</c> to perform these actions.
</p>
<p>
  Run <c>sestatus -v</c>.  Click the first context that doesn't match:
</p>
<table>
<tr><th>Process</th><th>Context</th></tr>
<tr><ti>Init context</ti><ti><uri link="#doc_chap2">system_u:system_r:init_t</uri></ti></tr>
<tr><ti>/sbin/agetty</ti><ti><uri link="#doc_chap3">system_u:system_r:getty_t</uri></ti></tr>
<tr><th>File</th><th>Context</th></tr>
<tr><ti>/bin/login</ti><ti><uri link="#doc_chap4">system_u:object_r:login_exec_t</uri></ti></tr>
<tr><ti>/sbin/unix_chkpwd</ti><ti><uri link="#doc_chap5">system_u:object_r:chkpwd_exec_t</uri></ti></tr>
<tr><ti>/etc/passwd</ti><ti><uri link="#doc_chap6">system_u:object_r:etc_t</uri></ti></tr>
<tr><ti>/etc/shadow</ti><ti><uri link="#doc_chap6">system_u:object_r:shadow_t</uri></ti></tr>
<tr><ti>/bin/bash</ti><ti><uri link="#doc_chap7">system_u:object_r:shell_exec_t</uri></ti></tr>
</table>
</body></subsection>
</section>

<section><title>Incorrect Init Context</title>
<subsection><title>Verify Init Label</title>
<body>
<p>
  There are several possible reasons why init may have the wrong context.
  First, verify that init is labeled correctly, refer to the sestatus's output
  for /sbin/init.  If it is not <c>system_u:object_r:init_exec_t</c>, relabel sysvinit.
</p>
<pre caption="Fix init context">
# <i>rlpkg sysvinit</i>
</pre>
</body></subsection>
<subsection><title>Verify Available Policy (2006.1+)</title><body>
<p>
  You must be in <c>sysadm_r</c> to perform this action.
</p>
<p>
  A binary policy must be available in  /etc/selinux/{strict,targeted}/policy.
  If it is missing, then install the policy.
</p>
<pre caption="Install binary policy">
# <i>semodule -n -B</i>
</pre>
</body>
</subsection>

<subsection><title>Verify Available Policy (pre 2006.1)</title><body>
<p>
  An appropriate binary policy version must also be available in 
  /etc/security/selinux.  For example, for policy version 17,
  /etc/security/selinux/policy.17 must exist.  If it is missing, first adjust
  the policy <uri link="?part=4&amp;chap=1#doc_chap6_sect3">Makefile</uri>.
  Then compile and install the policy.
</p>
<pre caption="Install binary policy">
# <i>cd /etc/security/selinux/src/policy</i>
# <i>make clean</i>
# <i>make install</i>
</pre>
</body>
</subsection>
<subsection><title>Verify Init Can Load the Policy</title><body>
<p>
  The final check is to ensure init can load the policy.  Run <c>ldd</c> on
  init, and if libselinux is not in the output, remerge sysvinit.
</p>
<pre caption="Check init linking">
# <i>ldd /sbin/init</i>
  linux-gate.so.1 =>  (0xffffe000)
  <comment>libselinux.so.1 => /lib/libselinux.so.1 (0x40025000)</comment>
  libc.so.6 => /lib/libc.so.6 (0x40035000)
  /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x40000000)
</pre>
<p>
  Now reboot so init gains the correct context, and loads the policy.
</p>
</body></subsection>
</section>

<section><title>Incorrect agetty Context</title>
<subsection><body>
<p>
  Verify that agetty is labeled correctly. Refer to the sestatus's output
  for /sbin/agetty.  If it is not <c>system_u:object_r:getty_exec_t</c>, relabel
  util-linux.  Then restart all gettys.
</p>
<pre caption="Fix agetty context">
# <i>rlpkg util-linux</i>
# <i>killall agetty</i> <comment>(they will respawn)</comment>
</pre>
<p>
  All of the agettys should now be in the correct <c>system_u:object_r:getty_exec_t</c>
  context.  Try logging in again.
</p>
</body>
</subsection>
</section>

<section><title>Incorrect Login Context</title>
<subsection><body>
<p>
  The login program (/bin/login) is not labeled correctly.  Relabel shadow.
</p>
<pre caption="Relabel shadow">
# <i>rlpkg shadow</i>
</pre>
<p>
  /bin/login should now be <c>system_u:object_r:login_exec_t</c>.
  Try logging in again.
</p>
</body>
</subsection>
</section>

<section><title>Incorrect PAM Context</title>
<subsection><body>
<p>
  Sshd must be able to use PAM for authenticating the user.  The PAM password
  checking program (/sbin/unix_chkpwd) must be labeled correctly so
  sshd can transition to the password checking context.  Relabel PAM.
</p>
<pre caption="Fix unix_chkpwd context">
# <i>rlpkg pam</i>
</pre>
<p>
  The password checking program should now be <c>system_u:object_r:chkpwd_exec_t</c>.
  Try loggin in again.
</p>
</body></subsection>
</section>

<section><title>Incorrect Password File Contexts</title>
<subsection><body>
<p>
  The password file (/etc/passwd), and the shadow file (/etc/shadow) must
  be labeled correctly, otherwise PAM will not be able to
  authenticate your user.  Relabel the files.
</p>
<pre caption="Fix shadow context">
# <i>restorecon /etc/passwd /etc/shadow</i>
</pre>
<p>
  The password and shadow files should now be <c>system_u:object_r:etc_t</c>
  and <c>system_u:object_r:shadow_t</c>, respectively.  Try logging in again.
</p>
</body>
</subsection>
</section>

<section><title>Incorrect Bash File Context</title>
<subsection><body>
<p>
  Bash must be labeled correctly so the user can transition into the user
  domain when logging in.  Relabel bash.
</p>
<pre caption="Fix bash context">
# <i>rlpkg bash</i>
</pre>
<p>
  Bash (/bin/bash) should now be <c>system_u:object_r:shell_exec_t</c>.
  Try logging in again.
</p>
</body>
</subsection>
</section>

</sections>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/proj/en/hardened/hardenedfaq.xml" lang="en">
<title>Gentoo Hardened Frequently Asked Questions</title>
<author title="Author">
  <mail link="tocharian@gentoo.org">Adam Mondl</mail>
</author>
<author title="Contributor">
  <mail link="solar@gentoo.org">solar</mail>
</author>
<author title="Contributor">
  <mail link="kang@gentoo.org">Guillaume Destuynder</mail>
</author>
<author title="Contributor">
  <mail link="pageexec@freemail.hu">The PaX Team</mail>
</author>

<abstract>
Frequently Asked Questions that arise on the #gentoo-hardened IRC channel and
the gentoo-hardened mailing list.
</abstract>

<version>1.9</version>
<date>2006-02-18</date>

<chapter>
<title>Questions</title>
<section>
<title>General</title>
<body>

<ul>
  <li>
    <uri link="#toolchain">What exactly is the "toolchain"?</uri>
  </li>
  <li>
    <uri link="#whichisbetter">What should I use: grsecurity, RSBAC or
    SELinux?</uri>
  </li>
  <li>
    <uri link="#aclall">Is it possible to use grsecurity, RSBAC, SELinux and 
    PaX all at the same time?</uri>
  </li>
  <li>
    <uri link="#hardenedcflags">Do I need to pass any flags to LDFLAGS/CFLAGS in
    order to turn on PIE/SSP building?</uri>
  </li>
  <li>
    <uri link="#hardenedcflagsoff">How do I turn off PIE/SSP building?</uri>
  </li>
  <li>
    <uri link="#fsexec">My kernel compilation fails with the error "error:
    structure has no member named `curr_ip'", how do I fix that?</uri>
  </li>
  <li>
    <uri link="#hardenedproject">I just found out about the hardened project; do
    I have to install everything on the project page in order to install
    Hardened Gentoo?</uri>
  </li>
  <li>
    <uri link="#Othreessp">Why don't my programs work when I use CFLAGS="-O3"
    and hardened gcc?</uri>
  </li>
  <li>
    <uri link="#cascadebootstrap">What happened to bootstrap-cascade.sh?</uri>
  </li>
  <li>
    <uri link="#hardenedprofile">How do I switch to the hardened profile?</uri>
  </li>
  <li>
    <uri link="#hardeneddebug">How do I debug with gdb?</uri>
  </li>
</ul>

</body>
</section>

<section>
<title>PaX</title>
<body>

<ul>
  <li>
    <uri link="#paxinformation">What is the homepage for PaX?</uri>
  </li>
  <li>
    <uri link="#paxgentoodoc">What Gentoo documentation exists about PaX?</uri>
  </li>
  <li>
    <uri link="#paxnoelf">I keep getting the message: "error while loading
    shared libraries: cannot make segment writable for relocation: Permission
    denied."  What does this mean?  </uri>
  </li>
  <li>
    <uri link="#paxjava">Ever since I started using PaX I can't get Java
    working, why?</uri>
  </li>
</ul>

</body>
</section>

<section>
<title>grsecurity</title>
<body>

<ul>
  <li>
    <uri link="#grsecinformation">What is the homepage for grsecurity?</uri>
  </li>
  <li>
    <uri link="#grsecgentoodoc">What Gentoo documentation exists about
    grsecurity?</uri>
  </li>
  <li>
    <uri link="#grsec2681">Can I use grsecurity with a 2.6.8, 2.6.8.1, or 2.6.9
    kernel?</uri>
  </li>
</ul>

</body>
</section>

<section>
<title>RSBAC</title>
<body>

<ul>
  <li>
    <uri link="#rsbacinformation">What is the homepage for RSBAC?</uri>
  </li>
  <li>
    <uri link="#rsbacgentoodoc">What Gentoo documentation exists about
    RSBAC?</uri>
  </li>
  <li>
    <uri link="#rsbacinitrd">How do I use an initial ramdisk with a RSBAC
    enabled kernel?</uri>
  </li>
</ul>

</body>
</section>

<section>
<title>SELinux</title>
<body>

<ul>
  <li>
    <uri link="#selinuxfaq">Where can I find SELinux related frequently asked
    questions?</uri>
  </li>
</ul>

</body>
</section>
</chapter>

<chapter>
<title>General Questions</title>
<section id="toolchain">
<title>What exactly is the "toolchain"?</title>
<body>

<p>
The term "toolchain" refers to the combination of software packages commonly
used to build and develop for a particular architecture.  The toolchain you may
hear referred to in the gentoo-hardened IRC channel consists of the GNU Compiler
Collection (GCC), binutils, and the GNU C library (glibc).
</p>

</body>
</section>

<section id="whichisbetter">
<title>What should I use: grsecurity, RSBAC or SELinux?</title>
<body>

<p>
The answer to this question is highly subjective, so the hardened Gentoo project
simply tries to lay out each technology and leave the choice up to the user.
This decision requires a lot of research that we have hopefully provided clearly
in the hardened documentation.  However, if you have any specific questions
about the security model that each provides, feel free to question the relevant
developer in our IRC channel or on the mailing list.
</p>

</body>
</section>

<section id="aclall">
<title>Is it possible to use grsecurity, RSBAC, SELinux and PaX all at the same
time?</title>
<body>

<p>
Yes, this combination is quite possible as PaX works with grsecurity, RSBAC
and SELinux.  The only conflict that arises is you can only use one access
control system.
</p>

</body>
</section>

<section id="hardenedcflags">
<title>Do I need to pass any flags to LDFLAGS/CFLAGS in order to turn on PIE/SSP
building?</title>
<body>

<p>
No, the current toolchain implements the equivalent of <c>CFLAGS="-fPIE
-fstack-protector-all" LDFLAGS="-Wl,-z,now -Wl,-z,relro"</c> automatically
through GCC's specfile which is a more proper solution.  For older hardened-gcc
users, add <c>USE="hardened pic"</c> to your <path>/etc/make.conf</path> and 
then upgrade with the following commands:
</p>

<pre caption="Hardened Toolchain Installation">
# <i>emerge --oneshot binutils gcc virtual/libc</i>
# <i>emerge -e world</i>
</pre>

<note>
Gentoo patches its GCCs to allow specfiles to be passed
through an environment variable.  Currently several sets of specfiles are
installed on Gentoo systems that allow users on supported architectures
to easily switch the functionality off and on of the toolchain.
To access the specs as the end user you can use the gcc-config utility.
</note>

</body>
</section>

<section id="hardenedcflagsoff">
<title>How do I turn off PIE/SSP building?</title>
<body>

<p>
You can use <c>gcc-config</c> to accomplish this:
</p>

<pre caption="Example gcc-config output">
# gcc-config -l
 [1] i686-pc-linux-gnu-3.4.4 *
 [2] i686-pc-linux-gnu-3.4.4-hardenednopie
 [3] i686-pc-linux-gnu-3.4.4-hardenednopiessp
 [4] i686-pc-linux-gnu-3.4.4-hardenednossp
 [5] i686-pc-linux-gnu-3.4.4-vanilla
 
<comment>To turn off SSP building switch to the hardenednossp profile:</comment>
# gcc-config i686-pc-linux-gnu-3.4.4-hardenednossp
</pre>

<p>
Alternatively you can achieve the same by changing your CFLAGS:
</p>

<p>
To turn off default SSP building when using the hardened toolchain, append
<c>-fno-stack-protector-all -fno-stack-protector</c> to your CFLAGS.
</p>

<p>
If you want to turn off default PIE building then append <c>-nopie</c> to your
<c>CFLAGS</c>.
</p>

<impo>
The flag <c>-fno-pic</c> should not be used as it will specifically enable
non-PIC code.  Using <c>-nopie</c> instead will revert back to vanilla GCC
behavior which should be the intended result.
</impo>

<note>
If you are interested in using per-package CFLAGS with Portage currently then
you may be interested in reading about the script solar has developed to deal
with this: <uri>http://article.gmane.org/gmane.linux.gentoo.hardened/1204</uri>
</note>

</body>
</section>

<section id="fsexec">
<title>My kernel compilation fails with the error "error: structure has no
member named `curr_ip'", how do I fix that?</title>
<body>

<p>
In order to use PaX on hardened-sources, you must enable grsecurity as well in
your kernel config.  This should be fixed in a future kernels.
</p>

</body>
</section>

<section id="hardenedproject">
<title>I just found out about the hardened project; do I have to install
everything on the project page in order to install Hardened Gentoo?</title>
<body>

<p>
No, the Hardened Gentoo Project is a collection of subprojects that all have
common security minded goals.  While many of these projects can be installed
alongside one another, some conflict as well such as several of the ACL
implementations that Hardened Gentoo offers.
</p>

</body>
</section>

<section id="Othreessp">
<title>Why don't my programs work when I use CFLAGS="-O3" and hardened
gcc?</title>
<body>

<p>
Using the gcc optimization flag <c>-O3</c> has been known to be problematic with
stack-smashing protector (SSP) in some situations. This optimization flag is not
officially supported and therefore discouraged by the hardened team. Compile
issues where a user uses <c>CFLAGS="-O3"</c> will be closed as INVALID/CANTFIX
and or ignored.
</p>

</body>
</section>

<section id="cascadebootstrap">
<title>What happened to bootstrap-cascade.sh?</title>
<body>

<p>
Recently, the old bootstrap.sh and bootstrap-2.6.sh were deprecated.  In their
place, bootstrap-cascade.sh has been renamed to bootstrap.sh.
</p>

</body>
</section>

<section id="hardenedprofile">
<title>How do I switch to the hardened profile?</title>
<body>

<pre caption="Set make.profile">
# <i>cd /etc</i>
# <i>rm make.profile</i>
# <i>ln -s ../usr/portage/profiles/hardened/x86 make.profile</i> <comment>(For 2.4 kernels)</comment>
# <i>ln -s ../usr/portage/profiles/hardened/x86/2.6 make.profile</i> <comment>(For 2.6 kernels)</comment>
</pre>

<p>
After setting up your profile, you should recompile your system using a
hardened toolchain so that you have a consistent base:
</p>

<pre caption="Switch to hardened toolchain">
# <i>emerge --oneshot binutils gcc virtual/libc</i>
# <i>emerge -e world</i>
</pre>

</body>
</section>

<section id="hardeneddebug">
<title>How do I debug with gdb?</title>
<body>
<p>
First gotcha is that GDB can't resolve symbols in PIEs; it doesn't realise that
the addresses are relative in PIEs not absolute. This shows up when you try to
get a backtrace for example, and see a stream of lines with '??' where the
symbol should be.
</p>
<p>
To get around this, do the final link stage with <c>-nopie</c> - all the
preceding object compilations can still be with <c>-fPIE</c> as normal (i.e. the
default with the hardened compiler) so that your executable is as close as
possible to the real thing, but the final link must create a regular executable.
Try adding <c>-nopie</c> to LDFLAGS if you're building with emerge.
</p>
<p>
Another way of accomplishing this, it to emerge =sys-devel/gdb-6.3-r5, which contains
a special patch that makes it able to debug executeables linked with -pie.
</p>
<p>
The second gotcha is that PaX may prevent GDB from setting breakpoints,
depending on how the kernel is configured. This includes the breakpoint at main
which you need to get started. To stop PaX doing this, the executable being
debugged needs the <c>m</c> and <c>x</c> flags. The <c>x</c> flag is set by
default, so it is enough to do:
</p>
<pre caption="Relax PaX for debug">
# <i>/sbin/paxctl -m foo</i>
</pre>
<p>
At this point, you should be good to go! Fire up gdb in the usual way.  Good
luck!
</p>
</body>
</section>
		
</chapter>

<chapter>
<title>PaX Questions</title>
<section id="paxinformation">
<title>What is the homepage for PaX?</title>
<body>

<p>
The homepage for PaX is located at <uri>http://pax.grsecurity.net</uri>.
</p>

</body>
</section>

<section id="paxgentoodoc">
<title>What Gentoo documentation exists about PaX?</title>
<body>

<p>
Currently the only Gentoo documentation that exists about PaX is a PaX
quickstart guide located at the
<uri>http://www.gentoo.org/proj/en/hardened/pax-quickstart.xml</uri> website.
</p>

</body>
</section>

<section id="paxnoelf">
<title>I keep getting the message: "error while loading shared libraries: cannot
make segment writable for relocation: Permission denied."  What does this
mean?</title>
<body>

<p>
This error occurs when you enable CONFIG_PAX_NOELFRELOCS as such:
</p>

<pre caption="Menuconfig Options">
Non-executable page ->

 [*]   Disallow ELF text relocations
</pre>

<p>
If you are using the gentoo hardened toolchain, typically compiling your
programs will create PIC ELF libraries that do not contain text relocations.
However, certain libraries still contain text relocations for various reasons
(often ones that contain assembly that is handled incorrectly).  This can be a
security vulnerability as an attacker can use non-PIC libraries to execute his
shellcode.  Non-PIC libraries are also bad for memory consumption as they defeat
the code sharing purpose of shared libraries.
</p>

<p>
To disable this error and allow your program to run, you must sacrifice security
and allow runtime code generation for that program.  The PaX feature that allows
you to do that is called MPROTECT.  You must disable MPROTECT on whatever
executable is using the non-PIC library.
</p>

<p>
To check your system for textrels, you can use the program <c>scanelf</c> from
<c>app-misc/pax-utils</c>. For information on how to use the <c>pax-utils</c>
package please consult the <uri link="/proj/en/hardened/pax-utils.xml">Gentoo 
PaX Utilities Guide</uri>.
</p>

<note>
Recent versions of <c>sys-apps/portage</c>(>=2.0.53) scan for text relocations
and print a warning or even abort the merge process, depending on the
<c>FEATURES</c> you have set in your <path>/etc/make.conf</path>.
</note>

</body>
</section>

<section id="paxjava">
<title>Ever since I started using PaX I can't get Java working, why?</title>
<body>

<p>
As part of its design, the Java virtual machine creates a considerable amount of
code at runtime which does not make PaX happy.  There are two ways to correct
this problem:
</p>

<pre caption="Install Chpax">
# <i>emerge chpax</i>
# <i>/etc/init.d/chpax start</i>
</pre>

<p>
Or if you already have <c>chpax</c> emerged then you can do:
</p>

<pre caption="Java Chpax Options">
# <i>chpax -pemrxs /opt/*-jdk-*/{jre,}/bin/*</i>
</pre>

<p>
Both of these options will slightly modify the ELF eheader in order to correctly
set the PAX flags on the binaries.
</p>

<note>
If you are running PaX in conjunction with an additional security implementation
such as RSBAC, grsecurity, or SELinux you should manage PaX using the kernel
hooks provided for each implementation.
</note>

<p>
On RSBAC, you can label all Java files with the following command.
</p>

<pre caption="Java PaX options with RSBAC">
# <i>for i in $(ls /opt/*(jdk|sdk)*/{jre,}/bin/*);do attr_set_file_dir FILE $i pax_flags pmerxs;done</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>grsecurity Questions</title>
<section id="grsecinformation">
<title>What is the homepage for grsecurity?</title>
<body>

<p>
The homepage for grsecurity is located at <uri>http://www.grsecurity.net</uri>.
</p>

</body>
</section>

<section id="grsecgentoodoc">
<title>What Gentoo documentation exists about grsecurity?</title>
<body>

<p>
The most current documentation for grsecurity is a Grsecurity2 quickstart guide
located at <uri>http://www.gentoo.org/proj/en/hardened/grsecurity.xml</uri>.
</p>

</body>
</section>

<section id="grsec2681">
<title>Can I use grsecurity with a 2.6.8, 2.6.8.1, or 2.6.9 kernel?</title>
<body>

<p>
Due to significant changes in the 2.6.8 kernel that broke PaX, neither a PaX nor
a grsecurity patch are available for kernels 2.6.8, 2.6.8.1, or 2.6.9.  Although
an experimental patch is available for 2.6.10, the official stance of the PaX
Team regarding 2.6 kernels should be noted and taken into consideration before
use: <uri> http://forums.grsecurity.net./viewtopic.php?t=968</uri>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>RSBAC Questions</title>
<section id="rsbacinformation">
<title>What is the homepage for RSBAC?</title>
<body>

<p>
The homepage for RSBAC is located at <uri>http://www.rsbac.org</uri>.
</p>

</body>
</section>

<section id="rsbacgentoodoc">
<title>What Gentoo documentation exists about RSBAC?</title>
<body>

<p>
All Gentoo RSBAC documentation is located at the RSBAC subproject page found at:
<uri>http://www.gentoo.org/proj/en/hardened/rsbac/index.xml</uri>
</p>

<p>
Moreover, non-Gentoo RSBAC documentation can be found in the RSBAC handbook,
found at: <uri>http://www.rsbac.org/documentation/rsbac_handbook</uri>
</p>

</body>
</section>

<section id="rsbacinitrd">
<title>How do I use an initial ramdisk with a RSBAC enabled kernel?</title>
<body>

<p>
To use an initial ramdisk with a RSBAC enabled kernel, a special kernel option
must be enabled or else RSBAC will treat the initrd as the root device:
</p>

<pre caption="Menuconfig Options">
General RSBAC options  --->
    [*] Delayed init for initial ramdisk
</pre>

</body>
</section>
</chapter>

<chapter>
<title>SELinux Questions</title>
<section id="selinuxfaq">
<title>Where can I find SELinux related frequently asked questions?</title>
<body>

<p>
A SELinux specific FAQ can be found at <uri>
http://www.gentoo.org/proj/en/hardened/selinux/selinux-handbook.xml?part=3&amp;chap=3</uri>.
</p>

</body>
</section>
</chapter>

</guide>

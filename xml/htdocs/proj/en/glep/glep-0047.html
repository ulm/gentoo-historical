<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/peps/pep-0001.html for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="Docutils 0.3.5: http://docutils.sourceforge.net/" />
  <title>GLEP 47 -- Creating 'safe' environment variables</title>
  <link rel="stylesheet" href="tools/glep.css" type="text/css" />
</head>
<body bgcolor="white">
<table class="navigation" cellpadding="0" cellspacing="0"
       width="100%" border="0">
<tr><td class="navicon" width="150" height="35">
<a href="http://www.gentoo.org/" title="Gentoo Linux Home Page">
<img src="http://www.gentoo.org/images/gentoo-new.gif" alt="[Gentoo]"
 border="0" width="150" height="35" /></a></td>
<td class="textlinks" align="left">
[<b><a href="http://www.gentoo.org/">Gentoo Linux Home</a></b>]
[<b><a href="http://www.gentoo.org/proj/en/glep">GLEP Index</a></b>]
[<b><a href="./glep-0047.txt">GLEP Source</a></b>]
</td></tr></table>
<div class="document">
<table class="rfc2822 field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">GLEP:</th><td class="field-body">47</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Creating 'safe' environment variables</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">1.8</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference" href="http://www.gentoo.org/cgi-bin/viewcvs/xml/htdocs/proj/en/glep/glep-0047.txt?cvsroot=gentoo">2006/01/26 20:56:55</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Diego Pettenò, Fabian rroffen &lt;{flameeyes,grobian}&#64;gentoo.org&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Active</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Proposal</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference" href="glep-0012.html">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">14-Oct-2005</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first"><a name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#credits" id="id9" name="id9">Credits</a></li>
<li><a class="reference" href="#abstract" id="id10" name="id10">Abstract</a></li>
<li><a class="reference" href="#motivation" id="id11" name="id11">Motivation</a></li>
<li><a class="reference" href="#rationale" id="id12" name="id12">Rationale</a></li>
<li><a class="reference" href="#backwards-compatibility" id="id13" name="id13">Backwards Compatibility</a></li>
<li><a class="reference" href="#specification" id="id14" name="id14">Specification</a><ul>
<li><a class="reference" href="#variables" id="id15" name="id15">Variables</a></li>
</ul>
</li>
<li><a class="reference" href="#references" id="id16" name="id16">References</a></li>
<li><a class="reference" href="#copyright" id="id17" name="id17">Copyright</a></li>
</ul>
</div>
<div class="section" id="credits">
<h1><a class="toc-backref" href="#id9" name="credits">Credits</a></h1>
<p>The text of this GLEP is a result of a discussion and input of the
following persons, in no particular order: Mike Frysinger, Diego
Pettenò, Fabian Groffen and Finn Thain.</p>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id10" name="abstract">Abstract</a></h1>
<p>In order for ebuilds and eclasses to be able to make host specific
decisions, it is necessary to have a number of environmental variables
which allow for such decisions.  This GLEP introduces some measures that
need to be made to make these decisions 'safe', by making sure the
variables the decisions are based on are 'safe'.  A small overlap with
GLEP 22 <a class="footnote-reference" href="#id5" id="id1" name="id1">[1]</a> is being handled in this GLEP where the use of 2-tuple
keywords are being kept instead of 4-tuple keywords.  Additionally, the
<tt class="literal"><span class="pre">ELIBC</span></tt>, <tt class="literal"><span class="pre">KERNEL</span></tt> and <tt class="literal"><span class="pre">ARCH</span></tt> get auto filled starting from
<tt class="literal"><span class="pre">CHOST</span></tt> and the 2-tuple keyword, instead of solely from they 4-tuple
keyword as proposed in GLEP 22.</p>
<p>The destiny of the <tt class="literal"><span class="pre">USERLAND</span></tt> variable is out of the scope of this
GLEP.  Depending on its presence in the tree, it may be decided to set
this variable the same way we propose to set <tt class="literal"><span class="pre">ELIBC</span></tt>, <tt class="literal"><span class="pre">KERNEL</span></tt> and
<tt class="literal"><span class="pre">ARCH</span></tt>, or alternatively, e.g. via the profiles.</p>
</div>
<div class="section" id="motivation">
<h1><a class="toc-backref" href="#id11" name="motivation">Motivation</a></h1>
<p>The Gentoo/Alt project is in an emerging state to get ready to serve a
plethora of 'alternative' configurations such as FreeBSD, NetBSD,
DragonflyBSD, GNU/kFreeBSD, Mac OS X, (Open)Darwin, (Open)Solaris and so
on.  As such, the project is in need for a better grip on the actual
host being built on.  This information on the host environment is
necessary to make proper (automated) decisions on settings that are
highly dependant on the build environment, such as platform or as in
<a class="footnote-reference" href="#id6" id="id2" name="id2">[2]</a>.</p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id12" name="rationale">Rationale</a></h1>
<p>Gentoo's unique Portage system allows easy installation of applications
from source packages.  Compiling sources is prone to many environmental
settings and availability of certain tools.  Only recently the Gentoo
for FreeBSD project has started, as second Gentoo project that operates
on a foreign host operating system using foreign (non-GNU) C-libraries
and userland utilities.  Such projects suffer from the current implicit
assumption made within Gentoo Portage's ebuilds that there is a single
type of operating system, C-libraries and system utilities.  In order to
enable ebuilds -- and also eclasses -- to be aware of these
environmental differences, information regarding it should be supplied.
Since decisions based on this information can be vital, it is of high
importance that this information can be trusted and the values can be
considered 'safe' and correct.</p>
</div>
<div class="section" id="backwards-compatibility">
<h1><a class="toc-backref" href="#id13" name="backwards-compatibility">Backwards Compatibility</a></h1>
<p>The proposed keywording scheme in this GLEP is fully compatible with the
current situation of the portage tree, this in contrast to GLEP 22.  The
variables provided by GLEP 22 can't be extracted from the new keyword,
but since GLEP 22-style keywords aren't in the tree at the moment, that
is not a problem.  The same information can be extracted from the CHOST
variable, if necessary.  No modifications to ebuilds will have to be
made.</p>
</div>
<div class="section" id="specification">
<h1><a class="toc-backref" href="#id14" name="specification">Specification</a></h1>
<p>Unlike GLEP 22 the current keyword scheme as used in practice is not
changed.  Instead of proposing a 4-tuple <a class="footnote-reference" href="#id7" id="id3" name="id3">[3]</a> keyword, a 2-tuple
keyword is chosen for archs that require them.  Archs for which a
1-tuple keyword suffices, keep that keyword.  Since this doesn't change
anything to the current situation in the tree, it is considered to be a
big advantage over the 4-tuple keyword from GLEP 22.  This GLEP is an
official specification of the syntax of the keyword.</p>
<p>Keywords will consist out of two parts separated by a hyphen ('-').  The
left hand part of the keyword 2-tuple is the architecture, such as
ppc64, sparc and x86.  The right hand part indicates the operating
system or distribution, such as linux, macos, darwin, obsd, etc.  If the
right hand part is omitted, it implies the operating system/distribution
type is GNU/Linux.  In such case the hyphen is also omitted.  Examples
of such keywords are ppc-darwin and x86.  This is fully compatible with
the current keywords used in the tree.</p>
<p>The variables <tt class="literal"><span class="pre">ELIBC</span></tt>, <tt class="literal"><span class="pre">KERNEL</span></tt> and <tt class="literal"><span class="pre">ARCH</span></tt> are currently set in
the profiles when other than their defaults for a GNU/Linux system.
They can as such easily be overridden and defined by the user.  To
prevent this from happening, the variables should be auto filled by
Portage itself, based on the <tt class="literal"><span class="pre">CHOST</span></tt> variable.</p>
<p>A map file can be used to have the various <tt class="literal"><span class="pre">CHOST</span></tt> values being
translated to the correct values for the four variables.  This change is
invisible for ebuilds and eclasses, but allows to rely on these
variables as they are based on a 'safe' value -- the <tt class="literal"><span class="pre">CHOST</span></tt> variable.
Ebuilds should not be sensitive to the keyword value, but use the
aforementioned four variables instead.  They allow specific tests for
properties.  If this is undesirable, the full <tt class="literal"><span class="pre">CHOST</span></tt> variable can be
used to match a complete operating system.</p>
<p>Current USE-expansion is being maintained, for backwards compatibility.
Since the expansion is based on the variables mentioned above which do
not change, but only in the way they are generated, there should be no
problem in maintaining them.</p>
<div class="section" id="variables">
<h2><a class="toc-backref" href="#id15" name="variables">Variables</a></h2>
<p>The <tt class="literal"><span class="pre">ELIBC</span></tt>, <tt class="literal"><span class="pre">KERNEL</span></tt>, <tt class="literal"><span class="pre">ARCH</span></tt> variables are filled from a profile
file.  The file can be overlaid, such that the following entries in the
map file (on the left of the arrow) will result in the assigned
variables on the right hand side of the arrow:</p>
<pre class="literal-block">
*-*-linux-*      -&gt; KERNEL=&quot;linux&quot;  
*-*-*-gnu        -&gt; ELIBC=&quot;glibc&quot;
*-*-kfreebsd-gnu -&gt; KERNEL=&quot;FreeBSD&quot; ELIBC=&quot;glibc&quot;
*-*-freebsd*     -&gt; KERNEL=&quot;FreeBSD&quot; ELIBC=&quot;FreeBSD&quot;
*-*-darwin*      -&gt; KERNEL=&quot;Darwin&quot; ELIBC=&quot;Darwin&quot;
*-*-netbsd*      -&gt; KERNEL=&quot;NetBSD&quot; ELIBC=&quot;NetBSD&quot;
*-*-solaris*     -&gt; KERNEL=&quot;Solaris&quot; ELIBC=&quot;Solaris&quot;
</pre>
<p>A way to achieve this is proposed by Mike Frysinger <a class="footnote-reference" href="#id8" id="id4" name="id4">[4]</a>, which
suggests to have a env-map file, for instance filled with:</p>
<pre class="literal-block">
% cat env-map
*-linux-* KERNEL=linux
*-gnu ELIBC=glibc
x86_64-* ARCH=amd64
</pre>
<p>then the following bash script can be used to set the four variables to
their correct values:</p>
<pre class="literal-block">
% cat readmap 
#!/bin/bash 

CBUILD=${CBUILD:-${CHOST=${CHOST:-$1}}} 
[[ -z ${CHOST} ]] &amp;&amp; echo need chost 

unset KERNEL ELIBC ARCH 

while read LINE ; do 
    set -- ${LINE} 
    targ=$1 
    shift 
    [[ ${CBUILD} == ${targ} ]] &amp;&amp; eval $&#64; 
done &lt; env-map 

echo ARCH=${ARCH} KERNEL=${KERNEL} ELIBC=${ELIBC}
</pre>
<p>Given the example env-map file, this script would result in:</p>
<pre class="literal-block">
% ./readmap x86_64-pc-linux-gnu 
ARCH=amd64 KERNEL=linux ELIBC=glibc
</pre>
<p>It should be noted, however, that the bash script is a proof of concept
implementation.  It cannot be used as Portage will need this
information, which is written in Python.  Hence, an equivalent of this
bash script should be written in Python to be able to use it within
Portage.  This is considered to be a non-issue coding wise.</p>
</div>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id16" name="references">References</a></h1>
<table class="footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1" name="id5">[1]</a></td><td>GLEP 22, New &quot;keyword&quot; system to incorporate various
userlands/kernels/archs, Goodyear,
(<a class="reference" href="http://glep.gentoo.org/glep-0022.html">http://glep.gentoo.org/glep-0022.html</a>)</td></tr>
</tbody>
</table>
<table class="footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2" name="id6">[2]</a></td><td><p>For example in the perl ebuild, it is necessary to
fill in the C-library part, which on a FreeBSD system is other than
on a Linux system and currently is handled as follows:</p>
<pre class="literal-block">
[[ ${ELIBC} == &quot;FreeBSD&quot; ]] &amp;&amp; myconf=&quot;${myconf} -Dlibc=/usr/lib/libc.a&quot;
</pre>
</td></tr>
</tbody>
</table>
<table class="footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3" name="id7">[3]</a></td><td>For the purpose of readability, we will refer to 1, 2 and
4-tuples, even though tuple in itself suggest a field consisting of
two values.  For clarity: a 1-tuple describes a single value field,
while a 4-tuple decribes a field consisting out of four values.</td></tr>
</tbody>
</table>
<table class="footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4" name="id8">[4]</a></td><td><a class="reference" href="mailto:vapier">mailto:vapier</a> [at) gentoo .dot org</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id17" name="copyright">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
</div>
</div>

<hr class="footer" />
<div class="footer">
<a class="reference" href="glep-0047.txt">View document source</a>.
Generated on: 2006-02-09 21:32 UTC.
Generated by <a class="reference" href="http://docutils.sourceforge.net/">Docutils</a> from <a class="reference" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> source.
</div>
</body>
</html>


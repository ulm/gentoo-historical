<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/peps/pep-0001.html for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="Docutils 0.4: http://docutils.sourceforge.net/" />
  <title>GLEP 55 -- Use EAPI-suffixed ebuilds (.ebuild-EAPI)</title>
  <link rel="stylesheet" href="tools/glep.css" type="text/css" />
</head>
<body bgcolor="white">
<table class="navigation" cellpadding="0" cellspacing="0"
       width="100%" border="0">
<tr><td class="navicon" width="150" height="35">
<a href="http://www.gentoo.org/" title="Gentoo Linux Home Page">
<img src="http://www.gentoo.org/images/gentoo-new.gif" alt="[Gentoo]"
 border="0" width="150" height="35" /></a></td>
<td class="textlinks" align="left">
[<b><a href="http://www.gentoo.org/">Gentoo Linux Home</a></b>]
[<b><a href="http://www.gentoo.org/peps">GLEP Index</a></b>]
[<b><a href="http://www.gentoo.org/proj/en/glep/glep-0055.txt">GLEP Source</a></b>]
</td></tr></table>
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">GLEP:</th><td class="field-body">55</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Use EAPI-suffixed ebuilds (.ebuild-EAPI)</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">1.1</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference" href="http://www.gentoo.org/cgi-bin/viewcvs.cgi/xml/htdocs/proj/en/glep/glep-0055.txt?cvsroot=gentoo">2008/01/05 02:36:35</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Piotr Jaroszy≈Ñski &lt;peper&#32;&#97;t&#32;gentoo.org&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference" href="glep-0002.html">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">17-Dec-2007</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body">17-Dec-2007, 22-Dec-2007</td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic">
<p class="topic-title first"><a id="contents" name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#abstract" id="id3" name="id3">Abstract</a></li>
<li><a class="reference" href="#problem" id="id4" name="id4">Problem</a></li>
<li><a class="reference" href="#abstract-solution" id="id5" name="id5">Abstract solution</a></li>
<li><a class="reference" href="#proposed-solution" id="id6" name="id6">Proposed solution</a></li>
<li><a class="reference" href="#specification" id="id7" name="id7">Specification</a></li>
<li><a class="reference" href="#application" id="id8" name="id8">Application</a></li>
<li><a class="reference" href="#other-ideas" id="id9" name="id9">Other ideas</a></li>
<li><a class="reference" href="#references" id="id10" name="id10">References</a></li>
<li><a class="reference" href="#copyright" id="id11" name="id11">Copyright</a></li>
</ul>
</div>
<blockquote>
<p>&quot;A little learning is a dangerous thing; drink deep, or taste not the Pierian
spring: there shallow draughts intoxicate the brain, and drinking largely
sobers us again.&quot;</p>
<p class="attribution">&mdash;Alexander Pope, An Essay on Criticism</p>
</blockquote>
<div class="section">
<h1><a class="toc-backref" href="#id3" id="abstract" name="abstract">Abstract</a></h1>
<p>This GLEP proposes usage of EAPI-suffixed file extensions for ebuilds (for
example, foo-1.2.3.ebuild-1).</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id4" id="problem" name="problem">Problem</a></h1>
<p>The current way of specifying the EAPI in ebuilds is flawed. In order to get the
EAPI the package manager needs to source the ebuild, which itself needs the EAPI
in the first place. Otherwise it imposes a serious limitation, namely every ebuild,
using any of the future EAPIs, will have to be source'able by old package
managers and hence there is no way to:</p>
<blockquote>
<ul class="simple">
<li>Change behaviour of inherit in any way (for example, to extend or change
eclass functionality).</li>
<li>Add new global scope functions in any sane way.</li>
<li>Extend versioning rules in an EAPI - for example, addition of the scm
suffix - GLEP54 <a class="footnote-reference" href="#glep54" id="id1" name="id1">[1]</a>.</li>
</ul>
</blockquote>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id5" id="abstract-solution" name="abstract-solution">Abstract solution</a></h1>
<p>A solution to this problem has to lift those limitations and the only way to do
it is to make the EAPI of an ebuild available to the package managers in a way
that doesn't require them to source the ebuild. Another important requirement is
for the solution to be backward compatible, which has the pleasant side-effect
of making the solution applicable in the Gentoo tree right away. Opposed to
waiting an arbitrary amount of time, which is never long enough anyway, as the
issues listed on the common portage problems page - <a class="footnote-reference" href="#portageproblems" id="id2" name="id2">[2]</a> - show.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id6" id="proposed-solution" name="proposed-solution">Proposed solution</a></h1>
<p>The proposed solution is to use EAPI-suffixed file extensions for ebuilds. This
allows package managers to trivially read the EAPI from the ebuild filename. It
is also backward compatible, because currently ebuilds are recognised by the
<tt class="docutils literal"><span class="pre">.ebuild</span></tt> file extension and hence EAPI-suffixed ebuilds are simply ignored by
the package managers.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id7" id="specification" name="specification">Specification</a></h1>
<p>Ebuild filename extension syntax: <tt class="docutils literal"><span class="pre">ebuild[-&lt;EAPI&gt;]</span></tt>, where <tt class="docutils literal"><span class="pre">[]</span></tt> denotes an
optional part, and <tt class="docutils literal"><span class="pre">&lt;EAPI&gt;</span></tt> is the EAPI of the ebuild.</p>
<p>Let's call the EAPI included in the ebuild filename the pre-source EAPI, and the
EAPI set inside the ebuild the post-source EAPI. Given these two, the final EAPI
used by the ebuild can be established by following these steps:</p>
<blockquote>
<ul class="simple">
<li>If the pre-source EAPI is not set it defaults to 0.</li>
<li>If the pre-source EAPI is not recognised it is returned immediately.</li>
<li>If the post-source EAPI is not set, it defaults to the pre-source EAPI.</li>
<li>post-source EAPI is returned.</li>
</ul>
</blockquote>
<p>The above process should be only used to generate the metadata cache. Should the
pre-source EAPI be unsupported the cache entry cannot be generated.</p>
<p>Ebuilds with unsupported EAPIs are masked.</p>
<p>QA tools should consider it an error for both EAPIs to be set explicitly to
different values. Package managers may warn, but must use the post-source EAPI
in such cases.</p>
<p>Examples:</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">pkg-1.ebuild</span></tt>, no EAPI set inside the ebuild</dt>
<dd><p class="first last">pre-source EAPI defaults 0, post-source EAPI defaults to pre-source EAPI.
EAPI 0 is used.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">pkg-2.ebuild-1</span></tt>, no EAPI set inside the ebuild</dt>
<dd><p class="first last">pre-source EAPI is 1, post-source EAPI defaults to pre-source EAPI.
EAPI 1 is used.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">pkg-3.ebuild</span></tt>, <tt class="docutils literal"><span class="pre">EAPI=&quot;1&quot;</span></tt></dt>
<dd><p class="first last">pre-source EAPI defaults to 0, post-source EAPI is 1.
EAPI 1 is used.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">pkg-4.ebuild-2</span></tt>, <tt class="docutils literal"><span class="pre">EAPI=&quot;1&quot;</span></tt></dt>
<dd><p class="first last">pre-source EAPI is 2, post-source EAPI is 1.
EAPI 1 is used, but note that one should <strong>never</strong> explicitly set both
EAPIs to different values.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">pkg-5.ebuild-2</span></tt>, no EAPI set inside the ebuild, package manager not supporting EAPI 2</dt>
<dd><p class="first last">pre-source EAPI is 2, post-source EAPI is never checked.
ebuild masked because of the unsupported pre-source EAPI.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">pkg-6.ebuild</span></tt>, <tt class="docutils literal"><span class="pre">EAPI=&quot;2&quot;</span></tt>, package manager not supporting EAPI 2</dt>
<dd><p class="first last">pre-source EAPI defaults to 0, post-source EAPI is 2 (assuming the
package manager didn't die when sourcing the ebuild thinking that EAPI 0
is used).
ebuild masked because of the unsupported post-source EAPI.</p>
</dd>
</dl>
</li>
</ul>
</blockquote>
<p>Note that it is still not permitted to have more than one ebuild with equal
category, package name, and version. Although it would have the advantage of
allowing to provide backward compatible ebuilds, it would introduce problems
too. The first is the requirement to have strict EAPI ordering, the second is
ensuring that all the ebuilds for a single category/package-version are
equivalent, i.e. installing any of them has exactly the same effect to the
system.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id8" id="application" name="application">Application</a></h1>
<p>Note that the developers should only set the pre-source EAPI. The process
described above is only necessary to avoid undefined behaviour in corner cases
and to retain backwards compatibility.</p>
<p>QA tools may warn if the post-source EAPI is set at all, thus helping with the
transition to the new format.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id9" id="other-ideas" name="other-ideas">Other ideas</a></h1>
<p>There were some other solutions proposed on the mailing list:</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>Set the EAPI inside the ebuild in a way that makes it easy to fetch it</dt>
<dd><ul class="first last simple">
<li>Doesn't meet the backward compatibility requirement.</li>
<li>Isn't forward compatible either.</li>
<li>Could be confusing as ebuilds, and not without a reason, are
considered bash scripts and this would impose additional restrictions.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Do the above and change the ebuild extension to <tt class="docutils literal"><span class="pre">.ebuild-ng</span></tt></dt>
<dd><ul class="first last simple">
<li>Meets the backward compatibility requirement.</li>
<li>Still can be confusing.</li>
<li>Isn't really forward compatible. What would be after <tt class="docutils literal"><span class="pre">.ebuild-ng</span></tt>?
<tt class="docutils literal"><span class="pre">.ebuild-ng-ng</span></tt>?</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Use different subdirectories for different EAPIs, i.e. cat/pkg/eapiX/</dt>
<dd><ul class="first last simple">
<li>Meets both requirements.</li>
<li>Introduces a noticeable performance hit (several more directory reads
in an I/O bound operation).</li>
<li>Makes it much harder for maintainers to see what they have.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</blockquote>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id10" id="references" name="references">References</a></h1>
<table class="docutils footnote" frame="void" id="glep54" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1" name="glep54">[1]</a></td><td>GLEP 54, scm package version suffix
(<a class="reference" href="http://glep.gentoo.org/glep-0054.html">http://glep.gentoo.org/glep-0054.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="portageproblems" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2" name="portageproblems">[2]</a></td><td>Common portage problems
(<a class="reference" href="http://www.gentoo.org/proj/en/portage/doc/common-problems.xml">http://www.gentoo.org/proj/en/portage/doc/common-problems.xml</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id11" id="copyright" name="copyright">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- vim: set tw=80 fileencoding=utf-8 spell spelllang=en et : -->
</div>

</div>
<div class="footer">
<hr class="footer" />
<a class="reference" href="glep-0055.txt">View document source</a>.
Generated on: 2008-01-05 02:38 UTC.
Generated by <a class="reference" href="http://docutils.sourceforge.net/">Docutils</a> from <a class="reference" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> source.

</div>
</body>
</html>


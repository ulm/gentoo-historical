<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/desktop/kde/Attic/kde44-46-upgrade.xml,v 1.17 2011/08/12 20:07:56 dilfridge Exp $ -->

<guide>
<title>Gentoo KDE 4.4 - 4.6 Upgrade Guide</title>

<author title="Author">
  <mail link="dilfridge"/>
</author>
<author title="Author">
 <mail link="tampakrap" />
</author>
<author title="Author">
 <mail link="ssuominen" />
</author>

<abstract>
This page provides some hints how the smooth upgrade from KDE SC 4.4 to KDE SC 4.6 
can go even smoother. 
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>0.1</version>
<date>2011-04-09</date>

<chapter>
<title>Introduction</title>
<section>
<title>About the upgrade</title>
<body>

<p>
With the stable KDE upgrade from KDE SC 4.4.5 to KDE SC 4.6.2, an entire major
release number is skipped. Naturally some functionality has been shifted between
packages, some has been replaced or deprecated. On the whole, the upgrade should 
go very smooth. This page collects some tips and tricks for the rare cases when
it does not...
</p>

</body>
</section>
</chapter>




<chapter>
<title>Before / while starting the upgrade</title>
<section>
  <title>Amarok woes (bug 365719)</title>
  <body>
    <p>
    If you are an Amarok user, be warned, there is a bug that can effectively
    delete all your playlist statistics on upgrade. You can get around this only by backing up
    your Amarok database <b>before the upgrade</b>, and doing some rather nasty
    manual hacks. More details can be found in the <uri link="https://bugs.gentoo.org/show_bug.cgi?id=365719">bug 
    report</uri> and in <uri link="http://forum.kde.org/viewtopic.php?f=116&amp;t=94868&amp;p=195086">this KDE forum post</uri>.
    </p>
    </body>
</section>
<section>
  <title>USE flags to be set</title>
  <body>
    <p>
    Before you upgrade your system it is recommended that you set/unset several useflags. 
    Part of that is done automatically if you use a desktop/kde or desktop profile. 
    In detail you should use:
    </p>
    <table>
      <tr>
	<th>flag</th>
	<th>explanation</th>
      </tr>
      <tr>
	<ti>consolekit</ti>
	<ti>Enables the consolekit framework for defining and tracking users, login sessions and seats</ti>
      </tr>
      <tr>
	<ti>dbus</ti>
	<ti>Enables use of the dbus message bus system</ti>
      </tr>
      <tr>
	<ti>policykit</ti>
	<ti>Enables the <b>polkit</b> framework for controlling privileges for system-wide services</ti>
      </tr>
      <tr>
	<ti>udev</ti>
	<ti>Enables support for udev Linux dynamic and persistent device naming</ti>
      </tr>
      <tr>
	<ti>-hal</ti>
	<ti>DISABLES the use of sys-apps/hal for hardware access</ti>
      </tr>
    </table>
    <p>
    Note that other combinations may technically be possible, but may be unsupported, 
    untested, or lead to unexpected loss of functionality.
    </p>
    <p>
    If you changed any global useflags, you should later include the -N flag when running the actual emerge command 
    which updates your system, e.g. 
    </p>
<pre caption="Updating world after a useflag change">
# <i>emerge -uDNav world</i>
</pre>
  </body>
</section>

<section>
<title>Packages that you should deselect or unmerge before upgrade</title>
<body>

<p>
KDE uses some packages outside kde-base for specific services. As an example,
bluetooth integration was in KDE SC 4.4 provided by net-wireless/kbluetooth. 
KDE SC 4.6 uses the new bluetooth system provided by net-wireless/bluedevil, and
kbluetooth and bluedevil cannot be installed at the same time. Normally portage 
should resolve this automatically. However, if you have net-wireless/kbluetooth
in your world file, portage will refuse to unmerge it, blocking the entire upgrade.
In this case you need to run the following command:
</p>

<pre caption="Removing (as an example) net-wireless/kbluetooth from your world file">
# <i>emerge --deselect net-wireless/kbluetooth</i>
</pre>

<p>
Afterwards portage should do a better job resolving the upgrade. A list of such
packages is given below.
</p>

<table>
  <tr>
    <th>package used by KDE 4.4</th>
    <th>replaced by</th>
    <th>remarks</th>
  </tr>
  <tr>
    <ti>net-wireless/kbluetooth</ti>
    <ti>net-wireless/bluedevil</ti>
    <ti>pulled in by bluetooth use flag</ti>
  </tr>
  <tr>
    <ti>kde-misc/filelight</ti>
    <ti>kde-base/filelight</ti>
    <ti>now in main KDE distribution</ti>
  </tr>
</table>

</body>
</section>
</chapter>



<chapter>
<title>Things to do after the upgrade</title>

<section>
<title>Packages you should remove after the upgrade</title>
<body>
<p>
KDE SC 4.6 does not rely on HAL anymore. As HAL is deprecated and interferes with newer
mechanisms for hardware access, it should be removed after the upgrade. Stop the HAL daemon 
and unmerge it, as well as now-obsolete devicekit and policykit (if any of these packages is already gone,
that's of course fine too):
</p>
<pre caption="Stopping and unmerging HAL et al">
# <i>/etc/init.d/hald stop</i>
# <i>emerge -cav hal hal-info policykit devicekit devicekit-disks devicekit-power</i>
</pre>
<p>
Note that you're removing the old <b>policykit</b> here; its successor is <b>polkit</b>. This change should 
usually be transparent (and the useflag is still named <b>policykit</b>, dont get confused by this).
</p>
<p>
If you get at this point a message that hal cannot be unmerged as it is still required by some packages, please check 
in the message which packages exactly still require it. That is considered a bug of these packages and should be 
reported and fixed, as hal will go down the drain soon. Please consider unmerging the remaining packages that require HAL,
or updating them to a testing version that does not depend on hal anymore.
</p>
<p>
Finally, when hal is gone for good, you can remove its init script from the default runlevel:
</p>
<pre caption="Removing the hald init script from the runlevels">
# <i>rc-update del hald</i>
</pre>
<p>
To absolutely make sure that hal never comes back by accident, you can add an entry to the package.mask file:
</p>
<pre caption="/etc/portage/package.mask">
sys-apps/hal
</pre>
<p>
In addition, if you have only now added support for these, you may have to add consolekit and dbus to the
default runlevel:
</p>
<pre caption="Adding the consolekit and dbus init scripts to the default runlevel">
# <i>rc-update add dbus default</i>
# <i>rc-update add consolekit default</i>
</pre>
<p>
If you are rolling your own kernel, you'll want to install a new one with the following options:
</p>
<pre caption="Recommended kernel settings">
CONFIG_USB_SUSPEND=y
CONFIG_IDE=n
CONFIG_AUDITSYSCALL=y
</pre>
<p>
CONFIG_USB_SUSPEND=y and CONFIG_IDE=n are required by sys-fs/udisks. The former enables power management
for devices attached at usb ports, the latter disables the old, deprecated and unsupported ide driver. 
CONFIG_AUDITSYSCALL=y is required by sys-auth/consolekit for some of its features.
</p>
<p>
Now, you may want to reboot (to remove all remains of hal, get the new kernel, and start consolekit etc).
</p>
</body>
</section>

<section>
<title>Packages that you should upgrade</title>
<body>

<p>
Several applications developed for KDE SC 4.4 do not compile properly with KDE SC 4.6
anymore. In addition, newer application versions may require KDE SC 4.6 for its features
and do not build with KDE SC 4.4 anymore... 
We try to stabilize newer versions together with KDE SC 4.6 so noone runs into
these problems; in case of doubts, below is the relevant information for comparison. 
</p>

<table>
  <tr>
    <th>package name</th>
    <th>maximum version for KDE 4.4</th>
    <th>minimum version for KDE 4.6</th>
  </tr>
  <tr>
    <ti>media-gfx/digikam</ti>
    <ti>1.2</ti>
    <ti></ti>
  </tr>
  <tr>
    <ti>media-plugins/kipi-plugins</ti>
    <ti>1.2</ti>
    <ti></ti>
  </tr>
  <tr>
    <ti>app-office/koffice-libs</ti>
    <ti>2.2.2</ti>
    <ti>2.3.2</ti>
  </tr>
</table>

</body>
</section>
</chapter>




<chapter>
<title>Possible problems after the upgrade has completed</title>

<section>
<title>Get rid of the KResource Migration Tool popup</title>
<body>

<p>
There have been reports that the KResource Migration Tool
pops up on every login. There is no proper solution yet for
this, but you can see a workaround in <uri
link="https://bugs.gentoo.org/353200">bug 353200</uri>.
</p>

</body>
</section>

<section>
<title>Rebuilding the application database</title>
<body>

<p>
If your KMenu lacks any application or the whole application list,
you probably need to rebuild the KDE configuration cache. It is also
a possible fix for any KMenu related issues, like missing icons.
Run the following command with the user account having problems:
</p>

<pre caption="kbuildsycoca command">
$ <i>kbuildsycoca4 --noincremental</i>
</pre>

</body>
</section>

<section>
<title>Double-hibernate or crashes after hibernate (bug 363363)</title>
<body>

<p>
KDE 4.6 handles "sleep button" events on its own, and the system correctly
hibernates. If you have manually set up any other programs to handle these events (e.g. 
acpid), please disable that, as you may otherwise get double hibernation and/or
system instability.
</p>
</body>
</section>

<section>
<title>Shutdown, reboot, logout does not work (bug 326393)</title>
<body>

<p>
There is some strange interaction between the sound system and the logout mechanism
going on. Open systemsettings, and disable the "logout sound". Afterwards, 
logging out will likely work.
</p>
</body>
</section>

<section>
<title>The desktop background covers all windows (bug 365623)</title>
<body>

<p>
In rare cases, after working with several screens the desktop settings are not cleaned
up properly. The result is that the desktop background seems to cover all windows.
More details plus some manual workarounds can be found in <uri link="https://bugs.kde.org/show_bug.cgi?id=260360">this
KDE bug report</uri>.
</p>
</body>
</section>


<section>
<title>No login possible, hangs at splash screen (bug 365637)</title>
<body>

<p>
If you have been playing with unstable Gnome stuff (naughty!) you may encounter
a so-far unexplained incompatibility. Logging in to KDE fails as soon as 
net-libs/glib-networking is installed. Unmerge that package and you should be fine.
</p>
</body>
</section>
</chapter>
</guide>

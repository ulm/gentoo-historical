<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/desktop/kde/kde4-guide.xml,v 1.65 2010/11/27 19:04:12 tampakrap Exp $ -->

<guide>
<title>Gentoo KDE Guide</title>

<author title="Author">
  <mail link="tampakrap"/>
</author>
<author title="Author">
  <mail link="scarabeus"/>
</author>
<author title="Author">
  <mail link="jmbsvicetto"/>
</author>
<author title="Author">
  <mail link="cryos"/>
</author>
<author title="Editor">
  <mail link="keytoaster"/>
</author>
<author title="Editor">
  <mail link="nightmorph"/>
</author>

<abstract>
This guide demonstrates how to setup KDE SC using the ebuilds in the tree. Some
tools from the KDE team's git overlay (kde) may be used.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>2.2</version>
<date>2010-11-27</date>

<chapter>
<title>KDE 3</title>
<section>
<title>Quick Information</title>
<body>

<p>
KDE 3 is no longer maintained by upstream, with 3.5.10 being their last release.
Also, most KDE 3 applications aren't maintained any more, as they already have
been or are currently being ported to KDE 4.
</p>

<p>
In Gentoo, KDE 3 ebuilds have been removed from the Portage tree, and they have
been moved to the user-maintained overlay called <uri
link="http://git.overlays.gentoo.org/gitweb/?p=proj/kde-sunset.git;a=summary">kde-sunset</uri>
(available in layman). Keep in mind that this overlay is user-maintained only,
and current KDE team members have no responsibility for its content. If you are
interested in co-maintaining it, you can send an email to <mail link="overlays"
/> asking for commit access. If you want to report a bug about this overlay,
please don't file a bug in Gentoo's Bugzilla. Instead, use the <uri
link="http://archives.gentoo.org/gentoo-desktop/">gentoo-desktop</uri> mailing
list. Instructions on how to subscribe can be found <uri
link="/main/en/lists.xml">here</uri>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>KDE SC 4</title>
<section>
<title>Introduction</title>
<body>

<p>
KDE SC 4 is the current KDE version supported by upstream. In Portage there is a
stable version, and there might be one (or more) non-stable versions. Under
normal conditions new versions get in stabilized after a month. The KDE SC 4
version available through Portage is 4.4.5 (stable by both upstream and
Gentoo).
In addition, KDE upstream provides weekly <uri
link="ftp://ftp.kde.org/pub/kde/unstable">snapshots</uri>, and a <uri
link="http://websvn.kde.org">live SVN tree</uri>. The Gentoo KDE team provides
the snapshots, trunk and latest branch live ebuilds, through the <c>kde</c>
overlay.
</p>

<p>
Choose what KDE SC version is most appropriate for you:
</p>

<table>
  <tr>
    <th>KDE SC Version</th>
    <th>Repository</th>
  </tr>
  <tr>
    <ti><uri link="#kde_portage">KDE SC 4.4.5</uri></ti>
	<ti>Portage</ti>
  </tr>
  <tr>
    <ti><uri link="#kde_portage">KDE SC 4.5.3</uri></ti>
	<ti>Portage</ti>
  </tr>
  <tr>
    <ti><uri link="#snapshots">KDE SC 4.5.xx snapshots</uri></ti>
	<ti>KDE Overlay</ti>
  </tr>
  <tr>
    <ti><uri link="#live">Live Ebuilds (4.5 Branch, Trunk)</uri></ti>
	<ti>KDE Overlay</ti>
  </tr>
</table>

</body>
</section>
<section id="kde_portage">
<title>Installing KDE SC 4.4.5 or 4.5.3 (from Portage)</title>
<body>

<p>
KDE SC 4.4.5 is the currect stable release.
</p>

<pre caption="Installation of KDE SC 4.4.5 using meta packages">
# <i>emerge -av kde-meta</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av kdebase-meta kdegames-meta</i> <comment>(installation of chosen modules only)</comment>
</pre>

<p>
KDE SC 4.5.3 is also in portage, but in ~testing. Users with stable systems
also need to put <uri
link="http://git.overlays.gentoo.org/gitweb/?p=proj/kde.git;a=blob_plain;f=Documentation/package.keywords/kde-4.5.keywords;h=8663dc27daa94aa6f312283cb894e0176d96cc9b;hb=HEAD">
this keywords file</uri> in <path>/etc/portage/package.keywords</path>.
</p>

<pre caption="Installation of KDE SC 4.5.3 using meta packages">
# <i>emerge -av kde-meta</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av kdebase-meta kdegames-meta</i> <comment>(installation of chosen modules only)</comment>
</pre>

<note>KDE SC 4.5 will never go stable though. Reasons are explained on <uri 
link="http://www.gentoo.org/proj/en/desktop/kde/meeting-logs/kde-project-meeting-summary-20100902.txt">
September's meeting summary</uri> and <uri
link="http://blog.tampakrap.gr/gentoo-kde-and-qt-september-meetings/">this
blog post</uri>.
</note>

<p>
Due to a major rewrite in KDEPIM, the upstream KDEPIM developers decided
not to release KDEPIM for KDE 4.5. Instead, they still release new KDEPIM
4.4.x versions (currently 4.4.7), which can be installed with KDE 4.4.5 and
KDE 4.5.3 as well.
</p>

</body>
</section>
<section id="snapshots">
<title>Installing KDE 4.5.80 snapshots (from kde overlay)</title>
<body>

<p>
KDE upstream provides <uri link="ftp://ftp.kde.org/pub/kde/unstable">weekly
snapshots</uri> taken from the <uri link="http://websvn.kde.org/trunk/">SVN
trunk tree</uri>. KDE now provides 4.5.xx snapshot series, and after the 4.6
release they are going to start with 4.6.60. Beta and Release Candidate KDE
releases are following the snapshot model below:
</p>

<table>
  <tr>
    <th>KDE SC Version</th>
    <th>Release Name</th>
  </tr>
  <tr>
    <ti>4.x.80</ti>
	<ti>Beta 1</ti>
  </tr>
  <tr>
    <ti>4.x.85</ti>
	<ti>Beta 2</ti>
  </tr>
  <tr>
    <ti>4.x.90</ti>
	<ti>Release Candidate 1</ti>
  </tr>
  <tr>
    <ti>4.x.95</ti>
	<ti>Release Candidate 2</ti>
  </tr>
</table>

<p>
Snapshots are only available through <c>kde</c> overlay, so first
thing is to install it:
</p>

<pre caption="Installing kde overlay">
# <i>layman -f -a kde</i>
<comment>For more information regarding overlays, please read the <uri
link="http://www.gentoo.org/proj/en/overlays/userguide.xml">Overlay Guide</uri></comment>
</pre>

<p>
Users with stable systems have to keyword the packages to proceed. We provide a
package.keyword file in <c>kde</c> overlay. Due to masked depedencies, KDE SC
4.5.80 should also be masked. We should symlink the files:
</p>

<pre caption="Creating symlink of the keywords file">
# <i>ln -s /path/to/overlay/kde/Documentation/package.keywords/kde-4.6.keywords /etc/portage/package.keywords/</i>
# <i>ln -s /path/to/overlay/kde/Documentation/package.unmask/kde-4.6 /etc/portage/package.unmask/</i>
</pre>

<p>
The installation can be done either by using the meta packages or by using
sets.
</p>

<pre caption="Installation using meta packages">
# <i>emerge -av kde-meta</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av kdebase-meta kdegames-meta</i> <comment>(installation of chosen modules only)</comment>
</pre>

<pre caption="Installation using sets">
# <i>emerge -av @kde-4.6</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av @kdebase-4.6 @kdegames-4.6</i> <comment>(installation of chosen modules only)</comment>

<comment>See the <uri link="#sets">Using Sets</uri> section for more information.</comment>
</pre>

</body>
</section>
<section id="live">
<title>Installing KDE SC live ebuilds (from kde overlay)</title>
<body>

<p>
KDE SC is Open Source, with its code being available for browsing through <uri
link="http://websvn.kde.org">KDE Websvn</uri>, and for public checkout
through an anonymous (anonsvn) account. Gentoo, as a source based distro,
has the ability to provide live ebuilds that checkout the code either from
the latest branch or from trunk. Currently, we provide 4.5.9999 ebuilds from
4.5 branch and 9999 ebuilds from trunk.
</p>

<table>
  <tr>
    <th>Ebuilds Version</th>
    <th>KDE SC Version</th>
  </tr>
  <tr>
    <ti>4.5.9999</ti>
    <ti>KDE 4.5 Branch</ti>
  </tr>
  <tr>
    <ti>9999</ti>
    <ti>KDE 4 Trunk</ti>
  </tr>
</table>

<p>
Live ebuilds are only available through <c>kde</c> overlay, so first
thing is to install it:
</p>

<pre caption="Installing kde overlay">
# <i>layman -f -a kde</i>
<comment>For more information regarding overlays, please read the <uri
link="http://www.gentoo.org/proj/en/overlays/userguide.xml">Overlay Guide</uri></comment>
</pre>

<p>
Users with stable systems have to keyword the packages to proceed.  We provide a
package.keyword file in <c>kde</c> overlay, which we'll have to symlink
to our package.keywords directory:
</p>

<pre caption="Creating symlink of the keywords file">
# <i>cd /etc/portage/package.keywords</i>
# <i>ln -s /path/to/overlay/kde/Documentation/package.keywords/kde-4.5.9999.keywords .</i><comment>(for 4.5 Branch)</comment>
# <i>ln -s /path/to/overlay/kde/Documentation/package.keywords/kde-live.keywords .</i><comment>(for KDE Trunk)</comment>
</pre>

<p>
The installation can be done either by using the meta packages or by using
sets.
</p>

<pre caption="Installation using meta packages">
# <i>emerge -av kde-meta</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av kdebase-meta kdegames-meta</i> <comment>(installation of chosen modules only)</comment>
</pre>

<pre caption="Installation using sets">
<comment>(For KDE SC 4.5 Branch)</comment>
# <i>emerge -av @kde-4.5</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av @kdebase-4.5 @kdegames-4.5</i> <comment>(installation of chosen modules only)</comment>
<comment>(For KDE SC Trunk)</comment>
# <i>emerge -av @kde-live</i> <comment>(contains all of KDE modules)</comment>
# <i>emerge -av @kdebase-live @kdegames-live</i> <comment>(installation of chosen modules only)</comment>

<comment>See the <uri link="#sets">Using Sets</uri> section for more information.</comment>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Additional Installation/Removal Information</title>
<section id="sets">
<title>Using Sets</title>
<body>

<p>
One of the new features provided by Portage 2.2 is sets.
</p>

<p>
Sets allow the KDE team to provide a complete replacement for the monolithic
packages, with the added bonus that users may choose to remove from the default
sets any packages they do not want. There is still some discussion going on
before we can put sets in the Portage tree. Thus, grab the sets from the
<c>kde</c> overlay <uri
link="http://git.overlays.gentoo.org/gitweb/?p=proj/kde.git;a=tree;f=sets">sets
directory</uri> or grab them as a <uri
link="http://git.overlays.gentoo.org/gitweb/?p=proj/kde.git;a=snapshot;h=5b2fc54fa5d1c8aeddaeb05f044bf28754bb18be;sf=tbz2">
tar.bz2 archive</uri> and put the ones you like in <path>/etc/portage/sets</path> --
you can browse the list of sets provided by the KDE team in the overlay
by using the first link.
</p>

<note>
If you are using the kde overlay you can use sets directly
instead of copying them to <path>/etc/portage/sets</path>.
</note>

<p>
Amongst others, there are sets for each KDE tarball - @kdeaccessibility,
@kdeadmin, @kdeartwork, @kdebase, @kdeedu, @kdegames, @kdegraphics,
@kdemultimedia, @kdenetwork, @kdepim, @kdesdk, @kdetoys, and @kdeutils. There is
also a set of sets (the equivalent to the old kde-meta package) @kde, and the
same for specific versions @kde-3.5 and @kde-4x, a set for KDE deps @kdedeps, a
set for optional packages @kdeoptional and a set for the split qt packages
@qt-split.
</p>

<p>
One can install the complete KDE by running <c>emerge -av @kde</c>. The specific
version equivalents are very useful to uninstall an old version, e.g. <c>emerge
-C @kde-3.5</c>, or to reinstall all packages from a specific version, e.g.
<c>emerge -av1 @kde-4x</c>. Advanced features, like removing any unwanted
packages from a set, will be supported in a future release of Portage -- you can
read more about it in <uri
link="http://blogs.gentoo.org/genone/2008/09/29/more_extensions_to_package_set_support">Marius
Mauch's (genone) blog</uri>. Part of this code has now been released in
portage-2.2_rc12, so you can reinstall all installed packages of a set
with <c>emerge -av @&lt;set&gt;/@installed</c> or to have a
<path>/etc/portage/sets/kdebase-unwanted</path> set and then run <c>emerge -av
@kdebase-@kdebase-unwanted</c>.
</p>

<p>
We strongly recommend that you install the <c>kdebase</c> set in order to get a
full KDE 4 session. The example below would install the <c>kdebase</c> set and
the <c>kdegames</c> set.
</p>

<pre caption="Installing KDE SC">
# <i>emerge @kdebase @kdegames</i>
</pre>

<note>
If you want to check the list of sets known to Portage run the following:
<c>emerge --list-sets</c>
</note>

<note>
All >= KDE 4.1 ebuilds require <c>sys-apps/portage-2.1.6</c> or greater,
which has implemented everything in the new EAPI 2 specification used in
these ebuilds (<c>>=sys-apps/portage-2.2_rc12</c> is required to use sets).
</note>

</body>
</section>
<section id="cleanup">
<title>Cleaning Up KDE</title>
<body>

<p>
In order to minimize issues, it is best to begin with a clean environment. This
is recommended for the following cases:
</p>

<ul>
 <li>Moving from <c>+kdeprefix</c> to <c>-kdeprefix</c> (and vice versa)</li>
 <li>
   Downgrading KDE (eg. from snapshots/live ebuilds to the Portage version)
 </li>
 <li>Fully upgrading from KDE 3 to KDE 4 (and vice versa)</li>
 <li>Moving from an old overlay</li>
</ul>

<p>
Two possible ways of removing old KDE installations are:
</p>

<pre caption="Unmerging commands">
# <i>emerge -C @kde-4.X @kdebase-4.X @kde-3.5</i>(using the typical sets)
# <i>emerge -C $(qfile -C -q -e /usr/kde/%PREFIX%)</i> <comment>(replace %PREFIX% with your KDE version, eg. 3.5, 4)</comment>
</pre>

<pre caption="Unmerging commands (only applicable if you are moving from an overlay)">
# <i>cd /path/to/overlay/</i>
# <i>emerge -C $(find ./ -name \*.ebuild |sed -e "s:\.ebuild$::" -e "s:./::" |awk -F'/' '{print "="$1"/"$3}')</i>
</pre>

<p>
As a final step you should remove the old overlay so that there are no conflicts
with the KDE ebuilds. You should remove the old unmask and/or keyword data, too.
</p>

<note>
Don't forget to run <c>emerge --depclean</c> in order to uninstall any dependant
packages.
</note>

</body>
</section>
<section>
<title>Rebuilding the application database</title>
<body>

<p>
To rebuild the KDE application database run:
</p>

<pre caption="kbuildsycoca command">
# <i>kbuildsycoca4 --noincremental</i>
</pre>

</body>
</section>
<section>
<title>Localization/Internationalization</title>
<body>

<p>
With new KDE there is new translators effort in Localization instead of
Internationalization. This cause some confusion, but don't worry; just the name
has been changed.
</p>

<pre caption="Getting the translations">
<comment>For KDE 4 and KOffice 2:</comment>
# <i>emerge kde-l10n</i>
# <i>emerge koffice-l10n</i>
</pre>

</body>
</section>
<section>
<title>Migrating configs from 3.5 to 4.X</title>
<body>

<p>
KDE stores its configuration files in the <path>~/.kde</path> directory by
default. In the Gentoo ebuilds this has been changed in KDE 4.X to
allow for better integration of KDE 3.5 and 4.X when using the same user
account. If you export $KDEHOME this behaviour will be overridden. It is
strongly recommended that you do not do this. $KDEHOME will make KDE 3.5 and 4.X
use the same configuration directory which is usually not desired.
</p>

<p>
KDE 3.5 uses <path>~/.kde</path> and the default FHS (<c>-kdeprefix</c>) KDE 4.X
uses <e>~/.kde4</e>.
</p>

<p>
Settings are not migrated by default. If you want to attempt to migrate your
settings you should copy your old configuration directory to the new location
before logging in. For example:
</p>

<pre caption="Copying the configuration directory">
$ <i>cp -r ~/.kde ~/.kde4</i>
</pre>

<p>
If this is successful, then your settings should all be migrated. If not, it is
possible to log out and remove the new configuration directory to start with a
clean configuration directory.
</p>

<impo>
Moving backwards in version, from 4.X to 3.5, is not supported.
</impo>

</body>
</section>
</chapter>

<chapter>
<title>Hints and Troubleshooting</title>
<section>
<title>Plasmoids</title>
<body>

<p>
Plasmoids are new plasma tools which can enhance your desktop experience. Many
plasmoids are available in the kde-misc/ category. If you find out that your
favorite plasmoid is missing, file a bug and somebody might create it for you.
If you've got to have them all, there is a set called @plasmoids which contains
all plasmoids currently available.
</p>

<note>
Many plasmoids are in the kde overlay.
</note>

</body>
</section>
<section>
<title>Plasma Themes</title>
<body>

<p>
The ebuild that contains various plasma themes is called
<c>x11-themes/plasma-themes</c>. The procedure for requesting
additional themes is the same as that for plasmoids.
</p>

</body>
</section>
<section>
<title>Make GTK applications look like Qt 4 ones</title>
<body>

<p>
The ebuild that should be used if you want your GTK applications to use the same
theme as your Qt applications is called <c>x11-themes/gtk-engines-qtcurve</c>.
You must also install <c>x11-themes/qtcurve-qt4</c> for this to work with Qt 4/KDE 4
applications. In order to get configuration options in System Settings->Appearance->GTK
Styles and Fonts, you have to install <c>kde-misc/kcm_gtk</c>.
</p>

</body>
</section>
<section>
<title>Akonadi complains about the MySQL config</title>
<body>

<p>
Start by checking the permissions in <path>/usr/share/config</path> and
<path>/usr/share/kde4</path>. If they're 700, you need to update them to 755
recursively.
</p>

<pre caption="Updating /usr/share/config permissions">
# <i>chmod -R 755 /usr/share/{config,kde4}</i>
</pre>

<p>
If that doesn't solve the error, you need to open the akonadi configuration and
change the default mysql config. If you don't have the tray running, start
<c>akonaditray</c>, select "Akonadi Server Configuration", activate  "Use
internal MySQL server" and then press the test button.  If you want to use the
mysql server and not the embedded executable, you'll need to ensure that mysql
is running.
</p>

</body>
</section>
<section>
<title>Make KDE start on boot</title>
<body>

<p>
There are two ways to make KDE start on boot. The easiest way is by using the KDM,
which is available at <c>kde-base/kdm</c>. First we edit the Xorg Configuration file,
so that DISPLAYMANAGER is set to "kdm":
</p>

<pre caption="Editing /etc/conf.d/xdm">
# What display manager do you use ?  [ xdm | gdm | kdm | kdm-4.3 | gpe | entran$
# NOTE: If this is set in /etc/rc.conf, that setting will override this one.
#
# KDE-specific note:
# - If you are using kdeprefix go with "kdm-4.Y", e.g. "kdm-4.3".
#     You can find possible versions by looking at the directories in /usr/kde/.
# - Else, if you are using KDE 3 enter "kdm-3.5"
# - Else, if you are using KDE 4 enter "kdm" without a version
DISPLAYMANAGER="kdm"
</pre>

<p>
Next step is to add xdm to default runlevel:
</p>

<pre caption="Adding xdm to the default runlevel">
# <i>rc-update add xdm default</i>
</pre>

</body>
</section>
<section>
<title>Fonts suggestions</title>
<body>

<p>
If you click to view the menu and notice that there is nothing legible, you need
to install some fonts. Some common choices are <c>media-fonts/corefonts</c>,
<c>media-fonts/ttf-bitstream-vera</c> and <c>media-fonts/dejavu</c>.
</p>

</body>
</section>
<section>
<title>KDM fails to start</title>
<body>

<p>
Start by checking the permissions in /usr/share/config. If they're 700, you need
to update them to 755.  Check previous section.  If that doesn't solve the
error, check the following notice in the kdm ebuild:
</p>

<pre caption="kdm notice">
If when you restart xdm, kdm fails to start with a message like "gentoo kdm[2116]: X
server startup timeout, terminating" in /var/log/messages, uncomment the ServerTimeout
line in "grep kdmrc /var/db/pkg/kde-base/kdm-4.3.1/CONTENTS | cut -f2 -d " ""
and be sure to increase the timeout - 60 should work
</pre>

<p>
Also be sure that the following services are started:
</p>

<pre caption="checking and starting services">
# <i>/etc/init.d/dbus status</i>
# <i>/etc/init.d/hald status</i>
# <i>/etc/init.d/consolekit status</i>
</pre>

<p>
If not, enable them by replacing <c>status</c> with <c>start</c>, and use the
command <c>rc-update add dbus default</c> for every one of them to add them to
default runlevel.
</p>

<p>
Finally, KDM could fail due to errors in <path>/etc/X11/xorg.conf</path>. Take a
look in your logs: <path>/var/log/Xorg.0.log</path> and
<path>/var/log/kdm.log</path> and fix <path>xorg.conf</path> accordingly.  For
additional help you can find us in IRC (#gentoo-kde at Freenode).
</p>

</body>
</section>
<section>
<title>The battery applet or solid notifications don't show the relevant info</title>
<body>

<p>
So that the battery applet or other solid notifications can show the relevant
info, you need dbus and hald running.
</p>

<pre caption="checking and starting dbus and hald">
# <i>/etc/init.d/dbus status</i>
# <i>/etc/init.d/hald status</i>
# <i>/etc/init.d/dbus start</i>
# <i>/etc/init.d/hald start</i>
</pre>

</body>
</section>
<section>
<title>Desktop profile and subprofiles</title>
<body>

<p>
Desktop profile has been split to KDE and GNOME subprofiles.
This means that KDE and GNOME specific USE flags have been stripped
from the basic desktop profile and have been migrated to the subprofiles.
Choosing a subprofile doesn't restrict you to use only the equivalent
DE.
</p>

</body>
</section>
</chapter>
</guide>

<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/en/vps/Attic/stage4-howto.xml,v 1.3 2012/10/28 15:21:17 swift Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide>
<title>Howto create custom VPS stages</title>

<author title="Author">
  <mail link="hollow@gentoo.org">Benedikt Boehm</mail>
</author>

<abstract>
In this Howto you will learn how to create your own stage4 tarballs for use
as virtual private server templates.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.0</version>
<date>2007-03-26</date>

<chapter>
<title>Introduction</title>
<section>
<title>Motivation</title>
<body>

<p>
In most cases there is not a single vserver on one machine, but rather plenty
of them. To ease installation and save resources it is recommended to create
custom stages with necessary packages already included, so there is no need to
compile the initial software in the guest environment.
</p>

</body>
</section>
<section>
<title>Requirements</title>
<body>

<p>
To create stages Gentoo developers use a tool called catalyst. If you do not
already have it installed on your system please do so:
</p>

<pre caption="Install catalyst">
# <i>emerge dev-util/catalyst</i>
</pre>

<p>
Since the base requirement for every Gentoo system is a stage3, you don't have
to bother about building stage1, 2 or 3, but rather download a precompiled
stage3 for your architecture and add your custom packages. As soon as as
baselayout-1.13 is stable you can use a regular stage3 available from one of
<uri link="/main/en/mirrors.xml">our mirrors</uri>. In the meantime please
download a stage3 from
<uri link="http://people.linux-vserver.org/~hollow/stages/">here</uri>.
</p>

<pre caption="Download precompiled stage3">
# <i>mkdir -p /var/tmp/catalyst/builds/default</i>
# <i>cd /var/tmp/catalyst/builds/default</i>
# <i>wget http://people.linux-vserver.org/~hollow/stages/stage3-&lt;ARCH&gt;-&lt;DATE&gt;.tar.bz2</i>
</pre>

<p>
Finally, you need a copy of the portage tree used by catalyst. You can either
download a snapshot from on of
<uri link="/main/en/mirrors.xml">our mirrors</uri> or create one yourself.
</p>

<pre caption="Get a portage snapshot">
<comment>(Download from our mirrors)</comment>
# <i> mkdir -p /var/tmp/catalyst/snapshots</i>
# <i> cd /var/tmp/catalyst/snapshots</i>
# <i>wget http://url/to/snapshots/portage-latest.tar.bz2</i>

<comment>(Create one yourself)</comment>
# <i>catalyst -s latest</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Building your stage4</title>
<section>
<title>Download a spec-file template</title>
<body>

<p>
The Gentoo VPS team provides
<uri link="http://people.linux-vserver.org/~hollow/stages/specs">several spec files</uri>
that can be used with catalyst. In many cases it is probably enough to just
download a spec-file and start building. However, if you want to customize the
list of packages even further, take a look at the spec-files and the
<uri link="/proj/en/releng/catalyst/2.x/reference.xml">catalyst reference manual</uri>.
</p>

<pre caption="Download a spec-file">
# <i>CONFDIR=/etc/vservers/.stages</i>
# <i>mkdir -p $CONFDIR/specs</i>
# <i>cd $CONFDIR/specs</i>
# <i>wget http://people.linux-vserver.org/~hollow/stages/specs/stage4-&lt;ARCH&gt;-&lt;NAME&gt;.spec</i>
</pre>

<p>
As long as baselayout-1.13 is not stable you need to keyword/unmask baselayout
and some dependencies. Fortunately, the spec-files are already prepared for
this and the list of dependencies is rather small.
</p>

<pre caption="Unmask baselayout">
# <i>mkdir -p $CONFDIR/portage</i>
# <i>echo sys-apps/baselayout &gt;&gt; $CONFDIR/portage/package.keywords</i>
# <i>echo sys-apps/makedev    &gt;&gt; $CONFDIR/portage/package.keywords</i>
# <i>echo app-shells/bash     &gt;&gt; $CONFDIR/portage/package.keywords</i>
# <i>echo sys-apps/baselayout &gt;&gt; $CONFDIR/portage/package.unmask</i>
# <i>echo sys-apps/makedev    &gt;&gt; $CONFDIR/portage/package.unmask</i>
</pre>

</body>
</section>
<section>
<title>Start build process</title>
<body>

<p>
Your environment is now ready to start the build process with catalyst. To be
able to maintain multiple stages in one repository, there is no version number
in the spec-files, so you have to specify it on the command line.
</p>

<pre caption="Run catalyst">
# <i>time catalyst -f $CONFDIR/specs/stage4-&lt;ARCH&gt;-&lt;NAME&gt;.spec -C version_stamp=$(date +%Y%m%d)</i>
</pre>

<p>
Depending on your hardware and package selection this can take a rather long
time, so get yourself a cup of coffee and check back occasionally. Once
finished, the newly created stage can be found in
<path>/var/tmp/catalyst/builds/default</path>.
</p>

</body>
</section>
<section>
<title>Contact</title>
<body>

<p>
Please feel free to contact the <mail link="hollow@gentoo.org">author</mail> or
file a bug on <uri link="http://bugs.gentoo.org">Bugzilla</uri> in case of any
problems or if you wish to contribute custom spec-files.
</p>

</body>
</section>
</chapter>
</guide>

<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The context of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommonds.org/licenses/by-sa/1.0 -->

<sections>

<version>2004.3</version>
<date>February 20, 2005</date>

<section>

<title>Howto Upgrade an AMD64 installation from 2004.3 to 2005.0.</title>
<body>
<p>
Multilib is now forced on in the base 2005.0 profile.  If you wish to have a pure-64bit system, you can use the 2005.0/no-multilib profile.  This guide will show you how to upgrade a prior installation to a system that uses our new profile. There are two ways of upgrading: the easy and scripted way, or the longer way by hand.
</p>
<p>
2005.0 hasn't been released yet, so there are still some changes you will need to make in /etc/portage to get this process to work:
</p>
<pre>
# <i>echo '=app-emulation/emul-linux-x86-glibc-2.3.4.20041102 ~amd64' >> /etc/portage/package.keywords</i>
# <i>echo '>=sys-kernel/linux-headers-2.6' >> /etc/portage/package.unmask</i>
</pre>
</body>
</section>

<section>
<title>Updating to 2005.0 (multilib)</title>
</section>

<section>
<title>The Easy, Scripted Way</title>
<body>
<pre>
# <i>mkdir /usr/tmp/profile-update</i>
# <i>cd /usr/tmp/profile-update</i>
# <i>wget http://amd64.gentoo.org/Makefile-profile_update-2005.0</i>
# <i>lynx -source http://amd64.gentoo.org/Makefile-profile_update-2005.0.md5sum | md5sum -c -</i>
<codenote>If you use a PORTDIR other than /usr/portage, please edit the PORTDIR variable in the Makefile.</codenote>
# <i>make -f Makefile-profile_update-2005.0</i>
# <i>emerge -upv system</i>
# <i>emerge -uv system</i>
</pre>
</body>
</section>

	
<section>
<title>Upgrading by hand</title>
<body>
<p>
If you currently have USE=-multilib, you need to set multilib in USE and re-emerge gcc. 
</p>
<pre>
# <i>nano /etc/make.conf</i>
<codenote>remove -mutilib from USE flags</codenote>

# <i>emerge gcc</i>
<codenote>If youu get an error about not having a multilib sandbox, you need to set FEATURES=-sandbox</codenote>
# <i>FEATURES=-sandbox emerge gcc</i>
</pre>
<p>
Additionally, you need to make sure you have the required versions of toolchain/portage packages as these are needed to properly rebuild glibc after switching the profile.
</p>
<pre>
# <i>emerge -v --oneshot '>=sys-apps/portage-2.0.51-r9'</i>
# <i>emerge -v --oneshot '>=sys-devel/gcc-config-1.3.9'</i>
# <i>emerge -v --oneshot '>=sys-devel/distcc-2.18.3-r1'</i>
# <i>emerge unmerge linux26-headers</i>
# <i>emerge -v --oneshot '>=linux-headers-2.6.8.1-r4'</i>
</pre>
<p>
Next, make sure our 32bit glibc version is up to date.  This version is needed to bootstrap the 32bit glibc build after the profile switch.
</p>
<pre>
# <i>emerge -v --oneshot '>=emul-linux-x86-glibc-2.3.4.20041102'</i>
</pre>
<p>
2005.0 doesn't use symlinks from /lib32 and /usr/lib32 to the emul directories, so we need to change them into directories and copy over some important files.
</p>
<pre>
# <i>rm /lib32 /usr/lib32</i>
# <i>mkdir /lib32 /usr/lib32</i>
# <i>cp /emul/linux/x86/lib32/libsandbox.so /lib32</i>
# <i>cp /emul/linux/x86/usr/lib32/libc.so /usr/lib32</i>
# <i>cp /emul/linux/x86/usr/lib32/libpthread.so /usr/lib32</i>
# <i>cp /emul/linux/x86/usr/lib32/*crt*.o /usr/lib32</i>
# <i>env-update</i>
</pre>
<p>
Now, we need to make sure our baselayout is up to date, so we can gurantee /etc/env.d/04multilib exists.
</p>
<pre>
# <i>emerge -v --oneshot baselayout</i>
</pre>
<p>
We are now ready to actually switch the profile to 2005.0
</p>
<pre>
# <i>rm /etc/make.profile</i>
# <i>ln -s /usr/portage/profiles/default-linux/amd64/2005.0 /etc/make.profile</i>
</pre>
<p>
Now just build glibc, unmerge the emul-* ones and update the base system.
</p>
<pre>
# <i>emerge -v --oneshot '>=sys-libs/glibc-2.3.4.20041102'</i>
# <i>emerge unmerge emul-linux-x86-glibc</i>
# <i>emerge -upv system</i>
# <i>emerge -uv system</i>
</pre>
</body>
</section>

<section>
<title>Updating to the 2005.0/no-multilib (64bit only) profile</title>
<body>
<p>
Use this profile if you don't want any 32bit applications installed on your system.  This means you won't be able to play x86 games, use openoffice-bin, mplayer-bin, mozilla-bin (flash), acroread, etc.
</p>
<pre>
# <i>rm /etc/make.profile</i>
# <i>ln -s /usr/portage/profiles/default-linux/amd64/2005.0/no-multilib /etc/make.profile</i>
# <i>emerge -upv system</i>
# <i>emerge -uv system</i>
</pre>
</body>
</section>
</sections>

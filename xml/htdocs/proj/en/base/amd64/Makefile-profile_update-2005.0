PORTDIR=/usr/portage

#--- You shouldn't need to chane anything past this line ---

PORTAGE_REQ=>=sys-apps/portage-2.0.51-r9
GCC_CONFIG_REQ=>=sys-devel/gcc-config-1.3.9
DISTCC_REQ=>=sys-devel/distcc-2.18.3-r1
EMUL_GLIBC_REQ=>=app-emulation/emul-linux-x86-glibc-1.2
LINUX_HEADERS_REQ=>=sys-kernel/linux-headers-2.6

all: $(HASM32) complete

step0:
	@[ "`gcc -m32 -print-multi-directory`" = "32" ] || { echo "Your compiler does not have multilib support.  Please emerge gcc with USE=multilib.  If your portage is not multilib enabled, you will need to do FEATURES=-sandbox emerge gcc." ; exit 1;}

	# Always install portage since current might not be multilib friendly
	emerge -v --oneshot '$(PORTAGE_REQ)'
	@touch step0

step1: step0
	portageq has_version / '$(GCC_CONFIG_REQ)' || emerge -v --oneshot '$(GCC_CONFIG_REQ)'
	portageq has_version / '$(EMUL_GLIBC_REQ)' || emerge -v --oneshot '$(EMUL_GLIBC_REQ)'
	portageq has_version / '$(DISTCC_REQ)' || emerge -v --oneshot '$(DISTCC_REQ)'
	@touch step1

step2: step1
	portageq has_version / linux26-headers && emerge unmerge linux26-headers || true
	portageq has_version / '$(LINUX_HEADERS_REQ)' || emerge -v --oneshot '$(LINUX_HEADERS_REQ)'
	[ -f /etc/env.d/04multilib ] || emerge -v --oneshot baselayout
	[ -f /etc/env.d/04multilib ]
	env-update
	@touch step2

step3: step2
	[ -L /lib32 ] && rm /lib32 || true
	[ -L /usr/lib32 ] && rm /usr/lib32 || true
	[ -L /usr/X11R6/lib32 ] && rm /usr/X11R6/lib32 || true
	[ -d /lib32 ] || mkdir /lib32
	[ -d /usr/lib32 ] || mkdir /usr/lib32
	[ -d /usr/X11R6/lib32 ] || mkdir /usr/X11R6/lib32
	cp /emul/linux/x86/lib32/libsandbox.so /lib32
	cp /emul/linux/x86/usr/lib32/libc.so /usr/lib32
	cp /emul/linux/x86/usr/lib32/libpthread.so /usr/lib32
	[ -d /emul/linux/x86/usr/lib32/nptl ] && mkdir /usr/lib32/nptl || true
	[ -d /emul/linux/x86/usr/lib32/nptl ] && cp /emul/linux/x86/usr/lib32/nptl/libc.so /usr/lib32/nptl || true
	[ -d /emul/linux/x86/usr/lib32/nptl ] && cp /emul/linux/x86/usr/lib32/nptl/libpthread.so /usr/lib32/nptl || true
	env-update
	@touch step3

step4: step3
	[ -L /etc/make.profile ] && rm /etc/make.profile
	ln -s $(PORTDIR)/profiles/default-linux/amd64/2005.0 /etc/make.profile
	@touch step4

step5: step4
	emerge -v --oneshot glibc
	emerge unmerge emul-linux-x86-glibc
	@touch step5

complete: step5
	@echo "-------------------------------------------------------------------"
	@echo "Congradulations, you're almost finished updating to 2005.0.  Please"
	@echo "run 'emerge -upv system' followed by 'emerge -uv system' to finish."

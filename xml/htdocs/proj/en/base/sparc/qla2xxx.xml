<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/proj/en/base/sparc/qla2xxx.xml">
<title>How to get QLA2xxx working with kernel >=2.6.18 on Gentoo/SPARC</title>

<author title="Author">
  <mail link="armin76"/>
</author>
<author title="Editor">
  <mail link="nightmorph"/>
</author>

<abstract>
This guide shows you how to get the QLA2xxx adapter working on your Sparc for
kernel 2.6.18 and up.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1</version>
<date>2008-05-23</date>
 
<chapter>
<title>Overview</title>
<section>
<body>

<p>
Booting Linux from a harddrive connected to a QLA2xxx fibre channel adapter (as
used in the Sun Blade 1000 and 2000) has become a bit complicated since the
firmware has been removed from the kernel (version 2.6.18, commit
441d1072040823feb4950a21094860bfddd310c0).
</p>

<p>
To make it work with a recent kernel, such as 2.6.24, you need an initramfs that
loads the firmware for this driver before the root filesystem is mounted.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Requirements</title>
<section>
<body>

<p>
To create the initramfs, you'll need the following packages:
</p>

<ul>
  <li>
    <c>virtual/linux-sources</c> (<c>gentoo-sources</c>, <c>vanilla-sources</c>,
    etc.)
  </li>
  <li><c>sys-block/qla-fc-firmware</c></li>
  <li><c>>=sys-kernel/genkernel-3.4.10_pre7</c></li>
</ul>

<impo>
You need to symlink the kernel sources directory you want to compile to
<path>/usr/src/linux</path>.
</impo>

</body>
</section>
</chapter>

<chapter>
<title>Configure the kernel</title>
<section>
<body>

<p>
Once you have those packages emerged, you'll need to run the following command:
</p>

<pre caption="Running genkernel">
# <i>genkernel --menuconfig --firmware-files=/lib/firmware/ql2200_fw.bin all</i>
</pre>

<p>
After that, you'll need to configure your kernel, and you need the following
options:
</p>

<pre caption="Configuration options">
General Setup ---&gt;
 [*] Initial RAM filesystem and RAM disk (initramfs/initrd) support

Device Drivers  ---&gt;
 SCSI device support  ---&gt;
  SCSI low-level drivers  ---&gt;
   &lt;M&gt; QLogic QLA2XXX Fibre Channel Support
</pre>

<p>
Which translated to the <path>.config</path> file they would be:
</p>

<pre caption=".config options">
CONFIG_BLK_DEV_INITRD=y
CONFIG_SCSI_QLA_FC=m
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Installing the kernel and configuring SILO</title>
<section>
<body>

<p>
Once you've configured the kernel, genkernel should start compiling the kernel
and building the initramfs. After it finished, it automatically installs to
<path>/boot</path>, so now you only need to configure your SILO.
</p>

<p>
To do so, you only need to edit your silo.conf, which its normally in
<path>/etc/silo.conf</path>. Just open it with your favorite editor, and
adjust it to suit your needs.
</p>

<pre caption="Sample silo.conf">
partition = 1
default = gentoo
timeout = 0

image = /boot/kernel-genkernel-sparc64-2.6.24-gentoo-r4
        label = gentoo
        initrd = /boot/initramfs-genkernel-sparc64-2.6.24-gentoo-r4
        append = "rdinit=/linuxrc real_root=/dev/sda4"
</pre>

</body>
</section>
</chapter>
</guide>

<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/pl/base/x86/gcc-upgrading-guide.xml,v 1.1 2005/12/07 19:11:47 rane Exp $ -->

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/proj/pl/base/x86/gcc-upgrading-guide.xml" lang="pl">
<title>Aktualizacja GCC w Gentoo Linux</title>

<author title="Author">
<mail link="amne@gentoo.org">Wernfried Haas</mail>
</author>

<author title="Editor">
<mail link="wolf31o2@gentoo.org">Chris Gianelloni</mail>
</author>

<abstract>
Opis aktualizacji kompilatora GCC w Gentoo.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.3</version>
<date>2005-12-06</date>

<chapter>
<title>Wstęp</title>
<section>
<body>

<p>
W tym przewodniku skupimy się na uaktualnieniu GCC 3.3 do GCC 3.4, ale
instrukcje w nim zawarte mogą zostać użyte do uaktualniania dowolnych wersji
GCC.
</p>

<p>
Sama instalacja gcc 3.4.4 nie ma żadnego wpływu na system. Aby z niego
skorzystać musimy odpowiednio skonfigurować kilka rzeczy.  Ten krok może zabrać
nam sporo czasu, więc upewnijmy się czy mamy go odpowiednio dużo oraz czy
jesteśmy do tego przygotowani. Jest kilka sposobów przygotowania tego
uaktualnienia. Pierwsza metoda jest szybka, ale może przypadkowo pominąć dwa
lub trzy pakiety, które wymagają uaktualnienia. Druga metoda jest
bezpieczniejsza, jednak wymaga znacznie więcej kompilacji.
</p>

<note>
Przed rozpoczęciem uaktualniania jakąkolwiek metodą, powinniśmy wyłączyć distcc
jeżeli jest ono uruchomione. Jeżeli komputery połączone przez distcc nie mają
zainstalowanego gcc-3.4 mogą pojawić się prbolemy z kompilacją. Nie jest to
wymagana w przypadku ccache, ponieważ obiekty z ccache i tak zostaną
unieważnione.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Użycie revdep-rebuild (szybsza metoda)</title>
<section>
<body>

<p>
Ta metoda wymaga abyśmy najpierw zainstalowali pakiet <c>gentoolkit</c> -
oczywiście jeżeli do tej pory jeszcze tego nie zrobiliśmy.  Następnie
uaktualnimy GCC i skonfigurujemy system tak, aby go używał.
</p>

<pre caption="Instalacja gentoolkit i ukatualnianie GCC">
# <i>emerge -an gentoolkit</i>
# <i>emerge -uav gcc</i>
# <i>gcc-config i686-pc-linux-gnu-3.4.4</i>
# <i>source /etc/profile</i>
</pre>

<note>
Zakładając, że mamy ustawioną zmienną CHOST="i686-pc-linux-gnu". Jeżeli
natomiast używamy innej wartości tej zmiennej, musimy wybrać stosowną opcję w
gcc-config (3 linijka).
</note>

<warn>
Nie ustawiajmy żadnych specyficznych dla GCC 3.4 wartości zmiennych CFLAGS (np.
-march=pentium-m) w tym momencie. Może to powodować błędy w kompilacjach.
Wartości te można zmieniać dopiero po usunięciu gcc-3.3, ponieważ nie będą one
ich rozpoznawać.
</warn>

<p>
Teraz, chcemy zobaczyć które pakiety chce przekompilować revdep-rebuild.
Przekażemy wtedy revdep-rebuild aby faktycznie przebudował pakiety. Może to
zabrać trochę czasu więc uzbrójmy się w cierpliwość.
</p>

<pre caption="Użycie revdep-rebuild">
# <i>revdep-rebuild --library libstdc++.so.5 -- -p -v</i>
# <i>revdep-rebuild --library libstdc++.so.5</i>
</pre>

<p>
Mogą pojawić się problemy nieistniejącymi wersjami pakietów, ponieważ mogły się
one przedawnić lub zostać zamaskowane. W takim przypadku, może zajść potrzeba
uruchomienia revdep-rebuild z opcją -X. Sprawia ona, iż revdep-rebuild
rozpoznaje pakiety do przebudowy wyłącznie po ich nazwie, zamiast normalnego
sprawdzania nazwy i wersji.
</p>

<pre caption="Używanie revdep-rebuild z opcją -X">
# <i>revdep-rebuild -X --library libstdc++.so.5 -- -p -v</i>
# <i>revdep-rebuild -X --library libstdc++.so.5</i>
</pre>

<p>
Aby zadbać o kompatybilność już skompilowanych aplikacji, napisanych w C++ oraz
wszelkich pakietów jakie revdep-rebuild mógłby opuścić,
<c>sys-libs/libstdc++-v3</c> musi zostać zaemergowane przed odinstalowaniem GCC
3.3 z systemu.
</p>

<pre caption="Instalacja libstdc++-v3 oraz oczyszczanie systemu">
# <i>emerge --oneshot sys-libs/libstdc++-v3</i>
# <i>emerge -aC =sys-devel/gcc-3.3*</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Używając emerge -e (Metoda bezpieczniejsza)</title>
<section>
<body>

<p>
Ta metoda jest o wiele wolniejsza, zakłada bowiem przekompilowanie całego
systemu. Po pierwsze, uaktualnimy gcc i skonfigurujemy system tak, aby z niego
korzystał.
</p>

<pre caption="Uaktualnianie GCC">
# <i>emerge -uav gcc</i>
# <i>gcc-config i686-pc-linux-gnu-3.4.4</i>
# <i>source /etc/profile</i>
</pre>

<note>
Zakładamy, że jest ustawiona zmienna CHOST="i686-pc-linux-gnu". Jeżeli zmienna
ma inną wartość, należy dodać odpowiednią opcję dla gcc-config (3 linijka).
</note>

<warn>
Nie ustawiajmy żadnych specyficznych dla GCC 3.4 wartości zmiennych CFLAGS (np.
-march=pentium-m) w tym momencie. Może to powodować błędy w kompilacjach.
Wartości te można zmieniać dopiero po usunięciu gcc-3.3, ponieważ nie będą one
ich rozpoznawać.
</warn>

<p>
Aby zadbać o kompatybilność już skompilowanych aplikacji napisanych w C++,
należy zainstalować <c>sys-libs/libstdc++-v3</c> przed odinstalowaniem GCC 3.3
z systemu.
</p>

<pre caption="Instalacja libstdc++-v3">
# <i>emerge --oneshot sys-libs/libstdc++-v3</i>
</pre>

<p>
Najpierw przekompilujemy pakiety z grupy system, a następnie pakiety z grupy
world. Może to zająć sporo czasu, zależnie od ilości zainstalowanych pakietów.
Przekompilowane zostaną podstawowe składniki systemu (jak np. binutils, glibc
- czyli tzw toolchain) oraz podstawe pliki systemowe. Następnie wykorzystując
nowy toolchain zostanie przekompilowana reszta plików, wliczając w to sam
toolchain.
</p>

<pre caption="Przekompilowanie grup system i world">
# <i>emerge -e system</i>
# <i>emerge -e world</i>
</pre>

<p>
W tym momencie możemy bezpiecznie usunąc stare GCC z systemu.
</p>

<pre caption="Oczyszczanie systemu">
# <i>emerge -aC =sys-devel/gcc-3.3*</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Problemy i rozwiązania</title>
<section>
<body>

<ul>
  <li>
    Moduły jądra systemu (np app-emulation/qemu-softmmu) przekompilowane przy
    pomocy GCC 3.4 nie będą działać ze  starym kernelem. Przekompilowanie jądra
    za pomocą GCC 3.4 rozwiązuje problem.
  </li>
  <li>
    Można bezpiecznie zignorować sytuację, kiedy revdep-rebuild będzie chciał
    przekompilować pakiety nawet po tym, jeżeli zostały one już raz
    przebudowane. Wszystko powinno działać bezproblemowo.
  </li>
  <li>
    Jeżeli kompilacja jakiegoś pakietu podczas wykonywania emerge -e
    system/world nie powiedzie się, można wznowić ją poleceniem <c>emerge
    --resume</c>. Jeżeli za każdym razem kompilacja nie udaje się,  można
    ominąć pakiet za pomocą polecenia <c>emerge --resume --skipfirst</c>.
    W międzyczasie nie wolno uruchamiać emerge w innym celu, w przeciwnym
    wypadku nastąpi utrata informacje potrzebne do wznowienia kompilacji grup
    system lub world i konieczne będzie rozpoczęcie od początku.
  </li>
  <li>
    Jeżeli pojawi się: "libtool: link:
    '/usr/lib/gcc-lib/i686-pc-linux-gnu/3.3.6/libstdc++.la' is not a valid
    libtool archive", wystarczy uruchomić <c>/sbin/fix_libtool_files.sh
    3.3.6</c>
  </li>
  <li>
    Jeżeli <c>/sbin/fix_libtool_files.sh</c> zostało usunięte podczas
    odinstalowywania GCC 3.3, należy ponownie zainstalować starsze GCC. Może
    się to przytrafić jeżeli podczas <c>emerge -e system</c> GCC 3.3 jest
    kompilowane po GCC 3.4. Jeżeli nie chcemy instalować starszego GCC
    ponownie, możemy spróbować odzyskać odzyskać
    <c>/lib/rcscripts/awk/fixlafiles.awk</c> i
    <c>/sbin/fix_libtool_files.sh</c> z <c>/usr/portage/sys-devel/gcc/files</c>
    i <c>/usr/portage/sys-devel/gcc/files/awk</c>. Oznacza to jednak że pliki
    te nie będą znane przez Portage i kolejne kompilacje mogą nie dojść do
    skutku przy ustawionym FEATURES=collision-protect.
  </li>
  <li>
    Jeżeli pojawi się błąd: /usr/bin/gcc-config: line 632:
    /etc/env.d/gcc/i686-pc-linux-gnu-3.3.5: No such file or directory, należy
    usunąć <c>/etc/env.d/gcc/config-i686-pc-linux-gnu</c> oraz uruchomić
    <c>gcc-config</c> jeszcze raz, a następnie <c>source /etc/profile</c>.
    Można to robić jednak tylko wtedy jeżeli nie ma ustawionych żadnych
    "cross-compillerów"
  </li>
</ul>

<p>
Komentarze i dodatkowe informacje dotyczące tematu tego dokuemntu można znaleźć
na <uri link="http://forums.gentoo.org/viewtopic-t-407840.html">Forum
Gentoo</uri>.
</p>

</body>
</section>
</chapter>
</guide>

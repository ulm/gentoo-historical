<?xml version='1.0' encoding="utf-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/it/hardened/selinux/Attic/hb-selinux-conv-reboot2.xml,v 1.6 2012/05/27 12:44:02 ago Exp $ -->

<sections>
<version>2.3</version>
<date>2010-11-27</date>

<section>
<title>Emergere i pacchetti SELinux</title>
<subsection>
<body>

<p>
Ora occorre emergere le librerie, i programmi e le politiche di base. Potrebbe
rendersi necessario correggere la versione delle politiche: fare riferimento al
capitolo "Panoramica su SELinux" per ulteriori informazioni. A questo punto
caricare le politiche.
</p>

<pre caption="Emergere i pacchetti di SELinux e le politiche di base">
# <i>emerge -1 checkpolicy policycoreutils</i>
# <i>FEATURES=-selinux emerge -1 selinux-base-policy</i>
</pre>

<note>
La parte "FEATURES=-selinux" del comando di emerge dovrebbe essere usata
solamente nel comando appena esposto. È richiesto per poter installare
selinux-base-policy (solo per la prima volta) in quanto le caratteristiche
SELinux di portare richiedono sia policycoreutils che selinux-base-policy
altrimenti portage fallirà.
</note>

</body>
</subsection>
</section>

<section>
<title>Scegliere il tipo di politica</title>
<body>

<p>
A partire dal profilo 2006.1, gli utenti hanno la possibilità di scegliere tra
una politiche rigida e una ad obbiettivi.
</p>

<p>
Nella politica rigida, tutti i processi vengono confinati. Fino al profilo
2006.1, Gentoo SELinux utilizzava una politica rigida, ora suggerita per i
server. Gentoo non supporta politiche rigide sui desktop.
</p>

<p>
Le politiche ad obbiettivi differiscono da quelle rigide per il fatto che
solamente i servizi che si affacciano alla rete sono confinati, mentre gli
utenti locali non sono sottoposti a limiti. Gentoo supporta questo tipo di
politica solamente sui Desktop, tuttavia potrebbe essere utilizzata anche sui
server.
</p>

<p>
Per impostare il tipo di politica, modificare il file /etc/selinux/config.
</p>

<pre caption="Contenuti del file /etc/selinux/config">
# This file controls the state of SELinux on the system on boot.

# SELINUX can take one of these three values:
#       enforcing - SELinux security policy is enforced.
#       permissive - SELinux prints warnings instead of enforcing.
#       disabled - No SELinux policy is loaded.
SELINUX=permissive <comment>(Dovrebbe restare impostata a permissive per la durata dell'installazione)</comment>

# SELINUXTYPE can take one of these two values:
#       targeted - Only targeted network daemons are protected.
#       strict - Full SELinux protection.
SELINUXTYPE=strict <comment>(Da impostare a rigida (strict) o ad obbiettivi (targeted))</comment>
</pre>

</body>
</section>

<section>
<title>Emergere i pacchetti adattati per SELinux</title>
<subsection>
<body>

<p>
Esistono numerosi pacchetti di sistema dotati delle patch di SELinux, che
forniscono molteplici funzionalità addizionali, come visualizzare i contesti di
un file.
</p>

<pre caption="Reinstallare i pacchetti">
# <i>emerge -1 sysvinit pam coreutils findutils openssh procps psmisc shadow util-linux python-selinux</i>
</pre>

<note>
Può capitare che portage riporti un errore simile a <c>!!! 'module' object has
no attribute 'secure_rename'</c> oppure <c>AttributeError: 'module' object has
no attribute 'getcontext'</c>: è un baco di portage che si verifica perchè non
viene individuato python-selinux. Per correggere il problema, installarlo
tramite "FEATURES=-selinux emerge python-selinux". Per ulteriori informazioni
consultare il bug <uri
link="http://bugs.gentoo.org/show_bug.cgi?id=122517">#122517</uri>.
</note>

<p>
Sono disponibili anche altri pacchetti adattati a SELinux, ma sono opzionali. Se
sono già installati sul sistema, dovrebbero venire reinstallati, in modo che
vengano applicate le patch:
</p>

<ul>
  <li>app-admin/logrotate</li>
  <li>sys-apps/fcron</li>
  <li>sys-apps/vixie-cron</li>
  <li>sys-fs/device-mapper</li>
  <li>sys-fs/udev</li>
  <li>sys-libs/pwdb</li>
</ul>

<note>
Fcron e Vixie-cron sono gli unici schedulatori con supporto ad SELinux
disponibili.
</note>

<note>
I pacchetti elencati NON sono un elenco completo ed esaustivo, ma solamente i
più comuni. In linea di massima, qualsiasi pacchetto installato sul sistema
che utilizzi il flag USE "selinux" dovrebbe venire installato nuovamente.
Per identificare i pacchetti da reinstallare, si utilizzi: emerge -upDN world
Dal momento che modificando il profilo di SELinux vengono alterati anche i flag
USE, il comando descritto restituirà tutti i pacchetti collegati ad SELinux (e
probabilmente qualcosa in più). Per emergere tutti i pacchetti elencati, si
rimuova semplicemente l'opzione 'p' dal comando precedente, altrimenti
occorrerà specificare manualmente i pacchetti da installare.
</note>

</body>
</subsection>
</section>

<section>
<title>Emergere le Politiche delle Applicazioni</title>
<subsection>
<body>

<p>
Una volta completata l'installazione di SELinux, nel momento in cui verrà
installato un pacchetto, la politica verrà considerata una dipendenza e
impostata di conseguenza; tuttavia, siccome il sistema è ancora in fase di
conversione, occorre emergere una politica per i pacchetti installati
precedentemente. La politica selinux-base integra già la maggior parte di
pacchetti presenti nel profilo di sistema.
</p>

<p>
Nella cartella <c>/usr/portage/sec-policy</c> sono presenti numerosi schemi,
ognuno dei quali rappresenta una politica. Il nome di uno schema è composto da
selinux-NOMEPKG, dove NOMEPKG rappresenta il nome del pacchetto al quale è
associata la politica: per esempio selinux-apache è la politica di SELinux per
il corrispondente pacchetto net-www/apache. Occorre installare tutte le
politiche necessarie e quindi caricarle. Se si sta convertendo un desktop,
assicurarsi di includere il pacchetto delle politiche <c>selinux-desktop</c>.
</p>

<pre caption="Esempio: emergere le politiche di Apache e BIND">
# <i>ls /usr/portage/sec-policy</i>
<comment>(verranno elencate numerose directory)</comment>

# <i>emerge -1 selinux-apache selinux-bind</i>

</pre>

</body>
</subsection>
</section>

<section>
<title>Etichettare i filesystem</title>
<subsection>
<body>

<p>
Prima di poter procedere ad etichettare il resto del filesystem, è necessario
anzitutto etichettare /dev. A dire il vero, questo passo è necessario solo se
non si ha optato per la versione statica di /dev. In ogni caso, dal momento
che attualmente la stragrande maggioranza dei sistemi utilizza udev,
probabilmente ci si troverà in questa situazione. Esistono molte soluzioni
differenti per svolgere questo compito: i passi seguenti sono molto semplici e
svolgono il compito alla perfezione.
</p>

<pre caption="Etichettare /dev">
 <i># mkdir /mnt/gentoo
    # mount -o bind / /mnt/gentoo
    # setfiles -r /mnt/gentoo /etc/selinux/{strict,targeted}/contexts/files/file_contexts /mnt/gentoo/dev
    # umount /mnt/gentoo
 </i>
</pre>

<note>
Si ricordi di selezionare una delle due opzioni {strict,targeted} in base al
modello di enforcement selezionato.
</note>

<p>
L'ultimo passo necessario consiste nell'etichettare il filesystem. Questa
operazione assegna ad ogni file una etichetta di sicurezza: è importante che la
consistenza di queste etichette venga sempre preservata.
</p>

<pre caption="Etichettare i filesystem">
# <i>rlpkg -a -r</i>
</pre>

<warn>
Nelle versioni più datate di GRUB è presente un baco noto che non permette di
leggere i link simbolici etichettati: assicurarsi di avere installato almeno la
versione 0.94 di GRUB. Inoltre occorre reinstallare GRUB nell'MBR in modo da
assicurarsi che venga eseguito il codice aggiornato. Per qualsiasi evenienza, è
consigliabile tenere un LiveCD a portata di mano.
</warn>

<pre caption="Reinstallare GRUB nell'MBR (solo per gli utenti di GRUB)">
# <i>grub</i>

grub> root (hd0,0) <comment>(La partizione di avvio)</comment>
grub> setup (hd0) <comment>(Dove installare il boot record; in questo caso, nell'MBR)</comment>
</pre>

<p>
Se Gentoo è stato installato utilizzando la versione "hardened" del kernel,
occorre fare in modo che SELinux ne sia a conoscenza. Questo è possibile
impostando una variabile globale booleana di SELinux
</p>
<pre caption="SELinux global_ssp">
 <i>setsebool -P global_ssp on</i>
</pre>

<note>
Ci si assicuri di utilizzare il parametro -P, altrimenti l'impostazione avrà
effetto solamente per la sessione corrente ma verrà persa al primo riavvio:
una serie di errori relativi a /dev/null e /dev/random saranno un sinonimo
di questo errore.
</note>

</body>
</subsection>
</section>

<section>
<title>Riavvio finale</title>
<subsection>
<body>

<p>
Riavviare. A questo punto accedere al sistema ed etichettare nuovamente tutti i
file, in modo da essere sicuri di aver correttamente etichettato tutto il
filesystem (alcuni file potrebbero essere stati creati durante il recedente
riavvio).
</p>

<pre caption="Etichettare nuovamente">
# <i>rlpkg -a -r</i>
</pre>

<note>
È caldamente raccomandato <uri link="/main/it/lists.xml">
iscriversi</uri> alla mailing list gentoo-hardened. Solitamente è una lista a
basso traffico riguardante la versione sicura di Gentoo (hardened, appunto), e
comprende anche SELinux.
</note>

<p>
A questo punto SELinux è installato!
</p>

</body>
</subsection>
</section>
</sections>

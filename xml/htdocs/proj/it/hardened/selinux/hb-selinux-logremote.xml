<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/proj/it/hardened/selinux/Attic/hb-selinux-logremote.xml,v 1.2 2008/06/04 19:43:15 scen Exp $ -->

<sections>
<version>1.4</version>
<date>2004-11-16</date>

<section
><title>Si comincia...</title>
<subsection>
<body>

<p>
Per effettuare le seguenti azioni, occorre appartenere al ruolo <c>sysadm_r</c>.
</p>

<p>
Eseguire <c>sestatus -v</c>. Selezionare il primo collegamento relativo al
contesto che non corrisponde:
</p>

<table>
<tr>
  <th>Processo</th>
  <th>Contesto</th>
</tr>
<tr>
  <ti>Init context</ti>
  <ti><uri link="#doc_chap2">system_u:system_r:init_t</uri></ti>
</tr>
<tr>
  <ti>/usr/sbin/sshd</ti>
  <ti><uri link="#doc_chap3">system_u:system_r:sshd_t</uri></ti>
</tr>
<tr>
  <th>File</th>
  <th>Contesto</th>
</tr>
<tr>
  <ti>/sbin/unix_chkpwd</ti>
  <ti><uri link="#doc_chap4">system_u:object_r:chkpwd_exec_t</uri></ti>
</tr>
<tr>
  <ti>/etc/passwd</ti>
  <ti><uri link="#doc_chap5">system_u:object_r:etc_t</uri></ti>
</tr>
<tr>
  <ti>/etc/shadow</ti>
  <ti><uri link="#doc_chap5">system_u:object_r:shadow_t</uri></ti>
</tr>
<tr>
  <ti>/bin/bash</ti>
  <ti><uri link="#doc_chap6">system_u:object_r:shell_exec_t</uri></ti>
</tr>
</table>

</body>
</subsection>
</section>
<section>
<title>Contesto Initi errato</title>
<subsection>
<title>Verificare l'etichetta Init</title>
<body>

<p>
Esistono molti possibili motivi per cui init può utilizzare un contesto errato.
Anzitutto occorre verificare che init sia stato etichettato correttamente,
facendo riferimento al risultato del comando sestatus su /sbin/init. Nel
caso in cui sia differente da <c>system_u:object_r:init_exec_t</c>, etichettare
nuovamente sysvinit.
</p>

<pre caption="">
# <i>rlpkg sysvinit</i>
</pre>

</body>
</subsection>
<subsection>
<title>Verificare le politiche disponibili</title>
<body>

<p>
Per eseguire questa azione, occorre appartenere al ruolo <c>sysadm_r</c>.
</p>

<p>
SELinux deve necessariamente avere a disposizione almeno una politica binaria in
/etc/selinux/{strict,targeted}/policy. In caso contrario, installare la
politica.
</p>

<pre caption="Installare una politica binaria">
# <i>semodule -n -B</i>
</pre>

</body>
</subsection>

<subsection>
<title>Verificare che Init possa caricare la politica</title>
<body>

<p>
Il controllo conclusivo viene fatto per assicurarsi che Init possa caricare la
politica. Eseguire <c>ldd</c> su init e se l'output non contenesse libselinux,
emergere nuovamente sysvinit.
</p>

<pre caption="">
# <i>ldd /sbin/init</i>
  linux-gate.so.1 =>  (0xffffe000)
  <comment>libselinux.so.1 => /lib/libselinux.so.1 (0x40025000)</comment>
  libc.so.6 => /lib/libc.so.6 (0x40035000)
  /lib/ld-linux.so.2 => /lib/ld-linux.so.2 (0x40000000)
</pre>

<p>
A questo punto occorre riavviare in modo che init ottenga il contesto corretto
e carichi la politica.
</p>

</body>
</subsection>
</section>
<section>
<title>Contesto di sshd non corretto</title>
<subsection>
<body>

<p>
Un'altra possibilità è che sshd non sia etichettato correttamente, ovvero che
non è in esecuzione nel contesto corretto. Etichettare nuovamente openssh e
riavviare sshd.
</p>

<pre caption="">
# <i>rlpkg openssh</i>
# <i>/etc/init.d/sshd restart</i>
</pre>

</body>
</subsection>
</section>
<section>
<title>Contesto di PAM non corretto</title>
<subsection>
<body>

<p>
Il server SSHd deve essere in grado di utilizzare PAM per l'autenticazione degli
utenti. Il programma di verifica delle password di PAM (/sbin/unix_chkpwd) deve
venire etichettato correttamente, così che sshd possa trasferire il contesto al
controllo della password. Etichettare nuovamente PAM.
</p>

<pre caption="">
# <i>rlpkg pam</i>
</pre>

<p>
Il programma di verifica della password dovrebbe appartenere a
<c>system_u:object_r:chkpwd_exec_t</c>. Si provi ad accedere nuovamente.
</p>

</body>
</subsection>
</section>
<section>
<title>Contesti del file delle password errati</title>
<subsection>
<body>

<p>
I file delle password (/etc/passwd e /etc/shadow) devono essere etichettati
correttamente, altrimenti PAM non sarà in grado di autenticare gli utenti.
Etichettare nuovamente i file.
</p>

<pre caption="">
# <i>restorecon /etc/passwd /etc/shadow</i>
</pre>

<p>
I file delle password e shadow adesso dovrebbero appartenere rispettivamente a
<c>system_u:object_r:etc_t</c> e <c>system_u:object_r:shadow_t</c>. Riprovare ad
accedere.
</p>

</body>
</subsection>
</section>
<section>
<title>Contesto di Bash non corretto</title>
<subsection>
<body>

<p>
Bash deve essere etichettato correttamente, in modo da permettere la transizione
degli utenti nei propri domini nel momento in cui accedono al sistema.
Etichettare nuovamente bash.
</p>

<pre caption="">
# <i>rlpkg bash</i>
</pre>

<p>
Bash (/bin/bash) adesso dovrebbe appartenere a
<c>system_u:object_r:shell_exec_t</c>. Provare ad accedere nuovamente.
</p>

</body>
</subsection>
</section>
<section>
<title>Altri problemi relativi a sshd</title>
<subsection>
<title>Shell valida</title>
<body>

<p>
Per prima cosa, assicurarsi che l'utente abbia una shell valida.
</p>

<pre caption="">
# <i>grep</i> <comment>username</comment> <i>/etc/passwd | cut -d: -f7</i>
/bin/bash <comment>(o la propria shell preferita)</comment>
</pre>

<p>
Se il precedente comando non restituisce alcunchè, o la shell è sbagliata,
impostare la shell dell'utente.
</p>

<pre caption="">
# <i>usermod -s /bin/bash</i> <comment>username</comment>
</pre>

</body>
</subsection>
<subsection>
<title>PAM abilitato</title>
<body>

<p>
PAM dev'essere abilitato in sshd. Assicurasi che questa linea in
<c>/etc/ssh/sshd_config</c> non sia commentata:
</p>

<pre caption="">
UsePAM yes
</pre>

<p>
SELinux attualmente permettere solamente a PAM e a pochi programmi selezionati
di accedere direttamente a <c>/etc/shadow</c>; perciò, openssh ora deve usare
PAM per l'autenticazione della password (la chiave pubblica funziona ancora).
</p>

</body>
</subsection>
</section>
</sections>

<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/en/rsync.xml,v 1.26 2004/05/03 12:30:06 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/en/rsync.xml">
<title>Gentoo Linux rsync Mirrors Policy</title>
<author title="Author">
  <mail link="mirror-admin@gentoo.org">Gentoo Mirror Administrators</mail>
</author>

<abstract>
This document explains how to set up a official rsync mirror.
</abstract>

<license/>

<version>1.3</version>
<date>February 23, 2004</date>

<chapter>
<title>Requirements</title>
<section>
<title>Minimum Bandwidth</title>
<body>

<p>
To properly host a mirror you should have a minimum of 5Mbps full duplex
bandwidth.
</p>

</body>
</section>
<section>
<title>Minimum User Count</title>
<body>

<p>
We ask that you support a minimum of 15 concurrent user connections.
</p>

</body>
</section>
<section>
<title>Minimum Hardware</title>
<body>

<p>
In order to effectively serve at least 15 concurrent user connections, we ask
that you have at least the following minimum hardware requirements:
</p>

<ul>
<li>PIII 500 Processor</li>
<li>256MB RAM</li>
</ul>

</body>
</section>
<section>
<title>Update Frequency</title>
<body>

<p>
Updates must occur at :00 and :30 of each hour, 24 hours a day. It is
<e>very</e> important that this schedule is followed strictly, as we use a
round robin style DNS to select the users' rsync server.
</p>

</body>
</section>
<section>
<title>MOTD (/etc/rsync/rsyncd.motd)</title>
<body>

<p>
Please include the following information in your rsync MOTD file:
</p>

<ul>
<li>server name</li>
<li>server IP address</li>
<li>server specs (CPU and RAM)</li>
<li>bandwidth available to the server</li>
<li>user connection limit, if any</li>
<li>server location (city and country)</li>
<li>a contact name and email address</li>
</ul>

<p>
Including the above information in your MOTD file makes it easy to identify
your mirror in case of problems.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Implementation details</title>
<section>
<body>

<p>
To set up a new mirror, please complete the following steps:
</p>

<ul>
<li>
  Set up your mirror to synchronize against an existing, public Gentoo Linux
  rsync mirror.  It does not matter which one.  Please make sure to synchronize
  in accordance with our <e>Update Frequency</e> schedule noted above.
</li>
<li>
  Fill out a bug report on <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri>
  that contains your server name, ip address, contact information and the fact
  that you'd like to become a new rsync mirror.  We will check your server to
  ensure it is synchronizing properly. It is important that your server synchronizes
  twice an hour, with one sync occuring between :00 and :10 and the second sync
  occuring between :30 and :40.  You may pick any time in these two, 10-minute 
  windows to schedule your sync. 
</li>
<li>
  Once we have verified that the mirror is synchronizing correctly, we will add
  the server's IP address to the rsync1.us.gentoo.org access list.
</li>
<li>
  Update your rsync cron job to point to <path>rsync1.us.gentoo.org</path>. We
  will monitor your server over the next 48-72 hours to ensure it is
  synchronizing correctly.
</li>
</ul>
<p>
If all steps went smoothly, we will then set up an official 
<path>rsync[num].[countrycode].gentoo.org</path> DNS entry and add you to our
DNS round-robin for rsync.[continentcode].gentoo.org and rsync.[countrycode].gentoo.org.
Shortly after you've been added to our DNS, you should start to see rsync
traffic.
</p>

<p>
Additionally, you, the mirror admin will be added to the gentoo-mirrors mailing
list (low traffic) so that you can folllow all issues associated with rsync
mirrors.
</p>

<note>
Thanks for helping out Gentoo Linux users and developers! :) For any rsync
administration issues or problems, please visit <uri
link="http://bugs.gentoo.org">http://bugs.gentoo.org</uri> and fill out a bug
on the product "Rsync".
</note>

</body>
</section>
</chapter>

<chapter>
<title>Parallel Tasks</title>
<section>
<body>

<p>
We will have soon a rrdtool created page that will simply have links to graphs
(ordered by continent, then country, then server) of official rsync mirrors
availability (these graphs will be made from sping output). We will check these
graphs at least once a day, and unreacheable boxes will be removed from the
RR DNS scheme until the problems are addressed. We will have scripts checking
that every 30 minutes all mirrors are, in fact, syncing with us.
</p>

<warn>
If a mirror has periodically problematic behavior and the admin is being
contacted and the situation doesn't improve, then that mirror box will be
taken of the RR scheme permanently.
</warn>

</body>
</section>
</chapter>

<chapter>
<title>Short FAQ</title>
<section>
<title>Q: Who should I contact regarding rsync issues and maintenance?</title>
<body>

<p>
A: Visit http://bugs.gentoo.org and fill out a bug on the product "Rsync".
</p>

</body>
</section>
<section>
<title>Q: I run a private rsync mirror for my company. Can I still access rsync1.us.gentoo.org?</title>
<body>

<p>
A: Because our resources are limited, we need to ensure we allocate them in
such a way to provide the maximum amount of benefit to our users. As such, we
limit connections to our master rsync and distfile mirrors to public mirrors
only. Users are welcome to use our regular mirror system to establish a private
rsync mirror, though they are asked to follow certain basic
<uri link="http://www.gentoo.org/news/en/gwn/20030505-newsletter.xml#doc_chap1_sect3">
rsync etiquette guidelines</uri>.
</p>

</body>
</section>
<section>
<title>Q: Is it important that I sync my mirror twice an hour?</title>
<body>

<p>
A: Yes it is important.  You do not need to perform the syncs at exactly :00 and :30
but the syncs should take place between the following two windows:
</p>
<ol>
	<li>:00 and :10</li>
	<li>:30 and :40</li>
</ol>
<p>
Additionally, please make sure that your syncs are exactly 30 minutes apart.  So, if
you schedule the first sync of each hour for :08, please schedule the second sync of
the hour for :38.
</p>
</body>
</section>
<section>
<title>Q: How do I find the mirror nearest to me?</title>
<body>

<p>
A: netselect was designed to do this for you. If you haven't already run
<c>emerge netselect</c> then do it. Then run: <c>netselect rsync.gentoo.org</c>.
After a minute or so netselect will print an IP address. Take this address and
use it as the only parameter for rsync with two colons appended to it. eg:
<c>rsync 1.2.3.4::</c>. You should be able to find out which mirror that is
from the banner message. Update your /etc/make.conf accordingly.
</p>

</body>
</section>
<section>
<title>Q: Can I use compression when syncing against rsync1.us.gentoo.org?</title>
<body>

<p>
A: No.  Compression utilizes too many resources on the server, so we have
forcibly disabled it on <path>rsync1.us.gentoo.org</path>. Please <e>do not</e>
attempt to use compression when syncing against this server.
</p>

</body>
</section>
<section>
<title>Q: I'm seeing a lot of old and probably dead rsync processes, how can I get rid of that?</title>
<body>

<p>
A: Please see the Example Scripts section.
</p>

</body>
</section>
<section>
<title>Q: There are many users who connect to my rsync server very frequently,
sometimes even causing a DoS to my mirror, is there any way to prevent this?</title>
<body>
<p>
A: Again please see the Example Scripts section.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Example Scripts</title>
<section>
<body>
<p>
Right now, mirroring our Portage tree requires around 250Mb, so it isn't space
intensive; having at least 500Mb free should allow for growing room. Setting
up a Portage tree mirror is simple -- first, ensure that your mirror has rsync
installed. Then, set up your rsyncd.conf file to look something like this:
</p>

<pre caption="rsyncd.conf">
uid = nobody
gid = nobody
use chroot = yes
max connections = 15
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
log file = /var/log/rsync.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#this entry is for compatibility
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree

[gentoo-portage]
#modern versions of portage use this entry
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>

<p>
Above, the gentoo-x86-portage mirror points to the same data as gentoo-portage.
Although we have recently changed the official name of our mirror to
gentoo-portage, gentoo-x86-portage is still needed for backwards compatibility,
so include both entries.
</p>

<p>
For security reasons, the use of a chrooted environment is required!
</p>

<p>
Now, you need to mirror the Gentoo Linux Portage tree. You should use the
following script to do so:
</p>

<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=300"
#Uncomment the following line only if you have been granted access to rsync1.us.gentoo.org
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#If you are waiting for access to our master mirror, select one of our mirrors to mirror from:
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>

<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2
or later
# $Header: /var/cvsroot/gentoo/xml/htdocs/doc/en/rsync.xml,v 1.26 2004/05/03 12:30:06 neysx Exp $

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --timeout=300"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>

<p>
Your rsyncd.motd should contain your IP address and other relevant information
about your mirror, such as information about the host providing the Portage
mirror and an administrative contact. After you have been approved as an
official rsync mirror your host will be aliased with a name of the form:
<path>rsync[num].[country code].gentoo.org</path>
</p>

<p>
This command will help you killing old rsync processes that sometimes lies
around due to connection problems.  It's important to kill those because they
count as valid connections for the 'max connections' option.  You may run this
command via crontab every hour, it will search and kill rsync processes older
than one hour.
</p>

<pre>
/bin/kill -9 `/bin/ps --no-headers -Crsync -o etime,user,pid,command|/bin/grep nobody | \
             /bin/grep "[0-9]\{2\}:[0-9]\{2\}:" |/bin/awk '{print $3}'` 
</pre>

<p>
In some cases, there are a few inconsiderate users who abuse the rsync mirror system by syncing more than 1-2 times per day.  In the most extreme cases, users schedule cron jobs to sync every 15 minutes or so.  This often leads to a Denial of Service attack by continually occupying an rsync slot that could have otherwise gone to another user.  To try and prevent this, you may use the following <uri link="/proj/en/infrastructure/mirrors/rsyncd.conf_pl.txt">perl script</uri> which will scan through your rsync log files, pick out IP addresses that have already connected more than <c>N</c> times that day and dynamically create a rsyncd.conf file, including the offending IP addresses in the 'hosts deny' directive.  The following line controls what <c>N</c> equals:
</p>
<pre>
@badhosts=grep {$hash{$_}>4} keys %hash;
</pre>
<p>
If you use this script, please remember to rotate your rsync log files daily and modify the script to match the location of your rsyncd.conf file.  This script is tested on Gentoo Linux, but should work suitably on other arches that support both rsync and perl.  
</p>
</body>
</section>
</chapter>
</guide>

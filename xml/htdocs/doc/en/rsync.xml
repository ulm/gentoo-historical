<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/en/rsync.xml">
<title>Gentoo Linux rsync Mirrors Policy</title>
<author title="Author"><mail link="mirror-admin@gentoo.org">Gentoo Mirror Administrators</mail></author>

<version>1.1</version>
<date>13 Dec 2002</date>

<chapter>
<title>Requirements</title>
<section>
<title>Minimum Bandwidth</title>
<body>
<p> To properly host a mirror you should have a minimum of T1 bandwidth.
ADSL and cable connections do not generally make adequate connections for rsync hosts due to their limited upstream performance.</p>
</body>
</section>
<section>
<title>Minimum User Count</title>
<body>
<p>We ask that you support a minimum of 5 and preferrably 10 concurrent user connections.</p>
</body>
</section>
<section>
<title>Update Frequency</title>
<body>
<p>Updates must occur at :00 and :30 of each hour, 24 hours a day. It is <e>very</e> important that this schedule is followed strictly, as we use a round robin style DNS to select the users' rsync server.</p> 
<impo>This must be strictly enforced, as an out of sync server with this type of setup generate a much higher amount of traffic for all servers involved in the process (see included FAQ for more details.)</impo>
</body>
</section>
<section>
<title>MOTD (<path>/etc/rsync/rsyncd.motd</path>)</title>
<body>
<p>
Please include the following information in your rsync MOTD file:</p>
<ul>
	<li>server name</li>
	<li>server IP address</li>
	<li>server location (city and country)</li>
	<li>a contact name and email address</li>
</ul>
<p>Including the above information in your MOTD file makes it easy to identify your mirror in case of problems.</p>
</body>
</section>
</chapter>
<chapter>
<title>Implementation details</title>
<section>
<body>
<p>To set up a new mirror, please complete the following steps:</p>
<ul>
	<li>Set up your mirror to synchronize against an existing, public Gentoo Linux rsync mirror.  It does not matter which one.  Please make sure to synchronize in accordance with our <e>Update Frequency</e> schedule noted above.</li>
	<li>Fill out a bug report on <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> that contains your server name, ip address, contact information and the fact that you'd like to become a new rsync mirror.  We will check your server to ensure it is synchronizing properly.  If your server is not synchronizing at exactly :00 and :30, we will contact you and ask you to adjust your schedule appropriately.</li>
	<li>Once we have verified that the mirror is synchronizing correctly, we will add the server's IP address to the rsync1.us.gentoo.org access list.</li>
	<li>Update your rsync cron job to point to <path>rsync1.us.gentoo.org</path>.  We will monitor your server over the next 48-72 hours to ensure it is synchronizing correctly.</li>
</ul>

<p>If all steps went smoothly, we will then set up an official rsync[num].[countrycode].gentoo.org DNS entry and add you to our DNS round-robin for rsync.gentoo.org and rsync.[countrycode].gentoo.org. Shortly after you've been added to our DNS, you should start to see rsync traffic.</p>

<p>Additionally, you, the mirror admin will be added to the gentoo-mirrors mailing list (low traffic) so that you can folllow all issues associated with rsync mirrors.
</p>
<note>
Thanks for helping out Gentoo Linux users and developers! :) For any rsync administration issues or problems, please visit http://bugs.gentoo.org and fill out a bug on the product "Rsync".
</note>
</body>
</section>
</chapter>
<chapter>
<title>Parallel Tasks</title>
<section>
<body>
<p>We will have soon a rrdtool created page that will simply have links to graphs (ordered by continent, then country, then server) of official rsync mirrors availability (these graphs will be made from sping output).
We will check these graphs at least once a day, and unreacheable boxes will be removed from the RR DNS scheme until the problems are addressed.

We will have scripts checking that every 30 minutes all mirrors are, in fact, syncing with us.
</p>
<warn>
If a mirror has periodically problematic behavior and the admin is being contacted and the situation doesn't improve, then that mirror box will be taken of the RR scheme permanently.
</warn>
</body>
</section>
</chapter>
<chapter>
<title>Short FAQ</title>
<section>
<title>Q: Who should I contact regarding rsync issues and maintenance?</title>
<body>
<p>A: Visit http://bugs.gentoo.org and fill out a bug on the product "Rsync".</p>
</body>
</section>

<section>
<title>Q: Is it important that I sync my mirror at :00 and :30 of each hour?</title>
<body>
<p>A: Yes it is important. As each user rsyncs against a mirror they transfer the difference between that mirror and what is on their file system. If your mirror is different and a user is using a round robin hostname then you increase the amount of bandwidth needed for the user, you, and all other mirrors.

For example:

A user is configured to rsync with <path>rsync://rsync.gentoo.org/gentoo-portage</path> .

Lets pretend that <path>rsync.gentoo.org</path> is a DNS Round Robbin for <path>rsync1.gentoo.org</path>, <path>rsync2.gentoo.org</path>, and <path>rsync3.gentoo.org</path>.

Then, lets pretend that rsync1 and rsync3 sync at the recomended times but rsync2 only syncs once at midnight and the current time is in the afternoon.
</p>
<ol>
<li>The user syncs against rsync1 and brings their /usr/portage tree current. Lets say this used 5 megs of bandwidth.</li>
<li>The uses syncs again, this time against rsync2. This time they have just made their portage tree no longer current and whatever bandwidth used to make their portage tree current in step 1 has been undone. Lets say the difference was 5 megs.</li>
<li>The user syncs against rsync3 this time and once again brings their portage tree current again. Because rsync2 is a stale version of the portage tree the user had to transfer the 5 megs again.</li>
</ol>
<p> In the above example the user had to transfer 5 megs * 3 = 15 megs of bandwidth which is 3 times what he needed to and will hurt his overall impression of the Gentoo Portage system.

Also rsync2 and rsync3 both tranfered 5 megs more than they needed to if rsync2 had been current.

Muliptly that by the number of users using DNS Round Robin and you've just wasted a lot of bandwidth which increases the bandwidth cost of not just your mirror but everyone else's mirror too.

We understand that we allways will have some clock drift between each mirror, and each mirror won't sync at exactly the same time. In order to try to keep that window as small as possible, we encourage you to run a NTP daemon to minimize drift.

If that isn't reason enough to run ntpd then you should know that your log files will carry more weight in the court of law if you can show that the clock on your server is right and in sync with the rest of the world.

If you don't want to run ntpd all the time then at least consider running ntpdate at least once a day from cron.
</p>
</body>
</section>
<section>
<title>Q) How do I find the mirror nearest to me?</title>
<body>
<p>A) netselect was designed to do this for you. If you haven't already run <c>emerge netselect</c> then do it.
Then run: <c>netselect rsync.gentoo.org</c>. After a minute or so netselect will print an IP address.
Take this address and use it as the only parameter for rsync with two colons appended to it. eg: <c>rsync 1.2.3.4::</c>.
You should be able to find out which mirror that is from the banner message. Update your /etc/make.conf accordingly.
</p>
</body>
</section>
</chapter>
<chapter>
<title>Example Scripts</title>
<section>
<body>
<p>Right now, mirroring our Portage tree requires around 60Mb, so it isn't space intensive; having at least 200Mb free should allow for growing room. Setting up a Portage tree mirror is simple -- first, ensure that your mirror has rsync installed. Then, set up your rsyncd.conf file to look something like this:</p>
<pre caption="rsyncd.conf">
#uid = nobody
#gid = nobody
use chroot = no
max connections = 20
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#this entry is for compatibility
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree


[gentoo-portage]
#modern versions of portage use this entry
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>
<p>Above, the gentoo-x86-portage mirror points to the same data as gentoo-portage. Although we have recently changed the official name of our mirror to gentoo-portage, gentoo-x86-portage is still needed for backwards compatibility, so include both entries.</p>
<p>Now, you need to mirror the Gentoo Linux Portage tree. You should use the following script to do so: </p>
<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --compress --delete --timeout=600"
#Uncomment the following line only if you have been granted access to rsync1.us.gentoo.org
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#If you are waiting for access to our master mirror, select one of our mirrors to mirror from:
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>
<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2
or later
# $Header: /var/cvsroot/gentoo/xml/htdocs/doc/en/rsync.xml,v 1.10 2003/03/26 15:03:26 klieber Exp $

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --compress --bwlimit=700 --timeout=1800"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>
<p>Your rsyncd.motd should contain your IP address and other relevant information about your mirror, such as information about the host providing the Portage mirror and an administrative contact. After you have been approved as an official rsync mirror your host will be aliased with a name of the form :
<path>rsync[num].[country code].gentoo.org</path>
</p>
</body>
</section>
</chapter>
</guide>

<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/en/handbook/Attic/hb-install-kernel.xml,v 1.29 2004/01/18 14:17:35 aaby Exp $ -->

<sections>
<section>
<title>Installing the Sources</title>
<subsection>
<title>Choosing a Kernel</title>
<body>

<p>
The core around which all distributions are built is the Linux kernel. It is the
layer between the user programs and your system hardware. Gentoo provides its
users several possible kernel sources. A full listing with description is
available at the <uri link="/doc/en/gentoo-kernel.xml">Gentoo Kernel
Guide</uri>. 
</p>

<p>
For x86-based systems we have, amongst other kernels, <c>vanilla-sources</c>
(the default kernel source as developed by the linux-kernel developers),
<c>gentoo-sources</c> (kernel source patched with performance-enhancing
features), <c>gentoo-dev-sources</c> (kernel v2.6 source patched with
performance-enhancing features and stability improvements), <c>xfs-sources</c> 
(kernel source with the latest XFS support), <c>gs-sources</c> (kernel source 
patched for server usage), <c>gaming-sources</c> (kernel source patched for 
optimal gaming performance), ...
</p>

<p>
For alpha-based systems we have <c>vanilla-sources</c> (the default kernel
source as developed by the linux-kernel developers), <c>alpha-sources</c>
(kernel source optimized for alpha users) and <c>compaq-sources</c> (kernel
source as used by RedHat for Alpha, maintained by Compaq).
</p>

<p>
For sparc-based systems we have <c>vanilla-sources</c> (the default kernel
source as developed by the linux-kernel developers) and <c>sparc-sources</c>
(kernel source optimized for SPARC users).
</p>

<p>
MIPS-based systems can choose from <c>mips-sources</c> (the default kernel
source for the MIPS architecture) and <c>mips-prepatch-sources</c> (prerelease
kernel tree).
</p>

<p>
For AMD64-based systems we have <c>gentoo-dev-sources</c> (kernel v2.6 source
patched with amd64 specific fixes for stability, performance and hardware
support). 
</p>

<p>
Other architectures should use the kernel source specifically optimized for
their architecture: <c>hppa-sources</c> (HPPA) or <c>ppc-sources</c> (PowerPC).
</p>

<p>
Choose your kernel source and install it using <c>emerge</c>. From now onwards
we will use <c>emerge --usepkg</c> which will install a prebuilt package if
available (for GRP users) and download it otherwise. In other words, if you are
not using prebuilt packages, you can omit the <c>--usepkg</c> option, but you
don't have to. Furthermore, you can abbreviate the <c>--usepkg</c> option by
using <c>-k</c>.
</p>

<p>
In the next example we install the <c>vanilla-sources</c> (as 
<c>gentoo-sources</c> isn't available on all architectures). Of course 
substitute with your choice of sources:
</p>

<pre caption="Installing a kernel source">
# <i>emerge --usepkg vanilla-sources</i>
</pre>

<p>
When you take a look in <path>/usr/src</path> you should see a symlink called
<path>linux</path> pointing to your kernel source:
</p>

<pre caption="Viewing the kernel source symlink">
# <i>ls -l /usr/src/linux</i>
lrwxrwxrwx    1 root     root           12 Oct 13 11:04 /usr/src/linux -&gt; linux-2.4.22
</pre>

<p>
If this isn't the case (i.e. the symlink points to a different kernel source) 
change the symlink before you continue:
</p>

<pre caption="Changing the kernel source symlink">
# <i>rm /usr/src/linux &amp;&amp; ln -s /usr/src/linux-2.4.22 /usr/src/linux</i>
</pre>

<p>
Now it is time to configure and compile your kernel source. The x86-based
architectures can use <c>genkernel</c> for this, which will build a generic
kernel as used by the LiveCD. We explain the "manual" configuration first
though, as it is the best way to optimize your environment.
</p>

<p>
If you want to manually configure your kernel, continue now with <uri
link="#doc_chap2">Default: Manual Configuration</uri>. If you are an x86-users 
and you want to use <c>genkernel</c> you should read <uri 
link="#doc_chap3">Alternative: Using genkernel</uri> instead.
</p>

</body>
</subsection>
</section>
<section>
<title>Default: Manual Configuration</title>
<subsection>
<title>Introduction</title>
<body>

<p>
Manually configuring a kernel is often seen as the most difficult course every
Linux users ever has to go through. Nothing is less true -- after configuring a
couple of kernels you don't even remember that it was difficult ;)
</p>

<p>
However, one thing <e>is</e> true: you must know your system when you start
configuring a kernel manually. Most information can be gathered by viewing the
contents of <path>/proc/pci</path> (or by using <c>lspci</c> if available). You
can also run <c>lsmod</c> to see what kernel modules the LiveCD uses (it might
provide you with a nice hint on what to enable).
</p>

<p>
Now go to your kernel source directory and execute <c>make menuconfig</c>. This
will fire up an ncurses-based configuration menu.
</p>

<pre caption="Invoking menuconfig">
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<p>
You will be greeted with several configuration sections. We'll first list some
options you must activate (otherwise Gentoo will not function, or not function
properly without additional tweaks).
</p>

</body>
</subsection>
<subsection>
<title>Activating Required Options</title>
<body>

<p>
First of all, activate the use of development and experimental code/drivers.
You need this, otherwise some very important code/drivers won't show up:
</p>

<pre caption="Selecting experimental code/drivers">
Code maturity level options ---&gt;
  [*] Prompt for development and/or incomplete code/drivers
</pre>

<p>
Now go to <c>File Systems</c> and select support for the filesystems you use.
<e>Don't</e> compile them as modules, otherwise your Gentoo system will not be
able to mount your partitions. Also select <c>Virtual memory</c>, <c>/proc
file system</c>, <c>/dev file system</c> + <c>Automatically mount at boot</c>:
</p>

<pre caption="Selecting necessary file systems">
File systems ---&gt;
  [*] Virtual memory file system support (former shm fs)
  [*] /proc file system support
  [*] /dev file system support (EXPERIMENTAL)
  [*]   Automatically mount at boot

<comment>(Deselect the following unless you have a 2.6 kernel)</comment>
  [ ] /dev/pts file system for Unix98 PTYs

<comment>(Select one or more of the following options as needed by your system)</comment>
  &lt;*&gt; Reiserfs support
  &lt;*&gt; Ext3 journalling file system support
  &lt;*&gt; JFS filesystem support
  &lt;*&gt; Second extended fs support
  &lt;*&gt; XFS filesystem support
</pre>

<note>
Users of a 2.6 kernel will find some of the mentioned options under <c>Pseudo
filesystems</c> which is a subpart of <c>File systems</c>.
</note>

<p>
If you are using PPPoE to connect to the Internet, you will need the following
options in the kernel:
</p>

<pre caption="Selecting PPPoE necessary drivers">
Network device support ---&gt;
  &lt;*&gt; PPP (point-to-point protocol) support
  &lt;*&gt;   PPP support for async serial ports
  &lt;*&gt;   PPP support for sync tty ports
</pre>

<note>
Users of a 2.6 kernel will find the mentioned options under <c>Networking
support</c> which is a subpart of <c>Device Drivers</c>.
</note>

<p>
The two compression options won't harm but are not definitely needed, neither
does the <c>PPP over Ethernet</c> option, that might only be used by 
<c>rp-pppoe</c> when configured to do kernel mode PPPoE.
</p>
<!-- TODO reactivate when LVM2 instructions are boarded
<p>
If you are using LVM, you will need to activate it in the kernel:
</p>

<pre caption="Selecting LVM support">
Multi-device support (RAID and LVM) - - -&gt;
  [*] Multiple devices driver support (RAID and LVM)
  &lt;*&gt;  Logical volume manager (LVM) support
</pre>
-->
<note>
Users of a 2.6 kernel will find the mentioned options under <c>Device
Drivers</c>.
</note>

<p>
If you require it, don't forget to include support in the kernel for your
ethernet card.
</p>

<p>
Now, dependent on your architecture, you might need to select more options:
</p>

<ul>
<li><uri link="#doc_chap2_sect3">Activating x86-recommended Options</uri></li>
<li><uri link="#doc_chap2_sect4">Activating Alpha-recommended Options</uri></li>
<li><uri link="#doc_chap2_sect5">Activating HPPA-recommended Options</uri></li>
<li><uri link="#doc_chap2_sect6">Activating PPC-recommended Options</uri></li>
<li><uri link="#doc_chap2_sect7">Activating SPARC-recommended Options</uri></li>
<li><uri link="#doc_chap2_sect8">Activating MIPS-recommended Options</uri></li>
<li><uri link="#doc_chap2_sect9">Activating AMD64-recommended Options</uri></li>
</ul>

</body>
</subsection>
<subsection>
<title>Activating x86-recommended Options</title>
<body>

<p>
If you have an Intel CPU that supports HyperThreading (tm), or you have a
multi-CPU system, you should activate "Symmetric multi-processing support":
</p>

<pre caption="Activating SMP support">
Processor type and features  ---&gt;
  [*] Symmetric multi-processing support
</pre>

<p>
When you've finished configuring the kernel, continue with <uri 
link="#compiling">Compiling and Installing</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Activating Alpha-recommended Options</title>
<body>

<p>
The following options are recommended for Alpha-users:
</p>

<pre caption="Alpha-specific options">
General setup ---&gt;
  &lt;*&gt; SRM environment through procfs
  &lt;*&gt; Configure uac policy via sysctl

Plug and Play configuration ---&gt;
  &lt;*&gt; Plug and Play support
  &lt;M&gt;   ISA Plug and Play support

SCSI support ---&gt;
  SCSI low-level drivers ---&gt;
    &lt;*&gt; SYM53C8XX Version 2 SCSI support (NEW)
    &lt;*&gt; Qlogic ISP SCSI support

Network device support ---&gt;
  Ethernet (10 or 100 Mbit) ---&gt;
    &lt;M&gt; DECchip Tulip (dc21x4x) PCI support
    &lt;M&gt; Generic DECchip &amp; DIGITAL EtherWORKS PCI/EISA
    &lt;M&gt; EtherExpressPro/100 support (eepro100)
    &lt;M&gt; EtherExpressPro/100 support (e100)
  Ethernet (1000 Mbit) ---&gt;
    &lt;M&gt; Alteon AceNIC
      [*] Omit support for old Tigon I
    &lt;M&gt; Broadcom Tigon3
  [*] FDDI driver support
  &lt;M&gt; Digital DEFEA and DEFPA
  &lt;*&gt; PPP support
    &lt;*&gt; PPP Deflate compression

Character devices ---&gt;
  [*] Support for console on serial port
  [*] Direct Rendering Manager

File systems ---&gt;
  &lt;*&gt; Kernel automounter version 4 support
  Network File Systems ---&gt;
    &lt;*&gt; NFS
      [*] NFSv3 client
      &lt;*&gt; NFS server
      [*] NFSv3 server
  Partition Types ---&gt;
    [*] Advanced partition selection
    [*] Alpha OSF partition support
  Native Language Support
    &lt;*&gt; NLS ISO 8859-1

Sound ---&gt;
  &lt;M&gt; Sound card support
    &lt;M&gt; OSS sound modules
      [*] Verbose initialisation
      [*] Persistent DMA buffers
      &lt;M&gt; 100% Sound Blaster compatibles
</pre>

<p>
When you've finished configuring the kernel, continue with <uri
link="#compiling">Compiling and Installing</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Activating HPPA-recommended Options</title>
<body>

<p>
If you have a HIL mouse or keyboard, do not forget to compile in support for
them.
</p>

<pre caption="Activating HIL support">
Input core support ---&gt;
  [*] Keyboard support
  [*] Mouse support
  [*] Event interface support
</pre>

<p>
If you have no mouse on your HIL port, only use the basic support:
</p>

<pre caption="Basic HIL support">
HIL support ---&gt;
  [*] HIL Keyboard (basic) support
</pre>

<p>
If you however want <e>full</e> HIL support, select the following options:
</p>

<pre caption="Full HIL support">
HIL support ---&gt;
  [*] HP System Device Controller i8042 Support
  [*] HIL MLC Support
  [*] HIL Keyboard (full) support
  [*] HIL Mouse &amp; Pointer support
</pre>

<p>
When you're done configuring your kernel, continue with <uri
link="#compiling">Compiling and Installing</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Activating PPC-recommended Options</title>
<body>

<p>
First of all, disable ADB raw keycodes:
</p>

<pre caption="Disabling ADB raw keycodes">
Macintosh Device Drivers ---&gt;
  [ ] Support for ADB raw keycodes
</pre>

<p>
Also choose the correct RTC support (<e>disable</e> the <c>Enhanced RTC</c> 
option):
</p>

<pre caption="Activating the correct RTC option">
Character devices ---&gt;
  [ ] Enhanced RTC

General setup ---&gt;
  [*] Support for /dev/rtc
</pre>

<p>
Users of OldWorld machines will want HFS support so they can copy compiled
kernels to the MacOS partition.
</p>

<pre caption="Activating HFS support">
File Systems ---&gt;
  [*] HFS Support
</pre>

<p>
When you're done configuring your kernel, continue with <uri
link="#compiling">Compiling and Installing</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Activating SPARC-recommended Options</title>
<body>

<p>
First activate the correct bus-support:
</p>

<pre caption="Activating SBUS/UPA">
Console drivers ---&gt;
  Frame-buffer support ---&gt;
    [*] SBUS and UPA framebuffers             
      [*] Creator/Creator3D support     <comment>(Only for UPA slot adapter used in many Ultras)</comment>
    [*] CGsix (GX,TurboGX) support      <comment>(Only for SBUS slot adapter used in many SPARCStations)</comment>
</pre>

<p>
Of course you want support for the OBP:
</p>

<pre caption="Activating OBP Support">
Misc Linux/SPARC drivers ---&gt;
  [*]  /dev/openprom device support
</pre>

<p>
You will also need SCSI-specific support:
</p>

<pre caption="Activating SCSI-specific support">
SCSI support ---&gt;
  SCSI low-level drivers ---&gt;
    &lt;*&gt; Sparc ESP Scsi Driver             <comment>(Only for SPARC ESP on-board SCSI adapter)</comment>
    &lt;*&gt; PTI Qlogic, ISP Driver            <comment>(Only for SBUS SCSI controllers from PTI or QLogic)</comment>
    &lt;*&gt; SYM53C8XX Version 2 SCSI support  <comment>(Only for Ultra 60 on-board SCSI adapter)</comment>
</pre>

<p>
To support your network card, select one of the following:
</p>

<pre caption="Activating networking support">
Network device support ---&gt;
  Ethernet (10 or 100Mbit) ---&gt;
    &lt;*&gt; Sun LANCE support                   <comment>(Only for SPARCStation, older Ultra systems, and as Sbus option)</comment>
    &lt;*&gt; Sun Happy Meal 10/100baseT support  <comment>(Only for Ultra; also supports "qfe" quad-ethernet on PCI and Sbus)</comment>
</pre>

<p>
When you're done configuring your kernel, continue with <uri
link="#compiling">Compiling and Installing</uri>. However, after having
compiled the kernel, check its size:
</p>

<pre caption="Check kernel size">
# <i>ls -lh vmlinux</i>
-rw-r--r--    1 root     root         2.4M Oct 25 14:38 vmlinux
</pre>

<p>
If the (uncompressed) size is bigger than 2.5Mb (for Sparc32) or 3.5Mb (for 
Sparc64), reconfigure your kernel untill it doesn't exceed these limits. One way
of accomplishing this is by having most kernel drivers compiled as modules.
Ignoring this can lead to a non-booting kernel.
</p>

<p>
Also, if your kernel is just a tad too big, you can try stripping it using the
<c>strip</c> command:
</p>

<pre caption="Stripping the kernel">
# <i>strip -R .comment -R .note vmlinux</i>
</pre>

</body>
</subsection>
<subsection>
<title>Activating MIPS-recommended Options</title>
<body>

<p>
If you are using an Indy/Indigo2 based system, you need to activate support for
it.
</p>

<pre caption="Activating SGI IP22">
Machine selection ---&gt;
  [*] Support for SGI IP22 (Indy/Indigo2)
</pre>

<p>
If you want to run Irix binaries, include the following option:
</p>

<pre caption="Including IRIX Binary support">
General setup ---&gt;
  [*] Include IRIX binary compatibility
</pre>

<p>
If you have ISA/EISA cards in your SGI Indigo2, enable support for it.
</p>

<pre caption="Enabling ISA/EISA support for SGI Indigo2">
General setup ---&gt;
  [*] Indigo-2 (IP22) EISA bus support
  [*]   ISA bus support
</pre>

<p>
If you have a SGI parallel port, you can enable support for it. If you have an
ISA parallel port you should select "PC-style hardware" instead.
</p>

<pre caption="Enabling SGI Parallel Port Support">
Parallel port support  ---&gt;
  &lt;*&gt; Parallel port support
  &lt;*&gt;   SGI Indy/Indigo2 hardware (EXPERIMENTAL) (NEW)
  &lt;*&gt;   IEEE 1284 transfer modes (NEW)
</pre>

<p>
If you want to use the Indigo2 ISA slots, enable the plug and play support.
</p>

<pre caption="Enabling PnP support for ISA">
Plug and Play configuration  ---&gt;
  &lt;*&gt; Plug and Play support
  &lt;*&gt;   ISA Plug and Play support
</pre>

<p>
Don't forget to enable SCSI support, and use the SGI WD93C93 Driver:
</p>

<pre caption="Enabling WD93C93 Driver Support">
SCSI low-level drivers  ---&gt;
  &lt;*&gt; SGI WD93C93 SCSI Driver
</pre>

<p>
For network cards you probably need support for the SGI Seeq ethernet
controller:
</p>

<pre caption="Enabling SGI Seeq Support">
Network device support  ---&gt;
  Ethernet (10 or 100Mbit)  ---&gt;
    [*] Ethernet (10 or 100Mbit)
    [*]   SGI Seeq ethernet controller support
</pre>

<p>
Don't forget to enable serial console support and enable support for the SGI
Zilog85C30:
</p>

<pre caption="Enable SGI Zilog85C30 Support">
Character devices ---&gt;
  [*] Non-standard serial port support
  [*]   SGI Zilog85C30 serial support
</pre>

<p>
Also don't forget to enable the Indy/I2 Watchdog support as well as the SGI
DS1286 RTC support:
</p>

<pre caption="Enable Watchdog and RTC Support">
Character Devices ---&gt;
  [*] SGI DS1286 RTC support
  Watchdog Cards  ---&gt;
    [*] Watchdog Timer Support
    &lt;*&gt;   Indy/I2 Hardware Watchdog
</pre>

<p>
You should also enable support for SGI partitions :)
</p>

<pre caption="Enabling Support for SGI Partitions">
File Systems ---&gt;
  Partition Types ---&gt;
    [*] Advanced partition selection
    [*]   SGI partition support
</pre>

<p>
If you have an SGI Newport (XL Gfx) Card and want to use it, then you'll want to
enable support for it:
</p>

<pre caption="Enabling Support for the SGI Newport Card">
Console drivers  ---&gt;
  &lt;*&gt; SGI Newport Console support (NEW)
</pre>

<p>
If you want sound support on your Indy/Indigo2, enable support for it:
</p>

<pre caption="Enabling Support for the SGI HAL2">
Sound  ---&gt;
  &lt;*&gt; Sound card support
  &lt;*&gt;   SGI HAL2 sound (EXPERIMENTAL)
</pre>

<p>
When you're done configuring your kernel, continue with <uri
link="#compiling">Compiling and Installing</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Activating AMD64-recommended Options</title>
<body>

<p>
If you have a multi-CPU Opteron system, you should activate "Symmetric
multi-processing support":
</p>

<pre caption="Activating SMP support">
Processor type and features ---&gt;
  [*] Symmetric multi-processing support
</pre>

<p>
When you've finished configuring the kernel, continue with <uri
link="#compiling">Compiling and Installing</uri>.
</p>

</body>
</subsection>
<subsection id="compiling">
<title>Compiling and Installing</title>
<body>

<p>
Now that your kernel is configured, it is time to compile and install it. Exit 
the configuration and run <c>make dep &amp;&amp; make bzImage modules 
modules_install</c>:
</p>

<pre caption="Compiling the kernel">
<comment>(For x86-based systems, 2.4 kernel)</comment>
# <i>make dep &amp;&amp; make bzImage modules modules_install</i>

<comment>(For other systems, 2.4 kernel)</comment>
# <i>make dep &amp;&amp; make vmlinux modules modules_install</i>

<comment>(For amd64-based systems, 2.6 kernel)</comment>
# <i>make bzImage modules modules_install</i>

<comment>(For other systems, 2.6 kernel)</comment>
# <i>make &amp;&amp; make modules_install</i>
</pre>

<p>
When the kernel is done compiling, copy over the kernel image to
<path>/boot</path>. In the next example we assume you have configured and
compiled <c>vanilla-sources-2.4.22</c> (which may not be the right kernel for
your architecture!):
</p>

<pre caption="Installing the kernel">
<comment>(For x86-based systems)</comment>
# <i>cp arch/i386/boot/bzImage /boot/kernel-2.4.22</i>
# <i>cp System.map /boot/System.map-2.4.22</i>

<comment>(For amd64-based systems)</comment>
# <i>cp arch/x86_64/boot/bzImage /boot/kernel-2.4.22</i>

<comment>(For other systems)</comment>
# <i>cp vmlinux /boot/kernel-2.4.22</i>
# <i>cp System.map /boot/System.map-2.4.22</i>
</pre>

<p>
It is also wise to copy over your kernel configuration file to
<path>/boot</path>, just in case :)
</p>

<pre caption="Backing up your kernel configuration">
# <i>cp .config /boot/config-2.4.22</i>
</pre>

<p>
If you are a MIPS user and your system doesn't boot ELF kernels, compile the
kernel using <c>make vmlinux.ecoff</c> instead of <c>make vmlinux</c>. The
kernel image will be saved as <path>arch/mips/boot/vmlinux.ecoff</path> instead
of <path>vmlinux</path>.
</p>

<p>
Now continue with <uri link="#doc_chap4">Installing Separate Kernel
Modules</uri>.
</p>

</body>
</subsection>
</section>
<section>
<title>Alternative: Using genkernel</title>
<body>

<p>
If you are reading this section, you have chosen to use our <c>genkernel</c>
script to configure your kernel for you. However, this also means that you have
an x86-based system. Other architectures are <e>not supported</e> by
<c>genkernel</c>. <!-- TODO: Add ppc as it should be available with the first
2004 release -->
</p>

<p>
Now that your kernel source tree is installed, it's now time to compile your 
kernel by using our <c>genkernel</c> script to automatically build a kernel for 
you. <c>genkernel</c> works by configuring a kernel nearly identically to the 
way our LiveCD kernel is configured. This means that when you use 
<c>genkernel</c> to build your kernel, your system will generally detect all 
your hardware at boot-time, just like our Live CD does. Because genkernel 
doesn't require any manual kernel configuration, it is an ideal solution for 
those users who may not be comfortable compiling their own kernels.
</p>

<p>
Now, let's see how to use genkernel. First, emerge the genkernel ebuild:
</p>

<pre caption="Emerging genkernel">
# <i>emerge --usepkg genkernel</i>
</pre>

<p>
Now, compile your kernel sources. If you are using a <c>genkernel</c> that is
installed through GRP, run <c>genkernel</c>. If you have a recent
<c>genkernel</c> package (a downloaded version), run <c>genkernel all</c>.
Be aware though, as <c>genkernel</c> compiles a kernel that supports almost all 
hardware, this compilation will take quite a while to finish!
</p>

<pre caption="Running genkernel">
<comment>(This example is for the GRP genkernel)</comment>
# <i>genkernel</i>
Gentoo Linux genkernel, version 1.4
Copyright 2003 Gentoo Technologies, Inc., Bob Johnson, Daniel Robbins
Distributed under the GNU General Public License version 2

Settings:
compile optimization: 1 processor(s)
source tree: /usr/src/linux-2.4.22
config: gentoo (customized)
config loc: /etc/kernels/config-2.4.22
initrd config: (default) /etc/kernels/settings

* Running "make oldconfig"...                                                                     [ ok ]
* Logging to /var/log/genkernel.log...                                                            [ ok ]
* Starting 2.4.22 build...                                                                        [ ok ]
* Running "make dep"...                                                                           [ ok ]
* Running "make bzImage"...                                                                       [ ok ]
* Running "make modules"...                                                                       [ ok ]
* Running "make modules_install"...                                                               [ ok ]
* Moving bzImage to /boot/kernel-2.4.22...                                                        [ ok ]
* Building busybox...                                                                             [ ok ]
* Creating initrd...                                                                              [ ok ]

* Build completed successfully!

* Please specify /boot/kernel-2.4.22 and /boot/initrd-2.4.22
* when customizing your boot loader configuration files.
</pre>

<p>
Once <c>genkernel</c> completes, a kernel, full set of modules and 
<e>initial root disk</e> (initrd) will be created. We will use the kernel 
and initrd when configuring a boot loader later in this document. Write
down the names of the kernel and initrd as you will need it when writing
the bootloader configuration file. The initrd will be started immediately after 
booting to perform hardware autodetection (just like on the Live CD) before 
your "real" system starts up.
</p>

<p>
Now, let's perform one more step to get our system to be more like the Live 
CD -- let's emerge <c>hotplug</c>. While the initrd autodetects hardware that 
is needed to boot your system, <c>hotplug</c> autodetects everything else.
To emerge and enable <c>hotplug</c>, type the following:
</p>

<pre caption="Emerging and enabling hotplug">
# <i>emerge --usepkg hotplug</i>
# <i>rc-update add hotplug default</i>
</pre>

</body>
</section>
<section>
<title>Installing Separate Kernel Modules</title>
<subsection>
<title>Installing Extra Modules</title>
<body>

<p>
If appropriate, you should emerge ebuilds for any additional hardware that is 
on your system. Here is a list of kernel-related ebuilds that you could emerge:
</p>

<table>
<tcolumn width="1in"/>
<tcolumn width="4in"/>
<tcolumn width="2in"/>
<tr>
  <th>Ebuild</th>
  <th>Purpose</th>
  <th>Command</th>
</tr>
<tr>
  <ti>nvidia-kernel</ti>
  <ti>Accelerated NVIDIA graphics for XFree86</ti>
  <ti><c>emerge --usepkg nvidia-kernel</c></ti>
</tr>
<tr>
  <ti>nforce-net</ti>
  <ti>On-board ethernet controller on NVIDIA NForce(2) motherboards</ti>
  <ti><c>emerge nforce-net</c></ti>
</tr>
<tr>
  <ti>nforce-audio</ti>
  <ti>On-board audio on NVIDIA NForce(2) motherboards</ti>
  <ti><c>emerge nforce-audio</c></ti>
</tr>
<tr>
  <ti>e100</ti>
  <ti>Intel e100 Fast Ethernet Adapters</ti>
  <ti><c>emerge e100</c></ti>
</tr>
<tr>
  <ti>e1000</ti>
  <ti>Intel e1000 Gigabit Ethernet Adapters</ti>
  <ti><c>emerge e1000</c></ti>
</tr>
<tr>
  <ti>emu10k1</ti>
  <ti>Creative Sound Blaster Live!/Audigy support</ti>
  <ti><c>emerge emu10k1</c></ti>
</tr>
<tr>
  <ti>ati-drivers</ti>
  <ti>Accelerated ATI Radeon 8500+/FireGL graphics for XFree86</ti>
  <ti><c>emerge ati-drivers</c></ti>
</tr>
<tr>
  <ti>xfree-drm</ti>
  <ti>
    Accelerated graphics for ATI Radeon up to 9200, Rage128, Matrox, Voodoo and
    other cards for XFree86
  </ti>
  <ti><c>VIDEO_CARDS="yourcard" emerge xfree-drm</c></ti>
</tr>
</table>

<p>
Beware though, some of these ebuilds might deal with big dependencies. To verify
what packages will be installed by emerging an ebuild, use <c>emerge 
--pretend</c>. For instance, for the <c>emu10k1</c> package:
</p>

<pre caption="View full installation package listing">
# <i>emerge --pretend emu10k1</i>
</pre>

<p>
If you don't like the packages it wants to install, use <c>emerge --pretend 
--verbose</c> to see what USE-flags are checked when deciding the dependencies:
</p>

<pre caption="View USE-flag usage">
# <i>emerge --pretend --verbose emu10k1</i>
<comment>...</comment>
[ebuild  N    ] media-sound/aumix-2.8  +gpm +nls +gtk +gnome +alsa -gtk2
</pre>

<p>
In the previous example you can see that one of <c>emu10k1</c>'s dependencies
(<c>aumix</c>) uses the <c>gtk</c> and <c>gnome</c> USE-flags, making gtk (which
depends on XFree) be compiled with it.
</p>

<p>
If you don't want all this to be compiled, deselect all USE-flags, for instance:
</p>

<pre caption="Emerging emu10k1 with all USE-flags deselected">
# <i>USE="-gpm -nls -gtk -gnome -alsa" emerge --pretend emu10k1</i>
</pre>

<p>
When you're happy with the results, remove the <c>--pretend</c> to start
installing <c>emu10k1</c>.
</p>

</body>
</subsection>
<subsection>
<title>Configuring the Modules</title>
<body>

<p>
If you are not using <c>hotplug</c>, you should list the modules you want
automatically loaded in <path>/etc/modules.autoload.d/kernel-2.4</path> (or
<path>kernel-2.6</path>). You can add extra options to the modules too if you 
want.
</p>

<p>
To view all available modules, run the following <c>find</c> command. Don't
forget to substitute "&lt;kernel version&gt;" with the version of the kernel you
just compiled:
</p>

<pre caption="Viewing all available modules">
# <i>find /lib/modules/&lt;kernel version&gt;/ -type f -iname '*.o'</i>
</pre>

<p>
For instance, to automatically load the <c>3c59x.o</c> module:
</p>

<pre caption="/etc/modules.autoload.d/kernel-2.4 or kernel-2.6">
3c59x
</pre>

<p>
Now run <c>modules-update</c> to commit your changes to the
<path>/etc/modules.conf</path> file:
</p>

<pre caption="Running modules-update">
# <i>modules-update</i>
</pre>

<p>
Continue the installation with <uri link="?part=1&amp;chap=8">Configuring 
your System</uri>.
</p>

</body>
</subsection>
</section>
</sections>

<sections>
<section>
<title>Choosing the Right Stage</title>
<body>

<p>
When we asked you to choose for an installation medium (LiveCDs, existing
distribution etc.) we explained you what the pros and cons are. One of those was
choosing your stage: do you go for a full compilation (<e>stage1</e>), skip the
bootstrapping (<e>stage2</e>) or start from a precompiled stade (<e>stage3</e>)?
</p>

<p>
Depending on your installation medium, you can still make your choice. Others
will already have made the choice at the beginning of the installation. It is
now time to install your choice of stage. But first we'll configure Portage with
the compiler optimizations you want and feature support you need.
</p>

</body>
</section>
<section>
<title>Configuring the Compile Options</title>
<subsection>
<title>Introduction</title>
<body>

<p>
To optimize Gentoo, you can set a couple of variables which impact Portage 
behaviour. All those variables can be set as environment variables (using
<c>export</c>) but that isn't permanent. To keep your settings, Portage provides
you with <path>/etc/make.conf</path>, a configuration file for Portage. It is
this file we will edit now. 
</p>

<p>
Fire up your favorite editor (in this guide we use <c>nano</c>) so we can alter
the optimization variables we will discuss hereafter.
</p>

<pre caption="Opening /etc/make.conf">
# <i>nano -w /etc/make.conf</i>
</pre>

<p>
As you probably notice now, the <path>make.conf</path> file is structured in a
generic way: commented lines start with "#", other lines define variables using
the <c>VARIABLE="content"</c> syntax. Several of those variables are discussed
next. 
</p>

</body>
</subsection>
<subsection>
<title>CHOST</title>
<body>

<warn>
Although it might be interesting for non-stage1 users, they should <e>not</e>
change the <c>CHOST</c> setting in <path>make.conf</path>. Doing so might render
their system unusable. Again: only change this variable if you use a
<e>stage1</e> installation.
</warn>

<p>
The <c>CHOST</c> variable defines what architecture <c>gcc</c> has to
compile programs for. The possibilities are:
</p>

<table>
<tr>
  <th>Architecture</th>
  <th>Subarchitecture</th>
  <th>CHOST Setting</th>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i386</ti>
  <ti>i386-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i486</ti>
  <ti>i486-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i586</ti>
  <ti>i586-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i686 and above (incl. athlon)</ti>
  <ti>i686-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>alpha</ti>
  <ti></ti>
  <ti>alpha-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>ppc</ti>
  <ti></ti>
  <ti>powerpc-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>sparc</ti>
  <ti></ti>
  <ti>sparc-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>hppa</ti>
  <ti></ti>
  <ti></ti>
</tr>
</table>

</body>
</subsection>
<subsection>
<title>CFLAGS and CXXFLAGS</title>
<body>

<p>
The <c>CFLAGS</c> and <c>CXXFLAGS</c> variables define the optimization flags 
for the <c>gcc</c> C and C++ compiler respectively. Although we define those
generally here, you will only have maximum performance if you optimize these
flags for each program seperately. The reason for this is because every program
is different.
</p>

<p>
In <path>make.conf</path> you should define the optimization flags you think
will make your system the most responsive <e>generally</e>. Don't place
experimental settings in this variable; too much optimization can make 
programs behave bad (crash, or even worse, malfunction).
</p>

<p>
We will not explain all possible optimization options. If you want to know
them all, read the <uri link="http://www.gnu.org/software/gcc/onlinedocs/">GNU
Online Manual(s)</uri> or the <c>gcc</c> info page (<c>info gcc</c> -- only
works on a working Linux system). 
</p>

<p>
A first setting is the <c>-march=</c> flag, which specifies the name of the
target architecture. Possible options are described in the
<path>make.conf</path> file (as comments). For instance, for the x86 Athlon XP
architecture:
</p>

<pre caption="The GCC march setting">
-march=athlon-xp
</pre>

<p>
A second one is the <c>-O</c> flag, which specifies the <c>gcc</c> optimization
class flag. Possible classes are <c>s</c> (for size-optimized),
<c>0</c> (for no optimizations), <c>1</c>, <c>2</c> or <c>3</c> for more
speed-optimization flags (every class has the same flags as the one before, plus
some extras). For instance, for a class-2 optimization:
</p>

<pre caption="The GCC O setting">
-O2
</pre>

<p>
Other popular optimization flags are <c>-pipe</c> (use pipes rather than
temporary files for communication between the various stages of compilation) and
<c>-fomit-frame-pointer</c> (which doesn't keep the frame pointer in a register
for functions that don't need one).
</p>

<p>
When you define the <c>CFLAGS</c> and <c>CXXFLAGS</c>, you should combine
several optimization flags, like in the following example:
</p>

<pre caption="Defining the CFLAGS and CXXFLAGS variable">
CFLAGS="-march=athlon-xp -pipe -O3"
CXXFLAGS="${CFLAGS}"                  <comment># Use the same settings for both variables</comment>
</pre>

</body>
</subsection>
<subsection>
<title>USE</title>
<body>

<p>
<c>USE</c> is one of the most powerfull variables Gentoo provides to its users.
Several programs can be compiled with or without optional support for certain
items. For instance, some programs can be compiled with gtk-support, or with
qt-support. Others can be compiled with or without SSL support. Some programs
can even be compiled with framebuffer support (svgalib) instead of X11 support
(X-server).
</p>

<p>
Most distributions compile their packages with support for as much as possible,
increasing the size of the programs and startup time, not to mention an enormous
amount of dependencies. With Gentoo you can define with what options a package 
should be compiled with. This is where <c>USE</c> comes into play.
</p>

<p>
In the <c>USE</c> variable you define keywords which are mapped onto
compile-options. For instance, <e>ssl</e> will compile ssl-support in the
programs that support it. <e>-X</e> will remove X-server support (note the minus
sign in front). <e>gnome gtk -kde -qt</e> will compile your programs with gnome
(and gtk) support, and not with kde (and qt) support, making your system fully
tweaked for GNOME.
</p>

<p>
The default <c>USE</c> settings are placed in
<path>/etc/make.profile/make.defaults</path>. What you place in
<path>/etc/make.conf</path> is calculated against these defaults settings. If
you add something to the <c>USE</c> setting, it is added to the default list. If
you remove something from the <c>USE</c> setting (by placing a minus sign in
front of it) it is removed from the default list (if it was in the default list
at all). <e>Never</e> alter anything inside the <path>/etc/make.profile</path>
directory; it gets overwritten when you update Portage!
</p>

<p>
A full description on <c>USE</c> can be found in our <uri
link="http://www.gentoo.org/doc/en/use-howto.xml">USE Howto</uri>. As an example
we show a <c>USE</c> setting for a KDE-based system with DVD, ALSA and CD
Recording support:
</p>

<pre caption="USE setting">
USE="-gtk -gnome qt kde dvd alsa cdr"
</pre>

</body>
</subsection>
<subsection>
<title>ACCEPT_KEYWORDS</title>
<body>

<p>
Ebuilds (the package format Gentoo uses) are located in one out of three stadia.
The first one is called <e>ARCH</e>, meaning that the ebuild and its
dependencies are thought to be stable and ready for general acceptance. Most
people want this. If you want your system to use packages from <e>ARCH</e>, then
<c>ACCEPT_KEYWORDS</c> should contain your architecture (being <c>x86</c>,
<c>alpha</c>, <c>ppc</c>, <c>sparc</c> or <c>hppa</c>):
</p>

<pre caption="Setting ACCEPT_KEYWORDS for the x86 architecture in ARCH">
ACCEPT_KEYWORDS="x86"
</pre>

<p>
When an ebuild enters Portage, is first goes to <e>~ARCH</e>, meaning that the
developer who committed the ebuild sais it works on his box(es), but that the
package needs more testing before it is moved to <e>ARCH</e>. If you want your
system to use packages from <e>~ARCH</e>, then <c>ACCEPT_KEYWORDS</c> should
contain your architecture, prefixed by a tilde (<e>~</e>). <e>Don't</e> think
this is the equivalent of "testing" or "unstable" in other distributions.
Packages inside <e>~ARCH</e> <e>do</e> occasionally break stuff!
</p>

<pre caption="Setting ACCEPT_KEYWORDS for the x86 architecture in ~ARCH">
ACCEPT_KEYWORDS="~x86"
</pre>

<p>
If you want to use packages that are known to break your system, then you have
dance with the devil and uncomment the packages in
<path>/usr/portage/profiles/package.mask</path>. However, and this is a big fat
warning:
</p>

<warn>
Fiddling with <path>package.mask</path> is bad for your system, health and sense
of humor. Do <e>not</e> touch it unless you drive a tank, wear a teflon vest
24h/7 and love to sit and wait until Gentoo is reinstalled again... and again...
and again...
</warn>

</body>
</subsection>
<subsection>
<title>MAKEOPTS</title>
<body>

<p>
With <c>MAKEOPTS</c> you define how many parallel compilations should occur when
you install a package. The suggested number is the number of CPUs in your system
plus one.
</p>

<pre caption="MAKEOPTS for a regular, 1-CPU system">
MAKEOPTS="-j2"
</pre>

</body>
</subsection>
<subsection>
<title>Ready, Set, Go!</title>
<body>

<p>
Update your <path>/etc/make.conf</path> to your own will and save. You are now
ready to install the stage you prefer onto your system.
</p>

<p>
The following two parts explain how to install your preferred stage. The default
option here is to download your stage of choice from the internet. However, some
LiveCDs have these stages available on the CD. 
</p>

<p>
If you have a working Internet connection, you are advised to use the default
option. If however you do not have a working Internet connection, or you want to
install Gentoo using GRP (precompiled packages), then you have to choose for the
alternative option.
</p>

<ul>
<li><uri link="#doc_chap3">Default: Downloading from the Internet</uri></li>
<li><uri link="#doc_chap4">Alternative: Using a Stage from the LiveCD</uri></li>
</ul>

</body>
</subsection>
</section>
<section>
<title>Default: Downloading from the Internet</title>
<subsection>
<title>Downloading the Stage Tarball</title>
<body>

<p>
Go to the Gentoo mountpoint at which you mounted your filesystems
(most likely <path>/mnt/gentoo</path>):
</p>

<pre caption="Going to the Gentoo mountpoint">
# <i>cd /mnt/gentoo</i>
</pre>

<p>
Depending on your installation medium, you have a couple of tools available to
download a stage. If you have <c>lynx</c> available, then you can immediately
surf to <uri link="http://www.gentoo.org/main/en/mirrors.xml">the Gentoo
mirrorlist</uri> and choose a mirror close to you. Then pick the
<path>releases/</path> directory, followed by your architecture (for instance
<path>x86/</path> and the Gentoo version (<path>1.4/</path>) to finish up with
the <path>stages/</path> directory. For there on you should see all available
stage files for your architecture. Select one and press <c>D</c> to download.
When you're finished, press <c>Q</c> to quit the browser.
</p>

<pre caption="Surfing to the mirror listing with lynx">
# <i>lynx http://www.gentoo.org/main/en/mirrors.xml</i>
</pre>

<p>
If you do not have <c>lynx</c>, you should have <c>links2</c> at your disposal.
<c>links2</c> is more powerfull than <c>lynx</c>, but has some drawbacks. One of
them is that it doesn't listen to the proxy variables we have declared
previously. If you need to setup a proxy, use <c>links2 -http-proxy
proxy.server.com:8080</c>. From there on, you should follow the same steps as
with <c>lynx</c> as they are equivalent.
</p>

<pre caption="Surfing to the mirror listing with links2">
<comment>(Without proxy:)</comment>   # <i>links2 http://www.gentoo.org/main/en/mirrors.xml</i>
<comment>(With proxy:)</comment>      # <i>links2 -http-proxy proxy.server.com:8080 http://www.gentoo.org/main/en/mirrors.xml</i>
</pre>

</body>
</subsection>
<subsection>
<title>Unpacking the Stage Tarball</title>
<body>

<p>
Now unpack your downloaded stage onto your system. We use GNU's <c>tar</c> to
proceed as it is the easiest method:
</p>

<pre caption="Unpacking the stage">
# <i>tar xvjpf stage?-*.tar.bz2</i>
</pre>

<p>
Make sure that you use the same options (<c>xvjpf</c>). The <c>x</c> stands for
<e>Extract</e>, the <c>v</c> for <e>Verbose</e> (okay, yes, this is optional),
the <c>j</c> for <e>Decompress with bzip2</e>, the <c>p</c> for <e>Preserve
permissions</e> and the <c>f</c> to denote that we want to extract a file, not
standard input.
</p>

<p>
Done? Okay, you are now ready to proceed with the next section on <uri
link="?part=1&amp;chap=6">Installing the Gentoo Base System</uri>.
</p>

</body>
</subsection>
</section>
<section>
<title>Alternative: Using a Stage from the LiveCD</title>
<subsection>
<title>Extracting the Stage Tarball</title>
<body>

<p>
The stages on the CD reside in the <path>/mnt/cdrom/stages</path> directory. To
see a listing of available stages, use <c>ls</c>:
</p>

<pre caption="List all available stages">
# <i>ls /mnt/cdrom/stages</i>
</pre>

<p>
Now go into your Gentoo mountpoint (usually <path>/mnt/gentoo</path>):
</p>

<pre caption="Changing directory to /mnt/gentoo">
# <i>cd /mnt/gentoo</i>
</pre>

<p>
We will now extract the stage tarball of your choice. We will do this with the
GNU <c>tar</c> tool. Make sure you use the same options (<c>xvjpf</c>)! In the
next example, we extract the stage tarball <path>stage3-20031011.tar.bz2</path>.
Be sure to substitute the tarball filename with your stage.
</p>

<pre caption="Extracting the stage tarball">
# <i>tar xvjpf /mnt/cdrom/stages/stage3-20031011.tar.bz2</i>
</pre>

</body>
</subsection>
<subsection>
<title>Installing a Portage Snapshot and Source Code</title>
<body>

<p>
There is a Portage snapshot available on some LiveCDs. Since you are reading
this, we can safely assume you are using such a LiveCD. To install this
snapshot, take a look inside <path>/mnt/cdrom/snapshots/</path> to see what
snapshots we have available:
</p>

<pre caption="Checking the /mnt/cdrom/snapshots content">
# <i>ls /mnt/cdrom/snapshots</i>
</pre>

<p>
Now extract the snapshot of your choice using the following construct. Again,
make sure you use the correct options to <c>tar</c>. Also, the <c>-C</c> is with
a capital <c>C</c>, not <c>c</c>. In the next example we use
<path>portage-20031011.tar.bz2</path> as the snapshot filename. Be sure to
substitute with your snapshot.
</p>

<pre caption="Extracting a Portage snapshot">
# <i>tar xvjf /mnt/cdrom/snapshots/portage-20031011.tar.bz2 -C /mnt/gentoo/usr</i>
</pre>

<p>
You also need to copy over all source code from the CD. 
</p>

<pre caption="Copy over source code">
# <i>cp -R /mnt/cdrom/distfiles /mnt/gentoo/usr/portage/distfiles</i>
</pre>

<p>
If you want to use GRP (precompiled binaries), read on. Otherwise continue with
<uri link="?part=1&amp;chap=6">Installing the Gentoo Base System</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Optional: Preparing GRP</title>
<body>

<p>
If you want to install Gentoo using GRP (precompiled packages), you need to copy
over all packages onto your filesystem so that Portage can use them. 
</p>

<pre caption="Copy over precompiled packages">
# <i>cp -a /mnt/cdrom/packages /mnt/gentoo/usr/portage/packages</i>
</pre>

<p>
Now continue with <uri link="?part=1&amp;chap=6">Installing the Gentoo Base
System</uri>.
</p>

</body>
</subsection>
</section>
</sections>

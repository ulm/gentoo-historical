<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/es/dri-howto.xml,v 1.7 2005/12/19 13:28:17 chiguire Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/es/dri-howto.xml" lang="es">
<title>Guía de Aceleración 3D por Hardware</title>
<author title="Autor">
  <mail link="spyderous@gentoo.org">Donnie Berkholz</mail>
</author>
<author title="Editor">
  <mail link="peesh@gentoo.org">Jorge Paulo</mail>
</author>
<author title="Traductor">
  <mail link="anpereir@gentoo.org">Andrés Pereira</mail>
</author>

<abstract>
Este documento es una guía para hacer funcionar la aceleración 3D usando
X11-DRM con Xorg en Gentoo Linux.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.0.15</version>
<date>2005-12-16</date>

<chapter>
<title>Introducción</title>
<section>
<title>¿Qué es la aceleración 3D por hardware y por qué quisiera tenerla?</title>
<body>

<p>
Con la aceleración 3D por hardware, el renderizado tridimensional usa el
procesador gráfico en su tarjeta de video en vez de ocupar valiosos recursos
de la CPU para dibujar imagenes 3D. También se le conoce como "aceleración
por hardware" en vez de "aceleración por software" debido a que sin esta
aceleración 3D, la CPU está obligada a dibujar todo por sí misma usando
las bibliotecas de renderizado por software de Mesa, lo que ocupa una
considerable potencia de procesamiento. Aunque Xorg típicamente permite
aceleración 2D por hardware, a menudo carece de aceleración 3D por hardware.
La aceleración tridimensional vía hardware es valiosa en situaciones que
requieran renderizado de objetos 3D tales como juegos, CAD 3D y modelamiento.
</p>
</body>
</section>

<section>
<title>¿Cómo obtener aceleración 3D por hardware?</title>
<body>

<p>
En muchos casos existen manejadores, tanto binarios como de código abierto.
Los manejadores de código abierto son de preferencia ya que estamos usando
Linux y el código abierto es uno de sus principios básicos. Algunas
veces, los manejadores binarios son la única opción, como aquellos de las
tarjetas nVidia. Los manejadores binarios para las tarjetas nVidia se incluyen 
en los paquetes media-video/nvidia-kernel y media-video/nvidia-glx, para
las tarjetas Matrox está el paquete media-video/mgavideo y para las
tarjetas ATI está el paquete media-video/ati-drivers. Hay otros manejadores
de código abierto para las tarjetas KyroII en media-video/kyro-kernel y
en media-video/ati-gatos para las tarjetas ATI, que tiene la finalidad
de permitir capacidades de video más completas de las tarjetas ATI.
</p>
</body>
</section>

<section>
<title>¿Qué es DRI?</title>
<body>

<p>
La <uri link="http://dri.freedesktop.org/wiki/">Infraestructura de 
Renderizado Directo</uri> (Direct Rendering Infrastructure), también conocida
como DRI (por sus siglas en inglés), es un marco de referencia para permitir
el acceso directo al hardware gráfico de manera segura y eficiente. Incluye
cambios al servidor X, a muchas bibliotecas clientes y al núcleo. El uso
principal de DRI es crear implementaciones de OpenGL rápidas.
</p>
</body>
</section>

<section>
<title>¿Qué es X11-DRM y cómo se relaciona con el Xorg normal?</title>
<body>

<p>
X11-DRM es una <e>mejora</e> a Xorg que agrega aceleración 3D a las
tarjetas mediante la adición de un módulo del núcleo necesario para
el renderizado directo.
</p>
</body>
</section>

<section>
<title>Propósito</title>
<body>

<p>
Esta guía es para aquellas personas que no pueden hacer funcionar
el renderizado directo tan sólo usando Xorg. X11-DRM funciona para
los manejadores de 3dfx, gamma, i8x0, matrox, rage128, radeon, mach64
y sis300. Vea la <uri
link="http://dri.freedesktop.org/">página Web de DRI</uri> para mayor
información y documentación.
</p>
</body>
</section>

<section>
<title>Comentarios y/o sugerencias</title>
<body>

<p>
Si tiene sugerencias, preguntas, etc. escriba un correo electrónico a
<mail link="spyderous@gentoo.org">Donnie Berkholz</mail>.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Instale Xorg y configure su núcleo</title>
<section>
<title>Instale Xorg</title>
<body>

<p>
Por favor, lea nuestra <uri link="/doc/es/xorg-config.xml">Guía de
Configuración de Xorg</uri> para tener Xorg funcionando.
</p>
</body>
</section>

<section>
<title>Configure su núcleo</title>
<body>

<p>
Investigue cuál es su chipset y active sólo ése.
</p>

<pre caption="Chequeando su chipset AGP">
# <i>emerge pciutils; lspci | grep AGP</i>
# <i>00:01.0 PCI bridge: Intel Corp. 440BX/ZX/DX - 82443BX/ZX/DX AGP bridge (rev 03)</i>
<comment>(La salida del comando puede que no sea igual a la suya debido a 
hardware distinto)</comment>
</pre>

<p>
Si su chipset no está reconocido por el núcleo, puede que tenga éxito pasando
el parámetro del núcleo <c>agp=try_unsupported</c> a su gestor de arranque. Ésto
usará las rutinas genéricas de Intel para el soporte de AGP. Para agregar este
parámetro, edite el archivo de configuración de su gestor de arranque.
</p>

<p>
Casi todos los núcleos deberían tener esas opciones. Ésto fue configurado usando
gentoo-sources-2.4.20-r5.
</p>

<pre caption="Configurando el núcleo">
# <i>ls -l /usr/src/linux </i>
lrwxrwxrwx    1 root     root           22 May 29 18:20 /usr/src/linux -> linux-2.4.20-gentoo-r5
<comment>(Asegúrese que /usr/src/linux apunte a su núcleo actual)</comment>
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<pre caption="Opciones de make menuconfig">
Processor type and features ---&gt;
&lt;*&gt; MTRR (Memory Type Range Register) support
Character devices ---&gt;
&lt;M&gt; /dev/agpgart (AGP Support)
[M] Intel 440LX/BX/GX and I815/I820/I830M/I830MP/I840/I845/I850/I860 support
<comment>(Active su chipset en vez del señalado arriba)</comment>
&lt; &gt; Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)
</pre>

<p>
Asegúrese que el « Direct Rendering Manager » (DRM) esté <e>desactivado</e>.
El paquete X11-DRM proveerá uno propio.
</p>
</body>
</section>

<section>
<title>Compile e instale su núcleo</title>
<body>

<pre caption="Compilando e instalando el núcleo">
<comment>(Este ejemplo es válido para un núcleo 2.4)</comment>
# <i>make dep &amp;&amp; make clean bzImage modules modules_install</i>
# <i>mount /boot</i>
# <i>cp arch/i386/boot/bzImage /boot</i>
</pre>

<p>
Si quiere que su núcleo sea llamado distinto de bzImage, asegúrese de
copiarlo a /boot/su-nombre-acá. No olvide de configurar grub.conf
o lilo.conf y ejecutar /sbin/lilo si usa LILO.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Instalar X11-DRM y configure el renderizado directo</title>
<section>
<title>Instalar X11-DRM</title>
<body>

<pre caption="Instalando X11-DRM">
# <i>emerge x11-drm</i>
</pre>
</body>
</section>

<section id="configure_xorg">
<title>Configurar Xorg.conf</title>
<body>

<p>
Algunos chipsets requieren que reconstruya <c>xorg-x11</c> con 
<c>USE="insecure-drivers"</c>. Esto es válido para los chipsets
mach64, unichrome y savage en xorg-x11-6.8.2 y para mach64 y 
unichrome en xorg-x11-6.8.99.x. Los usuarios de Savage no deberían
intentar usar xorg-x11-6.8.99.x ya que el soporte de savage está
roto.
</p>

<pre caption="Reconstruyendo xorg-x11">
# <i>vim /etc/portage/package.use</i>
<comment>
(Agregue la siguiente línea si usa alguno de los chipsets mencionados arriba)
</comment>
x11-base/xorg-x11 insecure-drivers

# <i>emerge xorg-x11</i>
</pre>

<p>
Abra el archivo <path>/etc/X11/xorg.conf</path> con su editor
de texto favorito y edítelo para activar DRI y GLX.
</p>

<pre caption="xorg.conf">
...
Section "Module"
  Load "dri"
  Load "glx"
  ...
EndSection
...
Section "Device"
  Driver "radeon"
  ...
EndSection
...
Section "dri"
  Mode 0666
EndSection
</pre>

<p>
Si está usando un manejador distinto, reemplace "radeon" con el suyo.
</p>
</body>
</section>

<section>
<title>Cambios a modules.autoload.d</title>
<body>

<p>
Necesitará agregar el nombre del módulo que su tarjeta usa
al archivo <path>/etc/modules.autoload.d/kernel-2.6</path> para
asegurarse que este sea cargado automáticamente cuando se inicie
el sistema.
</p>

<pre caption="Editando /etc/modules.autoload.d/kernel-2.6">
<comment>(Cambie el nombre del módulo acorde a su caso.)</comment>
intel-agp
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Probar la aceleración 3D</title>
<section>
<title>Reinicie al nuevo núcleo</title>
<body>

<p>
Reinicie su computadora con el nuevo núcleo. Es hora de ver si tiene
el renderizado directo y cuán bueno es.
</p>

<pre caption="Probando el renderizado">
# <i>startx</i>
<comment>(No hay necesidad de cargar los módulos para su manejador o agpgart, 
si compiló agpgart como módulo)</comment>
<comment>(Serán cargados automáticamente)</comment>
# <i>glxinfo | grep rendering</i>
direct rendering: Yes
<comment>(Si dice "No", no tiene aceleración 3D)</comment>
# <i>glxgears</i>
<comment>(Pruebe sus cuadros por segundo (FPS) con el tamaño por defecto.
El número debería ser significativamente más alto que antes de instalar x11-drm.
Haga ésto mientras la CPU esté lo más inactiva posible)</comment>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Usando las fuentes del CVS</title>
<section>
<body>

<warn>
No haga ésto si le funcionó el paquete x11-drm.
</warn>
</body>
</section>

<section>
<title>¿Necesita del CVS?</title>
<body>

<p>
Primero, debe chequear si funciona el paquete x11-drm. Sino, y ha verificado
sus archivos de bitácora para ver que no hay un error de configuración, entonces
podría considerar las fuentes del CVS. También están disponibles manejadores
binarios de actualización diaria si no desea construir todo a partir del CVS.
</p>
</body>
</section>

<section>
<title>¿Las fuentes del CVS permiten reconocer su tarjeta?</title>
<body>

<p>
Revise la <uri
link="http://dri.freedesktop.org/wiki/Status">lista de DRI
de tarjetas reconocidas</uri> para ver si las fuentes del CVS
permiten reconocer su tarjeta. Si no lo hacen, pero existe una similar,
inténtelo.
</p>

<!-- I see a couple of 8x AGP stuff on the Internet about vanilla 2.4 kernels;
     is this now available or not? I've commented it out for the time being,
     hoping that this doesn't affect us :)

<warn>
"Linux 2.4 doesn't support agp 8x, so I had to go find a backport. The backport
works .... it doesn't patch quite properly, and it requires 2.4.21 (I've only
gotten it to work with vanilla, straight from the tarball (not ebuild)). First
go get the 2.4.20-2.4.21 patch from kernel.org .... (then get the patch,) It
was on a mailing list somewhere. It doesn't patch cleanly - - one file fails,
the pci_ids.h file, but if you actually read the file and the reject list, it's
very easy to fix. But it does load, and it gives me 1600x1200 with video
(although a bit slow b/c of lack of dga) with xfree-drm." (SanityInAnarchy on
#gentoo)
</warn>

<impo>
The patch is a little tricky to work with but <uri
link="http://www.ussg.iu.edu/hypermail/linux/kernel/0302.2/att-1618/01-agp3.diff.bz2">here's
the link</uri>. If you can disable 8X AGP in your BIOS, change it to 4X and you
may not need the patch.
</impo>
-->
</body>
</section>

<section>
<title>Siga las instrucciones del CVS</title>
<body>

<p>
El proyecto DRI tiene un documento propio acerca de la compilación de las
fuentes del CVS. Por favor, léa el <uri
link="http://dri.freedesktop.org/wiki/Building">documento</uri>
y siga las instrucciones hasta la parte de <e>« Installing for XFree86 »</e> o
<e>« Installing for X.org »</e>.
</p>
</body>
</section>

<section>
<title>Instale las fuentes del CVS</title>
<body>

<p>
Verifique que fueron construidos el(los) módulo(s) del núcleo para DRI:
</p>

<pre caption="Verificación">
# <i>cd ~/DRI-CVS/build/xc/programs/Xserver/hw/xfree86/os-support/linux/drm/kernel; ls</i>
</pre>

<p>
Para la 3dfx Voodoo, debería ver <path>tdfx.o</path>. Para la Matrox
G200/G400, <path>mga.o</path>. Para la  ATI Rage 128, <path>r128.o</path>. Para
la ATI Radeon, <path>radeon.o</path>. Para la  Intel i810, <path>i810.o</path>.
Si falló la construcción de el(los) módulo(s), verifique que está usando
la versión correcta del núcleo de Linux. Las versiones más recientes del núcleo
no están siempre soportadas.
</p>

<p>
Instale sobre su actual instalación de XFree86 o X.org. Puede que desee 
respaldar xorg-x11.
</p>

<pre caption="Respaldando Xorg">
# <i>quickpkg xorg-x11</i>
<comment>(Ésto respalda su paquete xorg-x11)</comment>
# <i>make install</i>
</pre>

<p>
Siga la sección "Configurar Xorg" señalada más arriba.
</p>

<p>
Para cargar el módulo apropiado de DRM en su núcleo actual, copie el
módulo a <path>/lib/modules/`uname -r`/kernel/drivers/char/drm/</path>, luego
ejecute <c>modules-update</c> y reinicie su servidor X. Si no está corriendo
el núcleo en el cual usará DRM, en vez de <c>`uname -r`,</c> use el otro
nombre del núcleo.
</p>

<warn>
Asegúrese primero de descargar cualquier otro(s) módulo(s) DRI del núcleo
que puede(n) estar cargado(s). Note que algunos módulos DRM requieren que el
módulo agpgart esté cargado primero.
</warn>
</body>
</section>
</chapter>

<chapter>
<title>Afinando su rendimiento</title>
<section>
<title>Obtenga el máximo del renderizado directo</title>
<body>

<p>
Unas pocas opciones pueden incrementar el rendimiento hasta en un 30 %
(o más) por sobre la configuración por defecto. Ajústelas en
<path>/etc/X11/xorg.conf</path>.
</p>

<pre caption="xorg.conf">
Section "Device"
  Option     "AGPMode" "4"
  <comment>(Ésto incrementó los FPS de 609 a 618)</comment>
  Option     "AGPFastWrite" "True"
  <comment>(Ésto no tiene un efecto medible, pero puede aumentar 
la inestabilidad de su computadora)</comment>
  <comment>(También puede que necesite ajustarlo en su BIOS)</comment>
  Option     "EnablePageFlip" "True"
  <comment>(Ésto mejoró los FPS de 618 a 702. También es "riesgoso" pero pocas
personas han reportado problemas)</comment>
  ...
EndSection
</pre>

<p>
Si quiere ajustar aún más características, revise la
<uri link="http://dri.freedesktop.org/wiki/FeatureMatrix">matriz de
características</uri> en el sitio Web de DRI o la 
<uri link="http://dri.sourceforge.net/doc/dri_driver_features.phtml">lista de
características</uri> en Sourceforge.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Solución de problemas</title>
<section>
<title>No funciona. Acabo de recompilar mi núcleo o me cambié a uno nuevo.</title>
<body>

<p>
Siempre que recompile su núcleo o se cambie a otro, tendrá que recompilar
el módulo del núcleo. Note que no necesita reinstalar vía emerge xorg-x11, pero
si necesitará reemerger x11-drm.
</p>
</body>
</section>

<section>
<title>No funciona. No tengo renderizado y no sé porque.</title>
<body>

<p>
Intente <c>insmod radeon</c> (o su manejador en caso de no ser radeon) antes
de iniciar el servidor X. También, intente compilar agpgart en el núcleo en
vez de que sea un módulo.
</p>
</body>
</section>

<section>
<title>Cuando inicio startx, obtengo este error:
"[drm] failed to load kernel module agpgart"</title>
<body>

<p>
Eso es porque compiló agpgart en el núcleo en vez de hacerlo
como módulo. Ignórelo a menos que tenga problemas.
</p>
</body>
</section>

<section>
<title>El renderizado directo no funciona y en /var/log/Xorg.0.log
obtengo un mensaje de error acerca de que la versión del manejador
es muy baja.</title>
<body>

<p>
No está usando el manejador x11-drm. Chequee si compiló DRM y el
manejador en el núcleo; no debería serlo.
</p>
</body>
</section>

<section>
<title>Tengo una Radeon, y quiero que funcione la salida de TV (TV-Out)</title>
<body>

<p>
Revise los manejadores ati-gatos. <c>emerge -s gatos</c>.
</p>
</body>
</section>

<section>
<title>No funciona. Mi tarjeta es tan increíblemente nueva y fenomenal que no 
está reconocida por completo.</title>
<body>

<p>
Intente con los manejadores binarios. Para los ati-drivers, hay una lista en
<uri>http://www.schneider-digital.de/html/download_ati.php</uri>. Si esos
no la reconocen, use fbdev. Es lento, pero funciona.
</p>
</body>
</section>

<section>
<title>Tengo una tarjeta PCI y no funciona. ¡Ayuda!</title>
<body>

<p>
En la sección "Device" active ForcePCIMode.
</p>

<pre caption="Activando ForcePCIMode">
Option "ForcePCIMode" "True"
</pre>
</body>
</section>
</chapter>

<chapter>
<title>Agradecimientos</title>
<section>
<body>

<ol>
  <li>
    Christopher Webber por sugerir una pregunta de la sección
    Solución de Problemas acerca del cambio o recompilación
    de núcleos.
  </li>
  <li>
    Steve, por sugerir consistencia entre los casos de dri y DRI en
    XF86Config
  </li>
</ol>
</body>
</section>
</chapter>

<chapter>
<title>Referencias</title>
<section>
<body>

<ol>
  <li><uri>http://forums.gentoo.org/viewtopic.php?t=46681</uri></li>
  <li><uri>http://forums.gentoo.org/viewtopic.php?t=29264</uri></li>
  <li><uri>http://dri.freedesktop.org/</uri></li>
  <li><uri>http://www.retinalburn.net/linux/dri_status.html</uri></li>
</ol>
</body>
</section>
</chapter>
</guide>

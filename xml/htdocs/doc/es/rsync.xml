<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/es/rsync.xml,v 1.2 2005/11/21 20:58:46 chiguire Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/es/rsync.xml" lang="es">
<title>Política de servidores réplica (mirrors) rsync Gentoo Linux</title>
<author title="Autor">
  <mail link="mirror-admin@gentoo.org">Administradores de réplicas Gentoo</mail>
</author>
<author title="Editor">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Traductor">
  <mail link="bass@gentoo.org">José Alberto Suárez López</mail>
</author>
<author title="Traductor">
    <mail link="chiguire@gentoo.org">John Christian Stoddart</mail>
 </author>
<author title="Traductor">
    <mail link="yoswink@gentoo.org">José Luis Rivero</mail>
</author>
<author title="Traductor">
  <mail link="LinuxBlues@gentoo-es.org">Fernando M. Bueno</mail>
</author>

<abstract>
Este documento explica cómo configurar una réplica rsync oficial y una réplica
local propia.
</abstract>

<license/>

<version>1.12</version>
<date>2005-11-07</date>

<chapter>
<title>Petición de hardware</title>
<section>
<title>Donación de máquinas</title>
<body>

<p>
Gentoo Linux tiene dos tipos distintos de réplicas: réplicas principales de
rotación y réplicas comunitarias. Las réplicas principales de rotación son
servidores rsync dedicados y están dedicados a manejar todo nuestro tráfico rsync.
Todas las réplicas principales de rotación emplean Gentoo Linux y son manejadas
por miembros del equipo de desarrollo Gentoo. Las réplicas comunitarias son
servidores proporcionados y manejados por miembros de la comunidad. Estos
servidores pueden o pueden no estar dedicados al uso rsync y pueden o pueden no
emplear Gentoo Linux.
</p>

<p>
En este momento, disponemos de suficientes réplicas comunitarias y estamos
buscando activamente réplicas de rotación principales. Las especificaciones
para estos servidores incluyen:
</p>

<ul>
  <li>Procesador Pentium 4 a 2GHz como mínimo (o equivalente)</li>
  <li>1GB de RAM como mínimo (1,5GB - 2GB es lo ideal)</li>
  <li>10GB de espacio en el disco (IDE está bien)</li>
</ul>

<p>
Estos servidores pueden donarse con ancho de banda y el espacio para tenerlos
si se dispone de ellos. En caso contrario, podemos proporcionar estos servicios
y simplemente se habrá de enviar la máquina a donde podamos colocarla.
El consumo de ancho de banda promedio de una réplica principal de rotación
oscila los ~7Mbps (alrededor de 2 TB al mes). En cuanto el número de estos
servidores aumente, estas cifras se reducirán proporcionalmente.
</p>

<p>
Si se quiere donar una máquina, por favor envíe toda la información pertinente
por correo electrónico a <mail link="jforman@gentoo.org">Jeffrey Forman</mail>.
</p>

</body>
</section>
</chapter>
<!--
<chapter>
<title>Requisitos</title>
<section>
<title>Ancho de banda mínimo</title>
<body>

<p>
Para alojar adecuadamente una réplica, debe tenerse un ancho de banda de, como
mínimo, 5Mbps full duplex.
</p>

</body>
</section>
<section>
<title>Cuenta de usuarios mínima</title>
<body>

<p>
Solicitamos que soporte un mínimo de 15 conexiones concurrentes de usuarios.
</p>

</body>
</section>
<section>
<title>Mínimo hardware</title>
<body>

<p>
Para poder lograr servir, como mínimo, 15 conexiones concurrentes de usuarios,
solicitamos que se disponga de los siguientes requisitos hardware mínimos:
</p>

<ul>
  <li>Procesador PIII 500</li>
  <li>256MB de RAM</li>
</ul>

</body>
</section>
<section>
<title>Frecuencia de actualización</title>
<body>

<p>
Las actualizaciones deben ocurrir a los minutos :00 y :30 de cada hora, 24 horas
al día. Es <e>muy</e> importante que este horario se siga estrictamente, dado que
seguimos un estilo de rotación DNS para seleccionar el servidor rsync de los
usuarios.
</p>

</body>
</section>
<section>
<title>MOTD (/etc/rsync/rsyncd.motd)</title>
<body>

<p>
Por favor, se ha de incluir la siguiente información en el archivo MOTD rsync:
</p>

<ul>
<li>nombre del servidor</li>
<li>Dirección IP del servidor</li>
<li>Especificaciones del servidor (CPU y RAM)</li>
<li>Ancho de banda del que dispone el servidor</li>
<li>Límite de conexiones de usuarios, si lo hay</li>
<li>Localización del servidor (ciudad y país)</li>
<li>Nombre de contacto y dirección de correo electrónico</li>
</ul>

<p>
Incluyendo toda la información anterior en el archivo MOTD, se facilita la
localización de la réplica en caso de problemas.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Detalles de implementación</title>
<section>
<body>

<p>
Para establecer una nueva réplica, han de seguirse los siguientes pasos:
</p>

<ul>
<li>
  Configurar la réplica para que sincronice con uno de los servidores públicos
  rsync existentes. No importa cual sea. Por favor, hay que asegurarse de que
  sincroniza de acuerdo con el horario de la <e>Frequencia de actualización</e>
  mencionado anteriormente.
</li>
<li>
  Rellene un "informe de fallo" en <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri>
  que contenga el nombre de su organización, el del servidor, la dirección IP,
  la información de contacto y el hecho de que desea llegar a ser una nueva
  réplica rsync. Comprobaremos su servidor para ver si está sincronizando
  correctamente. Es muy importante que el servidor sincronice dos veces por
  hora, y que la primera ocurra entre el minuto :00 y :10 y la segunda entre
  el minuto :30 y :40. Puede seleccionarse cualquiera en las dos, en ese período
  de tiempo de 10 minutos para programar la sincronización.
</li>
<li>
  Una vez hayamos verificado que su mirror sincroniza correctamente, nosotros
  añadiremos la dirección IP del servidor a la lista de acceso de rsync1.us.gentoo.org
</li>
<li>
  Actualice su trabajo cron para que apunte a <path>rsync1.us.gentoo.org</path>.
  Monitorizaremos su servidor durante las siguientes 48-72 horas para comprobar
  que está sincronizando correctamente.
</li>
</ul>

<p>
Si todo ha funcionado de manera correcta, añadiremos una entrada DNS oficial
<path>rsync[núm].[código_de_país].gentoo.org</path> y lo añadiremos al mecanismo
de rotación DNS para rsync.[código_de_continente].gentoo.org y rsync.[código_de_país].gentoo.org.
Después de añadirlo a nuestro DNS, debe empezar a ver el tráfico rsync.
</p>

<p>
Adicionalmente, será añadido a la lista de correo gentoo-mirrors (con muy poco
tráfico) como administrador de una réplica, para que pueda seguir todos los asuntos
relacionados con réplicas rsync.
</p>

<note>
¡Gracias por ayudar a los usuarios y desarrolladores de Gentoo! :)
Para cualquier asunto o problema relacionado con la administración rsync, visite
<uri link="http://bugs.gentoo.org">http://bugs.gentoo.org</uri> y rellene un informe
de fallo con respecto al producto "Rsync".
</note>

</body>
</section>
</chapter>

<chapter>
<title>Tareas paralelas</title>
<section>
<body>

<p>
Tendremos pronto una página rrdtool que símplemente tendrá enlaces a gráficos
(ordenados por continente, país y servidor) de la disponibilidad de réplicas
oficiales rsync (estos gráficos se crearán a través de la salida sping).
Comprobaremos estos gráficos al menos una vez al día, y todos aquellos servidores
no disponibles (unreachable) serán eliminados de nuestro esquema de rotación DNS
hasta que los problemas sean resueltos. De hecho, tenemos macros que comprueban
cada 30 minutos que las réplicas estén sincronizando con la nuestra.
</p>

<warn>
Si una réplica tiene un comportamiento problemático periódicamente y estamos
contactando con el administrador y la situación no mejora, entonces esa réplica
será eliminada permanentemente de nuestro esquema de rotación.
</warn>

</body>
</section>
</chapter>
-->
<chapter>
<title>PUF breve (proporcionadas como referencia para los administradores de réplicas)</title>
<section>
<title>P: ¿Con quién debo contactar para asuntos relacionados con rsync y el mantenimiento?</title>
<body>

<p>
R: Visite http://bugs.gentoo.org y rellene un bug con respecto a "Rsync".
</p>

</body>
</section>
<section>
<title>P: Tengo una réplica rsync para mi compañía. ¿Puedo acceder a rsync1.us.gentoo.org?</title>
<body>

<p>
R: Dado que nuestros recursos son limitados, necesitamos asegurarnos de que los
disponemos de forma que proporcionen el máximo beneficio posible a nuestros
usuarios. Como consecuencia de ello, limitamos las conexiones de nuestros
servidores principales rsync y distfiles permitiendo sólo la conexión de
servidores réplica públicos. Bienvenidos quienes usen nuestro sistema
ordinario de réplicas públicas para establecer una réplica rsync privada,
aunque se les ruega que sigan unas ciertas 
<uri link="http://www.gentoo.org/news/en/gwn/20030505-newsletter.xml#doc_chap1_sect3">
normas básicas de "etiquette"</uri>.
</p>

</body>
</section>
<section>
<title>P: ¿Es importante que sincronice mi réplica dos veces por hora?</title>
<body>

<p>
R: Sí, es importante. No necesita hacer la sincronización exactamente en :00 y :30
pero las sincronizaciones se han de hacer, forzosamente, en cada uno de los
siguientes dos intervalos:
</p>

<ol>
	<li>:00 y :10</li>
	<li>:30 y :40</li>
</ol>

<p>
Adicionalmente, por favor, asegúrese de que las sincronizaciones se hacen cada 30
minutos exactamente. Así, si la primera sincronización horaria es en el minuto :08,
la segunda sincronización horaria deberá hacerse en el minuto :38.
</p>

</body>
</section>
<section>
<title>P: ¿Cómo encuentro la réplica más cercana?</title>
<body>

<p>
R: <c>netselect</c> fue diseñado para hacer eso precisamente. Si aún no ha ejecutado 
<c>emerge netselect</c>, hágalo. A continuación ejecute: <c>netselect rsync.gentoo.org</c>.
Después de un minuto o así, netselect mostrará una dirección IP. Tome nota de
la IP y después úsela como único parámetro con dos puntos, dos veces, al final.
ej.: <c>rsync 1.2.3.4::</c>. Debe ver de qué réplica se trata con la información
que proporciona. Actualice el archivo /etc/make.conf con esa dirección.
</p>

</body>
</section>
<section>
<title>P: ¿Puedo usar compresión al sincronizar con rsync1.us.gentoo.org?</title>
<body>

<p>
R: No. La compresión requiere demasiados recursos en el servidor, así que nos
hemos visto obligados a deshabilitarla en <path>rsync1.us.gentoo.org</path>. Por
favor, <e>no</e> intente usar compresión cuando sincronice con este servidor.
</p>

</body>
</section>
<section>
<title>P: Estoy viendo muchos procesos antiguos y posiblemente muertos de rsync, ¿cómo lo evito?</title>
<body>

<p>
R: Por favor, vea la sección de macros de ejemplo.
</p>

</body>
</section>
<section>
<title>P: Hay muchos usuarios que conectan a mi servidor rsync muy frecuentemente,
a veces causando un DoS a mi réplica, ¿hay alguna forma de prevenirlo?</title>
<body>

<p>
R: De nuevo, vea la sección de macros de ejemplo.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Macros de ejemplo</title>
<section>
<body>

<note>
Encontrará varios ficheros de muestra de configuración y macros en el paquete
gentoo-rsync-mirror. Haga un <c>emerge gentoo-rsync-mirror</c>
</note>

<p>
En estos momentos, la réplica del árbol Portage requiere unos 250Mb, así pues,
no requiere demasiado espacio; tener como mínimo unos 500Mb adicionales libres
permitirán que el árbol siga creciendo. Configurar una réplica del árbol Portage
es simple -- en primer lugar, asegúrese de que tiene rsync instalado y después
configure el archivo <path>rsyncd.conf</path> para que sea algo parecido a ésto:
</p>

<pre caption="rsyncd.conf">
uid = nobody
gid = nobody
use chroot = yes
max connections = 15
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
log file = /var/log/rsync.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#this entry is for compatibility
path = /gentoo/rsync
comment = Gentoo Linux Portage tree

[gentoo-portage]
#modern versions of portage use this entry
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>

<p>
En el fichero, la réplica gentoo-x86-portage apunta a los mismos datos que
gentoo-portage. Aunque hemos cambiado recientemente el nombre oficial de
nuestra réplica a gentoo-portage, gentoo-x86-portage se sigue necesitando
para mantener la compatibilidad con versiones anteriores, así pues, incluya
ambas entradas.
</p>

<p>
Por motivos de seguridad, !se requiere el uso de un entorno enjaulado (chrooted)!
</p>

<p>
Ahora, necesita hacer una réplica del árbol Portage Gentoo Linux. Debe usar
esta macro para hacerlo:
</p>

<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=300"
#Uncomment the following line only if you have been granted access to rsync1.us.gentoo.org
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#If you are waiting for access to our master mirror, select one of our mirrors to mirror from:
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>

<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2004 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# &#36;Header: /var/cvsroot/gentoo-x86/net-misc/rsync/files/rsyncd.init.d,v 1.2 2004/05/02 22:45:02 mholzer Exp &#36;

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --timeout=300"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>

<p>
El fichero <path>rsyncd.motd</path> debe contener su dirección IP y otra
información relevante acerca de la réplica, como información acerca del
anfitrión que proporciona la réplica Portage e información de contacto
con el administrador. Después de ser aprobado como una réplica oficial rsync,
el anfitrión recibirá un alias de la forma:
<path>rsync[núm].[código_de_país].gentoo.org</path>
</p>

<p>
Este comando ayudará a matar viejos procesos rsync que a veces permanecen
activos debido a problemas de conexión. Es importante matarlos porque cuentan
como conexiones válidas para la opción 'max connections'. Se puede ejecutar
este comando como tarea cron (crontab) cada hora, buscará y matará procesos
rsync con más de una hora de ejecución.
</p>

<pre caption="Matando viejos procesos rsync">
/bin/kill -9 `/bin/ps --no-headers -Crsync -o etime,user,pid,command|/bin/grep nobody | \
             /bin/grep "[0-9]\{2\}:[0-9]\{2\}:" |/bin/awk '{print $3}'` 
</pre>

<p>
En algunos casos, hay unos pocos usuarios que abusan del sistema de réplicas
rsync sincronizando más de 1 o 2 veces al día. En los casos más extremos,
estos usuarios pueden hacer un horario cron para que sincronicen cada 15
minutos. Esto conduce a un ataque de Denegación de Servicio ocupando una
posición rsync que podría haber sido para cualquier otro usuario. Para
prevenir esto se puede usar la siguiente <uri 
link="http://www.gentoo.org/proj/en/infrastructure/mirrors/rsyncd.conf_pl.txt">
macro perl</uri> que buscará en la bitácora de los archivos rsync, extraerá las
direcciones IP que se han conectado más de <c>N</c> veces ese día y creará
dinámicamente un archivo <path>rsyncd.conf</path>, incluyendo las direcciones IP
que abusan del servicio en la directiva 'denegar anfitriones' ('hosts deny').
</p>

<pre caption="Definir el máximo número de conexiones por IP">
@badhosts=grep {$hash{$_}>4} keys %hash;
</pre>

<p>
Si se usa esta macro, hay que recordar rotar los archivos de bitácora rsync
diariamente y modificar la macro indicándole dónde se encuentra el archivo
<path>rsyncd.conf</path>. Esta macro se ha comprobado en Gentoo Linux, pero debe
funcionar correctamente en otras que soporten tanto rsync como perl.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Configurando una réplica rsync propia</title>
<section>
<title>Introducción</title>
<body>

<p>
Muchos usuarios usan Gentoo en varias máquinas y necesitan ejecutar <c>emerge --sync</c>
en todas ellas. Usar las réplicas públicas es simplemente desperdiciar el ancho
de banda en ambos. Sincronizar una sola máquina con una réplica pública y
sincronizar el resto de máquinas con ésta, evitará desperdiciar recursos en
las réplicas Gentoo y ancho de banda a los usuarios.
</p>

<p>
Todo lo que necesita hacer es seleccionar cuál de las máquinas va a ser la
réplica local rsync y configurarla. Debería elegir una máquina capaz de
soportar la carga de CPU y de disco que la operación rsync requiere. La
réplica local rsync deberá estar también disponible siempre que cualquiera
de las otras máquinas sincronice su árbol portage. Además, debe tener una
dirección IP estática o nombre que siempre resuelva al servidor. Configurar
DHCP o un servidor DNS está más allá del propósito de esta guía.
</p>

</body>
</section>
<section>
<title>Configurando el servidor</title>
<body>

<p>
No hay que instalar ningún paquete adicional, dado que el software necesario
ya se encuentra en su computadora. Configurar la réplica local rsync es sólo
un asunto de ajustar el daemon <e>rsyncd</e> para hacer disponible el directorio
<path>/usr/portage</path> para sincronización. Se tiene que crear el siguiente
archivo de configuración <path>/etc/rsyncd.conf</path>:
</p>

<pre caption="Muestra de /etc/rsyncd.conf">
pid file = /var/run/rsyncd.pid
max connections = 5
use chroot = yes
uid = nobody
gid = nobody
<comment># Optional: restrict access to your Gentoo boxes</comment>
hosts allow = 192.168.0.1 192.168.0.2 192.168.1.0/24
hosts deny  = *

[gentoo-portage]
path=/usr/portage
comment=Gentoo Portage
exclude=distfiles/ packages/
</pre>

<p>
No se tienen que usar las opciones <c>hosts allow</c> ni <c>hosts deny</c>. Por
defecto, se permitirá a todos los clientes conectar. El orden en que se indiquen
las opciones no es importante. El servidor siempre comprobará primero la opción
<c>hosts allow</c> y permitirá la conexión siempre que el anfitrión que conecte
coincida con alguno de los patrones listados. El servidor comprobará después la
opción <c>hosts deny</c> y rechazará la conexión si encuentra alguna conexión que
coincida con el patrón. A cualquier anfitrión que no se encuentre en ninguna de
ellas se le concederá la conexión. Por favor, consulte el manual (<c>man rsyncd.conf</c>)
para más información.
</p>

<p>
Ahora, inicie el daemon rsync con el siguiente comando como usuario root:
</p>

<pre caption="Iniciando el daemon rsync">
<comment>(Iniciar el daemon ahora)</comment>
# <i>/etc/init.d/rsyncd start</i>
<comment>(Añadir el daemon al nivel de ejecución default)</comment>
# <i>rc-update add rsyncd default</i>
</pre>

<p>
Vamos a comprobar nuestra réplica rsync. No se necesita intentarlo desde otra
máquina, pero sería una buena idea hacerlo. Si el servidor no se reconoce por
nombre en todas las máquinas, se puede usar la dirección IP en su lugar.
</p>

<pre caption="Comprobando nuestra réplica">
<comment>(Se puede usar tanto el nombre del servidor como la IP)</comment>
# <i>rsync 192.168.0.1::</i>
gentoo-portage     Gentoo Portage
# <i>rsync nombre_del_servidor::gentoo-portage</i>
<comment>(Debería mostrar el contenido de /usr/portage en la réplica)</comment>
</pre>

<p>
El servidor local rsync está configurado. Hágase un <c>emerge --sync</c> como de
costumbre para mantener el servidor actualizado.
</p>

<note>
Por favor, ha de tenerse en cuenta que los administradores de las réplicas públicas
consideran un abuso sincronizar más de una o dos veces al día.
</note>

</body>
</section>
<section>
<title>Configurando los clientes</title>
<body>

<p>
Ahora, haga que las otras computadoras usen la réplica local rsync en lugar de
una pública. Edite <path>/etc/make.conf</path> y haga que la variable <c>SYNC</c> apunte
a la réplica local.
</p>

<pre caption="Definir SYNC en /etc/make.conf">
<comment>(Usar la dirección IP del servidor)</comment>
SYNC="rsync://<i>192.168.0.1</i>/gentoo-portage"
<comment>(o bien el nombre del servidor)</comment>
SYNC="rsync://<i>nombre_del_servidor</i>/gentoo-portage"
</pre>

<p>
Se puede comprobar si la computadora está configurada adecuadamente sincronizando
con la réplica local por primera vez:
</p>

<pre caption="Comprobando y sincronizando">
<comment>(Comprobar que la variable SYNC está configurada)</comment>
# <i>emerge --info|grep SYNC</i>
SYNC="rsync://nombre_del_servidor/gentoo-portage"
<comment>(Sincronizando con la réplica local)</comment>
# <i>emerge --sync</i>
</pre>

<p>
¡Eso es todo! Todas sus computadoras usarán la réplica local rsync cada vez que 
ejecuten <c>emerge --sync</c>.
</p>

</body>
</section>
</chapter>
</guide>

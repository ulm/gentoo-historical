<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/es/lvm2.xml,v 1.3 2005/01/11 23:40:46 chiguire Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link = "/doc/en/lvm2.xml" lang="es">
<title>Instalación de LVM2 en Gentoo</title>
<author title="Autor">
  <mail link="avi@CFFtechnologies.com">Avi Schwartz</mail>
</author>
<author title="Contribuyente">
  <mail link="rajiv@gentoo.org">Rajiv Manglani</mail>
</author>
<author title="Editor">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Editor Es">
  <mail link="bass@gentoo.org">José Alberto Suárez López</mail>
</author>
<author title="Editor Es Adjunto">
  <mail link="chiguire@gentoo.org">John Christian Stoddart</mail>
</author>

<abstract>
Esta guía describe cómo configurar su máquina Gentoo para utilizar el
Manejado de Volúmenes Lógico (Logical Volume Manager), versión 2
(LVM2).
</abstract>

<license/>

<version>2.0.6</version>
<date>2004-11-21</date>

<chapter>
<title>Introducción</title>
<section>
<body>

<p>
Esta guia está basada en un ejemplo usando dos discos duros
IDE. Significa que probablemente tendrá que cambiar el disco, los
nombres y los tamaños de las particiones según su configuración y sus
propias necesidades.
</p>

<warn>
No es la intención que este documento sea un tutorial de LVM2. Sirve
como información suplementaria al procedimiento de instalación de
Gentoo, tal como ha sido descrito en la <uri
link="/doc/es/handbook/handbook-x86.xml?part=1&amp;chap=0"> parte 1 del
Manual</uri>. Asegúrese de <c>leer</c> el Manual de Instalación <c>antes</c>
de comenzar el proceso de instalación.
</warn>

<note>
Para un HOWTO completo acerca de LVM, navegue a
<uri>http://tldp.org/HOWTO/LVM-HOWTO</uri>.
</note>
</body>
</section>

<section>
<title>Requerimientos iniciales</title>
<body>

<p>
Si va a hacer una instalación desde cero, hará falta usar un CD del
cual pueda arrancar y que soporte LVM2, tal como el LiveCD
Gentoo. Puede encontrar el LiveCD para plataforma x86 en nuestros <uri
link="http://www.gentoo.org/main/en/mirrors.xml">servidores
espejo</uri> bajo <path>/releases/x86/2004.3/livecd</path>. Tal vez
estén soportadas otras plataformas también.
</p>

<p>
Si instala LVM2 en un sistema existente con algún espacio de sobra en
disco duro, hará falta activar el módulo LVM2
(<path>dm-mod</path>). Este módulo está disponible en las fuentes
<path>gentoo-sources</path>, en <path>development-sources</path> y en
<path>gentoo-dev-sources</path>. La compilación del kernel y el hacer
funcionar a LVM2 serán cubiertos más adelante en esta misma guía.
</p>

<p>
¡No todos los kernels 2.4 de Gentoo soportan LVM2!
</p>
</body>
</section>

<section>
<title>Las particiones</title>
<body>

<p>
Nuestro sistema de ejemplo tiene dos discos duros IDE y serán
particionados de la siguiente manera:
</p>

<ul>
  <li>/dev/hda1  --  /boot</li>
  <li>/dev/hda2  --  (swap)</li>
  <li>/dev/hda3  --  /</li>
  <li>/dev/hda4  --  Será usado por LVM2</li>
  <li>/dev/hdb1  --  Será usado por LVM2</li>
</ul>

<impo>
Ponga atención a los nombres de las particiones, ya que es fácil
confundir las a y las b, y los números de las particiones. Un
movimiento en falso y podemos borrar la partición equivocada. ¡Está
advertido!
</impo>

<p>
OK, hora de comenzar ...
</p>
</body>
</section>
</chapter>

<chapter>
<title>Instalación</title>
<section>
<body>

<p>
Siga el manual, pero con los siguientes cambios en el capítulo <c>4. 
Preparando los discos</c>:
</p>

<p>
Use <c>fdisk</c> como está descrito en el Manual, pero use el esquema
de particiones antes mencionado como ejemplo. Acuérdese que este es
sólo <e>un ejemplo</e>, haga las adaptaciones según sus necesidades.
</p>

<p>
Cree una pequeña partición física para /boot (hda1). En este ejemplo,
/boot no será manejado por LVM2. Esta partición contendrá el gestor de
arranque y el/los kernel(s). 64MB debe ser suficiente para varias
generaciones de kernel.
</p>

<p>
Cree una partición de intercambio (hda2) y actívela.
</p>

<pre caption="Activando la partición de intercambio">
# <i>mkswap /dev/hda2</i>
# <i>swapon /dev/hda2</i>
</pre>

<p>
Cree una partición raíz / (hda3). Si le interesa colocar su partición
raíz bajo control de LVM (cosa que no recomendamos), vea la sección de
recursos al final de esta guía para un enlace a un mini-howto acerca
de cómo hacer esto. La partición raíz no requiere ser grande si decide
mantener los directorios <path>/opt /usr /home /var</path> y
<path>/tmp</path> en un grupo de volúmenes (vg) de LVM2. En este caso,
150MB serían suficientes.
</p>

<note>
<b>No</b> recomendamos colocar los siguientes directorios en una
partición LVM2: <path>/etc</path>, <path>/lib</path>, <path>/mnt</path>, 
<path>/proc</path>, <path>/sbin</path>, <path>/dev</path> y
<path>/root</path>. De esta manera podrá ingresar a su sistema (aunque
estará incompleto será utilizable como root) si ocurre algún desastre.
</note>

<p>
Asumiendo que las particiones /boot, swap y root no usan el disco
físico completo, cree una cuarta partición y asígnele el tipo 8e (para
Linux LVM). Si tiene más de un disco físico que quiera usar bajo LVM,
cree una partición en cada uno y asígneles el mismo tipo (8e).
</p>

<note>
Tomando en cuenta el tamaño enorme de los discos duros actuales,
podría considerar dividir el disco en particiones más pequeñas, en vez
de crear una sola partición enorme a ser agregada a un grupo de
volúmenes LVM2 en un sólo bloque. Después de todo, el LVM2 permite
fácilmente aumentar el tamaño de los volúmenes. Esto puede dejarle
particiones no asignadas que pueda usar afuera del control de un grupo
LVM2. Un consejo corto, no use su espacio de disco hasta que sepa que
lo necesite. Como ejemplo podemos citar un contribuyente que ha
subdividido su disco duro de 160 Gb en 8 particiones de
20 Gb c/u.
</note>

<p>
Cargue el módulo LVM2 <path>dm-mod</path>.
</p>

<pre caption="Cargando el módulo LVM2">
# <i>modprobe dm-mod</i>
</pre>

<p>
Barrido y activación del LVM:
</p>

<pre caption="Activando el LVM">
<comment>(Evite un barrido del lector cdrom)</comment>
# <i>mkdir -p /etc/lvm</i>
# <i>echo 'devices { filter=["r/cdrom/"] }' >/etc/lvm/lvm.conf</i>
# <i>vgscan</i>
  Reading all physical volumes.  This may take a while...
  No volume groups found
<comment>(Haga disponible otros grupos de volúmenes previamente configurados)</comment>
# <i>vgchange -a y</i>
</pre>

<p>
Prepare las particiones.
</p>

<pre caption="Preparando las particiones">
# <i>pvcreate /dev/hda4 /dev/hdb1</i>
  No physical volume label read from /dev/hda4
  Physical volume "/dev/hda4" successfully created
  No physical volume label read from /dev/hdb1
  Physical volume "/dev/hdb1" successfully created
</pre>

<p>
Configure un grupo de volúmenes. Un grupo de volúmenes es el resultado
de la combinación de varias unidades físicas en una unidad lógica.
</p>

<p>
En nuestro ejemplo, <path>/dev/hda1</path>, <path>/dev/hda2</path> y
<path>/dev/hda3</path> son las particiones <path>/boot</path>, swap y
root, por lo que neceistamos combinar <path>/dev/hda4</path> y
<path>/dev/hdb1</path>. Esto se puede hacer con un solo comando, pero
como es un ejemplo, crearemos un grupo de volúmenes y luego lo
aumentaremos.
</p>

<pre caption="Creando y aumentando un grupo de volúmenes">
<comment>(Cree un grupo de volúmenes llamado vg)</comment>
# <i>vgcreate vg /dev/hda4</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignore this warning)</comment>
  Volume group "vg" successfully created
<comment>(Aumente el tamaño de un grupo de volúmenes existente)</comment>
# <i>vgextend vg /dev/hdb1</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignore
esta advertencia, ahora y más adelante también)</comment>
  Volume group "vg" successfully extended
</pre>

<p>
Create the logical volumes.  Logical volumes are the equivalent of partitions
you would create using fdisk in a non LVM2 environment. In our example, we
create the following partitions:
</p>

<table>
<tr>
  <th>Directorio</th>
  <th>Tamaño</th>
</tr>
<tr>
  <ti>/usr</ti>
  <ti>10 GB</ti>
</tr>
<tr>
  <ti>/home</ti>
  <ti>5 GB</ti>
</tr>
<tr>
  <ti>/opt</ti>
  <ti>5 GB</ti>
</tr>
<tr>
  <ti>/var</ti>
  <ti>10 GB</ti>
</tr>
<tr>
  <ti>/tmp</ti>
  <ti>2 GB</ti>
</tr>
</table>

<p>
Como usaremos LVM2, no debemos preocuparnos mucho acerca de los
tamaños de las particiones, ya que pueden ser aumentadas a voluntad.
</p>

<note>
Como lo ha comentado Terje Kvernes, es más fácil aumentar el tamaño de
una partición que reducirla, de manera que tal vez quiera empezar con
particiones menores y aumentarlas según lo requiera.
</note>

<pre caption="Creando y aumentando volúmenes lógicos">
# <i>lvcreate -L10G -nusr  vg</i>
  Logical volume "usr" created <comment>(Los mensajes adicionales
  iguales no los mostramos)</comment>
# <i>lvcreate -L5G  -nhome vg</i>
# <i>lvcreate -L5G  -nopt  vg</i>
# <i>lvcreate -L10G -nvar  vg</i>
# <i>lvcreate -L2G  -ntmp  vg</i>
<comment>(Como ejemplo, aumentemos un volumen lógico por 5 Gbytes)</comment>
# <i>lvextend -L+5G /dev/vg/home</i>
</pre>

<p>
Cree sus sistemas de archivo en los volúmenes lógicos de la misma
manera que lo haría en una partición regular. Usamos ext3 en los
volúmenes lógicos, pero cualquier sistema de archivos de su escogencia
servirá:
</p>

<pre caption="Creando el sistema de archivos">
# <i>mke2fs -j /dev/vg/usr</i>
# <i>mke2fs -j /dev/vg/home</i>
# <i>mke2fs -j /dev/vg/opt</i>
# <i>mke2fs -j /dev/vg/var</i>
# <i>mke2fs -j /dev/vg/tmp</i>
</pre>

<p>
Monte sus particiones tal como lo describe el Manual y monte sus
volúmenes lógicos LVM2 tal como si fuesen particiones. Reemplace el
<path>/dev/hdxx</path> usual con <path>/dev/vg/nombre_del_volumen_lógico</path>.
</p>

<pre caption="Montando sus volúmenes lógicos">
<comment>(Asegúrese de montar primero su partición raíz, tal como
aparece en el Manual)</comment>
# <i>mkdir /mnt/gentoo/usr</i>
# <i>mount /dev/vg/usr /mnt/gentoo/usr</i>
# <i>mkdir /mnt/gentoo/home</i>
# <i>mount /dev/vg/home /mnt/gentoo/home</i>
# <i>mkdir /mnt/gentoo/opt</i>
# <i>mount /dev/vg/opt /mnt/gentoo/opt</i>
# <i>mkdir /mnt/gentoo/var</i>
# <i>mount /dev/vg/var /mnt/gentoo/var</i>
# <i>mkdir /mnt/gentoo/tmp</i>
# <i>mount /dev/vg/tmp /mnt/gentoo/tmp</i>
</pre>

<note>
El resto de la instalación es prácticamente igual, así que no la
repetiremos. Solamente le diremos dónde están las diferencias.
</note>

<p>
Al configurar su kernel, asegúrese que soporte LVM2 (ya que no todas
las de la serie 2.4 lo hacen). Seleccione el módulo LVM2 de la
siguiente manera:
</p>

<pre caption="Seleccionando el módulo LVM2 en un kernel 2.4.x">
Multi-device support (RAID and LVM)  ---&gt;
  [*] Multiple devices driver support (RAID and LVM)
  &lt; &gt;  RAID support
<comment>(Note que LVM no está seleccionado a propósito, esto era para LVM1)</comment>
  &lt; &gt;  Logical volume manager (LVM) support
  &lt;M&gt;  Device-mapper support
  &lt; &gt;   Mirror (RAID-1) support
</pre>

<pre caption="Seleccionando el módulo LVM2 en un kernel 2.6.x">
Device Drivers  ---&gt;
 Multi-device support (RAID and LVM)  ---&gt;
   [*] Multiple devices driver support (RAID and LVM)
   &lt; &gt;   RAID support
   &lt;M&gt;   Device mapper support
</pre>

<p>
El módulo compilado se llama <path>dm-mod.ko</path>
</p>

<p>
Luego de construir su kernel e instalar sus módulos, agregue
la siguiente línea a su
<path>/etc/modules.autoload.d/kernel-{KV}</path> donde {KV} representa
su versión de kernel (bien sea, 2.4 o 2.6) de manera que el módulo
LVM2 sea cargado al arrancar la máquina:
</p>

<pre caption="Agregando el módulo LVM2 a /etc/modules.autoload.d/kernel-2.6">
# <i>nano -w /etc/modules.autoload.d/kernel-2.6</i>
<comment>(Agregue la siguiente línea)</comment>
dm-mod
</pre>

<p>
Ahora instale el paquete lvm2.
</p>

<impo>
Verifique que su enlace simbólico <path>/usr/src/linux</path> apunte a
las fuentes de kernel que está usando porque el ebuild del lvm2 ebuild
depende del ebuild del mapeador de dispositivos que revisará la
presencia del archivo de fuentes requerido bajo
<path>/usr/src/linux/include/linux</path>.
</impo>

<pre caption="Haciendo emerge al paquete LVM2">
# <i>emerge lvm2</i>
<comment>(Al momento de escribir estas líneas, la versión estable es
la 2.00.08. Con esta versión, evite que lvm2 barra su cdrom haciendo:</comment>
# <i>echo 'devices { filter=["r/cdrom/"] }' >> /etc/lvm/lvm.conf</i>

<comment>(Las versions 2.00.15 y posteriores vienen con un archivo
/etc/lvm/lvm.conf. Modifique su /etc/lvm/lvm.conf y siga los comentarios</comment>
# <i>nano -w /etc/lvm/lvm.conf</i>
</pre>

<p>
Al modificar su archivo <path>/etc/fstab</path>, siga el Manual y
agregue sus volúmenes como lo requiera. Una vez más, unas líneas como
ejemplo:
</p>

<pre caption="Extracto del /etc/fstab">
/dev/hda1     /boot   ext3    noauto,noatime 1 1
/dev/hda2     none    swap    sw             0 0
/dev/hda3     /       ext3    noatime        0 0
# Logical volumes
/dev/vg/usr   /usr    ext3    noatime        0 0
/dev/vg/home  /home   ext3    noatime        0 0
/dev/vg/opt   /opt    ext3    noatime        0 0
/dev/vg/var   /var    ext3    noatime        0 0
/dev/vg/tmp   /tmp    ext3    noatime        0 0
</pre>

<p>
Al llegar al final de la parte de instalación del Manual, no se olvide
desmontar todos sus volúmenes lógicos también y para rematar, ejecute
el siguiente comando antes de reiniciar:
</p>

<pre caption="Cerrando operaciones del LVM2">
# <i>vgchange -a n</i>
</pre>

<p>
Reinicie su máquina y todas las particiones deberán estar montadas y
visibles.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Recursos</title>
<section>
<body>

<ul>
  <li>
    La <uri link="http://sources.redhat.com/lvm2">página oficial LVM2</uri>
  </li>
  <li>
    El <uri link="http://tldp.org/HOWTO/LVM-HOWTO">Howto LVM</uri>
  </li>
  <li>
    Artículos de Daniel Robbins sobre LVM en los DeveloperWorks de IBM:
    <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm/?dwzone=linux</uri>
    y <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm2.html?dwzone=linux</uri>
  </li>
  <li>
    ¿Cómo arrancar su sistema de archivos raíz desde LVM1? (How to
    boot your root FS off of LVM1):
    <uri>http://www.the-infinite.org/archive/docs/lvm/howto-boot-off-root-lv.txt</uri>
  </li>
</ul>

</body>
</section>
</chapter>

<chapter>
<title>Agradecimientos</title>
<section>
<body>

<p>
Muchas gracias a <mail link="bangert@gentoo.org">Thilo Bangert</mail>
y a <mail link="terjekv@math.uio.no">Terje Kvernes</mail> por su ayuda
y sus comentarios acerca de este documento.
</p>
</body>
</section>
</chapter>
</guide>

<?xml version = '1.0' encoding = 'UTF-8' ?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/es/ldap-howto.xml,v 1.1 2004/12/10 11:37:49 chiguire Exp $ -->

<guide link="/doc/en/ldap-howto.xml" lang="es">
<title>Guía Gentoo para la autenticación con OpenLDAP</title>
<author title="Author" >
  <mail link="sj7trunks@gentoo.org" >Benjamin Coles</mail>
</author>
<author title="Editor" >
  <mail link="swift@gentoo.org" >Sven Vermeulen</mail>
</author>
<author title="Editor" >
  <mail link="tseng@gentoo.org" >Brandon Hale</mail>
</author>
<author title="Editor" >
  <mail link="bennyc@gentoo.org" >Benny Chuang</mail>
</author>
<author title="Editor Es">
   <mail link="bass@gentoo.org">José Alberto Suárez López</mail>
</author>
<author title="Editor Es Adjunto">
   <mail link="chiguire@gentoo.org">John Christian Stoddart</mail>
</author>
<author title="Traductor" >
  <mail link="carles@carles.no-ip.info" >Carles Ferrer Peris</mail>
</author>

<abstract>
Esta guía explica los aspectos básicos de LDAP y muestra cómo instalar OpenLDAP con la finalidad de conseguir la autenticación entre un grupo de máquinas Gentoo.
</abstract>

<license/>

<version>0.10</version>
<date>2004-11-28</date>

<chapter>
<title>Empezando con OpenLDAP</title>
<section>
<title>¿Qué es LDAP?</title>
<body>
<p>
LDAP significa <e>Lightweight Directory Access Protocol</e> (Protocolo
Ligero de Acceso a Directorios). Basado en X.500, abarca muchas de sus
funciones principales, pero carece de las funciones más esotéricas de
X.500. Pero, ¿qué es este X.500 y por qué hay un LDAP? 
</p>

<p>
X.500 es un modelo de Servicio de Directorio basado en el concepto OSI
(interconexión de sistemas abiertos). Contiene definiciones de
espacios de nombres y los protocolos para preguntar y actualizar el
directorio. Sin embargo, X.500 ha sido creado para ser excesivamente
estricto en algunas situaciones. Entrando en LDAP, al igual que X.500,
proporciona un modelo de datos/espacio de nombres para el directorio y
el protocolo. No obstante, LDAP está diseñado para ejecutarse
directamente sobre la pila TCP/IP. Vea a LDAP como una versión ligera
de X.500.
</p>
</body>
</section>

<section>
<title>No lo entiendo. ¿Qué es un directorio?</title>
<body>
<p>
Un directorio es una base de datos especializada diseñada para
frecuentes consultas pero para infrecuentes actualizaciones. A
diferencia de las bases de datos generalistas, no contiene soporte
para transacciones o funcionalidad de vuelta atrás
(&quot;roll-back&quot;). Los directorios son fácilmente replicados
para incrementar disponibilidad y fiabilidad. Cuando los directorios
son replicados, se permiten inconsistencias temporales con tal de que
acaben siendo finalmente sincronizadas.
</p>
</body>
</section>

<section>
<title>¿Cómo está estructurada la información?</title>
<body>
<p>
Toda la información dentro de un directorio está estructurada
jerárquicamente. Aún más, si usted intenta introducir datos en el
directorio, el directorio debe conocer cómo almacenar estos datos en
un árbol. Eche un vistazo a la compañía de ficción y a su organigrama:
</p>

<pre caption="Estructura organizativa de GenFic, una empresa Gentoo Ficticia" >
dc:         com
             |
dc:        genfic         <comment>(Organización)</comment>
          /      \
ou:  personas servidores  <comment>(Unidades organizativas)</comment>
      /    \     ..     
uid: ..   john            <comment>(Datos específicos de las UO)</comment>
</pre>

<p>
Puesto que usted no puede alimentar la base de datos con este tipo de
&quot;ascii-art&quot;, cada nodo de tal árbol debe ser definido. Para
nombrar tales nodos, LDAP usa un sistema de definición de nombres. La
mayor parte de distribuciones de LDAP (incluyendo OpenLDAP) ya
contienen un buen número de esquemas predefinidos (y comúnmente
aprobados), como el &quot;inetorgperson&quot;, frecuentemente
utilizado para definir usuarios.
</p>

<p>
Animamos a las personas interesadas a leer la<uri
link="http://www.openldap.org/doc/admin21/" >OpenLDAP Admin
Guide</uri>.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Configurando OpenLDAP</title>
<section>
<title>Configuración inicial</title>
<body>

<note>
En este documento utilizamos la dirección genfic.com como ejemplo. Usted deberá, desde luego, cambiarlo. Sin embargo, asegúrese que el nodo superior es un dominio oficial de primer nivel (net, com, cc, be, ...).
</note>

<p>
Primero instale todos los componentes necesarios en su servidor:
</p>

<pre caption="Instalación de OpenLDAP" >
# <i>emerge openldap pam_ldap nss_ldap</i>
<comment>
 (Necesitamos migrationtools-64 que está, en el momento de escribir esto, únicamente disponible en los entornos ~arch)
</comment>
# <i>mkdir /etc/portage</i>
# <i>echo &quot;net-nds/migrationtools&quot; >> /etc/portage/package.keywords</i>
# <i>emerge migrationtools</i>
 
# <i>chown ldap:ldap /var/lib/openldap-ldbm /var/lib/openldap-data /var/lib/openldap-slurp</i>
</pre>

<p>
Edite <path>/etc/openldap/slapd.conf</path>y añada lo siguiente
después de <c>core.schema</c>:
</p>

<pre caption="/etc/openldap/slapd.conf" >
<comment># Incluya los esquemas de datos necesarios</comment>
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/nis.schema

<comment># Use crypt para el resumen criptográfico de las contraseñas</comment>
password-hash {crypt}

<comment># Defina las propiedades SSL y TLS (opcional)</comment>
TLSCertificateFile /etc/ssl/ldap.pem
TLSCertificateKeyFile /etc/openldap/ssl/ldap.pem
TLSCACertificateFile /etc/ssl/ldap.pem

<codenote>Adicionalmente ...</codenote>

database        ldbm
suffix          &quot;dc=genfic,dc=com&quot;
rootdn          &quot;cn=Manager,dc=genfic,dc=com&quot;
rootpw          <i>{MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==</i>
directory       /var/lib/openldap-ldbm
index           objectClass     eq

<codenote>Puede obtener una contraseña cifrada como la anterior con slappasswd -h {Md5}</codenote>
</pre>

<p>
Luego edite el fichero de configuración de LDAP:
</p>

<pre caption="/etc/openldap/ldap.conf" >
# <i>nano -w /etc/openldap/ldap.conf</i>
<codenote>Añada lo siguiente ...</codenote>

BASE         dc=genfic, dc=com
URI          ldaps://auth.genfic.com:636/
TLS_REQCERT  allow
</pre>

<p>
Ahora deberá generar un certificado SSL para asegurar su
directorio. Responda a las preguntas de la mejor manera
posible. Cuando se le pregunte por su <e>Common Name</e>, introduzca
el nombre que los clientes usarán cuando se conecten con el
servidor. Generalmente es el dominio completo (por
ejemplo,<path>auth.genfic.com</path>).
</p>

<pre caption="Generando el Certificado SSL" >
# <i>cd /etc/ssl</i>
# <i>openssl req -config /etc/ssl/openssl.cnf -new -x509 -nodes -out \
ldap.pem -keyout /etc/openldap/ssl/ldap.pem -days 999999</i>
</pre>

<p>
Ahora edite <path>/etc/conf.d/slapd</path> y añada lo siguiente,
comentando la línea existente:
</p>

<pre caption="/etc/conf.d/slapd" >
OPTS=&quot;-h 'ldaps:// ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock'&quot;
</pre>

<p>
Inicie slapd:
</p>

<pre caption="Iniciando SLAPd" >
# <i>/etc/init.d/slapd start</i>
</pre>

<p>
Puede probarlo con la siguiente instrucción:
</p>

<pre caption="Prueba del servicio SLAPd" >
# <i>ldapsearch -D &quot;cn=Manager,dc=genfic,dc=com&quot; -W</i>
</pre>

<p>
Si recibe un error, pruebe a añadir <c>-d 255</c> para incrementar el
nivel de detalle de los avisos y poder resolver el problema que pueda
tener.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Migrar los datos existentes</title>
<section>
<title>Migración de cuentas de usuario</title>
<body>
<p>
A continuación, migraremos las cuentas de usuario. Abra
<path>/usr/share/migrationtools/migrate_common.ph</path> y edite lo
siguiente:
</p>

<pre caption="/usr/share/migrationtools/migrate_common.ph" >
$DEFAULT_BASE = &quot;dc=genfic,dc=com&quot;;
$EXTENDED_SCHEMA = 1;
<comment># Comente estas líneas a menos que tenga un esquema de correo cargado
</comment>
<comment>#$DEFAULT_MAIL_DOMAIN = &quot;genfic.com&quot;;</comment>
<comment>#$DEFAULT_MAIL_HOST = &quot;mail.genfic.com&quot;;</comment>
</pre>

<p>
Ahora ejecute los guiones de migración:
</p>

<pre caption="Ejecución de los scripts de migración" >
# <i>export ETC_SHADOW=/etc/shadow</i>
# <i>cd /usr/share/migrationtools</i>
# <i>./migrate_base.pl > /tmp/base.ldif</i>
# <i>./migrate_group.pl /etc/group /tmp/group.ldif</i>
# <i>./migrate_hosts.pl /etc/hosts /tmp/hosts.ldif</i>
# <i>./migrate_passwd.pl /etc/passwd /tmp/passwd.ldif</i>
</pre>

<p>
Este último paso migra los ficheros anteriores a ficheros ldif leídos
por LDAP. Ahora se añadirán los ficheros a nuestro directorio:
</p>

<pre caption="Importación de los datos a nuestro directorio" >
# <i>ldapadd -D &quot;cn=Manager,dc=genfic,dc=com&quot; -W -f /tmp/base.ldif</i>
# <i>ldapadd -D &quot;cn=Manager,dc=genfic,dc=com&quot; -W -f /tmp/group.ldif</i>
# <i>ldapadd -D &quot;cn=Manager,dc=genfic,dc=com&quot; -W -f /tmp/passwd.ldif</i>
# <i>ldapadd -D &quot;cn=Manager,dc=genfic,dc=com&quot; -W -f /tmp/hosts.ldif</i>
</pre>
</body>
</section>
</chapter>

<chapter>
<title>Configuración de la autenticación</title>
<section>
<title>Configuración de PAM</title>
<body>
<p>
Seguidamente vamos a configurar PAM para permitir la autorización con
LDAP. Edite <path>/etc/pam.d/system-auth</path> para que se parezca al
siguiente listado:
</p>

<pre caption="/etc/pam.d/system-auth" >
auth    required    /lib/security/pam_env.so
auth    sufficient  /lib/security/pam_unix.so likeauth nullok shadow
auth    sufficient  /lib/security/pam_ldap.so use_first_pass
auth    required    /lib/security/pam_deny.so

account sufficient  /lib/security/pam_unix.so
account sufficient  /lib/security/pam_ldap.so
account required    /lib/security/pam_deny.so

password    required /lib/security/pam_cracklib.so retry=3
password    sufficient /lib/security/pam_unix.so nullok use_authtok shadow md5
password    sufficient /lib/security/pam_ldap.so use_authtok
password    required /lib/security/pam_deny.so

session required    /lib/security/pam_limits.so
session required    /lib/security/pam_unix.so
session required    /lib/security/pam_mkhomedir.so skel=/etc/skel/ umask=0
session optional    /lib/security/pam_ldap.so
</pre>

<p>
Ahora cambie <path>/etc/ldap.conf</path> para que tenga:
</p>

<pre caption="/etc/ldap.conf" >
<comment>#host 127.0.0.1</comment>
<comment>#base dc=padl,dc=com</comment>

ssl start_tls
ssl on
suffix          &quot;dc=genfic,dc=com&quot;
<comment>#rootbinddn uid=root,ou=People,dc=genfic,dc=com</comment>

uri ldaps://auth.genfic.com/
pam_password exop

ldap_version 3
pam_filter objectclass=posixAccount
pam_login_attribute uid
pam_member_attribute memberuid
nss_base_passwd ou=People,dc=genfic,dc=com
nss_base_shadow ou=People,dc=genfic,dc=com
nss_base_group  ou=Group,dc=genfic,dc=com
nss_base_hosts  ou=Hosts,dc=genfic,dc=com

scope one
</pre>

<p>
Finalmente, configure sus clientes para que verifiquen en LDAP las
cuentas de sistema:
</p>

<pre caption="/etc/nsswitch.conf" >
passwd:         files ldap
group:          files ldap
shadow:         files ldap
</pre>

<p>
Para probar los cambios, escriba:
</p>

<pre caption="Prueba de la autorización con LDAP" >
# <i>getent passwd|grep 0:0</i>
<codenote>Debería devolver dos entradas:</codenote>
root:x:0:0:root:/root:/bin/bash 
root:x:0:0:root:/root:/bin/bash
</pre>

<p>
Si observa, una de las lineas copiadas en su
<path>/etc/ldap.conf</path> está comentada (the <c>rootbinddn</c>
line): no la necesita salvo que quiera cambiar la contraseña de un
usuario como superusuario. En este caso, necesita escribir la
contraseña de root en <path>/etc/ldap.secret</path> con texto en
claro. Esto es <brite>PELIGROSO</brite> por lo que debería tener
permisos &quot;600&quot;. Lo que yo hago es mantener el fichero vacío
y cuando necesito cambiar cualquier contraseña que está tanto en ldap
como en <path>/etc/passwd</path> escribo la contraseña en él durante
10 segundos mientras hago los cambios y la borro cuando he acabado.
</p>
</body>
</section>

<section>
<title>Permisos de OpenLDAP</title>
<body>
<p>
Si echamos un vistazo a <path>/etc/openldap/slapd.conf</path> podrá
ver que se pueden especificar ACLs (listas de control de acceso, o
permisos, si lo prefiere) de qué datos pueden los usuarios leer y/o
escribir:
</p>

<pre caption="/etc/openldap/slapd.conf" >
access to *
  by dn=&quot;uid=root,ou=people,dc=genfic,dc=com&quot; write
  by users read
  by anonymous auth

access to attrs=userPassword,gecos,description,loginShell
  by self write
</pre>

<p>
Esto le da acceso a todo a lo que a un usuario le está permitido
cambiar. Si es su información, entonces tiene acceso de escritura; si
es la de otro usuario, entonces puede leerla; un usuario anónimo puede
enviar un usuario/contraseña para ser conectado. Hay cuatro niveles,
del menor al mayor: <c>autorización búsqueda lectura escritura</c>.
</p>

<p>
La siguiente ACL es un poco más segura puesto que impide a los
usuarios normales leer la contraseña enmascarada de otros usuarios:
</p>

<pre caption="/etc/openldap/slapd.conf" >
access to attribute=&quot;userPassword&quot;
  by dn=&quot;uid=root,ou=people,dc=genfic,dc=com&quot; write
  by dn=&quot;uid=John,ou=People,dc=genfic,dc=com&quot; write
  by anonymous auth
  by self write
  by * none
  
access to *
  by dn=&quot;uid=root,ou=People,dc=genfic,dc=com&quot; write
  by * read
</pre>

<p>
Este ejemplo le da acceso a root y John para leer/escribir/buscar en
todo el árbol por debajo de <path>dc=genfic,dc=com</path>. También
permite a los usuarios cambiar su propia <path>userPassword</path>. Y
en la sentencia final cualquier otro tiene la capacidad de búsqueda,
lo que significa que puede introducir un filtro de búsqueda pero no
puede leer los resultados de la búsqueda. Puede tener múltiples ACLs
pero la regla de procesamiento es de abajo arriba, por lo que su nivel
superior debe ser el más restrictivo.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Trabajando con OpenLDAP</title>
<section>
<title>Manteniendo el directorio</title>
<body>
<p>
Puede empezar utilizando el directorio para autentificar usuarios en
apache, proftpd, qmail o samba. Puede administrarlo con Webmin, que
proporciona una interfaz de administración realmente sencilla. Puede
también usar gq o directory_administrator.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Agradecimientos</title>
<section>
<body>
<p>
Quisiera agradecer a Matt Heler el préstamo de su equipo para poder
realizar esta guía. Gracias también a toda la gente simpática de #ldap
@ irc.freenode.net.
</p>
</body>
</section>
</chapter>
</guide>

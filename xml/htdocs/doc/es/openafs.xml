<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/es/openafs.xml,v 1.6 2007/08/07 21:56:51 chiguire Exp $ -->
 
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link = "/doc/es/openafs.xml" lang="es">
<title>GuÃ­a Gentoo Linux OpenAFS</title>
<author title="Editor">
  <mail link="darks@gentoo.org">Holger Brueckner</mail>
</author>
<author title="Editor">
  <mail link="bennyc@gentoo.org">Benny Chuang</mail>
</author>
<author title="Editor">
  <mail link="blubber@gentoo.org">Tiemo Kieft</mail>
</author>
<author title="Editor">
  <mail link="fnjordy@gmail.com">Steven McCoy</mail>
</author>
<author title="Editor">
  <mail link="stefaan@gentoo.org">Stefaan De Roeck</mail>
</author>
<author title="Editor">
  <mail link="fox2mike@gentoo.org">Shyam Mani</mail>
</author>
<author title="Traductor">
  <mail link="chiguire@gentoo.org">John Christian Stoddart</mail>
 </author>
<author title="Traductor">
  <mail link="rlazo.paz@gmail.com">Rodrigo Lazo</mail>
</author>

<abstract>
Esta guía muestra cómo instalar un servidor y clientes de OpenAFS en
Gentoo Linux.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.1</version>
<date>2005-11-10</date>

<chapter>
<title>Introducción</title>
<section>
<title>Sobre este documento</title>
<body>

<p>
Este documento te provee con todos los pasos necesarios para instalar
un servidor OpenAFS en Gentoo Linux. Partes de este documento están
tomadas del AFS PUF y la Guía de inicio rápido sobre AFS de
IBM. Bueno, nunca reinventaremos la rueda. :)
</p>
</body>
</section>

<section>
<title>¿Qué es AFS?</title>
<body>

<p>
AFS es un sistema de archivos distribuido que permite compartir,
eficientemente, recursos del sistema de archivos a través de una
red de área local y una red de área amplia entre máquinas
co-operativas (clientes y servidores). Los clientes mantienen un
caché de los objetos más utilizados (archivos), para tener un
acceso más rápido.
</p>

<p>
AFS está basado en el sistema de archivos distribuido
originalmente desarrollado en el Centro de Tecnología de la
Información de la Universidad Carnegie-Mellon que fue llamado el
"Sistema de Archivos Andrew". "Andrew" era el nombre del proyecto
de investigación de la CMU - honrando a los fundadores de la
universidad. Una vez que Transarc fue formado y AFS se convirtió
en un producto, el "Andrew" fue dejado de lado como una forma de
indicar que AFS había ido más allá del proyecto de investigación
Andrew y se había convertido en un producto con soporte, un
sistema de archivos de calidad. Sin embargo, ya habían numerosas
celdas cuyo sistema de archivos raíz era /afs. Inicialmente,
cambiar este detalle no era una operación sencilla, así que, para
evitar que los primero sitios AFS tuviesen que renombrar sus
sistemas de archivos, se mantuvo el nombre AFS.
</p> 
</body>
</section>  
  
<section>
<title>¿Qué es una celda AFS?</title>
<body>

<p>
Una celda AFS es una colección de servidores agrupados juntos
administrativamente y que representan un único y cohesionado
sistema de archivos. Típicamente, una celda AFS es un conjunto
de máquinas que comparten el mismo nombre de dominio de Internet
(como por ejemplo gentoo.org). Los usuarios ingresan al sistema
a través de una de las estaciones de trabajo cliente y esta
solicita, a nombre del usuario, la información y archivos
necesarios de los servidores de la celda. El usuario no sabe en
qué servidor se encuentra el archivo al que está accediendo,
incluso no notará si el servidor está localizado en otra
habitación, dado que cada volumen puede ser replicado y movido a
otro servidor sin que el usuario pueda notarlo. Los archivos son
siempre accesibles. Es como NFS, pero con esteroides :)
</p>
</body>
</section>  

<section>
<title>¿Cuáles son los beneficios de usar AFS ?</title>
<body>

<p>
Las principales fortalezas de AFS son:
facilidad en el manejo del caché (en el lado del cliente,
normalmente de 100M a 1GB), características de seguridad (basado
en Kerberos 4, listas de control de acceso), simplicidad en el
direccionamiento (únicamente posees un sistema de archivos),
escalabilidad (añade servidores a la celda cuando los
necesites), protocolo de comunicaciones.
</p>
</body>
</section>  

<section>
<title>¿Dónde puedo encontrar más información?</title>
<body>

<p>
Lee el <uri
link="http://www.angelfire.com/hi/plutonic/afs-faq.html">AFS
PUF</uri>.
</p>

<p>
La página principal de OpenAFS <uri
link="http://www.openafs.org">www.openafs.org</uri>.
</p>

<p>
AFS fue originalmente desarrollado por Transarc que es ahora
parte de IBM. Puedes encontrar algo de información de AFS en la <uri
link="http://www.transarc.ibm.com/Product/EFS/AFS/index.html">Página
web de Transarcs</uri>.
</p>
</body>
</section>  

<section>
<title>¿Cómo puedo depurar problemas?</title>
<body>

<p>
OpenAFS tiene grandes capacidades de bitácora. Sin embargo, por
defecto lo hace directamente dentro de sus propias bitácoras en vez de
hacerlo a través de los mecanismos que tienes en tu sistema. Para que
tus servidores usen este mecanismo utiliza la opción <c>-syslog</c> en
todos los comandos <c>bos</c>.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Actualizando desde versiones anteriores</title>
<section>
<title>Introducción</title>
<body>

<p>
Esta sección apunta a ayudarte a través del proceso de actualización
de una instalación existente a OpenAFS versión 1.4.0 o superior (o
1.2.x empezando desde 1.2.13. Lo antes mencionado no será manejado
específicamente, ya que la mayoría de las personas querrán la versión
1.4 para soporte apropiado de linux-2.6, soporte para archivos más
grandes y correcciones de fallos).
</p>

<p>
Si lo que estás haciendo es una instalación completamente nueva de la
versión 1.4 de OpenAFS, entonces puedes saltarte este capítulo sin
dudarlo. Sin embargo, si estás actualizando de una versión anterior,
es muy recomendable que sigas las instrucciones de las siguientes
secciones. El guión de transición en el ebuild está diseñado para
asistirte en una actualización rápida y el reinicio del sistema en
poco tiempo. Por favor, nota que (por razones de seguridad) no borrará
los archivos de configuración y guiones de arranque de los lugares
antiguos, tampoco alterará tu configuración de arranque para que
utilice los nuevos guiones, etc. Si necesitas más razones para
convencerte, utilizando un módulo OpenAFS del núcleo junto con los
binarios del sistema actualizados, muy probablemente causará que tu
núcleo enloquezca. Así que, sigamos leyendo para tener una transición
limpia y tranquila, ok?
</p>

<note>
Este capítulo ha sido escrito teniendo distintas configuraciones de
sistema en mente. Sin embargo, es posible que debido a ajustes que el
usuario haya realizado, su configuración específica no será descrita
aquí. Un usuario con suficiente confianza en sí mismo como para
modificar sus sistema debe tener suficiente experiencia cómo para
aplicar los consejos aquí presentados cuando sea
necesario. Viceversa, un usuario que haya hecho pocas modificaciones
puede saltarse la mayoría de las advertencias.
</note>

</body>
</section>
<section>
<title>Diferencias con versiones anteriores</title>
<body>

<p>
Tradicionalmente, OpenAFS ha utilizado las mismas convenciones de
rutas que el IBM TransArc labs, antes de que exista la separación. Por
lo cual se entiende que configuraciones antiguas de AFS sigan con
aquellas convenciones de rutas antiguas. Instalaciones más recientes
están mas acorde con el FHS al utilizar ubicaciones estándar (como se
ve en muchas distribuciones de Linux). La siguiente tabla es una
compilación del guión de configuración y el LEEME que acompaña los
comprimidos de la distribución de OpenAFS:
</p>

<table>
<tr>
  <th>Directorio</th>
  <th>Propósito</th>
  <th>Modo Transarc</th>
  <th>Modo por defecto</th>
  <th>Traducción en Gentoo</th>
</tr>
<tr>
  <ti>viceetcdir</ti>
  <ti>Configuración del cliente</ti>
  <ti>/usr/vice/etc</ti>
  <ti>$(sysconfdir)/openafs</ti>
  <ti>/etc/openafs</ti>
</tr>
<tr>
  <ti>sin nombre</ti>
  <ti>Binarios del cliente</ti>
  <ti>sin especificar</ti>
  <ti>$(bindir)</ti>
  <ti>/usr/bin</ti>
</tr>
<tr>
  <ti>afsconfdir</ti>
  <ti>Configuración del servidor</ti>
  <ti>/usr/afs/etc</ti>
  <ti>$(sysconfdir)/openafs/server</ti>
  <ti>/etc/openafs/server</ti>
</tr>
<tr>
  <ti>afssrvdir</ti>
  <ti>Binarios internos del servidor</ti>
  <ti>/usr/afs/bin (servers)</ti>
  <ti>$(libexecdir)/openafs</ti>
  <ti>/usr/libexec/openafs</ti>
</tr>
<tr>
  <ti>afslocaldir</ti>
  <ti>Estado del servidor</ti>
  <ti>/usr/afs/local</ti>
  <ti>$(localstatedir)/openafs</ti>
  <ti>/var/lib/openafs</ti>
</tr>
<tr>
  <ti>afsdbdir</ti>
  <ti>Auth/serverlist/... bases de datos</ti>
  <ti>/usr/afs/db</ti>
  <ti>$(localstatedir)/openafs/db</ti>
  <ti>/var/lib/openafs/db</ti>
</tr>
<tr>
  <ti>afslogdir</ti>
  <ti>Archivos de bitácora</ti>
  <ti>/usr/afs/logs</ti>
  <ti>$(localstatedir)/openafs/logs</ti>
  <ti>/var/lib/openafs/logs</ti>
</tr>
<tr>
  <ti>afsbosconfig</ti>
  <ti>Configuración del supervisor</ti>
  <ti>$(afslocaldir)/BosConfig</ti>
  <ti>$(afsconfdir)/BosConfig</ti>
  <ti>/etc/openafs/BosConfig</ti>
</tr>
</table>

<p>
Hay algunas rarezas, como binarios siendo colocados en
<path>/usr/vice/etc</path> en modo Transarc, pero esta lista no
intenta ser exhaustiva. Es más que nada para dar una referencia a
aquellos tratando de resolver problemas con la transición de sus
archivos de configuración.
</p>

<p>
Otro resultado del cambio de rutas es que el caché de disco ha sido
cambiado de ubicación de <path>/usr/vice/cache</path> a
<path>/var/cache/openafs</path>.
</p>

<p>
Además, el guión de inicio ha sido dividido en una parte cliente y
otra servidor. Solías tener <path>/etc/init.d/afs</path>, pero ahora
tienes ambos, <path>/etc/init.d/openafs-client</path> y
<path>/etc/init.d/openafs-server</path>. Consecuentemente, el archivo
de configuración <path>/etc/conf.d/afs</path> a sido dividido en
<path>/etc/conf.d/openafs-client</path> y
<path>/etc/conf.d/openafs-server</path>. Junto con esto, las opciones
dentro de <path>/etc/conf.d/afs</path> para definir la máquina como
cliente o servidor son obsoletas.
</p>

<p>
Otro cambio al guión de inicio es que ya no revisa la configuración
de tu caché de disco. El antiguo código requiere que una partición
ext2 separada sea montada en <path>/usr/vice/cache</path>. Habían
algunos problemas con ello:
</p>
<ul>
  <li>
    Aunque es una configuración muy lógica, tu caché no necesita estar
    en una partición separada. Mientras te asegures que existe la
    cantidad de espacio libre que especificas en
    <path>/etc/openafs/cacheinfo</path> para el uso del caché de
    disco, estás a salvo. Así que no existe un problema real con que
    tu caché esté en tu partición raíz.
  </li>
  <li>
    Algunas personas utilizan enlaces simbólicos para apuntar a la
    verdadera ubicación del caché de disco. El guión de inicio no se
    llevaba bien con ello, ya que la ubicación del caché no era
    mostrada en <path>/proc/mounts</path>.
  </li>
  <li>
    En estos días, muchos prefieren ext3 sobre ext2. Ambos sistemas de
    archivos son válidos para utilizarlos en el caché de
    disco. Cualquier otro sistema de archivos no está soportado (como
    por ejemplo: no intentes reiserfs, recibirás una enorme
    advertencia, de todas formas espera fallos).
  </li>
</ul>
</body>
</section>

<section>
<title>Transición a las nuevas rutas</title>
<body>

<p>
Antes de nada, emerger una nueva versión de OpenAFS no debe
sobreescribir ningún archivo de configuración antiguo. El guión está
diseñado para no alterar ningún archivo de configuración ya existente
en el sistema. Incluso si tienes una configuración completamente
entreverada utilizando nuevas y antiguas ubicaciones, el guión no debe
causar mayores problemas. También, si detecta que hay un servidor
OpenAFS ejecutándose, la instalación se detendrá, previniendo
cualquier posible corrupción en la base de datos.
</p>

<p>
Una advertencia sin embargo -- han habido algunos ebuilds flotando a
través de la Internet que desactivan parcialmente la protección que
Gentoo pone en <path>/etc</path>. Estos ebuilds nunca han sido
distribuidos por Gentoo. Quizás quieras revisar la variable
<c>CONFIG_PROTECT_MASK</c> en la salida del siguiente comando:
</p>

<pre caption="Revisando tu CONFIG_PROTECT_MASK">
# <i>emerge info | grep "CONFIG_PROTECT_MASK"</i>
CONFIG_PROTECT_MASK="/etc/gconf /etc/terminfo /etc/texmf/web2c /etc/env.d"
</pre>

<p>
Aunque nada en este ebuild tocará el archivo <path>/etc/afs</path>, la
actualización causará que tu antigua instalación de OpenAFS sea
eliminada. Los archivos en <c>CONFIG_PROTECT_MASK</c> que pertenezcan
a la antigua instalación también serán retirados.
</p>

<p>
Debe ser claro para el usuario experimentado que en caso se haya
ajustado el sistema añadiendo enlaces simbólicos manualmente
(e.g. <path>/usr/afs/etc</path> hacia <path>/etc/openafs</path>), la
nueva instalación posiblemente se llevará bien con los antiguos
archivos de configuración. En este caso, no ha habido una transición
real, así que eliminar la antigua instalación resultará en una
configuración de OpenAFS rota.
</p>

<p>
Ahora que sabes que no sucede, quizás quieras saber lo que sí pasa:
</p>

<ul>
  <li>
    <path>/usr/afs/etc</path> es copiado a <path>/etc/openafs/server</path>
  </li>
  <li>
    <path>/usr/vice/etc</path> es copiado a <path>/etc/openafs</path>
  </li>
  <li>
    <path>/usr/afs/local</path> es copiado a <path>/var/lib/openafs</path>
  </li>
  <li>
    <path>/usr/afs/local/BosConfig</path> es copiado a
    <path>/etc/openafs/BosConfig</path>, mientras se reemplazan las
    ocurrencias de <path>/usr/afs/bin/</path> con
    <path>/usr/libexec/openafs</path>, <path>/usr/afs/etc</path> con
    <path>/etc/openafs/server</path> y <path>/usr/afs/bin</path>
    (sin el / como previamente) con <path>/usr/bin</path>
  </li>
  <li>
    <path>/usr/afs/db</path> es copiado a <path>/var/lib/openafs/db</path>
  </li>
  <li>
    El archivo de configuración <path>/etc/conf.d/afs</path> es
    copiado a <path>/etc/conf.d/openafs-client</path>, ya que todas
    las opciones antiguas estaban destinadas para uso sólo del
    cliente.
  </li>
</ul>
</body>
</section>

<section>
<title>La actualización en sí</title>
<body>

<p>
Así que no tienes un servidor OpenAFS? O quizás sí, y las secciones
anteriores te han informado de que va a suceder, y aún quieres seguir?
</p>

<p>
¡Entonces vamos a hacerlo!
</p>

<p>
Si tienes un servidor levantado, querrás detenerlo ahora.
</p>

<pre caption="Deteniendo OpenAFS (en caso que tengas un servidor)">
# <i>/etc/init.d/afs stop</i>
</pre>

<p>
Ahora, a actualizar.
</p>

<pre caption="¡Actualiza!">
# <i>emerge -u openafs</i>
</pre>

</body>
</section>
<section>
<title>Reiniciando OpenAFS</title>
<body>

<p>
Si no tienes un servidor OpenAFS levantado, no deberías haber sido
obligado a detener el cliente. Ahora es tiempo para que lo hagas.
</p>

<pre caption="Deteniendo el cliente OpenAFS luego de la actualización">
# <i>/etc/init.d/afs stop</i>
</pre>

<p>
De seguro querrás mantener bajo el tiempo que pase tu servidor
detenido, así que ahora puedes reactivar tu servidor OpenAFS.
</p>

<pre caption="Reiniciando el servidor OpenAFS luego de la actualización">
# <i>/etc/init.d/openafs-server start</i>
</pre>

<p>
Puedes revisar si está corriendo de manera adecuada con el siguiente
comando:
</p>

<pre caption="Revisando el estado del servidor OpenAFS">
# <i>/usr/bin/bos status localhost -localauth</i>
</pre>

<p>
Antes de que reinicies el cliente OpenAFS, por favor toma algún tiempo
en revisar la configuración de tu caché. Estas son determinadas en
<path>/etc/openafs/cacheinfo</path>.  Para reiniciar tu cliente
OpenAFS, ejecuta el siguiente comando:
</p>

<pre caption="Reiniciando el cliente OpenAFS luego de la actualización">
# <i>/etc/init.d/openafs-client start</i>
</pre>

</body>
</section>
<section>
<title>Haciendo la limpieza</title>
<body>

<p>
Antes de eliminar lo anterior, por favor asegúrate bien que todo esté
corriendo de manera adecuada y que efectivamente has reiniciado todo
luego de la actualización (de otra forma, puede que aún estés
ejecutando tu antigua instalación).
</p>

<impo>
¡¡Por favor asegúrate que no estás utilizando
<path>/usr/vice/cache</path> para el caché de disco si vas a eliminar
el directorio <path>/usr/vice</path>!!
</impo>

<p>
Los siguientes directorios pueden ser eliminados del sistema de manera
segura:
</p>

<ul>
  <li><path>/etc/afs</path></li>
  <li><path>/usr/vice</path></li>
  <li><path>/usr/afs</path></li>
  <li><path>/usr/afsws</path></li>
</ul>

<p>
Los siguientes archivos también son innecesarios:
</p>

<ul>
  <li><path>/etc/init.d/afs</path></li>
  <li><path>/etc/conf.d/afs</path></li>
</ul>

<pre caption="Eliminando los archivos antiguos">
# <i>tar czf /root/oldafs-backup.tgz /etc/afs /usr/vice /usr/afs /usr/afsws</i>
# <i>rm -R /etc/afs /usr/vice /usr/afs /usr/afsws</i>
# <i>rm /etc/init.d/afs /etc/conf.d/afs</i>
</pre>

<p>
En caso que hayas utilizado previamente los ebuilds =openafs-1.2.13 o
=openafs-1.3.85, es probable que también tengas algunos archivos innecesarios más:
</p>

<ul>
  <li><path>/etc/init.d/afs-client</path></li>
  <li><path>/etc/init.d/afs-server</path></li>
  <li><path>/etc/conf.d/afs-client</path></li>
  <li><path>/etc/conf.d/afs-server</path></li>
</ul>

</body>
</section>
<section>
<title>Cambios en los guiones de inicio</title>
<body>

<p>
La mayoría de la gente posiblemente tenga configurado sus sistema para
que inicie el cliente y el servidor OpenAFS automáticamente. Aquellos
que no, pueden saltarse esta sección con seguridad. Si tienes un
sistema que los arranca automáticamente, debes reactivar esta
característica ya que los nombres de lo guiones de inicio han cambiado.
</p>

<pre caption="Reactivando el inicio de OpenAFS al arrancar el sistema">
# <i>rc-update del afs default</i>
# <i>rc-update add openafs-client default</i>
# <i>rc-update add openafs-server default</i>
</pre>

<p>
Si tienes <c>=openafs-1.2.13</c> o <c>=openafs-1.3.85</c>, debes
eliminar <path>afs-client</path> y <path>afs-server</path> del nivel
de ejecución por defecto, en vez de <path>afs</path>.
</p>

</body>
</section>
<section>
<title>Solucionando problemas: que hacer si falla la actualización
automática</title>
<body>
<!--TRADUCIR!!! -->
<p>
No entres en pánico. No deberías haber perdido ninguna información ni
tampoco archivos de configuración. Así que analicemos la situación. Por
favor envía información sobre la falla a <uri
link="http://bugs.gentoo.org">bugs.gentoo.org</uri> en cualquier caso,
con la mayor cantidad de información posible.
</p>

<p>
Si tienes problemas iniciando el cliente, esto debe ayudarte a
diagnosticar el problema.
</p>

<ul>
  <li>
    Ejecuta <c>dmesg</c>. El cliente normalmente envía mensajes de error ahí.
  </li>
  <li>
    Revisa <path>/etc/openafs/cacheinfo</path>. Debería estar con el
    siguiente formato: /afs:{ruta al caché de disco}:{número de
    bloques para el caché de disco}.  Normalmente, tu caché de disco
    estará localizado en <path>/var/cache/openafs</path>.
  </li>
  <li>
    Revisa la salida de <c>lsmod</c>. Debes revisar las lineas que
    empiecen con la palabra openafs.
  </li>
  <li><c>pgrep afsd</c> te dirá si afsd se está ejecutando o no.</li>
  <li>
    <c>cat /proc/mounts</c> debe revelar si <path>/afs</path> fue
    montado.
  </li>
</ul>

<p>
Si tienes problemas iniciando el servidor, entonces estos consejos
deben ser útiles:
</p>

<ul>
  <li>
    <c>pgrep bosserver</c> te dirá si el supervisor se está ejecutando
    o no. Si tienes más de uno corriendo, entonces algo ha salido
    mal. En ese caso, deberías intentar apagar el servidor OpenAFS
    elegantemente con <c>bos shutdown localhost -localauth -wait</c>,
    revisa el resultado con <c>bos status localhost -localauth</c>,
    elimina los procesos supervisores restantes que sigan ejecutándose
    (<c>ls /usr/libexec/openafs</c> para obtener una lista de ellos).
    Luego de ello, haz un <c>/etc/init.d/openafs-server zap</c> para
    reiniciar el estado del servidor y <c>/etc/init.d/openafs-server
    start</c> para intentar iniciarlo de nuevo.
  </li>
  <li>
    Si estás utilizando el sistema de bitácoras propio de OpenAFS (que
    es cómo se configura por defecto), revisa
    <path>/var/lib/openafs/logs/*</path>.  Si estás utilizando syslog,
    revisa sus propias bitácoras en búsqueda de cualquier información
    útil.
  </li>
</ul>

</body>
</section>
</chapter>


<chapter>
<title>Documentación</title>
<section>
<title>Obteniendo la documentación sobre AFS</title>
<body>

<p>
Puedes obtener la documentación original AFS de IBM. Está muy
bien escrita y si vas a administrador un servidor AFS es lectura
muy recomendada.
</p>

<pre caption="Instalando afsdoc">
# <i>emerge app-doc/afsdoc</i>
</pre>
</body>   
</section>
</chapter>

<chapter>
<title>Instalación del cliente</title>
<section>
<title>Trabajo preliminar</title>
<body>

<note>
¡Todos los comandos deben ser escritos en una sola linea!
En este documento están, algunas veces, divididos en dos
líneas para hacerlos más fáciles de leer.
</note>

<note>
Desafortunadamente el cliente AFS necesita una partición ext2
para que su cache funcione de manera correcta, ya que existen
algunos problemas de bloque con resiserfs.  Necesitas crear
una partición ext2 de aproximadamente 200MB (más no le hace
daño a nadie) y montarla en <path>/usr/vice/cache</path>.
</note>

<p>
Deberás ajustar los dos archivos llamados CellServDB y
ThisCell antes de crear tu cliente afs. (Estos archivos están
en el directorio <path>/usr/portage/net-fs/openafs/files</path>)
</p>

<pre caption="Ajustando CellServDB y ThisCell">
CellServDB:
>netlabs        #Nombre de la celda
10.0.0.1        #almacenamiento

ThisCell:
netlabs       
</pre>

<warn>
Utiliza solamente espacios dentro del archivo
<path>CellServDB</path>. El cliente muy probablemente fallará si
utilizas TABs.
</warn>
 
<p>
CellServDB le indica a tu cliente qué servidor(es) necesita
contactar en una celda específica. ThisCell debe ser bastante
obvio. Normalmente utilizas un nombre que es único en tu
organización. Tu dominio (oficial) debe ser una buena opción.
</p>
</body>
</section>

<section>
<title>Creando al cliente</title>
<body>

<pre caption="Instalando openafs">
# <i>emerge net-fs/openafs</i>
</pre>

<p>
Luego de una compilación exitosa debes estar listo para seguir.
</p>
</body>
</section>

<section>
<title>Iniciando AFS en el arranque</title>
<body>

<p>
El siguiente comando creará los apropiados enlaces para que
se inicie el cliente afs en el arranque del sistema.
</p>

<warn>
Siempre debes tener activo el servidor AFS cuando trates de
iniciar un cliente afs. Tu sistema no arrancará hasta que
llegue a un límite de tiempo si el servidor está fuera de
línea. (y esto es un tiempo muy, muy largo).
</warn>

<pre caption="Agregando AFS al nivel de ejecución default">
# <i>rc-update add afs default</i>
</pre>
</body>
</section>
</chapter>

<chapter>
<title>Instalación del servidor</title>
<section>
<title>Construyendo el servidor</title>
<body>

<p>
El siguiente comando instalará todos los binarios necesarios
para crear un servidor AFS <e>y</e> un cliente.
</p>

<pre caption="Instalando openafs">
# <i>emerge net-fs/openafs</i>
</pre>
</body>
</section>

<section>
<title>Iniciando el servidor AFS</title>    
<body>
<p>
Necesitas remover los archivos de ejemplo CellServDB y
ThisCell previamente.
</p>

<pre caption="Borrando archivos de ejemplos">
# <i>rm /usr/vice/etc/ThisCell</i>
# <i>rm /usr/vice/etc/CellServDB</i>
</pre>

<p>
Ahora ejecutaremos el comando <c>bosserver</c> para
inicializar el Servidor Basic OverSeer (BOS), que monitorea y
controla otros procesos del servidor AFS. Tómalo como si fuera
el init del sistema. Incluye la bandera <c>-noauth</c> para
desactivar la comprobación de autorización, ya que no has
añadido al usuario administrador todavía.
</p>

<warn>
Deshabilitar la comprobación de autenticación compromete
gravemente la seguridad de la celda. Debes completar todos los
siguientes pasos subsecuentemente de manera ininterrumpida y no
debes dejar desatendida la máquina en ningún momento hasta que
reinicies el servidor BOS con la comprobación de autorización
habilitada. Bueno, eso es lo que la documentación sobre AFS dice
:).
</warn>

<pre caption="Inicializando el servidor Basico OverSeer (supervisor básico)">
# <i>/usr/afs/bin/bosserver -noauth &amp;</i>
</pre>

<p>
Verifica que el Servidor BOS
creó <path>/usr/vice/etc/CellServDB</path>
y <path>/usr/vice/etc/ThisCell</path>
</p>

<pre caption="Revise si CellServDB y ThisCell han sido creados">
# <i>ls -al /usr/vice/etc/</i>
-rw-r--r--    1 root     root           41 Jun  4 22:21 CellServDB
-rw-r--r--    1 root     root            7 Jun  4 22:21 ThisCell
</pre>
</body>    
</section>

<section>
<title>Definiendo nombre de celda y membrecía para los procesos del servidor</title>
<body>

<p>
Ahora asígnale un nombre a tu celda.
</p>

<impo>
Hay algunas restricciones en el formato del nombre. Dos de las
más importantes son que el nombre no puede incluir mayúsculas
y tiene que ser menor a 64 caracteres. Recuerda que el nombre
de tu celda estará bajo <path>/afs</path>, así que quizás
desees escoger un nombre corto.
</impo>

<note>
En la siguiente y en las demás instrucciones de esta guía,
sustituye el argumento &lt;server name&gt; por el nombre
calificado completo (como por ejemplo<b> afs.gentoo.org</b>)
de la máquina en la que estás instalando. Por el argumento
&lt;cell name&gt; pon el nombre completo de tu celda
(como <b>gentoo</b>).
</note>

<p>
Ejecuta el comando <c>bos setcellname</c> para definir el nombre de la celda:
</p>

<pre caption="Asignando el nombre de la celda">
# <i>/usr/afs/bin/bos setcellname &lt;server name&gt; &lt;cell name&gt; -noauth</i>
</pre>
</body>
</section>

<section>
<title>Iniciando el proceso de servidor de base de datos</title>
<body>

<p>
Ahora, utiliza el comando <c>bos create</c> para crear
las entradas para los cuatro procesos servidores de base de
datos en el archivo <path>/usr/afs/local/BosConfig</path>. Los
cuatro procesos corren únicamente en las máquinas servidoras
de base de datos.
</p>

<table>
<tr>
   <ti>kaserver</ti>
   <ti>El servidor de autenticación mantiene la base de datos de
   autenticación. Este puede ser reemplazado por un demonio kerberos
   5. Si alguien quiere intentarlo siéntase libre de agregarlo a este
   documento :)</ti> 
</tr>
<tr>
   <ti>buserver</ti>
   <ti>El servidor de respaldo mantiene la base de datos de respaldo</ti>
</tr>
<tr>
   <ti>ptserver</ti>
   <ti>El servidor de protección mantiene la base de datos de protección</ti>
</tr>
<tr>
   <ti>vlserver</ti>
   <ti>El servidor de localización de volumen mantiene la base de
   datos de localización de volumen(VLDB). Muy importante por cierto.</ti>
</tr>
</table>    

<pre caption="Creando los registros para los procesos de bases de datos">
# <i>/usr/afs/bin/bos create &lt;server name&gt; kaserver simple 
    /usr/afs/bin/kaserver -cell &lt;cell name&gt; -noauth</i>
# <i>/usr/afs/bin/bos create &lt;server name&gt; buserver simple 
    /usr/afs/bin/buserver -cell &lt;cell name&gt; -noauth</i>
# <i>/usr/afs/bin/bos create &lt;server name&gt; ptserver simple 
    /usr/afs/bin/ptserver -cell &lt;cell name&gt; -noauth</i>
# <i>/usr/afs/bin/bos create &lt;server name&gt; vlserver simple 
    /usr/afs/bin/vlserver -cell &lt;cell name&gt; -noauth</i>
</pre>

<p>
Puedes comprobar que todos los servidores están funcionando
con el comando <c>bos status</c>:
</p>

<pre caption="Revisar que estén corriendo todos los servidores">
# <i>/usr/afs/bin/bos status &lt;server name&gt; -noauth</i>
Instance kaserver, currently running normally.
Instance buserver, currently running normally.
Instance ptserver, currently running normally.
Instance vlserver, currently running normally.
</pre>
</body>
</section>

<section>
<title>Inicializando la seguridad de la celda</title>
<body>

<p>
Es hora de inicializar los mecanismos de seguridad de la
celda. Empezaremos creando las dos siguientes entradas
iniciales en la base de datos de autenticación: La cuenta
administrativa principal, llamada <b>admin</b> por convención
y una entrada para el proceso del servidor AFS,
llamado <c>afs</c>. Ningún usuario pude ingresar al sistema
bajo la identidad de <b>afs</b>, pero el módulo del Servicio
de Entrega de Tickets (TGS) del Servidor de Autenticación
utiliza esta cuenta para encriptar todos los tickets que
entrega a clientes AFS. Esto suena muy parecido a Kerberos :)
</p>

<p>
Entrando al modo interactivo de <c>kas</c>
</p>

<pre caption="Entrando al modo interactivo">
# <i>/usr/afs/bin/kas -cell &lt;cell name&gt; -noauth</i>
ka&gt; <i>create afs</i>
initial_password:
Verifying, please re-enter initial_password:
ka&gt; <i>create admin</i>
initial_password:
Verifying, please re-enter initial_password:
ka&gt; <i>examine afs</i>

User data for afs
  key (0) cksum is 2651715259, last cpw: Mon Jun  4 20:49:30 2001
  password will never expire.
  An unlimited number of unsuccessful authentications is permitted.
  entry never expires.  Max ticket lifetime 100.00 hours.
  last mod on Mon Jun  4 20:49:30 2001 by $lt;none&gt;
  permit password reuse
ka&gt; <i>setfields admin -flags admin</i>
ka&gt; <i>examine admin</i>
 
User data for admin (ADMIN)
  key (0) cksum is 2651715259, last cpw: Mon Jun  4 20:49:59 2001
  password will never expire.
  An unlimited number of unsuccessful authentications is permitted.
  entry never expires.  Max ticket lifetime 25.00 hours.
  last mod on Mon Jun  4 20:51:10 2001 by $lt;none&gt;
  permit password reuse
ka&gt;
</pre>

<p>
Ejecuta el comando <c>bos adduser</c>, para añadir el
usuario <b>admin</b> a <path>/usr/afs/etc/UserList</path>.
</p>

<pre caption="Agregue al usuario admin al UserList">
# <i>/usr/afs/bin/bos adduser &lt;server name&gt; admin -cell &lt;cell name&gt; -noauth</i>
</pre>

<p>
Utiliza el comando <c>bos addkey</c> para definir la llave de
encriptación del servidor AFS
en <path>/usr/afs/etc/KeyFile</path>
</p>

<note>
Si se te pregunta por una llave de entrada, usa la contraseña
que ingresaste al crear la entrada afs con <b>kas</b>
</note>

<pre caption="Ingresando la contraseña">
# <i>/usr/afs/bin/bos addkey  &lt;server name&gt; -kvno 0 -cell &lt;cell name&gt; -noauth</i>
    input key:
    Retype input key:
</pre>

<p>
Con el comando <c>pts createuser</c> crea una entrada para el
usuario admin en la Base de Datos de Protección
</p>

<note>
Por defecto el servidor de protección asigna AFS UID 1 al
usuario <b>admin</b>, porque es el primer usuario cuya entrada
se crea. Si el archivo de contraseñas local (<path>/etc/passwd</path> o
equivalente) ya tiene una entrada para <b>admin</b> que le
asigna un UID distinto, utiliza el argumento <c>-id</c> para
crear UID que sean iguales.
</note>

<pre caption="Creación del registro en la base de datos de protección
para el usuario">
# <i>/usr/afs/bin/pts createuser -name admin -cell &lt;cell name&gt; [-id &lt;AFS UID&gt;] -noauth</i>
</pre>

<p>
Ejecuta el comando <c>pts adduser</c> para hacer al
usuario <b>admin</b> miembro del grupo system:administrators, y
el comando <c>pts membership</c> para verificar la membresía.
</p>

<pre caption="Hacer a admin miembro del grupo de administradores y verificación">
# <i>/usr/afs/bin/pts adduser admin system:administrators -cell &lt;cell name&gt; -noauth</i>
# <i>/usr/afs/bin/pts membership admin -cell &lt;cell name&gt; -noauth</i>
      Groups admin (id: 1) is a member of:
        system:administrators
</pre>

<p>
Reinicie todos los procesos del servidor AFS
</p>

<pre caption="Reinicie todos los procesos de servidor AFS">
# <i>/usr/afs/bin/bos restart &lt;server name&gt; -all -cell &lt;cell name&gt; -noauth</i>
</pre>
</body>
</section>

<section>
<title>Iniciando el Servidor de Archivos, el Servidor de Volumen y Salvager</title>
<body>

<p>
Inicia el proceso <c>fs</c>, que consiste en el Servidor de
Archivos, el Servidor de Volumen y Salvager (procesos
fileserver, volserver y salvager).
</p>

<pre caption="Inicie el proceso fs">
# <i>/usr/afs/bin/bos create &lt;server name&gt; fs fs /usr/afs/bin/fileserver
 /usr/afs/bin/volserver /usr/afs/bin/salvager -cell &lt;cell name&gt; -noauth</i>
</pre>

<p>
Es hora de verificar que todos los procesos estén en ejecución.
</p>

<pre caption="Verifique que todos los procesos estén corriendo">
 # <i>/usr/afs/bin/bos status &lt;server name&gt; -long -noauth</i>
 Instance kaserver, (type is simple) currently running normally.
     Process last started at Mon Jun  4 21:07:17 2001 (2 proc starts)
     Last exit at Mon Jun  4 21:07:17 2001
     Command 1 is '/usr/afs/bin/kaserver'

 Instance buserver, (type is simple) currently running normally.
     Process last started at Mon Jun  4 21:07:17 2001 (2 proc starts)
     Last exit at Mon Jun  4 21:07:17 2001
     Command 1 is '/usr/afs/bin/buserver'

 Instance ptserver, (type is simple) currently running normally.
     Process last started at Mon Jun  4 21:07:17 2001 (2 proc starts)
     Last exit at Mon Jun  4 21:07:17 2001
     Command 1 is '/usr/afs/bin/ptserver'

 Instance vlserver, (type is simple) currently running normally.
     Process last started at Mon Jun  4 21:07:17 2001 (2 proc starts)
     Last exit at Mon Jun  4 21:07:17 2001
     Command 1 is '/usr/afs/bin/vlserver'

 Instance fs, (type is fs) currently running normally.
     Auxiliary status is: file server running.
     Process last started at Mon Jun  4 21:09:30 2001 (2 proc starts)
     Command 1 is '/usr/afs/bin/fileserver'
     Command 2 is '/usr/afs/bin/volserver'
     Command 3 is '/usr/afs/bin/salvager'
</pre>

<p>
Lo que tienes que hacer ahora depende en si alguna vez has
ejecutado en la celda un servidor de archivos AFS.
</p>

<p>
En caso que estés instalando el primer servidor AFS de la celda,
crea el primer volumen AFS <b>root.afs</b>
</p>

<note>
En el argumento del nombre de la partición, sustituye el nombre
de una de las particiones de la máquina Servidor AFS. Por
convención estas particiones son llamadas <path>/vicepx</path>,
donde x está en el rango a-z.
</note>

<pre caption="Creación del volumen root.afs">
# <i>/usr/afs/bin/vos create &lt;server name&gt; &lt;partition name&gt; root.afs -cell &lt;cell name&gt; -noauth</i>
</pre>

<p>
Si hay máquinas servidoras de archivos AFS y volúmenes ya
creados en la celda, utiliza los comandos <c>vos sncvldb</c>
y <c>vos syncserv</c> para sincronizar el VLDB (Base de Datos de
Localización de Volumen) con el estado actual de la localización
de los volúmenes. Esto copiará toda la información necesaria a
tu nuevo servidor.
</p>

<p>
Si el comando falla con el mensaje "partition /vicepa does not
exist on the server", asegúrate que la partición está montada
antes de levantar los servidores OpenAFS, o monta el directorio
y reinicia los procesos utilizando<c>/usr/afs/bin/bos restart
&lt;server name&gt; -all -cell &lt;cell name&gt; -noauth</c>.
</p>

<pre caption="Sincronice el VLDB">
# <i>/usr/afs/bin/vos syncvldb &lt;server name&gt; -cell &lt;cell name&gt; -verbose -noauth</i>
# <i>/usr/afs/bin/vos syncserv &lt;server name&gt; -cell &lt;cell name&gt; -verbose -noauth</i> 
</pre>
</body>
</section>

<section>
<title>Iniciando la parte servidor del servidor de actualizaciones</title>
<body>

<pre caption="Inicie el servidor de actualización">
# <i>/usr/afs/bin/bos create &lt;server name&gt; upserver simple "/usr/afs/bin/upserver -crypt /usr/afs/etc -clear /usr/afs/bin" -cell &lt;cell name&gt; -noauth</i>
</pre>
</body>
</section>

<section>
<title>Configurando el Nivel Superior del espacio de archivos AFS</title>
<body>

<p>
Primero necesitas definir algunos ACLs, de manera que
cualquier usuario pueda ve <path>/afs</path>.
</p>

<pre caption="Configure las listas de control de acceso">
# <i>/usr/afs/bin/fs setacl /afs system:anyuser rl</i>
</pre>

<p>
Ahora necesitas crear el volumen raíz, montarlo como de sólo
lectura en <path>/afs/&lt;cell name&gt;</path> y
lectura-escritura en <path>/afs/.&lt;cell name&gt;</path>.
</p>

<pre caption="Prepare el volumen raíz">
# <i>/usr/afs/bin/vos create &lt;server name&gt;&lt;partition name&gt; root.cell</i>
# <i>/usr/afs/bin/fs mkmount /afs/&lt;cell name&gt; root.cell </i>
# <i>/usr/afs/bin/fs setacl /afs/&lt;cell name&gt; system:anyuser rl</i>
# <i>/usr/afs/bin/fs mkmount /afs/.&lt;cell name&gt; root.cell -rw</i>
</pre>

<p>
Finalmente, ¡terminaste!. Ahora debes tener un servidor de
archivos AFS funcionando en tu red local. ¡¡Es hora de tomar una
gran taza de café e imprimir la documentación sobre AFS!!
</p>

<note>
Es muy importante para el correcto funcionamiento de servidor
AFS que todos los relojes de todos los sistemas estén
sincronizados. Esto lo puedes conseguir instalando un servidor
ntp en una máquina (por ejemplo el servidor AFS) y sincronizar
los relojes como clientes ntp. Esto también puede ser echo por
el cliente AFS.
</note>
</body>
</section>
</chapter>

<chapter>
<title>Administración básica</title>
<section>
<title>Renuncia de responsabilidad</title>
<body>

<p>
OpenAFS es una tecnología extensa. Por favor lee la documentación de
AFS para mayor información. Nosotros sólo listamos una pequeña lista
de tareas administrativas en este capítulo.
</p>
</body>
</section>

<section>
<title>Configurando PAM para obtener una ficha AFS al ingresar</title>
<body>

<p>
Para poder utilizar AFS necesitas autenticarte con el servidor KA si
utilizas una implementación AFS Kerberos 4, o con un servidor Kerberos
5 KDC si utilizas MIT, Heimdal o ShiShi Kerberos 5. Sin embargo, para
poder ingresar a una máquina también necesitaras una cuenta de
usuario, que puede ser local mediante <path>/etc/passwd</path>, NIS, LDAP
(OpenLDAP), o una base de datos Hesiod. PAM permite a Gentoo atar la
autenticación de ingreso al sistema y de AFS a la cuenta del usuario.
</p>

<p>
Necesitarás actualizar <path>/etc/pam.d/system-auth</path> que es
utilizado por las demás configuraciones. "use_first_pass" indica que
primero se revisará el ingreso al sistema, e "ignore_root" evita que
el usuario root sea autenticado de manera que pueda ingresar al
sistema si el AFS o la red falla.
</p>

<pre caption="/etc/pam.d/system-auth">
auth       required     pam_env.so
auth       sufficient   pam_unix.so likeauth nullok
auth       sufficient   pam_afs.so.1 use_first_pass ignore_root
auth       required     pam_deny.so

account    required     pam_unix.so

password   required     pam_cracklib.so retry=3
password   sufficient   pam_unix.so nullok md5 shadow use_authtok
password   required     pam_deny.so

session    required     pam_limits.so
session    required     pam_unix.so
</pre>

<p>
Para hacer que <c>sudo</c> mantenga la ficha del usuario real y prevenir a los
usuarios locales ganar acceso AFS cambia /etc/pam.d/su de la siguiente
manera:
</p>

<pre caption="/etc/pam.d/su">
<comment># Aquí usuarios con uid &gt; 100 se consideran miembros del AFS y usuarios con 
# uid &lt;= 100 son ignorados por pam_afs.</comment>
auth       sufficient   /usr/afsws/lib/pam_afs.so.1 ignore_uid 100

auth       sufficient   /lib/security/pam_rootok.so

<comment># Si quieres restringir más a los usuarios de utilizar el comando su, crea el archivo,
# /etc/security/suauth.allow que es solo con permisos de escritura por el superusuario
# y añade a los usuarios que se les permite hacer "su" a ese archivo, uno por línea
#auth       required     /lib/security/pam_listfile.so item=ruser \
#       sense=allow onerr=fail file=/etc/security/suauth.allow

# Descomenta esta linea para permitir que los usuarios del grupo 
# wheel puedan hacer "su" sin utilizar passwd.
#auth       sufficient   /lib/security/pam_wheel.so use_uid trust

# Alternativamente a lo anterior, puedes implementar una lista de usuarios 
# que no necesitan dar una contraseña con una lista.
#auth       sufficient   /lib/security/pam_listfile.so item=ruser \
#       sense=allow onerr=fail file=/etc/security/suauth.nopass

# Comenta las siguiente lineas para permitir a cualquier usuario, incluso a
# aquellos fuera del grupo 'wheel', poder hacer "su"</comment>
auth       required     /lib/security/pam_wheel.so use_uid

auth       required     /lib/security/pam_stack.so service=system-auth

account    required     /lib/security/pam_stack.so service=system-auth

password   required     /lib/security/pam_stack.so service=system-auth

session    required     /lib/security/pam_stack.so service=system-auth
session    optional     /lib/security/pam_xauth.so

<comment># Aquí prevenimos que la ficha del id real del usuario sea dejada atrás</comment>
session    optional     /usr/afsws/lib/pam_afs.so.1 no_unlog
</pre>
</body>
</section>
</chapter>
</guide>

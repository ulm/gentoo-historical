<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/gentoo-x86+raid+lvm2-quickinstall.xml,v 1.1 2006/10/05 14:31:38 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fr/gentoo-x86+raid+lvm2-quickinstall.xml" lang="fr">

<title>Guide d'installation rapide de Gentoo Linux x86 avec raid logiciel et LVM2</title>

<author title="Auteur">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Auteur">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Auteur">
  Steven Wagner
</author>
<author title="Traducteur">
  <mail link="pongten@gmail.com">Rémy Mainil</mail>
</author>

<abstract>
Le guide d'installation rapide présente le processus d'installation de Gentoo
Linux de façon concise. Son objectif est de permettre aux utilisateurs
d'effectuer une installation stage3 avec Raid logiciel et LVM2 en un rien de
temps. Une expérience préalable avec l'installation de Gentoo est vivement
recommandée pour suivre ce guide.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>3</version>
<date>2006-09-04</date>

<chapter>
<title>Introduction</title>
<section>
<body>

<p>
Ce guide contient toutes les commandes nécessaires à une installation d'un
stage3 de Gentoo avec LVM2 et Raid logiciel. Ce guide s'adresse à des
utilisateurs expérimentés. Vous avez besoin d'une connexion à Internet pour
télécharger le stage3 et l'instantané de Portage.
</p>

<p>
Les commandes nécessitant plus de quelques secondes pour être réalisées sont
suivies du temps nécessaire à leur exécution. Ces commandes ont été
chronométrées sur un AMD 2000 1.66Ghz avec 512 Mo de RAM et deux disques SATA
connectés à un contrôleur matériel configuré comme JBOD (c'est-à-dire que deux
disques durs séparés sont vus par Gentoo). Si vous disposez d'un contrôleur
«&nbsp;matériel&nbsp;» sur votre carte-mère, ce n'est probablement <b>pas</b>
un contrôleur matériel.
</p>

<pre caption="Caractéristiques de la machine de test">
<comment>(Les caractéristiques suivantes et les informations de chronométrage devraient
vous aider à estimer le temps nécessaire pour terminer votre installation)</comment>

# <i>grep bogo /proc/cpuinfo</i>
 bogomips       : 3337.81

# <i>hdparm -tT /dev/sda /dev/sdb</i>
/dev/sda:
 Timing cached reads:   1048 MB in  2.00 seconds = 524.00 MB/sec
 Timing buffered disk reads:  152 MB in  3.01 seconds =  50.50 MB/sec

/dev/sdb:
 Timing cached reads:   1048 MB in  2.00 seconds = 524.00 MB/sec
 Timing buffered disk reads:  152 MB in  3.01 seconds =  50.50 MB/sec

# <i>grep MemTotal /proc/meminfo</i>
 MemTotal:       509248 kB
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Guide d'installation rapide</title>
<section>
<title>Média pour l'installation</title>
<body>

<p>
Téléchargez un CD à partir de l'un de nos <uri
link="/main/en/mirrors.xml">miroirs</uri>. Vous trouverez l'image ISO du CD
d'installation <e>minimal</e> dans
<path>releases/x86/&lt;release&gt;/installcd</path> ou l'image ISO du
<e>LiveCD</e> dans <path>releases/x86/&lt;release&gt;/livecd</path>. Le CD
d'installation <e>minimal</e> ne sert que pour l'installation par le biais
d'Internet. Vous pouvez utiliser le <e>LiveCD</e> pour effectuer une
installation sans réseau, comme cela est décrit dans <uri
link="/doc/fr/handbook/2006.1/handbook-x86.xml">Le manuel Gentoo Linux/x86
2006.1</uri>. Le CD d'installation <e>minimal</e> est recommandé.
</p>

<p>
<uri link="/doc/fr/faq.xml#isoburning">Gravez</uri> puis amorcez le CD.
</p>

</body>
</section>
<section>
<title>Amorçage du CD</title>
<body>

<p>
Appuyez sur <c>F2</c>lorsque s'affiche l'écran de démarrage afin de voir
quelles sont les options de démarrage disponibles. Vous pouvez soit démarrer
<c>gentoo</c> soit <c>gentoo-nofb</c>, ce dernier désactive le framebuffer. Si
vous avez démarré depuis le <e>LiveCD</e>, n'oubliez pas d'ajouter l'option
<c>nox</c> pour empêcher l'environnement graphique X de démarrer. De nombreuses
options activent ou désactivent différentes fonctionnalités. Si tout se passe
bien, votre matériel sera détecté et tous les modules seront chargés. Si le
noyau ne parvient pas à démarrer proprement ou si votre ordinateur plante
durant la procédure de démarrage, vous devrez peut-être tester différentes
configurations. La plus sûre façon de procéder est probablement d'utiliser
l'option <c>nodetect</c> et ensuite de charger manuellement les modules
requis.
</p>

<pre caption="Démarrer avec le CD d'installation minimal">
Gentoo Linux Installation LiveCD                     http://www.gentoo.org
Enter to Boot; F1 for kernels  F2 for options.
boot: <i>gentoo-nofb</i>
<comment>(ou en cas de problème)</comment>
boot: <i>gentoo-nofb nodetect</i>
</pre>

</body>
</section>

<section>
<title>Facultatif&nbsp;: chargement de modules</title>
<body>

<p>
Si vous utilisez l'option <c>nodetect</c>, une fois démarré, chargez les
modules nécessaires. Vous devez activer une connexion réseau et avoir accès à
vos disques. La commande <c>lspci</c> peut vous aider à identifier votre
matériel.
</p>

<pre caption="Charger les modules nécessaires">
livecd root # <i>lspci</i>
<comment>(Utilisez la sortie de la commande lspci pour identifier les modules nécessaires)</comment>

<comment>(Ceci est un exemple, adaptez-le à votre matériel)</comment>
livecd root # <i>modprobe 3w-9xxx</i>
livecd root # <i>modprobe r8169</i>
</pre>

</body>
</section>
<section>
<title>Configuration du réseau</title>
<body>

<p>
Si votre réseau ne fonctionne pas déjà, vous pouvez utiliser <c>net-setup</c>
pour le configurer. Vous devrez peut-être utiliser <c>modprobe</c> pour charger
le support pour votre carte réseau avant de procéder à la configuration. Si
vous avez une connexion ADSL, utilisez <c>pppoe-setup</c> et
<c>pppoe-start</c>. Si vous utilisez un routeur ADSL, il établit la connexion
pour vous et vous n'avez pas besoin d'exécuter ces scripts. Pour le support
PPTP, éditez d'abord <path>/etc/ppp/chap-secrets</path> et
<path>/etc/ppp/options.pptp</path>, puis exécutez <c>pptp
&lt;server&nbsp;ip&gt;</c>.
</p>

<p>
Pour l'accès par réseau sans fil, utilisez <c>iwconfig</c> pour régler les
paramètres du sans fil, puis lancez <c>net-setup</c> à nouveau ou alors
exécutez manuellement <c>ifconfig</c>, <c>dhcpcd</c> et/ou <c>route</c>.
</p>

<p>
Si vous êtes situé derrière un serveur mandataire («&nbsp;proxy&nbsp;»),
n'oubliez pas de préparer votre système avec <c>export http_proxy</c>,
<c>ftp_proxy</c> et <c>RSYNC_PROXY</c>.
</p>

<pre caption="Guide pour configurer le réseau">
livecd root # <i>net-setup eth0</i>
</pre>

<p>
Alternativement, vous pouvez démarrer la connexion réseau manuellement.
L'exemple suivant attribue l'adresse IP 192.168.1.10 à votre PC et définit
192.168.1.1 comme votre routeur et serveur de noms.
</p>

<pre caption="Configurer manuellement une connexion réseau">
livecd root # <i>ifconfig eth0 192.168.1.10/24</i>
livecd root # <i>route add default gw 192.168.1.1</i>
livecd root # <i>echo nameserver 192.168.1.1 &gt; /etc/resolv.conf</i>
</pre>

<p>
Le CD d'installation vour permet de démarrer un serveur <c>sshd</c>, d'ajouter
des utilisateurs supplémentaires, d'exécuter <c>irssi</c> (un logiciel de chat
en ligne de commande) ainsi que de naviguer sur le web avec <c>lynx</c> ou
<c>links</c>.
</p>

</body>
</section>
<section>
<title>Facultatif&nbsp;: vous connecter à votre nouveau PC avec ssh</title>
<body>

<p>
Le dispositif le plus intéressant est évidemment <c>sshd</c>. Vous pouvez le
démarrer et vous y connecter depuis une autre machine et ainsi faire un
copier-coller des commandes depuis ce guide.
</p>

<pre caption="Démarrer sshd">
livecd root # <i>time /etc/init.d/sshd start</i>
 * Generating hostkey ...
<comment>(sshd génère une clé et affiche différentes informations)</comment>
 * starting sshd ...                            [ok]

 real   0m13.688s
 user   0m9.420s
 sys    0m0.090s
</pre>

<p>
Maintenant, initialisez le mot de passe root sur le liveCD de façon à pouvoir
vous y connecter depuis un autre PC. Notez qu'autoriser root à se connecter via
ssh n'est pas recommandé en temps normal. Si vous n'avez pas confiance en votre
réseau local, utilisez un mot de passe long et complexe, vous ne devriez
l'utiliser qu'une seule fois, car il disparaîtra après votre premier
redémarrage.
</p>

<pre caption="Initialiser le mot de passe root">
livecd root # <i>passwd</i>
New UNIX password: <comment>saisissez un mot de passe</comment>
Retype new UNIX password: <comment>saississez à nouveau le mot de passe</comment>
passwd: password updated successfully
</pre>

<p>
Maintenant, vous pouvez démarrer un terminal depuis un autre PC et vous connecter
à votre nouveau PC et ainsi suivre le reste de ce guide dans une autre fenêtre
et faire des copier/coller des commandes.
</p>

<pre caption="Vous connecter à votre nouveau PC depuis un autre PC">
<comment>(Utilisez l'adresse IP de votre nouveau PC)</comment>
$ <i>ssh root@192.168.1.10</i>
The authenticity of host '192.168.1.10 (192.168.1.10)' can't be established.
RSA key fingerprint is 96:e7:2d:12:ac:9c:b0:94:90:9f:40:89:b0:45:26:8f.
Are you sure you want to continue connecting (yes/no)? <i>yes</i>
Warning: Permanently added '192.168.1.10' (RSA) to the list of known hosts.
Password: <comment>Saississez le mot de passe</comment>
</pre>

</body>
</section>
<section>
<title>Préparer les disques</title>
<body>

<p>
Chargez les modules pour le RAID logiciel et LVM2.
</p>

<pre caption="Charger les modules pour le RAID logiciel et LVM2">
livecd ~ # <i>modprobe raid0</i>
livecd ~ # <i>modprobe raid1</i>
<comment>(raid5, raid6 et raid10 sont également disponibles)</comment>

livecd ~ # <i>modprobe dm-mod</i>
</pre>

<p>
Utilisez <c>fdisk</c> ou <c>cfdisk</c> pour créer vos partitions. Les noms des
périphériques sont généralement <path>/dev/sda</path> et <path>/dev/sdb</path>
pour des disques SATA ou SCSI, ou <path>/dev/hda</path> et
<path>/dev/hdb</path> pour des disques IDE. Le schéma suivant est utilisé dans
ce guide&nbsp;:
</p>

<table>
  <tr>
    <ti/>
    <th><path>/dev/sda</path></th>
    <th><path>/dev/sdb</path></th>
    <th>Type</th>
  </tr>
  <tr>
    <th><path>/dev/md1</path></th>
    <th><path>/boot</path></th>
    <th><path>/boot</path></th>
    <ti>Raid-1 (mirroring)</ti>
  </tr>
  <tr>
    <th/>
    <th>swap</th>
    <th>swap</th>
    <ti>Partitions normales</ti>
  </tr>
  <tr>
    <th><path>/dev/md3</path></th>
    <th><path>/</path></th>
    <th><path>/</path></th>
    <ti>Raid-1 (mirroring)</ti>
  </tr>
  <tr>
    <th><path>/dev/md4</path></th>
    <th colspan="2">LVM2 volumes</th>
    <ti>Raid-0 (striped)</ti>
  </tr>
</table>

<note>
La partition depuis laquelle vous démarrez ne peut pas être du type striped.
Elle ne peut être de type raid-5 ou raid-0.
</note>

<note>
D'une part, si vous souhaitez plus de stabilité, préférez l'utilisation du mode
raid-1 (ou même raid-5) pour vos partitions d'échange de façon à ce qu'un
plantage du disque ne corrompe pas votre espace d'échange évitant ainsi de
planter les applications qui l'utilisent. D'autre part, si vous voulez plus de
performances, laissez simplement le noyau utiliser des partitions d'échange
séparées comme il le fait par défaut en mode striping.
</note>


<pre caption="Créer les partitions">
livecd ~ # <i>fdisk /dev/sda</i>
<comment>(Vérifiez que vous utilisez le type fd)</comment>

<comment>(Le schéma de partitions suivant est utilisé pour le restant de ce guide)</comment>
livecd ~ # <i>fdisk -l /dev/sda</i>

Disk /dev/sda: 299.9 GB, 299989204992 bytes
255 heads, 63 sectors/track, 36471 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1               1          11       88326   fd  Linux raid autodetect
/dev/sda2              12          61      401625   82  Linux swap / Solaris
/dev/sda3              62         311     2008125   fd  Linux raid autodetect
/dev/sda4             312       36471   290455200   fd  Linux raid autodetect

<comment>(Partitionnez le second disque comme le premier)</comment>
livecd ~ # <i>fdisk /dev/sdb</i>
</pre>

<p>
Ensuite, créez les les nœuds des périphériques et les périphériques RAID:
</p>

<pre caption="Créer les noeuds des périphériques et les périphériques">
livecd ~ # <i>mknod /dev/md1 b 9 1</i>
livecd ~ # <i>mknod /dev/md3 b 9 3</i>
livecd ~ # <i>mknod /dev/md4 b 9 4</i>

livecd ~ # <i>mdadm --create /dev/md1 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</i>
mdadm: array /dev/md1 started.
livecd ~ # <i>mdadm --create /dev/md3 --level=1 --raid-devices=2 /dev/sda3 /dev/sdb3</i>
mdadm: array /dev/md3 started.
livecd ~ # <i>mdadm --create /dev/md4 --level=0 --raid-devices=2 /dev/sda4 /dev/sdb4</i>
mdadm: array /dev/md4 started.

<comment>(Attendez que toutes les unités soient prêtes)</comment>
livecd ~ # <i>cat /proc/mdstat</i>
Personalities : [raid0] [raid1]
md4 : active raid0 sdb4[1] sda4[0]
581006592 blocks 64k chunks

md3 : active raid1 sdb3[1] sda3[0]
1959808 blocks [2/2] [UU]

md1 : active raid1 sdb1[1] sda1[0]
88256 blocks [2/2] [UU]
</pre>

<p>
Ensuite, créez les volumes LVM2 dans <path>/dev/md4</path>. Le schéma suivant
est utilisé comme <b>exemple</b>:
</p>

<table>
<tr>
  <th>Répertoire</th>
  <th>Taille</th>
  <th>Système de fichiers</th>
</tr>
<tr>
  <ti>/usr</ti>
  <ti>8 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/usr/portage</ti>
  <ti>2 GB</ti>
  <ti>ext2, petits blocs, beaucoup d'inodes</ti>
</tr>
<tr>
  <ti>/usr/portage/distfiles</ti>
  <ti>4 GB</ti>
  <ti>ext2, gros blocs, moins d'inodes</ti>
</tr>
<tr>
  <ti>/home</ti>
  <ti>10 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/opt</ti>
  <ti>4 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/var</ti>
  <ti>4 GB</ti>
  <ti>ext3</ti>
</tr>
<tr>
  <ti>/var/tmp</ti>
  <ti>6 GB</ti>
  <ti>ext2</ti>
</tr>
<tr>
  <ti>/tmp</ti>
  <ti>2 GB</ti>
  <ti>ext2</ti>
</tr>
</table>

<pre caption="Créer les volumes LVM2">
livecd ~ # <i>vgscan</i>
  Reading all physical volumes.  This may take a while...
  No volume groups found
livecd ~ # <i>vgchange -a y</i>
  No volume groups found

<comment>(Créez les volumes physiques, nous n'en avons qu'un dans notre exemple)</comment>
livecd ~ # <i>pvcreate /dev/md4</i>
  Physical volume "/dev/md4" successfully created

<comment>(Créez les groupes de volumes, à nouveau nous n'en avons qu'un dans notre exemple)</comment>
livecd ~ # <i>vgcreate vg /dev/md4</i>
Volume group "vg" successfully created

<comment>(Créez les volumes logiques)</comment>
livecd ~ # <i>lvcreate -L8G -nusr vg</i>
  /dev/cdrom: open failed: Read-only file system
  Logical volume "usr" created <comment>(D'autres messages similaires ne sont plus repris)</comment>
livecd ~ # <i>lvcreate -L2G -nportage vg</i>
livecd ~ # <i>lvcreate -L4G -ndistfiles vg</i>
livecd ~ # <i>lvcreate -L10G -nhome vg</i>
livecd ~ # <i>lvcreate -L4G -nopt vg</i>
livecd ~ # <i>lvcreate -L4G -nvar vg</i>
livecd ~ # <i>lvcreate -L6G -nvartmp vg</i>
livecd ~ # <i>lvcreate -L2G -ntmp vg</i>

<comment>(Afficher les groupes de volumes et le volumes logiques)</comment>
livecd ~ # <i>vgs</i>
  VG   #PV #LV #SN Attr  VSize   VFree
  vg     1   8   0 wz--n 554.09G 514.09G
livecd ~ # <i>lvs</i>
  LV        VG   Attr   LSize  Origin Snap%  Move Copy%
  distfiles vg   -wi-a-  4.00G
  home      vg   -wi-a- 10.00G
  opt       vg   -wi-a-  4.00G
  portage   vg   -wi-a-  2.00G
  tmp       vg   -wi-a-  2.00G
  usr       vg   -wi-a-  8.00G
  var       vg   -wi-a-  4.00G
  vartmp    vg   -wi-a-  6.00G
</pre>

<p>
Utilisez <c>mke2fs</c>, <c>mke2fs -j</c>, <c>mkreiserfs</c>, <c>mkfs.xfs</c> et
<c>mkfs.jfs</c> pour créer les systèmes de fichiers. Initialisez votre
partition de mémoire virtuelle avec <c>mkswap</c> et <c>swapon</c>.
</p>

<pre caption="Créer le système de fichiers et activer la mémoire virtuelle">
<comment>(Le système de fichiers ext2 est suffisant pour la partition /boot)</comment>
livecd ~ # <i>mke2fs /dev/md1</i>

<comment>(Utilisons le système de fichiers ext3 sur la partition racine)</comment>
livecd ~ # <i>mke2fs -j /dev/md3</i>

<comment>(Créez les systèmes de fichiers sur les volumes logiques)</comment>
livecd ~ # <i>mke2fs -b 4096 -T largefile /dev/vg/distfiles</i>
livecd ~ # <i>mke2fs -j /dev/vg/home</i>
livecd ~ # <i>mke2fs -j /dev/vg/opt</i>
livecd ~ # <i>mke2fs -b 1024 -N 200000 /dev/vg/portage</i>
livecd ~ # <i>mke2fs /dev/vg/tmp</i>
livecd ~ # <i>mke2fs -j /dev/vg/usr</i>
livecd ~ # <i>mke2fs -j /dev/vg/var</i>
livecd ~ # <i>mke2fs /dev/vg/vartmp</i>

<comment>(Créez et activez la mémoire virtuelle)</comment>
livecd ~ # <i>mkswap /dev/sda2 &amp;&amp; mkswap /dev/sdb2</i>
livecd ~ # <i>swapon -p 1 /dev/sda2 &amp;&amp; swapon -p 1 /dev/sdb2</i>
<comment>(Vérifiez que toutes les partitions d'échange utilisent les mêmes priorités)</comment>
livecd ~ # <i>swapon -v -s</i>
Filename                   Type            Size    Used    Priority
/dev/sda2                  partition       401616  0       1
/dev/sdb2                  partition       401616  0       1
</pre>

<p>
Montez les systèmes de fichiers fraîchement créés sur <path>/mnt/gentoo</path>.
Créez les répertoires pour les autres points de montage et montez-les.
</p>

<pre caption="Monter le système de fichiers">
livecd ~ # <i>mount /dev/md3 /mnt/gentoo</i>
livecd ~ # <i>cd /mnt/gentoo</i>
livecd gentoo # <i>mkdir boot home usr opt var tmp</i>
livecd gentoo # <i>mount /dev/md1 /mnt/gentoo/boot</i>
livecd gentoo # <i>mount /dev/vg/usr /mnt/gentoo/usr</i>
livecd gentoo # <i>mount /dev/vg/home /mnt/gentoo/home</i>
livecd gentoo # <i>mount /dev/vg/opt /mnt/gentoo/opt</i>
livecd gentoo # <i>mount /dev/vg/tmp /mnt/gentoo/tmp</i>
livecd gentoo # <i>mount /dev/vg/var /mnt/gentoo/var</i>
livecd gentoo # <i>mkdir usr/portage var/tmp</i>
livecd gentoo # <i>mount /dev/vg/vartmp /mnt/gentoo/var/tmp</i>
livecd gentoo # <i>mount /dev/vg/portage /mnt/gentoo/usr/portage</i>
livecd gentoo # <i>mkdir usr/portage/distfiles</i>
livecd gentoo # <i>mount /dev/vg/distfiles /mnt/gentoo/usr/portage/distfiles</i>

<comment>(Configurez les bonnes permissions pour les répertoires /tmp)</comment>
livecd gentoo # <i>chmod 1777 /mnt/gentoo/tmp /mnt/gentoo/var/tmp</i>
</pre>

</body>
</section>
<section>
<title>Préparer le stage</title>
<body>

<p>
D'abord, assurez-vous que la date de votre système est correcte en utilisant
<c>date MMJJhhmmAAAA</c>. Utilisez le temps UTC.
</p>

<pre caption="Préciser la date et l'heure UTC">
<comment>(Vérifiez l'horloge)</comment>
livecd gentoo # <i>date</i>
Mon Mar  6 00:14:13 UTC 2006

<comment>(Préciser la date et l'heure actuelle, si nécessaire)</comment>
livecd gentoo # <i>date 030600162006</i> <comment>(Format : MMJJhhmmAAAA)</comment>
Mon Mar  6 00:16:00 UTC 2006
</pre>

<p>
Ensuite, téléchargez une archive «&nbsp;stage&nbsp;» à
partir d'un de nos <uri link="/main/en/mirrors.xml">miroirs</uri>. Allez dans
<path>/mnt/gentoo</path> et désarchivez le stage avec la commande
<c>tar&nbsp;xvjpf&nbsp;&lt;archive&nbsp;tar&gt;</c>.
</p>

<pre caption="Télécharger une archive «&nbsp;stage3&nbsp;»">
livecd ~ # <i>cd /mnt/gentoo</i>
livecd gentoo # <i>links http://www.gentoo.org/main/en/mirrors.xml</i>
<comment>(Choisissez un miroir, allez dans le répertoire releases/x86/current/stages,
sélectionnez le stage3 de votre choix, probablement stage3-i686-2006.1.tar.bz2
et appuyez sur D pour le télécharger)</comment>

<comment>(<b>Ou</b> télécharger le directement avec wget sans choisir un miroir proche)</comment>
livecd ~ # <i>cd /mnt/gentoo</i>
livecd gentoo # <i>wget http://gentoo.osuosl.org/releases/x86/current/stages/stage3-i686-2006.1.tar.bz2</i>
</pre>

<pre caption="Désarchiver l'archive «&nbsp;stage3&nbsp;»">
livecd gentoo # <i>time tar xjpf stage3*</i>

real  1m14.157s
user  1m2.920s
sys   0m7.530s
</pre>

<p>
Installez le dernier instantané de Portage.  Pour ce faire, procédez comme pour
l'archive «&nbsp;stage3&nbsp;»&nbsp;: choississez un miroir proche depuis notre
<uri link="/main/en/mirrors.xml">liste</uri>, téléchargez l'instantané le plus
récent et désarchivez-le.
</p>

<pre caption="Télécharger l'instantané Portage le plus récent">
livecd gentoo # <i>cd /mnt/gentoo/usr</i>
livecd usr # <i>links http://www.gentoo.org/main/en/mirrors.xml</i>
<comment>(Choisissez un miroir, allez dans le répertoire snapshots/, sélectionnez
<b>portage-latest.tar.bz2</b> et appuyez sur D pour le télécharger)</comment>

<comment>(<b>Ou</b> téléchargez le directement avec wget sans choisir un miroir proche)</comment>
livecd gentoo # <i>cd /mnt/gentoo/usr</i>
livecd usr # <i>wget http://gentoo.osuosl.org/snapshots/portage-latest.tar.bz2</i>
</pre>

<pre caption="Désarchiver l'instantané Portage">
livecd usr # <i>time tar xjf portage-lat*</i>

real  0m40.523s
user  0m28.280s
sys   0m8.240s
</pre>

</body>
</section>
<section>
<title>Exécution du chroot</title>
<body>

<p>
Montez le système de fichiers <path>/proc</path>, copiez et remplacez le
fichier <path>/etc/resolv.conf</path>, puis utilisez <c>chroot</c> pour entrer
dans votre environnement Gentoo.
</p>

<pre caption="Exécution de chroot">
livecd usr # <i>cd /</i>
livecd / # <i>mount -t proc none /mnt/gentoo/proc</i>
livecd / # <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/</i>
livecd / # <i>chroot /mnt/gentoo /bin/bash</i>
livecd / # <i>env-update</i> &amp;&amp; <i>source /etc/profile</i>
>>> Regenerating /etc/ld.so.cache...
</pre>

</body>
</section>

<section>
<title>Configuration de votre fuseau horaire</title>
<body>

<p>
Choisissez votre fuseau horaire en copiant le fichier approprié de
<path>/usr/share/zoneinfo</path> vers <path>/etc/localtime</path>.
</p>

<pre caption="Copier le fichier pour votre fuseau horaire">
<comment>(Utilisation de Brussels comme exemple)</comment>
livecd / # <i>cp /usr/share/zoneinfo/Europe/Brussels /etc/localtime</i>
livecd / # <i>date</i>
Wed Mar  8 00:46:05 CET 2006
</pre>

</body>
</section>
<section>
<title>Configurer votre nom d'hôte et votre nom de domaine</title>
<body>

<p>
Configurer votre nom de domaine dans <path>/etc/conf.d/hostname</path> et dans
<path>/etc/hosts</path>. Dans l'exemple suivant, nous utilisons <c>mybox</c>
comme nom d'hôte et <c>at.myplace</c> comme nom de domaine. Vous pouvez soit
éditer les fichiers de configuration avec <c>nano</c> ou utiliser les
commandes suivantes&nbsp;:
</p>

<pre caption="Configuration du nom d'hôte et du nom de domaine">
livecd / # <i>cd /etc</i>
livecd etc # <i>echo "127.0.0.1 mybox.at.myplace mybox localhost" > hosts</i>
livecd etc # <i>sed -i -e 's/HOSTNAME.*/HOSTNAME="mybox"/' conf.d/hostname</i>
<comment>(Utilisez le nom d'hôte défini précédemment et testez)</comment>
livecd etc # <i>hostname mybox</i>
livecd etc # <i>hostname -f</i>
mybox.at.myplace
</pre>

</body>
</section>
<section>
<title>Configuration du noyau</title>
<body>

<p>
Installez les sources d'un noyau de votre choix (habituellement
<c>gentoo-sources</c> ou <c>vanilla-sources</c>), configurez-le, compilez-le
puis copiez le fichier <path>arch/i386/boot/bzImage</path> dans
<path>/boot</path>.
</p>

<pre caption="Installer les sources d'un noyau, le compiler et l'installer">
livecd etc # <i>time emerge gentoo-sources</i>

real  3m3.110s
user  1m2.320s
sys   0m34.990s
livecd etc # <i>cd /usr/src/linux</i>
livecd linux # <i>make menuconfig</i>

<comment>(Configurez votre kernel comme d'habitude et assurez-vous que les modules raid
et lvm dont vous avez besoins sont intégrés, c-à-d qu'ils ne sont <b>pas</b>
construits commes modules.  Même recommandation pour les pilotes des disques et
pour les systèmes de fichiers.)</comment>
Multi-device support (RAID and LVM)  --->
[*] Multiple devices driver support (RAID and LVM)
  &lt;*&gt;   RAID support
  &lt; &gt;     Linear (append) mode (NEW)
  &lt;*&gt;     RAID-0 (striping) mode
  &lt;*&gt;     RAID-1 (mirroring) mode
  &lt; &gt;     RAID-10 (mirrored striping) mode (EXPERIMENTAL) (NEW)
  &lt; &gt;     RAID-4/RAID-5 mode (NEW)
  &lt; &gt;     RAID-6 mode (NEW)
  &lt; &gt;     Multipath I/O support (NEW)
  &lt; &gt;     Faulty test module for MD (NEW)
  &lt;*&gt;   Device mapper support
  &lt; &gt;     Crypt target support (NEW)
  &lt; &gt;     Snapshot target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Mirror target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Zero target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Multipath target (EXPERIMENTAL) (NEW)
  &lt; &gt;     Bad Block Relocation Device Target (EXPERIMENTAL) (NEW)

livecd linux # <i>time make -j2</i>

<comment>(Le temps nécessaire varie fortement en fonction des options choisies)</comment>
real  5m5.869s
user  4m32.320s
sys   0m32.930s

livecd linux # <i>make modules_install</i>
livecd linux # <i>cp arch/i386/boot/bzImage /boot/kernel</i>
</pre>

</body>
</section>
<section>
<title>Configurer le système</title>
<body>

<p>
Éditez le fichier <path>/etc/fstab</path> et remplacez <c>/BOOT</c>,
<c>/ROOT</c> et <c>/SWAP</c> avec les noms effectivement donnés à vos
partitions et ajoutez vos volumes logiques. N'oubliez pas de vérifier que les
systèmes de fichiers correspondent à ceux mis en place.
</p>

<pre caption="Exemple de fichier fstab">
livecd linux # <i>cd /etc</i>
livecd etc # <i>nano -w fstab</i>
/dev/<i>md1</i>          /boot                   ext2  noauto,noatime  1 2
/dev/<i>md3</i>          /                       ext3  noatime         0 1
/dev/<i>sda2</i>         none                    swap  sw,pri=1        0 0
/dev/<i>sdb2</i>         none                    swap  sw,pri=1        0 0
/dev/vg/usr       /usr                    ext3  noatime         1 2
/dev/vg/portage   /usr/portage            ext2  noatime         1 2
/dev/vg/distfiles /usr/portage/distfiles  ext2  noatime         1 2
/dev/vg/home      /home                   ext3  noatime         1 2
/dev/vg/opt       /opt                    ext3  noatime         1 2
/dev/vg/tmp       /tmp                    ext2  noatime         1 2
/dev/vg/var       /var                    ext3  noatime         1 2
/dev/vg/vartmp    /var/tmp                ext2  noatime         1 2
</pre>

<p>
Configurez votre connexion réseau dans <path>/etc/conf.d/net</path>. Ajoutez le
script d'initialisation <c>net.eth0</c> au niveau d'exécution par défaut. Si
vous avez de multiples adaptateurs réseaux, faites-en des liens symboliques
vers le script <c>net.eth0</c> et ajoutez-les également au niveau d'exécution
par défaut. Vous pouvez soit éditer <path>/etc/conf.d/net</path> avec
<c>nano</c> soit utiliser les commandes suivantes&nbsp;:
</p>

<pre caption="Configurer le réseau">
livecd etc # <i>cd conf.d</i>
livecd conf.d # <i>echo 'config_eth0=( "192.168.1.10/24" )' >> net</i>
livecd conf.d # <i>echo 'routes_eth0=( "default via 192.168.1.1" )' >> net</i>
livecd conf.d # <i>rc-update add net.eth0 default</i>
<comment>(Si vous avez compilé le pilote de votre carte réseau comme module, ajoutez-le
dans /etc/modules.autoload.d/kernel-2.6)</comment>
livecd conf.d # <i>echo r8169 >> /etc/modules.autoload.d/kernel-2.6</i>
<comment>(Si vous voulez vous reconnecter par ssh après avoir redémarré votre nouveau PC :)</comment>
livecd conf.d # <i>rc-update add sshd default</i>
</pre>

<note>
Si vous en avez besoin, installez <c>pcmcia-cs</c> (utilisez <c>emerge</c>) et
ajoutez-le au niveau d'exécution par défaut.
</note>

<p>
Définissez le mot de passe <c>root</c> en utilisant <c>passwd</c>.
</p>

<pre caption="Définir le mot de passe root">
livecd conf.d # <i>passwd</i>
New UNIX password: <comment>Tapez le mot de passe</comment>
Retype new UNIX password: <comment>Tapez à nouveau le mot de passe</comment>
passwd: password updated successfully
</pre>

<p>
Vérifiez la configuration du système dans les fichiers
<path>/etc/rc.conf</path>, <path>/etc/conf.d/rc</path>,
<path>/etc/conf.d/keymaps</path> et <path>/etc/conf.d/clock</path> et
modifiez-les si nécessaire.
</p>

<pre caption="Facultatif : éditer quelques fichiers de configuration">
livecd conf.d # <i>nano -w /etc/rc.conf</i>
livecd conf.d # <i>nano -w /etc/conf.d/rc</i>
livecd conf.d # <i>nano -w /etc/conf.d/keymaps</i>
livecd conf.d # <i>nano -w /etc/conf.d/clock</i>
</pre>

</body>
</section>
<section>
<title>Installer les outils système</title>
<body>

<p>
Installez les outils RAID et LVM2.
</p>

<pre caption="Installer les outils RAID &amp; LVM2">
livecd conf.d # <i>emerge mdadm lvm2</i>
</pre>

<p>
Installez un système de journalisation tel que <c>syslog-ng</c> et ajoutez-le
au niveau d'exécution par défaut. Faites la même chose pour un démon cron tel
que <c>vixie-cron</c>.
</p>

<note>
Les démons cron nécessitent un MTA. <c>mail-mta/ssmtp</c> sera installé comme
dépendance. Si vous désirez utiliser un MTA plus évolué, vous pouvez
l'installer maintenant. Si vous êtes pressé, laissez ssmtp être installé et
désinstallez-le plus tard en installant alors le MTA de votre choix.
</note>

<pre caption="Installer un système de journalisation et un démon cron">
livecd conf.d # <i>time emerge syslog-ng vixie-cron</i>

real  1m54.099s
user  1m2.630s
sys   0m34.620s

livecd conf.d # <i>rc-update add syslog-ng default</i>
livecd conf.d # <i>rc-update add vixie-cron default</i>
</pre>

<p>
Installez les outils système nécessaires (<c>xfsprogs</c>, <c>reiserfsprogs</c>
ou <c>jfsutils</c>) et les outils réseaux (<c>dhcpcd</c> ou <c>rp-pppoe</c>) si
vous en avez besoin.
</p>

<pre caption="Installer des outils supplémentaires si nécessaire">
livecd conf.d # <i>emerge xfsprogs</i>          <comment>(Si vous utilisez le système de fichiers XFS)</comment>
livecd conf.d # <i>emerge jfsutils</i>          <comment>(Si vous utilisez le système de fichiers JFS)</comment>
livecd conf.d # <i>emerge reiserfsprogs</i>     <comment>(Si vous utilisez le système de fichiers Reiser)</comment>
livecd conf.d # <i>emerge dhcpcd</i>            <comment>(Si vous avez besoin d'un client DHCP)</comment>
livecd conf.d # <i>USE="-X" emerge rp-pppoe</i> <comment>(Si vous utilisez une connexion ADSL)</comment>
</pre>

</body>
</section>
<section>
<title>Configurer le chargeur de démarrage</title>
<body>

<p>
Fait un emerge de <c>grub</c> et configurez-le.
</p>

<pre caption="Installer Grub et éditer son fichier de configuration">
livecd conf.d # <i>time emerge grub</i>

real  1m4.634s
user  0m39.460s
sys   0m15.280s
livecd conf.d # <i>nano -w /boot/grub/grub.conf</i>
</pre>

<pre caption="Exemple de fichier grub.conf">
default 0
timeout 10
title=Gentoo
root (hd0,0)
kernel /boot/kernel root=/dev/md3
</pre>

<pre caption="Installer grub sur les deux disques">
livecd conf.d # <i>grub</i>
Probing devices to guess BIOS drives. This may take a long time.

grub> <i>root (hd0,0)</i>
Filesystem type is ext2fs, partition type 0x83

grub> <i>setup (hd0)</i>
 Checking if "/boot/grub/stage1" exists... yes
 Checking if "/boot/grub/stage2" exists... yes
 Checking if "/boot/grub/e2fs_stage1_5" exists... yes
 Running "embed /boot/grub/e2fs_stage1_5 (hd0)"...  16 sectors are embedded.
succeeded
 Running "install /boot/grub/stage1 (hd0) (hd0)1+16 p (hd0,0)/boot/grub/stage2
/boot/
grub/menu.lst"... succeeded
Done.

grub> <i>root (hd1,0)</i>
Filesystem type is ext2fs, partition type 0x83

grub> <i>setup (hd1)</i>

grub> <i>quit</i>
</pre>

</body>
</section>
<section id="reboot">
<title>Redémarrage</title>
<body>

<p>
Quittez l'environnement chroot, démontez tous les systèmes de fichiers et
redémarrez.
</p>

<pre caption="Redémarrage">
livecd conf.d # <i>exit</i>
livecd / # <i>umount /mnt/gentoo/usr/portage/distfiles /mnt/gentoo/usr/portage /mnt/gentoo/usr</i>
livecd / # <i>umount /mnt/gentoo/var/tmp /mnt/gentoo/tmp /mnt/gentoo/var /mnt/gentoo/opt</i>
livecd / # <i>umount /mnt/gentoo/proc /mnt/gentoo/home /mnt/gentoo/boot /mnt/gentoo</i>
livecd / # <i>reboot</i>
<comment>(N'oubliez pas d'éjecter le CD)</comment>
</pre>

<p>
Pour finaliser votre installation, veuillez suivre le chapitre <uri
link="gentoo-x86-quickinstall.xml#after-reboot">Finaliser votre
installation</uri> du guide d'installation rapide de Gentoo x86.
</p>

</body>
</section>
</chapter>
</guide>

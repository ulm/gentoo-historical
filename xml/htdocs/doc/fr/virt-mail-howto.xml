<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/virt-mail-howto.xml,v 1.35 2006/04/10 09:22:48 neysx Exp $-->

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fr/virt-mail-howto.xml" lang="fr">
<title>Mise en place d'un système de messagerie multidomaine avec postfix</title>

<author title="Auteur">
 <mail link="antifa@gentoo.org">Ken Nowack</mail>
</author>
<author title="Auteur">
 <mail link="ezra@revoltltd.org">Ezra Gorman</mail>
</author>
<author title="Correcteur">
 <mail link="seather@scygro.za.net">Scygro</mail>
</author>
<author title="Traducteur">
 <mail link="cam@gentoo.org">Camille Huot</mail>
</author>

<abstract>
Ce document décrit en détails comment créer un système de messagerie en se
basant sur postfix, mysql, courier-imap et cyrus-sasl.
</abstract>

<license/>

<version>1.0.27</version>
<date>2006-04-09</date>

<chapter>
<title>Introduction</title>
<section>
<body>

<p>
Pour la plupart des utilisateurs Gentoo, un client de courrier électronique et
fetchmail feront l'affaire. Cependant, si vous hébergez un nom de domaine sur
votre système, vous aurez besoin d'un MTA (Agent de Transfert du Courrier)
complet. Et si vous hébergez plusieurs domaines, alors vous avez certainement
besoin de quelque chose d'assez robuste pour prendre en charge tous les
courriels de vos utilisateurs. Le système décrit dans cet article propose une
solution élégante à ce problème.
</p>

<p>
Un système de messagerie multidomaine doit être capable de prendre en charge
les courriels de nombreux utilisateurs répartis sur de nombreux domaines, via
plusieurs interfaces. Nous allons présenter quelques problèmes qui doivent être
résolus. Par exemple, que faire si vous avez deux utilisateurs sur des domaines
différents qui veulent le même nom&nbsp;? Si vous fournissez un accès IMAP et
SMTP-auth, comment combiner les divers systèmes d'authentification en un
seul&nbsp;? Comment allez-vous sécuriser les différents composants du
système&nbsp;? Comment allez-vous tout gérer&nbsp;?
</p>

<p>
Il existe beaucoup de façons différentes de mettre en place un système
de messagerie multidomaine. Selon vos besoins, il existe peut-être une
meilleure solution pour vous. Documentez-vous sur
<uri>http://www.qmail.org/</uri> et <uri>http://www.exim.org/</uri> qui sont
des solutions alternatives.
</p>

<p>
Dans notre configuration, nous utiliserons les paquets suivants&nbsp;: apache,
courier-imap, courier-authlib, postfix, mod_php, phpmyadmin, squirrelmail,
cyrus-sasl, mysql, php et mailman.
</p>

<p>
Avant d'installer ces paquets, assurez-vous que les options suivantes de USE se
trouvent dans votre fichier <path>/etc/make.conf</path>&nbsp;: <c>USE="mysql
imap libwww maildir sasl ssl"</c>. Sinon, vous risquez de devoir recompiler
certains paquets pour activer le support de ces protocoles. Il est également
recommandé de désactiver les autres options liées au courrier et au réseau,
comme ipv6.
</p>

<impo>
Ce guide a été écrit pour postfix-2.0.x. Si vous utilisez postfix &lt; 2,
certaines variables présentées dans ce document seront différentes. Il est
vivement recommandé que vous mettiez à jour votre système. Quelques autres
paquets figurant dans ce guide sont également sensibles au changement de
version. Je vous conseille de lire la documentation incluse dans les paquets
si vous vous trouvez en face de problèmes de ce genre.
</impo>

<impo>
Ce document utilise apache-1.3.x. Apache-2 a été marqué stable dans Portage.
Pourtant, il y a encore quelques problèmes avec l'intégration de PHP. Ce guide
continuera d'utiliser la version 1.3.x jusqu'à ce que le support PHP
d'apache-2.0.x soit marqué stable.
</impo>

<impo>
Vous devez avoir un nom de domaine pour pouvoir faire un serveur public de
messagerie, ou, au moins, un enregistrement de type MX pour un domaine. Pour
utiliser pleinement votre serveur multidomaine, vous devrez gérer au moins deux
domaines.
</impo>

<impo>
Assurez-vous que le fichier <path>/etc/hostname</path> contient bien le bon nom
pour votre serveur de messagerie. Vérifiez également que votre nom de domaine
est réglé correctement avec la commande <c>hostname</c>. Enfin, assurez-vous
que le fichier <path>/etc/hosts</path> ne contient pas d'entrée pouvant créer
des conflits.
</impo>

<note>
Je vous recommande de lire ce document dans son intégralité et de vous
familiariser avec la marche à suivre avant de vous lancer dans l'installation.
Si vous avez des problèmes pendant une étape, consultez la <uri
link="#doc_chap15">section dépannage</uri> à la fin de ce document. Notez
également que tous les paquets ne sont pas requis, cette installation est très
flexible. Par exemple si vous ne voulez pas d'interface Web vous pouvez sauter
la section squirrelmail.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Postfix, la base</title>
<section>
<body>

<pre caption="Installation de postfix">
# <i>emerge postfix</i>
</pre>

<warn>
Assurez-vous de ne pas avoir installé d'autre MTA, comme ssmtp, exim ou qmail,
car, sinon, vous vous exposez à de gros problèmes.
</warn>

<p>
Une fois postfix installé, il est temps de le configurer. Changez les options
suivantes dans <path>/etc/postfix/main.cf</path>&nbsp;:
</p>

<pre caption="/etc/postfix/main.cf">
myhostname = $host.domain.name
mydomain = $domain.name
inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain $mydomain
mynetworks = my.ip.net.work/24, 127.0.0.0/8
home_mailbox = .maildir/
local_destination_concurrency_limit = 2
default_destination_concurrency_limit = 10
</pre>

<p>
Ensuite modifiez <path>/etc/postfix/master.cf</path> de la façon suivante. Cela
activera le mode bavard pour faciliter le débogage&nbsp;:
</p>

<pre caption="/etc/postfix/master.cf">
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (yes)   (never) (50)
#
==========================================================================
smtp      inet  n       -       n       -       -       smtpd -v

<comment>(Ajoutez juste le <i>-v</i> après <i>smtpd</i> dans la ligne ci-dessus.)</comment>
</pre>

<p>
Ensuite, éditez <path>/etc/mail/aliases</path> pour ajouter vos alias locaux.
Il devrait au moins y avoir un alias pour root&nbsp;:
<c>root:&nbsp;&nbsp;&nbsp;votre@adresse.ici</c>.
</p>

<pre caption="Premier lancement de postfix">
<comment>(Reconstruit la base des alias. À ne faire qu'en cas de mise à jour des alias.)</comment>
# <i>/usr/bin/newaliases</i>

# <i>/etc/init.d/postfix start</i>
</pre>

<p>
Maintenant que postfix tourne, lancez votre client de courrier électronique
préféré et envoyez-vous un courrier. Vérifiez que postfix délivre les courriers
aux utilisateurs système. Une fois cela fait, nous pouvons passer à l'étape
suivante.
</p>

<note>
Je vous recommande vivement de vérifier que cette configuration postfix de base
fonctionne correctement avant de continuer.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Courier-imap</title>
<section>
<body>

<pre caption="Installation de courier-imap et de courier-authlib">
# <i>emerge courier-imap courier-authlib</i>
</pre>

<pre caption="Configuration de courier-imap">
# <i>cd /etc/courier-imap</i>
<comment>(Si vous voulez utiliser ssl avec courier-imap ou pop3, vous devez créer des)</comment>
<comment>(certificats. Cette étape est recommandée. Si vous ne voulez pas utiliser ssl,)</comment>
<comment>(passez cette étape.)</comment>

<comment>(Modifiez les paramètres C, ST, L, CN et email)</comment>
<comment>(pour qu'ils correspondent à votre serveur.)</comment>
# <i>nano -w pop3d.cnf</i>
# <i>nano -w imapd.cnf</i>

# <i>mkpop3dcert</i>
# <i>mkimapdcert</i>
</pre>

<pre caption="Lancement des services de courrier">
# <i>/etc/init.d/courier-imapd start</i>
# <i>/etc/init.d/courier-imapd-ssl start</i>
# <i>/etc/init.d/courier-pop3d start</i>
# <i>/etc/init.d/courier-pop3d-ssl start</i>
</pre>

<p>
Lancez votre client de courrier électronique favori et vérifiez que tous les
services que vous avez lancés répondent en envoyant et réceptionnant des
courriels. Maintenant que le système de base fonctionne, nous allons procéder à
plusieurs étapes d'un seul coup pour installer le reste du système. Encore une
fois, soyez certain que ce que nous avons déjà installé fonctionne correctement
avant de continuer.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Cyrus-sasl</title>
<section>
<body>

<p>
Installons à présent cyrus-sasl. Sasl sert à passer vos variables
d'authentification à courier-auth qui va à son tour les passer à mysql pour
vérifier l'authentification des utilisateurs smtp. Dans ce guide, nous ne
testerons pas sasl tant que mysql ne sera pas installé et ne contiendra pas un
utilisateur pour fins de tests. Ce n'est pas grave car, de toute façon, nous
utiliserons mysql pour l'authentification à la fin.
</p>

<pre caption="Installer et configurer cyrus-sasl">
# <i>emerge cyrus-sasl</i>
</pre>

<p>
Ensuite, éditez <path>/etc/sasl2/smtpd.conf</path>.
</p>

<pre caption="Lancement de sasl">
<comment>(Il est important de désactiver les méthodes d'authentification que nous)</comment>
<comment>(n'utilisons pas. Elles peuvent poser problème avec certains clients de courrier électronique.)</comment>
# <i>nano -w /etc/sasl2/smtpd.conf</i>
mech_list: PLAIN LOGIN
pwcheck_method: saslauthd
# <i>nano -w /etc/conf.d/saslauthd</i>
SASLAUTHD_OPTS="${SASLAUTH_MECH} -a rimap -r"
SASLAUTHD_OPTS="${SASLAUTHD_OPTS} -O localhost"

# <i>/etc/init.d/saslauthd start</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Certificats SSL pour Postfix et Apache</title>
<section>
<body>

<p>
Nous allons à présent créer un jeu de certificats pour postfix et apache.
</p>

<pre caption="Création des certificats de sécurité">
# <i>cd /etc/ssl/</i>
# <i>nano -w openssl.cnf</i>

<comment>(Modifiez les valeurs par défaut suivantes pour votre domaine&nbsp;:)</comment>
countryName_default
stateOrProvinceName_default
localityName_default
0.organizationName_default
commonName_default
emailAddress_default.

<comment>(Si les variables n'existent pas, créez-les.)</comment>


# <i>cd misc</i>
# <i>nano -w CA.pl</i>
<comment>(Nous devons ajouter -nodes aux codes commentés par « # create a certificate » et)</comment>
<comment>(« # create a certificate request » afin de laisser nos nouveaux certificats ssl se)</comment>
<comment>(charger sans demander de mot de passe. Sinon, quand vous redémarrerez, vos)</comment>
<comment>(certificats ssl ne seront pas disponibles.)</comment>

# create a certificate
system ("$REQ -new -nodes -x509 -keyout newreq.pem -out newreq.pem $DAYS");

# create a certificate request
system ("$REQ -new -nodes -keyout newreq.pem -out newreq.pem $DAYS");

# <i>./CA.pl -newca</i>
# <i>./CA.pl -newreq</i>
# <i>./CA.pl -sign</i>
# <i>cp newcert.pem /etc/postfix</i>
# <i>cp newreq.pem /etc/postfix</i>
# <i>cp demoCA/cacert.pem /etc/postfix</i>
<comment>(À présent, faire de même pour Apache.)</comment>

# <i>openssl req -new &gt; new.cert.csr</i>
# <i>openssl rsa -in privkey.pem -out new.cert.key</i>
# <i>openssl x509 -in new.cert.csr -out new.cert.cert -req -signkey new.cert.key -days 365</i>
<comment>(Laissez les certificats ici pour le moment. Nous les installerons)</comment>
<comment>(une fois Apache lui-même installé.)</comment>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Ajouter le support SSL et SASL à Postfix</title>
<section>
<body>

<p>
Maintenant, éditez la configuration de postfix pour l'informer de votre
volonté d'utiliser sasl et ssl. Ajoutez les paramètres suivants à la fin du
fichier, là où ils seront faciles à trouver.
</p>

<pre caption="/etc/postfix/main.cf">
# <i>nano -w /etc/postfix/main.cf</i>

smtpd_sasl_auth_enable = yes
smtpd_sasl2_auth_enable = yes
smtpd_sasl_security_options = noanonymous
broken_sasl_auth_clients = yes
smtpd_sasl_local_domain =

<comment>(L'option broken_sasl_auth_clients et la méthode d'authentification de connexion sont)</comment>
<comment>(pour outlook et outlook express uniquement et ne sont pas documentées. N'est-ce)</comment>
<comment>(pas super de devoir trafiquer un bon logiciel pour pallier la stupidité de ceux)</comment>
<comment>(de Micromou&nbsp;? smtpd_sasl_local_domain ajoute un nom de domaine aux clients)</comment>
<comment>(qui utilisent smtp-auth. Soyez sûr que c'est vide ou sinon vos utilisateurs se)</comment>
<comment>(feront virer par postfix et ne pourrons pas s'identifier.)</comment>

smtpd_recipient_restrictions =
  permit_sasl_authenticated,
  permit_mynetworks,
  reject_unauth_destination


<comment>(Les 3 lignes suivantes permettent l'encryption lors de l'envoi.)</comment>
smtp_use_tls = yes
smtp_tls_note_starttls_offer = yes
smtpd_use_tls = yes
#smtpd_tls_auth_only = yes
smtpd_tls_key_file = /etc/postfix/newreq.pem
smtpd_tls_cert_file = /etc/postfix/newcert.pem
smtpd_tls_CAfile = /etc/postfix/cacert.pem
smtpd_tls_loglevel = 3
smtpd_tls_received_header = yes
smtpd_tls_session_cache_timeout = 3600s
tls_random_source = dev:/dev/urandom

<comment>(smtpd_tls_auth_only est commenté pour faciliter le test du système.)</comment>
<comment>(Vous pourrez l'activer plus tard si vous le désirez.)</comment>

# <i>postfix reload</i>
</pre>

<p>
Maintenant, vérifions que nos modifications ont été prises en compte par postfix.
</p>

<pre caption="Vérification du support sasl et ssl">
# <i>telnet localhost 25</i>

Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mail.domain.com ESMTP Postfix
<i>EHLO domain.com</i>
250-mail.domain.com
250-PIPELINING
250-SIZE 10240000
250-VRFY
250-ETRN
250-STARTTLS
250-AUTH LOGIN PLAIN
250-AUTH=LOGIN PLAIN
250-XVERP
250 8BITMIME
<i>^]</i>
telnet&gt; <i>quit</i>
</pre>

<p>
Vérifiez que les lignes AUTH et STARTTLS sont maintenant bien présentes. Comme
je l'ai déjà dit, actuellement AUTH ne marchera pas. C'est à cause du fait que
sasl utilise sa base sasldb (que nous n'avons pas encore configurée) au lieu du
fichier de mots de passe du système pour procéder à l'identification, pour une
raison inconnue. Nous allons donc continuer et installer mysql qui contiendra
toutes les informations d'authentification et de domaine virtuel.
</p>

</body>
</section>
</chapter>

<chapter>
<title>MySQL</title>
<section>
<body>

<p>
Il est temps d'installer et de configurer MySQL. Vous aurez besoin du fichier
<uri link="/doc/en/files/genericmailsql.sql">genericmailsql.sql</uri> pour
cette étape.
</p>

<pre caption="Installation et configuration de MySQL">
# <i>emerge mysql</i>

# <i>/usr/bin/mysql_install_db</i>
<comment>(Après avoir lancé cette commande, suivez les instructions affichées à l'écran)</comment>
<comment>(pour ajouter un mot de passe root à mysql, pas mysqladmin, sinon votre base de)</comment>
<comment>(données sera grande ouverte.)</comment>

# <i>/etc/init.d/mysql start</i>
# <i>mysqladmin -u root -p create mailsql</i>
# <i>mysql -u root -p mailsql &lt; genericmailsql.sql</i>

# <i>mysql -u root -p mysql</i>
mysql&gt; <i>GRANT SELECT,INSERT,UPDATE,DELETE</i>
-&gt;     <i>ON mailsql.*</i>
-&gt;     <i>TO mailsql@localhost</i>
-&gt;     <i>IDENTIFIED BY '$password';</i>
Query OK, 0 rows affected (0.02 sec)

mysql&gt; <i>FLUSH PRIVILEGES;</i>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <i>quit</i>
<comment>(Assurez-vous que l'utilisateur mailsql puisse se connecter au serveur mysql.)</comment>

# <i>mysql -u mailsql -p mailsql</i>
</pre>

<p>
Votre nouvelle base de données a des valeurs par défaut et des tables
configurées pour deux domaines. Les tables suivantes sont incluses&nbsp;:
</p>

<ul>
<li>alias - Alias locaux et alias pour mailman.</li>
<li>relocated - Liste des adresses déplacées.</li>
<li>transport - Méthode de transport par défaut pour chaque domaine hébergé.</li>
<li>users - Les comptes utilisateurs.</li>
<li>virtual - Liste des alias pour les domaines virtuels.</li>
</ul>

<pre caption="Exemple de table alias">
id   alias    destination
1    root     foo@bar.com
2  postmaster foo@bar.com
</pre>

<pre caption="Exemple de table user">
<comment>(Lignes coupées pour améliorer la lisibilité.)</comment>
id email            clear     name     uid     gid     homedir     \
        maildir                                quota  postfix
10 foo@virt-bar.org $password realname virtid  virtid  /home/vmail \
        /home/vmail/virt-bar.org/foo/.maildir/        y
13 foo@bar.com      $password realname localid localid /home/foo   \
        /home/foo/.maildir/                           y
</pre>

<p>
Les valeurs uid et gid de <c>virtid</c> doivent être les uid et gid de
l'utilisateur et du groupe <c>vmail</c>.
</p>

<pre caption="Exemple de table transport">
id   domain       destination
1    bar.com      local:
2    virt-bar.org virtual:
</pre>

<pre caption="Exemple de table virtual">
id   email            destination
3   root@virt-bar.org other@email.address
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Apache et phpMyAdmin</title>
<section>
<body>

<p>
Nous allons à présent mettre en place apache afin d'installer une interface
pour interagir plus facilement avec la base de données.
</p>

<pre caption="Installation d'apache et de phpmyadmin">
# <i>emerge apache mod_php phpmyadmin</i>
</pre>

<p>
Il existe une ribambelle de guides qui expliquent comment installer apache avec
php. Celui-ci, par exemple&nbsp;:
<uri>http://www.linuxguruz.org/z.php?id=31</uri>. Il y a aussi de nombreux articles
sur <uri>http://forums.gentoo.org/</uri> qui détaillent comment résoudre les
problèmes d'installation (faites une recherche de «&nbsp;apache php&nbsp;»).
Ceci étant dit, je ne vais pas en parler dans ce guide. Installez apache et
php, puis continuez à suivre ce guide. En fait juste un mot&nbsp;: mettez un
.htaccess pour protéger le répertoire où réside phpmyadmin. Si vous ne le
faites pas, les moteurs de recherche vont y accéder et indexer vos pages, ce
qui veux dire que n'importe qui pourra venir modifier les données de votre base
de données, ce qui est à proscrire. Il existe de nombreux guides sur le sujet,
notamment&nbsp;:
<uri>http://www.csoft.net/docs/micro/htaccess.html.en</uri>.
</p>

<p>
Nous allons à présent installer les certificats créés auparavant. Voici les
directives Apache-SSL dont vous aurez besoin pour utiliser les certificats&nbsp;:
</p>

<ul>
<li>SSLCertificateFile /path/to/certs/new.cert.cert</li>
<li>SSLCertificateKeyFile /path/to/certs/new.cert.key</li>
</ul>

<pre caption="Installation des certificats pour Apache SSL">
# <i>cp /etc/ssl/misc/new.cert.cert /etc/apache/conf/ssl/</i>
# <i>cp /etc/ssl/misc/new.cert.key /etc/apache/conf/ssl/</i>
# <i>nano -w /etc/apache/conf/vhosts/ssl.default-vhost.conf</i>
<comment>(Modifiez les paramètres suivants :)</comment>

ServerName host.domain.name
ServerAdmin your@email.address
SSLCertificateFile /etc/apache/conf/ssl/new.cert.cert
SSLCertificateKeyFile /etc/apache/conf/ssl/new.cert.key

# <i>/etc/init.d/apache restart</i>
</pre>

<note>
Si vous aviez déjà installé apache, vous devrez effectuer un redémarrage de la
machine pour installer les nouveaux certificats. Vérifiez vos journaux système
pour vous assurer qu'apache a redémarré correctement.
</note>

<p>
Ensuite, configurez phpMyAdmin.
</p>

<pre caption="Configuration de phpMyAdmin">
# <i>nano -w /var/www/localhost/htdocs/phpmyadmin/config.inc.php</i>
<comment>(Modifiez les paramètres suivants :)</comment>

$cfg['Servers'][$i]['host'] = 'localhost';          // MySQL hostname
$cfg['Servers'][$i]['controluser'] = 'mailsql';     // MySQL control user settings
                                                    // (this user must have read-only
$cfg['Servers'][$i]['controlpass'] = '$password';   // access to the "mysql/user"
                                                    // and "mysql/db" tables)
$cfg['Servers'][$i]['user'] = 'mailsql';            // MySQL user
$cfg['Servers'][$i]['password'] = '$password';      // MySQL password
</pre>

<p>
Maintenant, entrez sur la page de phpmyadmin et naviguez dans les tables. Vous
devez ajouter vos alias locaux, éditer la table 'user' pour ajouter un
utilisateur de test et modifier la table «&nbsp;transport&nbsp;» pour ajouter des
informations sur vos domaines. Les valeurs fournies par défaut devraient être
suffisantes pour vous guider vers les bonnes valeurs à mettre. Assurez-vous de
mettre des informations correctes dans la base de données. Par exemple, si vous
ajoutez un utilisateur, il faut que son répertoire existe, ainsi que ses
uid/gid. Les répertoires pour le courrier devraient être automatiquement créés
par postfix quand l'utilisateur recevra son premier courriel. C'est d'ailleurs
une bonne idée d'envoyer un courriel de bienvenue à tous vos utilisateurs pour
vous assurer que son .maildir s'est créé correctement.
</p>

</body>
</section>
</chapter>

<chapter>
<title>L'utilisateur vmail</title>
<section>
<body>

<p>
Vous vous êtes peut-être demandé quel utilisateur et quel répertoire mettre pour
les utilisateurs virtuels. C'est une bonne question. Occupons-nous en.
</p>

<pre caption="Ajout de l'utilisateur vmail">
# <i>adduser -d /home/vmail -s /bin/false vmail</i>
# <i>uid=`cat /etc/passwd | grep vmail | cut -f 3 -d :`</i>
# <i>groupadd -g $uid vmail</i>
# <i>mkdir /home/vmail</i>
# <i>chown vmail: /home/vmail</i>
</pre>

<p>
Maintenant, quand vous créez des comptes virtuels, utilisez les uid, gid et
répertoire de l'utilisateur vmail. Nous pensions créer une page d'administration
en PHP pour faciliter l'ajout d'utilisateurs, mais, comme phpmyadmin marche assez
bien, on s'en passera.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Configuration de l'authentification avec MySQL et les domaines
virtuels</title>
<section>
<body>

<p>
Nous devons à présent reconfigurer le système d'authentification pour utiliser
la base de données mailsql dans courier-imap et postfix. Dans tous les exemples
ci-dessous, remplacez $password par le mot de passe que vous avez assigné à
l'utilisateur mysql «&nbsp;mailsql&nbsp;».
</p>

<pre caption="Configurer l'authentification">
# <i>nano -w /etc/courier/authlib/authdaemonrc</i>
authmodulelist="authmysql authpam"

# <i>nano -w /etc/courier/authlib/authmysqlrc</i>
MYSQL_SERVER            localhost
MYSQL_USERNAME       mailsql
MYSQL_PASSWORD      $password
MYSQL_DATABASE          mailsql
MYSQL_USER_TABLE        users
#MYSQL_CRYPT_PWFIELD    crypt (<comment>Celle-ci doit être commentée car les</comment>
#                              <comment>mots de passes ne sont pas cryptés.</comment>)
MYSQL_CLEAR_PWFIELD     clear
MYSQL_UID_FIELD         uid
MYSQL_GID_FIELD         gid
MYSQL_LOGIN_FIELD       email
MYSQL_HOME_FIELD        homedir
MYSQL_NAME_FIELD        name
MYSQL_MAILDIR_FIELD     maildir

# <i>/etc/init.d/courier-authlib restart</i>
# <i>/etc/init.d/saslauthd restart</i>
</pre>

<p>
On y est presque, je le promets&nbsp;! Ensuite, réglez le reste de la
configuration pour que postfix puisse interagir avec la base de données.
</p>

<pre caption="/etc/postfix/mysql-aliases.cf">
# <i>nano -w /etc/postfix/mysql-aliases.cf</i>
# mysql-aliases.cf

user          = mailsql
password      = $password
dbname        = mailsql
table         = alias
select_field  = destination
where_field   = alias
hosts         = unix:/var/run/mysqld/mysqld.sock
</pre>

<pre caption="/etc/postfix/mysql-relocated.cf">
# <i>nano -w /etc/postfix/mysql-relocated.cf</i>
# mysql-relocated.cf

user          = mailsql
password      = $password
dbname        = mailsql
table         = relocated
select_field  = destination
where_field   = email
hosts         = unix:/var/run/mysqld/mysqld.sock
</pre>

<pre caption="/etc/postfix/mysql-transport.cf (facultatif)">
# <i>nano -w /etc/postfix/mysql-transport.cf</i>
# mysql-transport.cf

user          = mailsql
password      = $password
dbname        = mailsql
table         = transport
select_field  = destination
where_field   = domain
hosts         = unix:/var/run/mysqld/mysqld.sock
</pre>

<pre caption="/etc/postfix/mysql-virtual-gid.cf (facultatif)">
# <i>nano -w /etc/postfix/mysql-virtual-gid.cf</i>
#myql-virtual-gid.cf

user            = mailsql
password        = $password
dbname          = mailsql
table           = users
select_field    = gid
where_field     = email
additional_conditions = and postfix = 'y'
hosts           = unix:/var/run/mysqld/mysqld.sock
</pre>

<pre caption="/etc/postfix/mysql-virtual-maps.cf">
# <i>nano -w /etc/postfix/mysql-virtual-maps.cf</i>
#myql-virtual-maps.cf

user            = mailsql
password        = $password
dbname          = mailsql
table           = users
select_field    = maildir
where_field     = email
additional_conditions = and postfix = 'y'
hosts           = unix:/var/run/mysqld/mysqld.sock
</pre>

<pre caption="/etc/postfix/mysql-virtual-uid.cf (facultatif)">
# <i>nano -w /etc/postfix/mysql-virtual-uid.cf</i>
# mysql-virtual-uid.cf

user            = mailsql
password        = $password
dbname          = mailsql
table           = users
select_field    = uid
where_field     = email
additional_conditions = and postfix = 'y'
hosts           = unix:/var/run/mysqld/mysqld.sock
</pre>

<pre caption="/etc/postfix/mysql-virtual.cf">
# <i>nano -w /etc/postfix/mysql-virtual.cf</i>
# mysql-virtual.cf

user          = mailsql
password      = $password
dbname        = mailsql
table         = virtual
select_field  = destination
where_field   = email
hosts         = unix:/var/run/mysqld/mysqld.sock
</pre>

<p>
Enfin, éditez <path>/etc/postfix/main.cf</path> une fois de plus.
</p>

<pre caption="/etc/postfix/main.cf">
# <i>nano -w /etc/postfix/main.cf</i>
alias_maps = mysql:/etc/postfix/mysql-aliases.cf
relocated_maps = mysql:/etc/postfix/mysql-relocated.cf

local_transport = local
local_recipient_maps = $alias_maps $virtual_mailbox_maps unix:passwd.byname

virtual_transport = virtual
virtual_mailbox_domains =
        virt-bar.com,
        $other-virtual-domain.com

virtual_minimum_uid = 1000
virtual_gid_maps = static:$vmail-gid
virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-maps.cf
virtual_alias_maps = mysql:/etc/postfix/mysql-virtual.cf
virtual_uid_maps = static:$vmail-uid
virtual_mailbox_base = /
#virtual_mailbox_limit =
</pre>

<p>
Pour des raisons de sécurité, vous devriez changer les permissions des
fichiers <path>/etc/mail/mysql-*.cf</path>&nbsp;:
</p>

<pre caption="Changer les permissions des fichiers">
# <i>chmod 640 /etc/postfix/mysql-*.cf</i>
# <i>chgrp postfix /etc/postfix/mysql-*.cf</i>
</pre>

<p>
À partir de Postfix 2.0.x, il y a eu un bon nombre de modifications par rapport
aux versions 1.1.x. Notamment, les tables 'transport', 'virtual-gid' et
'virtual-uid' ne sont plus nécessaires. Les tables sont toujours incluses au
cas où vous voudriez les utiliser.
</p>

<note>
Il est recommandé de lire le fichier <path>VIRTUAL_README</path> inclus avec
postfix pour plus d'informations.
</note>

<pre caption="Recharger postfix">
# <i>postfix reload</i>
</pre>

<p>
Maintenant, si tout s'est bien passé, vous devriez avoir un système de
messagerie fonctionnel. Les utilisateurs devraient pouvoir s'identifier en
attaquant la base de données sql et en utilisant leur adresse de courrier
électronique complète avec pop3, imap et smtp. Je vous recommande très
fortement de vérifier que tout fonctionne à présent. Si vous avez un quelconque
problème (avec tout ce qu'on a fait, il est probable que vous en ayez),
consultez la <uri link="#doc_chap15">section dépannage</uri> de ce guide.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Squirrelmail</title>
<section>
<body>

<pre caption="Installer squirrelmail">
# <i>emerge squirrelmail</i>

<comment>(Installez squirrelmail dans localhost pour qu'il soit accessible sur http://localhost/mail).
Remplacez 1.4.3a-r2 par le numéro de la version que vous utilisez.)</comment>
# <i>webapp-config -I -h localhost -d /mail squirrelmail 1.4.3a-r2</i>

<comment>(Modifiez vos « Organization », « Server » et « Folder settings » pour squirrelmail.
Vous devriez maintenant pouvoir vous connecter sur squirrelmail (avec votre
adresse de courrier complète) et utiliser votre nouvelle interface webmail.)</comment>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Mailman</title>
<section>
<body>

<p>
Dernière étape&nbsp;: mailman. La nouvelle version de mailman possède un
excellent support multidomaine, c'est pourquoi je l'utilise. Inutile, donc, de
préciser que c'est un très bon programme. Pour arriver à installer ce paquet et
à le faire marcher correctement avec les domaines virtuels, il va falloir
faire un peu de bidouillage. Je vous recommande vraiment de lire toute la
documentation sur mailman, surtout README.POSTFIX.gz, pour comprendre ce que
nous allons faire.
</p>

<p>
Une petite note supplémentaire&nbsp;: les versions actuelles de mailman
s'installent dans <path>/usr/local/mailman</path>. Si vous êtes comme moi et
voulez changer le chemin d'installation par défaut, on peut le faire en
changeant la variable INSTALLDIR du fichier ebuild.
</p>

<pre caption="Installer mailman">
# <i>emerge mailman</i>
</pre>

<pre caption="Réglages de mailman : Mailman/Defaults.py">
# <i> nano -w /var/mailman/Mailman/Defaults.py</i>
<comment>(Modifiez les valeurs ci-dessous pour qu'elles correspondent à votre domaine)</comment>
<comment>(principal. Les domaines virtuels seront listés plus tard.)</comment>
DEFAULT_EMAIL_HOST = 'domain.com'
DEFAULT_URL_HOST = 'www.domain.com'
</pre>

<pre caption="Réglages de mailman : Mailman/mm_cfg.py">
# <i>nano -w /var/mailman/Mailman/mm_cfg.py</i>
MTA = "Postfix"
POSTFIX_STYLE_VIRTUAL_DOMAINS = ['virt-domain.com', 'virt.domain2.com']
add_virtualhost('www.virt.domain.com', 'virt.domain.com')
add_virtualhost('www.virt.domain2.com', 'virt.domain2.com')
<comment>(C'est obligatoire pour que mailman fonctionne avec vos domaines virtuels.)</comment>
</pre>

<pre caption="Ajouter une liste de diffusion">
<comment>(Une fois que c'est fait, ajoutez votre première liste de diffusion.)</comment>

# <i>su mailman</i>
# <i>cd ~</i>
# <i>bin/newlist test</i>
Enter the email of the person running the list: your@email.address
Initial test password:
Hit enter to continue with test owner notification...
<comment>(Les listes qui utilisent un domaine virtuel peuvent être spécifiées en)</comment>
<comment>(utilisant le style liste@domaine.com.)</comment>
# <i>bin/genaliases</i>
<comment>(Maintenant que vos alias ont été générés, vérifiez qu'ils ont été)</comment>
<comment>(correctement ajoutés.)</comment>

# <i>nano -w data/aliases</i>
# STANZA START: test
# CREATED:
test:             "|/var/mailman/mail/mailman post test"
test-admin:       "|/var/mailman/mail/mailman admin test"
test-bounces:     "|/var/mailman/mail/mailman bounces test"
test-confirm:     "|/var/mailman/mail/mailman confirm test"
test-join:        "|/var/mailman/mail/mailman join test"
test-leave:       "|/var/mailman/mail/mailman leave test"
test-owner:       "|/var/mailman/mail/mailman owner test"
test-request:     "|/var/mailman/mail/mailman request test"
test-subscribe:   "|/var/mailman/mail/mailman subscribe test"
test-unsubscribe: "|/var/mailman/mail/mailman unsubscribe test"
# STANZA END: test

<comment>(Pour lancer mailman manuellement et à chaque démarrage :)</comment>
# <i>/etc/init.d/mailman start</i>
# <i>rc-update add mailman default</i>
</pre>

<pre caption="Ajout du support des alias mailman à postfix">
# <i>nano -w /etc/postfix/main.cf</i>
owner_request_special = no
recipient_delimiter = +
<comment>(Lisez README.POSTFIX.gz pour plus de détails.)</comment>

alias_maps     =
        hash:/var/mailman/data/aliases,
        mysql:/etc/postfix/mysql-aliases.cf

virtual_alias_maps =
        hash:/var/mailman/data/virtual-mailman,
        mysql:/etc/postfix/mysql-virtual.cf
<comment>(Postfix supporte maintenant le fichier d'alias de mailman.)</comment>
<comment>(Vous pouvez bien sûr utiliser les tables mysql pour cela,)</comment>
<comment>(mais j'ai horreur de le faire à la main. Aussi, si vous n'utilisez)</comment>
<comment>(pas les domaines virtuels, l'ajout d'une liste d'alias virtuels à)</comment>
<comment>(postfix peut poser des problèmes. Vous êtes prévenu.)</comment>
</pre>

<p>
Vous devriez maintenant pouvoir installer une liste de diffusion pour n'importe
quel domaine de votre système. Une dernière note&nbsp;: assurez-vous de lancer
les commandes mailman en tant qu'utilisateur mailman (<c>su mailman</c>) car
sinon les permissions seront mauvaises et vous devrez les corriger. Lisez la
documentation de mailman pour plus d'information sur la mise en place et la
gestion des listes mailman.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Filtre de contenu et anti-virus</title>
<section>
<body>

<p>
Le filtrage du contenu et les anti-virus sont détaillés dans notre <uri
link="/doc/fr/mailfilter-guide.xml">Guide de configuration d'une passerelle de
filtrage de courrier électronique</uri>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Finalisation</title>
<section>
<body>

<p>
Ok, c'est terminé. Éditez <path>/etc/postfix/master.cf</path> et désactivez le
mode bavard pour un usage en production. Vous voudrez probablement que vos
services soient lancent au prochain redémarrage. Assurez-vous d'ajouter tous
les services que vous voulez utiliser parmi la liste de ceux qu'on a
installés&nbsp;: apache, mysql, saslauthd, postfix, courier-imapd,
courier-imapd-ssl, courier-pop3d et courier-pop3d-ssl. Personnellement, j'ai
tous ces services qui tournent.
</p>

<pre caption="Finalisation">
# <i>postfix reload</i>
# <i>rc-update add $service default</i>
</pre>

<p>
<e>Amusez-vous bien&nbsp;!</e>
</p>

</body>
</section>
</chapter>

<chapter>
<title>Dépannage</title>
<section>
<title>Introduction</title>
<body>

<p>
Dépannage&nbsp;: voici un petit guide de dépannage pour l'installation que nous
venons de détailler dans ce guide. Il n'est pas exhaustif, mais est là pour vous
aider à trouver la solution à vos problèmes. Avec un système aussi complexe que
celui-ci, il est impératif que vous puissiez cerner la partie exacte qui ne
fonctionne pas. En général, je procède en suivant quelques étapes. Commencez par
la base du système et passez en revue chaque composant jusqu'à ce que vous
découvriez celui qui pose problème.
</p>

</body>
</section>

<section>
<title>Étape 1&nbsp;: Vérifiez vos fichiers de configuration.</title>
<body>

<p>
Les fautes de frappe ne pardonnent pas, surtout au niveau du système
d'authentification. Cherchez des fautes de frappe dans vos fichiers de
configuration et dans la base de données. Vous pourrez déboguer autant que vous
voulez, si vous n'envoyez pas une information correcte, cela ne marchera jamais.
Si vous faites une modification dans un fichier de configuration pour un
certain service, assurez-vous de relancer le service concerné pour que les
changements puissent être pris en compte.
</p>

<pre caption="Relancer un service">
# <i>/etc/init.d/service restart</i>
</pre>

</body>
</section>

<section>
<title>Étape 2&nbsp;: Est-ce que tous les services requis sont lancés&nbsp;?</title>
<body>

<p>
S'il n'est pas lancé, lancez-le. C'est super dur de déboguer un service qui ne
tourne pas. Parfois, un service fera semblant de s'être lancé, mais ne
fonctionnera pas. Parfois, quand une mauvaise configuration est utilisée ou
qu'une mauvaise transmission arrive dans un composant du système de courrier,
le service peut planter et empêcher le port d'être utilisé par un autre
processus. Parfois, vous pouvez le détecter avec netstat. Quelques fois, un
petit redémarrage peut remettre les processus plantés à leur place et résoudre
bien des problèmes.
</p>

<pre caption="Vérifier qu'un service est actif">
# <i>/etc/init.d/$service status</i>
# <i>netstat -a | grep $service (or $port)</i>
</pre>

</body>
</section>

<section>
<title>Étape 3&nbsp;: Est-ce que les services utilisent mes configs&nbsp;?</title>
<body>

<p>
Si vous avez récemment modifié un fichier de configuration, relancez le service
pour vous assurez qu'il utilise la bonne version. Certains composants vous
montrent leur configuration actuelle, comme Postfix.
</p>

<pre caption="Vérifiez les configurations">
# <i>apachectl fullstatus</i> (Requiert lynx.)
# <i>apachectl configtest</i> (Vérifie la configuration.)
# <i>postconf -n</i> (Vous dit exactement la configuration qu'utilise postfix.)
# <i>/etc/init.d/$service restart</i>
</pre>

</body>
</section>

<section>
<title>Étape 4&nbsp;: Vérifiez les journaux système.</title>
<body>

<p>
Répétez après moi&nbsp;: les journaux système sont mes amis. Mes dépannages
s'arrêtent tout le temps sur la consultation des journaux système. Parfois,
c'est utile de répéter une opération qui a échoué puis de consulter les
journaux système afin de voir si le message d'erreur apparaît bien à la fin (ou
au début, ça dépend de votre système de journalisation). Voyez s'il n'y a pas
une information dans les journaux système qui pourrait vous aider à comprendre
le problème, ou, au moins, à vous indiquer de quel composant l'erreur provient.
</p>

<pre caption="Vérifiez les journaux du système">
# <i>kill -USR1 `ps -C metalog -o pid=`</i>(Désactive le cache de metalog.)
# <i>nano -w /var/log/mail/current</i>
# <i>cat /var/log/mysql/mysql.log</i>
# <i>tail /var/log/apache/error_log</i>
</pre>

<p>
Un paramètre de postfix est très utile&nbsp;; debug_peer permet d'augmenter
le niveau de verbosité dans les journaux système.
</p>

<pre caption="Ajout de debug_peer">
# <i>nano -w /etc/postfix/main.cf</i>
debug_peer_level = 5
debug_peer_list = $host.domain.name
<comment>(Décommentez une des commandes suggérées.)</comment>
</pre>

</body>
</section>

<section>
<title>Étape 5&nbsp;: Utilisez le service vous-même.</title>
<body>

<p>
SMTP, IMAP et POP3 répondent aux sessions telnet, comme nous l'avons déjà vu
pour vérifier la configuration de postfix. Cela peut parfois être utile d'ouvrir
une session telnet vers le service lui-même et de voir ce qu'il se passe.
</p>

<pre caption="Se connecter au service en telnet">
# <i>telnet localhost $port</i>
<comment>(Pour SMTP, c'est 25, IMAP, c'est 143, et POP3, c'est 110. Vous devriez au moins)</comment>
<comment>(recevoir une chaîne OK qui vous informe que le service fonctionne et est prêt)</comment>
<comment>(à répondre à une requête.)</comment>

Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
* OK Courier-IMAP ready. Copyright 1998-2002 Double Precision, Inc.
</pre>

</body>
</section>

<section>
<title>Étape 6&nbsp;: Il faut parfois sortir l'artillerie lourde pour lui faire
cracher le morceau&nbsp;: strace.</title>
<body>

<p>
Vous auriez de toute façon dû l'installer. C'est un outil hors du commun pour
déboguer les programmes. Vous pouvez lancer des commandes en ligne de commande
avec strace et observer tous les appels système qui arrivent. Il affiche souvent
une énorme quantité d'information&nbsp;; vous devez donc le regarder en temps
réel quand vous essayez de refaire une transaction qui échoue, ou envoyer la
sortie dans un fichier pour la lire plus calmement.
</p>

<pre caption="Déboguer avec strace">
# <i>emerge strace</i>
# <i>strace $commande</i>
# <i>strace -p `ps -C $service -o pid=`</i>
</pre>

</body>
</section>

<section>
<title>Étape 7&nbsp;: Recherche</title>
<body>

<p>
Une fois que vous avez l'information, si vous pouvez trouver et réparer le
problème, c'est bien. Sinon, vous devrez probablement fouiller sur le net à la
recherche d'informations qui vous aideront. Voici une liste de sites à visiter
pour voir si votre erreur a déjà été résolue quelque part. Il y a aussi un
guide vraiment bon sur la mise en place de smtp-auth qui contient de bonnes
idées de débogage.
</p>

<ul>
<li><uri>http://forums.gentoo.org/</uri> - Super forums pour les utilisateurs de
Gentoo.</li>
<li><uri>http://bugs.gentoo.org/</uri> - Base de données des bogues liés à Gentoo.
Bon endroit pour chercher des erreurs particulières.</li>
<li><uri>http://postfix.state-of-mind.de/</uri> - Guide pour smtp-auth.</li>
<li><uri>http://marc.theaimsgroup.com/?l=postfix-users</uri> - Liste de
diffusion de Postfix - recherches possibles.</li>
<li><uri>http://sourceforge.net/mailarchive/forum.php?forum_id=6705</uri> -
Archives de la liste de diffusion de Courier-imap - pas de recherche
possible.</li>
<li><uri>http://www.google.com/</uri> - Si tout le reste échoue, il reste
toujours Google, ce qui n'a jamais échoué pour moi.</li>
<li>Je passe également beaucoup de temps sur #gentoo irc.freenode.net. IRC est
un très bon endroit pour chercher de l'aide.</li>
</ul>

</body>
</section>
</chapter>
</guide>

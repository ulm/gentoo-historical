<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/handbook/hb-install-system.xml,v 1.59 2007/11/05 21:05:23 cam Exp $ -->

<sections>

<abstract>
Maintenant que le fichier stage3 est extrait nous allons entrer dans le nouveau
système et le configurer.
</abstract>

<version>8.2</version>
<date>2007-10-24</date>

<section>
<title>Entrer dans le nouvel environnement (chroot)</title>
<subsection>
<title>Facultatif&nbsp;: sélection des miroirs</title>
<body>

<p>
Il est recommandé de choisir un miroir rapide pour télécharger les sources.
Portage utilise la variable GENTOO_MIRRORS définie dans <path>make.conf</path>
pour connaitre les différents serveurs à contacter. Vous pouvez consulter la
liste de nos <uri link="/main/en/mirrors.xml">miroirs</uri> et en choisir
quelques-uns proches de chez vous, car ils sont en général les plus rapides pour
vous. Cependant, l'outil <c>mirrorselect</c> vous présente la même liste et vous
permet de choisir plus facilement.
</p>

<pre caption="Choisir des miroirs avec mirrorselect">
# <i>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<warn>
Ne sélectionnez pas de miroir IPv6, car les «&nbsp;stages&nbsp;» utilisés pour
l'installation ne supportent pas IPv6.
</warn>

<p>
Une autre variable importante de <path>make.conf</path> est SYNC qui indique à
Portage le serveur à utiliser pour synchroniser votre arbre Portage (l'ensemble
des ebuilds, des scripts et autres fichiers dont Portage a besoin pour installer
des paquets). Au lieu de définir SYNC manuellement, vous pouvez aussi utiliser
<c>mirrorselect</c>.
</p>

<pre caption="Choisir un miroir pour RSYNC">
# <i>mirrorselect -i -r -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<p>
Après avoir utilisé <c>mirrorselect</c>, il est conseillé de vérifier le contenu
de <path>/mnt/gentoo/etc/make.conf</path>.
</p>

</body>
</subsection>
<subsection>
<title>Copier l'information DNS</title>
<body>

<p>
Il reste une dernière chose à faire avant d'entrer dans le nouvel environnement.
Il s'agit de copier l'information DNS de <path>/etc/resolv.conf</path>. Vous
devez le faire afin d'assurer le bon fonctionnement du réseau dans le nouvel
environnement.  <path>/etc/resolv.conf</path> contient les serveurs de noms pour
votre réseau.
</p>

<pre caption="Copier l'information DNS">
<comment>(L'option -L garantit qu'on ne copie pas un lien symbolique.)</comment>
# <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/</i>
</pre>

</body>
</subsection>
<subsection test="not(func:keyval('arch')='IA64')">
<title>Monter /proc et /dev</title>
<body>

<p>
Montez le système de fichiers <path>/proc</path> dans
<path>/mnt/gentoo/proc</path> permet à l'installation d'utiliser les
informations fournies par le noyau, même lorsqu'on se trouve dans
l'environnement chroot ainsi que <path>/dev</path>.
</p>

<pre caption="Monter /proc et /dev">
# <i>mount -t proc none /mnt/gentoo/proc</i>
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
</pre>

</body>
</subsection>
<subsection test="func:keyval('arch')='IA64'">
<title>Monter /proc, /sys et /dev</title>
<body>

<p>
Montez votre <path>/proc</path> sur <path>/mnt/gentoo/proc</path> pour que
l'installation puisse utiliser les informations fournies par le noyau dans le
chroot. Montez ensuite <path>/dev</path> et <path>/sys</path>.
</p>

<pre caption="Montez /proc /sys et /dev">
# <i>mount -t proc none /mnt/gentoo/proc</i>
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
# <i>mount -o bind /sys /mnt/gentoo/sys</i>
</pre>

</body>
</subsection>
<subsection>
<title>Entrer dans le nouvel environnement</title>
<body>

<p>
Maintenant que toutes les partitions sont initialisées et que l'environnement
de base est installé, il est temps d'entrer dans notre nouvel environnement
d'installation. Cela signifie que l'on passe de l'environnement d'installation
actuel (CD d'installation ou autre environnement d'installation) à
l'environnement de votre système (soit les partitions initialisées).
</p>

<p>
L'entrée se fait en trois étapes. D'abord, on change la racine de <path>/</path>
(sur l'environnement d'installation) en <path>/mnt/gentoo</path> (sur vos
partitions) en utilisant <c>chroot</c>. Ensuite, on crée un nouvel environnement
en utilisant <c>env-update</c> dont l'effet est essentiellement de créer les
variables d'environnement. Finalement, ces variables sont chargées en mémoire en
utilisant <c>source</c>.
</p>

<pre caption="Entrer dans le nouvel environnement">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update</i>
 >> Regenerating /etc/ld.so.cache...
# <i>source /etc/profile</i>
# <i>export PS1="(chroot) $PS1"</i>
</pre>

<p>
Félicitations&nbsp;! Vous êtes maintenant dans votre propre environnement Gentoo
Linux. Bien sûr, ce dernier est loin d'être complet. C'est pourquoi il reste
encore quelques sections à ce guide d'installation :-)
</p>

</body>
</subsection>
</section>

<section>
<title>Configurer Portage</title>
<subsection>
<title>Mettre l'arbre de Portage à jour</title>
<body>

<p>
Vous devriez mettre votre arbre Portage à jour avec la commande <c>emerge
--sync</c>.
</p>

<pre caption="Mise à jour de l'arbre de Portage">
# <i>emerge --sync</i>
<comment>(Si vous utilisez un terminal lent comme certains framebuffers ou une
connexion série, vous pouvez ajouter l'option --quiet pour gagner du temps :)</comment>
# <i>emerge --sync --quiet</i>
</pre>

<p>
Si vous vous trouvez derrière un pare-feu qui bloque le trafic rsync, vous
pouvez utiliser <c>emerge-webrsync</c> qui télécharge un instantané de l'arbre
Portage depuis un miroir et l'utilise pour mettre votre arbre à jour.
</p>

<p>
Si vous recevez un avertissement vous suggérant de mettre Portage à jour parce
qu'une nouvelle version est disponible, il est recommandé de le faire. Utilisez
la commande <c>emerge portage</c>.
</p>

</body>
</subsection>

<subsection>
<title>Choisir le bon profil</title>
<body>

<p>
Qu'est-ce qu'un profil&nbsp;?
</p>

<p>
Un profil est un composant important d'une installation de Gentoo. Il spécifie
non seulement les valeurs par défaut des options de compilation (les variables
CFLAGS et CXXFLAGS) et d'autres paramètres importants, mais aussi quels paquets
sont disponibles ou pas. Les profils sont mis à jour par les développeurs
Gentoo.
</p>


<p>
Les utilisateurs n'avaient pas à se préoccuper des profils jusqu'à présent.
Cependant, il existe des situations dans lesquelles vous pourriez estimer qu'un
changement de profil est nécessaire.
</p>

<p>
Pour connaitre le profil que vous utilisez, lancez la commande suivante&nbsp;:
</p>

<pre caption="Connaitre son profil">
# <i>ls -FGg /etc/make.profile</i>
lrwxrwxrwx  1 48 Apr  8 18:51 /etc/make.profile -> ../usr/portage/profiles/<keyval id="profile"/>
</pre>

<p>
Le profil par défaut utilise un noyau 2.6. Ce profil est recommandé, mais vous
pouvez choisir de conserver un noyau 2.4 si vous le désirez.
</p>

<p>
Les sous-profils <c>desktop</c> et <c>server</c> sont également disponibles
pour certaines architectures.  Regardez dans le profil <path>2007.0/</path>
pour voir s'il en existe un pour votre architecture.  Vous pouvez consulter
le fichier <path>make.defaults</path> du profil <c>desktop</c> pour vérifier
s'il satisfait vos besoins.
</p>

<p>
Après avoir examiné les différents profils possibles pour votre architecture
dans <path>/usr/portage/profiles/</path>, vous pouvez en changer si vous le
désirez&nbsp;:
</p>

<pre caption="Changer de profil">
# <i>ln -snf /usr/portage/profiles/&lt;nom du profil&gt; /etc/make.profile</i>
</pre>

<p test="func:keyval('arch')='AMD64'">
Si vous désirez un environnement entièrement 64&nbsp;bits, sans applications ni
bibliothèques 32&nbsp;bits, vous devriez utiliser un profil non-multilib.
</p>

<pre test="func:keyval('arch')='AMD64'" caption="Passer à un profil non
multilib">
# <i>ln -snf /usr/portage/profiles/default-linux/amd64/2007.0/no-multilib /etc/m
ake.profile</i>
</pre>

</body>
</subsection>

<subsection id="configure_USE">
<title>Configurer la variable USE</title>
<body>

<p>
<c>USE</c> est une des plus puissantes variables mises à la disposition des
utilisateurs de Gentoo. Plusieurs programmes peuvent être compilés avec ou sans
le support optionnel disponible pour certaines fonctionnalités. Par exemple,
certains programmes peuvent être compilés avec un support pour GTK ou pour Qt.
D'autres peuvent être compilés avec ou sans support pour SSL. Certains
programmes peuvent même être compilés avec un support pour le
«&nbsp;framebuffer&nbsp;» (svgalib) plutôt que pour X11 (serveur X).
</p>

<p>
La plupart des distributions compilent leurs paquets avec un support aussi
complet que possible, augmentant ainsi la taille des programmes et le temps de
chargement, sans mentionner le nombre énorme de dépendances qui en résulte.
Avec Gentoo, vous pouvez définir les options à utiliser lors de la compilation
d'un paquet. C'est ici que la variable <c>USE</c> entre en jeu.
</p>

<p>
La variable <c>USE</c> contient des mots-clés que vous choisissez et qui
correspondent à des options de compilation. Par exemple, <e>ssl</e> compilera
le support ssl dans les programmes qui le supportent. <e>-X</e> retirera le
support pour le serveur X (remarquez le signe moins devant le mot-clé).
<e>gnome gtk -kde -qt3 -qt4</e> compilera vos programmes avec le support pour
GNOME (et GTK), mais sans le support pour KDE (ni Qt). Le résultat sera un
système complètement réglé pour GNOME.
</p>

<p>
Les options par défaut pour <c>USE</c> se trouvent dans les fichiers
<path>make.defaults</path> de votre profil. Vous trouverez ces fichiers
<path>make.defaults</path> dans le répertoire sur lequel le lien
<path>/etc/make.profile</path> pointe, ainsi que dans tous ses répertoires
parents. Les options par défaut de <c>USE</c> sont donc la somme de toutes les
options <c>USE</c> de ces fichiers. Vos modifications à
<path>/etc/make.conf</path> sont jugées en fonction de ces options par
défaut. Si vous ajoutez quelque chose aux options <c>USE</c>, c'est ajouté
à la liste par défaut. Si vous retirez quelque chose des options <c>USE</c>
(en le précédant du signe moins), c'est retiré de la liste par défaut (en
supposant que cela s'y trouvait). Ne modifiez <e>jamais</e> quoi que ce soit
dans le répertoire <path>/etc/make.profile</path> car ces fichiers sont écrasés
lors des mises à jour de Portage&nbsp;!
</p>

<p>
Une description complète de <c>USE</c> peut être consultée dans la seconde
partie du Manuel Gentoo, <uri link="?part=2&amp;chap=2">La variable USE</uri>.
Une description complète des options disponibles se trouve dans le fichier
<path>/usr/portage/profiles/use.desc</path> qui devrait déjà être sur votre
système.
</p>

<pre caption="Afficher les options de la variable USE disponibles">
# <i>less /usr/portage/profiles/use.desc</i>
<comment>(Utilisez les flèches de votre clavier pour faire défiler le texte et</comment>
<comment>tapez 'q' pour quitter.)</comment>
</pre>

<p>
L'exemple suivant montre les options de USE pour un
système basé sur KDE avec support pour ALSA, pour les DVD et pour la
gravure de CD&nbsp;:
</p>

<pre caption="Ouverture de /etc/make.conf">
# <i>nano -w /etc/make.conf</i>
</pre>

<pre caption="Options de USE">
USE="-gtk -gnome qt3 qt4 kde dvd alsa cdr"
</pre>

</body>
</subsection>
<subsection>
<title>Facultatif: les «&nbsp;locales&nbsp;» de glibc</title>
<body>

<p>
Vous n'utiliserez probablement qu'une ou deux «&nbsp;locales&nbsp;» sur votre
système. Vous pouvez définir les zones qui vous intéressent dans le fichier
<path>/etc/locale.gen</path>.
</p>

<pre caption="Ouvrir le fichier /etc/locale.gen">
# <i>nano -w /etc/locale.gen</i>
</pre>

<p>
L'exemple ci-dessous sélectionne l'anglais américain et le français en France
dans les encodages ISO et UTF-8.
</p>

<pre caption="Exemple de /etc/locale.gen">
en_US ISO-8859-1
en_US.UTF-8 UTF-8
fr_FR ISO-8859-1
fr_FR@euro ISO-8859-15
fr_FR.UTF-8 UTF-8
</pre>

<p>
Ensuite, exécutez la commande <c>locale-gen</c> pour créer les locales que vous
venez de définir.
</p>

<p>
Ensuite, passez à la <uri link="?part=1&amp;chap=7">Configuration du
noyau</uri>.
</p>

</body>
</subsection>
</section>
</sections>

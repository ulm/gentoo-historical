<?xml version="1.0" encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/handbook/hb-install-system.xml,v 1.35 2005/04/07 13:07:46 neysx Exp $ -->

<sections>

<version>2.3</version>
<date>2005-04-07</date>

<section>
<title>Entrer dans le nouvel environnement (chroot)</title>
<subsection>
<title>Facultatif&nbsp;: sélection des miroirs</title>
<body>

<p>
Choisir un miroir rapide afin de télécharger les sources est recommandé.
Portage utilise la variable GENTOO_MIRRORS définie dans <path>make.conf</path>
pour connaître les différents serveurs à contacter.  Vous pouvez consulter la
liste de nos <uri link="/main/en/mirrors.xml">miroirs</uri> et en choisir
quelques-uns proches de chez vous, car ils sont en général les plus rapides
pour vous. Cependant, l'outil <c>mirrorselect</c> vous présente la même liste
et vous permet de choisir plus facilement.
</p>

<pre caption="Choisir des miroirs avec mirrorselect">
# <i>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<warn>
Ne sélectionnez pas de miroir IPv6, car les «&nbsp;stages&nbsp;» utilisés pour
l'installation ne supportent pas IPv6.
</warn>

<p>
Une autre variable importante de <path>make.conf</path> est RSYNC qui indique à
Portage le serveur à utiliser pour synchroniser votre arbre Portage (l'ensemble
des ebuilds, des scripts et autres fichiers dont Portage a besoin pour
installer des paquets). Au lieu de définir RSYNC manuellement, vous pouvez
aussi utiliser <c>mirrorselect</c>.
</p>

<pre caption="Choisir un miroir pour RSYNC">
# <i>mirrorselect -i -r -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<p>
Après avoir utilisé <c>mirrorselect</c>, il est conseillé de vérifier le
contenu de <path>/mnt/gentoo/etc/make.conf</path>.
</p>

</body>
</subsection>
<subsection>
<title>Copier l'information DNS</title>
<body>

<p>
Il reste une dernière chose à faire avant d'entrer dans le nouvel
environnement. Il s'agit de copier l'information DNS de
<path>/etc/resolv.conf</path>. Vous devez le faire afin d'assurer le bon
fonctionnement du réseau dans le nouvel environnement.
<path>/etc/resolv.conf</path> contient les serveurs de noms pour votre réseau.
</p>

<pre caption="Copier l'information DNS">
<comment>(L'option -L garantit qu'on ne copie pas un lien symbolique.)</comment>
# <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/resolv.conf</i>
</pre>

</body>
</subsection>
<subsection>
<title>Monter /proc</title>
<body>

<p>
Monter le système de fichiers <path>/proc</path> dans
<path>/mnt/gentoo/proc</path> permet à l'installation d'utiliser les
informations fournies par le noyau, même lorsqu'on se trouve dans
l'environnement chroot.
</p>

<pre caption="Montage de /proc">
# <i>mount -t proc none /mnt/gentoo/proc</i>
</pre>

</body>
</subsection>
<subsection>
<title>Entrer dans le nouvel environnement</title>
<body>

<p>
Maintenant que toutes les partitions sont initialisées et que l'environnement
de base est installé, il est temps d'entrer dans notre nouvel environnement
d'installation. Cela signifie que l'on passe de l'environnement d'installation
actuel (CD d'installation ou autre environnement d'installation) à
l'environnement de votre système (soit les partitions initialisées).
</p>

<p>
L'entrée se fait en trois étapes. D'abord, on change la racine de
<path>/</path> (sur l'environnement d'installation) en <path>/mnt/gentoo</path>
(sur vos partitions) en utilisant <c>chroot</c>. Ensuite, on crée un nouvel
environnement en utilisant <c>env-update</c> dont l'effet est
essentiellement de créer les variables d'environnement. Finalement, ces
variables sont chargées en mémoire en utilisant <c>source</c>.
</p>

<pre caption="Entrer dans le nouvel environnement">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update</i>
 * Caching service dependencies...
# <i>source /etc/profile</i>
</pre>

<p>
Félicitations&nbsp;! Vous êtes maintenant dans votre propre environnement Gentoo
Linux. Bien sûr, ce dernier est loin d'être complet. C'est pourquoi il reste
encore quelques sections à ce guide d'installation :-)
</p>

</body>
</subsection>
<subsection>
<title>Mettre l'arbre de Portage à jour</title>
<body>

<p>
Vous devriez mettre votre arbre Portage à jour avec la commande <c>emerge
--sync</c>.
</p>

<pre caption="Mise à jour de l'arbre de Portage">
# <i>emerge --sync</i>
</pre>

<p>
Si vous vous trouvez derrière un pare-feu qui bloque le trafic rsync, vous
pouvez utiliser <c>emerge-webrsync</c> qui télécharge un instantané de l'arbre
Portage depuis un mirroir et l'utilise pour mettre votre arbre à jour.
</p>

<p>
Si vous recevez un avertissement vous suggérant de mettre Portage à jour parce
qu'une nouvelle version est disponible, vous devez l'ignorer. Portage sera mis
à jour pour vous plus tard pendant l'installation.
</p>

</body>
</subsection>

<subsection>
<title>Choisir le bon profil</title>
<body>

<p>
Qu'est-ce qu'un profil&nbsp;?
</p>

<p>
Un profil est un composant important d'une installation de Gentoo. Il spécifie
non seulement les valeurs par défaut des options de compilation (les variables
CFLAGS et CXXFLAGS) et d'autres paramètres importants, mais aussi quels paquets
sont disponibles ou pas. Les profils sont mis à jour par les développeurs
Gentoo.
</p>

<p>
Les utilisateurs n'avaient pas à se préoccuper des profils jusqu'à présent.
Depuis peu, les utilisateurs de machines x86, hppa et alpha peuvent choisir
entre deux profils, un pour le noyau 2.4 et un pour le noyau 2.6. Ceci est
nécessaire pour assurer une transition en douceur vers le noyau 2.6.
</p>

<p>
Pour connaître le profil que vous utilisez, lancez la commande suivante&nbsp;:
</p>

<pre caption="Connaître son profil">
# <i>ls -l /etc/make.profile</i>
lrwxrwxrwx  1 root root 48 Mar  7 11:55 /etc/make.profile -&gt;
      ../usr/portage/profiles/default-linux/x86/2005.0
</pre>

<p>
Si vous utilisez une des trois architectures mentionnées ci-dessus, vous verrez
un profil supplémentaire&nbsp;:
</p>

<pre caption="Savoir si un profil supplémentaire existe">
# <i>ls -F /etc/make.profile/</i>
2.4/  packages  parent  virtuals
</pre>

<p>
Comme vous pouvez le voir, un sous-répertoire <path>2.4</path> existe. Cela
signifie que le profil en cours utilise le noyau 2.6 et que si vous voulez un
système qui utilise le noyau 2.4, vous devez modifier le lien symbolique
<path>make.profile</path> comme suit&nbsp;:
</p>

<pre caption="Recréer le profil">
# <i>ln -snf /usr/portage/profiles/default-linux/x86/2005.0/2.4 /etc/make.profile</i>
</pre>

</body>
</subsection>

<subsection id="configure_USE">
<title>Configurer la variable USE</title>
<body>

<p>
<c>USE</c> est une des plus puissantes variables mises à la disposition des
utilisateurs de Gentoo. Plusieurs programmes peuvent être compilés avec ou sans
le support optionnel disponible pour certaines fonctionnalités. Par exemple,
certains programmes peuvent être compilés avec un support pour gtk ou pour Qt.
D'autres peuvent être compilés avec ou sans support pour SSL. Certains
programmes peuvent même être compilés avec un support pour le
«&nbsp;framebuffer&nbsp;» (svgalib) plutôt que pour X11 (serveur X).
</p>

<p>
La plupart des distributions compilent leurs paquets avec un support aussi
complet que possible, augmentant ainsi la taille des programmes et le temps de
chargement, sans mentionner le nombre énorme de dépendances qui en résulte.
Avec Gentoo, vous pouvez définir les options à utiliser lors de la compilation
d'un paquet. C'est ici que la variable <c>USE</c> entre en jeu.
</p>

<p>
La variable <c>USE</c> contient des mots-clés que vous choisissez et qui
correspondent à des options de compilation. Par exemple, <e>ssl</e> compilera
le support ssl dans les programmes qui le supportent. <e>-X</e> retirera le
support pour le serveur X (remarquez le signe moins devant le mot-clé).
<e>gnome gtk -kde -qt</e> compilera vos programmes avec le support pour GNOME
(et gtk), mais sans le support pour KDE (et qt). Le résultat est un système
complètement réglé pour GNOME.
</p>

<p>
Les options par défaut pour <c>USE</c> se trouvent dans les fichiers
<path>make.defaults</path> de votre profil. Vous trouverez ces fichiers
<path>make.defaults</path> dans le répertoire sur lequel le lien
<path>/etc/make.profile</path> pointe, ainsi que dans tous ses répertoires
parents. Les options par défaut de <c>USE</c> sont donc la somme de toutes les
options <c>USE</c> de ces fichiers. Vos modifications à
<path>/etc/make.conf</path> sont jugées en fonction de ces options par
défaut. Si vous ajoutez quelque chose aux options <c>USE</c>, c'est ajouté
à la liste par défaut. Si vous retirez quelque chose des options <c>USE</c>
(en le précédant du signe moins), c'est retiré de la liste par défaut (en
supposant que cela s'y trouvait). Ne modifiez <e>jamais</e> quoi que ce soit
dans le répertoire <path>/etc/make.profile</path> car ces fichiers sont écrasés
lors des mises à jour de Portage&nbsp;!
</p>

<p>
Une description complète de <c>USE</c> peut être consultée dans la seconde
partie du manuel Gentoo, <uri link="?part=2&amp;chap=2">La variable USE</uri>.
Une description complète des options disponibles se trouve dans le fichier
<path>/usr/portage/profiles/use.desc</path> qui devrait déjà être sur votre
système.
</p>

<pre caption="Afficher les options de la variable USE disponibles">
# <i>less /usr/portage/profiles/use.desc</i>
<comment>(Utilisez les flèches de votre clavier pour faire défiler le texte et</comment>
<comment>tapez 'q' pour quitter.)</comment>
</pre>

<p>
L'exemple suivant montre les options de USE pour un
système basé sur KDE avec support pour ALSA, pour les DVD et pour la
gravure de CD&nbsp;:
</p>

<pre caption="Ouverture de /etc/make.conf">
# <i>nano -w /etc/make.conf</i>
</pre>

<pre caption="Options de USE">
USE="-gtk -gnome qt kde dvd alsa cdr"
</pre>

</body>
</subsection>
<subsection>
<title>Facultatif: les «&nbsp;locales&nbsp;» de glibc</title>
<body>
<p>
Vous n'utiliserez probablement qu'une ou deux «&nbsp;locales&nbsp;» sur votre
système.  Après avoir compilé <c>glibc</c>, toutes les définitions de zone sont
créées. Vous pouvez éviter cela et ne créer que les définitions de zone qui
vous intéressent. Ajoutez l'option <c>userlocales</c> à votre variable USE et
définissez la liste des «&nbsp;locales&nbsp;» à créer dans le fichier
<path>/etc/locales.build</path>. N'utilisez cela que si vous connaissez la ou
les «&nbsp;locales&nbsp;» dont vous avez besoin. Ce système n'est pas utilisé lors
du bootstrap, mais il sera appliqué lorsque vous recompilerez glibc.
</p>

<pre caption="Utiliser l'option userlocales uniquement pour glibc">
# <i>mkdir -p /etc/portage</i>
echo "sys-libs/glibc userlocales" &gt;&gt; /etc/portage/package.use
</pre>

<p>
Ensuite, définissez les «&nbsp;locales&nbsp;» qui vous intéressent&nbsp;:
</p>

<pre caption="Ouvrir le fichier /etc/locales.build">
# <i>nano -w /etc/locales.build</i>
</pre>

<p>
L'exemple ci-dessous sélectionne l'anglais américain et le français en France
dans les encodages ISO et UTF-8.
</p>

<pre caption="Exemple de /etc/locales.build">
en_US/ISO-8859-1
en_US.UTF-8/UTF-8
fr_FR/ISO-8859-1
fr_FR@euro/ISO-8859-15
fr_FR.UTF-8/UTF-8
</pre>

</body>
</subsection>
</section>
<section>
<title>Les différences entre stage1, stage2 et stage3</title>
<body>

<p>
Prenez maintenant le temps de réfléchir aux étapes précédentes. Nous vous avons
guidé dans votre choix entre <e>stage1</e>, <e>stage2</e> et <e>stage3</e>, et
nous avons souligné que cela était important pour les étapes subséquentes. Le
choix que vous avez fait définit maintenant les étapes à suivre.
</p>

<ul>
<li>
  Si vous avez choisi le <e>stage1</e>, vous devez suivre <e>les deux</e>
  étapes décrites dans ce chapitre. Débutez par
  <uri link="#doc_chap3">Passer du stage1 au stage2</uri>.
</li>
<li>
  Si vous avez choisi le <e>stage2</e>, vous devez ignorer la première
  étape et poursuivre avec <uri link="#doc_chap4">Passer du stage2 au
  stage3</uri>.
</li>
<li>
  Si vous avez choisi le <e>stage3</e>, vous devez ignorer les deux étapes et
  passer à <uri link="?part=1&amp;chap=7"> Configurer le noyau</uri>.
</li>
</ul>

</body>
</section>
<section>
<title>Passer du stage1 au stage2</title>
<subsection>
<title>Introduction au «&nbsp;bootstrap&nbsp;»</title>
<body>

<p>
Alors, vous voulez tout compiler <e>ex nihilo</e>&nbsp;? Pourquoi pas :-)
</p>

<p>
Dans cette étape, nous réalisons le «&nbsp;bootstrap&nbsp;» de votre système Gentoo.
Cela prend un temps considérable, mais le résultat est un système optimisé dès
le départ pour votre machine et vos besoins.
</p>

<p>
Le <e>bootstrap</e> signifie que la bibliothèque C GNU, l'ensemble des
compilateurs GNU et d'autres programmes vitaux du système vont être construits.
</p>

<p>
Avant de débuter le «&nbsp;bootstrap&nbsp;», vous voudrez peut-être télécharger
toutes les sources nécessaires en une seule opération. Sinon, poursuivez avec
<uri link="#bootstrap">«&nbsp;Bootstrap&nbsp;» du système</uri>.
</p>

</body>
</subsection>
<subsection>
<title>Facultatif&nbsp;: télécharger les fichiers sources d'abord</title>
<body>

<p>
À moins que vous n'ayez déjà copié toutes les sources, le script du
«&nbsp;bootstrap&nbsp;» va télécharger les fichiers nécessaires. Si vous
préférez télécharger les sources d'abord, puis ensuite faire le
«&nbsp;bootstrap&nbsp;» du système (peut-être préférez-vous que votre connexion
à Internet ne soit pas active pendant l'installation), utilisez l'option
<e>-f</e> du script du «&nbsp;bootstrap&nbsp;», qui téléchargera alors toutes
les sources pour vous. (N.D.T.&nbsp;: f réfère au terme anglais
«&nbsp;fetch&nbsp;»).
</p>

<pre caption="Téléchargement des fichiers sources nécessaires">
# <i>cd /usr/portage</i>
# <i>scripts/bootstrap.sh -f</i>
</pre>

</body>
</subsection>
<subsection id="bootstrap">
<title>«&nbsp;Bootstrap&nbsp;» du système</title>
<body>

<p>
Maintenant, tapez les commandes suivantes pour démarrer le
«&nbsp;bootstrap&nbsp;».  Ensuite, trouvez une autre façon de vous amuser, car
cette étape prend pas mal de temps.
</p>

<pre caption="« Bootstrap » du système">
# <i>cd /usr/portage</i>
# <i>scripts/bootstrap.sh</i>
</pre>

<p>
Maintenant, poursuivez avec la prochaine étape, <uri
link="#doc_chap4">Passer du stage2 au stage3</uri>.
</p>

</body>
</subsection>
</section>
<section>
<title>Passer du stage2 au stage3</title>
<subsection>
<title>Introduction</title>
<body>

<p>
Si vous lisez cette section, vous disposez d'un système dont le «&nbsp;bootstrap&nbsp;»
est fait (soit parce que vous l'avez fait vous-même, soit parce que vous utilisez
un <e>stage2</e>). Il est maintenant temps d'installer les paquets système.
</p>

<p>
<e>Tous</e> les paquets système&nbsp;? Non, pas vraiment. Cette étape va
installer les paquets système pour lesquels il n'existe pas d'alternative.
Certains paquets offrent des alternatives (par exemple les «&nbsp;system
loggers&nbsp;»), et, puisque l'essence même de Gentoo est d'offrir des choix, rien
ne vous est imposé.
</p>

</body>
</subsection>
<subsection>
<title>Facultatif&nbsp;: visualiser ce qui va être fait</title>
<body>

<p>
Si vous voulez savoir quels paquets vont être installés, exécutez <c>emerge
--pretend --emptytree system</c>. Cela affiche une liste de tous les paquets
qui seront installés. Comme cette liste est volumineuse, vous devriez utiliser
un afficheur tel que <c>less</c> ou <c>more</c> pour la parcourir.
</p>

<pre caption="Visualiser ce que « emerge system » installera">
# <i>emerge --pretend --emptytree system | less</i>
</pre>

<p>
Si vous n'avez pas changé les variables CFLAGS/CXXFLAGS, la commande <c>emerge
--pretend --newuse system</c> suffit. Si vous n'avez pas modifié la variable
USE non plus, pourquoi passez-vous par le stage2&nbsp;?
</p>

</body>
</subsection>
<subsection>
<title>Facultatif&nbsp;: télécharger les sources</title>
<body>

<p>
Si vous voulez que <c>emerge</c> télécharge les sources avant l'installation
(peut-être préférez-vous que votre connexion à Internet ne soit pas active
pendant l'installation), utilisez l'option <e>--fetchonly</e> de <c>emerge</c>.
Les sources seront alors téléchargées pour vous.
</p>

<pre caption="Télécharger les sources">
# <i>emerge --fetchonly --emptytree system</i>
</pre>

</body>
</subsection>
<subsection>
<title>Construire le système</title>
<body>

<p>
Pour lancer la construction du système, exécutez <c>emerge --emptytree
system</c>.  Ensuite, trouvez quelque chose pour vous tenir occupé, car cette
étape est très longue.
</p>

<pre caption="Construire le système">
# <i>emerge --emptytree system</i>
</pre>

<p>
Si vous n'avez pas modifié les variables CFLAGS/CXXFLAGS, l'option
<c>--newuse</c> suffit.
</p>

<p>
Ignorez simplement les messages d'avertissement à propos de fichiers de
configuration qui devraient être mis à jour avec la commande <c>etc-update</c>.
Quand vous aurez redémarré votre nouvelle installation, veuillez consulter la
documentation à propos de la <uri
link="?part=3&amp;chap=2#doc_chap3">protection des fichiers de
configuration</uri>.

Lorsque la compilation est terminée, poursuivez votre lecture avec <uri
link="?part=1&amp;chap=7">Configurer le noyau</uri>.
</p>

</body>
</subsection>
</section>
</sections>

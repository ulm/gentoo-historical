<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/rsync.xml,v 1.1 2003/10/25 23:17:20 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fr/rsync.xml">
<title>Règles au sujet des miroirs rsync de Gentoo Linux</title>
<author title="Auteur"><mail link="mirror-admin@gentoo.org">Administrateurs du miroir Gentoo</mail></author>
<author title="Traducteur">
<mail link="mat@frheaven.com">Matthieu Montaudouin</mail>
</author>

<version>1.1</version>
<date>13 décembre 2002</date>

<abstract>
Guide et règles pour la mise en place d'un miroir rsync pour Gentoo Linux.
</abstract>
<license/>

<chapter>
<title>Conditions requises</title>
<section>
<title>Bande passante minimum</title>
<body>
<p>
Pour héberger un miroir correctement, vous devez disposer d'une bande passante d'au moins 5Mbps en full duplex.
</p>
</body>
</section>
<section>
<title>Nombre d'utilisateurs minimum</title>
<body>
<p>
Nous vous demandons de supporter un minimum de 15 connexions simultanées.
</p>
</body>
</section>
<section>
<title>Matériel minimum</title>
<body>
<p>
Afin de servir correctement au moins 15 personnes simultanément, nous vous demandons d'avoir au moins le matériel suivant&nbsp;:
</p>
<ul>
	<li>Processeur PIII 500</li>
	<li>256Mo RAM</li>
</ul>
</body>
</section>
<section>
<title>Fréquence de mise à jour</title>
<body>
<p>
Les mises à jour doivent avoir lieu à :00 et :30 toutes les heures, 24 heures sur 24.
Il est <e>très</e> important de respecter strictement cet horaire, car nous utilisons un DNS de type round robin pour sélectionner le serveur rsync de l'utilisateur.
</p> 
<impo>
Cela doit être respecté strictement, car un serveur non synchronisé, avec ce genre de configuration, génére beaucoup plus de trafic pour tous les serveurs impliqués dans le processus (cf. la FAQ incluse pour plus de détails).
</impo>
</body>
</section>
<section>
<title>MOTD (<path>/etc/rsync/rsyncd.motd</path>)</title>
<body>
<p>
Veuillez inclure les informations suivantes dans le fichier MOTD (Message Of The Day - message du jour) du rsync&nbsp;:
</p>
<ul>
	<li>Nom du serveur</li>
	<li>Adresse IP du serveur</li>
	<li>Spécifications du serveur (processeur et RAM)</li>
	<li>Bande passante utilisable du serveur</li>
	<li>Nombre d'utilisateurs maximum, si nécessaire</li>
	<li>Localisation du serveur (ville et pays)</li>
	<li>Un nom de contact et une adresse email</li>
</ul>
<p>
Mettre ces informations dans votre fichier MOTD permet d'identifier plus rapidement votre miroir en cas de problème.
</p>
</body>
</section>
</chapter>
<chapter>
<title>Détails pour la mise en place</title>
<section>
<body>
<p>
Pour installer un miroir, veuillez suivre ces étapes&nbsp;:
</p>
<ul>
	<li>
	Configurez votre miroir pour qu'il se synchronise avec un miroir rsync Gentoo Linux public existant, peu importe lequel.
	Assurez-vous de le synchroniser comme indiqué dans les <e>fréquences de mises à jour</e> ci-dessus.
	</li>
	<li>
	Remplissez un rapport de bug sur <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> qui contient le nom de votre serveur, son adresse IP, les informations concernant le contact et le fait que vous souhaitez devenir un miroir rsync.
	Nous vérifierons votre serveur pour nous assurer qu'il se synchronise correctement.
	Si votre serveur ne se synchronise pas exactement à :00 et :30, nous vous contacterons pour vous demander d'ajuster votre planification correctement.
	</li>
	<li>
	Une fois que nous aurons vérifié que le miroir se synchronise correctement, nous ajouterons l'adresse IP de votre serveur dans la liste d'accès de rsync1.us.gentoo.org.
	</li>
	<li>
	Mettez à jour votre tâche cron rsync pour que la synchronisation se fasse sur <path>rsync1.us.gentoo.org</path>.
	Nous surveillerons votre serveur durant les 48-72 heures qui suivent pour nous assurer qu'il se synchronise correctement.
	</li>
</ul>

<p>
Si toutes les étapes se sont déroulées correctement, nous ajouterons une entrée DNS officielle rsync[num].[code_pays].gentoo.org et vous ajouterons à notre round robin DNS pour rsync.gentoo.org et rsync.[code_pays].gentoo.org.
Peu de temps après avoir été ajouté à notre DNS, vous devriez commencer à voir du trafic rsync.
</p>
<p>
Qui plus est, vous, l'administrateur, serez ajouté à la mailing list gentoo-mirrors (faible trafic) afin de pouvoir suivre tous les problèmes liés aux miroirs rsync.
</p>
<note>
Merci d'aider les utilisateurs et développeurs Gentoo Linux&nbsp;!
Pour tout problème relatif à l'administration d'un serveur rsync, visitez <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> et remplissez un bug sur le produit "Rsync".
</note>
</body>
</section>
</chapter>
<chapter>
<title>Tâches parallèles</title>
<section>
<body>
<p>
Nous aurons bientôt une page créée par rrdtool qui permettra d'avoir des liens vers les graphes (triés par continent, puis par pays, puis par serveur) d'accès aux serveurs miroirs rsync officiels (ces graphes seront faits avec le résultat d'une commande sping).
Nous vérifierons ces graphes au moins une fois par jour et les machines injoignables seront enlevées de notre DNS round robin jusqu'à ce que les problèmes soient résolus.
Nous aurons des scripts qui vérifieront que toutes les 30 minutes, tous les miroirs se synchronisent bien avec nous.
</p>
<warn>
Si un miroir a régulièrement un comportement problèmatique, que l'administrateur est contacté et que la situation ne s'améliore pas, alors le miroir sera supprimé du round robin de façon permanente.
</warn>
</body>
</section>
</chapter>
<chapter>
<title>FAQ rapide</title>
<section>
<title>Q: Qui dois-je contacter pour tout ce qui concerne les problèmes et la maintenance de serveurs rsync&nbsp;?</title>
<body>
<p>R: Visitez <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> et remplissez un bug sur le produit "Rsync".</p>
</body>
</section>
<section>
<title>Q: J'utilise un miroir rsync privé pour mon entreprise. Puis-je quand même accèder à rsync1.us.gentoo.org&nbsp;?</title>
<body>
<p>R: Etant donné que nos ressources sont limitées, nous les allouons de telle sorte qu'elles bénéficient au maximum à nos utilisateurs.
Nous limitons donc les connexions à notre rsync maître et aux miroirs distfiles pour les miroirs publics seulement.
Les utilisateurs sont encouragés à utiliser notre système de miroirs normal pour établir un miroir rsync privé, il leur est donc demandé de suivre les <uri link="http://www.gentoo.org/news/en/gwn/20030505-newsletter.xml#doc_chap1_sect3">règles de bonne conduite rsync</uri>.
</p>
</body>
</section>
<section>
<title>Q: Est il important de synchroniser mon miroir à :00 et :30 toutes les heures&nbsp;?</title>
<body>
<p>R: Oui, c'est important. A chaque fois qu'un utilisateur fait un rsync sur un miroir, il obtient la différence entre ce miroir et ce qui se trouve sur son système.
Si votre miroir est différent et un utilisateur obtient un nom d'hôte du système round robin, alors vous augmentez la bande passante utilisée par l'utilisateur, par vous et par tous les autres miroirs.
Par exemple&nbsp;:
un utilisateur est configuré de telle sorte que son rsync se se fasse avec <path>rsync://rsync.gentoo.org/gentoo-portage</path>.

Supposons que <path>rsync.gentoo.org</path> est un round robin DNS pour <path>rsync1.gentoo.org</path>, <path>rsync2.gentoo.org</path> et <path>rsync3.gentoo.org</path>.

Supposons ensuite que rsync1 et rsync3 se synchronisent aux instants recommandés mais que rsync2 ne se synchronise qu'une fois à minuit et que nous sommes l'après-midi.
</p>
<ol>
<li>
L'utilisateur se synchrnoise avec rsync1 et met à jour son arbre /usr/portage. Disons que cela a nécessité 5 Mo de bande passante.
</li>
<li>
L'utilisateur se re-synchronise, cette fois-ci avec rsync2.
A ce moment là, leur arbre de portage n'est pas à jour et quelle que soit la bande passante utilisée par l'utilisateur pour mettre à jour son arbre à l'étape 1, elle est perdue.
Disons que la différence est de 5 Mo.
</li>
<li>
L'utilisateur se re-synchronise, cette fois avec rsync3, et une fois encore met à jour son arbre de portage.
Comme rsync2 avait une ancienne version, l'utilisateur doit encore une fois transférer 5 Mo.
</li>
</ol>
<p> 
Dans l'exemple ci-dessus, l'utilisateur a dû transférer 5 Mo * 3 = 15 Mo, ce qui est trois fois plus que ce qui était nécessaire. Cela donnera une mauvaise impression du système de Portage Gentoo à l'utilisateur.

De plus, rsync2 et rsync3 ont chacun transféré 5 Mo, ce qui n'aurait pas été nécessaire si rsync2 avait été à jour.

Multipliez ceci par le nombre d'utilisateurs du round robin DNS et vous verrez la quantité de bande passante gaspillée, ce qui augmente les coûts, non seulement pour votre miroir, mais pour tous les autres miroirs.

Nous comprenons que nous aurons toujours une différence de synchronisation d'horloge entre les miroirs, et chaque miroir ne se synchronisera pas exactement au même moment. Afin de garder cet écart le plus faible possible, nous vous encourageons à utiliser un démon NTP.

Si cela ne vous paraît pas une raison suffisante, sachez que vos logs auront plus d'importance vis à vis de la loi si vous pouvez prouver que l'heure de votre système est correcte et synchronisée avec le reste du monde.

Si vous ne voulez pas faire tourner ntpd tout le temps, exécutez ntpdate au moins une fois par jour avec cron.
</p>
</body>
</section>
<section>
<title>Q: Comment puis-je trouver le miroir le plus proche de chez moi&nbsp;?
</title>
<body>
<p>R: netselect a été conçu pour faire cela à votre place.
Si vous n'avez pas encore fait <c>emerge netselect</c>, alors faites-le.
Exécutez ensuite <c>netselect rsync.gentoo.org</c>. Après une minute environ, netselect vous indiquera une adresse IP.
Notez cette adresse et utilisez-la comme seul paramètre pour rsync en lui accolant deux "deux points", par exemple <c>rsync 1.2.3.4::</c>.
Vous devriez être capable de trouver quel est ce miroir par son MOTD. Adaptez ensuite votre /etc/make.conf selon ces nouvelles informations.
</p>
</body>
</section>
<section>
<title>Q: Puis-je utiliser la compression quand je me synchronise avec rsync1.us.gentoo.org&nbsp;?</title>
<body>
<p>R: Non.  
La compression utilise trop de ressources sur le serveur, nous l'avons donc désactivée sur rsync1.us.gentoo.org.
S'il vous plaît <b>n'utilisez pas</b> la compression quand vous vous synchronisez avec ce serveur.
</p>
</body>
</section>
</chapter>
<chapter>
<title>Exemples de scripts</title>
<section>
<body>
<p>
Actuellement, faire un miroir de notre arbre de Portage ne demande qu'environ 60 Mo d'espace disque. Avoir 200 Mo de libre devrait permettre de voir venir.
Mettre en place un miroir de l'arbre de Portage est simple, tout d'abord assurez vous que rsync est installé sur votre miroir, puis configurez votre fichier rsyncd.conf pour qu'il ressemble à ceci&nbsp;:
</p>
<pre caption="rsyncd.conf">
#uid = nobody
#gid = nobody
use chroot = no
max connections = 20
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#pour des raisons de compatibilité
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree


[gentoo-portage]
#les versions modernes de portage utilisent cette section
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>
<p>
Ci-dessus, le miroir gentoo-x86-portage pointe vers les mêmes données que gentoo-portage.
Bien que nous ayons récemment changé le nom officiel de notre miroir en gentoo-portage, il est encore nécessaire de garder gentoo-x86-portage pour des raisons de compatibilité, indiquez donc les deux sections.
</p>
<p>
Maintenant, vous avez besoin de construire un miroir de l'arbre de Portage de Gentoo Linux.
Vous pouvez utiliser le script suivant pour cela:
</p>
<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=600"
#décommentez la ligne suivante seulement si vous avez obtenu un accès à rsync1.us.gentoo.org
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#Si vous attendez l'accès à notre miroir maître, sélectionnez un de nos miroirs publics:
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Mise à jour commencée à" `date` >> $0.log 2>&amp;1
logger -t rsync "Mise à jour de l'arbre de Portage Gentoo"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "Fin: "`date` >> $0.log 2>&amp;1 
</pre>
<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2 or later
# $Header: /home/cvsroot/gentoo-x86/net-misc/rsync/files/rsyncd.init.d,v 1.1 2003/02/22 22:41:09 vapier Exp &#36;

depend() {
need net
}

# Pour votre information: --sparce semble causer des problèmes.
RSYNCOPTS="--daemon --safe-links --timeout=1800"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>
<p>
Votre fichier rsyncd.motd devrait contenir votre adresse IP et d'autres informations utiles sur votre miroir, comme l'hôte fournissant le miroir Portage et un moyen de contacter l'administrateur.
Après avoir été approuvé comme serveur miroir rsync officiel, votre hôte recevra un alias de la forme:
<path>rsync[num].[code_pays].gentoo.org</path>
</p>
</body>
</section>
</chapter>
</guide>

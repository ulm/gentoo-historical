<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/rsync.xml,v 1.10 2004/06/29 10:15:39 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fr/rsync.xml" lang="fr">
<title>Règles au sujet des miroirs rsync de Gentoo Linux</title>

<author title="Auteurs">
  <mail link="mirror-admin@gentoo.org">Administrateurs du miroir Gentoo</mail>
</author>
<author title="Traducteur">
  <mail link="mat@frheaven.com">Matthieu Montaudouin</mail>
</author>

<abstract>
Guide et règles pour la mise en place d'un miroir rsync pour Gentoo Linux.
</abstract>

<license/>

<version>1.4</version>
<date>28 juin 2004</date>

<chapter>
<title>Conditions requises</title>
<section>
<title>Bande passante minimum</title>
<body>

<p>
Pour héberger un miroir correctement, vous devez disposer d'une bande passante
d'au moins 5&nbsp;Mbps en «&nbsp;full duplex&nbsp;».
</p>

</body>
</section>
<section>
<title>Nombre d'utilisateurs minimum</title>
<body>

<p>
Nous vous demandons de supporter un minimum de 15 connexions simultanées.
</p>

</body>
</section>
<section>
<title>Matériel minimum</title>
<body>

<p>
Afin de servir correctement au moins 15 personnes simultanément, nous vous
demandons d'avoir au moins le matériel suivant&nbsp;:
</p>

<ul>
  <li>Processeur PIII 500</li>
  <li>256Mo RAM</li>
</ul>
</body>
</section>
<section>
<title>Fréquence de mise à jour</title>
<body>

<p>
Les mises à jour doivent avoir lieu à :00 et :30 toutes les heures, 24 heures
sur 24.  Il est <e>très</e> important de respecter strictement cet horaire, car
nous utilisons un DNS de type round robin pour sélectionner le serveur rsync de
l'utilisateur.
</p> 

</body>
</section>
<section>
<title>MOTD (/etc/rsync/rsyncd.motd)</title>
<body>

<p>
Veuillez inclure les informations suivantes dans le fichier MOTD (Message Of
The Day - message du jour) du rsync&nbsp;:
</p>

<ul>
  <li>Nom du serveur</li>
  <li>Adresse IP du serveur</li>
  <li>Spécifications du serveur (processeur et RAM)</li>
  <li>Bande passante utilisable du serveur</li>
  <li>Nombre d'utilisateurs maximum, si nécessaire</li>
  <li>Emplacement du serveur (ville et pays)</li>
  <li>Un nom de contact et une adresse courrier électronique</li>
</ul>

<p>
Mettre ces informations dans votre fichier MOTD permet d'identifier plus
rapidement votre miroir en cas de problème.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Détails pour la mise en place</title>
<section>
<body>

<p>
Pour installer un miroir, veuillez suivre ces étapes&nbsp;:
</p>
<ul>
  <li>
    Configurez votre miroir pour qu'il se synchronise avec un miroir rsync
    Gentoo Linux public existant, peu importe lequel.  Assurez-vous de le
    synchroniser comme indiqué dans les <e>fréquences de mises à jour</e>
    ci-dessus.
  </li>
  <li>
    Remplissez un rapport de bogue sur <uri
    link="http://bugs.gentoo.org">bugs.gentoo.org</uri> qui contient le nom de
    votre organisation, celui de votre serveur, son adresse IP, les
    informations concernant le contact et le fait que vous souhaitez devenir un
    miroir rsync.  Nous vérifierons votre serveur pour nous assurer qu'il se
    synchronise correctement. Votre serveur doit se synchroniser deux fois par
    heure, entre :00 et :10, et entre :30 et :40, vous pouvez décider de
    l'heure exacte dans ces fenêtres.  Nous vous contacterons pour vous
    demander d'ajuster votre planification correctement.
  </li>
  <li>
    Une fois que nous aurons vérifié que le miroir se synchronise correctement,
    nous ajouterons l'adresse IP de votre serveur dans la liste d'accès de
    rsync1.us.gentoo.org.
  </li>
  <li>
    Mettez à jour votre tâche cron rsync pour que la synchronisation se fasse
    sur <path>rsync1.us.gentoo.org</path>.  Nous surveillerons votre serveur
    durant les 48-72 heures qui suivent pour nous assurer qu'il se synchronise
    correctement.
  </li>
</ul>

<p>
Si toutes les étapes se sont déroulées correctement, nous ajouterons une entrée
DNS officielle rsync[num].[code_pays].gentoo.org et vous ajouterons à notre
round robin DNS pour rsync.[code_continent].gentoo.org et
rsync.[code_pays].gentoo.org.  Peu de temps après avoir été ajouté à notre DNS,
vous devriez commencer à voir du trafic rsync.
</p>

<p>
Qui plus est, vous, l'administrateur, serez ajouté à la mailing list
gentoo-mirrors (faible trafic) afin de pouvoir suivre tous les problèmes liés
aux miroirs rsync.
</p>

<note>
Merci d'aider les utilisateurs et développeurs Gentoo Linux&nbsp;!  Pour tout
problème relatif à l'administration d'un serveur rsync, visitez <uri
link="http://bugs.gentoo.org">bugs.gentoo.org</uri> et remplissez un bogue sur
le produit "Rsync".
</note>

</body>
</section>
</chapter>

<chapter>
<title>Tâches parallèles</title>
<section>
<body>

<p>
Nous aurons bientôt une page créée par rrdtool qui permettra d'avoir des liens
vers les graphes (triés par continent, puis par pays, puis par serveur) d'accès
aux serveurs miroirs rsync officiels (ces graphes seront faits avec le résultat
d'une commande sping).  Nous vérifierons ces graphes au moins une fois par jour
et les machines injoignables seront enlevées de notre DNS round robin jusqu'à
ce que les problèmes soient résolus.  Des scripts vérifieront toutes les 30
minutes que tous les miroirs se synchronisent bien avec nous.
</p>

<warn>
Si un miroir a régulièrement un comportement problèmatique, que
l'administrateur est contacté et que la situation ne s'améliore pas, alors le
miroir sera supprimé du round robin de façon permanente.
</warn>

</body>
</section>
</chapter>

<chapter>
<title>FAQ rapide</title>
<section>
<title>Q: Qui dois-je contacter pour tout ce qui concerne les problèmes et la
maintenance de serveurs rsync&nbsp;?</title>
<body>

<p>
R: Visitez <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> et
remplissez un bogue sur le produit "Rsync".
</p>
</body>
</section>
<section>
<title>Q: J'utilise un miroir rsync privé pour mon entreprise. Puis-je quand
même accèder à rsync1.us.gentoo.org&nbsp;?</title>
<body>

<p>
R: Etant donné que nos ressources sont limitées, nous les allouons de telle
sorte qu'elles bénéficient au maximum à nos utilisateurs.  Nous limitons donc
les connexions à notre rsync maître et aux miroirs distfiles pour les miroirs
publics seulement.  Les utilisateurs sont encouragés à utiliser notre système
de miroirs normal pour établir un miroir rsync privé&nbsp;; il leur est donc
demandé de suivre les <uri
link="http://www.gentoo.org/news/en/gwn/20030505-newsletter.xml#doc_chap1_sect3">règles
de bonne conduite rsync</uri>.
</p>

</body>
</section>
<section>
<title>Q: Est-il important de synchroniser mon miroir deux fois par heure&nbsp;?</title>
<body>

<p>
R: Oui, c'est important. Votre miroir doit se synchroniser deux fois par heure
dans les fenêtres ci-dessous&nbsp;:
</p>

<ol>
  <li>entre :00 et :10</li>
  <li>entre :30 et :40</li>
</ol>

<p>
Veuillez aussi synchroniser aux mêmes minutes, par exemple :08 et :38, pour
garantir une synchronisation toutes les trente minutes.
</p>

</body>
</section>
<section>
<title>Q: Comment puis-je trouver le miroir le plus proche de chez moi&nbsp;?
</title>
<body>

<p>
R: netselect a été conçu pour faire cela à votre place.  Si vous n'avez pas
encore fait <c>emerge netselect</c>, alors faites-le.  Exécutez ensuite
<c>netselect rsync.gentoo.org</c>. Après une minute environ, netselect vous
indiquera une adresse IP.  Notez cette adresse et utilisez-la comme seul
paramètre pour rsync en lui accolant deux "deux points", par exemple <c>rsync
1.2.3.4::</c>.  Vous devriez être capable de trouver quel est ce miroir par son
MOTD. Adaptez ensuite votre /etc/make.conf selon ces nouvelles informations.
</p>
</body>
</section>
<section>
<title>Q: Puis-je utiliser la compression quand je me synchronise avec
rsync1.us.gentoo.org&nbsp;?</title>
<body>

<p>
R: Non.  La compression utilise trop de ressources sur le serveur, nous l'avons
donc désactivée sur rsync1.us.gentoo.org.  S'il vous plaît <b>n'utilisez
pas</b> la compression quand vous vous synchronisez avec ce serveur.
</p>

</body>
</section>
<section>
<title>Q: Comment éliminer les processus rsync morts&nbsp;?</title>
<body>

<p>
R: Voyez la section «&nbsp;Exemples de scripts&nbsp;».
</p>

</body>
</section>
<section>
<title>Q: Des utilisateurs se connectent très féquemment sur mon miroir et
causent parfois un déni de service. Comment empêcher cela&nbsp;?</title>
<body>

<p>
R: Voyez la section «&nbsp;Exemples de scripts&nbsp;».
</p>
</body>
</section>
</chapter>

<chapter>
<title>Exemples de scripts</title>
<section>
<body>

<p>
Actuellement, faire un miroir de notre arbre de Portage ne demande qu'environ
250&nbsp;Mo d'espace disque. Avoir 500 Mo de libre devrait permettre de voir
venir.  Mettre en place un miroir de l'arbre de Portage est simple&nbsp;; tout
d'abord, assurez-vous que rsync est installé sur votre miroir, puis configurez
votre fichier rsyncd.conf pour qu'il ressemble à ceci&nbsp;:
</p>

<pre caption="rsyncd.conf">
uid = nobody
gid = nobody
use chroot = yes
max connections = 15
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
log file = /var/log/rsync.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
# Pour des raisons de compatibilité
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree

[gentoo-portage]
# Les versions modernes de portage utilisent cette section.
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>

<p>
Ci-dessus, le miroir gentoo-x86-portage pointe vers les mêmes données que
gentoo-portage.  Bien que nous ayons récemment changé le nom officiel de notre
miroir en gentoo-portage, il est encore nécessaire de garder gentoo-x86-portage
pour des raisons de compatibilité&nbsp;; indiquez donc les deux sections.
</p>

<p>
Pour des raisons de sécurité, l'utilisation d'un environnement chroot est
imposée.
</p>

<p>
Maintenant, vous avez besoin de construire un miroir de l'arbre de Portage de
Gentoo Linux.  Vous pouvez utiliser le script suivant pour cela:
</p>

<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=300"
# Décommentez la ligne suivante seulement si vous avez obtenu un accès à rsync1.us.gentoo.org.
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
# Si vous attendez l'accès à notre miroir maître, sélectionnez un de nos miroirs publics :
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Mise à jour commencée à" `date` >> $0.log 2>&amp;1
logger -t rsync "Mise à jour de l'arbre de Portage Gentoo"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "Fin: "`date` >> $0.log 2>&amp;1 
</pre>

<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2 or later
# $Header: /home/cvsroot/gentoo-x86/net-misc/rsync/files/rsyncd.init.d,v 1.1 2003/02/22 22:41:09 vapier Exp &#36;

depend() {
need net
}

# Pour votre information: --sparce semble causer des problèmes.
RSYNCOPTS="--daemon --safe-links --timeout=300"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>

<p>
Votre fichier rsyncd.motd devrait contenir votre adresse IP et d'autres
informations utiles sur votre miroir, comme l'hôte fournissant le miroir
Portage et un moyen de contacter l'administrateur.  Après avoir été approuvé
comme serveur miroir rsync officiel, votre hôte recevra un alias de la forme:
<path>rsync[num].[code_pays].gentoo.org</path>
</p>

<p>
La commande suivante vous permet de supprimer les vieux processus rsync qui
traînent à cause de problèmes de connexion. Il est important de les supprimer,
car ils comptent pour appliquer la limite sur le nombre maximum de connexions.
Vous devriez exécuter cette commande toutes les heures via cron. Elle supprime
les connexions établies depuis plus d'une heure.
</p>

<pre caption="Supprimer les processus rsync inactifs">
/bin/kill -9 `/bin/ps --no-headers -Crsync -o etime,user,pid,command|/bin/grep nobody | \
          /bin/grep "[0-9]\{2\}:[0-9]\{2\}:" |/bin/awk '{print $3}'`
</pre>

<p>
Parfois, certains utilisateurs indélicats abusent des miroirs en synchronisant
plus d'une à deux fois par jour. Dans des cas extrêmes, des utilisateurs
lancent un rsync toutes les 15 minutes. Cela provoque souvent un déni de
service et occupe une connexion qui pourrait être utilisée par un autre
utilisateur. Pour essayer de bloquer ces utilisateurs, vous pouvez essayer ce
<uri link="/proj/en/infrastructure/mirrors/rsyncd.conf_pl.txt">script
perl</uri> qui détecte les IP qui ont établi plus de N connexions dans la
journée et crée un fichier rsyncd.conf qui leur bloque l'accès.  La ligne
suivante utilise une valeur N de 4 connexions&nbsp;:
</p>

<pre caption="Détecter les adresses IP qui abusent du rsync">
@badhosts=grep {$hash{$_}>4} keys %hash;
</pre>

<p>
Si vous utilisez ce script, n'oubliez pas d'effectuer une rotation quotidienne
de vos fichiers de journaux («&nbsp;logs&nbsp;») et définissez le chemin vers
votre fichier rsyncd.conf. Le script a été testé sur Gentoo, mais devrait
fonctionner dans d'autres environnements qui supportent rsync et perl.
</p>

</body>
</section>
</chapter>
</guide>

<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/lvm2.xml,v 1.5 2004/09/01 15:18:05 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fr/lvm2.xml" lang="fr">
<title>Installation de LMV2 sur Gentoo Linux</title>
<author title="Auteur">
  <mail link="avi@CFFtechnologies.com">Avi Schwartz</mail>
</author>
<author title="Contributeur">
  <mail link="rajiv@gentoo.org">Rajiv Manglani</mail>
</author>
<author title="Correcteur">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Traducteur">
  <mail link="ribosome@gentoo.org">Olivier Fisette</mail>
</author>

<abstract>
Ce guide décrit comment configurer votre système Gentoo pour utiliser le
gestionnaire de volumes logiques, version 2 (en anglais 
«&nbsp;Logical Volume Manager&nbsp;» ou LVM2).
</abstract>

<license/>

<version>2.0.3</version>
<date>29 août 2004</date>

<chapter>
<title>Introduction</title>
<section>
<body>

<p>
Ce guide est basé sur un exemple utilisant deux disques durs IDE. Cela signifie
que vous devrez très probablement changer le disque, les noms et les tailles
des partitions afin de refléter vos propres besoins et ressources matérielles.
</p>

<warn>
Ce document n'a pas l'ambition d'être un tutoriel pour LVM2&nbsp;; il s'agit 
d'un supplément à la procédure d'installation de Gentoo Linux décrite dans la 
<uri link="/doc/fr/handbook/handbook-x86.xml?part=1&amp;chap=0">première partie du
Manuel Gentoo</uri>. Assurez-vous de <c>lire</c> le Manuel d'installation
de Gentoo <c>avant</c> de débuter le processus d'installation.
</warn>

<note>
Si vous cherchez un HOWTO complet pour LVM, pointez votre navigateur vers
<uri>http://tldp.org/HOWTO/LVM-HOWTO</uri>.
</note>

</body>
</section>
<section>
<title>Pré-requis</title>
<body>

<p>
Si vous faites une nouvelle installation de Gentoo, vous aurez besoin d'un CD
amorçable avec support pour LVM2 tel que le LiveCD Gentoo. Vous trouverez le
LiveCD pour l'architecture x86 sur nos <uri
link="/main/en/mirrors.xml">miroirs</uri> dans le répertoire
<path>/releases/x86/2004.0/livecd/universal</path>. D'autres architectures sont
peut-être aussi supportées.
</p>

<p>
Si vous installez LVM2 sur un système déjà configuré et disposant d'espace
disque libre, vous devrez activer le module LVM2 (<path>dm-mod</path>). Ce
dernier est disponible dans <path>gentoo-sources</path>,
<path>development-sources</path> et <path>gentoo-dev-sources</path>. La
compilation du noyau et la mise en place de LVM2 sont couverts plus loin dans
ce guide.
</p>

</body>
</section>
<section>
<title>Partitions</title>
<body>

<p>
Dans cet exemple, notre système hypothétique comprend deux disques durs IDE qui
seront partitionnés comme suit&nbsp;:
</p>

<ul>
  <li>/dev/hda1  --  /boot</li>
  <li>/dev/hda2  --  Partition de mémoire virtuelle</li>
  <li>/dev/hda3  --  /</li>
  <li>/dev/hda4  --  Partition qui sera utilisée par LVM2</li>
  <li>/dev/hdb1  --  Partition qui sera utilisée par LVM2</li>
</ul>

<impo>
Portez une attention particulière aux noms des partitions car il est facile de
confondre les a et les b, ainsi que les numéros des partitions. Un seul faux
mouvement pourrait balayer la mauvaise partition. Vous êtes prévenu&nbsp;!
</impo>

<p>
Maintenant, il est temps de se lancer...
</p>

</body>
</section>
</chapter>

<chapter>
<title>Installation</title>
<section>
<body>

<p>
Suivez les directives du Manuel jusqu'au chapitre 4 (<c>Préparer les
disques).</c>
</p>

<p>
Employez <c>fdisk</c> tel que décrit dans le Manuel, mais utilisez l'exemple
ci-dessus pour établir votre plan de partitionnement. Ce n'est toutefois
<e>qu'un exemple</e>&nbsp;; adaptez-le à vos besoins.
</p>

<p>
Créez une petite partition physique (hda1) pour /boot. Dans cet exemple, /boot
ne sera pas géré par LVM2. Cette partition contiendra votre chargeur de
démarrage («&nbsp;bootloader&nbsp;») et votre (ou vos) noyau(x). Une partition
de 64&nbsp;Mo devrait être suffisante pour quelques générations de noyaux.
</p>

<p>
Créez une partition (hda2) de mémoire virtuelle et activez-la.
</p>

<pre caption="Activer la partition de mémoire virtuelle">
# <i>mkswap /dev/hda2</i>
# <i>swapon /dev/hda2</i>
</pre>

<p>
Créez une partition (hda3) pour / (la racine). Si vous voulez essayer
d'utiliser une partition racine gérée par LVM (ce que nous ne recommandons
pas), consultez la section ressources à la fin de ce guide. Vous y trouverez un
lien vers un mini-HOWTO expliquant comment y parvenir. La taille de la
partition racine peut être relativement petite si elle ne doit pas contenir les
répertoires suivants&nbsp;: <path>/opt /usr /home /var</path> et
<path>/tmp</path>. Dans ce cas, 150&nbsp;Mo devraient suffire.
</p>

<note>
Il n'est <b>pas</b> recommandé de mettre les répertoires suivants dans une
partition LVM2&nbsp;: <path>/etc</path> , <path>/lib</path> , <path>/mnt</path>
, <path>/proc</path> , <path>/sbin</path> , <path>/dev</path> et
<path>/root</path>.  Si vous suivez ce conseil, vous serez toujours capable de
vous connecter à votre système si quelque chose devait très mal tourner. (Bien
que mutilé, il serait à peu près utilisable pour l'utilisateur root.)
</note>

<p>
En supposant que la partition de mémoire virtuelle, la partition racine et la
partition /boot n'occupent pas l'entièreté de l'espace disque, créez une
quatrième partition sur ce disque. Utilisez le type 8e (Linux LVM). Si vous
avez d'autres disques durs, créez une partition de type 8e sur chacun.
</p>

<note>
Considérant la taille énorme des disques actuels, vous souhaiterez peut-être
séparer vos disques en petites partitions plutôt que de créer une seule
grosse partition qui serait ajoutée en un bloc à LVM2. Après tout, LVM2
vous permet justement d'augmenter facilement la taille des volumes. Cela vous
laissera de l'espace non utilisé dont vous aurez peut-être besoin à l'extérieur
du groupe LVM2. En résumé, n'utilisez pas votre espace disque avant de savoir
que vous en avez besoin. À titre d'exemple, un de nos contributeurs possédant un
disque dur de 160&nbsp;Go l'a scindé en 8 partitions de 20&nbsp;Go chacune.
</note>

<p>
Chargez le module LVM2 <path>dm-mod</path>. Pour une raison obscure, ce module
a été compilé dans le noyau 2.6 (nommé <c>smp</c>) sur le LiveCD Gentoo. Si
vous utilisez ce noyau à la place du noyau 2.4 par défaut (nommé
<c>gentoo</c>), vous pouvez passer cette étape ou ignorer les avertissements
que vous obtiendrez.
</p>

<pre caption="Charger le module LVM2">
# <i>modprobe dm-mod</i>
</pre>

<p>
Scannez et activez LVM&nbsp;:
</p>

<pre caption="Activer LVM">
<comment>(Empêcher lvm2 d'accéder à votre lecteur de CD-ROM.)</comment>
# <i>echo 'devices { filter=["r/cdrom/"] }' >/etc/lvm/lvm.conf</i>
# <i>vgscan</i>
  Reading all physical volumes.  This may take a while...
  No volume groups found
</pre>

<p>
Préparez vos partitions&nbsp;:
</p>

<pre caption="Préparer les partitions">
# <i>pvcreate /dev/hda4 /dev/hdb1</i>
  No physical volume label read from /dev/hda4
  Physical volume "/dev/hda4" successfully created
  No physical volume label read from /dev/hdb1
  Physical volume "/dev/hdb1" successfully created
</pre>

<p>
Configurez un groupe de volumes. Un groupe de volumes est le résultat de la
fusion de plusieurs unités physiques en un seul disque logique.
</p>

<p>
Dans notre exemple, <path>/dev/hda1</path>, <path>/dev/hda2</path> et
<path>/dev/hda3</path> sont les partitions dédiées respectivement à /boot, à la
mémoire virtuelle et à la racine. Nous devons donc combiner 
<path>/dev/hda4</path> et <path>/dev/hdb1</path>. Cela peut être fait en une
seule commande mais, à titre d'exemple, nous créerons d'abord le groupe de
volumes avant de l'étendre.
</p>

<pre caption="Créer et étendre un groupe de volumes">
<comment>(Créez un groupe de volumes nommé vg.)</comment>
# <i>vgcreate vg /dev/hda4</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignorez cet avertissement.)</comment>
  Volume group "vg" successfully created
<comment>(Étendez le nouveau groupe de volumes.)</comment>
# <i>vgextend vg /dev/hdb1</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignorez à nouveau cet avertissement, et faites de même par la suite.)</comment>
  Volume group "vg" successfully extended
</pre>

<p>
Créez les volumes logiques. Ces volumes logiques sont l'équivalent des
partitions que vous créeriez avec fdisk dans un environnement non LVM2. Dans
notre exemple, les partitions suivantes sont créées&nbsp;:
</p>

<table>
<tr>
  <th>Répertoire</th>
  <th>Taille</th>
</tr>
<tr>
  <ti>/usr</ti>
  <ti>10 Go</ti>
</tr>
<tr>
  <ti>/home</ti>
  <ti>5 Go</ti>
</tr>
<tr>
  <ti>/opt</ti>
  <ti>5 Go</ti>
</tr>
<tr>
  <ti>/var</ti>
  <ti>10 Go</ti>
</tr>
<tr>
  <ti>/tmp</ti>
  <ti>2 Go</ti>
</tr>
</table>

<p>
Puisque nous utiliserons LVM2, il n'est pas nécessaire de se creuser la tête
trop longtemps pour choisir les tailles des partitions puisqu'il sera toujours
possible de les étendre selon les besoins.
</p>

<note>
Tel que souligné par Terje Kvernes, il est plus facile d'agrandir une partition
que de la rapetisser. Vous voudrez donc probablement débuter avec de petites
partitions, puis augmenter leur taille lorsque nécessaire.
</note>

<pre caption="Créer et étendre les volumes logiques">
# <i>lvcreate -L10G -nusr  vg</i>
  Logical volume "usr" created <comment>(Les messages semblables ne seront pas retranscrits désormais.)</comment>
# <i>lvcreate -L5G  -nhome vg</i>
# <i>lvcreate -L5G  -nopt  vg</i>
# <i>lvcreate -L10G -nvar  vg</i>
# <i>lvcreate -L2G  -ntmp  vg</i>
<comment>(À titre d'exemple, ajoutons 5 Go à un volume logique.)</comment>
# <i>lvextend -L+5G /dev/vg/home</i>
</pre>

<p>
Créez les systèmes de fichiers sur les volumes logiques, en procédant comme vous
le feriez pour une partition standard. Nous utilisons ici ext3 sur les volumes
logiques, mais vous pouvez utiliser le système de fichiers de votre choix.
</p>

<pre caption="Créer les systèmes de fichiers">
# <i>mke2fs -j /dev/vg/usr</i>
# <i>mke2fs -j /dev/vg/home</i>
# <i>mke2fs -j /dev/vg/opt</i>
# <i>mke2fs -j /dev/vg/var</i>
# <i>mke2fs -j /dev/vg/tmp</i>
</pre>

<p>
Montez vos partitions tel que décrit dans le Manuel et montez vos volumes
logiques LVM comme s'ils étaient des partitions. Remplacez le classique
<path>/dev/hdxx</path> par <path>/dev/vg/nom_du_volume_logique</path>.
</p>

<pre caption="Monter les volumes logiqes">
<comment>(Assurez-vous que votre partition racine a été montée d'abord, tel que décrit dans le Manuel.)</comment>
# <i>mkdir /mnt/gentoo/usr</i>
# <i>mount /dev/vg/usr /mnt/gentoo/usr</i>
# <i>mkdir /mnt/gentoo/home</i>
# <i>mount /dev/vg/home /mnt/gentoo/home</i>
# <i>mkdir /mnt/gentoo/opt</i>
# <i>mount /dev/vg/opt /mnt/gentoo/opt</i>
# <i>mkdir /mnt/gentoo/var</i>
# <i>mount /dev/vg/var /mnt/gentoo/var</i>
# <i>mkdir /mnt/gentoo/tmp</i>
# <i>mount /dev/vg/tmp /mnt/gentoo/tmp</i>
</pre>

<note>
Le reste des instructions d'installation du Manuel ne change pas
significativement. Par conséquent, nous ne reprendrons pas chaque étape, mais
soulignerons plutôt les différences.
</note>

<p>
Lorsque vous configurez votre noyau, soyez certain d'activer le support pour
LVM2 (tous les noyaux 2.4.x ne supportent pas LVM2.) Sélectionnez le module
LVM2 comme suit&nbsp;:
</p>

<pre caption="Sélectionner le module LVM2 dans un noyau 2.4.x">
Multi-device support (RAID and LVM)  ---&gt;
  [*] Multiple devices driver support (RAID and LVM)
  &lt; &gt;  RAID support
<comment>(Notez que LVM est désélectionné à dessein&nbsp;; c'était pour LVM1.)</comment>
  &lt; &gt;  Logical volume manager (LVM) support
  &lt;M&gt;  Device-mapper support
  &lt; &gt;   Mirror (RAID-1) support
</pre>

<pre caption="Sélectionner le module LVM2 dans un noyau 2.6.x">
Device Drivers  ---&gt;
 Multi-device support (RAID and LVM)  ---&gt;
   [*] Multiple devices driver support (RAID and LVM)
   &lt; &gt;   RAID support
   &lt;M&gt;   Device mapper support
</pre>

<p>
Le module compilé se nomme <path>dm-mod.ko</path>.
</p>

<p>
Après avoir compilé votre noyau et installé ses modules, ajoutez la ligne
suivante à votre <path>/etc/modules.autoload.d/kernel-{KV}</path> où {KV}
représente la version de votre noyau (2.4 ou 2.6), afin que le module LVM2
soit chargé lors de l'amorçage de votre système&nbsp;:
</p>

<pre caption="Ajouter l'information sur les modules LVM2 dans/etc/modules.autoload.d/kernel-2.6">
# <i>nano -w /etc/modules.autoload.d/kernel-2.6</i>
<comment>(Ajoutez la ligne suivante.)</comment>
dm-mod
</pre>

<p>
Maintenant, installez le paquet logiciel lvm2.
</p>

<impo>
Assurez-vous que <path>/usr/src/linux</path> pointe vers les sources du noyau
que vous utilisez car l'ebuild lvm2 dépend de l'ebuild device-mapper qui, lui,
vérifiera la présence d'un fichier nécessaire situé dans
<path>/usr/src/linux/include/linux</path>.
</impo>

<pre caption="Installer le paquet lvm2">
# <i>emerge lvm2</i>
<comment>(Empêcher lvm2 d'accéder à votre lecteur de CD-ROM.)</comment>
# <i>echo 'devices { filter=["r/cdrom/"] }' >> /etc/lvm/lvm.conf</i>
</pre>

<p>
Pour l'édition du fichier <path>/etc/fstab</path>, suivez les directives du
Manuel et ajoutez vos volumes logiques LVM2 tel que désiré. Voici les quelques
lignes nécessaires pour notre exemple&nbsp;:
</p>

<pre caption="Extrait de /etc/fstab">
/dev/hda1     /boot   ext3    noauto,noatime 1 1
/dev/hda2     none    swap    sw             0 0
/dev/hda3     /       ext3    noatime        0 0
# Volumes logiques
/dev/vg/usr   /usr    ext3    noatime        0 0
/dev/vg/home  /home   ext3    noatime        0 0
/dev/vg/opt   /opt    ext3    noatime        0 0
/dev/vg/var   /var    ext3    noatime        0 0
/dev/vg/tmp   /tmp    ext3    noatime        0 0
</pre>

<p>
Lorsque vous aurez atteint la fin de l'installation telle que décrite dans le
Manuel, n'oubliez pas de démonter tous vos volumes logiques LVM2 et, pour faire
bonne mesure, exécutez la commande suivante avant de redémarrer&nbsp;:
</p>

<pre caption="Fermer LVM2">
# <i>vgchange -an</i>
</pre>

<p>
Redémarrez votre machine. Toutes les partitions devraient être visibles et
montées.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Ressources</title>
<section>
<body>

<ul>
  <li>
    Le <uri link="http://sources.redhat.com/lvm2">site Web LVM2</uri> officiel.
  </li>
  <li>Le <uri link="http://tldp.org/HOWTO/LVM-HOWTO">HOWTO LVM</uri>.</li>
  <li>
    Les articles de Daniel Robbins sur LVM, disponibles sur IBM's
    DeveloperWorks&nbsp;:
    <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm/?dwzone=linux</uri>
    et <uri>
    http://www-106.ibm.com/developerworks/linux/library/l-lvm2.html?dwzone=linux</uri>.
  </li>
  <li>
    Comment démarrer votre système de fichiers racine à partir de LVM1&nbsp;:
    <uri>http://www.the-infinite.org/archive/docs/lvm/howto-boot-off-root-lv.txt</uri>.
  </li>
</ul>

</body>
</section>
</chapter>

<chapter>
<title>Remerciements</title>
<section>
<body>

<p>
Merci à <mail link="bangert@gentoo.org">Thilo Bangert</mail> et <mail
link="terjekv@math.uio.no">Terje Kvernes</mail> pour leur aide et leurs 
commentaires à propos de ce document.
</p>

</body>
</section>
</chapter>
</guide>

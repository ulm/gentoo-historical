<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/migration-to-2.6.xml,v 1.9 2005/04/07 23:12:30 neysx Exp $ -->

<guide link="/doc/fr/migration-to-2.6.xml" lang="fr">

<title>Le guide Gentoo exhaustif pour la migration vers Linux 2.6</title>

<author title="Auteur">
  <mail link="dsd@gentoo.org">Daniel Drake</mail>
</author>
<author title="Contributeur">
  <mail link="sergey_zlodey@mail.ru">Sergey Galkin</mail>
</author>
<author title="Contributeur">
  <mail link="svyatogor@gentoo.org">Sergey Kuleshov</mail>
</author>
<author title="Correcteur">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Correcteur">
  <mail link="bennyc@gentoo.org">Benny Chuang</mail>
</author>
<author title="Traducteur">
  <mail link="ribosome@gentoo.org">Olivier Fisette</mail>
</author>
<author title="Traducteur">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>

<abstract>
Ce document vous assistera dans le processus de migration de Linux 2.4 vers
Linux 2.6, de devfs vers udev, d'OSS vers ALSA et de LVM vers LVM2.
</abstract>

<version>0.2.6</version>
<date>2005-04-07</date>

<chapter>
<title>Introduction</title>

<section>
<title>Qu'y a-t-il de nouveau dans Linux 2.6&nbsp;?</title>
<body>

<p>
Voilà une question à laquelle il n'est pas facile de répondre. Linux 2.6 est le
résultat de plus de deux ans de développement et de stabilisation de nouvelles
fonctionnalités. Du point de vue de l'architecture, il diffère
significativement de la version 2.4. Quelques-uns des changements les plus
importants sont résumés ci-dessous.
</p>

<ul>
  <li>
    Des améliorations ont été apportées à l'ordonnanceur&nbsp;: cela procure
    une meilleure interactivité pour les ordinateurs de bureau et assure un
    meilleur comportement lorsque le système est surchargé.
</li>
  <li>
    Échelonnage&nbsp;: Linux s'adapte mieux à une variété de systèmes
    électroniques allant des minuscules systèmes embarqués aux ordinateurs
    multiprocesseurs.
  </li>
  <li>
    Performances&nbsp;: la vitesse des applications courantes a été augmentée
    significativement.</li>
  <li>
    Support matériel&nbsp;: Linux supporte maintenant plus d'architectures et
    plus de périphériques que tout autre système d'exploitation.
</li>
</ul>

<p>
Vous serez peut-être intéressé par le document <uri
link="http://www.kniggit.net/wwol26.html">The Wonderful World Of Linux
2.6</uri>, écrit par Joseph Pranevich, qui est particulièrement détaillé. Si
vous préférez jeter un œil sur les détails techniques, consultez le <uri
link="http://www.linux.org.uk/~davej/docs/post-halloween-2.6.txt">Document
d'après l'Halloween</uri> (en anglais). Toutefois, ce dernier document date
quelque peu.
</p>

</body>
</section>
<section>
<title>Qu'est-ce qu'udev&nbsp;?</title>
<body>

<p>
Par le passé, Gentoo recommandait à ses utilisateurs <e>devfs</e> pour la
gestion du répertoire <path>/dev</path> qui contient un ensemble de fichiers
servant d'interfaces entre les applications du système et le matériel (lui-même
géré par le noyau).
</p>

<p>
Bien que <e>devfs</e> ait ses mérites, il souffre de problèmes internes et a
été déclaré obsolète dans Linux 2.6.
</p>

<p>
<e>udev</e> est le nouveau système de gestion des fichiers de périphériques. Il
apporte des solutions aux problèmes présents dans les gestionnaires précédents
et va plus loin en résolvant d'autres problèmes liés au système d'exploitation.
</p>

<p>
Ce qui précède ne vous dit peut-être pas grand chose, mais n'ayez
crainte&nbsp;: l'équipe des développeurs Gentoo a travaillé avec acharnement
afin de rendre la migration de devfs vers udev très simple.
</p>

</body>
</section>
<section>
<title>Qu'est-ce qu'ALSA&nbsp;?</title>
<body>

<p>
Avec Linux 2.4, vous utilisiez probablement des pilotes OSS («&nbsp;Open Sound
System&nbsp;») pour faire fonctionner votre carte de son. OSS a été remplacé
par un pilote audio plus moderne et meilleur, nommé ALSA.
</p>

<p>
ALSA («&nbsp;Advanced Linux Sound Architecture&nbsp;»), est un nouvel ensemble
de pilotes audio fonctionnant avec un API amélioré. Ce système est intégré au
noyau Linux 2.6. Il offre une compatibilité ascendante avec OSS, pourvu que
vous choisissiez les options appropriées lors de la configuration de votre
noyau&nbsp;!
</p>

<note>
Si vous n'avez aucun matériel audio, vous pouvez simplement ignorer toutes les
instructions relatives à ALSA dans ce document.
</note>

</body>
</section>
<section>
<title>Qu'est-ce que LVM&nbsp;?</title>
<body>

<p>
La gestion des volumes logiques (en anglais «&nbsp;Logical Volume
Management&nbsp;» (LVM)) est un ensemble d'outils qui vous permettent de gérer
votre disque dur de manière très flexible. LVM procure, entre autres choses,
un contrôle accru des partitions (par exemple la possibilité de
redimensionner sans redémarrer), et simplifie certaines opérations tel que le
remplacement d'un disque. LVM est une alternative à la gestion classique des
disques au moyen de partitions.
</p>

<p>
LVM a été implémenté dans Linux 2.4. Linux 2.6 propose une nouvelle version
de LVM, nommée <e>LVM2</e>. Le processus de migration requiert l'installation
de nouveaux outils utilisateurs (cela est couvert plus loin dans ce guide),
mais laissera vos données intactes&nbsp;!
</p>

<p>
<e>Si vous n'utilisez pas actuellement LVM pour le stockage de vos données,
la migration vers LVM2 ne vous concerne pas.</e> Dans ce cas, vous pouvez
ignorer toutes les sections de ce guide qui portent sur LVM et LVM2. La mise à
jour vers Linux 2.6 <e>ne nécessite pas</e> l'utilisation de LVM&nbsp;; vous
pouvez conserver vos données dans des partitions classiques comme vous l'avez
toujours fait.
</p>

<p>
Si vous n'utilisez pas LVM mais que LVM2 vous semble attrayant, vous pourrez,
dans le futur, convertir vos disques pour qu'ils utilisent ce format. Suivez
alors les instructions du guide <uri link="/doc/fr/lvm2.xml">Installation de
LMV2 sur Gentoo Linux</uri>. Pour l'instant, concentrons-nous sur notre
objectif actuel&nbsp;: une migration vers Linux 2.6 sans problème.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Préparation</title>
<section>
<title>Mettre votre système à jour</title>
<body>

<p>
Certains des changements apportés à Linux 2.6 requièrent des modifications à
des applications du système de base. Avant de poursuivre, vous devriez vous
assurer que votre système est relativement à jour. Pour en être parfaitement
sûr, vous devriez appliquer toutes les mises à jour «&nbsp;world&nbsp;» et
«&nbsp;system&nbsp;» disponibles.
</p>

<p>
Vous devriez vous assurer tout particulièrement de disposer des dernières
versions stables des paquets logiciels suivants&nbsp;:
</p>

<ul>
  <li><c>sys-apps/baselayout</c></li>
  <li><c>sys-apps/util-linux</c></li>
  <li>
    <c>sys-kernel/genkernel</c> (Seulement si vous voulez utiliser Genkernel
    plutôt que configurer le noyau manuellement.)
</li>
</ul>

<pre caption="Mettre à jour tous les paquets « world »">
# <i>emerge --sync</i>
# <i>emerge -ua world</i>
</pre>

</body>
</section>
<section>
<title>modutils vs module-init-tools</title>
<body>

<p>
<c>sys-apps/modutils</c> est le paquet logiciel contenant (entre autres) les
outils <c>modprobe</c>, <c>rmmod</c> et <c>insmod</c> pour Linux 2.4.
</p>

<p>
Linux 2.6 utilise un format différent pour les modules et nécessite donc de
nouveaux outils pour gérer ces modules. Ces outils sont rassemblés dans le
paquet <c>sys-apps/module-init-tools</c>.
</p>

<p>
Vous devriez maintenant désinstaller modutils puis installer
module-init-tools&nbsp;:
</p>

<pre caption="Passer de modutils à module-init-tools">
# <i>emerge --unmerge sys-apps/modutils</i>
# <i>emerge module-init-tools</i>
</pre>

<note>
Les outils de module-init-tools sont compatibles avec Linux 2.4. Vous n'avez
donc pas à vous inquiétez lorsque vous désinstallez modutils&nbsp;; vous serez
toujours capable d'amorcer Linux 2.4 et de gérer des modules fonctionnant avec
ce noyau.
</note>

<note>
Pour la raison invoquée ci-dessus, module-init-tools est peut-être déjà
installé et fonctionnel sur votre système Linux 2.4. Si c'est le cas, vous
n'avez pas à faire quoi que ce soit de particulier&nbsp;; votre système est
déjà prêt à gérer les modules de Linux 2.6.
</note>

</body>
</section>
<section>
<title>Installer udev</title>
<body>

<p>
Aucune configuration n'est requise. Utilisez simplement <c>emerge</c> pour
installer udev&nbsp;:
</p>

<pre caption="Installer udev">
# <i>emerge -a udev</i>
</pre>

<p>
Vous devriez lire le <uri link="/doc/fr/udev-guide.xml">Guide udev</uri> si
vous voulez mieux comprendre les différences entre devfs et udev.
</p>

</body>
</section>
<section>
<title>Vérification des fichiers de périphériques essentiels</title>
<body>

<p>
Lorsque le système démarre, il a besoin de quelques fichiers de périphériques.
Puisque udev n'est pas inclus dans le noyau, il n'est pas activé immédiatement.
Pour éviter ce problème, vous devez vous assurer que ces fichiers de
périphériques sont présents sur votre disque.
</p>

<p>
L'archive stage utilisée lors de l'installation devrait avoir créé les fichiers
requis. Malheureusement, quelques utilisateurs ont rapporté que cela ne
fonctionne pas à tous les coups. Nous allons maintenant vérifier si ces
fichiers existent sur votre système et, sinon, les créer.
</p>

<p>
Puisque votre gestionnaire de périphériques actuel est monté sur /dev, nous ne
pouvons accéder à ce répertoire directement. Nous allons donc lier-monter votre
partition racine à un autre emplacement et accéder à /dev à partir de cet
endroit.
</p>

<pre caption="Lier-monter la partition racine et obtenir une liste des fichiers de périphériques statiques">
# <i>mkdir -p /mnt/temp</i>
# <i>mount -o bind / /mnt/temp</i>
# <i>cd /mnt/temp/dev</i>
# <i>ls -l console null</i>
</pre>

<p>
Si la commande précédente rapporte que le fichier <c>console</c> ou le fichier
<c>null</c> n'existent pas, vous devrez créer manuellement les fichiers
nécessaires tel qu'indiqué ci-dessous&nbsp;:
</p>

<pre caption="Créer les fichiers console et null">
# <i>mknod -m 660 console c 5 1</i>
# <i>mknod -m 660 null c 1 3</i>
</pre>

<p>
Vous devriez maintenant démonter la partition racine liée-montée, et ce même si
vous n'avez pas créé les fichiers de périphériques&nbsp;:
</p>

<pre caption="Démonter la partition racine liée-montée">
# <i>cd</i>
# <i>umount /mnt/temp</i>
# <i>rmdir /mnt/temp</i>
</pre>

</body>
</section>
<section>
<title>Installer les utilitaires ALSA</title>
<body>

<p>
ALSA nécessite certains paquets logiciels afin que les applications puissent
accéder à l'API ALSA. Ces paquets vous permettront aussi de contrôler le mixeur
et le niveau du volume. Installez ces utilitaires comme suit&nbsp;:
</p>

<pre caption="Installer les bibliothèques et les utilitaires ALSA">
# <i>emerge -a alsa-lib alsa-utils alsa-tools alsa-headers alsa-oss</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Installer les sources d'un noyau Linux 2.6</title>

<section>
<title>Choisir et installer les sources</title>
<body>

<p>
Vous devez tout d'abord installer les sources d'un noyau 2.6 de votre choix.
Les deux noyaux 2.6 officiellement supportés par Gentoo sont
<e>gentoo-sources</e> (pour les stations de travail) et
<e>hardened-dev-sources</e> (pour les serveurs). D'autres noyaux sont
disponibles&nbsp;; consultez le <uri link="/doc/fr/gentoo-kernel.xml">Guide du
noyau Gentoo Linux</uri> pour en savoir plus.
</p>

<p>
Dans ce guide, nous utiliserons <c>gentoo-sources</c> à titre d'exemple.
Installez les sources du noyau que vous avez choisies avec le programme
<c>emerge</c>&nbsp;:
</p>

<pre caption="Installer gentoo-sources">
# <i>emerge -a gentoo-sources</i>
These are the packages that I would merge, in order:
Calculating dependencies ...done!
[ebuild  N    ] sys-kernel/gentoo-sources-2.6.10-r4

Do you want me to merge these packages? [Yes/No] <i>y</i>
</pre>

<p>
Quand vous lancez la commande <c>emerge</c> décrite ci-dessus, si Portage veux
installer une version 2.4 dd gentoo-sources (p.ex.
<c>gentoo-sources-2.4.26</c>), cela signifie que votre profil n'est pas prévu
pour utiliser un noyau 2.6. Veuillez d'abord consulter le <uri
link="/doc/fr/gentoo-upgrading.xml">Guide des mises à jour de Gentoo</uri> pour
savoir comment basculer votre profile.
</p>

</body>
</section>
<section>
<title>Mettre à jour le lien symbolique /usr/src/linux</title>
<body>

<p>
Plusieurs composants de Gentoo nécessitent que le fichier /usr/src/linux soit
un lien symbolique pointant vers les sources du noyau que vous utilisez (ou
avec lesquelles vous souhaitez compiler des paquets logiciels).
</p>

<p>
Nous allons donc mettre à jour <path>/usr/src/linux</path> afin qu'il pointe
vers les sources que vous venez d'installer. Poursuivons l'exemple
précédent&nbsp;:
</p>

<pre caption="Mettre à jour le lien symbolique /usr/src/linux">
# <i>cd /usr/src</i>
# <i>ln -sfn linux-2.6.10-gentoo-r4 linux</i>
</pre>

</body>
</section>
</chapter>

<chapter id="pitfalls">
<title>Problèmes connus avec la migration vers Linux 2.6</title>
<section>
<body>

<p>
Avant de plonger dans la configuration du noyau, révisons quelques-unes des
erreurs les plus fréquemment commises lors de la migration vers Linux 2.6.
Certaines des remarques qui suivent influenceront la façon dont vous
configurerez votre noyau.
</p>

<note>
La pertinence des présentes remarques ne vous semblera peut-être pas évidente à
ce moment-ci, mais vous souhaiterez peut-être vous référer à ces remarques
lorsque vous lirez les sections suivantes. Nous avons préféré rassembler toutes
ces notes en un seul endroit.
</note>

</body>
</section>
<section>
<title>N'utilisez pas «&nbsp;make oldconfig&nbsp;» avec un fichier .config de
la version 2.4</title>
<body>

<note>
Si vous ne comprenez pas tout à fait cet avertissement, ne vous inquiétez
pas&nbsp;; si vous suivez correctement les instructions de ce guide, vous ne
commettrez pas cette erreur.
</note>

<p>
Vous seriez confronté à une multitude de questions puisqu'il y a eu de nombreux
changements entre les deux versions. Plusieurs utilisateurs ont essayé
d'utiliser <c>make oldconfig</c> avec un fichier de configuration provenant
d'un noyau 2.4 seulement pour obtenir un noyau inutilisable (pas de sortie à
l'écran, pas d'entrée avec le clavier, etc.) Évitez ces problèmes et utilisez
la configuration <c>menuconfig</c> traditionnelle pour votre premier noyau 2.6.
</p>

</body>
</section>
<section>
<title>N'utilisez pas ide-scsi pour la gravure de CD/DVD</title>
<body>

<p>
Dans Linux 2.4, la seule façon d'obtenir de bons résultats avec l'écriture de
CD et de DVD était d'activer l'émulation <c>ide-scsi</c> (ce qui était pour le
moins inélégant). Heureusement, la couche de gestion des périphériques IDE dans
Linux 2.6 a été étendue et supporte beaucoup mieux les graveurs de CD/DVD.
</p>

<p>
Aucune option supplémentaire n'est nécessaire pour le support de la gravure de
CD. Assurez-vous seulement de <e>ne pas</e> utiliser <c>ide-scsi</c> comme vous
le faisiez avant.
</p>

</body>
</section>
<section>
<title>Le haut-parleur PC est maintenant une option configurable</title>
<body>

<p>
Aucun son ne sera émis par votre haut-parleur PC («&nbsp;PC speaker&nbsp;») (ce
qui inclut les «&nbsp;beep&nbsp;» de la console) si vous n'activez pas
explicitement la nouvelle option concernant le haut-parleur PC
(<c>CONFIG_INPUT_PCSPKR</c>)&nbsp;:
</p>

<pre caption="Repérer l'option relative au haut-parleur PC">
Device Drivers  ---&gt;
 Input device support  ---&gt;
  [*] Misc
   &lt;*&gt;   PC Speaker support
</pre>

<note>
Le haut-parleur PC est le petit haut-parleur analogue intégré qui émet quelques
sons lorsque votre ordinateur démarre&nbsp;; il n'a rien à voir avec le
matériel standard pour le son qui est utilisé pour écouter de la musique ou
pour d'autres applications.
</note>

</body>
</section>
<section>
<title>Le nouveau pilote pour les périphériques de blocs USB est parfois
problématique</title>
<body>

<p>
Très récemment, un nouveau pilote pour le stockage de masse USB a été ajouté au
noyau. Au moment d'écrire ces lignes, ce pilote (nommé «&nbsp;ub&nbsp;») est
encore dans ses premières étapes de développement et cause des problèmes à
certains utlisateurs. Si vous avez des difficultés à accéder à vos
périphériques USB (disque dur, disque flash, lecteur de cartes, caméra
numérique), vous pouvez revenir à l'ancien pilote de type SCSI&nbsp;:
</p>

<pre caption="Désactiver ub">
Device Drivers  ---&gt;
 Block devices  ---&gt;
  &lt; &gt; Low Performance USB Block driver
</pre>

<note>
L'ancien pilote de type SCSI (appelé «&nbsp;USB Mass Storage support&nbsp;»)
est activé par défaut. Vous le trouverez dans la section «&nbsp;Device Drivers
--&gt; USB support&nbsp;». Toutefois, ce pilote n'est habituellement pas
utilisé lorsque ub est activé.
</note>

</body>
</section>
<section>
<title>usbdevfs a un nouveau nom&nbsp;: usbfs</title>
<body>

<p>
Si vous avez édité le fichier <path>/etc/fstab</path> pour configurer la façon
dont le système de fichiers des périphériques USB est monté, vous devrez
peut-être modifier le type de système de fichier en remplaçant <e>usbdevfs</e>
par <e>usbfs</e>.
</p>

<note>
Les noyaux 2.4 récents supportent eux aussi «&nbsp;usbfs&nbsp;» et
«&nbsp;usbdevfs&nbsp;». Aussi, vous ne perdez aucune compatibilité en passant
au système plus récent.
</note>

</body>
</section>
<section>
<title>Ne modifiez pas la priorité de X</title>
<body>

<p>
Si vous utilisez Linux 2.4 sur une station de travail, vous aviez peut-être
«&nbsp;hacké&nbsp;» votre système pour exécuter X avec une priorité plus
élevée, ce qui semblait améliorer les performances sur ces ordinateurs.
</p>

<p>
Beaucoup de modifications ont été apportées à l'ordonnanceur dans le noyau 2.6,
ce qui change substantiellement son comportement. Si vous persistez à exécuter
X avec une priorité élevée, le système fera exactement ce qu'il est supposé
faire (soit exécuter le <e>serveur d'affichage</e> à une très haute priorié),
et vous en subirez les conséquences&nbsp;: le son sera saccadé et le lancement
des applications sera lent, puisque votre processeur passera beaucoup trop de
temps à s'occuper uniquement de X.
</p>

<p>
Avec Linux 2.6, vous n'avez plus besoin de changer la priorité des applications
de bureau pour obtenir une bonne interactivité. N'utilisez donc plus la
commande <c>renice</c> et ses astuces pour ce type d'applications.
</p>

</body>
</section>
<section>
<title>Le fichier de configuration de X11 devrait maintenant utiliser
/dev/input/mice pour les souris PS/2 et USB</title>
<body>

<p>
Un des changements introduits par la configuration par défaut de udev (par
rapport à devfs) concerne l'organisation des fichiers de périphériques relatifs
aux souris (et autres dispositifs de pointage). Auparavant, ces fichiers
avaient pour noms, entre autres, <path>/dev/psaux</path> et
<path>/dev/mouse</path>. Désormais, vous aurez des fichiers tels que
<path>/dev/input/mouse0</path> et <path>/dev/input/mouse1</path>, ainsi que le
nœud matériel <path>/dev/input/mice</path> qui combine les mouvements de tous
les dispositifs de pointage.
</p>

<p>
Les vieilles configuration de X typiques référencent <path>/dev/mouse</path> ou
<path>/dev/psaux</path>, ce qui peut causer des erreurs telles que celle
ci-dessous lorsque vous essayez de démarrer X11&nbsp;:
</p>

<pre caption="Erreur fréquemment rencontrée lorsque X est exécuté pour la première fois sur un système udev">
(EE) xf86OpenSerial: Cannot open device /dev/mouse
No such file or directory.
(EE) Mouse0: cannot open input device
(EE) PreInit failed for input device "Mouse0"
No core pointer
</pre>

<p>
Pour corriger ceci, ouvrez votre fichier de configuration X11 avec un éditeur
de texte et mettez à jour la section <e>InputDevice</e> relative à votre souris
pour qu'elle utilise <path>/dev/input/mice</path>. Voici un exemple&nbsp;:
</p>

<pre caption="Ouvrez votre fichier de configuration X11">
# <i>nano -w /etc/X11/xorg.conf</i>
</pre>

<note>
Si vous utilisez toujours XFree86, votre fichier de configuration sera
<path>/etc/X11/XF86Config</path>.
</note>

<pre caption="Exemple d'une section InputDevice pour la souris">
Section "InputDevice"
  Identifier  "Mouse0"
  Driver      "mouse"
  Option      "Protocol" "auto"
  Option      "Device" "/dev/input/mice"
EndSection
</pre>

<note>
Si vous utilisez une souris sur un port série, le chemin vers le périphérique
sera <path>/dev/tts/0</path> au lieu de <path>/dev/ttyS0</path>.
</note>

</body>
</section>
<section>
<title>Les nouveaux pilotes ATA série («&nbsp;serial ATA&nbsp;») nomment les
périphériques différemment</title>
<body>

<p>
Si vous utilisiez les pilotes ATA série originaux de Linux 2.4, vous avez sans
doute remarqué que vos périphériques SATA ont des noms tels que
<c>/dev/hde</c>.
</p>

<p>
Linux 2.6 utilise de nouveaux pilotes SATA (libata). Ceux-ci sont
basés sur l'infrastructure SCSI du noyau, ce qui implique que vos disques SATA
apparaîtront désormais comme des périphériques SCSI. Votre premier disque SATA
se nommera donc <c>/dev/sda</c>. Vous devrez mettre à jour votre fichier
<c>/etc/fstab</c> pour refléter ces changements. Vous devrez aussi vous
souvenir de ces nouveaux noms lorsque vous choisirez le paramètre
root/real_root relatif au démarrage du noyau.
</p>

<note>
Puisque libata a été rétrointégré dans les versions récentes de Linux 2.4, vous
êtes peut-être déjà familier avec ce nouveau schéma de noms de périphériques.
</note>

</body>
</section>
<section>
<title>Bootsplash n'est plus développé</title>
<body>

<p>
Si vous utilisiez le noyau <c>gentoo-sources-2.4</c>, peut-être utilisiez-vous
la fonctionnalité <e>bootsplash</e> pour obtenir une console de type
«&nbsp;framebuffer&nbsp;» en couleurs.
</p>

<p>
À cause de problèmes dans sa conception, le développeur de bootsplash semble
avoir perdu son intérêt pour ce projet. Toutefois, le développeur Gentoo
<e>Michal Januszewski</e> développe actuellement le successeur de bootsplash,
nommé <c>gensplash</c>, qui est inclus dans le noyau gentoo-sources-2.6.
Vous pouvez lire le guide <uri
link="http://dev.gentoo.org/~spock/projects/gensplash/archive/gensplash-in-5-easy-steps.txt">Gensplash
in 5 easy steps</uri> écrit par Michal si vous souhaitez vous familiariser
avec gensplash.
</p>

</body>
</section>
<section>
<title>Les pilotes I2C sont maintenant inclus dans le noyau</title>
<body>

<p>
Si vous utilisiez <c>lm-sensors</c> pour surveiller la température de votre
système et son niveau de consommation d'énergie, vous aviez également installé
le paquet logiciel <c>i2c</c> qui fournit le support nécessaire pour le
matériel.
</p>

<p>
Les pilotes pour le matériel I2C sont maintenant inclus dans le noyau
2.6&nbsp;; vous n'avez donc plus besoin du paquet externe i2c. Souvenez-vous
que vous devez compiler dans le noyau le support spécifique à votre matériel
I2C. Une fois cela fait, vous pourrez utiliser <c>lm-sensors</c> comme à
l'habitude.
</p>

</body>
</section>
</chapter>

<chapter id="conf">
<title>Configurer, compiler et installer le noyau</title>
<section>
<body>

<p>
Tout comme avec Linux 2.4, vous avez le choix entre deux façons de gérer la
mise en place de votre noyau.
</p>

<ol>
  <li>
    La méthode par défaut est la configuration manuelle du noyau. Cela peut
    sembler rebutant, mais c'est la méthode suggérée si vous connaissez bien
    votre matériel. Si vous souhaitez configurer votre noyau manuellement,
    poursuivez avec le <uri link="#manual">chapitre suivant</uri>.
  </li>
  <li>
    L'alternative est d'utiliser notre utilitaire <c>genkernel</c> pour
    configurer, compiler et installer le noyau à votre place et
    automatiquement. Si vous souhaitez utiliser <c>genkernel</c>, sautez le
    chapitre suivant et poursuivez votre lecture avec le chapitre «&nbsp;<uri
    link="#genkernel">Utilisation de genkernel</uri>&nbsp;».
  </li>
</ol>

</body>
</section>
</chapter>

<chapter id="manual">
<title>Par défaut&nbsp;: configuration manuelle</title>
<section>
<title>Configurer le noyau</title>
<body>

<p>
Nous allons maintenant poursuivre avec la configuration du noyau. Ouvrez
menuconfig comme d'habitude&nbsp;:
</p>

<pre caption="Lancer menuconfig">
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<p>
Vous êtes probablement familier avec l'utilisation de menuconfig pour la
configuration des noyaux de la série 2.4. Cet utilitaire n'a presque pas
changé, mais vous remarquerez que les options du noyau sont bien mieux
organisées qu'avant et qu'il existe de nombreuses nouvelles options.
</p>

<p>
Assurez-vous d'activer les options du noyau suivantes&nbsp;:
</p>

<pre caption="Options du noyau requises">
File systems ---&gt;
  Pseudo Filesystems ---&gt;
    [*] /proc file system support
    [*] Virtual memory file system support (former shm fs)

<comment>(Les options suivantes sont requises pour udev :)</comment>
General setup  ---&gt;
 [*] Support for hot-pluggable devices

Device Drivers  ---&gt;
 Block devices  ---&gt;
  &lt;*&gt; RAM disk support

<comment>(Les options suivantes sont requises pour ALSA :)</comment>
Device Drivers  ---&gt;
 Sound  ---&gt;
  &lt;*&gt; Sound card support
  Advanced Linux Sound Architecture  ---&gt;
   &lt;M&gt; Advanced Linux Sound Architecture
   &lt;M&gt; Sequencer support
   &lt;M&gt; OSS Mixer API
   [*] OSS Sequencer API
<comment>   (N'oubliez pas de choisir votre carte son dans le sous-menu.)</comment>

<comment>(Les options suivantes sont requises pour la gestion des disques avec LVM :)</comment>
Device Drivers  ---&gt;
 Multi-device support (RAID and LVM)  ---&gt;
  [*] Multiple devices driver support (RAID and LVM)
   &lt;*&gt;   Device mapper support
</pre>

<warn>
Peut-être aviez-vous ajouté le support pour le système de fichiers
<path>/dev</path> (aujourd'hui considéré obsolète) dans vos précédentes
configurations de noyaux. N'utilisez plus le support de devfs&nbsp;; udev est
maintenant installé sur votre système et sera utilisé à la place de devfs.
</warn>

<p>
N'oubliez pas d'ajouter le support nécessaire pour votre matériel et pour les
types de systèmes de fichiers que vous utilisez. Assurez-vous d'activer le
support des contrôleurs IDE de votre carte-mère si vous souhaitez bénéficier
de l'accès rapide aux disques DMA. Référez-vous au chapitre «&nbsp;<uri
link="/doc/fr/handbook/handbook-x86.xml?part=1&amp;chap=7">Configurer le
noyau</uri>&nbsp;» du <uri link="/doc/fr/handbook/index.xml">Manuel Gentoo</uri>
pour des instructions plus détaillées.
</p>

</body>
</section>
<section>
<title>Compilation du noyau</title>
<body>

<p>
Maintenant que votre noyau est configuré, nous pouvons débuter le processus de
compilation&nbsp;:
</p>

<pre caption="Compiler le noyau à partir de ses sources">
# <i>make &amp;&amp; make modules_install</i>
</pre>

<note>
Peut-être vous souvenez-vous que la commande <c>make dep</c> était employée
lors de la compilation des noyaux 2.4. Cette commande n'est maintenant plus
nécessaire.
</note>

<p>
Attendez que la compilation du noyau soit terminée. Vous remarquerez que les
messages de sortie sont beaucoup plus lisibles qu'avant.
</p>

</body>
</section>
<section>
<title>Installer le noyau</title>
<body>

<p>
L'étape suivante consiste à monter votre partition <path>/boot</path> et à
copier l'image du noyau à cet endroit. Vous devez ensuite mettre à jour votre
chargeur de démarrage manuellement.
</p>

<pre caption="Installer le noyau">
# <i>mount /boot</i>
# <i>cp arch/i386/boot/bzImage /boot/bzImage-2.6.10-gentoo-r4</i>
# <i>cp System.map /boot/System.map-2.6.10-gentoo-r4</i>
</pre>

<p>
Notez bien que les instructions ci-dessus ont valeur d'exemple. Vous devriez
suivre la procédure que vous employez habituellement lors de la mise à jour de
votre noyau, telle que décrite dans les instructions du chapitre «&nbsp;<uri
link="/doc/fr/handbook/handbook-x86.xml?part=1&amp;chap=7">Configurer le
noyau</uri>&nbsp;» du <uri link="/doc/fr/handbook/">Manuel Gentoo</uri>.
</p>

<p>
Lorsque vous mettrez à jour la configuration de votre chargeur de démarrage,
ne supprimez pas les entrées relatives à votre ancien noyau 2.4. Ainsi, vous
serez toujours capable de passer d'un noyau à l'autre si un problème devait
survenir.
</p>

<p>
Poursuivez maintenant avec la section «&nbsp;<uri link="#modules">Configuration
des modules</uri>&nbsp;».
</p>

</body>
</section>
</chapter>

<chapter id="genkernel">
<title>Alternative&nbsp;: utiliser genkernel</title>
<section>
<body>

<p>
Si vous préférez utiliser genkernel plutôt que configurer manuellement votre
noyau, vous serez heureux d'apprendre que le processus d'utilisation de
genkernel pour la gestion des noyaux 2.6 est très similaire à celui employé
pour les noyaux 2.4.
</p>

<p>
Vous devriez exécuter genkernel comme suit&nbsp;:
</p>

<pre caption="Exécuter genkernel avec quelques options communes">
# <i>genkernel --udev --menuconfig --bootloader=grub all</i>
</pre>

<p>
Dans l'exemple précédent, nous profitons de quelques-unes des fonctionnalités
de genkernel, soit l'utilisation de menuconfig qui vous permet de personnaliser
la configuration de votre noyau (si vous le désirez), et la mise à jour de la
configuration du chargeur de démarrage grub qui a lieu après la compilation.
</p>

<p>
Bien sûr, vous devriez utiliser les options qui conviennent à votre système
lorsque vous exécutez genkernel. Toutefois, n'oubliez surtout pas d'inclure
l'option <c>--udev</c>&nbsp;! Référez-vous au <uri
link="/doc/fr/genkernel.xml">Guide Genkernel pour Gentoo Linux</uri> et au
chapitre «&nbsp;<uri
link="/doc/fr/handbook/handbook-x86.xml?part=1&amp;chap=7">Configurer le
noyau</uri>&nbsp;» du <uri link="/doc/fr/handbook/">Manuel Gentoo</uri> pour
plus de détails.
</p>

<p>
Si vous mettez votre chargeur de démarrage à jour vous-même, n'oubliez pas le
paramètre <c>udev</c> sur la commande <c>kernel</c>. L'exemple de configuration
de <e>grub</e> ci-dessous peut vous aider, mais n'oubliez pas d'utiliser la
bonne valeur pour le paramètre <c>real_root</c>.
</p>

<pre caption="Sample GRUB config for genkernel + udev">
title=Gentoo Linux (2.6 kernel)
root (hd0,0)
kernel /kernel-2.6.10-gentoo-r4 <i>udev</i> root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=/dev/hda3
initrd /initrd-2.6.10-gentoo-r4
</pre>

</body>
</section>
</chapter>

<chapter id="modules">
<title>Configuration des modules</title>

<section>
<title>Installer des modules externes</title>
<body>

<p>
Plusieurs utilisateurs ont besoin de modules du noyau qui sont maintenus à
l'extérieur de l'arbres des sources. Les exemples les plus évidents sont les
pilotes pour les accélérateurs graphiques ATI et Nvidia. Si vous souhaitez
utiliser de tels modules, vous devez maintenant les installer. Ces modules
seront compilés en utilisant l'arbre des sources de votre nouveau noyau 2.6 qui
se trouve dans <path>/usr/src/linux</path>. L'installation des modules est
identique à celle de tout autre paquet logiciel&nbsp;: utilisez la commande
<c>emerge nom_du_paquet</c> pour chaque module externe que vous aviez
l'habitude d'utiliser avec votre noyau 2.4.
</p>

<p>
Encore une fois, n'hésitez pas à consulter le chapitre «&nbsp;<uri
link="/doc/fr/handbook/handbook-x86.xml?part=1&amp;chap=7">Configurer le
noyau</uri>&nbsp;» du <uri link="/doc/fr/handbook/index.xml">Manuel Gentoo</uri>
pour obtenir plus d'information.
</p>

</body>
</section>
<section>
<title>Chargement automatique des modules</title>
<body>

<p>
Vous avez peut-être décidé de compiler certains composants du noyau en tant que
modules (plutôt que de les inclure directement dans le noyau). Si c'est le cas
ou si vous avez installé des modules externes à partir des paquets disponibles
dans Portage (tel que décrit ci-dessus), vous voudrez sans doute charger
automatiquement ces modules lors du démarrage, comme vous le faisiez avec votre
noyau 2.4.
</p>

<p>
La procédure pour ce faire est similaire à celle que vous utilisiez avec les
noyaux 2.4. Ouvrez simplement le fichier
<path>/etc/modules.autoload.d/kernel-2.6</path> dans un éditeur de texte et
listez-y les noms des modules que vous souhaitez charger automatiquement.
</p>

<pre caption="Ouvrir la liste des modules à charger automatiquement avec nano">
# <i>nano -w /etc/modules.autoload.d/kernel-2.6</i>
</pre>

<pre caption="Exemple de liste de chargement automatique pour les modules nvidia et 3c59x">
# /etc/modules.autoload.d/kernel-2.6:  kernel modules to load when system boots.
#
# Note that this file is for 2.6 kernels.
#
# Add the names of modules that you'd like to load when the system
# starts into this file, one per line.  Comments begin with # and
# are ignored.  Read man modules.autoload for additional details.

3c59x
nvidia
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Passer de LVM à LVM2</title>
<section>
<title>Mise à jour des outils pour LVM2</title>
<body>

<note>
Si vous n'utilisez pas LVM pour la gestion de vos disques, vous pouvez
ignorer ce chapitre et passer tout de suite au suivant.
</note>

<p>
Heureusement, mettre à niveau les outils utilisateurs pour passer de la
version LVM1 à la version LVM2 est très simple.
</p>

<pre caption="Mettre à jour les outils utilisateurs (de LVM1 vers LVM2)">
# <i>emerge --unmerge lvm-user</i>
# <i>emerge lvm2</i>
</pre>

<note>
Les outils LVM2 ont une compatibilité ascendante avec LVM1. Vos données ne
seront donc pas affectées. Vous ne perdrez aucune compatibilité avec les
versions antérieures en procédant à cette mise à jour, et vous pourrez
toujours démarrer avec Linux 2.4 comme à l'habitude.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Démarrer Linux 2.6</title>
<section>
<body>

<p>
Il est maintenant temps de démarrer Linux 2.6. Fermez toutes les applications
et redémarrez&nbsp;:
</p>

<pre caption="Redémarrer">
# <i>umount /boot</i>
# <i>reboot</i>
</pre>

<p>
Si vous avez suivi correctement les instructions de ce guide, vous aurez le
choix entre lancer Linux 2.4 ou Linux 2.6 à partir de votre chargeur de
démarrage. Choisissez Linux 2.6.
</p>

<p>
Une fois le système amorcé, vérifiez que tout fonctionne. Si vous avez fait
une erreur dans la configuration du noyau, ne vous inquiétez pas&nbsp;: vous
pouvez revenir en arrière à l'étape «&nbsp;<uri link="#conf">Configurer,
compiler et installer le noyau</uri>&nbsp;». Il suffit alors de changer la
configuration, de recompiler et d'installer l'image du noyau puis de redémarrer
pour un nouvel essai&nbsp;!
</p>

</body>
</section>
<section>
<title>Configurer les canaux ALSA et les sortir du mode muet</title>
<body>

<p>
Nous allons maintenant procéder à la configuration d'ALSA et sortir les
canaux audio du mode muet. Les paquets logiciels ALSA fournissent un
utilitaire qui rend cette tâche fort aisée&nbsp;:
</p>

<pre caption="Lancer l'utilitaire de configuration automatique d'ALSA">
# <i>alsaconf</i>
</pre>

<p>
La manière de procéder est simple&nbsp;: permettez la mise à jour automatique
du fichier <e>/etc/modules.d/alsa</e>, puis acceptez qu'ALSA soit rechargé.
Le programme alsaconf a alors fini son travail. Toutefois, vous devrez
exécuter cet utilitaire plusieurs fois si votre système comporte plus d'un
périphérique audio.
</p>

<p>
Vous devriez maintenant ajouter le script d'initialisation <c>alsasound</c> au
niveau d'exécution «&nbsp;boot&nbsp;», afin que les volumes des canaux audio
soient sauvegardés lors de l'extinction de votre ordinateur et restaurés lors
du démarrage.
</p>

<pre caption="Ajouter alsasound au niveau d'exécution « boot »">
# <i>rc-update add alsasound boot</i>
</pre>

<note>
L'utilitaire <c>alsaconf</c> choisit le volume initial de votre périphérique
audio. Si ce volume est inapproprié, vous pouvez le régler avec le programme
<c>alsamixer</c>.
</note>

</body>
</section>
<section>
<title>Déjà des problèmes ?</title>
<body>

<p>
Si vous rencontrez déjà des problèmes, veuillez consulter le chapitre <uri
link="#pitfalls">Problèmes connus avec la migration vers Linux 2.6</uri>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Fichiers d'en-têtes et NPTL</title>
<section>
<body>

<p>
À ce point-ci, vous disposez d'un système Linux 2.6 et vous avez réglé tous
les problèmes éventuels liés à la migration. Vous devriez maintenant mettre à
jour les fichiers d'en-têtes du noyau et réinstaller glibc afin que les
programmes utilisateurs puissent bénéficier des nouvelles fonctionnalités de
Linux 2.6.
</p>

<pre caption="Mettre à jour le système en passant à linux26-headers">
# <i>emerge -u linux-headers</i>
</pre>

<p>
Après la mise à jour du paquet logiciel contenant les en-têtes, vous devez
habituellement réinstaller glibc. Il existe une nouvelle fonctionnalité que
vous souhaiterez peut-être utiliser&nbsp;: NPTL. NPTL est un nouveau modèle de
gestion des fils d'exécution de Linux 2.6 qui propose une création et une
destruction plus rapides des fils d'exécution. Cela ne fera pas de différence
appréciable sur la plupart des systèmes, mais vous souhaiterez peut-être tout
de même activer NPTL pendant ce processus de migration. Pour le faire, éditez
<path>/etc/make.conf</path> et ajoutez <e>nptl</e> à vos options de la variable
USE.
</p>

<warn>
Si vous compilez glibc avec <c>USE="nptlonly"</c>, vous ne pourrez plus
démarrer avec un noyau 2.4.
</warn>

<p>
Maintenant, réinstallez glibc. (Vous devriez réaliser cette étape même si vous
n'avez pas activé NPTL.)
</p>

<pre caption="Récompiler glibc en utilisant les nouveaux en-têtes du noyau">
# <i>emerge -a glibc</i>
</pre>

<p>
Si vous avez activé NPTL, les programmes binaires déjà présents sur votre
système n'utiliseront pas cette fonctionnalité avant qu'ils ne soient
recompilés. Tous les programmes compilés à partir de ce moment
<e>supporteront</e> NPTL. Vous souhaiterez peut-être recompiler tous vos
programmes maintenant&nbsp;:
</p>

<pre caption="Recompiler tous les paquets du système">
# <i>emerge -e world</i>
</pre>

<p>
Alternativement, vous pouvez simplement laisser votre système se convertir
«&nbsp;naturellement&nbsp;» au fur et à mesure que vous mettrez à jour vos
paquets lorsque de nouvelles versions seront disponibles.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Dernières remarques</title>
<section>
<title>Des problèmes&nbsp;?</title>
<body>

<p>
Considérant la somme de travail incroyable qui a été nécessaire au
développement de Linux 2.6, on peut s'attendre à de très nombreux changements
et, inévitablement, à quelques problèmes.
</p>

<p>
Si vous éprouvez une difficulté particulière avec votre noyau 2.6 et que vous
pouvez confirmer que le problème n'existe pas dans Linux 2.4, veuillez remplir
un rapport de bogue sur <uri link="http://bugs.gentoo.org">Bugzilla</uri>.
Nous étudierons la situation et, si nous découvrons qu'il s'agit d'un problème
dans le noyau officiel, nous vous demanderons peut-être de remplir un rapport
sur le Bugzilla centralisé pour le noyau Linux.
</p>

</body>
</section>
<section>
<title>Conclusion</title>
<body>

<p>
Avec un peu de chance, vous venez de terminer votre migration, n'avez rencontré
aucun problème et profitez maintenant des améliorations apportées à Linux 2.6
par rapport à Linux 2.4.
</p>

<p>
L'auteur adresse ses plus vifs remerciements aux nombreux utilisateurs qui ont
testé ce document et qui ont permis son amélioration. Tous vos courriels n'ont
pas reçu de réponse, mais ils ont tous été lus avec attention et ont permis
d'améliorer ce guide.
</p>

</body>
</section>
<section>
<title>Désinstaller Linux 2.4</title>
<body>

<p>
Après quelque temps passé avec Linux 2.6, vous concluerez peut-être que vous
n'avez plus besoin du tout de Linux 2.4. Les étapes nécessaires à la
désinstallation de Linux 2.4 de votre système sont détaillées ci-dessous. <e>Ne
suivez ces instructions que si vous êtes certain de ne plus avoir l'intention
d'utiliser Linux 2.4&nbsp;!</e>
</p>

<p>
Les sources des noyaux 2.4 peuvent être supprimées en utilisant emerge comme
vous le faites d'habitude. Par exemple, si des versions 2.4 des paquets
vanilla-sources et gentoo-sources sont installées sur votre système, vous
pouvez utiliser la commande suivante pour les désinstaller tout en gardant
intactes les versions 2.6&nbsp;:
</p>

<pre caption="Exemple : désinstaller les sources de Linux 2.4">
# <i>emerge --unmerge =vanilla-sources-2.4.* =gentoo-sources-2.4.*</i>
</pre>

<p>
Portage ne supprimera pas complètement les sources des noyaux 2.4 puisque des
fichiers temporaires sont créés après l'installation des sources pendant la
compilation du noyau. Il est tout à fait sûr de supprimer manuellement
ces fichiers avec la commande suivante&nbsp;:
</p>

<pre caption="Supprimer les fichiers temporaires restants">
# <i>rm -rf /usr/src/linux-2.4.*</i>
</pre>

<p>
Vous pouvez aussi supprimer les modules et les fichiers qui contiennent des
informations relatives à vos anciens noyaux 2.4, ces composants ne sont plus
nécessaires.
</p>

<pre caption="Supprimer les modules 2.4 installés précédemment">
# <i>rm -rf /lib/modules/2.4.*</i>
</pre>

<p>
Les images binaires des noyaux 2.4 que vous utilisiez pour démarrer votre
système peuvent également être supprimées. Pour ce faire, vous devez monter
votre partition <c>/boot</c>, puis supprimer les images. Vous devez aussi
mettre à jour la configuration de votre chargeur de démarrage afin d'y
supprimer les références à ces anciennes images.
</p>

<p>
Certains utilisateurs de Linux 2.4 auront installé le paquet logiciel
<c>alsa-driver</c> afin de bénificier des nouvelles capacités audio de Linux
2.6. Si vous êtes l'un de ces utilisateurs et que vous avez suivi notre
suggestion qui consiste à installer ALSA à partir des sources d'un noyau 2.6
(plutôt que d'utiliser le paquet <c>alsa-driver</c>), vous pouvez maintenant
supprimer ce paquet afin d'éviter d'éventuels conflits dans le futur.
</p>

<p>
De plus, les utilisateurs de <c>lm-sensors</c> auront tous installé le
paquet <c>i2c</c> afin d'obtenir les pilotes de périphériques. Comme mentionné
plus tôt, les pilotes I2C sont maintenant inclus dans le noyau. Le paquet peut
donc être désinstallé afin de prévenir d'éventuels conflits.
</p>

<p>
Enfin, le démon du gestionnaire de matériel devfs, <c>devfsd</c>, peut lui
aussi être désinstallé en toute quiétude maintenant que vous utilisez udev
pour la gestion de votre matériel.
</p>

<pre caption="Désinstaller alsa-driver, i2c et devfsd">
# <i>emerge --unmerge alsa-driver i2c devfsd</i>
</pre>

<p>
Si vous êtes maintenant un utilisateur de LVM2, vous souhaiterez peut-être
convertir vos données existantes (format LVM1) pour utiliser le format LVM2.
Ainsi, vous bénéficierez des avantages de LVM2. Toutefois, cela vous
empêchera définitivement d'accéder à vos données LVM à partir d'un noyau 2.4.
Si vous voulez procéder à cette conversion (qui est tout à fait
optionnelle&nbsp;!), vous devriez lire la page man de <c>vgconvert</c>. Vous
y trouverez les instructions nécessaires. Un exemple est fourni ci-dessous,
où <c>main</c> est le nom du groupe de volumes.
</p>

<pre caption="Convertir un groupe de volumes LVM1 au format LVM2">
# <i>vgconvert -M2 main</i>
</pre>

</body>
</section>
</chapter>
</guide>

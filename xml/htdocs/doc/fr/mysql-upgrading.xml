<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/mysql-upgrading.xml,v 1.4 2006/03/11 21:10:16 neysx Exp $ -->

<guide link="/doc/fr/mysql-upgrading.xml" lang="fr">
<title>Guide de mise à jour pour MySQL 4.1.x</title>

<author title="Auteur">
  <mail link="citizen428@gentoo.org">Michael Kohl</mail>
</author>
<author title="Auteur">
  <mail link="vivo@gentoo.org">Francesco Riosa</mail>
</author>
<author title="Traducteur">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>

<abstract>
Les développeurs Gentoo qui s'occupent de MySQL sont heureux d'annoncer la
disponibilité de MySQL 4.1 dans Portage. Ce guide devrait vous aider à mettre
votre base de données à jour.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.7</version>
<date>2006-03-11</date>

<chapter>
<title>Mettre une ancienne version de MySQL à jour</title>
<section>
<body>

<p>
Pour mettre MySQL à jour depuis une ancienne version (&lt;4.0.24), il est
nécessaire de passer par la version 4.0.25. Si vous utilisez déjà une version
plus récente, vous pouvez passer à l'étape suivante.
</p>

<pre caption="Mise à jour simple">
# <i>emerge -av --buildpkg "&lt;mysql-4.1"</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Créer une copie de vos données</title>
<section>
<body>

<p>
Une des tâches les plus importantes pour un administrateur de base de données
est la copie de sauvegarde. Procédons&nbsp;:
</p>

<pre caption="« Dump » de toutes les bases">
# <i>mysqldump \</i>
  <i>-uroot \</i>
  <i>--password=</i><comment>'mot_de_passe'</comment><i> \</i>
  <i>-hlocalhost \</i>
  <i>--all-databases \</i>
  <i>--opt \</i>
  <i>--allow-keywords \</i>
  <i>--flush-logs \</i>
  <i>--hex-blob \</i>
  <i>--master-data \</i>
  <i>--max_allowed_packet=16M \</i>
  <i>--quote-names \</i>
  <i>--result-file=BACKUP_MYSQL_4.0.SQL</i>
</pre>

<p>
Un fichier nommé <path>BACKUP_MYSQL_4.0.SQL</path> devrait avoir été créé.
Vous l'utiliserez pour recréer vos bases de données. Ce fichier est une suite
de commandes SQL.
</p>

<p>
Il est recommandé de vérifier que votre copie de sauvegarde pourra
effectivement être utilisée.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Mise à jour depuis une version récente de MySQL</title>
<section>
<body>

<p>
Si vous ne faites pas une mise à jour depuis une ancienne version, vous devez
faire une sauvegarde du logiciel que vous utilisez en ce moment.
</p>

<pre caption="Conserver un paquet binaire de la version actuelle de MySQL">
# <i>quickpkg dev-db/mysql</i>
</pre>

<p>
Ensuite, supprimez la version actuelle et toutes les données&nbsp;:
</p>

<pre caption="Enlever MySQL de votre système">
# <i>/etc/init.d/mysql stop</i>
# <i>emerge -C mysql</i>
# <i>tar cjpvf ~/mysql.$(date +%F_%H-%M).tar.bz2 /etc/mysql/my.cnf /var/lib/mysql/</i>
# <i>ls -l ~/mysql.*</i>
# <i>rm -rf /var/lib/mysql/ /var/log/mysql</i>
</pre>

<note>
Vous devriez maintenant avoir deux copies de sauvegarde. La première est
portable d'une version à l'autre de MySQL et la seconde vous permet de
redémarrer avec la version que vous venez de supprimer.
</note>

<p>
Maintenant que vous avez nettoyé votre installation de MySQL, vous pouvez
installer la nouvelle version. Remarquez que <c>revdep-rebuild</c> est utilisé
pour recompiler tous les paquets qui sont liés à MySQL.
</p>

<pre caption="Mise à jour du logiciel">
# <i>emerge -av "&gt;mysql-4.1"</i>
# <i>dispatch-conf</i>
# <i>revdep-rebuild</i>
</pre>

<p>
Ensuite, configurez la nouvelle installation et démarrez le serveur&nbsp;:
</p>

<pre caption="Configurer MySQL 4.1">
# <i>emerge --config =mysql-4.1.&lt;sous-version&gt;</i>
# <i>/etc/init.d/mysql start</i>
</pre>

<p>
Ensuite, importez vos données.
</p>

<impo>
La configuration par défaut du fichier <path>/etc/mysql/my.cnf</path> active la
journalisation binaire (<c>log-bin</c>). Cette option provoque une
journalisation de toutes les transactions effectuées. Si votre base de données
est relativement grande (p.ex. 1 Go), les fichiers de journalisation peuvent
rapidement occuper tout l'espace disponible sur votre disque. Si l'espace
disque est relativement retreint, il est recommandé de désactiver cette option.
</impo>

<pre caption="Importer les données sauvegardées">
# <i>cat BACKUP_MYSQL_4.0.SQL \</i>
     <i>| mysql \</i>
     <i>-uroot \</i>
     <i>--password=</i><comment>'mot_de_passe'</comment><i> \</i>
     <i>-hlocalhost \</i>
     <i>--max_allowed_packet=16M</i>

# <i>mysql_fix_privilege_tables \</i>
     <i>--defaults-file=/etc/mysql/my.cnf \</i>
     <i>--user=root \</i>
     <i>--password=</i><comment>'mot_de_passe'</comment><i></i>
</pre>

<p>
Si vous redémarrez le serveur MySQL et que tout fonctionne comme avant, vous
avez terminé votre mise à jour.
</p>

<pre caption="Redémarrer le serveur MySQL">
# <i>/etc/init.d/mysql restart</i>
</pre>

<p>
Si vous avez rencontré des problèmes, n'hésitez pas à nous en faire part via
<uri link="https://bugs.gentoo.org">Bugzilla</uri>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Récupérer votre installation de MySQL 4.0</title>
<section>
<body>

<p>
Si vous n'êtes pas satisfait de MySQL 4.1, il est possible de faire marche
arrière et de revenir à la version 4.0.
</p>

<pre caption="Retour à la version 4.0">
# <i>/etc/init.d/mysql stop</i>
# <i>emerge -C mysql</i>
# <i>rm -rf /var/lib/mysql/ /var/log/mysql</i>
# <i>emerge --usepkgonly "&lt;mysql-4.1"</i>
# <i>tar -xjpvf mysql.&lt;date&gt; -C /</i>
# <i>/etc/init.d/mysql start</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Mise à jour directe, non supportée, danger&nbsp;!</title>
<section>
<body>

<p>
Dans certaines conditions, il est possible de faire une mise à jour directement
à la version majeure supérieure. Si vous savez ce que vous faites, ce qui suit
pourrait vous aider&nbsp;:
</p>

<pre caption="Mise à jour directe">
# <i>quickpkg dev-db/mysql</i>
# <i>/etc/init.d/mysql stop</i>
# <i>tar -cjpvf ~/mysql.$(date +%F_%H-%M).tar.bz2 /etc/mysql/my.cnf /var/lib/mysql/</i>
# <i>ls -l ~/mysql.*</i>
# <i>export MYSQL_STRAIGHT_UPGRADE=1</i>
# <i>emerge -av "&gt;mysql-4.1"</i>
# <i>unset MYSQL_STRAIGHT_UPGRADE</i>
# <i>dispatch-conf</i>
# <i>revdep-rebuild</i>
# <i>/etc/init.d/mysql start</i>
# <i>mysql_fix_privilege_tables --defaults-file=/etc/mysql/my.cnf \
     -uroot --password=</i><comment>'mot_de_passe'</comment><i></i>
# <i>mysql --database=mysql -uroot --password=</i><comment>'mot_de_passe'</comment><i> &lt; /tmp/new_pieces.sql</i>
# <i>/etc/init.d/mysql restart</i> <comment># just to be sure</comment>
</pre>

<p>
Bonne chance, si quelque chose se passe mal, vous avez été prévenu.
</p>

</body>
</section>
</chapter>

</guide>

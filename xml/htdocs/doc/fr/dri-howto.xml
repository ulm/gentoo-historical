<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/dri-howto.xml,v 1.18 2007/05/05 18:37:46 cam Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fr/dri-howto.xml" lang="fr">

<title>Guide de l'accélération 3D matérielle</title>

<author title="Auteur">
  <mail link="dberkholz@gentoo.org">Donnie Berkholz</mail>
</author>
<author title="Correcteur">
  <mail link="peesh@gentoo.org">Jorge Paulo</mail>
</author>
<author title="Correcteur">
  <mail link="nightmorph@gentoo.org">Joshua Saddler</mail>
</author>
<author title="Traducteur">
  <mail link="vincent.rubiolo@free.fr">Vincent Rubiolo</mail>
</author>

<abstract>
Ce guide vous aidera à faire fonctionner l'accélération matérielle avec
le DRM et Xorg sur Gentoo Linux.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.8</version>
<date>2007-04-25</date>

<chapter>
<title>Introduction</title>
<section>
<title>Qu'est-ce que l'accélération 3D matérielle et pourquoi en voudrais-je&nbsp;?</title>
<body>

<p>
Avec l'accélération 3D matérielle, le rendu tri-dimensionnel utilise le
processeur graphique de votre carte vidéo au lieu de consommer de précieuses
ressources processeur pour afficher des images en 3D. On appelle également cela
«&nbsp;accélération matérielle&nbsp;» par opposition à «&nbsp;accélération
logicielle&nbsp;», car sans accélération matérielle, votre processeur est
obligé de tout calculer lui-même en utilisant les bibliothèques de rendu Mesa,
ce qui consomme une quantité non négligeable de puissance. Alors qu'Xorg
supporte de façon standard l'accélération matérielle 2D, il lui manque souvent
son équivalent 3D. L'accélération 3D matérielle est appréciable dans des
situations qui requièrent le rendu d'objets 3D comme les jeux, la CAO 3D ou la
modélisation.
</p>

</body>
</section>
<section>
<title>Comment disposer de l'accélération 3D matérielle&nbsp;?</title>
<body>

<p>
Dans de nombreux cas, il existe à la fois des pilotes binaires et des pilotes
libres. Les pilotes libres sont préférables puisque nous utilisons Linux et que
le logiciel libre est l'un de ses principes sous-jacents. Parfois, les pilotes
binaires sont les seuls disponibles, comme pour les cartes nVidia. Les pilotes
binaires sont <c>x11-drivers/nvidia-drivers</c> et
<c>x11-drivers/nvidia-legacy-drivers</c> pour les cartes nVidia et
<c>x11-drivers/ati-drivers</c> pour les cartes ATI. Il existe aussi le pilote
libre <c>media-video/ati-gatos</c> pour les cartes ATI qui essaie de supporter
les capacités vidéo des cartes ATI de façon plus complète.
</p>

</body>
</section>
<section>
<title>Qu'est-ce que DRI&nbsp;?</title>
<body>

<p>
L'<uri link="http://dri.sourceforge.net">Infrastructure de Rendu Direct</uri>,
ou DRI («&nbsp;Direct Rendering Infrastructure&nbsp;»), est une architecture
qui permet d'accéder aux fonctions matérielles des cartes graphiques de
manière sûre et efficace. Il inclut des changements au serveur X, à plusieurs
bibliothèques clientes et au noyau. La première grande utilisation de DRI est
la création d'implémentations rapides d'OpenGL.
</p>

</body>
</section>
<section>
<title>Qu'est-ce que le DRM et quelle est sa relation avec l'Xorg
normal&nbsp;?</title>
<body>

<p>
Le DRM («&nbsp;Direct Rendering Manager&nbsp;») est une <e>amélioration</e> 
d'Xorg qui ajoute l'accélération 3D aux cartes en fournissant le module noyau 
nécessaire au Rendu Direct.
</p>

</body>
</section>
<section>
<title>Objectif</title>
<body>

<p>
Ce guide est destiné aux personnes qui ne peuvent faire fonctionner le
Rendu Direct avec seulement Xorg. Le DRM fonctionne avec les pilotes suivants&nbsp;:
</p>

<ul>
 <li>3dfx</li>
 <li>i8x0</li>
 <li>matrox</li>
 <li>rage128</li>
 <li>radeon</li>
 <li>mach64</li>
 <li>sis300</li>
 <li>via</li>
</ul>

<p>
Visitez le <uri link="http://dri.sourceforge.net">site DRI</uri>
pour plus d'informations et de documentation.
</p>

</body>
</section>
<section>
<title>Retour d'expériences</title>
<body>

<p>
Envoyez vos suggestions ou questions à <mail
link="dberkholz@gentoo.org">Donnie Berkholz</mail>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Installez Xorg et configurez votre noyau</title>
<section>
<title>Installez Xorg</title>
<body>

<p>
Veuillez lire notre <uri link="xorg-config.xml">guide de configuration
d'Xorg</uri> pour installer et lancer Xorg.
</p>

</body>
</section>
<section>
<title>Configurez votre noyau</title>
<body>

<p>
Trouvez le nom/modèle de votre jeu de composants (chipset) et activez
seulement celui-ci.
</p>

<pre caption="Trouvez le nom/modèle de votre jeu de composants AGP">
# <i>emerge pciutils; lspci | grep AGP</i>
# 00:01.0 PCI bridge: Intel Corp. 440BX/ZX/DX - 82443BX/ZX/DX AGP bridge (rev 03)
<comment>(L'affichage sera probablement différent pour votre matériel.)</comment>
</pre>

<p>
Si votre jeu de composants n'est pas supporté par le noyau, vous devriez
essayer de lui passer le paramètre <c>agp=try_unsupported</c> de sorte que le
noyau utilise les routines génériques d'Intel pour le support d'AGP. Pour
ajouter ce paramètre, modifez le fichier de configuration de votre chargeur de
démarrage.
</p>

<p>
La plupart des noyaux, sinon tous, devraient avoir ces options. Ceci a été
configuré en utilisant un noyau standard <c>gentoo-sources</c>.
</p>

<pre caption="Configuration du noyau">
# <i>ls -l /usr/src/linux </i>
lrwxrwxrwx 1 root root 22 2007-02-14 20:12 /usr/src/linux -> linux-2.6.18-gentoo-r4
<comment>(Faites en sorte que /usr/src/linux pointe vers votre noyau.)</comment>
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<pre caption="Les options de make menuconfig">
Processor type and features ---&gt;
&lt;*&gt; MTRR (Memory Type Range Register) support
Device drivers ---&gt;
  Character devices ---&gt;
&lt;M&gt; /dev/agpgart (AGP Support)
<comment>(L'option agpgart n'est pas présente sur les noyaux 64 bits&nbsp;; choisissez juste le support de votre jeu de composants.)</comment>
&lt;M&gt; Intel 440LX/BX/GX, I8xx and E7x05 support
<comment>(Activez le support de votre jeu de composants.)</comment>
&lt;M&gt; Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)
</pre>

</body>
</section>
<section>
<title>Compilez et installez votre noyau</title>
<body>

<pre caption="Compilation et installation noyau">
# <i>make &amp;&amp; make modules_install</i>
</pre>

<p>
N'oubliez pas de configurer votre fichier <path>grub.conf</path> ou 
<path>lilo.conf</path> et de lancer <c>/sbin/lilo</c> ensuite si vous 
utilisez LILO.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Configurez le Rendu Direct</title>
<section id="configure_xorg">
<title>Configurez xorg.conf</title>
<body>

<p>
Ouvrez <path>/etc/X11/xorg.conf</path> et modifiez-le pour activer DRI et GLX.
</p>

<pre caption="Extrait du fichier xorg.conf">
...
Section "Module"
  Load "dri"
  Load "glx"
  ...
EndSection
...
Section "Device"
  Driver "radeon"
<comment>(Remplacez radeon par le nom de votre pilote.)</comment>
  ...
EndSection
...
Section "dri"
  Mode 0666
EndSection
</pre>

</body>
</section>
<section>
<title>Chargez le module pour votre carte graphique automatiquement</title>
<body>

<p>
Vous devez ensuite ajouter le nom du module noyau pour votre carte au fichier
<path>/etc/modules.autoload.d/kernel-2.6</path> pour que ce module soit chargé
automatiquement au démarrage.
</p>

<pre caption="Modifier /etc/modules.autoload.d/kernel-2.6">
<comment>(Spécifiez le nom du module.)</comment>
intel-agp
</pre>

<note>
Si vous avez compilé <c>agpgart</c> en tant que module, il vous faudra
également l'ajouter dans le fichier
<path>/etc/modules.autoload.d/kernel-2.6</path>.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Testez l'accélération 3D</title>
<section>
<title>Redémarrez avec votre nouveau noyau</title>
<body>

<p>
Redémarrez avec votre nouveau noyau et connectez-vous en tant qu'utilisateur
normal. Il est temps de voir si vous disposez du Rendu Direct et quel en est le
bénéfice. <c>glxinfo</c> et <c>glxgears</c> se trouvent dans le paquet
<c>mesa-progs</c>, donc veillez à ce qu'il soit installé avant de pouvoir
exécuter ces commandes.
</p>

<pre caption="Test du rendu">
$ <i>startx</i>
<comment>(Inutile de charger les modules pour votre pilote ou pour agpgart si 
vous avez compilé agpgart comme module.)</comment>
<comment>(Ils seront chargés automatiquement.)</comment>
$ <i>glxinfo | grep rendering</i>
direct rendering: Yes
<comment>(S'il est indiqué "No", vous ne disposez pas de l'accélération 3D.)</comment>

$ <i>glxgears</i>
<comment>(Testez votre nombre d'images par seconde (FPS - Frames Per Second) 
pour la taille par défaut. Ce nombre devrait être significativement plus élevé 
qu'avant la configuration du DRM. Faites ce test lorsque le processeur est en 
train de faire le moins de traitements possibles.)</comment>
</pre>

<note>
Votre nombre d'images par seconde peut être limité par le taux de 
rafraîchissement de votre écran, donc gardez ceci en tête si <c>glxgears</c> ne
vous donne seulement que 70-100 FPS. <c>games-fps/ut2004-demo</c> est une 
meilleure référence, puisqu'il peut vous donner vos performances réelles.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Ajustez vos réglages</title>
<section>
<title>Obtenez le maximum du Rendu Direct</title>
<body>

<p>
Quelques options peuvent améliorer les performances jusqu'à 30% (voire plus)
par rapport aux réglages par défaut. Réglez-les dans
<path>/etc/X11/xorg.conf</path>. Cependant, il vous faudra d'abord vérifier
que votre carte mère et carte vidéo supportent ces options
</p>

<p>
D'abord, voyons si votre carte supporte l'écriture rapide (fast writes). Cela
se fait en inspectant le résultat de la commande <c>lspci</c>. Plus
particulièrement, on s'intéresse à la partie «&nbsp;VGA compatible
controller&nbsp;».
</p>

<pre caption="Vérification de la carte vidéo">
# <i>lspci -vv</i>
01:00.0 VGA compatible controller: ATI Technologies Inc Radeon Mobility M6 LY (prog-if 00 [VGA])
. . .
Capabilities: [58] AGP version 2.0
  Status: RQ=48 Iso- ArqSz=0 Cal=0 SBA+ ITACoh- GART64- HTrans- 64bit- FW+ AGP3- Rate=x1,x2,x4
</pre>

<p>
Même si beaucoup d'informations sont affichées, nous nous préoccuperons
seulement des lettres <b>FW</b> sur la ligne «&nbsp;Status&nbsp;» de la section
«&nbsp;Capabilities&nbsp;». Si <b>FW+</b> est présent sur la ligne
«&nbsp;Status&nbsp;», alors votre carte vidéo supporte l'écriture rapide. Nous
pouvons maintenant vérifier si votre carte-mère le supporte également.
</p>

<impo>
Si vous voyez <b>FW-</b>, à la place de <b>FW+</b>, vous ne pouvez pas activer
l'écriture rapide dans <path>xorg.conf</path> car votre carte ne le supporte
pas.
</impo>

<p>
Vérifions maintenant que votre carte-mère supporte l'écriture rapide. Cette
fois, regardez dans la section «&nbsp;Host Bridge&nbsp;» de <c>lspci</c>.
</p>

<pre caption="Vérification de la carte-mère">
# <i>lspci -vv</i>
00:00.0 Host bridge: Intel Corporation 82830 830 Chipset Host Bridge (rev 02)
. . .
Capabilities: [a0] AGP version 2.0
  Status: RQ=32 Iso- ArqSz=0 Cal=0 SBA+ ITACoh- GART64- HTrans- 64bit- FW+ AGP3- Rate=x1,x2,x4
</pre>

<p>
Encore une fois, vérifiez la ligne «&nbsp;Status&nbsp;» de la section AGP
«&nbsp;Capabilities&nbsp;». Cherchez <b>FW</b>. Si vous voyez <b>FW+</b>,
alors votre carte-mère supporte l'écriture rapide.
</p>

<impo>
Retenez bien qu'il faut que votre carte-mère et votre carte graphique
supportent toutes les deux l'écriture rapide. Si au moins une des deux affiche
<b>FW-</b>, vous ne pourrez pas activer l'écriture rapide dans
<path>xorg.conf</path>.
</impo>

<p>
En supposant que tout va bien et qu'à la fois votre carte-mère et votre carte
vidéo supportent l'écriture rapide, nous allons activer cette option dans
<path>xorg.conf</path> pour obtenir les meilleures performances de votre
matériel.
</p>

<pre caption="Extrait du fichier xorg.conf">
Section "Device"
  Option     "AGPMode" "4"
  <comment>(Ceci a augmenté les FPS de 609 à 618.)</comment>
  Option     "AGPFastWrite" "True"
  <comment>(Ceci n'a pas eu d'effet mesurable, mais peut accroître l'instabilité de votre ordinateur.)</comment>
  <comment>(Vous pourriez avoir également besoin de le régler dans votre BIOS.)</comment>
  Option     "EnablePageFlip" "True"
  <comment>(Ceci a augmenté les FPS de 618 à 702.)</comment>
  <comment>(C'est également "risqué" mais peu de personnes ont eu des problèmes.)</comment>
  ...
EndSection
</pre>

<warn>
Activer l'option <c>AGPFastWrite</c> sur un chipset VIA causera probablement le
gel complet de votre machine. Les chipsets VIA ne fonctionnent pas très bien
avec l'écriture rapide, aussi n'utilisez cette option qu'à vos risques et
périls.
</warn>

<note>
N'oubliez pas que si vous voulez que l'écriture rapide fonctionne correctement,
vous devrez d'abord l'activer dans le BIOS.
</note>

<p>
Si vous souhaitez régler encore plus d'options, consultez la page <uri
link="http://dri.freedesktop.org/wiki/FeatureMatrix">feature matrix</uri> sur
le site Web du DRI, ou encore la page <uri
link="http://dri.sourceforge.net/doc/dri_driver_features.phtml">features
listing</uri> sur Sourceforge.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Dépannage</title>
<section>
<title>Cela ne fonctionne pas. Je n'ai pas de DRI et ne peux expliquer
pourquoi.</title>
<body>

<p>
Essayez <c>modprobe radeon</c> avant de démarrer le serveur X (remplacez 
<c>radeon</c> par le nom de votre pilote). Essayez aussi de compiler agpgart 
directement dans le noyau au lieu d'un module.
</p>

</body>
</section>
<section>
<title>Quand je lance startx, j'ai cette erreur&nbsp;: «&nbsp;[drm] failed to
load kernel module agpgart&nbsp;»</title>
<body>

<p>
C'est parce que vous avez compilé agpgart dans le noyau au lieu de le
mettre en module. Ignorez ce message sauf si vous avez des problèmes.
</p>

</body>
</section>
<section>
<title>J'ai une Radeon et je veux la sortie TV.</title>
<body>

<p>
Jetez un œil aux pilotes <c>ati-gatos</c> (<c>emerge -av ati-gatos</c>).
</p>

</body>
</section>
<section>
<title>Cela ne fonctionne pas. Ma carte est tellement nouvelle qu'elle n'est
pas supportée du tout&nbsp;!</title>
<body>

<p>
Essayez les pilotes binaires. Pour les pilotes <c>ati-drivers</c>, une liste
est disponible sur
<uri>http://ati.amd.com/support/drivers/linux/linux-radeon.html</uri> (pour
x86) et sur
<uri>http://ati.amd.com/support/drivers/linux64/linux64-radeon.html</uri> (pour
amd64). Si ceux-ci ne supportent pas votre carte, utilisez fbdev. C'est lent,
mais ça marche.
</p>

</body>
</section>
<section>
<title>J'ai une carte PCI et cela ne fonctionne pas. A l'aide&nbsp;!</title>
<body>

<p>
Editez le fichier <path>/etc/X11/xorg.conf</path>. Dans la section 
«&nbsp;Device&nbsp;», activez ForcePCIMode.
</p>

<pre caption="Activer de l'option ForcePCIMode">
Option "ForcePCIMode" "True"
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Remerciements</title>
<section>
<body>

<ol>
  <li>
    Christopher Webber qui a suggéré une question de dépannage
    à propos du changement et de la recompilation des noyaux.
  </li>
  <li>
    Steve qui a suggéré la consistance entre dri et DRI dans
    XF86Config.
  </li>
</ol>

</body>
</section>
</chapter>

<chapter>
<title>Références</title>
<section>
<body>

<ol>
  <li><uri>http://forums.gentoo.org/viewtopic.php?t=46681</uri></li>
  <li><uri>http://forums.gentoo.org/viewtopic.php?t=29264</uri></li>
  <li><uri>http://dri.freedesktop.org/</uri></li>
  <li><uri>http://www.retinalburn.net/linux/dri_status.html</uri></li>
</ol>

</body>
</section>
</chapter>
</guide>

<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fr/nvidia-guide.xml,v 1.17 2006/03/07 17:56:09 neysx Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<guide link="/doc/fr/nvidia-guide.xml" lang="fr">
<title>Guide nVidia pour Linux Gentoo</title>

<author title="Auteur">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Correcteur">
  <mail link="curtis119@gentoo.org">M Curtis Napier</mail>
</author>
<author title="Correcteur">
  <mail link="nightmorph@gentoo.org">Joshua Saddler</mail>
</author>
<author title="Traducteur">
  <mail link="cam@gentoo.org">Camille Huot</mail>
</author>
<author title="Traducteur">
  <mail link="koppatroopa@yahoo.fr">Bertrand Coppa</mail>
</author>

<abstract>
De nombreux Gentooistes possèdent une carte nVidia dans leur système. nVidia
fournit des pilotes Linux spécifiques pour améliorer les performances de votre
carte. Ce guide vous explique comment installer et configurer ces pilotes.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://createivecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.22</version>
<date>2006-03-05</date>

<chapter>
<title>Introduction</title>
<section>
<body>

<p>
La compagnie nVidia propose ses propres pilotes graphiques. Ceux-ci offrent de
bonnes performances et une accélération 3D complète. Les distributions des
pilotes comprennent deux composants&nbsp;: <c>nvidia-kernel</c> et
<c>nvidia-glx</c>.
</p>

<p>
<c>nvidia-kernel</c> est un pilote pour le noyau Linux qui prend en charge la
communication de bas niveau avec votre matériel vidéo. Il s'agit simplement
d'un module du noyau, nommé <c>nvidia</c>, installé en fonction de votre arbre
du code source du noyau, et qui doit être chargé à chaque fois que vous
souhaitez utiliser les pilotes nVidia.
</p>

<p>
En plus du pilote du noyau, vous devez installer le composant GLX pour X11
(<c>nvidia-glx</c>). Celui-ci est utilisé par X pour le rendu des images qui se
fait par le biais du pilote <c>nvidia-kernel</c>, ce dernier servant
d'interface vers le matériel.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Configuration de votre carte</title>
<section>
<title>Configuration du noyau</title>
<body>

<p>
Tel que mentionné ci-dessus, les pilotes nVidia sont installés et exécutés en
fonction de votre noyau courant. Puisque le pilote consiste en un module, votre
noyau doit, logiquement, supporter le chargement de modules. Si vous utilisez
<c>genkernel</c> pour la configuration de votre noyau, les paramètres
appropriés ont déjà été choisis pour vous. Autrement, vérifiez vous-même votre
configuration pour vous assurer que les options appropriées sont
sélectionnées&nbsp;:
</p>

<pre caption="Activation du chargement des modules du noyau">
Loadable module support ---&gt;
  [*] Enable loadable module support
</pre>

<p>
Vous devez aussi activer l'option <e>Memory Type Range Register</e>&nbsp;:
</p>

<pre caption="Activer MTRR">
Processor and Features ---&gt;
  [*] MTRR (Memory Type Range Register) support
</pre>

</body>
</section>
<section>
<title>Remarques concernant certaines architectures</title>
<body>

<impo>
Pour les processeurs x86 et AMD64, il y a conflit entre le pilote interne du
noyau et le pilote binaire fourni par nVidia. Si vous compilez votre noyau pour
ces processeurs, il faut retirer complètement le support pour le pilote
interne&nbsp;:
</impo>

<pre caption="Retirer le pilote interne">
Device Drivers ---&gt;
Graphics Support ---&gt;
&lt; &gt;   nVidia Framebuffer Support
&lt; &gt;   nVidia Riva support
</pre>

<p>
Le pilote <c>VESA</c> est une bonne alternative pour le framebuffer&nbsp;:
</p>

<pre caption="Activer le support de VESA">
Device Drivers ---&gt;
Graphics Support ---&gt;
&lt;*&gt;   VESA VGA graphics support
</pre>

<p>
Ensuite, dans la section «&nbsp;VESA driver type&nbsp;», choisissez entre
<c>vesafb</c> ou <c>vesafb-tng</c>&nbsp;:
</p>

<pre caption="Choisir un type de framebuffer">
( ) vesafb
(X) vesafb-tng
</pre>

<p>
Pour plus d'informations, vous pouvez lire
<path>/usr/src/linux/Documentation/fb/vesafb.txt</path> si vous utilisez
<c>vesafb</c> ou bien la documentation correspondant à votre pilote dans le
répertoire <path>/usr/src/linux/Documentation/fb/</path>.
</p>

</body>
</section>
<section>
<title>Poursuivre la configuration du noyau</title>
<body>

<p>
Les bibliothèques et les modules de nVidia sont disponibles dans deux paquets
séparés&nbsp;: <c>nvidia-glx</c> et <c>nvidia-kernel</c>. Le premier contient
les bibliothèques GLX pour X11 tandis que le second contient les modules du
noyau.
</p>

<p>
L'ebuild <c>nvidia-kernel</c> trouve automatiquement la version de votre noyau
grâce au lien symbolique <path>/usr/src/linux</path>. Assurez-vous que ce lien
pointe vers les bonnes sources et que le noyau a été configuré correctement.
Référez-vous à la section Configurer le noyau du <uri
link="/doc/fr/handbook/">Manuel Gentoo Linux</uri> pour obtenir des
instructions détaillées sur la configuration de votre noyau.
</p>

<p>
Si vous utilisez <c>gentoo-sources-2.6.11-r6</c>, votre répertoire
<path>/usr/src/</path> pourrait ressembler à ce qui suit&nbsp;:
</p>

<pre caption="Vérifier le lien symbolique /usr/src/linux">
# <i>cd /usr/src</i>
# <i>ls -l</i>
<comment>(Vérifiez que « linux » pointe vers le bon répertoire.)</comment>
lrwxrwxrwx   1 root root   22 Apr 23 18:33 linux -&gt; linux-2.6.11-gentoo-r6
drwxr-xr-x   4 root root  120 Apr  8 18:56 linux-2.4.26-gentoo-r4
drwxr-xr-x  18 root root  664 Dec 31 16:09 linux-2.6.10
drwxr-xr-x  18 root root  632 Mar  3 12:27 linux-2.6.11
drwxr-xr-x  19 root root 4096 Mar 16 22:00 linux-2.6.11-gentoo-r6
</pre>

<p>
Dans l'exemple ci-haut, remarquez que le lien symbolique <c>linux</c> pointe
vers le noyau <c>linux-2.6.11-gentoo-r6</c>.
</p>

<p>
Si le lien ne pointe pas vers les sources appropriées, vous devez le mettre à
jour comme suit&nbsp;:
</p>

<pre caption="Créer ou mettre à jour le lien symbolique /usr/src/linux">
# <i>cd /usr/src</i>
# <i>ln -snf linux-2.6.11-gentoo-r6 linux</i>
</pre>

</body>
</section>
<section>
<title>Facultatif : Vérification du support pour les anciennes cartes</title>
<body>

<note>
Malheureusement, certains cartes graphiques un peu anciennes ne sont plus
supportées par les dernières versions de <c>nvidia-glx</c> et
<c>nvidia-kernel</c>. nVidia fournit une <uri
link="http://www.nvidia.com/object/IO_18897.html">liste des cartes
supportées</uri>. Veuillez vérifier que votre carte s'y trouve bien avant
d'installer ce pilote.
</note>

<p>
Voici une liste de cartes anciennes qui <b>ne sont plus supportées</b>&nbsp;:
</p>

<pre caption="Cartes graphiques nVidia non supportées">
TNT2
TNT2 Pro
TNT2 Ultra
TNT2 Model 64 (M64)
TNT2 Model 64 (M64) Pro
Vanta
Vanta LT
GeForce 256
GeForce DDR
GeForce2 GTS
GeForce2 Pro
GeForce2 Ti
GeForce2 Ultra
GeForce2 MX Integrated graphics
Quadro
Quadro2 Pro
Quadro2 EX
</pre>

<p>
Si vous possédez une de ces cartes, vous devrez masquer les nouvelles versions
des pilotes nVidia et installer une ancienne version&nbsp;:
</p>

<pre caption="Masquer les pilotes récents">
# <i>echo "&gt;media-video/nvidia-kernel-1.0.6629-r4" &gt;&gt; /etc/portage/package.mask</i>
# <i>echo "&gt;media-video/nvidia-glx-1.0.6629-r7" &gt;&gt; /etc/portage/package.mask</i>
</pre>

</body>
</section>
<section>
<title>Installer les pilotes appropriés</title>
<body>

<p>
Il est maintenant temps d'installer <c>nvidia-kernel</c> et <c>nvidia-glx</c>.
Puisque <c>nvidia-glx</c> dépend de <c>nvidia-kernel</c>, installer le premier
est suffisant.
</p>

<pre caption="Installation des modules nVidia">
# <i>emerge nvidia-glx</i>
</pre>

<impo>
Chaque fois que vous <uri link="/doc/fr/kernel-upgrade.xml">compilez un nouveau
noyau</uri> ou que vous recompilez votre noyau courant, vous devez exécuter
<c>emerge nvidia-kernel</c> pour réinstaller les modules nVidia.
<c>nvidia-glx</c> n'est pas affecté par les changements du noyau&nbsp;; il
n'est même pas nécessaire de le réinstaller lorsque vous mettez à jour (ou
recompilez) X.
</impo>

<p>
Lorsque l'installation est finie, lancez <c>modprobe nvidia</c> pour charger le
module du noyau en mémoire.
</p>

<pre caption="Chargement du module du noyau">
# <i>modprobe nvidia</i>
</pre>

<p>
Pour éviter d'avoir à charger le module à chaque démarrage, vous souhaiterez
sans doute automatiser ce processus. Pour ce faire, éditez le fichier
<path>/etc/modules.autoload.d/kernel-2.6</path> (ou <path>kernel-2.4</path> en
fonction de la version de votre noyau) et ajoutez-y <c>nvidia</c>.  N'oubliez
pas d'exécuter <c>modules-update</c> par après&nbsp;:
</p>

<pre caption="Lancer modules-update">
# <i>modules-update</i>
</pre>

</body>
</section>
<section>
<title>Configuration du serveur X</title>
<body>

<p>
Une fois que les pilotes sont installés, vous devez configurer votre serveur X
(Xorg ou XFree86) pour qu'il utilise le pilote <c>nvidia</c> au lieu du pilote
<c>nv</c> par défaut.
</p>

<p>
Ouvrez <path>/etc/X11/xorg.conf</path> (ou <path>/etc/X11/XF86Config</path> si
vous utilisez encore l'ancien emplacement pour le fichier de configuration)
avec votre éditeur favori (<c>nano</c> ou <c>vim</c> par exemple) et allez à la
section <c>Device</c>. Dans cette section, modifiez la ligne
<c>Driver</c>&nbsp;:
</p>

<pre caption="Remplacement de nv par nvidia dans la configuration du serveur X">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  <i>Driver     "nvidia"</i>
  VideoRam   65536
EndSection
</pre>

<p>
Ensuite, allez à la section <c>Module</c> et assurez vous que le module
<c>glx</c> se charge tandis que le module <c>dri</c> ne se charge pas&nbsp;:
</p>

<pre caption="Mise à jour de la section Module">
Section "Module"
  <comment>(...)</comment>
  <i># Load  "dri"
  Load  "glx"</i>
  <comment>(...)</comment>
EndSection
</pre>

<p>
Puis, dans la section <c>Screen</c>, vérifiez que la directive
<c>DefaultDepth</c> indique 16 ou 24, ou qu'il n'y a pas de sous-section
<c>Display</c> avec des directives <c>Depth</c> qui valent autre chose que 16
ou 24. Si vous spécifiez d'autres profondeurs de couleurs que 16 ou 24, les
extensions nvidia-glx ne fonctionneront pas.
</p>

<pre caption="Mettre la section Screen à jour">
Section "Screen"
  <comment>(...)</comment>
  <i>DefaultDepth 16</i>
  Subsection "Display"
  <comment>(...)</comment>
EndSection
</pre>

<p>
Lancez <c>opengl-update</c> afin que le serveur X utilise les bibliothèques GLX
de nVidia&nbsp;:
</p>

<pre caption="Lancement de opengl-update">
# <i>opengl-update nvidia</i>
</pre>

</body>
</section>
<section>
<title>Ajouter des utilisateurs dans le groupe video</title>
<body>

<p>
Afin que vos utilisateurs puissent accéder aux fichiers de périphérique nVidia,
il faut les ajouter au groupe <c>video</c>&nbsp;:
</p>

<pre caption="Ajout d'un utilisateur au groupe video">
# <i>gpasswd -a nom_utilisateur video</i>
</pre>

<p>
Cela n'est pas forcément obligatoire si vous n'utilisez pas <c>udev</c> mais
cela ne vous fera pas de mal. De plus, votre système sera préparé pour l'avenir
:).
</p>

</body>
</section>
<section>
<title>Test de la carte</title>
<body>

<p>
Pour tester votre carte nVidia, démarrez X et lancez la commande <c>glxinfo |
grep direct</c>. Cela devrait vous répondre que le rendu direct est
activé&nbsp;:
</p>

<pre caption="Vérification de l'état du rendu direct">
$ <i>glxinfo | grep direct</i>
direct rendering: Yes
</pre>

<p>
Pour obtenir votre taux de FPS (images par seconde), lancez <c>glxgears</c>.
</p>

</body>
</section>
<section>
<title>Activer le support nVidia</title>
<body>

<p>
Certains paquets comme <c>mplayer</c> ou <c>xine-lib</c> ont une option USE
locale «&nbsp;nvidia&nbsp;» qui permet d'activer le support XvMCNVIDIA, utile
notamment pour visionner des films en haute résolution. Vous pouvez définir
cette option dans la variable USE de votre fichier <path>/etc/make.conf</path>
ou bien l'ajouter pour les paquets <c>media-video/mplayer</c> et/ou
<c>media-libs/xine-lib</c> dans le fichier
<path>/etc/portage/package.use</path>.
</p>

<p>
Ensuite, exécutez <c>emerge -uD --newuse world</c> pour recompiler les
applications qui utilisent cette option.
</p>

</body>
</section>
<section>
<title>Utiliser les outils de configuration nVidia</title>
<body>

<p>
Depuis la version 1.0.6106 des pilotes nVidia, vous pouvez disposer d'un outil
configuration qui vous permet de modifier les réglages graphiques sans
redémarrer le serveur X. Cet outil est disponible dans Portage sous le nom de
<c>media-video/nvidia-settings</c>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Problèmes</title>
<section>
<title>Faire fonctionner la carte en 2D sur des machines avec 4&nbsp;Go de
mémoire ou plus</title>
<body>

<p>
Si vous avez des problèmes avec l'accélération 2D, il est probable que
l'origine soit un problème d'écriture avec MTRR. Veuillez vérifier le contenu
du fichier <path>/proc/mtrr</path>&nbsp;:
</p>

<pre caption="Vérifier si l'option « write-combining » est activée">
# <i>cat /proc/mtrr</i>
</pre>

<p>
Chaque ligne doit contenir soit «&nbsp;write-back&nbsp;», soit
«&nbsp;write-combining&nbsp;». Si une ligne avec «&nbsp;uncachable&nbsp;»
apparaît, vous devez modifier une option de votre BIOS pour résoudre le
problème.
</p>

<p>
Redémarrez votre machine et cherchez l'option MTRR, en général, dans un menu
«&nbsp;CPU Settings&nbsp;». Changez cette option de «&nbsp;continuous&nbsp;»
en «&nbsp;discrete&nbsp;» et redémarrez Linux. Vous ne devriez plus voir
«&nbsp;uncachable&nbsp;» dans <path>/proc/mtrr</path> et l'accélération 2D
devrait mieux fonctionner.
</p>

</body>
</section>
<section>
<title>Je vois des messages d'erreur «&nbsp;unsupported 4K stack
sizes&nbsp;»</title>
<body>

<p>
Les pilotes nVidia antérieurs à 1.0.6106 ne fonctionnent qu'avec une pile de
8&nbsp;Ko.  Depuis la version 2.6.6, le noyau peut fonctionner avec une pile de
4&nbsp;Ko.  Ne sélectionnez pas cette option dans la configuration de votre
noyau si vous utilisez le paquet <c>nvidia-kernel</c>. Elle se trouve dans la
section <c>Kernel Hacking</c>.
</p>

</body>
</section>
<section>
<title>Lorsque j'essaie de charger le module noyau, je reçois un «&nbsp;no such
device&nbsp;»</title>
<body>

<p>
Cela arrive en général lorsque vous n'avez pas de carte graphique qui
corresponde. Assurez-vous de bien avoir une carte graphique nVidia (vous pouvez
vérifier avec <c>lspci</c>).
</p>

<p>
Si vous êtes sûr d'avoir une carte graphique nVidia, vérifiez que la directive
<e>Assign IRQ to VGA</e> est bien activée dans votre BIOS.
</p>

</body>
</section>
<section>
<title>
J'ai le message «&nbsp;no screens found&nbsp;» et les journaux disent
«&nbsp;Failed to initialize the NVIDIA kernel module!&nbsp;»
</title>
<body>

<p>
Il vous manque probablement les fichiers de périphérique
<path>/dev/nvidia*</path>. Créez-les en utilisant
<c>NVmakedevices.sh</c>&nbsp;:
</p>

<pre caption="Créer les fichiers de périphérique Nvidia">
# <i>/sbin/NVmakedevices.sh</i>
</pre>

<p>
Si les périphériques <path>/dev/nvidia</path> disparaissent à chaque
redémarrage, alors ceci est probablement dû à udev qui ne crée pas
automatiquement les fichiers de périphériques corrects. Vous pouvez corriger
ceci en relançant <c>NVmakedevices.sh</c>, puis en modifiant
<path>/etc/conf.d/rc</path> comme suit&nbsp;:
</p>

<pre caption="Modifier /etc/conf.d/rc">
RC_DEVICE_TARBALL="yes"
</pre>

<p>
Ceci permettra de conserver les fichiers <path>/dev/nvidia</path> même si vous
redémarrer.
</p>

<note>
Autrement, vous pouvez essayer d'utiliser les derniers <c>nvidia-kernel</c> et
<c>nvidia-glx</c> de la série 8xxx. Pour le moment, les deux sont encore
marqués ~arch. Ces pilotes ne se servent plus de hotplug ou udev pour créer les
fichiers de périphérique, il n'est donc pas nécessaire de lancer
<c>NVmakedevices.sh</c>. À la place, le pilote de X créera lui-même les
fichiers <path>/dev/nvidia</path> lorsque vous lancerez X. Cependant, il faut
utiliser un noyau récent (2.6.14 ou plus récent.)
</note>
	 
</body>
</section>
</chapter>

<chapter>
<title>Configuration experte</title>
<section>
<title>Documentation</title>
<body>

<p>
Le paquet logiciel du pilote nVidia contient une documentation exhaustive. Elle
est installée dans le répertoire <path>/usr/share/doc</path> et peut être
consultée avec la commande suivante&nbsp;:
</p>

<pre caption="Consulter la documentation de nVidia">
# <i>less /usr/share/doc/nvidia-glx-*/README.txt.gz</i>
</pre>

</body>
</section>
<section>
<title>Paramètres du module du noyau</title>
<body>

<p>
Le module du noyau <c>nvidia</c> accepte un éventail de paramètres (options)
qui permettent d'ajuster le comportement du pilote. La plupart sont mentionnés
dans la documentation. Pour ajouter ou modifier ces paramètres, éditez le
fichier <path>/etc/modules.d/nvidia</path>. Souvenez-vous d'exécuter
<c>modules-update</c> après ces modifications et gardez à l'esprit que vous
devrez recharger le module <c>nvidia</c> avant que ces modifications ne soient
prises en compte.
</p>

<pre caption="Ajuster la configuration nvidia">
<comment>(Éditez /etc/modules.d/nvidia avec votre éditeur de texte favori.)</comment>
# <i>nano -w /etc/modules.d/nvidia</i>
<comment>(Mettez à jour les fichiers des modules.)</comment>
# <i>modules-update</i>
<comment>Déchargez le module nvidia...)</comment>
# <i>modprobe -r nvidia</i>
<comment>(... et rechargez-le.)</comment>
# <i>modprobe nvidia</i>
</pre>

</body>
</section>
<section>
<title>Configuration avancée de X</title>
<body>

<p>
La couche logicielle GLX offre aussi une pléthore d'options de configuration.
Celles-ci contrôlent la sortie TV, l'utilisation simultanée de deux écrans, la
détection de la fréquence des moniteurs, etc. Ces options sont elles aussi
couvertes dans la documentation.
</p>

<p>
Si vous voulez utiliser certaines de ces options, vous devez les indiquer dans
la section Device appropriée de votre fichier de configuration de X
(habituellement <path>/etc/X11/xorg.conf</path>). Par exemple, supposons que
vous souhaitez désactiver le logo de démarrage&nbsp;:
</p>

<pre caption="Configuration avancée de nVidia dans X">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  Driver     "nvidia"
  <i>Option     "NoLogo" "true"</i>
  VideoRam   65536
EndSection
</pre>

</body>
</section>
</chapter>

</guide>

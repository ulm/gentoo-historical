<?xml version='1.0' encoding='UTF-8'?>
<!-- *$Localization:
target-language: Russian
target-version: 1.16-r1
target-date: 2005-05-28
translated-by: Aleksandr Zelinski [delph@ultranet.ru], Sergey Kuleshov [svyatogor@gentoo.org]
edited-by: none
proof-by: Sergey Kuleshov <svyatogor@gentoo.org>
links_checked_by: none
tested_by: none
-->

<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ru/handbook/hb-install-ppc-bootloader.xml,v 1.1 2005/07/29 07:42:44 sergey Exp $ -->
<!-- REV: 1.27 -->

<sections>

<version>2.4</version>
<date>2005-05-12</date>

<section>
<title>Сделай свой выбор</title>
<subsection>
<title>Введение</title>
<body>

<p>
Теперь, когда выше ядро сконфигурировано и скомпилировано, а также все 
необходимые системные файлы отредактированы, время установить программу, 
которая будет загружать ваше ядро при запуске системы. Такая программя
называются <e>загрузчик</e>. Но прежде чем начать, определитесь со своим 
выбором...
</p>

<p>
Для платформы Linux/PPC существует несколько загрузчиков. Это 
<uri link="#yaboot">Yabooot</uri> (для NewWorld компьютеров Apple и IBM)
и <uri link="#bootx">BootX</uri> (для OldWorld компьютеров Apple).
Pegasos'ам загрузчик не нужен, но вы включаем 
<uri link="#bootcreator">BootCreator</uri> для создания меню SmartFirmware.
</p>

</body>
</subsection>
</section>
<section id="yaboot">
<title>По умолчанию: использование Yaboot</title>
<subsection>
<title>Введение</title>
<body>

<impo>
yaboot можно использовать только на NewWorld компьютерах Apple и IBM!
</impo>

    
<p>
Для начала необходимо создать папку <path>/dev</path> в вашей новой системе,
которая необходима для установки загрузчика. Это можно сделать путем 
"привязки" файловой системы <path>/dev</path> с установочного CD.
</p>

<pre caption="Монтирование файловой системы /dev">
# <i>exit </i> # выйдем из chroot
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>/usr/sbin/env-update &amp;&amp; source /etc/profile </i>
</pre>
    
<p>
Есть 2 пути для конфигурирования Yaboot в вашей системе. Вы можете использовать
<c>yabootconfig</c> для автоматической настройки Yaboot. Если вы не 
хотите использовать <c>yabootconfig</c> для автоматической настройки 
<path>/etc/yaboot.conf</path> или вы устанавливаете Gentoo на G5'ую машину
(на которой <c>yabootconfig</c> не всегда работает), вы можете отредактировать
пример конфигурационного файла, который уже есть в вашей системе.
</p>

<note>
Если вы используете genkernel, возможно вам придется поправить yaboot.conf.
Аргументы предоставленные ebuild'ом genkernel нужно добавить как опции в раздел
настройки образа ядра. Соответствующий раздел yaboot.conf приведен ниже:
</note>

<pre caption="Добавляем опции загрузки в yaboot.conf">
<comment>#################
## This section can be duplicated if you have more than one kernel or set of
## boot options - replace 2.6.9 with your kernel-version
#################</comment>
image=/boot/kernel-2.6.9
  label=Linux
  root=/dev/ram0    <comment># Если вы используете genkernel, то это /dev/ram0</comment>
  partition=3
  sysmap=/boot/System.map-2.6.9
  append="real_root=/dev/hda3 init=/linuxrc"  <comment># Добавьте опции в этой строке</comment>
  read-only
<comment>##################</comment>
</pre>

<ul>
  <li><uri link="#yabootconfig">По умолчанию: использование yabootconfig</uri></li>
  <li>
    <uri link="#manual_yaboot">Альтернативa: конфигурирование Yaboot вручную</uri>
  </li>
</ul>

</body>
</subsection>
<subsection id="yabootconfig">
<title>По умолчанию: использование yabootconfig</title>
<body>

<p>
<c>yabootconfig</c> автоматически определит разделы на вашей машине и установит
двойную или тройную комбинацию загрузки из Linux, Mac OS и Mac OX X.
</p>

<p>
Чтобы использовать <c>yabootconfig</c> на вашем жестком диске должнен быть
раздел Apple_Bootstrap, а также в файле <path>/etc/fstab</path> должны быть 
указаны все ваше разделы. Все это настраивалось ранее. Прежде чем продолжить, 
убедитесь что у вас установлен <c>yaboot</c> последней версии.
</p>

<pre caption = "Установка yaboot с GRP">
# <i>emerge --usepkg --update yaboot</i>
</pre>

<p>
Теперь выйдем из chroot и запустим <c>yabootconfig --chroot /mnt/gentoo</c>.
После запуска программа попросит подтвердить путь к bootstrap разделу.
Введите <c>Y</c> если раздел выбран правильно. Если нет - проверьте файл
<path>/etc/fstab</path>. Далее yabootconfig проверит вашу систему, создаст файл
<path>/etc/yaboot.conf</path> и запустит <c>mkofboot</c>. <c>mkofboot</c>
используется для форматирования Apple_Bootstrap раздела и установки
на него конфигурационных файлов. Затем войдите в chroot снова.
</p>
<pre caption="Вход в chroot">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>/usr/sbin/env-update &amp;&amp; source /etc/profile</i>
</pre>

<p>
Вам следует убедиться в правильности <path>/etc/yaboot.conf</path>. Если вы
измените этот файл (например для выбора основной системы для загрузки), вам
следует запустить <c>ybin -v</c> для того, чтобы изменения вступили в силу.
</p>

<p>
Теперь переходите к разделу <uri link="#reboot">Перезагрузка системы</uri>
</p>

</body>
</subsection>
<subsection id="manual_yaboot">
<title>Альтернатива: конфигурирование Yaboot вручную</title>
<body>

<p>
Для начала убедитесь что у вас установлен <c>yaboot</c> последней версии:
</p>

<pre caption = "Установка yaboot">
# <i>emerge --usepkg --update yaboot</i>
</pre>

<p>
Ниже вы найдете полный <path>yaboot.conf</path>. Измените его по необходимости.
Пользователи с G5 должны помнить, что их Serial ATA диски для ядра выглядят как
SCSI диски (замените <path>/dev/hda</path> на <path>/dev/sda</path>).
</p>

<pre caption = "/etc/yaboot.conf">
<comment>## /etc/yaboot.conf
##
## запустите: "man yaboot.conf" для получения более подробной информации
## До тех пор ничего не меняйте!!!
## смотрите также примеры конфигурации: /usr/share/doc/yaboot/examples 
##
## Для меню с двойной загрузкой добавьте одну или более строк:
## bsd=/dev/hdaX, macos=/dev/hdaY, macosx=/dev/hdaZ

## our bootstrap partition:</comment>

boot=/dev/hda2

<comment>## ofboot это метод указания bootstrap раздела для openfirmware
## Если вы его не укажите yaboot не будет работать на G5'ых и некоторых G4'ых
## и вам придется передать соответствующие оции программам mkofboot/ybin.
## hd:X значит /dev/sdaX (или /dev/hdaX).
## 
## Пользователи G5'ых должны должны раскоментировать эту строку!!!

#ofboot=hd:2

## hd: это open firmware название для hda</comment>
device=hd:

delay=5
defaultos=macosx
timeout=30
install=/usr/lib/yaboot/yaboot
magicboot=/usr/lib/yaboot/ofboot

<comment>#################
## Этот раздел можно повторять, если у вас несколько ядер и вариантов 
## загрузочных опций. Замените 2.6.9 на свою версию ядра.
#################</comment>
image=/boot/kernel-2.6.9
  label=Linux
  root=/dev/hda3
  partition=3
  sysmap=/boot/System.map-2.6.9
  read-only
<comment>##################

## Пользователи G5'ых и некотрых G4'ых должны выставить 
##   macos=hd:13
##   macosx=hd:12
## вместо значений в примере.</comment>
macos=/dev/hda13
macosx=/dev/hda12
enablecdboot
enableofboot
</pre>

<p>
Итак, <path>yaboot.conf</path> настроен правильно, теперь необходимо
запустить <c>mkofboot -v</c> для установки конфигурационных файлов на
загрузочный раздел. <e>Не забудьте сделать это!</e>. Разрешите создание нового
раздела, когда <c>mkofboot</c> об этом попросит. 
</p>

<p>
Если все пройдет успешно и у вас теже настройки, что и выше, то при следующей
перезагрузке вы увидите простое меню с пятью пунктами. Если вы захотите изменить
настройки загрузчика, вам необходимо будет запустить <c>ybin -v</c> для
обновления bootstrap раздела. Утилита <c>mkofboot</c> необходима только для
первичной настройки.
</p>

<p>
Для более подробной информации о Yaboot, зайдите на сайт <uri  
link="http://penguinppc.org/bootloaders/yaboot">проекта Yaboot</uri>. А сейчас,
переходите к разделу <uri link="#reboot">Перезагрузка системы</uri>.
</p>

</body>
</subsection>
</section>
<section id="bootx">
<title>Альтернатива: BootX</title>
<body>

<impo>
BootX можно использовать только на OldWorld компьютерах Apple и IBM!
</impo>

<p>
Т.к. BootX загружает Linux из MacOS, нам придется скопировать ядро с Linux
раздела на раздел с MacOS. Сначала смонтируйте раздел с MacOS извне среды
измененного корня. Используйте <c>mac-fdisk -l</c> чтобы узнать номер раздела.
Далее мы будем использовать sda6. Когда раздел будет подмонтирован, мы скопируем
ядро в системный каталог, чтобы BootX смог его найти.
</p>

<pre caption="Copying the kernel to the MacOS partition">
# <i>exit</i>
cdimage ~# <i>mkdir /mnt/mac</i>
cdimage ~# <i>mount /dev/sda6 /mnt/mac -t hfs</i>
cdimage ~# <i>cp /mnt/gentoo/usr/src/linux/vmlinux "/mnt/mac/System Folder/Linux Kernels"</i>
</pre>

<p>
Если вы использовали genkernel, то ядро находится в другом месте и его надо
скопировать вместе с initrd.
</p>

<pre caption="Copying the Genkernel kernel and initrd to the MacOS partition">
# <i>exit</i>
cdimage ~# <i>mkdir /mnt/mac</i>
cdimage ~# <i>mount /dev/sda6 /mnt/mac -t hfs</i>
cdimage ~# <i>cp /mnt/gentoo/boot/kernel-* "/mnt/mac/System Folder/Linux Kernels"</i>
cdimage ~# <i>cp /mnt/gentoo/boot/initrd-* "/mnt/mac/System Folder"</i>
</pre>


<p>
Теперь, когда ядро скопировано, выйдите из chroot и размонтируйте все 
подмонтированные разделы. Затем введите одну магическую команду: <c>reboot</c>.
</p>

<pre caption="Размонтирование всех разделов и перезагрузка">
cdimage ~# <i>cd /</i>
cdimage ~# <i>umount /mnt/gentoo/proc /mnt/gentoo /mnt/mac</i>
cdimage ~# <i>reboot</i>
</pre>

<p>
Конечно, не забудьте убрать загрузочный CD из привода, иначе система опять
загрузит его, а не MacOS.
</p>

<p>
Теперь ваша машина загружена в MacOS. Откройте панель управления BootX. Выберите
<c>Options</c> и снимите флажок с <c>Used specified RAM disk</c>, если вы не
использовали genkernel. Если вы используете genkernel, проверьте что выбран
именно initrd от genkernel, а не с установочного диска. Если вы не используете
genkernel, то у вас есть возможность указать корневой Linux диск и раздел.
Укажите необходимые опции и, если необходимо, параметры загрузки, зависящие от
кофигурации ядра.
</p>

<p>
BootX можно сконфигурировать для запуска Linux во время загрузки. Если вы
сделаете так, то сначала ваша машина будет загружаться в MacOS, но во время
загрузки BootX запустит и загрузит Linux. Подробнее смотрите тут: <uri
link="http://penguinppc.org/bootloaders/bootx/">домашняя страница BootX</uri>.
</p>

<p>
Теперь сного перезагрузитесь и загрузитесь в Linux, затем продолжите с 
<uri link="?part=1&amp;chap=11">Окончание установки Gentoo</uri>.
</p>

</body>
</section>

<section id="bootcreator">
<title>Альтернатива: BootCreator</title>
<body>

<impo>
BootCreator создаст аккуратное SmartFirmware загрузочное меню на Forth для
Pegasos.
</impo>

<p>
Сначала проверим, что у нас установлена самая свежая версия <c>bootcreator</c>
</p>

<pre caption = "Установка bootcreator">
# <i>emerge --usepkg --update bootcreator</i>
</pre>

<p>
Теперь скопируйте <path>/etc/bootmenu.example</path> в
<path>/etc/bootmenu</path> и отредактируйте так, как в вам нужно:
</p>

<pre caption = "Редкатировния конфигурационного файла bootcreator">
# <i>cp /etc/bootmenu.example /etc/bootmenu</i>
# <i>nano -w /etc/bootmenu</i>
</pre>

<p>
Ниже приведен пример файла <path>/etc/bootmenu</path>. Подстройте его под свои
нужды.
</p>

<pre caption = "Конфигурационный файл bootcreator">
<comment>#
# Example description file for bootcreator 1.1
#</comment>

[VERSION]
1

[TITLE]
Boot Menu

[SETTINGS]
AbortOnKey = false
Timeout    = 9
Default    = 1

[SECTION]
Local HD -> Morphos      (Normal)
ide:0 boot2.img ramdebug edebugflags="logkprintf"

[SECTION]
Local HD -> Linux 2.6.10 (Normal)
ide:0 linux-2.6.10 video=radeonfb:1024x768@70 root=/dev/hda3

</pre>

<p>
Наконец надо перенести <path>bootmenu</path> на Forth и скопировать в
загрузочный раздел, чтобы SmartFirmware мог его прочитать. Значит нам надо
вызвать bootcreator.
</p>

<pre caption = "Установка загрузочного меню">
# <i>bootcreator /etc/bootmenu /boot/menu</i>
</pre>

<note>
После перезагрузки обязательно проверьте настройки SmartFirmware и проверьте,
что по умолчанию загружается именно <path>menu</path> файл.
</note>

<p>
Теперь можете читать раздел <uri link="#reboot">Перезагрузка системы</uri>.
</p>


</body>
</section>

<section id="reboot">
<title>Перезагрузка системы</title>
<subsection>
<body>
<p>
Выйдите из chroot и размонтируйте все подмонтированные разделы.
Затем введите одну магическую команду: <c>reboot</c>.
</p>

<pre caption="Выход из chroot, размонтирование всех разделов и перезагрузка">
# <i>exit</i>
cdimage ~# <i>umount /mnt/gentoo/proc /mnt/gentoo/dev /mnt/gentoo</i>
cdimage ~# <i>reboot</i>
</pre>

<p>
Перезагрузившись в вашу Gentoo, переходите к разделу <uri
link="?part=1&amp;chap=11">Окончание усттановки Gentoo</uri>.
</p>

</body>
</subsection>
</section>
</sections>


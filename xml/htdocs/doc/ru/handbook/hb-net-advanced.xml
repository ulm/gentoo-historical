<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ru/handbook/hb-net-advanced.xml,v 1.2 2006/09/26 11:18:31 achumakov Exp $ -->

<sections>

<version>7.0</version>
<date>2006-08-30</date>

<section>
<title>Расширенная настройка</title>
<body>

<p>
Переменная <c>config_eth0</c> служит основой конфигурации интерфейса.
Она содержит список высокоуровневых инструкций по настройке интерфейса (в 
данном случае, <c>eth0</c>). Все команды списка выполняются последовательно. 
Интерфейс считается работоспособным, если хотя бы одна команда выполнена 
успешно.
</p>

<p>
Вот список встроенных инструкций:
</p>

<table>
<tr>
  <th>Команда</th>
  <th>Описание</th>
</tr>
<tr>
  <ti><c>null</c></ti>
  <ti>Не выполнять никаких действий</ti>
</tr>
<tr>
  <ti><c>noop</c></ti>
  <ti>
    Если интерфейс включен и существует адрес, успешно завершить настройку.
  </ti>
</tr>
<tr>
  <ti>an IPv4 or IPv6 address</ti>
  <ti>Добавить адрес к интерфейсу</ti>
</tr>
<tr>
  <ti>
    <c>dhcp</c>, <c>adsl</c> or <c>apipa</c> (или  команда запуска
    модуля стороннего изготовителя)
  </ti>
  <ti>
    Запустить модуль, реализующий команду. Например, <c>dhcp</c> запускает
    модуль, реализующий DHCP, которым может быть <c>dhcpcd</c>, <c>udhcpc</c>,
    <c>dhclient</c> или <c>pump</c>.
  </ti>
</tr>
</table>

<p>
На случай неудачного выполнения команды можно указать запасную команду.
Запасной вариант должен строго соответствовать структуре конфигурации.
</p>

<p>
Команды можно сцеплять. Вот несколько практических примеров.
</p>

<pre caption="Примеры настройки">
<comment># Задание трех адресов IPv4</comment>
config_eth0=(
  "192.168.0.2/24"
  "192.168.0.3/24"
  "192.168.0.4/24"
)

<comment># Задание одного адреса IPv4 и двух адресов IPv6</comment>
config_eth0=(
  "192.168.0.2/24"
  "4321:0:1:2:3:4:567:89ab"
  "4321:0:1:2:3:4:567:89ac"
)

<comment># Сохранять адрес, присвоенный ядром, до отключения интерфейса.
# При этом назначить другой через DHCP. Если DHCP не работает, 
# задать статический адрес, определяемый APIPA</comment>
config_eth0=(
  "noop"
  "dhcp"
)
fallback_eth0=(
  "null"
  "apipa"
)
</pre>

<note>
При использовании модуля <c>ifconfig</c> для назначения нескольких адресов,
для каждого дополнительного адреса создаются псевдонимы интерфейса. Так,
в двух примерах, приведенных выше, создаются интерфейсы <c>eth0</c>, 
<c>eth0:1</c> и <c>eth0:2</c>. С этими интерфейсами нельзя сделать
ничего особенного, так как и ядро, и другие программы обрабатывают 
<c>eth0:1</c> и <c>eth0:2</c> просто как <c>eth0</c>. 
</note>

<impo>
Порядок настройки запасного режима имеет значение! Если бы мы не указали
инструкцию <c>null</c>, то команда <c>apipa</c> запускалась бы только при
неудачном выполнении команды <c>noop</c>.
</impo>

<note>
<uri link="?part=4&amp;chap=3#apipa">APIPA</uri> и
<uri link="?part=4&amp;chap=3#dhcp">DHCP</uri> обсуждаются позже.
</note>

</body>
</section>
<section>
<title>Сетевые зависимости</title>
<body>

<p>
Сценарии инициализации в <path>/etc/init.d</path> могут находиться в 
зависимости от определенного сетевого интерфейса или просто от службы сети 
(net). Определив переменную <c>RC_NET_STRICT_CHECKING</c> в 
<path>/etc/conf.d/rc</path>, службе <c>net</c> можно придать различный
смысл.
</p>

<table>
<tr>
  <th>Значение</th>
  <th>Описание</th>
</tr>
<tr>
  <ti><c>none</c></ti>
  <ti>Служба <path>net</path> считается всегда работающей.</ti>
</tr>
<tr>
  <ti><c>no</c></ti>
  <ti>
    В основном это означает, что по крайней мере одна служба 
    <path>net.*</path>, кроме <path>net.lo</path>, должна работать. Это 
    может пригодиться пользователям ноутбуков, у которых есть WIFI и 
    статическое проводное подключение, когда нужно, чтобы при включении хотя бы 
    одного интерфейса служба сети выглядела включенной.
  </ti>
</tr>
<tr>
  <ti><c>lo</c></ti>
  <ti>
    То же, что и <c>no</c>, но с учетом <path>net.lo</path>. Может быть полезно
    для тех, кого не волнует, чтобы определенный интерфейс включался при 
    загрузке.
  </ti>
</tr>
<tr>
  <ti><c>yes</c></ti>
  <ti>
    В этом случае ВСЕ сетевые интерфейсы ДОЛЖНЫ работать, чтобы служба 
    <path>net</path> считалась работающей.
  </ti>
</tr>
</table>

<p>
Но как насчет <path>net.br0</path>, зависимого от <path>net.eth0</path> и 
<path>net.eth1</path>? <path>net.eth1</path> может быть беспроводным или 
РРР-устройством, требующим предварительной настройки для возможности включения
в мост. Это невозможно сделать в <path>/etc/init.d/net.br0</path>, так как он 
является символьной ссылкой на <path>net.lo</path>.
</p>

<p>
Ответом является создание своей собственной функции <c>depend()</c> в
<path>/etc/conf.d/net</path>.
</p>

<pre caption="Зависимость net.br0 в /etc/conf.d/net">
<comment># Можно использовать любую зависимость (use, after, before),
# как видно в текущих сценариях</comment>
depend_br0() {
  need net.eth0 net.eth1
}
</pre>

<p>
Более подробно зависимости обсуждаются в разделе <uri 
link="?part=2&amp;chap=4#doc_chap4">Написание сценариев инициализации</uri> 
Настольной книги Gentoo.
</p>

</body>
</section>

<section id="variable_name">
<title>Имена и значения переменных</title>
<body>

<p>
Имена переменных являются динамическими. Обычно они следуют структуре
<c>variable_${interface|mac|essid|apmac}</c>. Например, значение переменной
<c>dhcpcd_eth0</c> хранит параметры dhcpcd для eth0, а переменной 
<c>dhcpcd_essid</c> &mdash; параметры dhcpcd, используемые при подключении 
любого интерфейса к ESSID &laquo;essid&raquo;. 
</p>

<p>
Однако, не существует твердого простого правила, устанавливающего, что
интерфейсы должны называться ethx. На деле, имена многих беспроводных
выглядят как wlanx, rax и ethx. Кроме того, некоторые пользовательские 
интерфейсы, например, мосты, можно называть как угодно, например, foo. Для 
пущего разнообразия, в именах беспроводных точек доступа также допускаются 
знаки, не входящие в алфавитно-цифровые; это имеет значение, потому что есть
возможность настройки сетевых параметров для отдельных ESSID.
</p>

<p>
Оборотная сторона всего этого в том, что для настройки сети в Gentoo 
используются переменные bash, а bash не в состоянии использовать что-либо кроме 
знаков английского алфавита и цифр. Чтобы обойти такое ограничение, мы заменяем 
каждый символ, не являющийся английским буквенно-цифровым, на знак 
подчеркивания: <c>_</c>.
</p>

<p>
Другая особенность bash &mdash; это значения переменных: некоторые символы
требуют специальной записи, перед ними помещается знак <c>\</c>. Им 
необходимо предварять следующие символы: <c>"</c>, <c>'</c> и <c>\</c>.
</p>

<p>
В следующем примере мы используем беспроводные ESSID, так как в них может 
содержаться самое широкое множество символов. Мы воспользуемся ESSID
<c>My "\ NET</c>:
</p>

<pre caption="Пример имени переменной">
<comment># Этот пример работает, но домен не существует</comment>
dns_domain_My____NET="My \"\\ NET"

<comment># Предыдущая строка устанавливает домен dns в My "\ NET при 
# подключении беспроводной платы к точке доступа с ESSID My "\ NET.</comment>
</pre>

</body>
</section>
</sections>

<!-- *$Localization:
target-language: Russian
target-version: 7.0-r1
target-date: 2006-09-25
source-cvs-revision: 1.12
translated-by: Igor Naum [naumi@vesti-rtr.com]
edited-by: Alexey Chumakov [achumakov@gentoo.org]
-->

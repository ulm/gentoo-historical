<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ru/gcc-upgrading.xml,v 1.1 2006/01/26 21:33:37 achumakov Exp $ -->

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/ru/gcc-upgrading.xml" lang="ru">
<title>Руководство Gentoo Linux по обновлению GCC</title>

<author title="автор">
  <mail link="amne@gentoo.org">Wernfried Haas</mail>
</author>
<author title="автор">
  <mail link="jkt@gentoo.org">Jan Kundrat</mail>
</author>
<author title="редактор">
  <mail link="halcy0n@gentoo.org">Mark Loeser</mail>
</author>
<author title="переводчик">
  <mail link="nerowolfe@hotmail.ru">Юрий Астахов</mail>
</author>
<author title="редактор перевода">
  <mail link="achumakov@gentoo.org">Алексей Чумаков</mail>
</author>

<abstract>
Этот документ проводит пользователя через процесс обновления компилятора GCC на
своей машине с Gentoo Linux.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<!-- Текст этого документа распространяется на условиях лицензии CC-BY-SA -->
<!-- См. http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>3</version>
<date>2005-12-08</date>

<chapter id="intro">
<title>Введение</title>
<section>
<title>Обновление GCC</title>
<body>

<p>
Зачем нужно обновлять? Ну, GCC довольно похож на любой другой пакет
в вашей системе, но чуточку более важен. GCC следует обновлять всякий
раз, когда в новой версии исправляются какие-нибудь раздражающие вас ошибки,
добавляется новые нужные функции, или если вы хотите держать свою систему 
обновленной. Если ни один из этих случаев к вам не относится, обновление
можно спокойно откладывать, пока ваша версия GCC поддерживается разработчиками 
Gentoo.
</p>

<p>
Если вы устанавливаете новую версию GCC, система не переключается на ее
использование автоматически. Вам необходимо явно запросить изменение,
потому что в процессе перехода может потребоваться несколько дополнительных 
шагов. Если вы решите не переключаться, система Portage продолжит использовать 
более старую версию компилятора, пока вы не передумаете или пока не удалите 
старый компилятор из своей системы.
</p>

<p>
В этом руководстве описываются шаги, нужные для гладкого обновления 
компилятора, используемого вашей системой Gentoo. Отдельный раздел посвящен 
<uri link="#upgrade-3.3-to-3.4">переходу с GCC 3.3 на 3.4</uri> и проблемам с 
<c>libstdc++</c>.
</p>

</body>
</section>
</chapter>

<chapter id="upgrade-general">
<title>Общие указания по обновлению</title>
<section>
<title>Введение</title>
<body>

<impo>
Если вам нужны конкретные указания по обновлению с GCC-3.3 на GCC-3.4,
обратитесь к <uri link="#upgrade-3.3-to-3.4">соотвествующему разделу</uri>.
</impo>

<p>
Вообще говоря, переход на <e>версии с исправленными ошибками (bugfix 
release)</e>, как с 3.3.5 на 3.3.6, должен быть довольно безопасен: надо только 
установить новую версию, переключиться на нее и пересобрать единственный 
затрагиваемый пакет &mdash; <c>libtool</c>. Однако, при некоторых обновлениях
GCC нарушается двоичную совместимость, в таких случаях может потребоваться
пересборка не только затрагиваемых пакетов, но и даже всего системного набора
и пакетов, необходимых для компиляции.
</p>

<p>
Говоря о  необходимости ручного переключения на новую версию компилятора,
мы сказали, что оно не происходит автоматически. Тем не менее, есть одно 
исключение &mdash; переход на версию с исправленными ошибками (как с 3.3.5 
на 3.3.6), если не используется режим &laquo;multislot&raquo;, позволяющий 
обеим версиям сосуществовать в одной системе. По умолчанию этот режим выключен, 
ведь большинству пользователей он ничего не дает.
</p>

<pre caption="Обновление GCC">
# <i>emerge -uav gcc</i>

<comment>(Вместо "i686-pc-linux-gnu-3.4.4" укажите обновленную
 версию GCC и настройки CHOST)</comment>
# <i>gcc-config i686-pc-linux-gnu-3.4.4</i>
# <i>source /etc/profile</i>

<comment>(Пересборка libtool)</comment>
# <i>emerge --oneshot -av libtool</i>
</pre>

<p>
Теперь пересоберите набор программ для компиляции, затем world, используя новый 
компилятор.
</p>

<pre caption="Пересборка системы">
# <i>emerge -eav system</i>
# <i>emerge -eav world</i>
</pre>

<p>
Теперь можно без опасений удалить старую версию GCC. Если вы чувствуете такую 
необходимость, введите следующую команду (как обычно, вместо 
<c>=sys-devel/gcc-3.3*</c> укажите версию, которую собираетесь удалить):
</p>

<pre caption="Удаление более старой версии GCC">
# <i>emerge -aC =sys-devel/gcc-3.3*</i>
</pre>

</body>
</section>
</chapter>

<chapter id="upgrade-3.3-to-3.4">
<title>Переход с GCC-3.3 на 3.4</title>
<section>
<title>Введение</title>
<body>

<p>
Переход с GCC/3.3 на 3.4 не так гладок, ведь между этими версиями изменился
двоичный прикладной интерфейс C++ (ABI), так что заодно нужно позаботиться о 
вопросе с библиотекой <c>libstdc++</c>.
</p>

</body>
</section>
<section id="upgrade-3.3-to-3.4-choices">
<title>Варианты</title>
<body>

<p>
У вас есть два варианта обновления системы. <uri 
link="#upgrade-3.3-to-3.4-revdep-rebuild">Первый способ</uri> быстрее и 
требует использования программы <c>revdep-rebuild</c> из пакета
<c>gentoolkit</c>, а <uri link="#upgrade-3.3-to-3.4-emerge-e">во втором</uri> 
вся системы пересобирается с нуля, чтобы задействовать новые возможности GCC. 
Ваше дело, какой из способов выбрать.
</p>

</body>
</section>
<section id="upgrade-3.3-to-3.4-revdep-rebuild">
<title>Использование revdep-rebuild</title>
<body>

<p>
При этом способе нужно сначала установить <c>gentoolkit</c>, если вы еще этого 
не сделали. Затем мы обновим GCC и перейдем на новый компилятор. Мы также 
пересоберем пакет <c>libtool</c>, чтобы обеспечить пригодность программ для 
компиляции.
</p>

<pre caption="Установка gentoolkit и обновление GCC">
# <i>emerge -an gentoolkit</i>
# <i>emerge -uav gcc</i>
# <i>gcc-config i686-pc-linux-gnu-3.4.4</i>
# <i>source /etc/profile</i>

<comment>(Пересборка libtool)</comment>
# <i>emerge --oneshot -av libtool</i>
</pre>

<note>
Предполагается, что установлен флаг <c>CHOST="i686-pc-linux-gnu"</c>. Если
вы используете другой CHOST, пожалуйста используйте соответствующие параметры
gcc-config.
</note>

<p>
Теперь посмотрим, какие пакеты собирается пересобирать revdep-rebuild.
Затем запустим revdep-rebuild на собственно пересборку. Это займет некоторое 
время, так что потерпите.
</p>

<pre caption="Использование revdep-rebuild">
# <i>revdep-rebuild --library libstdc++.so.5 -- -p -v</i>
# <i>revdep-rebuild --library libstdc++.so.5</i>
</pre>

<note>
Возможно, у вас появятся проблемы с несуществующими версиями пакетов
из-за того, что они устарели или замаскированы. В этом случае можно 
при запуске <c>revdep-rebuild</c> указать параметр <c>--package-names</c>. 
Это заставит пакеты пересобираться, основываясь на именах пакетов, вместо 
точного имени и версии.
</note>

<p>
Для обеспечения совместимости с более старыми двоичными приложениями C++ и
любыми пакетами, которые revdep-rebuild мог пропустить, надо установить пакет
<c>sys-libs/libstdc++-v3</c> до того, как удалять GCC 3.3 из своей системы.
</p>

<pre caption="Установка libstdc++-v3 и удаление GCC">
# <i>emerge --oneshot sys-libs/libstdc++-v3</i>
# <i>emerge -aC =sys-devel/gcc-3.3*</i>
</pre>

</body>
</section>
<section id="upgrade-3.3-to-3.4-emerge-e">
<title>Использование emerge -e</title>
<body>

<p>
Этот способ, будучи гораздо медленнее, пересобирает всю систему, давая 
уверенность в том, что все пересобрано новым компилятором, и, следовательно, 
безопаснее. Сперва потребуется обновить GCC и libtool, и переключить систему на
новый компилятор.
</p>

<pre caption="Обновление GCC">
# <i>emerge -uav gcc</i>
# <i>gcc-config i686-pc-linux-gnu-3.4.4</i>
# <i>source /etc/profile</i>

<comment>(Пересборка libtool)</comment>
# <i>emerge --oneshot -av libtool</i>
</pre>

<note>
Здесь предполагается, что установлен флаг <c>CHOST="i686-pc-linux-gnu"</c>. Если
используется другой CHOST, пожалуйста, используйте соответствующие параметры
gcc-config.
</note>

<p>
Для обеспечения совместимости с более старыми двоичными приложениями C++, надо 
установить в систему пакет <c>sys-libs/libstdc++-v3</c>.
</p>

<pre caption="Установка libstdc++-v3">
# <i>emerge --oneshot sys-libs/libstdc++-v3</i>
</pre>

<p>
Теперь займемся пересборкой сначала пакетов system, а затем world. Это займет
очень длительное время, зависящее от количества установленных пакетов: ведь
будут пересобираться все средства компиляции и поддерживающие системные
файлы, а затем каждый пакет, находящийся в вашей системе. Это необходимо, 
что все пакеты были гарантированно скомпилированы уже с новыми средствами 
компиляции, включая сами эти средства.
</p>

<pre caption="Пересборка system и world">
# <i>emerge -e system</i>
# <i>emerge -e world</i>
</pre>

<p>
Также надежнее удалить более старые версии GCC сейчас:
</p>

<pre caption="Очистка">
# <i>emerge -aC =sys-devel/gcc-3.3*</i>
</pre>

</body>
</section>
</chapter>

<chapter id="common-pitfalls">
<title>Обычные грабли</title>
<section>
<body>

<p>
Важно на время обновления отключить <c>distcc</c>. Смешение версий компилятора 
на разных узлах <e>вызовет</e> проблемы при сборке. Это не относится к 
ccache, так как объекты кэша будут в любом случае сделаны недействительными.
</p>

<p>
Всегда используйте одну и ту же версию GCC для своего ядра и дополнительных 
модулей ядра. Как только вы пересоберете world с новым GCC, внешние модули 
(например, <c>app-emulation/qemu-softmmu</c>) не смогут загрузиться. Пожалуйста,
чтобы это исправить, пересоберите свое ядро новой версией GCC.
</p>

</body>
</section>
<section>
<title>Распространенные сообщения об ошибках</title>
<body>

<p>
Если ваша система жалуется на что-то вроде <e>libtool: link:
`/usr/lib/gcc-lib/i686-pc-linux-gnu/3.3.6/libstdc++.la' is not a valid
libtool archive</e>, запустите <c>/sbin/fix_libtool_files.sh 3.3.6</c>
(замените &laquo;3.3.6&raquo; на номер версии из сообщения об ошибке).
</p>

<p>
Если вы увидели <e>error: /usr/bin/gcc-config: line 632:
/etc/env.d/gcc/i686-pc-linux-gnu-3.3.5: No such file or directory</e>,
тогда попробуйте удалить
<path>/etc/env.d/gcc/config-i686-pc-linux-gnu</path> и снова запустить
<c>gcc-config</c>, следом указав <c>source /etc/profile</c>. Делайте это
только тогда, когда у вас не настроены никакие кросс-компиляторы.
</p>

<p>
Если при <c>emerge -e system/world</c> не собирается пакет, выполнение
можно продолжить командой <c>emerge --resume</c>. Если ошибка появляется
снова и снова, пропустите пакет, указав <c>emerge --resume --skipfirst</c>.
Не запускайте параллельно другие экземпляры emerge, чтобы не потерять
информацию, нужную для возобновления.
</p>

<p>
Если во время обновления компиляторв встретится ошибка <e>spec failure: 
unrecognized spec option</e>, попробуйте откатиться на свой компилятор по 
умолчанию, убрать переменную <c>GCC_SPECS</c> и снова обновить компилятор:
</p>

<pre caption="Восстановление первичной настройки компилятора">
# <i>gcc-config 1</i>
# <i>source /etc/profile</i>
# <i>unset GCC_SPECS</i>
# <i>emerge -uav gcc</i>
</pre>

</body>
</section>

</chapter>
</guide>
<!-- *$Localization:
target-language: Russian
target-version: 3
target-date: 2006-01-26
source-cvs-revision: 1.4
translated-by: Yuri Astakhov
edited-by: Alexey Chumakov [achumakov@gentoo.org]     
-->

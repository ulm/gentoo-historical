<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ru/gentoo-x86-tipsntricks.xml,v 1.6 2006/11/08 17:10:09 achumakov Exp $ -->

<guide link="/doc/ru/gentoo-x86-tipsntricks.xml" lang="ru">
<title>Полезные советы по установке Gentoo/x86</title>

<author title="автор">
    <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="редактор">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="переводчик">
   <mail link="deadlyFROZEN@yandex.ru">Илья Крец</mail>
</author>
<author title="переводчик">
   <mail link="BanderaZZZ@kondopoga.ru">Антон Кекконен</mail>
</author>
<author title="редактор перевода">
   <mail link="svyatogor@gentoo.org">Сергей Кулешов</mail>
</author>
<author title="редактор перевода">
   <mail link="achumakov@gentoo.org">Алексей Чумаков</mail>
</author>

<abstract>
Процесс установки Gentoo очень гибок и дает возможность "пофантазировать". Так 
как каждый полезный совет невозможно включить в инструкции по установке, мы
стараемся собирать все присланные советы и хитрости в этом документе.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<!-- Текст этого документа распространяется на условиях лицензии CC-BY-SA -->
<!-- См. http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.12</version>
<date>2006-10-04</date>

<chapter>
<title>Вступление</title>
<section>
<title>Для начала</title>
<body>

<p>
Этот документ содержит различные полезные советы по установке Gentoo/x86. 
Большинство из них описаны кратко &mdash; подразумевается, что они послужат 
дополнением к руководству по установке, а не заменой ему.
</p>

</body>
</section>
<section>
<title>Содержание</title>
<body>

<p>
<b>Расширенная установка</b>
</p>

<ul>
  <li><uri link="#software-raid">Программный RAID</uri></li>
  <li><uri link="#ata-raid-2.4">ATA RAID с ядрами 2.4</uri></li>
  <li><uri link="#livecd-kernel">Использование ядра с установочного CD</uri></li>
</ul>

<p>
<b>Упрощение установки</b>
</p>

<ul>
  <li><uri link="#leave_terminal">Как оставить терминал</uri></li>
</ul>

<p>
<b>Решение ошибок/проблем</b>
</p>

<ul>
  <li>
    <uri link="#checking-disks">Детальное тестирование ваших дисков</uri>
  </li> 
  <li>
    <uri link="#recover">Восстановление сбойной установки</uri>
  </li>
</ul>

</body>
</section>
</chapter>
<chapter>
<title>Расширенная установка</title>
<section id="software-raid">
<title>Программный RAID</title>
<body>

<note>
Если вы не знакомы с программным RAID, пожалуйста, прочтите <uri
link="http://tldp.org/HOWTO/Software-RAID-HOWTO.html">Software-RAID-HOWTO</uri>
(англ.). 
</note>

<note>
Более подробное описание установки приведено в <uri
link="/doc/en/gentoo-x86+raid+lvm2-quickinstall.xml">руководстве по быстрой
установке программного RAID и LVM2 для x86</uri> (англ.).
</note>

<p>
После загрузки с установочного CD, загрузите соответствующие модули RAID.
Например, если вы собираетесь использовать RAID-1:
</p>

<pre caption="Загрузка модуля RAID-1">
# <i>modprobe raid1</i>
</pre>

<p>
Разбивая свои диски, убедитесь, что используете тип раздела <c>fd</c> 
(Linux raid autodetect), а не <c>83</c> (Linux native). Тип раздела можно
изменить, используя команду <c>t</c> программы <c>fdisk</c>.
</p>

<p>
Теперь, до начала создания массивов RAID, нам потребуется создать узлы
метаустройств:
</p>

<pre caption="Создание узлов метаустройств">
# <i>mknod /dev/md1 b 9 1</i>
# <i>mknod /dev/md2 b 9 2</i>
# <i>mknod /dev/md3 b 9 3</i>
</pre>

<p>
После разбивки на разделы, создайте файл <path>/etc/mdadm.conf</path> (да,
именно так, в среде установочного CD), с помощью <c>mdadm</c>, расширенного
средства <uri
link="http://www.linuxdevcenter.com/pub/a/linux/2002/12/05/RAID.html">управления
RAID</uri>. Например, чтобы зеркалировать (RAID-1) разделы boot, swap и root,
охватывая <path>/dev/sda</path> и <path>/dev/sdb</path>, можете использовать:
</p>

<pre caption="Создание устройств raid командой mdadm">
# <i>mdadm --create --verbose /dev/md1 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</i>
# <i>mdadm --create --verbose /dev/md2 --level=1 --raid-devices=2 /dev/sda2 /dev/sdb2</i>
# <i>mdadm --create --verbose /dev/md3 --level=1 --raid-devices=2 /dev/sda3 /dev/sdb3</i>
</pre>

<impo>
На загрузочном разделе не следует использовать никаких разновидностей
чередования (striping), таких как RAID-0 or RAID-5.
</impo>

<p>
Драйвер Linux Software RAID начнет создавать метаустройства. Вы можете 
проследить за этим в <path>/proc/mdstat</path>. Перед продолжением дождитесь,
пока создание метаустройств окончательно завершится..
</p>

<pre caption="Сохранение сведений о созданных устройствах">
# <i>mdadm --detail --scan > /etc/mdadm.conf</i>
</pre>

<p>
Теперь и далее используйте <path>/dev/md1</path> для загрузочного раздела, 
<path>/dev/md2</path> для раздела подкачки и <path>/dev/md3</path> для 
корневого раздела.
</p>

<p>
Прямо перед изменением корня (chroot), не забудьте скопировать
<path>/etc/mdadm.conf</path> в <path>/mnt/gentoo/etc</path>.
</p>

<p>
При конфигурации ядра, обязательно включите соответствующую поддержку RAID
<e>в состав</e> ядра, а не модулем.
</p>

<p>
При установке дополнительных утилит, также установите <c>mdadm</c>. Заметьте,
что она есть не на всех установочных CD, поэтому у вас может не получиться
бессетевая установка Gentoo на программный raid.
</p>

<p>
При настройке загрузчика не забудьте установить его в MBR <e>обоих</e>
дисков, если используется зеркалирование.
</p>

</body>
</section>
<section id="ata-raid-2.4">
<title>ATA RAID c ядрами 2.4</title>
<body>

<p>
Удостоверьтесь, что вы загрузились с установочного CD с параметром
<c>doataraid</c>. После загрузки, проверьте содержимое
<path>/dev/ataraid</path>. Там должны находиться различные каталоги 
<path>disc*</path> для каждого жесткого диска, доступного в ATA RAID.
Целый диск показывается как <path>disc</path>, а разделы &mdash; как
<path>part*</path>.
</p>

<p>
Выпишите различные файлы устройств <path>/dev/ataraid/disc*/*</path>, на
которые будете устанавливать Gentoo. При установке вам потребуется указывать
этот путь вместо <path>/dev/hda</path>, указанного в примерах.
</p>

<p>
Перед изменением корня, свяжите структуру <path>/dev</path> с новой
средой:
</p>

<pre caption="Связывание /dev">
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
</pre>

<p>
При настройке ядра не забудьте включить поддержку вашего ATA RAID чипсета с 
нужными параметрами. Например, для популярной системы ATA RAID <e>Promise
FastTrack built-in RAID</e> требуется включение в ядро <c>Promise FastTrack
Options</c>.
</p>

<p>
При настройке GRUB сначала потребуется создать загрузочный диск GRUB. Это не 
так сложно, как кажется. Сначала установите GRUB как обычно, а дойдя до пункта,
в котором GRUB устанавливается в MBR, следуйте этим инструкциям:
</p>

<pre caption="Создание загрузочного диска GRUB">
# <i>cd /boot/grub</i>
# <i>dd if=stage1 of=/dev/fd0 bs=512 count=1</i>
# <i>dd if=stage2 of=/dev/fd0 bs=512 seek=1</i>
</pre>

<p>
Еще вам потребуется записать файл <path>grub.conf</path>. Здесь нет никаких 
отличий от установочных инструкций, просто убедитесь, что запись <c>root=</c> 
указывает на ваше устройство ATA RAID.
</p>

<p>
После окончания установки, загрузитесь со своего загрузочного диска GRUB. Вы 
должны увидеть приглашение командной строки GRUB. Теперь настройте GRUB для 
загрузки с устройства ATA RAID:
</p>

<pre caption="Установка GRUB на ATA RAID">
grub&gt; root (hd0,x)
grub&gt; setup (hd0)
grub&gt; quit
</pre>

<p>
Теперь перезагрузитесь (вытащив загрузочную дискету GRUB из дисковода).
</p>

<p>
Пользователи LILO могут просто следовать указаниям руководства по установке.
</p>

</body>
</section>
<section id="livecd-kernel">
<title>Использование ядра с установочного CD</title>
<body>

<p>
Если вы не хотите компилировать ядро сами, можно взять ядро с установочного
компакт-диска и скопировать его в свою систему. Дойдя в процессе инсталяции
Gentoo до стадии компиляции ядра, перейдите на другую виртуальную консоль
(Alt-F2) и войдите в систему как ROOT, используя пароль, установленный
вами в начали установки (passwd root).
</p>

<p>
Скопируйте ядро и модули в свою систему:
</p>

<pre caption="Копирование ядра с установочного CD">
<comment>(${KN} это название ядра, обычно это что-то вроде 'gentoo' или 'smp')</comment>
cdimage ~# <i>cp /mnt/cdrom/isolinux/${KN} /mnt/cdrom/isolinux/${KN}.gz /mnt/gentoo/boot</i>
cdimage ~# <i>mkdir -p /mnt/gentoo/lib/modules</i>
cdiamge ~# <i>cp -Rp /lib/modules/`uname -r` /mnt/gentoo/lib/modules</i>
</pre>

<p>
Удостоверьтесь в том, что вы установили hotplug (<c>emerge hotplug</c>) и уже
добавили его в загрузку. Чтобы все запущенные сейчас модули (с установочного CD)
загружались на вашей машине, запустите следующие команды из среды с измененным
корнем (chroot):
</p>

<pre caption="Добавление всех запущенных модулей в файл modules.conf">
# <i>cat /proc/modules | cut -d ' ' -f 1 &gt;&gt; \</i>
  <i>/etc/modules.autoload.d/kernel-`uname -r | cut -d . -f -2`</i>
# <i>modules-update</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Упрощение установки</title>
<section id="leave_terminal">
<title>Как оставить терминал без присмотра</title>
<body>

<p>
Многим хочется отойти от своей системы, пока она компилируется. Иногда это
довольно сложно, поскольку установка производится в месте, где много народу
и нельзя доверять всем подряд. На этот случай пригодится возможность 
проводить компиляцию в фоновом режиме, выйдя изо всех терминалов.
</p>

<p>
Есть несколько возможных путей. Первый &mdash; использовать <c>screen</c>.
После загрузки с LiveCD, установите пароль для root и запустите сеанс screen:
</p>

<note>
screen есть не на всех LiveCD. Если у вас его нет, придется использовать один
из других способов, описанных в этом разделе.
</note>

<pre caption="Запуск сеанса screen">
# <i>screen -S gentoo</i>
</pre>

<p>
Из сеанса screen можно хоть провести полную установку. Захотев уйти от
терминала, нажмите <c>Ctrl-a, d</c> (то есть control и a одновременно, затем
d), чтобы <e>открепить</e> свой сеанс screen. Теперь можно с уверенностью
выйти из системы.
</p>

<p>
Чтобы восстановить доступ к терминалу, опять войдите как root и
<e>прикрепитесь</e> к запущенному сеансу screen: 
</p>

<pre caption="Прикрепление к сеансу screen">
# <i>screen -x gentoo</i>
</pre>

<p>
Если вы не можете использовать screen, есть другой путь отойти от терминала. 
Следуйте инструкциям по установке, а дойдя до пункта, в котором запускается
длительная компиляция (например, шаг с запуском <c>./scripts/bootstrap.sh</c>),
используйте команду <c>nohup</c>, которая позволит процессу продолжиться, даже
если вы выйдете. Не забудьте добавить в конце "&amp;", иначе процесс не будет
выполняться в фоновом режиме! Запомните, в каком каталоге вы находитесь
(команда <c>pwd</c> покажет ее), так как это вам позже понадобится.
</p>

<pre caption="Использование nohup">
# <i>pwd</i>
/usr/portage
# <i>nohup ./scripts/bootstrap.sh &amp;</i>
</pre>

<p>
Теперь выйдите из среды измененного корня (<c>exit</c>) и из сеанса
загрузочного CD. Компиляция продолжится в фоновом режиме.
</p>

<p>
Захотев проверить компиляцию, войдите как root (на установочный CD) и сделайте
chroot обратно в свою среду, затем перейдите в оставленный каталог:
</p>

<pre caption="Chroot обратно">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update &amp;&amp; source /etc/profile</i>
# <i>cd /usr/portage</i>
</pre>

<p>
Теперь запустите команду <c>less</c> на файле <path>nohup.out</path>, 
расположенном внутри каталога. Компиляция добавляет свои сообщения 
в этот файл, так что при желании следить за ней запустите <c>less 
nohup.out</c> и нажмите <c>F</c>, чтобы наблюдать за ее ходом. Когда 
компиляция закончится, можно приступать к следующему пункту указаний по 
установке. 
</p>

<p>
Если вам надоело следить за изменениями, нажмите <c>Ctrl-C</c>, затем <c>q</c>. 
Это остановит только процесс <c>less</c>, не затрагивая процесс компиляции.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Решение ошибок/проблем</title>
<section id="checking-disks">
<title>Тщательное тестирование дисков</title>
<body>

<p>
Если вы считаете, что необходимо тщательно проверить ваш диск на предмет
целостности (неисправные секторы и т.д.), можете включить параметр <c>-c</c>
при создании на нем файловой системы ext2 или ext3 (используя <c>mke2fs</c>).
Это запустит проверку на чтение, которая пометит все неисправные блоки.
Если вы настоящий параноик, можете включить <c>-c -c</c>, чтобы провести
детальный тест на чтение/запись.
</p>

<pre caption="Проверка целостности диска">
# <i>mke2fs -j -c /dev/hda3</i>
</pre>

</body>
</section>
<section id="recover">
<title>Восстановление сбойной установки</title>
<body>

<p>
Если по какой-то причине ваша установка Gentoo дает сбой, вам не придется
повторять ее раз за разом с самого начала. Вместо этого можно спокойно
вернуться к моменту, в который вы, как вам кажется, ошиблись (или где, как вы
считаете, есть ошибка в инструкции), и попробовать другой подход.
</p>

<p>
Прежде всего, вам потребуется перейти обратно в свою среду Gentoo Linux
командой chroot. Снова следуйте указаниям, пропуская шаги по разбивке диска,
так как ваши разделы уже созданы и даже заполнены. Таким образом, вы можете
сразу монтировать эти разделы в <path>/mnt/gentoo</path>. Следует также
пропустить шаги, связанные с извлечением файла стадии и изменением
<path>make.conf</path> &mdash; вы же не хотите перезаписывать существующие
файлы, не так ли?
</p>

<p>
Изменив корень на свою среду Gentoo Linux, сразу переходите к шагу, где, как
вам кажется, следует попробовать действовать по-другому. Не повторяйте все
шаги, такие как самогенерация, если не считаете, что именно там что-то пошло
не так.
</p>

<p>
Например, если вы считаете, что неверно настроили <path>grub.conf</path>, можно
сразу запустить свой редактор, чтобы изменить <path>/boot/grub/grub.conf</path>.
</p>

<p>
Попробовав другой подход в своей ситуации, вы, скорее всего, сможете
представить, сколько последующих шагов потребуется выполнить снова. Если
последующие действия зависели от вашего изменения, их потребуется повторить.
</p>

<p>
Например:
</p>

<ul>
  <li>
    изменив переменную в <path>make.conf</path>, вам потребуется выполнить
    всю последующую компиляцию, поскольку ее результаты зависят от настройки
    <path>make.conf</path>
  </li>
  <li>
    изменив <path>/boot/grub/grub.conf</path>, можно сразу выходить из среды
    измененного корня и перезагружаться, так как никакие последущие шаги не
    зависят от <path>grub.conf</path>
  </li>
  <li>
    перекомпилировав свое ядро, вам нужно лишь убедиться, что конфигурация
    вашего начального загрузчика указывает на верный образ ядра (убедитесь, что
    вы смонтировали свой <path>/boot</path>!), затем можно выйти из среды
    измененного корня и перезагрузиться
  </li>
  <li>
    изменив <path>/etc/fstab</path>, можно выходить из среды измененного корня
    и перезагружаться
  </li>
</ul>

<p>
Как видите, после большинства действий по восстановлению можно сразу
перезагружаться. Лишь изредка вам потребуется повторять последующие шаги
установки.
</p>

</body>
</section>

</chapter>

</guide>

<!-- *$Localization:
target-language: Russian
target-version: 1.12-r1
target-date: 2006-11-07
translated-by: (several)
edited-by: Alexey Chumakov
notes:
-->

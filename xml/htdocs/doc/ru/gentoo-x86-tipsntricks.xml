<?xml version='1.0' encoding="UTF-8"?>
<!-- REV: 1.5 -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/ru/gentoo-x86-tipsntricks.xml">
<title>Установка Gentoo/x86 - советы и трюки</title>
<author title="Author">
    <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Translator">
   <mail link="deadlyFROZEN@yandex.ru">Ilya Krets</mail>
</author>
<author title="Editor">
   <mail link="svyatogor@gentoo.org">Sergey Kuleshov</mail>
</author>


<abstract>
Процесс установки Gentoo очень гибкий и дает возможность "пофантазировать". Так как невозможно
включить каждый полезный в инструкции по установке, этот документ предоставляет
справку по всем прдложенным советам.
</abstract>

<license/>

<version>1.2</version>
<date>April 11, 2004</date>

<chapter>
<title>Вступление</title>
<section>
<title>Для начала</title>
<body>

<p>
Этот документ содержит различные полезные по установке Gentoo/x86. Большинство из
них описаны кратко - подразумевается, что они послужат дополнением к руководству по 
установке, а не заменой ему.
</p>

</body>
</section>
<section>
<title>Содержание</title>
<body>

<p>
<b>"Продвинутая" установка</b>
</p>

<ul>
  <li><uri link="#software-raid">Програмный RAID</uri></li>
  <li><uri link="#ata-raid-2.4">ATA RAID, используя ядра 2.4</uri></li>
</ul>

<p>
<b>Упрощение установки</b>
</p>

<ul>
  <li><uri link="#leave_terminal">Как оставить терминал</uri></li>
</ul>

<p>
<b>Решение ошибок/проблем</b>
</p>

<ul>
  <li><uri link="#checking-disks">Детальное тестирование Ваших дисков</uri></li>
</ul>

</body>
</section>
</chapter>
<chapter>
<title>"Продвинутая" установка</title>
<section id="software-raid">
<title>Програмный RAID</title>
<body>

<note>
Если Вы не знакомы с програмным RAID'ом, пожалуйста прочтите <uri
link="http://tldp.org/HOWTO/Software-RAID-HOWTO.html">Software-RAID-HOWTO</uri>.
</note>

<p>
После загрузки с LiveCD, загрузите соответствующие модули RAID. Например, если Вы
используете RAID-1:
</p>

<pre caption="Загрузка модуля RAID-1">
# <i>modprobe raid1</i>
</pre>

<p>
Когда вы разбиваете ваши диски на разделы, используйте тип раздела <c>fd</c>
(Linux raid autodetect), а не <c>83</c> (Linux native). Вы можете изменить тип раздела,
используя команду <c>t</c> в программе <c>fdisk</c>.
</p>

<p>
После разбивки на разделы, создайте файл <path>/etc/raidtab</path> (да, в самом деле,
в окружении LiveCD) и вставьте необходимые команды для установки RAID. Например,
чтобы зеркалировать (RAID-1) разделы boot, swap и root, покрывая
<path>/dev/sda</path> и <path>/dev/sdb</path>, можете использовать:
</p>

<pre caption="/etc/raidtab для установки RAID-1">
raiddev /dev/md0
  raid-level 1
  nr-raid-disks 2
  chunk-size 32
  persistent-superblock 1
  device /dev/sda1
    raid-disk 0
  device /dev/sdb1
    raid-disk 1

raiddev /dev/md1
  raid-level 1
  nr-raid-disks 2
  chunk-size 32
  persistent-superblock 1
  device /dev/sda2
    raid-disk 0
  device /dev/sdb2
    raid-disk 1

raiddev /dev/md2
  raid-level 1
  nr-raid-disks 2
  chunk-size 32
  persistent-superblock 1
  device /dev/sda3
    raid-disk 0
  device /dev/sdb3
    raid-disk 1
</pre>

<p>
Теперь создайте необходимые RAID устройства для каждого, перечисленного в <path>/etc/raidtab</path>:
</p>

<pre caption="Создание устройств RAID">
# <i>mkraid /dev/md0</i>
# <i>mkraid /dev/md1</i>
# <i>mkraid /dev/md2</i>
</pre>

<p>
Драйвер Linux Software RAID начнет создавать метаустройства. Вы можете проследить за этим в
<path>/proc/mdstat</path>. Подождите, пока метаустройства не будут окончательно готовы
перед тем, как продолжать.
</p>

<p>
Теперь используйте <path>/dev/md0</path> для загрузочного раздела,
<path>/dev/md1</path> для раздела подкачки и <path>/dev/md2</path> для корневого раздела.
</p>

<p>
После монтирования <path>/dev/md2</path> в <path>/mnt/gentoo</path>, не забудьте
скопировать <path>/etc/raidtab</path> в <path>/mnt/gentoo/etc</path>.
</p>

<p>
При конфигурации ядра, включите соответствующую поддержку RAID <e>в</e>
ядро, а не модулем.
</p>

<p>
При установке дополнительных утилит, сделайте также emerge <c>raidtools</c>. Заметьте, 
что это доступно не на всех LiveCD, поэтому, возможно, Вы не сможете установить
Gentoo на програмный raid при безсетевой установке.
</p>

<p>
При конфигурации загрузчика не забудьте установить его на MBR <e>обоих</e>
дисков, если вы использовали зеркалирование.
</p>

</body>
</section>
<section id="ata-raid-2.4">
<title>ATA RAID, используя ядра 2.4</title>
<body>

<p>
Удостоверьтесь, что вы загрузились с LiveCD, используя опцию <c>doataraid</c>. После загрузки,
проверьте содержимое <path>/dev/ataraid</path>. Эта директория должна содержать различные <path>disc*</path>
директории для каждого жесткого диска, доступного в ATA RAID. Весь диск показан как  <path>disc</path>, а разделы - как
<path>part*</path>.
</p>

<p>
Запишите различные файлы устройств <path>/dev/ataraid/disc*/*</path>, которые
нужны вам для установки Gentoo.
Вам надо будет заменить примеры с <path>/dev/hda</path> из установки на этот путь.
</p>

<p>
Перед тем, как сделать chroot, свяжите структуру <path>/dev</path> с новым окружением:
</p>

<pre caption="Связывание /dev">
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
</pre>

<p>
При настройке ядра не забудьте включить поддержку вашего ATA RAID чипсета с
нужными опциями.
Например, популярная ATA RAID система - <e>Promise FastTrack built-in RAID</e> требует встроенные 
в ядро <c>Promise FastTrack Options</c>.
</p>

<p>
При настройке GRUB, сначала надо будет создать загрузочный диск GRUB. Это не так
сложно, как вам кажется.
Сначала установите GRUB как обычно, но когда дойдете до пункта, в котором GRUB устанавливается на MBR, следуйте
этим инструкциям:
</p>

<pre caption="Создание загрузочного диска GRUB">
# <i>cd /boot/grub</i>
# <i>dd if=stage1 of=/dev/fd0 bs=512 count=1</i>
# <i>dd if=stage2 of=/dev/fd0 bs=512 seek=1</i>
</pre>

<p>
После этого вам нужно записать файл <path>grub.conf</path>. Здесь нет никаких отличий
от установочных инструкций, просто убедитесь, что запись <c>root=</c> указывает
на ваше устройство ATA RAID.
</p>

<p>
После окончания установки, загрузитесь с вашего загрузочного диска GRUB. Вы
должны увидеть приглашение коммандной строки GRUB.
Теперь настройте GRUB для загрузки с устройства ATA RAID:
</p>

<pre caption="Установка GRUB на ATA RAID">
grub&gt; root (hd0,x)
grub&gt; setup (hd0)
grub&gt; quit
</pre>

<p>
Теперь перезагрузитесь (вытащив загрузочную дискету GRUB из дисковода).
</p>

<p>
Пользователи LILO могут просто использовать указания из руководства по установке.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Упрощение установки</title>
<section id="leave_terminal">
<title>Как оставить терминал</title>
<body>

<p>
Многие люди хотят оставить свою систему, пока она компилируется. В некоторых
случаях это довольно сложно, поскольку установка производится в месте, где много
народу и вы не можете доверять всем и каждому. 
В этом случае, возможно проводить компиляцию в фоновом режиме, выйдя изо всех терминалов.
</p>

<p>
Есть несколько возможных путей. Первый - использовать <c>screen</c>. После
загрузки с LiveCD, установите пароль для root и запустите сессию screen:
</p>

<note>
Заметьте, что screen есть не на всех LiveCD. Если у вас его нет, Вам придется
использовать один из других методов, описанных в этом разделе.
</note>

<pre caption="Запуск сессии screen">
# <i>screen -S gentoo</i>
</pre>

<p>
После входа в сессию screen Вы можете проводить полную установку. Когда вы захотите
оставить терминал, нажмите <c>Ctrl-a, d</c> (именно так, control и a
одновременно, затем d), чтобы <e>отделить</e> Вашу сессию screen. Теперь
вы можете выходить из системы.
</p>

<p>
Чтобы восстановить доступ к терминалу, опять войдите как root и <e>прикрепитесь</e> к запущенной сессии screen: 
</p>

<pre caption="Прикрепление к сессии screen">
# <i>screen -x gentoo</i>
</pre>

<p>
Если Вы не можете использовать screen, есть другой путь оставить ваш терминал. Следуйте
инструкциям по установке, но когда дойдете до пункта, в котором запускается
длительная
компиляция (например, шаг с запуском <c>./scripts/bootstrap.sh</c>), используйте команду <c>nohup</c>, 
которая позволит процессу продолжиться, даже если вы выйдете. Не забудьте
добавить в конце "&amp;", иначе
процесс не будет выполняться в фоновом режиме! Запомните, в какой директории Вы находитесь (команда <c>pwd</c>
покажет ее), так как это вам понадобится позже.
</p>

<pre caption="Использование nohup">
# <i>pwd</i>
/usr/portage
# <i>nohup ./scripts/bootstrap.sh &amp;</i>
</pre>

<p>
Теперь выйдете из окружения chroot (<c>exit</c>) и из сессии LiveCD. Компиляция продолжится в 
фоновом режиме.
</p>

<p>
Когда Вы захотите проверить компиляцию, войдите как root (на LiveCD) и сделайте chroot обратно
в Ваше окружение, затем перейдите в оставленную директорию:
</p>

<pre caption="Chroot обратно">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update &amp;&amp; source /etc/profile</i>
# <i>cd /usr/portage</i>
</pre>

<p>
Теперь используйте команду <c>less</c> для файла <path>nohup.out</path>, который расположен внутри
директории. Компиляция будет добавлять свои сообщения в этот файл, так что если вы хотите следить за ней,
запустите <c>less nohup.out</c> и нажмите <c>F</c>, чтобы следить за изменениями. Когда компиляция закончится, можете приступать к следующему пункту инструкций по установке.
</p>

<p>
Если вам надоело следить за изменениями, нажмите <c>Ctrl-C</c>, затем <c>q</c>. Это остановит только процесс <c>less</c>, 
и не тронет процесс компиляции.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Решение ошибок/проблем</title>
<section id="checking-disks">
<title>Детальное тестирование дисков</title>
<body>

<p>
Если Вы считаете, что необходимо тщательно тестировать ваш диск на предмет
целостности (неисправные секторы и т.д.), 
можете включить опцию <c>-c</c> при создании на нем файловой системы ext2 или ext3 (используя <c>mke2fs</c>).
Это проведет проверку на чтение и пометит все неисправные блоки. Если вы
страдаете параноей, можете включить <c>-c -c</c>, чтобы
провести детальный тест на чтение/запись.
</p>

<pre caption="Проверка целостности диска">
# <i>mke2fs -j -c /dev/hda3</i>
</pre>

</body>
</section>
</chapter>

</guide>

<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ru/gentoo-sparc-netboot-howto.xml,v 1.1 2005/11/13 15:08:11 achumakov Exp $ -->

<guide link="/doc/ru/gentoo-sparc-netboot-howto.xml" lang="ru" disclaimer="draft">
<title>Описание сетевой загрузки с системы Gentoo Linux</title>

<author title="разработчик SPARC">
  <mail link="weeve@gentoo.org">Jason Wever</mail>
</author>
<author title="переводчик">
  <mail link="ikorot@earthlink.net">Игорь Короть</mail>
</author>

<abstract>
Руководство по установке сервера сетевой загрузки, который будет использоваться 
совместно с установочными образами сетевой загрузки Gentoo/SPARC.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.2</version>
<date>2005-08-18</date>

<chapter>
<title>Введение</title>
<section>
<body>

<note>
В настоящее время этот документ ориентирован только на системы типа SPARC, и 
ожидается что установка сервера сетевой загрузки будет происходить на уже 
существующей машине Gentoo Linux.
</note>

<p>
Этот документ описывает как установить среду сетевой загрузки для компьютеров 
на базе Sun Microsystems SPARC или UltraSPARC.  Он предполагает что имеется 
работающий компьютер с установленной системой Gentoo Linux для использования в 
качестве сервера сетеаой загрузки. 
</p>

<p>
Оба компьютера - сервер сетевой загрузки и клиент сетевой загрузки должны быть 
расположены в одной подсети, т.к. протокол ARP в большинстве не пересылается 
между двумя различными подсетями.
</p>

<p>
Здесь мы приводим общий обзор того что происходит во время сетевой загрузки;
</p>

<ol>
  <li>
    Машина-клиент посылает перевернутый запрос ARP (RARP) чтобы получить IP-адрес.
  </li>
  <li>
    Машина-сервер возвращает ответ машине клиенту с IP-адресом.
  </li>
  <li>
    Машина-клиент пытается загрузить загрузочный образ с сервера RARP используя 
    протокол tftp. 
  </li>
  <li>
    Как только образ загружен, клиент сетевой загрузки загружает образ.
  </li>
</ol>

<p>
На основании этого обзора нам необходимо будет установить программное 
обеспечение для демонов Reverse ARP и tftp.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Установка и настройка программного обеспечения</title>
<section>
<title>Демон Reverse ARP</title>
<body>

<p>
В настоящее время существуют 2 демона reverse ARP. Это net-misc/iputils 
(установленного как часть системного профиля) и net-misc/rarpd.
</p>

<note>
Установка net-misc/rarpd перезапишет rarpd и rarpd manpage установленных вместе
с net-misc/iputils
</note>

<p>
<b>Настройка общих rarpd элементов</b>: <path>/etc/ethers</path>
</p>

<p>
Независимо от того какой rarpd вы выберете для использования, нужно будет 
настроить файл <path>/etc/ethers</path>. Этот файл указывает на то,
каким хостам rarpd должен отвечать на запрос и какому адресу отвечать.
</p>

<p>
Форматом файла <path>/etc/ethers</path> является MAC адрес сетевой карты 
сетевой загрузки сервера и имя хоста. Эти два параметра разделены пробелом, и 
каждая запись должна быть на отдельной строке. Следующий пример написан для 
хоста названного sparc-netboot.gentoo.org:
</p>

<pre caption="Пример файла /etc/ethers">
08:00:20:77:1f:3e	sparc-netboot.gentoo.org
</pre>

<note>
Если данный MAC адрес начинается с нуля или является 0, можно этот нуль не 
указывать (т.е. 08:00:20:77:1f:3e превратится в 8:0:20:77:1f:3e).
</note>

<p>
Если вы добавляете хосты в файл <path>/etc/ethers</path>, перезапускать сервис 
rarpd не нужно, т.к. файл проверяется каждый раз при получении запроса.
</p>

<p>
<b>Разрешение хостов</b>: <path>/etc/hosts</path>
</p>

<p>
Так как каждая запись в файле <path>/etc/ethers</path> имеет имя хоста, сервер 
сетевой загрузки должен иметь возможность разрешить имя хоста в его IP-адрес. 
Это может быть выполнено 2 путями: с помощью файла <path>/etc/hosts</path> или
с помощью имени сервера используемого сервером сетевой загрузки.
</p>

<p>
Записи в файле <path>/etc/hosts</path> для разрешения имени хоста выглядят 
аналогично тем что уже скорее всего существуют с момента установки Gentoo на 
сервер сетевой загрузки. Для хоста sparc-netboot.gentoo.org используемого в 
нашем примере, предположим что его IP-адрес: 10.0.1.15. Соответственно, записи 
в файле <path>/etc/hosts</path> будут выглядеть так:
</p>

<pre caption="Файл /etc/hosts">
10.0.1.15  sparc-netboot.gentoo.org
</pre>


<note>
В зависимости от среды, вам возможно потребуется проконсультироваться с сетевым 
администратором чтобы получить соответствующий IP-адрес или адреса для сетевой 
загрузки хоста.
</note>

<p>
Если вы воспользуетесь именем сервера, тогда администратор сервера должени 
будет добавить запись для имени хоста, в нашем случае sparc-netboot.gentoo.org, 
чтобы он указывал на соответствующий IP-адрес. Пожалуйста, проконсультируйтесь 
со своим администратором сервера DNS и/или документацией по программному 
обеспечению DNS сервера о том как добавить такую запись.
</p>

<note>
Если файл <path>/etc/hosts</path> и имя сервкра имеют запись для сетевой 
загрузки хоста, файл <path>/etc/hosts</path> будет использоваться первым (при 
условии что порядок файла <path>/etc/nsswitch.conf</path> не был изменен с того 
который принят по умолчанию).
</note>

<p>
<b>Настройка net-misc/iputils rarpd</b>
</p>

<p>В первую очередь, необходимо определить параметры, которые будет 
использовать rarpd. Мы рассмотрим только те параметры, которые дадут 
возможность запустить демона rarpd. Так как в настоящее время не существует 
сценария init.d для версии net-misc/iputils демона rarpd, должна быть добавлена 
строка в файл <path>/etc/conf.d/local.start</path> если вы хотите запускать 
сервис rarpd во время загрузки. ПРиведем пример такой строки:
</p>

<pre caption="Файл /etc/conf.d/local.start">
/usr/sbin/rarpd -v -e eth0
</pre>

<p>
Приведем описание параметров указанных в команде выше (так как это описывается 
на странице правки):
</p>

<ul>
  <li>-v быть многословным</li>
  <li>
    -e не проверять на присутствие загрузочного образа, отвечать если reply if 
    MAC адрес разрешается в действительный IP-адрес используя 
    базу данных <path>/etc/ethers</path> и DNS
  </li>
  <li>
    eth0 представляет интерфейс к которому должен привязываться rarpd
  </li>
</ul>

<p>
Чтобы узнать больше про остальные параметры, смотрите раздел 8 страницы cправки 
для rarpd
</p>

<p>
<b>Настройка net-misc/rarpd</b>
</p>

<p>
В первую очередь нужно установить rarpd с помощью следующей команды:
</p>

<pre caption="Установка rarpd">
# <i>emerge net-misc/rarpd</i>
</pre>

<p>
Затем, параметры для rarpd должны быть установлены в файле 
<path>/etc/conf.d/rarpd</path>. Для конфигурации соответствующей описанной выше 
для net-misc/iputils rarpd, установите параметры в файле 
<path>/etc/conf.d/rarpd</path> чтобы они выглядели примерно так:
</p>

<pre caption="Файл /etc/conf.d/rarpd">
RARPD_OPTS="-v -i eth0"
</pre>

<p>
Приведем описание параметров указанных в команде выше (так как это описывается 
на странице правки):
</p>

<ul>
  <li>
    -v быть многословным. Показывать запрсы на которые демон отвечает.
  </li>
  <li>
    -i ПРивязать к указанному интерфейсу. По умолчанию rarpd привязывается к 
    интерфейсу по умолчанию для локальной системы, если он доступен. 
  </li>
</ul>

<p>
Чтобы узнать больше про остальные параметры, смотрите секцию 8 страницы справки 
для rarpd, а также воспользуйтесь командой rarpd --help.
</p>

</body>
</section>
<section>
<title>Демон tftpd</title>
<body>

<p>
Существует три возможности для демона tftp, net-misc/atftp, 
net-misc/netkit-tftp и net-misc/tftp-hpa. Вам нужео установить только один.
</p>

<p>
<b>Настройка общих элементов tftpd</b>
</p>

<p>
каждый демон tftp потребует каталог из которого он будет обслуживать файлы для 
клиентов tftp. В этом документе мы будем использовать каталог с именем 
/tftpboot. Этот каталог будет являться корневым (<path>/</path>) для клиентов 
при получении запросов. В дополнени мы настроим систему чтобы она запускала 
демон tftp без пользователя и группы пользователей.
</p>

<p>
Если выбранный каталог не существует, он должен быть создан с помощью команды 
mkdir. Команда для нашего примера <path>/tftpboot</path> следующая:
</p>

<pre caption="Создание каталога /tftpboot">
# <i>/bin/mkdir /tftpboot</i>
</pre>

<p>
Затем нам необходимо изменить владельца каталога /tftpboot так чтобы его 
владельцем стал пользователь nobody и группа nobody:
</p>

<pre caption="Смена владельца">
# <i>chown nobody:nobody /tftpboot</i>
</pre>

</body>
</section>
<section>
<title>Демон atftp</title>
<body>

<p>
Сначала установите пакет net-misc/atftp как показано ниже;
</p>

<pre caption="Установка atftp">
# <i>emerge net-misc/atftp</i>
</pre>

<p>
После установки пакета net-misc/atftp, он должен быть настроен. Если вы хотите 
получить сервисы tftpd во время загрузки, должна быть добавлена строка в файл 
<path>/etc/conf.d/local.start</path>, т.к. демон atftp не имеет своих файлов 
сценариев init.d, inetd или xinetd. Если вы хотите использовать inetd или 
xinetd для контроля за сервисом tftpd, обратитесь к соответствующей странице 
справки.
</p>

<p>
Ниже приведен пример строки для демона atftpd в файле 
<path>/etc/conf.d/local.start</path>:
</p>

<pre caption="Файл /etc/conf.d/local.start">
/usr/sbin/in.tftpd -v --daemon /tftpboot
</pre>

<p>
Описание вышеуказанных параметров rarpd (взято со страницы справки):
</p>

<ul>
  <li>
    -v Увеличить или установить уровень записи в файл регистрации. Отсутствие 
    аргументов увеличит текуще значение на 1. Значением по умолчанию является 
    LOG_NOTICE, смотрите страницу правки syslog(3) для объяснения уровня записи 
    в файл регистрации. Возможные значения варьируются от 0 (LOG_EMERG) до 7 
    (LOG_DEBUG)
  </li>
  <li>
    --daemon Запускается как демон. Не пользуйтесь этим параметром, если atftpd 
    запускается с помощью inetd. 
  </li>
</ul>

<p>
Чтобы узнать больше про остальные параметры, смотрите секцию 8 страницы правки 
для rarpd
</p>

</body>
</section>
<section>
<title>Демон netkit-tftp</title>
<body>

<p>
Сначала установите пакет net-misc/netkit-tftp как показано ниже;
</p>

<pre caption="Установка netkit-tftp">
# <i>emerge net-misc/netkit-tftp</i>
</pre>

<p>
Затем установите sys-apps/xinetd если он еще не установлен; после этого нужно 
будет настроить пакет netkit-tftp. Пакет netkit-tftp должен запускаться с 
помощью xinetd, однако примера сценария загрузки не предоставляется. Ниже 
приведен пример конфигурационного файла xinetd:
</p>

<pre caption="Пример файла /etc/xinetd.d/tftp">
service tftp
{
    protocol        = udp
    port            = 69
    socket_type     = dgram
    wait            = yes
    user            = nobody
    group           = nobody
    server          = /usr/sbin/in.tftpd
    server_args     = /tftpboot
    only_from       = 10.0.1.0
    disable         = no
}
</pre>

<note>
Этот пример конфигурационного файла xinetd для tftp использует строку "disable 
= no",  которая включает сервис по умолчанию. Данный пример вступает в 
противоречие с правилами конфигурационных файлов xinetd системы Gentoo 
принятыми по умолчанию, в соответствии с которыми параметр disable 
устанавливается в "yes". 
</note>

<p>
Описание параметров приведенных в примере выше;  параметры могут быть изменены;
user        пользователь in.tftpd запросы которого обрабатываются
group       группа пользователей in.tftpd запросы которой обрабатываются
server_args корневой каталог для демона tftp откуда будут поставляться файлы
only_from   сообщает xinetd каким хостам разрешено соединение с помощью tftp
</p>

<p>
Дополнительная информация по конфигурационным файлам xinetd может быть найдена 
в секции 5 страницы правки для xinetd.conf
</p>

<p>
Если запущен сервис xinetd, можно послать ему сигнал HUP, чтобьы он перечитал 
свой конфигурационный файл:
</p>

<pre caption="Посылка сигнала HUP в xinetd">
# <i>/bin/killall -HUP xinetd</i>
</pre>

<p>
Если сервис xinetd не запущен, запустите его с помощью команды init.d;
</p>

<pre caption="Запуск xinetd">
# <i>/etc/init.d/xinetd start</i>
</pre>

<p>
Для более полной информации изучите секцию 8 страницы правки для in.tftpd
</p>

</body>
</section>
<section>
<title>Демон tftp-hpa</title>
<body>
<p>
Сначала установите пакет tftp-hpa используя следующую команду;
</p>

<pre caption="Установка tftp-hpa">
# <i>emerge net-misc/tftp-hpa</i>
</pre>

<p>
Пакет tftp-hpa содержит файлы конфигурации init.d и conf.d. Проверьте что 
переменные INIITFTPD_PATH и INITFTP_OPTS в файле 
<path>/etc/conf.d/in.tftpd</path> имеют значения показанные ниже:
</p>

<pre caption="Файл /etc/conf.d/in.tftpd">
INTFTPD_PATH="/tftpboot"
INTFTPD_OPTS="-s -v -l ${INTFTPD_PATH}"
</pre>

<p>
Демон tftp может быть запущен с помощью сценария init.d;
</p>

<pre caption="Запуск in.tftpd">
# <i>/etc/init.d/in.tftpd start</i>
</pre>

<p>
Чтобы получить информацию об остальных параметрах, смотрите секцию 8 страницы 
правки о tftpd.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Подготовка образа tftpboot для использования клиентом</title>
<section>
<body>

<p>
Убедитесь что у вас есть образ который будет использоваться для сетевой 
загрузки. Для образа сетевой загрузки системы sparc или sparc64, проверьте ваше 
локальное зеркало исходных файлов Gentoo в каталоге 
<path>experimental/sparc/tftpboot</path>
на соответствующий образ. Мы предположим, что планируется загружать хост на 
базе sparc64 используя образ 
<path>gentoo-sparc64-1.4_rc4-20040102.tftpboot</path>.
</p>

<p>
После того как вы получите выбранный образ, скопируйте его в каталог 
<path>/tftpboot</path>:
</p>

<pre caption="Копирование образа">
# <i>cp gentoo-sparc64-1.4_rc4-20040102.tftpboot /tftpboot</i>
</pre>

<p>
Теперь когда клиент сетевой загрузки производит запрос tftp, он ищет файл 
который имеет имя в виде шестнадцатеричного номера его IP-адреса, и на 
некоторых платформах имеет расширение <path>.ARCH</path>. Шестнадцатеричный 
номер должен использовать <e>заглавные</e> буквы.
</p>

<p>
Руководство о том, как преобразовать десятичное в шестнадцатеричное можно найти 
по адресу <uri>http://www.permadi.com/tutorial/numDecToHex/</uri>
</p>

<p>
Для особо ленивых или нетерпеливых существует конвертер по адресу 
<uri>http://dan.drydog.com/hextemp.html</uri>
</p>

<note>
Каждое число в IP-адресе (например 10 в 10.0.1.15), нужно будет преобразовать в 
шестнадцатеричное, а не преобразовывать адрес как единое число
</note>

<p>Так для IP-адреса в нашем примере, 10.0.1.15, давайте посмотрим на его 
шестнадцатеричный эквивалент:
</p>

<pre caption="Пример IP-адреса">
десятичное число          10  0   1   15
шестандцатеричное число   0A  00  01  0F
</pre>

<p>
Поэтому для выбранного нами клиента сетевой загрузки sparc64, он будет искать 
файл с именем 0A00010F когда он загружается с помощью tftp.
</p>

<p>
В то же время на системах sparc, имя файла будет 0A00010F.SUN4M, 0A00010F.SUN4C 
или 0A00010F.SUN4D в зависимости от типа sparc системы.
</p>

<p>
Дополнительно, если вы очень, очень леивы (как я), вы можете произвести сетевую 
загрузку хоста, чтобы получить имя файла для поиска клиентом из файла 
регистрации сетевой загрузки.
</p>

<p>
Убедитесь что оба демона rarpd и tftpd, которые были выбраны, запущены, затем 
загрузите хост как описано ниже в "Сетевой загрузке клиента".
</p>

<p>
После того как будет дана команда boot net, клиент не будет реагировать. Затем 
на сервере сетеой загрузки, проверьте системный журнал и найдите строчку для 
in.tftpd.
</p>

<p>
Пример такой строки с сервера сетевой загрузки с запущенными sysklogd и 
tftp-hpa выглядит примерно так:
</p>

<pre caption="Строчка в журнале для сервера сетевой загрузки">
Jan  3 22:48:59 stargazer in.tftpd[8368]: RRQ from 10.0.1.15 filename 0A00010F
</pre>

<p>
Имя файла показано выше после "filename" в строке файла журнала, который в 
данном случае должен называться 0A00010F.
</p>

<p>
Для того, чтобы отслеживать какой образ сетевой загрузки используется, и чтобы 
позволить нескольким компьютерам использовать один и тот же образ сетевой 
загрузки, можно использовать ссылку  на созданный нами файл с шестнадцатеричным 
именем. Чтобы создать такую ссылку используя параметры нашего примера: хост 
sparc64 host и образ <path>gentoo-sparc64-1.4_rc4-20040102.tftpboot</path>,
воспользуйтесь следующей командой:
</p>

<pre caption="Сборка файлов образа">
# <i>/bin/ln -s /tftpboot/gentoo-sparc64-1.4_rc4-20040102.tftpboot \ 
/tftpboot/0A00010F</i>
</pre>

<p>
Сейчас у нас все готово для сетевой загрузки!
</p>

</body>
</section>
</chapter>

<chapter>
<title>Сетевая загрузка клиента</title>

<section>
<body>

<p>
Из OpenBoot PROM (OBP) на машине SPARC, введите команду;
</p>

<pre caption="Загрузка OBP">
ok <i>boot net</i>
</pre>

<p>
для отдельных машин существуют другие подходы:
</p>

<pre caption="Альтернативная загрузка OBP">
ok <i>boot net-tpe</i>
</pre>

<note>
Если ваша система не позволяет войти в OBP во время загрузки, нужно будет 
нажать клавиши Stop и A, или послать сигнал прерывания через серийную консоль 
до того момента как система начнет загружать систему. Если ваша система не 
может найти систему, она должна пытаться загружаться через сетевой интерфейс 
(т.е то что мы хотим) или вернуться к подсказке OBP.
</note>

<p>
Этак команда начнет процесс сетевой загрузки. Должна появиться постоянно 
изменяемая строка шестнадцатиричных цифр. Когда считывание образа закончится, 
управление перейдет к ядру и начнется процесс загрузки системы. Вслучае 
установочного образа вашего sparc64 компьютера, вы увидите подсказку оболочки и 
сможете начать процесс установки.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Тестирование</title>
<section>
<body>

<p>
<b>Построение предпосылочного программного обеспечения</b>
</p>

<p>
Если сервер сетевой загрузки -- система Gentoo/LINUX и возникнут проблемы с 
установкой пакетов rarpd и tftpd, пожалуйста обратитесь по ссылке 
<uri>http://forums.gentoo.org</uri> и <uri>http://bugs.gentoo.org</uri> чтобы 
проверить или даная проблемы уже встречалась у кого-то ещё. Если этого не 
происходило или решение не работает, пожалуйста создайте новый отчет об ошибке 
по адресу <uri>http://bugs.gentoo.org</uri>.
</p>

<p>
<b>Я дал команду boot net, но похоже что система зависла.</b>
</p>

<p>
Предположительно это происходит потому, что файл система пытается считать из 
сервера tftpboot не доступен.  В системе SPARC, вы скоре всего увидите 
следующее сообщение:
</p>

<pre caption="Загрузка системы зависла">
Rebooting with command: boot
Boot device: net  File and args:
</pre>

<p>
Проверьте и убедитесь что файл который необходим клиенту существует в каталоге 
<path>/tftpboot</path>. Вы можете проверить имя запрашиваемого файла посмотрев 
в системный журнал. Как только файл появится на своем месте, клиент будет 
пытаться его считать. Иногда, если файл отсутствовал изначально, сервер 
заморозит процесс загрузки при появлении файла. Чтобы разрешить эту проблему, 
перейдите обратно к подсказке OBP, и повторите команду "boot net". Хост должен 
начать считывать образ tftpboot и загружать систему.
</p>

<p>
<b>Я пытаюсь провести сетеувю загрузку, но получаю только сообщения "Timeout 
waiting for ARP/RARP packet".</b>
</p>

<p>
Это может происходить по нескольким причинам;
</p>

<ol>
  <li>
    Убедитесь что существует строка в файле <path>/etc/ethers</path> для 
    данного клиента. Если неверен MAC адрес и/или сервер сетевой загрузки не 
    может разрешить имя хоста для клиента, он не сможет ответить с требуемой 
    информацией.
  </li>
  <li>
    Проверьте, возможность потока сообщений RARP свободно проходить через 
    сетевой хаб или переключатель к которому подключены сервер и клиент сетевой 
    загрузки. Если запросы клиента не могут достигнуть сервера, или наоборот, хост 
    не сможет продолжать.
  </li>
  <li>
    Никто не отвечает на запросы RARPD, потому что не запущены прослушивающие 
    сервисы. Проверьте что запущен сервис rarpd.
  </li>
  <li>
    Клиент не думает что его сетевая карта имеет ссылку на сетевой 
    хаб/переключатель к которому она подключена. Проверьте что на сетевой карте
    и порту на сетевом хабе или переключателе горит лампочка link. Если 
    лампочка link включена, проверьте чему равно значение переменной     
    tpe-link-test? в OBP с помощью команды; <c>printenv tpe-link-test?</c>. Вы 
    должна получить нечто типа <path>tpe-link-test?   false     true</path>. 
    Первая колонка представляет имя параметра, вторая показывает текуще значение 
    параметра, и третья колонка показывает значение по умолчанию для данного 
    параметра. В примере выше можно увидеть что текущим значением переменной 
    является "false", что означает что клиент не проверяет или клиент и сетевой 
    хаб или переключатель могут создать link до того как послать RARP запрос. 
    Очень часто это создает проблему.
  </li>
</ol>

<p>
Чтобы изменить значение переменной tpe-link-test? из посказки OBP, ведите 
следующую команду:
</p>

<pre caption="Изменение значения переменной tpe-link-test">
ok <i>setenv tpe-link-test? true</i>
tpe-link-test? =      true
</pre>

<p>
Это указывает на то, что значение переменной tpe-link-test? является "true". 
Попытайтесь произвести сетевую загрузку клиента сейчас.
</p>

</body>
</section>
</chapter>

</guide>

<!-- *$Localization:
target-language: Russian
target-version: 1.2-r1
target-date: 2005-11-13
source-cvs-revision: 1.8
translated-by: Igor Korot <ikorot@earthlink.net>
edited-by:

notes:
now just validated against xmlguide //achumakov
-->

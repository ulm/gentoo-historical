<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/pt_br/handbook/hb-net-advanced.xml,v 1.1 2005/06/10 23:39:28 vanquirius Exp $ -->

<sections>

<version>1.1</version>
<date>2005-06-09</date>

<section>
<title>Configuração avançada</title>
<body>

<p>
A variável config_eth0 é o coração da configuração de uma interface.
É uma lista de instruções de alto nível para configurar a interface (eth0
neste caso). Cada comando na lista de instruções é feito seqüencialmente.
A interface é considerada OK se pelo menos um comando funcionar.
</p>

<p>
Aqui está uma lista de instruções internas.
</p>

<table>
  <tr>
    <th>Comando</th>
    <th>Descrição</th>
  </tr>
  <tr>
    <ti>null</ti>
    <ti>Não fazer nada</ti>
  </tr>
  <tr>
    <ti>noop</ti>
    <ti>
      Se a interface estiver levantada e houver um endereço, abortar a
      configuração com sucesso
    </ti>
  </tr>
  <tr>
    <ti>um endereço IPv4 ou IPv6</ti>
    <ti>Adicionar o endereço à interface</ti>
  </tr>
  <tr>
    <ti>
      dhcp, adsl ou apipa<br/>
      (ou comando personalizado de um módulo de terceiros)
    </ti>
    <ti>
      Rodar o módulo que fornece o comando. Por exemplo, "dhcp" irá
      rodar um módulo que fornece dhcp, que pode ser tanto dhcpcd,
      udhcpc, dhclient ou pump.
    </ti>
  </tr>
</table>

<p>
Se um comando falhar, você pode especificar uma alternativa. A alternativa tem
que bater com a estrutura de configuração exatamente.
</p>

<p>
Você pode encadear estes comandos juntamente. Aqui estão alguns exemplos do
mundo real.
</p>

<pre caption="exemplos de configuração">
<comment># Adicionando três endereços IPv4</comment>
config_eth0=(
	"192.168.0.2/24"
	"192.168.0.3/24"
	"192.168.0.4/24"
)

<comment># Adicionando um endereço IPv4 e dois endereços IPv6</comment>
config_eth0=(
	"192.168.0.2/24"
	"4321:0:1:2:3:4:567:89ab"
	"4321:0:1:2:3:4:567:89ac"
)

<comment># Manter nosso endereço designado pelo kernel, a menos que a interface
# caia, neste caso obter outro via DHCP. Se DHCP falhar, então adicionar um
# endereço estático determinado por APIPA</comment>
config_eth0=(
	"noop"
	"dhcp"
)
fallback_eth0=(
	"null"
	"apipa"
)
</pre>

<note>
Quando usando o módulo ifconfig e adicionando mais que um endereço, aliases de
interface são criados para cada endereço adicional. Então com os dois exemplos
acima você obterá as interfaces eth0, eth0:1 e eth0:2.
Você não pode fazer nada especial com essas interfaces já que o kernel e outros
programas irão simplesmente tratar eth0:1 e eth0:2 como eth0
</note>

<impo>
A ordem da alternativa é importante! Se você não especificar a opção "null",
então o comando "apipa" só seria rodado se o comando "noop" falhar.
</impo>

<note>
<uri link="?part=4&amp;chap=3#apipa">APIPA</uri> e
<uri link="?part=4&amp;chap=3#dhcp">DHCP</uri> são discutidos mais tarde
</note>

</body>
</section>

<section>
<title>Dependências de rede</title>
<body>

<p>Scripts de init em <path>/etc/init.d</path> podem depender de uma interface
de rede específica ou só net. "net" pode ser definido em
<path>/etc/conf.d/rc</path> para significar diferentes coisas usando a variável
<c>RC_NET_STRICT_CHECKING</c>.
</p>

<table>
  <tr>
    <th>Valor</th>
    <th>Descrição</th>
  </tr>
  <tr>
    <ti>nenhum</ti>
    <ti>O serviço net é considerado como sempre funcionando</ti>
  </tr>
  <tr>
    <ti>no</ti>
    <ti>
      Basicamente significa que pelo menos um serviço net.* fora net.lo
      deve estar funcionando. Isto pode ser usado por usuários de notebooks que
      têm wifi e um nic estático, e só precisam de um funcionando para que o
      serviço net seja visto como funcionando.
    </ti>
  </tr>
  <tr>
    <ti>lo</ti>
    <ti>
      É igual a opção 'no', mas net.lo também é contado.
      Deve ser útil para pessoas que não se importam se alguma interface
      específica está funcionando durante o carregamento.
    </ti>
  </tr>
  <tr>
    <ti>yes</ti>
    <ti>
      TODAS interfaces de rede DEVEM estar funcionando para o serviço 'net'
      ser considerado como funcionando.
    </ti>
  </tr>
</table>

<p>
Mas e o net.br0 dependendo de net.eth0 e net.eth1?
net.eth1 pode ser um dispositivo wireless ou ppp que precisa de configuração
antes de ser adicionado à ponte.
Isto não pode ser feito em <path>/etc/init.d/net.br0</path> já que é um link
simbólico para net.lo
</p>

<p>
É resposta é criar sua própria função depend() em <path>/etc/conf.d/net</path>
</p>

<pre caption="dependência net.br0 em /etc/conf.d/net">
<comment># Você pode usar qualquer dependência (use, after, before) como encontradas em scripts atuais</comment>
depend_br0() {
	need net.eth0 net.eth1
}
</pre>

<p>
Para uma discussão mais detalhada sobre dependência, consulte a seção
<uri link="/doc/pt_br/handbook/handbook-x86.xml?part=2&amp;chap=4#doc_chap4">
 "Escrevendo scripts de init"</uri> no Manual do Gentoo.
</p>

</body>
</section>

<section id="variable_name">
<title>Nomes de variáveis e valores</title>
<body>

<p>
Nomes de variáveis são dinâmicos. Normalmente seguem a estrutura
<c>variable_${interface|mac|essid|apmac}</c>. Por exemplo, a variável
<c>dhcpcd_eth0</c> tem os valores das opções de dhcpcd para eth0 e
<c>dhcpcd_essid</c> tem o valor das opções de dhcpcd quando qualquer interface
conecta-se ao essid "essid".
</p>

<p>
No entanto, não existe nenhuma regra rígida e pronta que diz que nomes de
interface devem ser ethx. Na verdade, muitas interfaces wireless têm nomes como
wlanx, rax bem como ethx. Também, algumas intercaces definidas por usuários como
pontes podem receber qualquer nome, como foo. Para tornar a vida mais
interessante, pontos de acesso (AP) de wireless podem ter nomes com caracteres
não alfa-numéricos neles - isto é importante porque você pode configurar
parâmetros de rede por ESSID.
</p>

<p>
O ponto negativo disto é que o Gentoo usa variáveis de bash para rede -
e o bash não pode usar nada fora caracteres ingleses alfa-numéricos. Para
contornar esta limitação nós trocamos cada caractere que não é inglês
alfa-numérico em um caractere _.
</p>

<p>
Outro ponto negativo do bash é o conteúdo das variáveis - alguns caracteres
precisam de escape. Isto pode ser feito colocando o caractere \ na frente do
caractere que precisa de escape. Abaixo está uma lista de caracteres que podem
receber escape deste jeito.
</p>

<p>
<c>" ' \</c>
</p>

<p>
Neste exemplo nós usados ESSID de wireless já que contêm o maior escopo de
caracteres. Nós usaremos a ESSID como aparece abaixo.
</p>

<p>
<c>My "\ NET</c>
</p>

<pre caption="exemplo de nome de variável">
<comment># Isto funciona, mas o domínio é inválido</comment>
dns_domain_My____NET="My \"\\ NET"

<comment># A parte acima configura o domínio de dns para My "\ NET quando um cartão de wireless
# conecta-se a um AP cujo ESSID é My "\ NET</comment>
</pre>

</body>
</section>

</sections>

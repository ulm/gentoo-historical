<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fi/handbook/hb-install-stage.xml,v 1.2 2004/11/24 11:07:14 flammie Exp $ -->

<sections>

<version>1.67</version>
<date>2004-11-09</date>

<section>
<title>Stage-tarpaketin asennus</title>
<subsection>
<title>Päiväyksen asettaminen</title>
<body>

<p>
Ennen kuin jatketaan koneen päiväys pitää tarkistaa. Väärää näyttävä kello
voi johtaa outoihin ongelmiin!
</p>

<p>
Ajan tarkastamiseen käytetään komentoa <c>date</c>:
</p>

<pre caption="Päiväyksen tarkastaminen">
# <i>date</i>
ma marraskuun 11. 03:43:18 EEST 2004
</pre>

<p>
Jos aika on väärä, sen voi päivittää syntaksia <c>date MMDDhhmmYYYY</c>
vastaavalla komennolla (missä
<b>M</b> on kuukaudet,
<b>D</b> on päivät,
<b>h</b> on tunnit,
<b>m</b> on minuutit ja
<b>Y</b> on vuosi).
Jos vaikkapa asetettaisiin päiväykseksi 24. marraskuuta 2004, kello 16:21:
</p>

<pre caption="Päiväyksen asettaminen">
# <i>date 112416212004</i>
</pre>

</body>
</subsection>
<subsection>
<title>Valitseminen</title>
<body>

<p>
Seuraavassa vaiheessa asennetaan järjestelmä valitsemastasi
<e>stage</e>-tarpaketista. Voit joko ladata paketin verkosta tai, jos käynnistit
Gentoon Universal LiveCD:ltä kopioida sen sieltä. Universal LiveCD:n kanssa on
järkevää käyttää cd:llä olevaa pakettia koska se on täysin sama kuin verkosta
haettavakin.
</p>

<ul>
<li><uri link="#doc_chap2">Oletus: Internetistä haetun Stagen
asentaminen</uri></li>
<li><uri link="#doc_chap3">Vaihtoehto: Universal LiveCD:n Stagen
käyttö</uri></li>
</ul>

</body>
</subsection>
</section>
<section>
<title>Oletus: Internetistä haetun Stagen asentaminen</title>
<subsection>
<title>Stagen lataaminen verkosta</title>
<body>

<p>
Siirry Gentoon liitospisteeseen tiedostojärjestelmässäsi
(todennäköisesti hakemisto <path>/mnt/gentoo</path>):
</p>

<pre caption="Gentoon osion tiedostojärjestelmään siirtyminen">
# <i>cd /mnt/gentoo</i>
</pre>

<p>
Asennusvälineestä riippuen voit käyttää muutamaa eri työkalua stagen
lataamiseen. Jos <c>links2</c> on mukana, voit surfata sillä  <uri
link="/main/en/mirrors.xml">Gentoon peilipalvelinlistaukseen</uri>.
Valitse sieltä itseäsi lähin peilipalvelin (ainoa Suomessa kirjoitushetkellä
listatuista on trumpetti.atm.tut.fi, muitakin löytynee joiltain
korkeakouluilta). Hakemisto josta paketti löytyy
alkaa <path>releases/</path>-osalla, jonka jälkeen tulee Gentoon versio
(<path>2004.3</path>) ja käytetty alusta (kuten <path>x86/</path>)
ja lopulta <path>stages/</path>-hakemisto. Näkyvissä pitäisi olla kaikki
alustan stage-tiedostot. Painamalla <c>D</c> ladataan tiedostoa ja selain
sulkeutuu näppäimestä <c>Q</c>.
</p>

<pre caption="Peilipalvelinlistauksen avaaminen links2:lla">
<comment>(Ilman välipalvelinta)</comment>
# <i>links2 http://www.gentoo.org/main/en/mirrors.xml</i>
<comment>(Välipalvelimella)</comment>
# <i>links2 -http-proxy proxy.example.com:8080 http://www.gentoo.org/main/en/mirrors.xml</i>
</pre>

<p>
Ladatun paketin yhtäpitävyyden voi tarkastaa komennolla <c>md5sum</c>, joka
vertaa MD5-tarkistussummia peilipalvelimelta löytyviin. Esimerkiksi
x86-tarpaketin voi testata seuraavalla tavalla:
</p>

<pre caption="esimerkki stage-tarpaketin eheyden tarkastuksesta">
# <i>md5sum -c stage1-x86-2004.3.tar.bz2</i>
stage1-x86-2004.3.tar.bz2: OK
</pre>

</body>
</subsection>
<subsection>
<title>Stage-tarpaketin purkaminen</title>
<body>

<p>
Seuraavaksi ladattu paketti puretaan järjestelmään. Tässä käytetään GNUn
<c>tar</c>-komentoa, koska se lienee yksinkertaisin:
</p>

<pre caption="Stage-paketin purkaminen">
# <i>tar -xvjpf stage?-*.tar.bz2</i>
</pre>

<p>
Muista käyttää täsmälleen samoja valitsimia (<c>-xvjpf</c>). <c>x</c>
<e>purkaa</e> tiedostoja arkistosta, <c>v</c> <e>listaa monisanaisesti</e>
käsitellyt tiedostot (no, ehkei tämä ole täysin välttämätön),
<c>j</c> <e>suodattaa paketin bzip2:lla</e>, <c>p</c> <e>säilyttää
käyttöoikeudet</e> ja <c>f</c> lukee syötteen tiedostosta vakiosyötevirran
asemesta.
</p>

<p>
Nyt stage on asennettu ja voit jatkaa <uri
link="#installing_portage">asentamalla portagen</uri>.
</p>

</body>
</subsection>
</section>
<section>
<title>Vaihtoehto: LiveCD:n Stagen käyttö</title>
<subsection>
<title>Stage-paketin purkaminen</title>
<body>

<p>
Staget sijaitsevat CD:llä hakemistossa <path>/mnt/cdrom/stages</path>.
Komento <c>ls</c> listaa olemassaolevat paketit:
</p>

<pre caption="Stagejen listaaminen">
# <i>ls /mnt/cdrom/stages</i>
</pre>

<p>
Jos tämä aiheuttaa virheilmoituksen niin CD kannattaa liittää ensin:
</p>

<pre caption="CD:n liittäminen">
# <i>ls /mnt/cdrom/stages</i>
ls: /mnt/cdrom/stages: Tiedostoa tai hakemistoa ei ole
# <i>mount /dev/cdroms/cdrom0 /mnt/cdrom</i>
# <i>ls /mnt/cdrom/stages</i>
</pre>

<p>
Siirry nyt Gentoon liitoshakemistoon (todennäköisesti <path>/mnt/gentoo</path>):
</p>

<pre caption="Siirtyminen hakemistoon /mnt/gentoo">
# <i>cd /mnt/gentoo</i>
</pre>

<p>
Seuraavaksi puretaan valittu stage-tarpaketti. Työhön käytetään GNUn
<c>tar</c>-työkalua. Muista käyttää samoja asetuksia (<c>-xvjpf</c>)!
Esimerkissä puretaan stage-tarpaketti <path>stage3-&lt;arkkitehtuuri&gt;-2004.3.tar.bz2</path>.
Muista korvata nimi omalla paketillasi.
</p>

<pre caption="stage-tarpaketin purku">
# <i>tar -xvjpf /mnt/cdrom/stages/stage3-&lt;arkkitehtuuri&gt;-2004.3.tar.bz2</i>
</pre>

<p>
Nyt kun stage on asennettu voidaan jatkaa <uri
link="#installing_portage">asentamalla Portage</uri>.
</p>

</body>
</subsection>
</section>
<section id="installing_portage">
<title>Portagen asennus</title>
<subsection>
<title>Verkkoyhteys vai ilman?</title>
<body>

<p>
Jos verkkoyhteys ei ole käytettävissä, pitää portage asentaa LiveCD:llä olevasta
otoksesta. Tällöin oletettavasti käytät stage3-pakettia, koska muita ei
verkotta pysty asentamaankaan. Myös käytettäessä esikäännettyjä paketteja
asennuksen nopeuttamiseen
<e>täytyy</e> portage ottaa LiveCD:ltä. Kaikki muut voivat ajallaan
ladata täydellisen Portage-puun verkosta käyttäen komentoa <c>emerge</c>.
</p>

<p>
Jatka sopivaan kohtaan ohjetta:
</p>

<ul>
  <li>
    <uri link="#installing_from_LiveCD">portagen ja lähdekoodien asennus
    LiveCD:ltä</uri> (Verkottomissa ja GRP-asennuksissa)
  </li>
  <li>
    <uri link="#compile_options">kääntöasetusten säätäminen</uri> (muissa
    tapauksissa)
  </li>
</ul>

</body>
</subsection>
<subsection id="installing_from_LiveCD">
<title>Portagen ja lähdekoodien asennus LiveCD:ltä</title>
<body>

<p>
Universal LiveCD:illä on käytettävissä Portagen otos. Koska olet lukemassa
tätä osaa ohjeesta sinulla varmaankin on Universal LiveCD. Otokset
löytyvät hakemistosta <path>/mnt/cdrom/snapshots/</path>:
</p>

<pre caption="/mnt/cdrom/snapshots-hakemistolistauksen katselu">
# <i>ls /mnt/cdrom/snapshots</i>
</pre>

<p>
Otoksen purkamiseen käytetään <c>tar</c>-komentoa. Varmista taas että
asetukset ovat oiketa. Huomaa myös, että <c>-C</c> on iso <c>C</c> eikä
pieni <c>c</c>. Esimerkissä käytetään
<path>portage-20041022.tar.bz2</path>:a otoksen tiedostonimenä, muista korvata
tämä omalla tiedostollasi.
</p>

<pre caption="Portagen kuvan purkaminen">
# <i>tar -xvjf /mnt/cdrom/snapshots/portage-20041022.tar.bz2 -C /mnt/gentoo/usr</i>
</pre>

<p>
Lisäksi täytyy kopioida kaikki lähdekoodi CD:ltä:
</p>

<pre caption="Lähdekoodin kopiointi">
# <i>mkdir /mnt/gentoo/usr/portage/distfiles</i>
# <i>cp /mnt/cdrom/distfiles/* /mnt/gentoo/usr/portage/distfiles/</i>
</pre>

<p>
Nyt kun Portagen otos on asennettu, voidaan jatkaa kohti <uri
link="#compile_options">käännösasetusten tekemistä</uri>.
</p>

</body>
</subsection>
</section>

<section id="compile_options">
<title>Käännösasetusten tekeminen</title>
<subsection>
<title>Johdanto</title>
<body>

<p>
Gentoo-järjestelmän voi optimoida muutamalla Portagen käytökseen vaikuttavalla
muuttujalla. Portage huomioi ympäristömuuttujat (joita asetetaan komennolla
<c>export</c>), mutta ne ovat väliaikaisia. Pysyvät asetukset tehdään
Portagen asetustiedostoon <path>/etc/make.conf</path>, jota muokataan
seuraavaksi.
</p>

<note>
Kommentoitu listaus kaikista mahdollisista muuttujista löytyy tiedostosta
<path>/mnt/gentoo/etc/make.conf.example</path>. Gentoon asentamiseksi et
tarvitse kuin alta löytyviä muuttujia.
</note>

<p>
Käytä suosikkimuokkaintasi (oppaassa <c>nano</c>) optimointiasetusten
muuttamiseksi.
</p>

<pre caption="/etc/make.conf-tiedoston avaus">
# <i>nano -w /mnt/gentoo/etc/make.conf</i>
</pre>

<p>
Huomannet, että <path>make.conf.example</path> on järjestetty hyvin
yleisellä tavalla: kommentit alkavat merkillä # ja muut rivit
määrittävät muuttujia syntaksilla <c>MUUTTUJA="sisältö"</c>. Alla muutamia
käytetyistä muuttujista
</p>

<warn>
Jos asennat stage3:lta ja GRP-asennuksella, älä muokkaa USE-muuttujaa.
USE-asetuksia voidaan vaihtaa asennuksen jälkeen, mutta jos sitä muokataan
varhemmassa vaiheessa vuorimaahiset murskaavat järjestelmäsi!
</warn>

</body>
</subsection>
<subsection>
<title>CHOST</title>
<body>

<warn>
Vaikka se vaikuttaisi näppärältä idealta stage2- ja stage3-käyttäjät
<e>eivät saa</e> muokata <c>CHOST</c>-asetustaan. Sen muuttaminen voi
tehdä järjestelmän käyttökelvottomaksi. Siis: muokkaa tätä muuttujaa vain
ja ainoastaan jos asennat <e>stage1</e>-asennusta.
</warn>

<p>
<c>CHOST</c> määrittelee alustan, jolle <c>gcc</c> kääntää ohjelmat.
Vaihtoehtoja ovat:
</p>

<table>
<tr>
  <th>Arkkitehtuuri</th>
  <th>Aliarkkitehtuuri</th>
  <th>CHOST-asetus</th>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i386</ti>
  <ti>i386-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i486</ti>
  <ti>i486-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i586</ti>
  <ti>i586-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>x86</ti>
  <ti>i686 tai uudempi (ml. athlonit)</ti>
  <ti>i686-pc-linux-gnu</ti>
</tr>
<tr>
  <ti>alpha</ti>
  <ti></ti>
  <ti>alpha-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>ppc</ti>
  <ti></ti>
  <ti>powerpc-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>ppc64</ti>
  <ti></ti>
  <ti>powerpc64-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>sparc</ti>
  <ti></ti>
  <ti>sparc-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>hppa</ti>
  <ti>(yleinen)</ti>
  <ti>hppa-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>hppa</ti>
  <ti>pa7000</ti>
  <ti>hppa1.1-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>hppa</ti>
  <ti>pa8000 tai uudempi</ti>
  <ti>hppa2.0-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>mips</ti>
  <ti></ti>
  <ti>mips-unknown-linux-gnu</ti>
</tr>
<tr>
  <ti>amd64</ti>
  <ti></ti>
  <ti>x86_64-pc-linux-gnu</ti>
</tr>
</table>

<!-- <p>
CHOSTin muuttamisen jälkeen ympäristömuuttujat tulee ladata uudelleen:
</p>

<pre caption="Ympäristöasetusten lataus">
# <i>env-update</i>
# <i>source /etc/profile</i>
</pre> -->

</body>
</subsection>
<subsection>
<title>CFLAGS ja CXXFLAGS</title>
<body>

<p>
<c>CFLAGS</c>- ja <c>CXXFLAGS</c>-muuttujat asettavat <c>gcc</c>:n C- ja
C++-käännösten optimointiasetuksia vastaavasti. Vaikka ne määritellään tässä
yleisesti niin jokainen ohjelma saavuttaa parhaan suorituskyvyn eri asetuksilla.
</p>

<p>
Tiedostoon <path>make.conf</path> kannattaa määritellä sellaiset
optimointiasetukset jotka <e>yleensä</e> takaavat parhaan lopputuloksen.
Älä käytä kokeellisia asetuksia täällä; liian tehokkaat optimoinnit saavat
ohjelmat epävakaiksi (kaatuilemaan tai käyttäytymään viallisesti).
</p>

<p>
Tässä ei selvitetä kaikkia optimointiasetuksia, tarkempia tietoja kaikista
löytyy <uri link="http://www.gnu.org/software/gcc/onlinedocs/">GNU
Online Manual(s)</uri>-sivuilta tai <c>gcc</c>:n infosivuilta (<c>info
gcc</c> -komennolla täysimittaisessa toimivassa Linux-järjestelmässä)
<path>make.conf.example</path> sisältää paljon esimerkkejä ja
tietoa, lue se huolellisesti myös.
</p>

<p>
Ensimmäinen vastaantuleva asetus on <c>-march=</c>. Se määrittelee
käytettävät arkkitehtuurioptimoinnit. Mahdolliset arvot on kuvattu
<path>make.conf.example</path>-tiedoston kommenteissa. Esimerkiksi Athlon
XP-suorittimelle:
</p>

<pre caption="GCC:n march-asetukset">
<comment># Niiden AMD64:n omistajien, jotka haluavat natiivin 64-bittisen
ympäristön, ei tule asettaa athlon-xp:tä arkkitehtuuriksi</comment>
-march=athlon-xp
</pre>

<p>
Toinen asetus on <c>-O</c>-valitsin (suuraakkonen O, ei nolla). Se
kertoo <c>gcc</c>:lle optimointiluokan. Mahdolliset arvot ovat <c>s</c> (koon
optimointiin), <c>0</c> (nolla optimointien poistamiseksi), <c>1</c>, <c>2</c>
tai <c>3</c> lisäoptimointien asettamiseksi (jokainen luokista siis sisältää
edeltävän optimoinnit ja jotain lisää). Esimerkiksi luokan 2 optimoinnit
asetetaan näin:
</p>

<pre caption="GCC: O-asetus">
-O2
</pre>

<p>
Usein käytetään myös valitsinta <c>-pipe</c> (joka määrittelee putket
käytettäviksi väliaikaistiedostojen asemesta käännettäessä).</p>

<p>
Kannattaa huomata, että toinen suosittu, <c>-fomit-frame-pointer</c> (joka
poistaa kehysosoittimen rekisteristä
niissä funktioissa, joissa sitä ei tarvita) saattaa hankaloittaa ohjelmien
vianetsintää.
</p>

<p>
<c>CFLAGS</c>- ja <c>CXXFLAGS</c>-valitsimissa kannattaa yhdistellä
monia optimointikeinoja, kuten seuraavassa:
</p>

<pre caption="CFLAGS- ja CXXFLAGS-määrittelyt ">
CFLAGS="-march=athlon-xp -pipe -O2"
CXXFLAGS="${CFLAGS}"     <comment># Käytetään samaa asetusta molemmissa muuttujissa</comment>
</pre>

</body>
</subsection>
<subsection>
<title>MAKEOPTS</title>
<body>

<p>
<c>MAKEOPTS</c> määrittelee rinnakkaisten käännösprosessien määrän paketin
asennuksessa. Suositeltu määrä on prosessorien lukumäärä lisättynä yhdellä.
</p>

<pre caption="MAKEOPTS yhden prosessorin järjestelmässä">
MAKEOPTS="-j2"
</pre>

</body>
</subsection>
<subsection>
<title>Paikoillanne, valmiit, hep!</title>
<body>

<p>
Päivitä ja tallenna tiedosto <path>/mnt/gentoo/etc/make.conf</path>. Nyt voit
jatkaa <uri link="?part=1&amp;chap=6">asentamalla Gentoo-järjestelmän
perustan</uri>.
</p>

</body>
</subsection>
</section>
</sections>

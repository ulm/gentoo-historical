<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fi/handbook/Attic/hb-install-x86-kernel.xml,v 1.17 2005/07/04 16:46:25 flammie Exp $ -->

<sections>

<version>3.3</version>
<date>2005-07-04</date>

<section>
<title>Aikavyöhyke</title>
<body>

<p>
Ensimmäisenä pitää varmistaa, että järjestelmä tietää millä aikavyöhykkeellä
se sijaitsee. Aikavyöhykelistausta voi katsella hakemistosta <path>/usr/share/zoneinfo</path>. Sopiva aikavyöhyke asetetaan symboliseksi
linkiksi <path>/etc/localtime</path> komennolla <c>ln</c>:
</p>

<pre caption="Aikavyöhykkeen asettaminen">
# <i>ls /usr/share/zoneinfo</i>
<comment>(Esimerkiksi käytetään Suomen vyöhykettä)</comment>
# <i>ln -sf /usr/share/zoneinfo/Europe/Helsinki /etc/localtime</i>
</pre>

</body>
</section>
<section>
<title>Lähdekoodin asennus</title>
<subsection>
<title>Ytimen valinta</title>
<body>

<p>
Kaikki distrot rakennetaan Linuxin ytimen ympärille. Ydin on laitteiston
ja ohjelmiston välinen rajapinta. Gentoossa on mukana useita ydinvaihtoehtoja,
täysimittainen listaus näistä on <uri link="/doc/en/gentoo-kernel.xml">Gentoo
Kernel Guidessa</uri>.
</p>

<p>
X86-järjestelmien ytimiä ovat <c>vanilla-sources</c> (ytimen kehittäjien
julkaisema oletusydin),
<c>gentoo-sources</c> (suorituskykyominaisuuksin pätsätty ydin), …
</p>

<p>
Valittu ytimen lähdekoodi asennetaan komennolla <c>emerge</c>.
</p>

<pre caption="Ytimen lähdekoodin asennus">
# <i>emerge gentoo-sources</i>
</pre>

<p>
Hakemistossa <path>/usr/src</path> pitäisi olla ytimen lähdekoodiin osoittava
symbolinen linkki <path>linux</path>:
</p>

<pre caption="Ytimen linkin tarkastelu">
# <i>ls -l /usr/src/linux</i>
lrwxrwxrwx  1 root root 12. loka 13 11:04 /usr/src/linux -&gt;
linux-2.6.11-gentoo-r3
</pre>

<p>
Jos näin ei ole (vaan linkki osoittaa vaikkapa väärään ytimeen), asia kannattaa
korjata ennen jatkamista (linux-2.6.11:han on tässä vain esimerkki, version
tulee tietenkin vastata asennettua):
</p>

<pre caption="Ytimen lähdekoodin symbolisen linkin korjaaminen">
# <i>rm /usr/src/linux</i>
# <i>cd /usr/src</i>
# <i>ln -s linux-2.6.11-gentoo-r3 linux</i>
</pre>

<p>
Nyt voidaan säätää ja asentaa ydin. Komennolla <c>genkernel</c> saadaan
aikaan sellainen yleisluontoinen ydin jota asennus-CD:lläkin käytetään.
Selitämme ensin kuitenkin ytimen asennuksen käsipelillä.
</p>

<p>
Jos haluat asentaa ytimen käsin, jatka kohtaan <uri
link="#manual">Oletus: Asetusten teko käsin</uri>.
Jos taas käytät <c>genkernel</c>iä, lue <uri link="#genkernel">
Vaihtoehto: genkernelin käyttö</uri>.
</p>

</body>
</subsection>
</section>
<section id="manual">
<title>Oletus: Asetusten teko käsin</title>
<subsection>
<title>Johdanto</title>
<body>

<p>
Ytimen asennusta pidetään usein vaikeimpana asiana mihin Linuxin käyttäjä
joutuu. Asia ei kuitenkaan aivan näin ole. Huomannet itsekin muutaman ytimen
kääntämisen jälkeen, ettei se edes ollut vaikeaakaan ;)
</p>

<p>
<e>Yksi</e> asia täytyy kuitenkin muistaa: asennettaessa
ydintä käsin täytyy tietää
järjestelmän kokoonpano tarkkaan. Suuren osan tiedoista saa selville
tarkastelemalla tiedostoa <path>/proc/pci</path> (tähän tarkoitetun komennon
<c>lspci</c>:n löytää asentamalla paketin <e>pci-utils</e> komennolla
<c>emerge pci-utils</c>). Lspci:n saattaa voida suorittaa myös suoraan
chrootin ulkopuolelta asennus-cd:ltä. Myös <c>lsmod</c>in voi ajaa nähdäkseen
mitä moduuleita asennus-CD on päättänyt käyttää (se tarjonnee hyvän vihjeen
siitä mitä kannattaa valita).
</p>

<p>
Seuraavaksi siirrytään ytimen lähdekoodin hakemistoon suorittamaan komentoa
<c>make menuconfig</c>. Näin saadaan käyttöön ncurses-pohjainen asetusvalikko.
</p>

<pre caption="Menuconfigin käynnistys">
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<p>
Vastaantulevassa valikossa on useita asetuskategorioita. Ensin tarkistamme
asetukset jotka täytyy kääntää päälle (tai muuten Gentoo ei toimi ollenkaan,
ainakaan ilman lisäsäätämistä).
</p>

</body>
</subsection>
<subsection>
<title>Tarvittavien asetusten kääntäminen päälle</title>
<body>

<p>
Ensiksi tulee aktivoida kokeellisen kehityskoodin ja -ajurien näyttö, ilman tätä
asetusta monet tärkeät ajurit ja ominaisuudet eivät näy ollenkaan:
</p>

<pre caption="Kokeellisen koodin ja ajureiden valinta">
Code maturity level options ---&gt;
  [*] Prompt for development and/or incomplete code/drivers
</pre>

<p>
Varmista, että kaikki järjestelmän käynnistämiseen vaadittavat
ajurit (kuten saattaa olla SCSI-ajuria, IDE-ajuria, …) tulevat mukaan kerneliin
eivätkä moduuleiksi, muuten käynnistäminen ei onnistu.mpletely.
</p>

<p>
Valitse nyt käytettäväksi oikeanmallinen prosessori:
</p>

<pre caption="Prosessorityypin valinta">
Processor type and features ---&gt;
  <comment>(Valitse prosessoriasi vastaava)</comment>
  (<i>Athlon/Duron/K7</i>) Processor family
General setup  ---&gt;
  [*] Support for hot-pluggable devices
</pre>


<p>
Valikosta <c>File Systems</c> valitaan tuki käytettäville
tiedostojärjestelmille. <e>Älä</e> tee niistä moduuleja tai Gentoo ei pysty
liittämään osioitasi.
Valitse myös <c>Virtual memory</c>, <c>/proc
file system</c>.
Älä valitse <c>/dev file system</c>iä, nykyään Gentoossa käytetään oletuksena
<c>udev</c>iä. Jos käytössä on 2.4-kerneli, pitää silti valita
<c>/dev file system</c> koska 2.4:stä puuttuu <c>udev</c>-tuki.:
</p>

<pre caption="Tarpeellisten tiedostojärjestelmien valinta">
<comment>(Ytimen versioille 2.4.x)</comment>
File systems ---&gt;
  [*] Virtual memory file system support (former shm fs)
  [*] /proc file system support
  [*] /dev file system support (EXPERIMENTAL)
  [*]   automatically mount /dev at boot
  [ ] /dev/pts file system for Unix98 PTYs

<comment>(Ytimen versioille 2.6.x)</comment>
File systems ---&gt;
  Pseudo Filesystems ---&gt;
    [*] /proc file system support
    [ ] /dev file system support (OBSOLETE)
    [*] Virtual memory file system support (former shm fs)

<comment>(Seuraavista valitaan ne mitä järjestelmässä tarvitaan)</comment>
  &lt;*&gt; Reiserfs support
  &lt;*&gt; Ext3 journalling file system support
  &lt;*&gt; JFS filesystem support
  &lt;*&gt; Second extended fs support
  &lt;*&gt; XFS filesystem support
</pre>

<p>
Jos BIOSisi ei tue suuria kovalevyjä ja olet asettanut kovalevyn jumpperin
rajoittamaan sen kokoa, seuraavat asetukset täytyy panna päälle, jotta koko
kovalevyä voisi käyttää.
</p>

<pre caption="Autogeometry resizing supportin asettaminen">
<comment>(2.4.x kernel only)</comment>
ATA/IDE/MFM/RLL support ---&gt;
  IDE, ATA and ATAPI Block devices ---&gt;
    &lt;*&gt;   Include IDE/ATA-2 DISK support
    [ ]     Use multi-mode by default
    [*]     Auto-Geometry Resizing support
</pre>

<p>
Muista lisätä DMA-asetukset asemillesi:
</p>

<pre caption="Activating DMA">
Device Drivers ---&gt;
  ATA/ATAPI/MFM/RLL support ---&gt;
    [*] Generic PCI bus-master DMA support
    [*]   Use PCI DMA by default when available
</pre>

<p>
Järjestelmissä, jotka yhdistävät nettiin PPPoE:llä tai modeemilla, tarvitaan
seuraavia asetuksia:
</p>

<pre caption="PPPoE:lle tarvittavien ajurien valinta">
<comment>(Ytimen versioille 2.4.x)</comment>
Network device support ---&gt;
  &lt;*&gt; PPP (point-to-point protocol) support
  &lt;*&gt;   PPP support for async serial ports
  &lt;*&gt;   PPP support for sync tty ports

<comment>(Ytimen versioille 2.6.x)</comment>
Device Drivers ---&gt;
  Networking support ---&gt;
    &lt;*&gt; PPP (point-to-point protocol) support
    &lt;*&gt;   PPP support for async serial ports
    &lt;*&gt;   PPP support for sync tty ports
</pre>

<p>
Pakkausasetuksista ei ole haittaa, vaikkei niitä kyllä tarvitakkaan. Myöskään
<c>PPP over Ethernet</c> ei ole erityisen tarpeellinen, sitä käyttää vain
<c>rp-pppoe</c> asettaessaan ytimen PPPoE-tukea.
</p>

<p>
Jos sinulla on verkkokortti, muista ottaa sen ajurit mukaan ytimeen.
</p>

<p>
Jos käytössä on uusi HyperThreadingiä tukeva Intelin prosessori tai useamman
prosessorin järjestelmä Symmetric multi-processing support on tärkeä asetus:
</p>

<pre caption="SMP:n aktivointi">
Processor type and features  ---&gt;
  [*] Symmetric multi-processing support
</pre>

<p>
Jos käytät USB-syötelaitteita (kuten USB-näppistä tai -hiirtä), muista
lisätä nekin mukaan:
</p>

<pre caption="USB-tuen aktivointi">
USB Support ---&gt;
<!-- … -->
</pre>

<p>
Läppärin käyttäjien <e>ei</e> kannata valita PCMCIA-ajureita 2.4-ytimiin:
tuoreemmat versiot näistä on paketissa <c>pcmcia-cs</c>, joka asennetaan
myöhempänä. 2.6-ytimiin PCMCIA-ajurit kuitenkin kannattaa ottaa mukaan.
</p>

<p>
PCMCIA-tuen lisäksi 2.6-kerneliin pitää kääntää tuki PCMCIA-väylälle:
</p>

<pre caption="PCMCIA-tuki 2.6-kerneleihin">
Bus options (PCI, PCMCIA, EISA, MCA, ISA)  ---&gt;
  PCCARD (PCMCIA/CardBus) support  ---&gt;
    &lt;*&gt; PCCard (PCMCIA/CardBus) support
<comment>(16-bittinen tukee vanhempia kortteja, useimmat tarvinnevat tämän asetuksen)</comment>
    &lt;*&gt;   16-bit PCMCIA support
    [*]   32-bit CardBus support
<comment>(valitse sopivat näistä)</comment>
    --- PC-card bridges
    &lt;*&gt; CardBus yenta-compatible bridge support (NEW)
    &lt;*&gt; Cirrus PD6729 compatible bridge support (NEW)
    &lt;*&gt; i82092 compatible bridge support (NEW)
    &lt;*&gt; i82365 compatible bridge support (NEW)
    &lt;*&gt; Databook TCIC host bridge support (NEW)
</pre>

<p>
Tehtyäsi ytimen asetukset jatka <uri
link="#compiling">kääntämällä ja asentamalla</uri>.
</p>

</body>
</subsection>
<subsection id="compiling">
<title>Käännös ja asennus</title>
<body>

<p>
Nyt kun ytimen asetukset on kasassa voidaan kääntää ja asentaa se. Poistu
asetusohjelmasta ja asenna:
</p>

<pre caption="Ytimen kääntäminen">
<comment>(2.4-sarjan ytimille)</comment>
# <i>make dep &amp;&amp; make bzImage modules modules_install</i>

<comment>(2.6-sarjan ytimille)</comment>
# <i>make &amp;&amp; make modules_install</i>
</pre>

<p>
Ytimen käännyttyä kopioi se hakemistoon <path>/boot</path>.
Seuraavissa esimerkeissä käytetään asetettua ja käännettyä ydintä
<c>gentoo-sources-2.6.11-r3</c>:
</p>

<pre caption="Ytimen asennus">
# <i>cp arch/i386/boot/bzImage /boot/kernel-2.6.11-gentoo-r3</i>
# <i>cp System.map /boot/System.map-2.6.11-gentoo-r3</i>
</pre>

<p>
Varmuuden varaksi kannattaa myös ottaa talteen ytimen asetukset hakemistoon
<path>/boot</path>:
</p>

<pre caption="Ytimen asetusten varmuuskopiointi">
# <i>cp .config /boot/config-2.6.11-gentoo-r3</i>
</pre>

<p>
Nyt voidaan jatkaa
<uri link="#kernel_modules">Asentamalla erilliset ytimen moduulit</uri>.
</p>

</body>
</subsection>
</section>
<section id="genkernel">
<title>Vaihtoehto: genkernelin käyttö</title>
<body>

<p>
Olet siis valinnut käyttäväsi <c>genkernel</c>-skriptiä ytimen asentamiseen.
</p>

<p>
Nyt kun ytimen lähdekoodi on asennettu, voidaan ydin kääntää automaattisesti
<c>genkernel</c>-skriptillä.
<c>genkernel</c> tekee ytimestä lähes identtisen asennus-CD:n ytimen kanssa.
Tästä seuraa että <c>genkernel</c>illä tehdyt ytimet tunnistavat laitteiston
käynnistyksessä kuten asennus-CD:kin. Koska genkerneliä käytettäessä ei tarvitse
tehdä asetuksia käsin, se sopii niille käyttäjille jotka eivät usko pitävänsä
ytimen oma-aloitteisesta kääntämisestä.
</p>

<p>
Ensin asennetaan genkernel ebuildista:
</p>

<pre caption="Genkernelin asennus">
# <i>emerge genkernel</i>
</pre>

<p>
Seuraavaksi kopioidaan kernelin asetukset asennus-CD:ltä genkernelin odottamaan
paikkaan, jos asennetaan 2.6-version kerneliä:
</p>

<pre caption="Asennus-CD:n asetusten kopiointi">
+<comment>(Vain jos käytetään kernelin 2.6-versioita)</comment>
# <i>zcat /proc/config.gz &gt; /usr/share/genkernel/x86/kernel-config-2.6</i>
</pre>

<p>
Ja käännetään komennolla <c>genkernel --udev all</c> (2.6-sarjalaisille)
tai <c>genkernel all</c> (2.4-sarjalaisille).
</p>

<p>
Jollei käynnistysosiosi käytä ext2- tai ext3-tiedostojärjestelmää, käytä
komentoa  <c>genkernel --menuconfig all</c> sopivan tiedostojärjestelmän
tuen lisäämiseksi kerneliin <e>mukaan</e> (<e>ei</e> siis moduuliksi).
EVMS tai LVM2 tarvitsevat valitsimet <c>--evms2</c> tai <c>--lvm2</c> mukaan
myös.
</p>

<pre caption="genkernelin käyttäminen">
<comment>(2.6-versiot)</comment>
# <i>genkernel --udev all</i>

<comment>(2.4-versiot)</comment>
# <i>genkernel all</i>

</pre>

<p>
<c>genkernel</c>in lopetettua on käytössä ydin täydehköllä moduulivalikoimalla
ja <e>initial root disk</e> (initrd). Tätä ydintä ja initrd:tä
käytetään käynnistyslataimen asettamiseksi myöhemmin. Muista ottaa ylös
ytimen ja initrd:n nimet, niitä tarvitaan käynnistyslataimen asetuksissa.
Initrd suorittaa käynnistyksen jälkeen laitteiston tunnistuksen (kuten
asennus-CD:lläkin. Sen jälkeen varsinainen järjestelmä käynnistyy.
</p>

<pre caption="Ytimen ja initrd:n nimen tarkastus">
# <i>ls /boot/kernel* /boot/initrd*</i>
</pre>

<p>
Vielä pitää tehdä yksi asia ennen kuin järjestelmä on lähes LiveCD:tä
vastaavassa tilassa. Asennetaan <c>coldplug</c>. Siinä missä initrd tunnistaa
järjestelmän käynnistämiseen tarvittavat laitteistot, <c>coldplug</c> hoitaa
loput. <c>coldplug</c> asennetaan ja asetetaan toimintakuntoon emergellä ja
rc-updatella:
</p>

<pre caption="coldplugin asennus">
# <i>emerge coldplug</i>
# <i>rc-update add coldplug default</i>
</pre>

</body>
</section>
<section id="kernel_modules">
<title>Ydinmoduulit</title>
<subsection>
<title>Moduulien asettaminen</title>
<body>

<p>
Kaikki automaattisesti käynnistyvät moduulit listataan tiedostoon
<path>/etc/modules.autoload.d/kernel-2.4</path> (tai <path>kernel-2.6</path>).
Lisäasetuksia voidaan käyttää.
</p>

<p>
Käytettävissä olevien moduulien listaus saadaan aikaiseksi
<c>find</c>-komennolla. Muista korvata ”&lt;ydinversio&gt;” ytimesi versiolla:
</p>

<pre caption="Ydinmoduulien listaaminen">
# <i>find /lib/modules/&lt;ydinversio&gt;/ -type f -iname '*.o' -or -iname '*.ko'</i>
</pre>

<p>
Ladataksesi moduulin <c>3c59x.o</c> käynnistyksessä lisää moduulin nimi
tiedostoon <path>kernel-2.4</path> tai <path>kernel-2.6</path>.
</p>

<pre caption="Tiedoston /etc/modules.autoload.d/kernel-2.4 muokkaus">
<comment>(2.4-ytimelle)</comment>
# <i>nano -w /etc/modules.autoload.d/kernel-2.4</i>
</pre>

<pre caption="/etc/modules.autoload.d/kernel-2.4 tai kernel-2.6">
3c59x
</pre>

<p>
Jatka asennusta <uri link="?part=1&amp;chap=8">tekemällä
järjestelmän asetukset</uri>.
</p>

</body>
</subsection>
</section>
</sections>

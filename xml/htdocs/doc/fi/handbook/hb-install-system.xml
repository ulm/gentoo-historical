<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fi/handbook/hb-install-system.xml,v 1.20 2006/01/31 02:10:04 flammie Exp $ -->

<sections>

<version>2.15</version>
<date>2006-01-19</date>

<section>
<title>Chroot-ympäristön asettaminen</title>
<subsection>
<title>Valinnainen: Peilipalvelimen valinta</title>
<body>

<p>
Lähdekoodien lataaminen onnistuu parhaiten jos käytetään nopeaa
peilipalvelinta.  Portage hakee peilipalvelinvaihtoehdot
<path>make.conf</path>in GENTOO_MIRRORS-asetuksesta. Luettelo kaikista
peilipalvelimista löytyy vaikkapa Gentoo-sivuston <uri
link="/main/en/mirrors.xml">peilipalvelinluettelosta</uri> (engl.).
Sieltä kannattaa valita lähimmät ja nopeimmat palvelimet käyttöä varten
(Suomessa esimerkiksi on kirjoittamisen hetkellä yksi: trumpetti.atm.tut.fi).
Palvelinnopeuksien kartoittamiseen tarjotaan myös mirrorselect-työkalua:
</p>

<pre caption="Mirrorselectin käyttö palvelinten valinnassa">
# <i>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<warn>
Älä kuitenkaan käytä IPv6-peilejä tässä vaiheessa. Stageista puuttuu nimittäin
IPv6-tuki.
</warn>

<p>
Toinen tärkeä palvelinasetus <path>make.conf</path>issa on SYNC. Sillä
valitaa rsync-palvelin Portagepuun (Gentoon ohjelmistohakemiston, joka sisältää
kaiken datan ohjelmien asennusta varten) päivittämistä varten. SYNCin voi toki
valita käsin listasta, mutta siihen voi käyttää myös
<c>mirrorselect</c>-komentoa:
</p>

<pre caption="Rsync-peilin valinta mirrorselectillä">
# <i>mirrorselect -i -r -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<p>
<c>Mirrorselectin</c> suortittamisen jälkeen on tärkeää tarkistaa, että
asetukset <path>/mnt/gentoo/etc/make.conf</path>issa näyttävät järkeviltä!
</p>


</body>
</subsection>
<subsection>
<title>DNS-osoitteiden kopiointi</title>
<body>

<p>
Ennen uuteen ympäristöön menemistä pitää vielä kopioida DNS-palvelinten
tiedosto tiedostosta <path>/etc/resolv.conf</path>.
Tietoja tarvitaan, että verkkoympäristö toimii vielä uudessakin ympäristössä.
<path>/etc/resolv.conf</path> sisältää tiedot käytettävistä nimipalvelimista.
</p>

<pre caption="DNS-tietojen kopiointi">
<comment>(valitsin -L varmistaa, ettei kopio ole symbolinen linkki)</comment>
# <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/resolv.conf</i>
</pre>

</body>
</subsection>
<subsection>
<title>Proc- ja dev-tiedostojärjestelmien liittäminen</title>
<body>

<p>
Jotta asennus voisi saada tietoa nykyisestä ytimestä chrootin sisältäkin,
täytyy <path>/proc</path> liittää hakemistoon <path>/mnt/gentoo/proc</path>.
Lisäksi pitää bindmountata dev-tiedostojärjestelmä.
</p>

<pre caption="/proc:n ja /dev:n liittäminen">
# <i>mount -t proc none /mnt/gentoo/proc</i>
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
</pre>

</body>
</subsection>
<subsection>
<title>Uuteen ympäristöön siirtyminen</title>
<body>

<p>
Nyt kun kaikki osiot on alustettu ja perusjärjestelmä on asennettu, voidaan
siirtyä <e>chrootaamaan</e> ympäristöä. Tämä tarkoittaa nykyisestä
asennusympäristöstä (asennus-CD:ltä tai vastaavasta) siirtymistä uuteen
asennusympäristöön (alustetuille osioille).
</p>

<p>
Chrootaus tehdään kolmessa osassa. Ensin vaihdetaan juurihakemisto
<c>chroot</c>-komennolla <path>/</path>-hakemistosta (asennusvälineen)
<path>/mnt/gentoo</path>-hakemistoksi (uusilla osioilla).
Uusi ympäristö luodaan komennolla <c>env-update</c>, joka luo
ympäristömuuttujat. Lopuksi muuttujat asetetaan komennolla <c>source</c>.
</p>

<pre caption = "Uuden ympäristön chrootaus">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update</i>
Regenerating /etc/ld.so.cache...
* Caching service dependencies...
# <i>source /etc/profile</i>
# <i>export PS1="(chroot) $PS1"</i>
</pre>

<p>
Olet nyt Gentoo Linux -järjestelmässäsi. Asennusta on toki vielä paljolti
jäljellä, kuten jäljellä olevien kappaleiden määräkin vihjaa :-)
</p>

</body>
</subsection>
</section>
<section>
<title>Portage-puun asetukset</title>
<subsection>
<title>Portage-puun päivitys</title>
<body>

<p>
Uuden Portage-puun voi ladata komennolla <c>emerge --sync</c>.
</p>

<pre caption="Portagen päivitys">
# <i>emerge --sync</i>
<comment>(Hitailla terminaaleilla, kuten joillakin framebuffereilla tai
sarjakonsoleilla, kannattaa lisätä --quiet-valitsin nopeuttamiseksi)</comment>
# <i>emerge --sync --quiet</i>
</pre>

<p>
Jos palomuuri estää rsync-liikenteen, voi käyttää
<c>emerge-webrsync</c>iä Portagepuun hakemiseen.
</p>

</body>
</subsection>
<subsection>
<title>Profiilin valitseminen</title>
<body>

<p>
Aluksi vähän profiilin merkityksestä.
</p>

<p>
Profiili on Gentoo-järjestelmä eräs asetusosanen. Se muun muassa määrittelee
oletusarvot CHOSTille, CFLAGSeille ja muille tärkeille muuttujille, sekä
lukitsee järjestelmäohjelmiston tiettyihin versioihin. Näistä kaikista
asetuksista vastaavat Gentoon kehittäjät.
</p>

<p>
Aiemmissa versioissa käyttäjä harvemmin joutui säätämään profiilitietoja,
hiljattain kuitenkin x86:een, hppa:han ja alphaan on pantu valittavaksi kaksi
profiilia: toinen 2.4-version ja toinen 2.6-version kernelille. Tämä asetus on
tehty 2.6-sarjan kernelien tuomiseksi laajempaan käyttöön.
</p>

<p>
Käytössä olevan profiilin näkee seuraavalla komennolla:
</p>

<pre caption="Järjestelmän profiilin katselu">
# <i>ls -FGg /etc/make.profile</i>
lrwxrwxrwx  1 48  1. helmi  11:33 /etc/make.profile -> ../usr/portage/profiles/default-linux/x86/2005.1/
</pre>

<p>
Jos käytät jotain aiemmin mainitusta arkkitehtuureista, oletusprofiili on
2.6-linuxeille. Tämä on hyvin suositeltava ratkaisu, mutta voit myös valita
käyttää toista profiilia. PPC:llä ja PPC64:llä on myös useita profiileja,
joista lisää tuonnempana.</p>

<p>
Jos sinulla on hyvä syy käyttää vanhempaa 2.4-sarjan linuxia, tarkasta ensin,
että sille on olemassa profiili. X86-järjestelmillä tarkastus hoituu
seuraavasti:
</p>

<pre caption="Lisäprofiilin 2.4 tarkastelu">
# <i>ls -d /usr/portage/profiles/default-linux/x86/no-nptl/2.4</i>
/usr/portage/profiles/default-linux/x86/no-nptl/2.4
</pre>

<p>
Ylläolevasta selviää, että 2.4-profiili on olemassa (koska ei tullut ilmoitusta
puuttuvasta hakemistosta). Oletusprofiilissa pysyminen on vielä suositeltavaa,
mutta toiseen profiiliin voi halutessaan vaihtaa:
</p>

<pre caption="Vaihto 2.4-profiiliin">
<comment>(Varmista että käytät oikeaa arkkitehtuuria, esimerkki on x86:lle)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/x86/no-nptl/2.4 /etc/make.profile</i>
<comment>(List the files in the 2.4 profile)</comment>
# <i>ls -FGg /etc/make.profile/</i>
yhteensä 12
-rw-r--r--  1 939 10. joulu  15:06 packages
-rw-r--r--  1 347  3. joulu   2004 parent
-rw-r--r--  1 573  3. joulu   2004 virtuals
</pre>

<p>
PPC:lle on olemassa lukuisia profiileja 2005.1:ssä.
</p>

<pre caption="PPC-profiilit">
<comment>(Geneerinen PPC-profiili kaikille PPC:ille)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc /etc/make.profile</i>
<comment>(G3)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G3 /etc/make.profile</i>
<comment>(G3 Pegasos)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G3/Pegasos/ /etc/make.profile</i>
<comment>(G4 (Altivec))</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G4 /etc/make.profile</i>
<comment>(G4 Pegasos)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G4/Pegasos/ /etc/make.profile</i>
</pre>

<p>
PPC64:lle on lukuisia profiileja 2005.1:ssä.
</p>

<pre caption="PPC64-profiilit">
<comment>(Geneerinen 64-bitttinen käyttöympäristö PPC64-profiili kaikille PPC64:ille)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/64bit-userland /etc/make.profile</i>
<comment>(Geneerinen 32-bittinen käyttöympäristö PPC64-profiili kaikille PPC64:ille)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/32bit-userland /etc/make.profile</i>
<comment>(Kaikille käyttöympäristöille on aliprofiilinsa muissa profiileissa,
jota merkataan (userland):lla alla, tämä korvataan sopivalla
vaihtoehdolla)</comment>
<comment>(970-profiili JS20:lle)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/970 /etc/make.profile</i>
<comment>(G5)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/970/pmac /etc/make.profile</i>
<comment>(POWER3)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/power3 /etc/make.profile</i>
<comment>(POWER4)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/power4 /etc/make.profile</i>
<comment>(POWER5)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/power5 /etc/make.profile</i>
<comment>(Multilib-profiili ei vielä ole stabiili.)</comment>
</pre>

</body>
</subsection>
<subsection id="configure_USE">
<title>USE-muuttujien asettaminen</title>
<body>

<p>
<c>USE</c> on yksi Gentoo-ympäristön tärkeimmistä muuttujista. Suureen osaan
ohjelmista voidaan kääntää mukaan vaihtoehtoinen tuki tietyille asioille.
Esimerkiksi joissakin ohjelmissa voi olla sekä gtk- että qt-tuki. Joihinkin
voi saada valinnaisena SSL-tuen. Jotkin kääntyvät jopa framebuffer-tuella
(svgalib) ilman X11:ä.
</p>

<p>
Useimmat jakelut kääntävät paketteihin mukaan tuen kaikelle mahdolliselle, mikä
on omiaan lisäämään ohjelmien kokoa ja käynnistysaikaa riippuuvuuksien määrästä
puhumattakaan. Gentoolla voit päättää mitkä asetukset käännetään mukaan. Tähän
käytämme juuri <c>USE</c>-muuttujia.
</p>

<p>
<c>USE</c>-muuttujaan määritetään avainsanoja jotka tulkitaan sitten
käännösasetuksiksi. Esimerkiksi <e>ssl</e> kääntää SSL-tuen jos ohjelmassa
sellainen on ja <e>-X</e> poistaa X-palvelintuen käytöstä (äksän edessä on siis
miinus). Asetuksella <e>gnome gtk -kde -qt</e> ohjelmat käännetään
Gnome- ja gtk-tuen kanssa, mutta ilman kde- tai qt-tukea. Näin aikaansaataisiin
täysin Gnome järjestelmä.
</p>

<p>
Oletusarvoiset <c>USE</c>-asetukset ovat profiilin
<path>make.defaults</path>-tiedostoissa. <path>make.defaults</path>it ovat
löydettävissä symbolisen linkin <path>/etc/make.profile</path> osoittamassa
hakemistossa ja kaikissa sen ylähakemistoissa aina profiilihakemistojen
juurihakemistoon saakka.
Itsetehdyt asetukset tiedostossa
<path>/etc/make.conf</path> lisätään niiden päälle. Lisätty asetus lisätään
oletusten listaan ja poistettu (asettamalla miinusmerkki asetuksen eteen)
poistetaan listasta (jos se siellä oli alunperinkään). Hakemiston
<path>/etc/make.profile</path> asetuksia <e>ei saa</e> muuttaa sillä se
korvataan jokaisessa Portagen päivityksessä.
</p>

<p>
<c>USE</c>-järjestelmän täydempi kuvaus löytyy käsikirjan toisen osan <uri
link="?part=2&amp;chap=2">kappaleesta 2: Use-muuttujat</uri>. Muuttujien
kuvaukset majailevat järjestelmän tiedostossa
<path>/usr/portage/profiles/use.desc</path>.
</p>

<pre caption="USE-kuvausten katselu">
# <i>less /usr/portage/profiles/use.desc</i>
<comment>(Nuolinäppäimillä vieritetään ja q:lla lopetetaan)</comment>
</pre>

<p>
Esimerkissä on <c>USE</c>-asetukset KDE-järjestelmälle DVD-, ALSA- ja
CD:n polttotuella.
</p>

<pre caption="/etc/make.confin avaus">
# <i>nano -w /etc/make.conf</i>
</pre>

<pre caption="USE-asetukset">
USE="-gtk -gnome qt kde dvd alsa cdr"
</pre>

</body>
</subsection>
<subsection>
<title>Valinnainen: GlibC:n localet</title>
<body>

<p>
Tyypillisessä järjestelmässä tarvitaan vain pari localea (maa-asetustoa)
käytettäväksi. Aikoinaan <c>glibc</c>:n mukana käännettiin aina kaikki maailman
localet samalla. Nykyään tätä voi rajoittaa <c>userlocales</c> USE-asetuksella
ja määrittämällä vain tarvitut asetustot tiedostoon
<path>/etc/locales.build</path>. Älä säädä kuitenkaan näitä, jollet tiedä mistä
on kysymys.
</p>

<pre caption="Userlocales-USE-asetuksen lisäys glibc:lle">
<i>mkdir -p /etc/portage</i>
<i>echo "sys-libs/glibc userlocales" >> /etc/portage/package.use</i>
</pre>

<p>
Seuraavaksi määritellään halutut localet. Esimerkiksi näin saadaan aikaan
Suomessa käytettävät paikallisasetustot kaikilla yleisesti käytössä olevilla
merkistöillä ja brittienglanti lisäksi:
</p>

<pre caption="nano -w /etc/locales.build">
fi_FI/ISO-8859-1
fi_FI@euro/ISO-8859-15
fi_FI.UTF-8/UTF-8
sv_FI/ISO-8859-1
sv_FI@euro/ISO-8859-15
sv_FI.UTF-8/UTF-8
en_GB/ISO-8859-1
en_GB.UTF-8/UTF-8
</pre>


</body>
</subsection>
<subsection>
<title>Valinnainen: Lähdekoodien lataaminen</title>
<body>

<p>
Jos haluat <c>emerge</c>n lataavan kaikki lähteet ennen asentamista (vaikkapa
siksi, kun et voi pitää internet-yhteyttä auki koko kääntämisen ajan) voit
käyttää valitsinta <e>--fetchonly</e>. Se lataa kaikki paketit asentamatta
niitä.
</p>

<pre caption = "Lähdekoodien hakeminen">
# <i>emerge --fetchonly --emptytree system</i>
</pre>

</body>
</subsection>
<subsection>
<title>Järjestelmän kääntäminen</title>
<body>

<p>
Järjestelmän kääntäminen käynnistetään komennolla <c>emerge --emptytree
system</c>.
Käännös kestää taas jonkin aikaa joten voit tehdä muita hommia odotellessasi.
</p>

<pre caption = "Järjestelmän kääntäminen">
# <i>emerge --emptytree system</i>
</pre>

<p>
Taas kerran, koskemattomilla CFLAGS- ja CXXFLAGS-asetuksilla pärjää hyvin
käyttämällä <c>--newuse</c>a <c>--emptytree</c>n asemesta.
</p>

<p>
Ohita kaikki varoitukset päivitetyistä tiedostoista (ja komennon
<c>etc-update</c> ajamisesta). Asennuksen jälkeen kannattaa lukea dokumentaatio
<uri
link="?part=2&amp;chap=2#doc_chap3">Asetustiedostojen suojaamisesta</uri>.
</p>

<p>
Asennusprosessin lopetettua jatka <uri
link="?part=1&amp;chap=7">Säätämällä ytimen asetuksia</uri>.
</p>

</body>
</subsection>
</section>
</sections>

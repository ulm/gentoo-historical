<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fi/nvidia-guide.xml,v 1.9 2006/01/31 01:39:10 flammie Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/en/nvidia-guide.xml" lang="fi">
<title>Gentoo Linuxin nVidia-opas</title>

<author title="Tekijä">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Toimittaja">
  <mail link="curtis119@gentoo.org">M Curtis Napier</mail>
</author>
<author title="Toimittaja">
  <mail link="jackdark@gmail.com">Joshua Saddler</mail>
</author>
<author title="Vastuullinen kääntäjä">
  <mail link="flammie@gentoo.org">Flammie Pirinen</mail>
</author>

<abstract>
Monilla Gentoon käyttäjillä on nVidian piirejä grafiikkakorteissaan. nVidia
on tehnyt Linuxille erityiset ajurit, jotka tehostavat näiden suorituskykyä.
Tässä oppaasse kerrotaan kuinka ajurit asennetaan ja säädetään kuntoon.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.19</version>
<date>2006-01-21</date>

<chapter>
<title>Johdanto</title>
<section>
<body>

<p>
Nvidia julkaisee itse omat laadukkaat ja kiihdytetyt ajurinsa linuxille. Ajurit
on jaettu kahteen pakettiin: <c>nvidia-kernel</c>iin ja <c>nvidia-glx</c>:ään.
</p>

<p>
<c>Nvidia-kernel</c> on ytimen ajuri, joka hoitaa kommunikoinnin
laitteistotasolla. Tämä on tavan ydinmoduuli, <c>nvidia</c>, ja asentuu
olemassaolevia ytimen sorsia käyttämään. Se pitää ladata, että se toimii.
</p>

<p>
Ajurin lisäksi pitä asentaa X11:n GLX-rajapinta (eli <c>nvidia-glx</c>), jota
käytetään X:n grafiikan piirtoon. Se käyttää <c>nvidia-kernel</c>iä
kommunikoidakseen laitteiston kanssa.</p>

</body>
</section>
</chapter>

<chapter>
<title>Kortin asetusten tekeminen</title>
<section>
<title>Ydinasetukset</title>
<body>

<p>
Kuten aiemmin mainittiin, nVidian ajurit käyttävät olemassaolevaa ydintä. Ne
ovat ydinmoduuleja, joten ytimeen pitää tietenkin lisätä tuki ladattaville
moduuleille. Jos ydin on tehty <c>genkernel</c>illä, tämä tuki on valmiina;
jollei, tarkista ytimen asetuksista, että tuki on päällä:
</p>

<pre caption="Ladattavien ydinmoduulien tuen asettaminen">
Loadable module support ---&gt;
  [*] Enable loadable module support
</pre>

<p>
Myös <e>Memory Type Range Register</e> -tuki pitää olla kernelissä:
</p>

<pre caption="MTRR:n asettaminen">
Processor and Features ---&gt;
  [*] MTRR (Memory Type Range Register) support
</pre>

<p>
Nvidian moduulit ja kirjastot ovat kahdessa paketissa: <c>nvidia-glx</c> ja
<c>nvidia-kernel</c>. Ensimmäisessä on X11:n GLX-kirjastot ja jälkimmäisessä
ydinmoduulit.
</p>

<p>
Nvidia-kernelin ebuild osaa hakea ytimen version
<path>/usr/src/linux</path>-linkin perusteella. Varmista siis, että tämä
linkki osoittaa oikeaan ytimeen ja se ydin on asetettu. <uri
link="/doc/fi/handbook/">Asennuskäsikirjassa</uri> on ohjeita ytimen
asettamiseen.
</p>

<p>
Jos käytössä on vaikkapa gentoo-sources-2.6.11-r6, pitäisi hakemiston
<path>/usr/src/</path> näyttää seuraavalta:
</p>

<pre caption="/usr/src/linux-linkin tarkastelu">
# <i>cd /usr/src</i>
# <i>ls -l</i>
<comment>(Varmista että linkki osoittaa oikeaan)</comment>
lrwxrwxrwx   1 root root   12  1. helmi  12:40 linux -&gt; linux-2.6.11-gentoo-r6
drwxr-xr-x  19 root root 4096  7. huhti  21:11 linux-2.6.11-gentoo-r6
drwxr-xr-x  18 root root 4096 20. huhti  21:11 linux-2.6.10
drwxr-xr-x  19 root root 4096 29. touko  21:11 linux-2.6.11.4
</pre>

<p>
Jollei linkki osoita oikeaan, sen voi korjata:
</p>

<pre caption="/usr/src/linux-linkin luonti">
# <i>cd /usr/src</i>
# <i>ln -snf linux-2.6.11-gentoo-r6 linux</i>
</pre>

</body>
</section>
<section>
<title>Valinnainen: Tarkista vanhempien korttien tuettuus</title>
<body>

<note>
Valitettavasti joitain vanhempi kortteja ei enää tueta uusissa 
<c>nvidia-glx</c>:n ja <c>nvidia-kernel</c>in versioissa. NVidialla on
<uri
link="http://www.nvidia.com/object/IO_18897.html">luettelo tuetuista 
näytönohjaimista</uri> sivuillaan, se kannattaa lukea läpi ennen asentamista.
</note>

<p>
Seuraavia vanhoja kortteja <b>ei tueta</b>:
</p>

<pre caption="Tukemattomat kortit">
TNT2
TNT2 Pro
TNT2 Ultra
TNT2 Model 64 (M64)
TNT2 Model 64 (M64) Pro
Vanta
Vanta LT
GeForce 256
GeForce DDR
GeForce2 GTS
GeForce2 Pro
GeForce2 Ti
GeForce2 Ultra
GeForce2 MX Integrated graphics
Quadro
Quadro2 Pro
Quadro2 EX
</pre>

<p>
Näiden korttien omistajien pitää maskata uudemmat versiot nVidian ajureista ja
asentaa vanhemmat versiot:
</p>

<pre caption="Uudempien ajurien maskaus">
# <i>echo "&gt;media-video/nvidia-kernel-1.0.6629-r4" &gt;&gt; /etc/portage/package.mask</i>
# <i>echo "&gt;media-video/nvidia-glx-1.0.6629-r7" &gt;&gt; /etc/portage/package.mask</i>
</pre>

</body>
</section>
<section>
<title>Ajurien asennus</title>
<body>

<p>
Nyt asennetaan <c>nvidia-kernel</c> ja <c>nvidia-glx</c>. Koska
<c>nvidia-glx</c> riippuu <c>nvidia-kernel</c>istä, on sen asentaminen
riittävää:
</p>

<pre caption="nVidian pakettien asennus">
# <i>emerge nvidia-glx</i>
</pre>

<impo>
Joka kerta kun 
<uri link="/doc/fi/kernel-upgrade.xml">asennat uuden ytimen</uri>
tai käännät nykyisen uusiksi, <c>emerge nvidia-kernel</c> pitää
toistaa, jotta nVidian ajurit asentuisivat oikein. <c>Nvidia-glx</c>:ään 
tämä ei kuitenkaan vaikuta. <c>Nvidia-glx</c>:ää ei itse asiassa tarvitse 
päivittää edes X:n päivitysten mukana.
</impo>

<p>
Kun asennus on ohi, aja <c>modprobe nvidia</c> ladataksesi ytimen moduulit
muistiin.
</p>

<pre caption="Ydinmoduulien lataus">
# <i>modprobe nvidia</i>
</pre>

<p>
Halunnet tämän toiminnon tapahtuvan jokaisessa käynnistymisessä, siispä lisäät
tiedostoon <path>/etc/modules.autoload.d/kernel-2.6</path> (tai
<path>kernel-2.4</path>) rivin <c>nvidia</c>. Muista suorittaa
<c>modules-update</c> sen jälkeen!
</p>

<pre caption="Modules-updaten suoritus">
# <i>modules-update</i>
</pre>

</body>
</section>
<section>
<title>X-palvelimen asetukset</title>
<body>

<p>
Kun ajurit on asennettu, X-palvelin (XFree86 tai Xorg) pitää asettaa käyttämään
<c>nvidia</c>-ajuria oletusarvoisen <c>nv</c>:n asemesta.
</p>

<p>
Avaa <path>/etc/X11/xorg.conf</path> (tai <path>/etc/X11/XF86Config</path>)
suosikkieditorillasi (kuten <c>nano</c>lla tai <c>vim</c>illä) ja etsi
kohta <c>Device</c>. Siellä muokkaa riviä <c>Driver</c>:
</p>

<pre caption="nv:n muutos nvidiaksi X:n ajuriosiossa">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  <i>Driver     "nvidia"</i>
  VideoRam   65536
EndSection
</pre>

<p>Sitten etsit <c>Module</c>-osion asetustiedostosta ja varmistat että
glx-moduuli ladataan kun taas dri:tä ei:</p>

<pre caption="Module-osion päivitys">
Section "Module"
  <comment>(...)</comment>
  <i># Load  "dri"
  Load  "glx"</i>
  <comment>(...)</comment>
EndSection
</pre>

<p>
Seuraavaan osaan <c>Screen</c> pitää asettaa <c>DefaultDepth</c>in arvoksi
joko 16 tai 24, tai sitten <c>Display</c>-osan pitää sisältää vain
<c>Depth</c>-asetukset 16 ja 24, muutoin nvidia-glx ei toimi.
</p>

<pre caption="Screen-osion päivitys">
Section "Screen"
  <comment>(...)</comment>
  <i>DefaultDepth 24</i>
  Subsection "Display"
  <comment>(...)</comment>
EndSection
</pre>

<p>
Kun suoritat <c>opengl-update</c>n, X-palvelin ryhtyy käyttämään nVidian
GLX-kirjastoa:
</p>

<pre caption="opengl-updaten ajaminen">
# <i>opengl-update nvidia</i>
</pre>

</body>
</section>
<section>
<title>Kortin testaus</title>
<body>

<p>
Kortin voi testata käynnistämällä X:n ja suorittamalla
<c>glxinfo | grep direct</c>. Sen pitäisi tulostaa jotta direct rendering on
päällä:
</p>

<pre caption="Direct renderingin tarkastelu">
$ <i>glxinfo | grep direct</i>
direct rendering: Yes
</pre>

<p>
FPS:iä voi tarkastella komennolla <c>glxgears</c>.
</p>

</body>
</section>
<section>
<title>nVidia-tuen hyödyntäminen ohjelmissa</title>
<body>

<p>
Jotkin sovellukset, kuten <c>mplayer</c> tai <c>xine-lib</c>, käyttävät
paikallista USE-flägiä nvidia, jolla saa käyttöön XvMCNVIDIA-tuen vaikkapa
korkearesoluutiovideoita varten. Tämän voi asettaa päälle joko
<path>/etc/make.conf</path>in globaaleihin USE-flägeihin tai pakettikohtaisesti
<c>media-video/mplayer</c>ille tai <c>media-libs/xine-lib</c>ille tiedostoon
<path>/etc/portage/package.use</path>.
</p>

<p>
USE-flägimuutosten jälkeen komento <c>emerge -uD --newuse world</c> kääntää
uudelleen sovellukset joihin muutokset vaikuttavat.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Vianpaikannus</title>
<section>
<title>2D toimimaan yli 4 Gigatavun muistilla varustetuilla koneilla</title>
<body>

<p>
Jos nVidian 2D-kiihdytys tuottaa ongelmia, vika on todennäköisesti siinä, ettei
MTRR:n write-combining-aluetta voida asettaa. Tämän voit varmistaa tiedoston
<path>/proc/mtrr</path> sisällöstä:
</p>

<pre caption="Tarkasta että write-combining on päällä">
# <i>cat /proc/mtrr</i>
</pre>

<p>
Joka rivillä tulisi olla "write-back" tai "write-combining". Jos jollain
rivillä lukee "uncachable", joudut säätämään BIOSia korjataksesi sen.
</p>

<p>
Uudelleenkäynnistä BIOSiin, etsi sieltä MTRR-asetukset (yleensä kohdassa "CPU
Settings" tai vastaavaa). Muuta asetus arvosta "continuous" arvoksi "discrete"
ja käynnistä uudelleen. Nyt "uncachable"-kohtien pitäisi olla poissa ja
2D-kiihdytyksen toimia ongelmitta.
</p>

</body>
</section>
<section>
<title>Varoitukset 4K stackista</title>
<body>

<p>
Versiota 1.0-6106 vanhemmat <c>nvidia-kernel</c>it eivät tue kuin 8 kilon
pinokokoa.
Tuoreimmissa kerneleissä (2.6.6:ta uudemmissa) on tuki myös 4 kilon pinoille,
älä valitse tätä asetusta, jos käytät vanhempaa <c>nvidia-kernel</c>iä. Asetus
on osiossa <c>Kernel Hacking</c>.
</p>

</body>
</section>
<section>
<title>nVidian asetustyökalun käyttö</title>
<body>

<p>
Versiosta 1.0.6106 lähtien nVidian ajureihin on ollut myös asetustyökalu. 
Tällä työkalulla voi muuttaa ajurin asetuksia käynnistämättä X-palvelinta
uudelleen. Ohjelmat ovat saatavilla paketissa 
<c>media-video/nvidia-settings</c>.
</p>

</body>
</section>
<section>
<title>
  Moduulia ladattaessa esiintyvä "no such a device"-virhe
</title>
<body>

<p>
Yleisimmin tämä seuraa kun sopivaa laitetta ei löydy. Varmista, että kyseessä
on nVidian näyttökortti (voit käyttää myös <c>lspci</c>:tä tarkastaessasi).
</p>

<p>
Jos kyseessä on varmasti nVidian näyttökortti, tarkista BIOSin asetuksista,
että <e>Assign IRQ to VGA</e> tai vastaava on asetettu.
</p>

</body>
</section>
<section>
<title>
  Virhe ”no screens found” ilmaantuu ja lokien mukaan ”Failed to initialize
  the NVIDIA kernel module!” on ongelmana.
</title>
<body>

<p>
Laitetiedostot <path>/dev/nvidia*</path> saattavat puuttua. Luo ne komennolla
<c>NVmakedevices.sh</c>:
</p>

<pre caption="NVidian laitetiedostojen luonti">
# <i>/sbin/NVmakedevices.sh</i>
</pre>

</body>
</section>
</chapter>
<chapter>
<title>Lisäasetukset</title>
<section>
<title>Ohjeita</title>
<body>

<p>
Nvidian ajuripaktein mukana tulee myös tarkat ohjeet. Nämä asennetaan
hakemistoon <path>/usr/share/doc</path> ja niitä voi tarkastella vaikkapa
seuraavalla komennolla:
</p>

<pre caption="Nvidian ohjeiden tarkastelu">
# <i>less /usr/share/doc/nvidia-glx-*/README.txt.gz</i>
</pre>

</body>
</section>
<section>
<title>Ytimen moduulin parametrejä</title>
<body>

<p>
<c>Nvidia</c>-moduuli hyväksyy joitakin parametrejä, joilla voi säätää ajurien
toimintaa. Valtaosa näistä löytyy myös ohjeista. Parametrit asetetaan
tiedostossa <path>/etc/modules.d/nvidia</path>. Muista suorittaa
<c>modules-update</c> asetusten muokkaamisen jälkeen. Myös moduuli pitää
ladata uudelleen, jotta muutokset tulevat voimaan.
</p>

<pre caption="NVidian asetusten muokkaus">
<comment>(Muokkaa /etc/modules.d/nvidiaa)</comment>
# <i>nano -w /etc/modules.d/nvidia</i>
<comment>(Päivitä moduulitiedot)</comment>
# <i>modules-update</i>
<comment>(Poista moduuli)</comment>
# <i>modprobe -r nvidia</i>
<comment>(Uudelleenlataa moduuli)</comment>
# <i>modprobe nvidia</i>
</pre>

</body>
</section>
<section>
<title>X:n lisäasetukset</title>
<body>

<p>
GLX-rajapinnassa on myös joukko asetuksia säädettäväksi. Näillä muutetaan
TV-outin asetuksia, useamman näytön asetuksia, näytön virkistystaajuusasetuksia
ja niin edelleen. Nämäkin kaikki asetukset löytyvät myös ohjeista.
</p>

<p>
Nämä asetukset pitää merkitä X:n asetustiedoston (todennäköisesti
<path>/etc/X11/xorg.conf</path>) sopivalle Device-osiolle. Esimerkiksi
nVidian X:n käynnistyskuva poistetaan seuraavalla tavalla:
</p>

<pre caption="Nvidian lisäasetukset X:lle">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  Driver     "nvidia"
  <i>Option     "NoLogo" "true"</i>
  VideoRam   65536
EndSection
</pre>

</body>
</section>
</chapter>

</guide>

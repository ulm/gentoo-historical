<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fi/nvidia-guide.xml,v 1.14 2006/11/08 18:12:23 flammie Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fi/nvidia-guide.xml">
<title>Gentoo Linuxin nVidia-ohje</title>

<author title="Tekijä">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Toimittaja">
  <mail link="curtis119@gentoo.org">M Curtis Napier</mail>
</author>
<author title="Toimittaja">
  <mail link="nightmorph@gentoo.org">Joshua Saddler</mail>
</author>
<author title="Toimittaja">
  <mail link="wolf31o2@gentoo.org">Chris Gianelloni</mail>
</author>

<abstract>
NVidia julkaisee Linux-ajureita, joissa on hyvä suorituskyky. Tässä
ohjeessa kerrotaan ajurien asentamisesta ja säätämisestä.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.28</version>
<date>2006-10-23</date>

<chapter>
<title>Johdanto</title>
<section>
<body>

<p>
NVidia julkaisee itse Linux-ajureista, joissa on hyvä suorituskyky ja 
3D-kiihdytys. Portagessa on kahta lajia ajureita, <c>nvidia-drivers</c> on
kaikille uusille korteille ja <c>nvidia-legacy-drivers</c> tukee vanhoja
kortteja.
</p>

<note>
Aiemmin Gentoossa oli erilliset paketit ytimen ajurille (<c>nvidia-kernel</c>)
ja X:n GLX-ajureille (<c>nvidia-glx</c>). Nämä on nyt poistettu
<c>nvidia-drivers</c>- ja <c>nvidia-legacy-drivers</c>-pakettien alta.
Vanhojen pakettien käyttäjien kannattaa päivittää.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Asetusten teko</title>
<section>
<title>Ytimen asetukset</title>
<body>

<p>
NVidian ydinajuri asentuu asennettua ydintä vastaan. Se luo moduulin, jonka
voi ladata ytimeen, joka tukee moduulien lataamista. Jos ydin on tehty
<c>genkernel</c>illä. Jollet tiedä, kannattaa asia tarkistaa:
</p>

<pre caption="Moduulien lataamisen tuki">
Loadable module support ---&gt;
  [*] Enable loadable module support
</pre>

<p>
Lisäksi tarvitaan <e>MTRR</e>-tuki:
</p>

<pre caption="MTRR-tuki">
Processor and Features ---&gt;
  [*] MTRR (Memory Type Range Register) support
</pre>

<p>
Jos näyttökortti on AGP-väylässä, on mahdollista käyttää ytimen
<c>agpgart</c>ia moduulina tai mukaan käännettynä. Jos ytimen agpgart ei
ole käytössä, nVidian ajurit käyttävät omaansa <c>nvAGP</c>:tä. Joissain
järjestelmissä nvagp toimii ytimen ajuria paremmin, joissain huonommin.
Tämä kannattaa testata itse parhaan laadun takaamiseksi. Jollet tiedä mitä
tehdä, käytä ytimen agpgartia:
</p>

<pre caption="Agpgart-tuki">
Device Drivers ---&gt;
Character devices ---&gt;
&lt;*&gt; /dev/agpgart (AGP Support)
</pre> 

</body>
</section>
<section>
<title>Alustakohtaista tietoa</title>
<body>

<impo>
X86- ja AMD64-prosessoreille ytimen ajurit eivät sovi yhteen nVidian tarjoamien
kanssa. Jos ydin on x86:lle tai AMD64:lle pitää ytimestä poistaa
nVidia-ajurit.
</impo>

<pre caption="Nvidia-ajurituki pois">
Device Drivers ---&gt;
Graphics Support ---&gt;
&lt; &gt;   nVidia Framebuffer Support
&lt; &gt;   nVidia Riva support
</pre>

<p>
Toimiva framebuffervaihtoehto on <c>VESA</c>:
</p>

<pre caption="VESA-tuki">
Device Drivers ---&gt; 
Graphics Support ---&gt;
&lt;*&gt;   VESA VGA graphics support
</pre>

<p>
VESA-ajurityypiksi valitaan <c>vesafb</c> tai <c>vesafb-tng</c>. Jos käytössä
on AMD64, <c>vesafb</c> on parempi valinta.
</p>

<pre caption="Framebuffer-tyyppi">
(X) vesafb
( ) vesafb-tng
</pre>

<p>
Lisätietoja on tiedostossa
<path>/usr/src/linux/Documentation/fb/vesafb.txt</path> ja
hakemiston <path>/usr/src/linux/Documentation/fb/</path> muissa tiedostoissa.
</p>

</body>
</section>
<section>
<title>Ytimen asetukset, jatkuu</title>
<body>

<p>
<c>Nvidia-drivers</c> ja <c>nvidia-legacy-drivers</c> valitsevat automaattisesti
ytimen, johon ajuri tulee hakemistolinkistä <path>/usr/src/linux</path>.
Varmista, että tämä osoittaa oikeaan. Lisätietoja on <uri
link="/doc/en/handbook/">asennuskäsikirjan</uri> kappaleessa ytimen asetukset.
</p>

<p>
Jos käytössä on ydin gentoo-sources-2.6.11-r6, hakemisto <path>/usr/src</path>
näyttää seuraavalta:
</p>

<pre caption="/usr/src/linux-linkin tarkastelu">
# <i>cd /usr/src</i>
# <i>ls -l</i>
<comment>(Tarkasta mihin linux osoittaa)</comment>
lrwxrwxrwx   1 root root   22 Apr 23 18:33 linux -&gt; linux-2.6.11-gentoo-r6
drwxr-xr-x   4 root root  120 Apr  8 18:56 linux-2.4.26-gentoo-r4
drwxr-xr-x  18 root root  664 Dec 31 16:09 linux-2.6.10
drwxr-xr-x  18 root root  632 Mar  3 12:27 linux-2.6.11
drwxr-xr-x  19 root root 4096 Mar 16 22:00 linux-2.6.11-gentoo-r6
</pre>

<p>
Yllä näkyy että <c>linux</c> osoittaa <c>linux-2.6.11-gentoo-r6</c>:een.
</p>

<p>
Jos symlinkki ei osoita oikeaan paikkaan se päivitetään:
</p>

<pre caption="/usr/src/linuxin kohdistus">
# <i>cd /usr/src</i>
# <i>ln -snf linux-2.6.11-gentoo-r6 linux</i>
</pre>

</body>
</section>
<section>
<title>Valinnainen: Varmista vanhan kortin tuki</title>
<body>

<note>
Joitakin vanhoiksi määriteltyjä kortteja ei enää tueta uudessa 
<c>nvidia-drivers</c>issa. NVidialla on <uri
link="http://www.nvidia.com/object/IO_18897.html">luettelo tuetuista laitteista
</uri> sivuillaan. Tarkasta luettelosta ennen asentamista.
</note>

<p>
Seuraava luettelo on <b>tukemattomia</b> kortteja:
</p>

<pre caption="Unsupported cards">
TNT2
TNT2 Pro
TNT2 Ultra
TNT2 Model 64 (M64)
TNT2 Model 64 (M64) Pro
Vanta
Vanta LT
GeForce 256
GeForce DDR
GeForce2 GTS
GeForce2 Pro
GeForce2 Ti
GeForce2 Ultra
GeForce2 MX Integrated graphics
Quadro
Quadro2 Pro
Quadro2 EX
</pre>

<p>
Jos kortti on luettelossa, pitää käyttää <c>nvidia-legacy-drivers</c>ia.
</p>

</body>
</section>
<section>
<title>Ajurin asennus</title>
<body>

<pre caption="Ajurien asentaminen">
<comment>(Uusille korteille)</comment>
# <i>emerge nvidia-drivers</i>
<comment>(Vanhojen listassa oleville)</comment>
# <i>emerge nvidia-legacy-drivers</i>
</pre>

<impo>
Joka kerta kun <uri link="/doc/en/kernel-upgrade.xml">uusi ydin käännetään</uri>
tai vanha uudelleenasennetaan, pitää <c>emerge nvidia-drivers</c>
tai <c>emerge nvidia-legacy-drivers</c> toistaa.
</impo>

<p>
Kun asennus on valmis, <c>modprobe nvidia</c> lataa ajurin muistiin. Jos
kyseessä on päivitys, vanhaa ajuri pitää ensin ladata pois muistista.
</p>

<pre caption="Ajurin lataaminen">
# <i>lsmod | grep nvidia &amp;&amp; rmmod nvidia</i>
# <i>modprobe nvidia</i>
</pre>

<p>
Ajurin voi myös lisätä automaattisesti käynnistyksessä ladattaviin
kirjoittamalla sen nimen tiedostoon
<path>/etc/modules.autoload.d/kernel-2.6</path> (tai <path>kernel-2.4</path>,
riippuen ytimen versiosta) ja lisää <c>nvidia</c>. Muista ajaa
<c>modules-update</c> lopuksi.
</p>

<impo>
Jos <c>agpgart</c> on myös moduuli, se pitää lisätä tiedostoon
<path>/etc/modules.autoload.d/kernel-2.6</path> (tai <path>kernel-2.4</path>).
</impo>

<pre caption="Modules-updaten käyttö">
# <i>modules-update</i>
</pre>

</body>
</section>
<section>
<title>X-palvelimen asettaminen</title>
<body>

<p>
Kun ajurit on asennettu, pitää vielä tehdä asetukset X:lle, että käytetään
<c>nvidia</c>-ajuria oletusarvoisen <c>nv</c>:n sijaan.
</p>

<p>
Avaa tiedosto <path>/etc/X11/xorg.conf</path> suosikkimuokkaimeesi 
(<c>nano</c>on tai <c>vim</c>iin) ja etsi <c>Device</c>-osion
<c>Driver</c>-rivi:
</p>

<pre caption="Nv:n muuttaminen nvidiaksi asetuksissa">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  <i>Driver     "nvidia"</i>
  VideoRam   65536
EndSection
</pre>

<p>
Siirry sitten <c>Module</c>-osioon ja varmista, että <c>glx</c> ladataan ja
<c>dri</c>:tä ei:
</p>

<pre caption="Modulen muuttaminen">
Section "Module"
  <comment>(...)</comment>
  <i># Load  "dri"
  Load  "glx"</i>
  <comment>(...)</comment>
EndSection
</pre>

<p>
Seuraavaksi <c>Screen</c>-osiossa kannattaa varmistaa 
<c>DefaultDepth</c>iksi 16 tai 24, tahi että <c>Display</c>-aliosioissa on
vain <c>Depth</c>ejä 16 tai 24. Muutoin nVidian GLX ei toimi.
</p>

<pre caption="Screenin muokkaus">
Section "Screen"
  <comment>(...)</comment>
  <i>DefaultDepth 16</i>
  Subsection "Display"
  <comment>(...)</comment>
EndSection
</pre>

<p>
<c>Eselect</c>illä voi valita X:n GLX-kirjastot:
</p>

<pre caption="Eselectin käyttö">
# <i>eselect opengl set nvidia</i>
</pre>

</body>
</section>
<section>
<title>Käyttäjien lisäys video-ryhmään</title>
<body>

<p>
Käyttäjät pitää lisätä <c>video</c>-ryhmään, jotta heillä olisi pääsy
nvidia-laitetiedostoihin:
</p>

<pre caption="Käyttäjän lisäys ryhmään">
# <i>gpasswd -a käyttäjä video</i>
</pre>

<p>
Tämä ei ole täysin välttämätöntä, jollei käytä <c>udev</c>iä, muttei
haittaakaan.
</p>

</body>
</section>
<section>
<title>Testaaminen</title>
<body>

<p>
Ajurin voi testata nopeasti X:ssä komennolla <c>glxinfo | grep direct</c>.
Sen pitäisi kertoa, että direct rendering on käytössä.
</p>

<pre caption="Direct rendering -testi">
$ <i>glxinfo | grep direct</i>
direct rendering: Yes
</pre>

<p>
Suorituskyvystä saa jonkinlaisen kuvan komennolla <c>glxgears</c>.
</p>

</body>
</section>
<section>
<title>NVidia-tuen käyttäminen</title>
<body>

<p>
Joissain työkaluissa, kuten <c>mplayer</c>issä ja <c>xine-lib</c>issä on
USE-flägi nvidia, joka kääntää päälle XvMCNVIDIA-tuen  esim.
korkearesoluutioisia videoita varten. Lisää nvidia USE-flägeihin
<path>/etc/make.conf</path>issa tai paketeille <c>media-video/mplayer</c>
tai <c>media-libs/xine-lib</c> pakettiasetustiedostoissa
<path>/etc/portage/package.use</path>.
</p>

<p>
Tämän jälkeen voi kääntää uudet asetukset käyttöön komennolla <c>emerge 
-uD --newuse world</c>, joka kääntää kaikki USE-muuttuneet paketit
järjestelmästä.
</p>

</body>
</section>
<section>
<title>NVidia-settings-työkalu</title>
<body>

<p>
Ajureista 1.0.6106 lähtien saatavilla on ollut myös asetustyökalu, jolla voi
muuttaa grafiikka-asetuksia käynnistämättä X:ää uudelleen. Se löytyy
Portage-puusta paketista <c>media-video/nvidia-settings</c>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Ongelmanselvityksestä</title>
<section>
<title>2D-ongelmat yli 4 gigan muistilla</title>
<body>

<p>
Jos nVidian 2d-kiihdytys ei toimi, vika saattaa olla MTRR:n write-combining
rangen asetuksessa. Tämän voi tarkistaa tiedostosta <path>/proc/mtrr</path>:
</p>

<pre caption="Write-combining-asetusten katselu">
# <i>cat /proc/mtrr</i>
</pre>

<p>
Joka rivin pitäisi kertoa ”write-back” tai ”write-combining”. Jos siellä lukee
”uncachable”, pitää muuttaa BIOS-asetuksia.
</p>

<p>
Käynnistä BIOS-asetuksiin, etsi MTRR-asetukset (yleensä CPU-asetuksissa tai
vastaavassa osiossa) ja muuta jatkuvasta diskreetiksi. Käynnistä uudelleen. Nyt
”uncachable”-kohtien pitäisi olla poissa ja 2D-kiihdytyksen toimia.
</p>

</body>
</section>
<section>
<title>
	No such device -virhe ajuria ladattaessa
</title>
<body>

<p>
Tämä tarkoittaa, ettei sopivaa näyttökorttia löydy. Tarkista, että käytössä
on sopiva nVidia-näytönohjain (voit käyttää apuna <c>lspci</c>:tä).
</p>

<p>
Jos olet varma, että käytössä on nVidian näytönohjain, tarkista BIOSista
asetus ”Assign IRQ to VGA”. Sen pitäisi olla päällä.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Tehokäyttäjän asetukset</title>
<section>
<title>Ohjeita</title>
<body>

<p>
NVidian ajureissa tulee mukana paljon hyödyllisiä ja ajantasaisia ohjeita.
Ne on asennettu <c>/usr/share/doc</c>iin ja niitä voi katsella seuraavin
komennoin:
</p>

<pre caption="NVidian ohjeiden katselu">
<comment>(nvidia-drivers)</comment>
$ <i>less /usr/share/doc/nvidia-drivers-*/README.gz</i>
<comment>(nvidia-legacy-drivers)</comment>
$ <i>less /usr/share/doc/nvidia-legacy-drivers-*/README.gz</i>
</pre>

</body>
</section>
<section>
<title>Ytimen ajurin parametrit</title>
<body>

<p>
<c>Nvidia</c>-moduuli hyväksyy useita parametreja asetusten virittämiseen.
Useimmat näistä kuvataan ohjeissakin. Asetuksia voi muuttaa tiedostosta 
<c>/etc/modules.d/nvidia</c>. Muista ajaa <c>modules-update</c> jälkikäteen.
Asetukset tulevat voimaan kun nvidia-ajuri seuraavan kerran ladataan.
</p>

<pre caption="Nvidia-asetusten säätö">
<comment>(Muokkaa tiedostoa /etc/modules.d/nvidia)</comment>
# <i>nano -w /etc/modules.d/nvidia</i>
<comment>(Muokkaa moduulia)</comment>
# <i>modules-update</i>
<comment>(Poista moduuli)</comment>
# <i>modprobe -r nvidia</i>
<comment>(Lataa moduuli)</comment>
# <i>modprobe nvidia</i>
</pre>

</body>
</section>
<section>
<title>X:n asetukset</title>
<body>

<p>
GLX-rajapinta sisältää joukon asetuksia myös. Nämä säätävät TV-outia,
usean näytön tukea, näyttöjen virkistystaajuksia jne. Kaikki on kuvattu
ohjeissa.
</p>

<p>
Jos aiot muuttaa näitä asetuksia, ne kirjoitetaan Device-osioon X-asetuksia
(yleensä <c>/etc/X11/xorg.conf</c>). Logo poistetaan seuraavalla asetuksella:
</p>

<pre caption="NVidian X-asetuksia">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  Driver     "nvidia"
  <i>Option     "NoLogo" "true"</i>
  VideoRam   65536
EndSection
</pre>

</body>
</section>
</chapter>

</guide>

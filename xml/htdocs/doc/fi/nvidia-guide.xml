<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/fi/nvidia-guide.xml,v 1.16 2007/06/28 02:34:41 flammie Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/fi/nvidia-guide.xml" lang="fi">
<title>Gentoon Linuxin nVidia-opas</title>

<author title="Tekijä">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Toimittaja">
  <mail link="curtis119@gentoo.org">M Curtis Napier</mail>
</author>
<author title="Toimittaja">
  <mail link="nightmorph@gentoo.org">Joshua Saddler</mail>
</author>
<author title="Toimittaja">
  <mail link="wolf31o2@gentoo.org">Chris Gianelloni</mail>
</author>
<author title="Vastuullinen kääntäjä">
  <mail link="flammie@gentoo.org">Flammie Pirinen</mail>
</author>

<abstract>
Monilla Gentoon-käyttäjillä on nVidia-pohjaisia näyttökortteja. NVidialla on
omat tehokkaat Linux-ajurinsa. Tässä ohjeessa kerrotaan niiden asentamisesta
ja asetusten teosta.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.31</version>
<date>2007-04-15</date>

<chapter>
<title>Johdanto</title>
<section>
<body>

<p>
NVidian ajurit rakennetaan tiettyä ydintä varten. Niissä on binääriosio, joka
tekee raskaan työn ja näyttökortin kanssa kommunikoinnin. Ajurit koostuu
kahdesta osasta, ytimen moduulista ja X11-ajurista. Molemmat ovat samassa
paketissa. Johtuen tavasta jolla ajurit on pakattu, joitain valintoja pitää
tehdä ennen asennusta. Ajureita löytyy kahdesta paketista. Ensimmäinen,
<c>nvidia-drivers</c>, sisältää nVidian tuoreet ajurit tuoreimmille korteille.
Toinen, <c>nvidia-legacy-drivers</c>, sisältää ajurit vanhemmile korteille
suunnilleen TNT:stä GeForce 6800:aan. Tässä ajurissa ei kuitenkaan ole tukia
kaikille tuoreille ominaisuuksille. <c>Nvidia-legacy-drivers</c>-pakettia
kannattaa käyttää vain jos <c>nvidia-drivers</c> ei toimi.
</p>

<note>
Aiemmin Gentoossa oli erilliset paketit ydinmoduulille (<c>nvidia-kernel</c>) ja
GLX-kirjastoille (<c>nvidia-glx</c>). Nämä paketit on poistettu
Portage-puusta <c>nvidia-drivers</c>in ja <c>nvidia-legacy-drivers</c>in alta.
Jos käytät vanhoja paketteja, kannattaa siirtyä.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Ajurien sopivuus</title>
<section>
<title>Nvidia-legacy-drivers</title>
<body>

<p>
<c>Nvidia-legacy-drivers</c> sisältää ajurit vanhemmille nVidioille. Nämä
ajurit ova vanhempaa nVidia-ajuripohjaa, mutta tukevat tuoreimpia ytimiä ja
X.org-versioita. Näitä kannattaa käyttää jos käytössä oleva kortti on TNT-,
TNT2-, GeForce- tai Geforce 2 -sarjaa. Täysi yhteensopivuusluettelo on
liitteessä A sivulla
<uri>http://download.nvidia.com/XFree86/Linux-x86/1.0-7184/README/readme.txt</uri>.
</p>

</body>
</section>
<section>
<title>Nvidia-drivers</title>
<body>

<p>
<c>Nvidia-drivers</c> sisältää ominaisuuksia uudemmille nVidian korteille.
Uusimassa ajurissa ei ole tukia NV2x-piireille. Jos käytössä on GeForce 3- tai
GeForce 4 -sarjan kortti, pitää peittää
<c>>=x11-drivers/nvidia-drivers-1.0.9700</c> tiedostossa
<path>/etc/portage/package.mask</path>.  Tämä estää uudempia versioita
asentumasta. Täysi yhteensopivuusluettlo on sivulla
<uri>http://us.download.nvidia.com/XFree86/Linux-x86/1.0-9746/README/appendix-a.html</uri>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Korttien säätäminen</title>
<section>
<title>Ytimen asetukset</title>
<body>

<p>
Nvidian ajurit käyttävät nykyistä ydintä. Ajurit asentuvat moduuliksi, joten
ytimeen pitää asentaa moduulituki. Jos ydin on tehty komennolla
<c>genkernel all</c>, kaiken pitäisi olla kunnossa. Muutoin pitää
tarkistaa, että moduulit ovat käytössä:
</p>

<pre caption="Moduulituen lisäys">
Loadable module support ---&gt;
  [*] Enable loadable module support
</pre>

<p>
Myös <e>Memory Type Range Register</e> pitää olla päällä:
</p>

<pre caption="MTRR:n käyttö">
Processor and Features ---&gt;
  [*] MTRR (Memory Type Range Register) support
</pre>

<p>
Jos käyhtössä on AGP-kortti, voi käyttää <c>agpgart</c>-tukea ytimestä, joko
käännettynä tai moduulina. Jollet käytä ytimen agpgartia, ajureissa on
oma <c>NvAGP</c>-toteutus. Jotkin järjestelmät toimivat paremmin
ytimen agpgartilla, jotkin nVidian. Tämä kannattaa testata itse. Jollet
osaa päättää, käytä ytimen agpgartia:
</p>

<pre caption="Agpgartin käyttö">
Device Drivers ---&gt;
Character devices ---&gt;
&lt;*&gt; /dev/agpgart (AGP Support)
</pre>

<note>
AMD64:llä IOMMU määrää agpgartin.
</note>

</body>
</section>
<section>
<title>Arkkitehtuurikohtaiset</title>
<body>

<impo>
X86- ja AMd64-suorittimille saatava ytimen ajuri ei toimi yhdessä nVidian
binääriajurin kanssa. Näissä tapauksissa nVidia-tuet ytimestä pitää poistaa
seuraavasti:
</impo>

<pre caption="Ydin-ajurien poistaminen">
Device Drivers ---&gt;
Graphics Support ---&gt;
&lt; &gt;   nVidia Framebuffer Support
&lt; &gt;   nVidia Riva support
</pre>

<p>
Vaihtoehtoinen framebuffer on <c>VESA</c>:
</p>

<pre caption="Lisää VESA-tuki">
Device Drivers ---&gt;
Graphics Support ---&gt;
&lt;*&gt;   VESA VGA graphics support
</pre>

<p>
VESA driver type on nyt vastaavasti <c>vesafb</c> tai <c>vesafb-tng</c>.
Jos suoritin on AMD64, on parempi valita <c>vesafb</c> kuin <c>vesafb-tng</c>:
</p>

<pre caption="Framebufferin valinta">
(X) vesafb
( ) vesafb-tng
</pre>

<p>
Lisätietoja vesafb:hen löytää ohjeesta
<path>/usr/src/linux/Documentation/fb/vesafb.txt</path>.  Muita framebuffereita
löytyy hakemistosta <path>/usr/src/linux/Documentation/fb/</path>.
</p>

</body>
</section>
<section>
<title>Ydinasetusten jatkaminen</title>
<body>

<p>
<c>Nvidia-drivers</c> ja <c>nvidia-legacy-drivers</c>
tunnistavat ytimen hakemistosta <path>/usr/src/linux</path>. Varmista,
että se osoittaa oikeisiin lähteisiin ja ydinasetukset on tehty. Katso
lisätietoja kappaleesta ydinasetusten teko
<uri link="/doc/fi/handbook/">asennuskäsikirjassa</uri>.
</p>

<p>
Jos vaikkapa käytössä on gentoo-sources-2.6.11-r6, se näkyy
<path>/usr/src</path>-hakemistossa seuraavasti:
</p>

<pre caption="/usr/src/linux-linkki">
# <i>cd /usr/src</i>
# <i>ls -l</i>
<comment>(Tarkista)</comment>
lrwxrwxrwx   1 root root   22 Apr 23 18:33 linux -&gt; linux-2.6.11-gentoo-r6
drwxr-xr-x   4 root root  120 Apr  8 18:56 linux-2.4.26-gentoo-r4
drwxr-xr-x  18 root root  664 Dec 31 16:09 linux-2.6.10
drwxr-xr-x  18 root root  632 Mar  3 12:27 linux-2.6.11
drwxr-xr-x  19 root root 4096 Mar 16 22:00 linux-2.6.11-gentoo-r6
</pre>

<p>
Ylläolevasta näkee, että <c>linux</c> osoittaa ytimeen
<c>linux-2.6.11-gentoo-r6</c>.
</p>

<p>
Jos symlinkki on pielessä se pitää korjata:
</p>

<pre caption="/usr/src/linuxin luonti tai korjaus">
# <i>cd /usr/src</i>
# <i>ln -snf linux-2.6.11-gentoo-r6 linux</i>
</pre>

</body>
</section>
<section>
<title>Valinnainen: Tarkasta kortin tuettuus</title>
<body>

<note>
Valitettavasti jotkin kortit eivät toimi uusilla <c>nvidia-drivers</c>illa.
NVidian sivuilla on <uri link="http://www.nvidia.com/object/IO_18897.html">
luettelo tuetuista korteista</uri>. Lue se läpi ennen kuin asennat.
</note>

<p>
Tässä on osittainen lista tukemattomien korttien kauppanimistä:
</p>

<pre caption="Tukemattomat kortit">
TNT
TNT2
TNT2 Pro
TNT2 Ultra
TNT2 Model 64 (M64)
TNT2 Model 64 (M64) Pro
Vanta
Vanta LT
GeForce 256
GeForce DDR
GeForce2 GTS
GeForce2 Pro
GeForce2 Ti
GeForce2 Ultra
GeForce2 MX Integrated graphics
Quadro
Quadro2 Pro
Quadro2 EX
</pre>

<p>
Jos kortti on ylläolevalla listalla, pitää käyttää
<c>nvidia-legacy-drivers</c>ia 3D-tukeen.
</p>

</body>
</section>
<section>
<title>Sopivien ajurien asennus</title>
<body>

<p>
Seuraavaksi asennetaan ajureita.
</p>

<pre caption="NVidia-ajurin asennus">
<comment>(Jollei kortti ole vanha)</comment>
# <i>emerge nvidia-drivers</i>
<comment>(Jos kortti kuuluu vanhoihin tukemattomiin)</comment>
# <i>emerge nvidia-legacy-drivers</i>
</pre>

<impo>
Joka kerta kun <uri link="/doc/fi/kernel-upgrade.xml">ydin päivitetään</uri>
tai vanhaa uudelleenkäännetään pitää ajaa <c>emerge
nvidia-drivers</c> tai <c>emerge nvidia-legacy-drivers</c> nVidia-ajurien
uudelleenasentamiseksi.
</impo>

<p>
Kun asennus on valmis, <c>modprobe nvidia</c> lataa ajurin muistiin. Jos
kyseessä on päivitys, pitää vanha poistaa ensin.
</p>

<pre caption="Ydinmoduulin lataus muistiin">
# <i>lsmod | grep nvidia &amp;&amp; rmmod nvidia</i>
# <i>modprobe nvidia</i>
</pre>

<p>
Jotta moduulia ei tarvitsisi joka käynnistyksessä ladata, kannattanee lisätä
tiedostoon <path>/etc/modules.autoload.d/kernel-2.6</path> (tai
<path>kernel-2.4</path>, ytimestä riippyen) rivi <c>nvidia</c>. Perään
ajetaan <c>update-modules</c>.
</p>

<impo>
Jos <c>agpgart</c> on moduuli, pitää se lisätä tiedostoon
<path>/etc/modules.autoload.d/kernel-2.6</path> (tai <path>kernel-2.4</path>
ytimestä riippuen).
</impo>

<pre caption="Update-modulesin suorittaminen">
# <i>update-modules</i>
</pre>

</body>
</section>
<section>
<title>X:n asetukset</title>
<body>

<p>
Kun ajurit on asennettu, pitää säätää X:n asetuksiin <c>nvidia</c> ajuriksi
oletusarvoisen <c>nv</c>:n sijaan.
</p>

<p>
Avaa <path>/etc/X11/xorg.conf</path> suosikkimuokkaimellasi (kuten
<c>nano</c>lla tai <c>vim</c>illä) ja muokkaa <c>Device</c>-osion
<c>Driver</c>-asetusta:
</p>

<pre caption="Ajurin asettaminen nvidiaksi xorg.confissa">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  <i>Driver     "nvidia"</i>
  VideoRam   65536
EndSection
</pre>

<p>
Seuraavaksi siirry <c>Module</c>-osioon ja varmista että <c>glx</c> ladataan
mutta <c>dri</c> ei:
</p>

<pre caption="Module-osion päivittäminen">
Section "Module"
  <comment>(...)</comment>
  <i># Load  "dri"
  Load  "glx"</i>
  <comment>(...)</comment>
EndSection
</pre>

<p>
Osiossa <c>Screen</c> varmista, että <c>DefaultDepth</c> on 16 tai 24, tahi
että kaikissa <c>Display</c>-osioissa <c>Depth</c> on 16 tai 24.
Muutoin nVidian GLX ei toimi.
</p>

<pre caption="Screen-osion päivittely">
Section "Screen"
  <comment>(...)</comment>
  <i>DefaultDepth 16</i>
  Subsection "Display"
  <comment>(...)</comment>
EndSection
</pre>

<p>
Suorita <c>eselect</c>, jotta X tajuaa käyttää oikeita kirjastoja:
</p>

<pre caption="Eselectin ajo">
# <i>eselect opengl set nvidia</i>
</pre>

</body>
</section>
<section>
<title>Käyttäjien lisäys video-ryhmään</title>
<body>

<p>
Käyttäjät pitää lisätä <c>video</c>-ryhmään, jotta heillä olisi pääsy
nvidia-laitteisiin:
</p>

<pre caption="Käyttäjän lisäys video-ryhmään">
# <i>gpasswd -a käyttäjä video</i>
</pre>

<p>
Tämä ei ole täysin välttämätöntä jollei käytössä ole <c>udev</c>, mutteipä
haittaakaan ja varmistaa tulevien päivitysten sujuvuuden.
</p>

</body>
</section>
<section>
<title>Kortin testaus</title>
<body>

<p>
NVidian testaukseen voi käynnistää X:n ja suorittaa <c>glxinfo</c>, joka löytyy
paketista <c>mesa-progs</c>.  Tulosteeksi pitäisi tulla suunnilleen:
</p>

<pre caption="Direct renderingin tarkastelu">
$ <i>glxinfo | grep direct</i>
direct rendering: Yes
</pre>

<p>
FPS:istä viitettä antaa <c>glxgears</c>.
</p>

</body>
</section>
<section>
<title>NVidia-tuen käyttö</title>
<body>

<p>
Jotkin ohjelmat, kuten <c>mplayer</c> ja <c>xine-lib</c>, käyttävä USE-asetusta
nvidia, joka vaikuttaa XvMCNVIDIA-tukeen, jota tarvitaan korkearesoluutioisissa
videoissa. Lisää nvidia <path>/etc/make.conf</path>in USEen tai
pakettikohtaisesti <c>media-video/mplayer</c>ille ja
<c>media-libs/xine-lib</c>ille <path>/etc/portage/package.use</path>.
</p>

<p>
Seuraavaksi suoritetaan <c>emerge -uD --newuse world</c>, jotta ne ohjelmat,
joihin uudet USE-asetukset vaikuttavat asentuvat uudestaan.
</p>

</body>
</section>
<section>
<title>NVidia Settings Tool</title>
<body>

<p>
Versiosta 1.0.6106 nVidialla on ollut myös työkalu asetusten tekoon. Sillä voi
muuttaa grafiikka-asetuksia käynnistämättä X:ää uudestaan. Se löytyy
Portage-puusta nimeltä <c>media-video/nvidia-settings</c>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Ongelmatilanteet</title>
<section>
<title>2D ei toimi, jos muistia on yli 4 gigaa</title>
<body>

<p>
Jos nVidian 2D-tuki ei toimi, voi olla, että MTRR:n write-combining range
-asetus ei toimi. Sen näkee tiedostosta <path>/proc/mtrr</path>:
</p>

<pre caption="Write-combining asetuksen katselu">
# <i>cat /proc/mtrr</i>
</pre>

<p>
Joka rivillä pitäisi olla write-back tai write-combining. Jos siellä on
uncachable, pitää BIOS-asetuksia muuttaa.
</p>

<p>
Käynnistä kone uudelleen ja mene BIOSin asetuksiin. Sieltä MTRR löytynee
suunnilleen CPU-asetusten suunnalta. Asetuksen pitää olla discrete eikä
continuous, jotta 2D toimii ongelmitta.
</p>

</body>
</section>
<section>
<title>
  Moduullin lataus tuottaa tekstin "no such device"
</title>
<body>

<p>
Yleensä virhe johtuu siitä, ettei näyttökorttia ole. Kannattaa siis varmistaa,
että käytössä on nVidia-pohjainen laite (<c>lspci</c> auttaa).
</p>

<p>
Jos kyseessä on nVidia, BIOSista saattaa pitää muuttaa asetus <e>Assign IRQ to
VGA</e> päälle.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Erikoisasetukset</title>
<section>
<title>Ohjeita</title>
<body>

<p>
NVidian ajureissa on ohjeet mukana. Ne löytyvät hakemistosta
<path>/usr/share/doc</path> ja ne voi avata seuraavasti:
</p>

<pre caption="NVidian ohjeiden lukeminen">
<comment>(nvidia-drivers)</comment>
$ <i>less /usr/share/doc/nvidia-drivers-*/README.gz</i>
<comment>(nvidia-legacy-drivers)</comment>
$ <i>less /usr/share/doc/nvidia-legacy-drivers-*/README.gz</i>
</pre>

</body>
</section>
<section>
<title>Ydinmoduulin asetukset</title>
<body>

<p>
<c>Nvidia</c>-moduulissa on joitain muokattavia asetuksia. Useimmat löytyvät
ohjeista. Niitä lisätään tai poistetaan tiedostossa
<path>/etc/modules.d/nvidia</path>. Muista suorittaa <c>update-modules</c>
tiedoston muokkaamisen jälkeen. Uudet aseutkset eivät vaikuta ennen kuin
<c>nvidia</c>-moduuli on ladattu uudelleen.
</p>

<pre caption="NVidian asetusten muokkaus">
<comment>(Avaa tiedosto editoriin)</comment>
# <i>nano -w /etc/modules.d/nvidia</i>
<comment>(Päivitä moduulidata)</comment>
# <i>update-modules</i>
<comment>(Poista moduuli)</comment>
# <i>modprobe -r nvidia</i>
<comment>(Lataa moduuli taas)</comment>
# <i>modprobe nvidia</i>
</pre>

</body>
</section>
<section>
<title>X:n lisäasetuksia</title>
<body>

<p>
GLX-rajapinnallakin on paljon erikoisasetuksia. Niillä muokataan TV outtia,
kahden näytön asetuksia, virkistystaajuusasetuksia jne. Kaikki asetukset
löytyvät ohjeista.
</p>

<p>
Asetukset kirjoitetaan Device-osioon X:n asetustiedostoa
(yleensä <c>/etc/X11/xorg.conf</c>). Esimerkiksi jos poistetaan käynnistyskuva:
</p>

<pre caption="NVidian asetuksia X:n asetustiedostossa">
Section "Device"
  Identifier "nVidia Inc. GeForce2"
  Driver     "nvidia"
  <i>Option     "NoLogo" "true"</i>
  VideoRam   65536
EndSection
</pre>

</body>
</section>
</chapter>

</guide>

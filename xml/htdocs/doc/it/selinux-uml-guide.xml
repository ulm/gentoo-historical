<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/it/Attic/selinux-uml-guide.xml,v 1.2 2004/05/08 11:15:43 mush Exp $ -->

<guide link="/doc/it/selinux-uml-guide.xml" lang="it">
<title>Guida Gentoo alla configurazione di SELinux in un ambiente User-Mode</title>
<author title="Autore">
  <mail link="dimiduk.1@osu.edu">Nick Dimiduk</mail>
</author>
<author title="Autore">
  <mail link="mark.robinson@stdc.com">Mark Robinson</mail>
</author>
<author title="Redazione">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Traduzione">
  <mail link="emix@solira.org">Emilio Pavia</mail>
</author>

<abstract>
Questa guida mostra come configurare SELinux in un ambiente User-Mode Linux (UML).
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->
<license/>

<version>0.3</version>
<date>7 marzo 2004</date>

<chapter>
<title>Prima di iniziare</title>
<section>
<title>Argomenti della guida</title>
<body>

<p>
Lo scopo di questa guida è quello di fornire una serie di passaggi per
configurare l'installazione di un User-Mode Linux con il supporto a
SELinux. Fornisce istruzioni, riferimenti, consigli e avvertimenti
su possibili insidie, consentendo al lettore di avere un sistema SELinux
perfettamente funzionante in esecuzione all'interno di un User-Mode Linux.
</p>

</body>
</section>
<section>
<title>Argomenti non trattati</title>
<body>

<p>
Questa guida non sostituisce la documentazione fornita dai progetti
<uri link="http://user-mode-linux.sf.net">UML</uri> e <uri
link="http://www.nsa.gov/selinux/">SELinux</uri>. Si consiglia vivamente di
leggere la documentazione appropriata per acquisire una piena conoscenza su
ciò che i comandi forniti producono e sulle scelte da effettuare durante la
configurazioone dell'ambiente virtuale.
</p>

<p>
Questa guida <e>non</e> è un tutorial su come utilizzare o amministrare un sistema
basato su SELinux.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Preparazione di UML e SELinux</title>
<section>
<title>Informazioni su UML e SELinux</title>
<body>

<p>
Come descritto nel <uri link="http://user-mode-linux.sf.net">sito ufficiale</uri>,
User-Mode Linux (d'ora in avanti abbreviato con UML) permette di "eseguire
Linux dentro se stesso". Più precisamente, UML fornisce una macchina virtuale
sulla quale un utente può "testare software instabile, provare nuovi kernel o
nuove distribuzioni e curiosare all'interno di Linux, il tutto senza compromettere
la configurazione principale". Una configurazione del genere è perfetta per testare
e familiarizzare con SELinux. 
</p>

<p>
Il <uri link="http://www.gentoo.org/proj/en/hardened/selinux/index.xml">Gentoo
Hardened SELinux Subproject</uri> descrive SELinux come "a mandatory access
control system using type enforcement and role-based access controls".
</p>

</body>
</section>
<section>
<title>Compilazione del kernel</title>
<body>

<p>
Si cominci installando i sorgenti UML e configurando il kernel:
</p>

<pre caption="Installazione, configurazione e compilazione del kernel">
# <i>emerge sys-kernel/usermode-sources</i>
# <i>cd /usr/src/linux-</i><comment>&lt;version&gt;</comment><i>-uml</i>
# <i>make menuconfig ARCH=um</i>
# <i>make linux ARCH=um</i>
# <i>cp linux /usr/local/bin/linux</i>
</pre>

<warn>
Si presti molta attenzione all'opzione <e>ARCH=um</e> poichè è <e>estremamente</e>
importante.
</warn>

<p>
Durante la configurazione del kernel ci si assicuri di attivare le seguenti
opzioni:
</p>

<pre caption="Elenco delle opzioni">
<comment>(Sotto "Code maturity level options")</comment>
[*] Prompt for development and/or incomplete code/drivers

<comment>(Sotto "File Systems")</comment>
[*] Second extended fs support
[*]   Ext2 extended attributes
[ ]     Ext2 POSIX Access Control Lists
[*]     Ext2 Security Labels
<comment>(Se si utilizza ext3)</comment>
[*] Ext3 journalling file system support
[*]   Ext3 extended attributes
[ ]     Ext3 POSIX Access Control Lists
[*]     Ext3 Security Labels


<comment>(Sotto "File Systems --&gt; Pseudo filesystems")</comment>
[ ] /dev file system support (OBSOLETE)
[ ]   Automatically mount at boot
[*] /dev/pts file system for Unix98 PTYs
[*]   /dev/pts Extended Attributes
[*]     /dev/pts Security Labels
[*] Virtual memory file system support (former shm fs)

<comment>(Sotto "Security Options")</comment>
[*] Enable different security models
&lt;*&gt; Capabilities Support
[*] NSA SELinux Support
[*]   NSA SELinux Development Support
</pre>

<warn>ReiserFS e JFS non sono supportati da SELinux</warn>

<p>
Non occorre aggiungere altro.
</p>

</body>
</section>
<section>
<title>Programmi di utilità di UML</title>
<body>

<p>
Si proceda con l'installazione dei programmi di utilità di UML.
</p>

<pre caption="Installazione dei programmi di utilità di UML">
# <i>emerge sys-apps/usermode-utilities</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Creazione del root_fs</title>
<section>
<title>Creazione del chroot di Gentoo</title>
<body>

<p>
<path>root_fs</path> richiesto per UML, è un singolo file che contiene un intero
filesystem di Gentoo Linux. Per creare questo file è necessario che nel kernel 
non-UML sia attiva l'opzione "Loopback device support"
</p>

<p>
La creazione del file <path>root_fs</path> rappresenta l'ultimo passaggio.
Prima di tutto si crei un filesystem di Gentoo in un normale chroot. Si scarichi
(o si estragga) il tarball di uno stage e si cominci l'installazione di Gentoo
allo stesso modo di un sistema normale.
</p>

<p>
Ci sono alcune particolarità da tenere in considerazione:
</p>

<ul>
  <li>
    Si possono tranquillamente ignorare i warning sul mancato caricamento
    del modulo di SELinux; i warning dovrebbero scomparire una volta utilizzato
    il kernel di SELinux
  </li>
  <li>
    Si deve modificare il file <path>/etc/make.profile/packages</path> e rimuovere
    il "*" davanti alla riga <c>virtual/bootloader</c> se presente
  </li>
  <li>
    Fra tutti i logger di sistema disponibili, solamente <c>syslog-ng</c> e
    <c>metalogd</c> sono stati sufficientemente testati con SELinux
  </li>
  <li>
    L'unico demone cron che sembra funzionare con SELinux è <c>vixie-cron</c>
  </li>
</ul>

<p>
Quando si modifica il file <path>/etc/fstab</path> è necessario operare un paio
di modifiche:
</p>

<ul>
  <li><path>/dev/ROOT</path> si deve cambiare in <path>/dev/ubd/0</path></li>
  <li><path>/dev/ubd/0</path> deve avere le opzioni <c>acl,user_xattr</c></li>
  <li><path>/dev/ubd/0</path> deve avere un filesystem di tipo ext2 o ext3</li>
  <li><path>/dev/SWAP</path> si deve cambiare in <path>/dev/ubd/1</path></li>
  <li>Commentare (o rimuovere) <path>/dev/BOOT</path></li>
</ul>

<p>
Aggiungere inoltre le due righe seguenti:
</p>

<pre caption="Aggiunta al file /etc/fstab">
none    /dev/pts    devpts       gid=5,mode=620    0    0
none    /selinux    selinuxfs    defaults          0    0
</pre>

<p>
Si può procedere alla creazione dei dispositivi elencati nel file <path>fstab</path>:
</p>

<pre caption="Creazione dei dispositivi a blocchi di UML">
# <i>for i in `seq 0 7`; do mknod /dev/ubd$i b 98 $(($i*16)); done</i>
</pre>

<p>
Si creino ora le policy di SELinux:
</p>

<pre caption="Creazione delle policy di SELinux">
# <i>cd /etc/security/selinux/src/policy/</i>
# <i>make install</i>
</pre>

<p>
Adesso si può completare l'installazione e procedere con la creazione del file 
<path>root_fs</path>.
</p>

</body>
</section>
<section>
<title>Creazione di root_fs</title>
<body>

<p>
Controllando le dimensioni dell'ambiente chroot ci si accorge che esso occupa
dai 600MB a 1.2GB (dipendentemente dallo stage utilizzato). A causa di queste notevoli
dimensioni occorre creare un'immagine che sia abbastanza capiente -- si può iniziare 
con 1.5GB.
</p>

<pre caption="Creazione del file root_fs">
# <i>cd /mnt/gentoo</i>
# <i>tar cvjpf ~/root_fs.tbz2 *</i>
# <i>cd</i>
# <i>dd if=/dev/zero of=root_fs seek=1500 count=1 bs=1M</i>
# <i>mke2fs -F root_fs</i>
# <i>mount -o loop root_fs /mnt/loop/</i>
# <i>tar xvjpf root_fs.tbz2 -C /mnt/loop</i>
# <i>umount /mnt/loop</i>
</pre>

<p>
Si crei inoltre un file di swap da 500MB.
</p>

<pre caption="Creazione del file di swap">
# <i>dd if=/dev/zero of=swap_fs seek=500 count=1 bs=1M</i>
# <i>mkswap -f swap_fs</i>
</pre>

<p>
Verificare adesso il corretto funzionamento:
</p>

<pre caption="Avvio dell'ambiente Gentoo">
# linux gentoo=nodevfs con0=fd:0,fd:1 con1=xterm con2=xterm con=null ubd0=root_fs ubd1=swap_fs
</pre>

<note>
UML utilizza xterm per le console virtuali che vengono eseguite alla partenza,
perciò è necessario assicurarsi che il terminale dal quale si esegue UML abbia
la variabile $DISPLAY correttamente impostata (con i permessi di xhost/xauth
appropriati).
</note>

<p>
Gli unici errori che potrebbero apparire sono i messaggi <e>Couldn't get a file descriptor
referring to the console</e> generati da <c>setfont</c> e <c>keymaps</c>. Questi errori
sono innocui, ma se si desidera eliminarli si eseguano i seguenti comandi:
</p>

<pre caption="Rimozione degli errori">
# <i>rc-update del keymaps</i>
# <i>rc-update del consolefont</i>
</pre>

<p>
A questo punto l'ultima cosa da fare è etichettare filesystem.
</p>

<pre caption="Impostazione dell'etichetta">
<comment>(Dall'interno dell'ambiente Gentoo SELinux)</comment>
# <i>cd /etc/security/selinux/src/policy</i>
# <i>make relabel</i>
# <i>reboot</i>
</pre>

<p>
La configurazione e terminata.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Risorse</title>
<section>
<title>UML</title>
<body>

<ul>
  <li>
    <uri link="http://edeca.net/articles/bridging/index.html">Bridging with 
    UML</uri>
  </li>
  <li>
    <uri link="http://user-mode-linux.sourceforge.net/">Home Page di UML</uri>
  </li>
  <li>
    <uri link="http://www.theshore.net/~caker/uml/">Appunti di Caker su UML</uri>
  </li>
  <li>
    <uri link="http://sourceforge.net/mailarchive/forum.php?forum_id=3647">Archivi della
    mailinglist su UML</uri>
  </li>
</ul>

</body>
</section>
<section>
<title>SELinux</title>
<body>

<ul>
  <li><uri link="http://www.nsa.gov/selinux/">Home Page di SELinux</uri></li>
  <li><uri link="http://www.gentoo.org/proj/en/hardened/selinux/selinux-quickstart.xml">Gentoo Hardened SELinux Quickstart Guide</uri></li>
  <li><uri link="http://web.verbum.org/selinux/uml/">SELinux and UML</uri></li>
  <li>
    <uri link="http://marc.theaimsgroup.com/?l=selinux">Archivi della mailinglist di SELinux</uri>
  </li>
</ul>

</body>
</section>
</chapter>

</guide>

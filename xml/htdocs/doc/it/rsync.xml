<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/it/rsync.xml,v 1.13 2005/12/19 22:47:51 so Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/it/rsync.xml" lang="it">
<title>Politica dei mirror rsync di Gentoo Linux</title>
<author title="Autore">
  <mail link="mirror-admin@gentoo.org">Amministratori dei mirror di Gentoo</mail>
</author>
<author title="Redattore">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Traduttore">
  <mail link="subbia@gmail.com">Dario Cavallaro</mail>
</author>

<abstract>
Questo documento vi spiega come creare un mirror ufficiale usando rsync e il
vostro mirror locale.
</abstract>

<license/>

<version>1.13</version>
<date>2005-12-12</date>

<chapter>
<title>Richieste Hardware</title>
<section>
<title>Donazioni di macchine</title>
<body>

<p>
Gentoo Linux ha due differenti tipi di mirror: mirror principali di
rotazione e mirror della comunità. I mirror principali di rotazione sono
server dedicati a rsync e sono responsabili della cura dell'enorme
quantità del nostro traffico rsync. Tutti i mirror principali di
rotazione eseguono Gentoo Linux e sono controllati dai membri del team
di sviluppo di Gentoo. I mirror della comunità sono server forniti e
controllati dai membri della comunità. Questi server possono o meno
essere dedicati all'uso di rsync e possono o meno eseguire Gentoo Linux.
</p>

<p>
Attualmente abbiamo abbastanza mirror della comunità, mentre stiamo
cercando ulteriori mirror principali di rotazione. Le specifiche per i
mirror principali di rotazione includono:
</p>

<ul>
  <li>Minimo un processore Pentium 4 2GHz (o equivalente)</li>
  <li>Minimo 1GB di RAM (1.5GB - 2GB sarebbe l'ideale)</li>
  <li>10GB di spazio su disco (IDE va bene)</li>
</ul>

<p>
Questi server possono essere donati con la propria larghezza di banda e nella
propria collocazione, se li avete. Altrimenti, possiamo fornire questi
servizi e voi potete mandare la macchina nella nostra collocazione. Il
consumo medio della larghezza di banda per un mirror principale di rotazione
è di circa 7Mbps (pressapoco 2 TB al mese). Questo numero dovrebbe diminuire
in rapporto all'aumentare dei mirror ufficiali.
</p>

<p>
Se desiderate donare la vostra macchina, mandate un'e-mail con tutte le
informazioni a <mail link="jforman@gentoo.org">Jeffrey Forman</mail>.
</p>

</body>
</section>
</chapter>
<!--
<chapter>
<title>Richieste minime</title>
<section>
<title>Minimo di banda disponibile</title>
<body>

<p>
Per poter offrire un servizio decente servono almeno 5mbps sia in upload che in download.
</p>

</body>
</section>
<section>
<title>Minimo di utenti in contemporanea</title>
<body>

<p>
Noi chiediamo che siano supportati almeno 15 utenti collegati contemporaneamente.
</p>

</body>
</section>
<section>
<title>Minimo di hardware</title>
<body>

<p>
Per poter offrire servizi per almeno 15 utenti collegati contemporaneamente in maniera decente chiediamo le seguenti 
caratteristiche minime:
</p>

<ul>
  <li>PIII 500 Processor</li>
  <li>256MB RAM</li>
</ul>

</body>
</section>
<section>
<title>Minimo di frequenza di aggiornamento</title>
<body>

<p>
Gli aggiornamenti devono avvenire a :00 e :30 di ogni ora, 24 ore al giorno. È <e>molto</e> importante che questa pianificazione sia seguita alla lettera, visto che il nostro DNS segue uno stile tipo round robin per selezionare i mirror 
per gli utenti.
</p>

</body>
</section>
<section>
<title>MOTD (/etc/rsync/rsyncd.motd)</title>
<body>

<p>
Vi prego di aggiungere le seguenti informazioni nel vostro file MOTD di rsync:
</p>

<ul>
<li>nome del server</li>
<li>indirizzo IP del server</li>
<li>specifiche tecniche del server (CPU e RAM)</li>
<li>banda disponibile per il server</li>
<li>limiti di utenti connessi contemporaneamente, se esistono</li>
<li>localizzazione del server (città e stato)</li>
<li>un nome ed un'indirizzo email per contattare l'amministratore</li>
</ul>

<p>
Con queste informazioni nel MOTD file riusciremmo ad indentificare con facilità il vostro mirror in caso di problemi.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Dettagli di implementazione</title>
<section>
<body>

<p>
Per configurare un nuovo server, dovreste seguire le seguenti procedure:
</p>

<ul>
<li>
  Configurate il vostro mirror in modo tale che si sincronizzi con uno pubblico già esistente. Non ha importanza con 
  quale. Assicuratevi che anche il vostro mirror rispetti la politica della pianificazione della 
  <e>frequenza di aggiornamenti</e> spiegata sopra.
</li>
<li>
  Segnalate un bug su <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> che conterrà: il nome della vostra 
  organizzazione, il nome del server, l'indirzzo ip, le informazioni di contatto e il fatto che voi vorreste attivare un 
  nuovo mirror con rsync. Verificheremo che il vostro server si sincronizzi correttamente. È importante che il vostro 
  server si sincronizzi due volte all'ora, con una finestra temporale di dieci minuti fra :00 e :10 e l'altra fra :30 e 
  :40. Potrete scieglere qualsiasi orario in queste finestre da dieci minuti l'ora, per pianificare la vostra 
  sincronizzazione. 
</li>
<li>
  Dopo che avremo verificato che il vostro mirror si sincronizza correttamente, aggiungeremo l'indirizzo IP del server 
  alla lista presente su rsync1.us.gentoo.org. 
</li>
<li>
  Aggiornate la vostra operazione pianificata con rsync in modo tale che punti ad <path>rsync1.us.gentoo.org</path>. 
  Monitoreremo il vostro server per 48-72 ore circa dopo la segnalazione, per assicurarci che il vostro server si 
  sincronizzi correttamente. 
</li>
</ul>

<p>
Se tutti i passaggi saranno avvenuti senza problemi, provvederemo a creare un campo DNS del tipo 
<path>rsync[numero].[codicenazione].gentoo.org</path> e aggiungeremo il vostro mirror al nostro round-robin DNS con 
valori del tipo rsync.[codicecontinente].gentoo.org e rsync.[codiceregione].gentoo.org. Poco dopo che il vostro mirror sarà 
aggiunto ai nostri server DNS potrete iniziare a vedere il traffico di rsync. 
</p>

<p>
In più l'inidirzzo email dell'amministratore del server sarà aggiunto alla nostra mailing-list (causa poco traffico) in 
modo tale che possa seguire tutte le evoluzioni riguardanti i mirror con rsync. 
</p>

<note>
Grazie per il supporto dato agli utenti ed agli sviluppatori di Gentoo Linux! :) Per qualsiasi problema o dubbio 
sull'amministrazione di rsync, visitate la pagina <uri link="http://bugs.gentoo.org">http://bugs.gentoo.org</uri> e 
segnalate un bug con oggetto "Rsync".
</note>

</body>
</section>
</chapter>

<chapter>
<title>Task Paralleli</title>
<section>
<body>

<p>
Avremo presto una pagina creata da rrdtool che conterrà semplicemente dei link a dei grafici (ordinati per continente, 
poi stato, poi server) della disponibilità dei mirror rsync ufficiali (questi grafici verranno creati dall'output di 
sping). Controlleremo questi grafici almeno una volta al giorno,  e ogni server irragiungibile sarà eliminato dallo schema 
RR DNS fino a quando i problemi non saranno risolti. Abbiamo script che ogni 30 minuti controllano se effettivamente ogni 
mirror si sincronizza correttamente con noi.
</p>

<warn>
Se un mirror ha continuamente problemi e se dopo che l'amministratore è stato contattato e la situazione non migliora, 
allora il mirror sarà definitivamente cancellato dalle schema RR.
</warn>

</body>
</section>
</chapter>
-->
<chapter>
<title>Brevi FAQ (fornita come risorsa per gli attuali amministratori dei mirror)</title>
<section>
<title>Q: Chi dovrei contattare per problemi e la manutenzione di rsync?</title>
<body>

<p>
A: Visitate la pagina http://bugs.gentoo.org e segnalate un bug con soggetto
"Rsync".
</p>

</body>
</section>
<section>
<title>Q: Mantengo un mirror rsync privato per la mia ditta. Posso accedere a
rsync1.us.gentoo.org comunque?</title>
<body>

<p>
A: Visto che le nostre risorse sono limitate, dobbiamo assicurare di usarle
in maniera tale da offrire il massimo beneficio ai nostri utenti.  Così,
limitiamo le connessioni nel nostro master rsync e distfile mirror solo a
mirror pubblici. Gli utenti sono benvenuti a usare il nostro sistema di
mirror normale per stabilire un mirror rsync privato, anche se gli viene
richiesto di seguire certe linee guida <uri
link="http://www.gentoo.org/news/en/gwn/20030505-newsletter.xml#doc_chap1_sect3">
base per rsync</uri>.
</p>

</body>
</section>
<section>
<title>Q: E' importante che sincronizzo il mio mirror due volte in un'ora?</title>
<body>

<p>
A: Sì è importante. Non dovete effettuare le sincronizzazioni esattamente a
:00 e a :30, ma dovrebbero avvenire fra le due finestre seguenti:
</p>

<ol>
	<li>da :00 a :10</li>
	<li>da :30 a :40</li>
</ol>

<p>
Assicuratevi ulteriormente che le vostre sincronizzazioni siano fatte
ogni 30 minuti. Così, se programmate la prima sincronizzazione di ogni
ora a :08, programmate la seconda a :38.
</p>

</body>
</section>

<section>
<title>Q: Con quali mirror dovrei sincronizzare il mio mirror di rsync prima
di diventare un mirror Gentoo ufficiale?</title>
<body>

<ul>
  <li>Se il mirror si trova in europa sincronizzatevi con rsync.de.gentoo.org</li>
  <li>Se il mirror si trova in America sincronizzatevi con rsync.us.gentoo.org</li>
  <li>Se il mirror non si trova nelle prime due zone sincronizzatevi con rsync.us.gentoo.org</li>
</ul>

</body>
</section>
<section>
<title>Q: Come trovo il mirror più vicino a me?</title>
<body>

<p>
A: <c>netselect</c> è stato designato per fare questo per voi. Se non avete
ancora eseguito <c>emerge netselect</c> allora fatelo ora. Poi eseguite il
comando: <c>netselect rsync.gentoo.org</c>. Dopo più o meno un minuto
netselect vi comunicherà un indirizzo IP. Copiate questo indirizzo e usatelo
come unico parametro per rsync seguito da due doppi punti.  Ad esempio:
<c>rsync 1.2.3.4::</c>. Dovreste poter capire di quale mirror si tratta dal
messaggio di benvenuto. Aggiornate il vostro <path>/etc/make.conf</path> con
i suoi dati. 
</p>

</body>
</section>
<section>
<title>Q: Posso usare la compressione nella sincronizzazione con
rsync1.gentoo.org?</title>
<body>

<p>
A: No. La compressione utilizza troppe risorse sul server, così l'abbiamo
disabilitata brutalmente su <path>rsync1.us.gentoo.org</path>. Vi preghiamo
di <e>non</e> tentare di usare la compressione nel sincronizzarvi a quel
server.
</p>

</body>
</section>
<section>
<title>Q: Ci sono parecchi processi di rsync vecchi e probabilmente morti,
come posso eliminarli?</title>
<body>

<p>
A: Vedete la sezione Script di Esempio.
</p>

</body>
</section>
<section>
<title>Q:  Ci sono molti utenti che si connettono al mio server rsync troppo
frequentemente, a volte causando un DoS al mio mirror, c'è un modo per
impedirlo?</title>
<body>

<p>
A: Di nuovo, vedete la sezione Script di Esempio.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Script di Esempio</title>
<section>
<body>

<note>
Troverete file di esempio di configurazione e di script nel
pacchetto gentoo-rsync-mirror. Eseguite <c>emerge gentoo-rsync-mirror</c>.
</note>

<p>
Attualmente, avere un mirror del nostro Portage tree richiede circa 250Mb,
quindi non consuma molto spazio; avendo almeno 500Mb disponibili dovrebbe
permettere future espansioni. Impostare un mirror del Portage tree è semplice
-- prima, assicuratevi che sul vostro mirror è installato rsync. Quindi,
impostate il vostro file <path>rsyncd.conf</path> in maniera simile alla
seguente:
</p>

<pre caption="rsyncd.conf">
uid = nobody
gid = nobody
use chroot = yes
max connections = 15
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
log file = /var/log/rsync.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#questa voce è per la compatibilità
path = /gentoo/rsync
comment = Gentoo Linux Portage tree

[gentoo-portage]
#le versioni più aggiornate di portage usano queste opzioni
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>

<p>
Sopra, il mirror gentoo-x86-portage punta sugli stessi dati di
gentoo-portage. Nonostante abbiamo recentemente cambiato il nome ufficiale
del nostro mirror a gentoo-portage, gentoo-x86-portage serve ancora per
ragioni di compatibilità, quindi includete entrambi i campi.
</p>

<p>
Per motivi di sicurezza, è richiesto l'uso di un ambiente chrooted!
</p>

<p>
Adesso bisogna copiare l'intero albero di Portage da un mirror Gentoo Linux.
Usate lo script seguente:
</p>

<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=300"
#Togliete il commento da queste righe se e solo se avete accesso autenticato ad rsync1.us.gentoo.org
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#Se state aspettando la conferma per l'accesso ad uno dei nostri mirror ufficiali, selezionate uno di questi mirror da: SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>

<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2004 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# &#36;Header: /var/cvsroot/gentoo-x86/net-misc/rsync/files/rsyncd.init.d,v 1.2 2004/05/02 22:45:02 mholzer Exp &#36;

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --timeout=300"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>

<p>
Il vostro <path>rsyncd.motd</path> dovrà contenere il vostro indirizzo IP ed
altre informazioni rilevanti, come le informazioni sull'host ed almeno un
contatto amministrativo. Dopo l'approvazione come mirror rsync ufficiale, al
vostro host sarà assegnato un alias nella forma: <path>rsync[num].[codice
stato].gentoo.org</path>
</p>

<p>
Questo comando vi aiuterà a eliminare vecchi processi di rsync, che a volte
si trovano perchè causati da problemi di connessione. E' importante
eliminarli poichè contano come connessioni valide nell'opzione 'connessioni
massime'. Potete eseguire questo comando ogni ora con crontab, che cercherà
ed eliminerà i processi di rsync più vecchi di un'ora. 
</p>

<pre caption="Eliminare i vecchi processi di rsync">
/bin/kill -9 `/bin/ps --no-headers -Crsync -o etime,user,pid,command|/bin/grep nobody | \
             /bin/grep "[0-9]\{2\}:[0-9]\{2\}:" |/bin/awk '{print $3}'` 
</pre>

<p>
In alcuni casi, ci sono utenti che abusano del sistema mirror rsync,
sincronizzando più di 2 volte al giorno. Nei casi più estremi, certi utenti
programmano cron per far sincronizzare ogni 15 minuti. Ciò porta ad un
attacco di tipo Denial of Service, occupando continuamente uno slot di
sincronizzazione che potrebbe essere usato da un altro utente. Per cercare di
impedire questi attacchi, potete usare il seguente <uri
link="/proj/en/infrastructure/mirrors/rsyncd.conf_pl.txt">script perl</uri>,
che esplorerà i vostri log file rsync, selezionerà gli indirizzi IP che sono
stati connessi quel giorno per più di <c>N</c> volte, e creerà un file
<path>rsyncd.conf</path> includendo gli indirizzi IP degli 'host bloccati'.
La riga seguente controlla a quanto è uguale <c>N</c>:
</p>

<pre caption="Definire il massimo numero di connessioni per IP">
@badhosts=grep {$hash{$_}>4} keys %hash;
</pre>

<p>
Se usate questo script, ricordatevi di ruotare giornalmente i vostri log file
rsync, e modificare lo script per abbinare la posizione del vostro file
<path>rsyncd.conf</path>. Questo script è testato su Gentoo Linux, ma
dovrebbe funzionare su altre architetture che supportano sia rsync che perl.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Impostare un vostro mirror rsync locale</title>
<section>
<title>Introduzione</title>
<body>

<p>
Molti utenti eseguono Gentoo su parecchie macchine e necessitano di eseguire
<c>emerge --sync</c> su tutte. Usare i mirror pubblici è semplicemente una
perdita di larghezza di banda. Sincronizzare solo una macchina su un mirror
pubblico e tutte le altre su quella, conserverebbe risorse sui mirror di
Gentoo e conserverebbe la larghezza di banda degli utenti.
</p>

<p>
Tutto quello che dovete fare è scegliere quale tra le vostre macchine sarà il
vostro mirror sync locale, e impostarla.  Dovete scegliere un computer che
possa gestire il carico della CPU e del disco che richiede un'operazione di
rsync.  Inoltre il vostro mirror locale deve essere disponibile quando uno
dei vostri computer sincronizzi il portage tree.  Dovrebbe avere un indirizzo
IP statico o un nome che in un modo o nell'altro porti al vostro server.
Configurare un DHCP e/o un server DNS va oltre lo scopo di questa guida.
</p>

</body>
</section>
<section>
<title>Impostare il server</title>
<body>

<p>
Non c'è nessun pacchetto extra da installare poichè il software richiesto è
già presente sul vostro computer. Impostare il vostro mirror rsync locale è
un aspetto della configurazione del demone di <e>rsyncd</e> per rendere
disponibile alla sincronizzazione la vostra directory
<path>/usr/portage</path>. Create il seguente file di configurazione
<path>/etc/rsyncd.conf</path>: 
</p>

<pre caption="Esempio di /etc/rsyncd.conf">
pid file = /var/run/rsyncd.pid
max connections = 5
use chroot = yes
uid = nobody
gid = nobody
<comment># Opzionale: limitare l'accesso alle vostre macchine Gentoo</comment>
hosts allow = 192.168.0.1 192.168.0.2 192.168.1.0/24
hosts deny  = *

[gentoo-portage]
path=/usr/portage
comment=Gentoo Portage
exclude=distfiles/ packages/
</pre>

<p>
Non dovete utilizzare le opzioni <c>hosts allow</c> e <c>hosts deny</c>. Di
default, tutti i client dovrebbero potersi a connettere. L'ordine con cui
scrivete queste opzioni non è rilevante. Il server controllerà sempre
l'opzione <c>hosts allow</c>, e darà la connessione se l'host è uno di quelli
elencati. Poi il server controllerà l'opzione <c>hosts deny</c>, e rifiuterà
la connessione se non ha trovato nessun host. A nessun host che rappresenti
qualcosa verrà data la connessione. Per ulteriori informazioni leggere la
pagina del manuale (<c>man rsyncd.conf</c>).
</p>

<p>
Ora, fate partire il vostro demone rsync con il seguente comando da root:
</p>

<pre caption="Fare partire il demone rsync">
<comment>(Ora parte il demone)</comment>
# <i>/etc/init.d/rsyncd start</i>
<comment>(Aggiungere il demone al vostro runlevel di default)</comment>
# <i>rc-update add rsyncd default</i>
</pre>

<p>
Provate il vostro mirror rsync. Non dovete necessariamente provare da
un'altra macchina, ma sarebbe una buona idea. Se il vostro server non è
conosciuto con un nome da tutti gli altri vostri computer, potete usare il
suo indirizzo IP.
</p>

<pre caption="Provare il vostro mirror">
<comment>(Potete usare il nome del server o il suo IP)</comment>
# <i>rsync 192.168.0.1::</i>
gentoo-portage     Gentoo Portage
# <i>rsync your_server_name::gentoo-portage</i>
<comment>(Dovreste vedere il contenuto di /usr/portage sul vostro mirror))</comment>
</pre>

<p>
Il vostro mirror sync è impostato. Eseguite <c>emerge --sync</c> come avete
fatto finora per aggiornare il vostro server.
</p>

<note>
Notate che la maggior parte degli amministratori di un mirror pubblico
considera come abuso la sincronizzazione fatta più di una o due volte al
giorno.
</note>

</body>
</section>
<section>
<title>Configurare i vostri client</title>
<body>

<p>
Ora, fate usare agli altri vostri computer il vostro mirror rsync locale
invece di uno pubblico. Modificate il vostro <path>/etc/make.conf</path> e
fate si che la variabile <c>SYNC</c> punti al vostro server.
</p>

<pre caption="Definire SYNC in /etc/make.conf">
<comment>(Usate l'indirizzo IP del vostro server)</comment>
SYNC="rsync://<i>192.168.0.1</i>/gentoo-portage"
<comment>(Oppure usate il nome del vostro server)</comment>
SYNC="rsync://<i>nome_del_vostro_server</i>/gentoo-portage"
</pre>

<p>
Potete controllare che il vostro computer è stato impostato correttamente e
sincronizzato verso il vostro mirror rsync locale:
</p>

<pre caption="Controllare e sincronizzare">
<comment>(Controllate che la variabile SYNC sia stata impostata)</comment>
# <i>emerge --info|grep SYNC</i>
SYNC="rsync://nome_del_vostro_server/gentoo-portage"
<comment>(Sincronizzate verso il vostro mirror locale)</comment>
# <i>emerge --sync</i>
</pre>

<p>
Questo è tutto! Tutti i vostri computer useranno il vostro mirror rsync
locale ogni volta che eseguiranno <c>emerge --sync</c>.
</p>

</body>
</section>
</chapter>
</guide>

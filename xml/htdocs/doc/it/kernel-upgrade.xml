<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/it/kernel-upgrade.xml,v 1.4 2006/02/18 13:53:01 mascherpa Exp $ -->

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<guide link="/doc/it/kernel-upgrade.xml" lang="it">
<title>Upgrade del kernel Gentoo Linux</title>
<author title="Autore">
	<mail link="dsd@gentoo.org">Daniel Drake</mail>
</author>

<author title="Traduzione">
	<mail link="grandezot@cheapnet.it">Raffaele Camarda</mail>
</author>
<author title="Traduzione">
  <mail link="cristiano.chiucchiolo@gmail.com">Cristiano Chiucchiolo</mail>
</author>

<abstract>
Questo documento descrive i passaggi da seguire per aggiornare il kernel da una
release ad un'altra.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>0.2</version>
<date>2006-01-06</date>

<chapter>
<title>Introduzione</title>
<section>
<body>

<p>
Il kernel è uno dei pochi pacchetti in portage che richiede un intervento
manuale da parte dell'utente per completare un upgrade. Portage può scaricare
ed installare il nuovo kernel autonomamente, ma dall'utente stesso ne
dipendono la configurazione e la compilazione.
</p>

<p>
Nonostante la guida sia scritta per gli utenti che intendono aggiornare il
proprio kernel da una release ad un'altra, può comunque essere utile a tutti
gli utenti che che passano da un particolare pacchetto del kernel ad un altro.
</p>

<p>
Il kernel utilizzato come esempio in questa guida è il <c>gentoo-sources</c>,
in ogni caso le istruzioni che si applicano a questa versione del kernel Gentoo
possono essere applicate anche ad altri flavour dei sorgenti presenti in
portage.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Perché aggiornare il kernel?</title>
<section>
<body>

<p>
Genericamente, l'aggiornamento del kernel da una release ad un'altra non porta
nessun evidente cambiamento. Nonostante cio' ci sono diverse ragioni per
aggiornare il kernel: una può essere quella di beneficiare dei vantaggi di una
nuova feature o di un nuovo driver; un'altra può essere quella di correggere
un'eventuale problema di sicurezza, oppure semplicemente quella di mantenere il
sistema up-to-date.
</p>

<p>
Anche se si decidesse di non upgradare ad ogni revisione del kernel è comunque
consigliato che questo venga aggiornato periodicamente. Inoltre è fortemente
raccomandato che si aggiorni il kernel se questo porta alla risoluzione di
eventuali problemi di sicurezza.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Ottenere i sorgenti aggiornati tramite portage</title>
<section>
<body>

<p>
Il kernel si aggiorna esattamente come si aggiornerebbe un qualunque altro
pacchetto - utilizzando <c>emerge</c>. Normalmente quindi si può decidere di
aggiornare il kernel quanto update world ne notifica un aggiornamento.
Ad Esempio:
</p>

<pre caption="I sorgenti di un nuovo kernel segnalati da un update world">
# <i>emerge -Dup world</i>
Calculating dependencies ...done!
[ebuild    NS ] sys-kernel/gentoo-sources-2.6.9-r2 [2.6.8-r5]
</pre>

<note>
La presenza della sigla "NS" nell'output appena sopra indica che il kernel
sarà installato in un nuovo slot, quindi i sorgenti del vostro vecchio kernel
non saranno toccati sino a che non deciderete di cancellarli manualmente.
</note>

<p>
A questo punto si può andare avanti ed installare l'update, e.g.:
</p>

<pre caption="Aggiornare i sorgenti del kernel">
# <i>emerge -u gentoo-sources</i>
</pre>

<p>
I sorgenti del kernel saranno quindi installati in una subdirectory in
<path>/usr/src</path>. Nel caso che stiamo prendendo in considerazione saranno
installati in <path>/usr/src/linux-2.6.9-gentoo-r2</path>
</p>

</body>
</section>
</chapter>

<chapter>
<title>Aggiornare il link simbolico /usr/src/linux</title>
<section>
<body>

<p>
Gentoo necessita che il link simbolico <path>/usr/src/linux</path> punti ai
sorgenti del kernel che si sta utilizzando sulla macchina.
</p>

<p>
Portage può aggiornare anche il link simbolico automaticamente quando si
effettua l'update dei sorgenti. Tutto ciò che si deve fare è aggiungere la
flag <c>symlink</c> alle variabili USE nel vostro <path>/etc/make.conf</path>.
</p>

<pre caption="Esempio delle variabili USE in /etc/make.conf">
<comment>(Aggiungere la parola symlink alle USE)</comment>
USE="<i>symlink</i> x86 3dnow 3dnowex X aac aalib adns alsa apache2"
</pre>

<p>
Se, invece di appoggiarvi ad emerge, preferite fare tutto da voi il prossimo
esempio vi mostra come:
</p>

<pre caption="Aggiornare il link simbolico /usr/src/linux manualmente">
# <i>cd /usr/src</i>
# <i>ln -sfn linux-2.6.9-gentoo-r2 linux</i>
</pre>

</body>
</section>
</chapter>

<chapter id="install">
<title>Configurare, compilare ed installare il nuovo kernel</title>
<section>
<body>

<p>
Per ognuna di queste operazioni dovreste fare riferimento alla guida presente
nel <uri link="/doc/it/handbook/index.xml">Manuale Gentoo</uri>, in particolare
alle sezioni <e>Configurare il kernel</e> e <e>Configurare il Bootloader</e>.
Qui sotto eccovi una serie di hightlight delle operazioni necessarie:
</p>

</body>
</section>
<section>
<title>Opzione 1: configurare automaticamente il kernel con GenKernel</title>
<body>

<p>
Se siete utenti Genkernel, tutto quello che dovrete fare è ripetere i passi
che avete fatto la prima volta che avete installato il kernel.
</p>

<p>
Eseguite semplicemente genkernel: 
</p>

<pre caption="Avviare genkernel">
<comment>(Per kernel 2.4:)</comment>
# <i>genkernel all</i>

<comment>(Per kernel 2.6:)</comment>
# <i>genkernel --udev all</i>
</pre>

<p>
Potete inoltre utilizzare dei parametri extra per attivare particolari
funzionalità di genkernel. Per esempio, se desiderate configurare alcune
opzioni attraverso <c>menuconfig</c> e desiderate che genkernel aggiorni
automaticamente la configurazione di grub, allora lanciate genkernel come
segue:
</p>

<pre caption="Eseguire genkernel con alcuni comandi aggiuntivi">
# <i>genkernel --menuconfig --bootloader=grub all</i>
</pre>

<p>
Per approfondire l'argomento seguite la <uri link="/doc/it/genkernel.xml">
Guida a genkernel</uri> o fate riferimento al
<uri link="/doc/it/handbook/index.xml">Manuale Gentoo</uri>. Molte delle
opzioni di <c>genkernel</c> possono essere direttamente impostate nel suo
file di configurazione: <path>/etc/genkernel.conf</path>
</p>

</body>
</section>
<section>
<title>Opzione 2: Configurazione manuale</title>
<body>

<p>
Per cominciare, avviate <c>menuconfig</c> nella directory dei sorgenti:
</p>

<pre caption="Avviare menuconfig">
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<p>
Selezionate le voci che maggiormente si confanno alla vostra configurazione
hardware ed alle vostre necessità. Per saperne di più sulla configurazione
del kernel fate riferimento al paragrafo intitolato
<e>Configurazione del kernel</e> del <uri
link="/doc/it/handbook/index.xml">Manuale Gentoo</uri>.
</p>

<p>
Adesso compilate il vostro kernel e copiate l'immagine nella vostra directory
di boot. Fate riferimento alla guida nel
<uri link="/doc/it/handbook/index.xml">Manuale Gentoo</uri>, in particolare al
paragrafo <e>Configurare il Bootloader</e>. Se <path>/boot</path> dovesse
essere una partizione dedicata accertatevi di averla montata prima di copiarvi
il kernel appena compilato. Se non si fa questo non si avvia il sistema con il
nuovo kernel.
</p>

<pre caption="Compilare ed installare un nuovo kernel">
# <i>make &amp;&amp; make modules_install</i>
# <i>mount /boot</i>
# <i>cp arch/i386/boot/bzImage /boot/bzImage-2.6.9-gentoo-r2</i>
</pre>

<p>
Infine, si deve aggiornare la configurazione del bootloader, aggiungendo una
voce per il nuovo kernel (non cancellate ancora le vecchie voci!) e smontare
la partizione <path>/boot</path>, fate riferimento ancora una volta al
<uri link="/doc/it/handbook/index.xml">Manuale Gentoo</uri> per una descrizione
dettagliata di tale procedura.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Reinstallare eventuali moduli esterni</title>
<section>
<body>

<p>
Se si utilizzano moduli del kernel che non sono distribuiti con i sorgenti del
kernel ma che sono comunque presenti in portage (e.g. i driver ALSA, NVIDIA o ATI),
dovrete reistallarli dopo avere completato l'intallazione del nuovo kernel.
Tale procedura e' semplice e consiste nel riemergere gli eventuali pacchetti
interessati. Per ulteriori informazioni fate riferimento al paragrafo
<e>Configurare il Kernel</e> del <uri 
link="/doc/it/handbook/index.xml">Manuale Gentoo</uri>. 
Per essere sicuri che questi pacchetti vengano compilati verso i nuovi sorgenti
in <path>/usr/src/linux</path>, prima disintallate i pacchetti e poi
riemergeteli. Questa procedura vi garantira' che vengano compilati verso i
nuovi sorgenti del kernel. 
</p>

<p>
Esiste un semplice tool (<c>sys-kernel/module-rebuild</c>) che ricompila tutti i moduli del kernel installati con ebuilds separati (per il kernel <c>attualmente in esecuzione</c>, che non è necessariamente quello in <path>/usr/src/linux</path>). Il suo uso è semplicissimo. Dopo averlo emerso, esegui semplicemente <c>module-rebuild-populate</c>, per popolare il database con una lista di pacchetti che necessitano di essere ricompilati dopo aver aggiornato o ricompilato il kernel. Una volta finito di aggiornare o ricompilare il kernel, esegui <c>module-rebuild rebuild</c> prima di riavviare, in modo da ricompilare i driver per il tuo nuovo kernel.
</p>

<p>
Per ulteriori informazioni, esegui <c>module-rebuild</c> senza alcuna opzione, e vedrai una lista di comandi che possono essere passati alla utility.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Riavviare col nuovo kernel</title>
<section>
<body>

<p>
Adesso chiudete tutte le applicazioni e riavviate il sistema. Se avete eseguito
correttamente tutte le istruzioni della guida, il menu del vostro bootloader
dovrebbe includere una voce con il nuovo kernel. Selezionatelo e fate
proseguire l'avvio del sistema.
</p>

<p>
Probabilmente il vostro sistema si avviera' col nuovo kernel e voi potrete
continuare a fare qualunque cosa stavate facendo prima. Se cosi' fosse allora
l'aggiornamento del kernel e terminato ed e' andato a buon fine.
</p>
 
<p>
Se invece avete fatto degli errori ed il sistema non vorra' saperne di avviarsi
col nuovo kernel, riavviate il sistema e dal menu' del bootloader scegliete il
vecchio kernel, a questo punto potete riprendere da <uri link="#install">
Configurare, compilare ed installare il nuovo kernel</uri> correggendo gli
eventuali errori. 
In alcuni casi non avrete bisogno di riavviare per apportare qualche piccola
modifica (e.g. se avete dimenticato di installare i driver per la vostra scheda
audio o per la vostra scheda di rete).
</p>

</body>
</section>
</chapter>

<chapter>
<title>Utilizzare kernel multipli</title>
<section>
<body>

<p>
Probabilmente avrete notato che quando avete installato il nuovo kernel i
sorgenti del vecchio kernel non sono stati rimossi. Questo vi consentira' di
utilizzare senza problemi diversi kernel.
</p>

<p>
Utilizzare diversi kernel e' molto semplice lasciando i sorgenti in
<path>/usr/src/</path> e lasciando l'immagine del kernel (<path>bzImage</path>)
in <path>/boot</path>. Ogni volta che avvierete il sistema potrete scegliere,
da una schermata del vostro bootloader, quale kernel avviare.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Rimuovere i vecchi kernel</title>
<section>
<body>

<p>
Potreste avere la necessita' di rimuovere il vostro vecchio kernel se il nuovo
dovesse rispondere alle vostre necessita'. Per rimuovere semplicemente tutti i
sorgenti del vecchio kernel potrete utilizzare l'opzione <e>prune</e> di
<c>emerge</c>. Eccovi un esempio sempre con i <c>gentoo-sources</c>:
</p>

<pre caption="Pruning dei vecchi sorgenti">
# <i>emerge -P gentoo-sources</i>
</pre>

<p>
Nella maggior parte dei casi i file temporanei utilizzati durante la
compilazione rimarranno nella directory dei sorgenti <path>/usr/src</path>.
Potranno essere comunque rimossi utilizzando <c>rm</c>.
</p>

<p>
Potrete anche tranquillamente cancellare ogni modulo utilizzato dal vostro
vecchio kernel, rimuovendo la directory che fa riferimento al kernel vecchio
in <path>/lib/modules/</path>. Prestate comunque attenzione a non cancellare i
moduli del kernel che avete ancora intenzione di utilizzare!</p>

<p>
Dopo la rimozione dei sorgenti e dei moduli potete montare la partizione
<path>/boot</path> e rimuovete il file <path>bzImage</path> che faccia riferimento al kernel che avete appena
disinstallato. Dovrete anche modificare la configurazione del vostro bootloader
in modo da evitare che ci siano voci che puntino a immagini che avete
rimosso.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Utilizzare il vecchio .config per configurare il nuovo kernel</title>
<section>
<body>

<p>
E' comunque possibile risparmiare tempo nell'installazione di un nuovo kernel
utilizzando il file di configurazione del vecchio. Generalmente questa non e'
una procedura sicura viste le modifiche che possono intercorrere tra una
release e l'altra.
</p>

<p>
L'unica situazione appropriata e quando si aggiorna da
una revisione all'altra del kernel Gentoo. Per esempio, i cambiamenti tra
<c>gentoo-sources-2.6.9-r1</c> e <c>gentoo-sources-2.6.9-r2</c> saranno molto
pochi, ed e' questo un caso in cui utilizzare il file di configurazione del
vecchio kernel per il nuovo non causera' problemi di sorta.
Invece non e' consigliato utilizzare questo metodo passando dal 2.6.8 al 2.6.9
ad esempio. In questo caso i cambiamente possono essere tali da non garantire
il controllo sulla configurazione.
</p>

<p>
Per utilizzare il <path>.config</path> del vecchio kernel basta copiarlo nella
directory dei sorgenti del nuovo kernel e poi dare un <c>make oldconfig</c>.
Nell'esempio che segue copiamo il file di configurazione da
<c>gentoo-sources-2.6.9-r1</c> a <c>gentoo-sources-2.6.9-r2</c>
</p>

<pre caption="Utilizzare il file di configurazione del vecchio kernel">
# <i>cd /usr/src/linux-2.6.9-gentoo-r2</i>
# <i>cp ../linux-2.6.9-gentoo-r1/.config .</i>
# <i>make oldconfig</i>
</pre>

<p>
A questo punto potrebbe venirvi chiesto di configurare alcune opzioni che sono
cambiate tra le due versione dei gentoo-sources. Una volta fatto questo,
potrete compilare ed installare il vostro kernel come sempre, senza dover
passare per <c>menuconfig</c>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Problemi dopo un upgrade del kernel?</title>
<section>
<body>

<p>Con la velocita' con cui viene sviluppato il kernel linux, e' possibile che
alcuni cambiamenti da una release all'altra diano qualche problema. Se si
dovessero avere dei problemi aggiornando il kernel si consiglia di fare
riferimento all'ultima versione di
<uri link="/doc/it/gentoo-kernel.xml#doc_chap2">
Guida ai Kernel Gentoo Linux</uri> e poi rendere noto il problema agli
sviluppatori di Gentoo.
</p>

</body>
</section>
</chapter>

</guide>
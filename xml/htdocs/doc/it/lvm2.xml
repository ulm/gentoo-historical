<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/it/lvm2.xml,v 1.6 2004/10/27 21:46:03 mush Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/it/lvm2.xml" lang="it">
<title>Installazione di Gentoo con LVM2</title>
<author title="Autore">
  <mail link="avi@CFFtechnologies.com">Avi Schwartz</mail>
</author>
<author title="Contributi">
  <mail link="rajiv@gentoo.org">Rajiv Manglani</mail>
</author>
<author title="Redazione">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>
<author title="Traduzione">
  <mail link="emix@solira.org">Emilio Pavia</mail>
</author>

<abstract>
Questa guida descrive la configurazione di un sistema Gentoo per l'utilizzo 
del Logical Volume Manager versione 2 (LVM2).
</abstract>

<license/>

<version>2.0.5</version>
<date>25 Settembre 2004</date>

<chapter>
<title>Introduzione</title>
<section>
<body>
<p>
Questa guida si basa su un esempio fatto con due hard disk IDE. Ciò vuol dire
che molto probabilmente è necessario modificare le unità, i nomi delle partizioni
e le loro dimensioni per essere adattata alla propria configurazione e alle
proprie esigenze.
</p>

<warn>
Questo documento non deve essere considerato un tutorial su LVM2. Deve servire
da supplemento alla procedura di installazione descritta nella <uri link="/doc/it/handbook/handbook-x86.xml?part=1&amp;chap=0">parte 1 del manuale</uri>.
E' necessaria la <c>lettura</c> del manuale di installazione di Gentoo <c>prima</c>
di iniziare la procedura di installazione.
</warn>

<note>
Per un completo HOWTO su LVM si consiglia di visitare
<uri>http://tldp.org/HOWTO/LVM-HOWTO</uri>
</note>
</body>
</section>

<section>
<title>Requisiti iniziali</title>
<body>
<p>
Se si sta effettuando una nuova installazione di Gentoo, occorre un CD avviabile
con il supporto a LVM2, come ad esempio il LiveCD Gentoo. E' possibile trovare
il LiveCD per l'architettura x86 nei nostri <uri
link="http://www.gentoo.org/main/en/mirrors.xml">mirror</uri> sotto <path>/releases/x86/2004.0/livecd/universal</path>.
Altre architetture potrebbero essere ugualmente supportate.
</p>

<p>
Se si sta installando LVM2 su un sistema già esistente con dello spazio disponibile su
hard disk, occorre attivare il modulo LVM2 (<path>dm-mod</path>). Questo
modulo è disponibile in <path>gentoo-sources</path>, in 
<path>development-sources</path> e in <path>gentoo-dev-sources</path>.
La compilazione del kernel e la configurazione di LVM2 viene affrontata più avanti
in questa guida.
</p>
<p>
Non tutti i kernel della serie 2.4 forniti da Gentoo supportano LVM2!
</p>
</body>
</section>

<section>
<title>Partizioni</title>
<body>
<p>
Il sistema preso in esempio ha 2 hard disk IDE così partizionati:
</p>

<ul>
<li>/dev/hda1  --  /boot</li>
<li>/dev/hda2  --  (swap)</li>
<li>/dev/hda3  --  /</li>
<li>/dev/hda4  --  Utilizzato da LVM2</li>
<li>/dev/hdb1  --  Utilizzato da LVM2</li>
</ul>

<impo>
Si faccia attenzione ai nomi delle partizioni poichè è facile confondere le
a con le b, e i numeri delle partizioni. Un passo falso potrebbe causare la
cancellazione della partizione sbagliata.
</impo>

</body>
</section>
</chapter>

<chapter>
<title>Installazione</title>
<section>
<body>

<p>
Si segua il manuale, ma con le seguenti correzioni al capitolo <c>4. Preparazione dei dischi</c>.
</p>

<p>
Si utilizzi <c>fdisk</c> come descritto nel manuale, ma si segua lo schema delle
partizioni menzionato sopra. Si ricordi che è solo <e>un esempio</e>,
e che va adattato alle proprie esigenze.
</p>

<p>
Si crei una piccola partizione fisica per /boot (hda1). In questo esempio /boot
non viene gestita da LVM2. In questa partizione vengono memorizzati il bootloader
e i vari kernel. Una partizione di 64MB dovrebbe essere sufficientemente grande.
</p>

<p>
Si crei una partizione di swap (hda2) e la si attivi.
</p>
<pre caption="Attivazione della partizione di swap">
# <i>mkswap /dev/hda2</i>
# <i>swapon /dev/hda2</i>
</pre>


<p>
Si crei una partizione per / (root) (hda3). Se si fosse interessati a gestire
la partizione di root con LVM (cosa che non si consiglia), si può visitare,
nella sezione 'Risorse' alla fine di questa guida, un link ad un mini-howto su come
fare ciò. Non occorre assegnare troppo spazio alla partizione di root se si
decide di tenere <path>/opt, /usr, /home, /var</path> e <path>/tmp</path> in un 
volume group (vg) LVM2. In questo caso, 150M sono sufficienti.
</p>

<note>
Non si consiglia di inserire le directory seguenti in una partizione LVM2:
</note>

<ul>
<li>/etc</li>
<li>/lib</li>
<li>/mnt</li>
<li>/proc</li>
<li>/sbin</li>
<li>/dev</li>
<li>/root</li>
</ul>

<note>
In questo modo sarebbe comunque possibile accedere al sistema (corrotto, ma ancora 
in qualche modo utilizzabile) come root, se inauguratamente qualcosa andasse storto.
</note>


<p>
Supponendo che le partizioni di /boot, swap e root non utilizzino l'intero disco
fisico, si crei una quarta partizione sul disco e la si imposti di tipo 8e
(Linux LVM). Se si hanno più dispositivi fisici che si vogliono utilizzare con LVM,
si crei una partizione su ognuno di essi e la imposti dello stesso tipo (8e).
</p>

<note>
Considerando le grosse dimensioni dei dischi odierni, si potrebbe pensare
di dividere il proprio hard disk in piccole partizioni anzichè crearne un'unica
grossa da aggiungere in un unico blocco ad un volume group LVM2. Dopo tutto LVM2 
permette di gestire facilmente il ridimensionamento dei volumi. Questa soluzione lascia
alcune partizioni non allocate che potrebbero servire al di fuori di un gruppo
LVM2. In breve, non si deve utilizzare lo spazio su disco se non è necessario.
Per esempio si può pensare di dividere un hard disk da 160 GB in 8 partizioni
da 20 GB ciascuna.
</note>

<p>
Si carichi il modulo di LVM2 <path>dm-mod</path>. Per qualche motivo, questo
modulo è stato compilato all'interno del kernel 2.6 (nominato <c>smp</c>) presente
nel Gentoo LiveCD. Se si utilizza questo kernel al posto di quello 2.4 di default (nominato
<c>gentoo</c>), si può saltare questo passaggio o ignorare il warning che si ottiene.
</p>

<pre caption="Caricamento del modulo di LVM2">
# <i>modprobe dm-mod</i>
</pre>


<p>
Si esegua lo scan e l'attivazione di LVM:
</p>
<pre caption="Attivazione di LVM">
<comment>(Evitare la scansione dei cdrom)</comment>
# <i>mkdir -p /etc/lvm</i>
# <i>echo 'devices { filter=["r/cdrom/"] }' >/etc/lvm/lvm.conf</i>
# <i>vgscan</i>
  Reading all physical volumes.  This may take a while...
  No volume groups found
</pre>
<p>
Si preparino le partizioni.
</p>
<pre caption="Preparazione delle partizioni">
# <i>pvcreate /dev/hda4 /dev/hdb1</i>
  No physical volume label read from /dev/hda4
  Physical volume "/dev/hda4" successfully created
  No physical volume label read from /dev/hdb1
  Physical volume "/dev/hdb1" successfully created
</pre>


<p>
Si imposti un volume group. Un volume group è la combinazione di più
unità fisiche in un'unica unità logica.
</p>

<p>
In questo esempio, <path>/dev/hda1</path>, <path>/dev/hda2</path> e
<path>/dev/hda3</path> sono le partizioni di <path>/boot</path>, swap e root, perciò 
quelle da combinare sono <path>/dev/hda4</path> e <path>/dev/hdb1</path>. Questo può
essere ottenuto con un singolo comando, ma, come nell'esempio, prima si creerà 
il volume group e poi verrà esteso.
</p>


<pre caption="Creazione ed estenzione del volume group">
<comment>(Creare un volume group di nome vg)</comment>
# <i>vgcreate vg /dev/hda4</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignorare questo warning)</comment>
  Volume group "vg" successfully created
<comment>(Estendere il volume group esistente)</comment>
# <i>vgextend vg /dev/hdb1</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignorare ancora questo warning e quelli più avanti)</comment>
  Volume group "vg" successfully extended
</pre>


<p>
Si creino i volumi logici. I volumi logici sono l'equivalente delle partizioni
che verrebbero create utilizzando fdisk in un ambiente non LVM2. Nell'esempio
vengono create le seguenti partizioni:
</p>

<table>
<tr>
<th>Directory</th>
<th>Dimensione</th>
</tr>
<tr>
<ti>/usr</ti><ti>10 GB</ti>
</tr>
<tr>
<ti>/home</ti><ti>5 GB</ti>
</tr>
<tr>
<ti>/opt</ti><ti>5 GB</ti>
</tr>
<tr>
<ti>/var</ti><ti>10 GB</ti>
</tr>
<tr>
<ti>/tmp</ti><ti>2 GB</ti>
</tr>
</table>

<p>
Dato che si sta utilizzando LVM2 non ci si deve preoccupare molto dello
spazio assegnato alle partizioni perchè queste ultime possono essere ridimensionate in
qualsiasi momento in base alle esigenze.
</p>

<note>
Terje Kvernes ha fatto notare che è più semplice aumentare la dimensione di una
partizione anzichè ridurla. Per questo è conveniente iniziare con partizioni
più piccole ed aumentare le dimensioni quando serve.
</note>

<pre caption="Creazione ed estensione dei volumi logici">
# <i>lvcreate -L10G -nusr  vg</i>
  Logical volume "usr" created <comment>(Gli altri messaggi simili non vengono mostrati)</comment>
# <i>lvcreate -L5G  -nhome vg</i>
# <i>lvcreate -L5G  -nopt  vg</i>
# <i>lvcreate -L10G -nvar  vg</i>
# <i>lvcreate -L2G  -ntmp  vg</i>
<comment>(Nell'esempio si mostra come ingrandire un volume logico di altri 5 GB)</comment>
# <i>lvextend -L+5G /dev/vg/home</i>
</pre>


<p>
Si creino i filesystem sui volumi logici nello stesso modo in cui si farebbe
sulle normali partizioni. Qui viene utilizzato ext3 ma qualsiasi filesystem
va bene.
</p>

<pre caption="Creazione dei filesystem">
# <i>mke2fs -j /dev/vg/usr</i>
# <i>mke2fs -j /dev/vg/home</i>
# <i>mke2fs -j /dev/vg/opt</i>
# <i>mke2fs -j /dev/vg/var</i>
# <i>mke2fs -j /dev/vg/tmp</i>
</pre>


<p>
Come descritto nel manuale si effettui il mount delle partizioni e allo 
stesso modo dei volumi logici LVM2 sostituendo però i soliti <path>/dev/hdxx</path> 
con <path>/dev/vg/logical_volumename</path>.
</p>

<pre caption="Mount dei volumi logici">
<comment>(Assicurarsi di aver fatto prima il mount della partizione di root come descritto nel manuale)</comment>
# <i>mkdir /mnt/gentoo/usr</i>
# <i>mount /dev/vg/usr /mnt/gentoo/usr</i>
# <i>mkdir /mnt/gentoo/home</i>
# <i>mount /dev/vg/home /mnt/gentoo/home</i>
# <i>mkdir /mnt/gentoo/opt</i>
# <i>mount /dev/vg/opt /mnt/gentoo/opt</i>
# <i>mkdir /mnt/gentoo/var</i>
# <i>mount /dev/vg/var /mnt/gentoo/var</i>
# <i>mkdir /mnt/gentoo/tmp</i>
# <i>mount /dev/vg/tmp /mnt/gentoo/tmp</i>
</pre>

<note>
Il resto della procedura di installazione è simile al manuale, perciò d'ora
in avanti verranno evidenziate solo le differenze.
</note>


<p>
Quando si configura il kernel assicurarsi di configurare il supporto
a LVM2 (non tutti i kernel della serie 2.4 lo supportano). 
Si selezioni il modulo LVM2 nel modo seguente:
</p>

<pre caption="Selezione del modulo LVM2 in un kernel 2.4.x">
Multi-device support (RAID and LVM)  ---&gt;
  [*] Multiple devices driver support (RAID and LVM)
  &lt; &gt;  RAID support
<comment>(Notare che LVM non è selezionato di proposito perchè è relativo a LVM1)</comment>
  &lt; &gt;  Logical volume manager (LVM) support
  &lt;M&gt;  Device-mapper support
  &lt; &gt;   Mirror (RAID-1) support
</pre>

<pre caption="Selezione del modulo LVM2 in un kernel 2.6.x">
Device Drivers  ---&gt;
 Multi-device support (RAID and LVM)  ---&gt;
   [*] Multiple devices driver support (RAID and LVM)
   &lt; &gt;   RAID support
   &lt;M&gt;   Device mapper support
</pre>

<p>
Il modulo compilato si chiama <path>dm-mod.ko</path>
</p>

<p>
Dopo aver compilato il kernel e installato i suoi moduli si aggiunga la riga seguente
al file <path>/etc/modules.autoload.d/kernel-{KV}</path>, dove {KV} rappresenta
la versione del kernel (2.4 o 2.6), in modo da fare caricare il modulo di LVM2
all'avvio della macchina:
</p>

<pre caption="Aggiunta del modulo di LVM2 in /etc/modules.autoload.d/kernel-2.6">
# <i>nano -w /etc/modules.autoload.d/kernel-2.6</i>
<comment>(Aggiungere la riga seguente)</comment>
dm-mod
</pre>

<p>
A questo punto si installi il pacchetto lvm2.
</p>

<impo>
Ci si assicuri che il link <path>/usr/src/linux</path> punti ai sorgenti del kernel
utilizzato perchè l'ebuild di lvm2 dipende dall'ebuild di device-mapper che controlla
la presenza di un file sorgente richiesto sotto <path>/usr/src/linux/include/linux</path>.
</impo>

<pre caption="Installazione del pacchetto lvm2">
# <i>emerge lvm2</i>
<comment>(Evitare che lvm2 controlli i cdrom)</comment>
# <i>echo 'devices { filter=["r/cdrom/"] }' >> /etc/lvm/lvm.conf</i>
</pre>


<p>
Nel modificare il file <path>/etc/fstab</path> si segua il manuale e si
aggiungano i volumi logici LVM2. Si ricordi sempre che qui ci sono
solo poche righe riferite all'esempio:
</p>

<pre caption="Extract of /etc/fstab">
/dev/hda1     /boot   ext3    noauto,noatime 1 1
/dev/hda2     none    swap    sw             0 0
/dev/hda3     /       ext3    noatime        0 0
# Logical volumes
/dev/vg/usr   /usr    ext3    noatime        0 0
/dev/vg/home  /home   ext3    noatime        0 0
/dev/vg/opt   /opt    ext3    noatime        0 0
/dev/vg/var   /var    ext3    noatime        0 0
/dev/vg/tmp   /tmp    ext3    noatime        0 0
</pre>


<p>
Raggiunta nel manuale la fine della parte relativa all'installazione, ci si ricordi
di effettuare l'umount di tutti i volumi logici LVM2, e si esegua il comando seguente
prima di riavviare:
</p>

<pre caption="Arresto di LVM2">
# <i>vgchange -an</i>
</pre>


<p>
Una volta riavviata la macchina tutte le partizioni dovrebbero essere
visibili e montate.
</p>
</body>
</section>
</chapter>

<chapter>
<title>Risorse</title>
<section>
<body>
<ul>
<li>
  <uri link="http://sources.redhat.com/lvm2">Home Page</uri> ufficiale di LVM2
</li>
<li><uri link="http://tldp.org/HOWTO/LVM-HOWTO">LVM Howto</uri></li>
<li>
  Articoli di Daniel Robbins riguardanti LVM su IBM DeveloperWorks:
  <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm/?dwzone=linux</uri>
  e
  <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm2.html?dwzone=linux</uri>
</li>
<li>
  Come fare il boot con il filesystem di root sotto LVM:
  <uri>http://www.the-infinite.org/archive/docs/lvm/howto-boot-off-root-lv.txt</uri>
</li>
</ul>

</body>
</section>
</chapter>
<chapter>
<title>Ringraziamenti</title>
<section>
<body>

<p>
Si ringrazia <mail link="bangert@gentoo.org">Thilo Bangert</mail> e <mail
link="terjekv@math.uio.no">Terje Kvernes</mail> per il loro aiuto e per i
commenti su questo documento.
</p>

</body>
</section>
</chapter>
</guide>

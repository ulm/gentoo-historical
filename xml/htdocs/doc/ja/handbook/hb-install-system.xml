<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/handbook/hb-install-system.xml,v 1.11 2005/04/01 14:30:26 idani Exp $ -->

<!-- Original revision: 1.73 -->
<!-- Translator: igarashi -->

<sections>

<version>2.1</version>
<date>2005-03-28</date>

<section>
<title>chrootする</title>
<subsection>
<title>自由選択: ミラーサイトの選択</title>
<body>

<p>
すばやくソースコードをダウンロードするために、一番回線速度が速いミラーサイトを選択することをお勧めします。
Portageは、GENTOO_MIRRORS変数を<path>make.conf</path>ファイルから参照し、その変数に羅列されいているミラーサイトを使用します。
Gentooサイトの<uri link="/main/en/mirrors.xml">mirror list</uri>
<uri link="/main/ja/mirrors.xml">(日本語訳)</uri>を参照し、(高確率で一番速いサイトとしての)一番近い一つのミラーサイト(もしくは複数のミラーサイト)を探すことができます。
しかし、お望みのミラーサイトを選択するのに使いやすいインターフェースを備える<c>mirrorselect</c>というすばらしいツールを提供しています。
</p>

<pre caption="GENTOO_MIRRORS変数用にmirrorselectを使用する">
# <i>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<warn>
どのIPv6ミラーサイトも選択してはいけません。現在stageファイルは、IPv6をサポートしていません。
</warn>

<p>
<path>make.conf</path>での2番目に重要な設定は、SYNC変数の設定です。
この変数には、Portageツリーを更新するときに使用したいrsyncサーバを設定します。
(Portageツリーとは、Portageがソフトウェアをダウンロードしてインストールのに必要な情報の全てが書かれているebuildや、スクリプトの集まりです。)
自分でSYNCサーバを手作業で指定できますが、<c>mirrorselect</c>はその作業を以下のように簡単にします。
</p>

<pre caption="mirrorselectを使ってrsyncミラーを選択する">
# <i>mirrorselect -i -r -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<p>
<c>mirrorselect</c>を実行した後、<path>/mnt/gentoo/etc/make.conf</path>内の設定が重複していないかを確認したほうがよいでしょう。
</p>

</body>
</subsection>
<subsection>
<title>DNS情報をコピーする</title>
<body>

<p>
新しい環境に入る前にしなければならないことが、まだ一つ残っています。
それは、新しい環境でもネットワーク環境が確実に動くようにするために、
<path>/etc/resolv.conf</path>にあるDNS情報を、新しい環境にコピーすることです。
<path>/etc/resolv.conf</path>にはあなたのネットワーク環境における
ネームサーバーの情報が含まれています。
</p>

<pre caption="DNS情報をコピーする">
<comment>("-L"オプションは、シンボリックリンクをコピーしないようにするために必要です)</comment>
# <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/resolv.conf</i>
</pre>

</body>
</subsection>
<subsection>
<title>procファイルシステムのマウント</title>
<body>

<p>
chroot後の環境でもカーネルが提供する情報を参照できるようにするために、<path>/mnt/gentoo/proc</path>に<path>/proc</path>ファイルシステムをマウントしてください。
</p>

<pre caption="/procのマウント">
# <i>mount -t proc none /mnt/gentoo/proc</i>
</pre>

</body>
</subsection>
<subsection>
<title>新しい環境に入る</title>
<body>

<p>
さて、全てのパーティションは初期化され、ベース環境はインストールされました。
ついに、あなたは<e>chroot</e>により新たにインストールされた環境に入ります。
これは、現在のインストーラの環境(インストールCDやその他のインストールメディア)から、
あなたのインストールした環境(すなわち初期化されたパーティション)に移行することを意味します。
</p>

<p>
このchrootの過程は3段階のステップからなります。
まず最初に、<c>chroot</c>によって、ルートディレクトリを(インストールメディア上の)<path>/</path> から、(あなたのパーティション上にある)<path>/mnt/gentoo</path>に変更します。次に、システムファイルの環境変数を更新するコマンドenv-updateを使って、新しい環境をつくります。最後に、<c>source</c>コマンドでこれらの変数をメモリ上に読み込みます。
</p>

<pre caption = "新しい環境にchrootする">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update</i>
 * Caching service dependencies...
# <i>source /etc/profile</i>
</pre>

<p>
おめでとうございます!あなたは自分のGentoo Linux環境に入ることができました。
もちろん、まだいくつかのセクションが残っており、完了までは程遠いのですが:-)
</p>

</body>
</subsection>
<subsection>
<title>Portageツリーの更新</title>
<body>

<p>
ここで、Portageツリーを最新状態に更新すべきです。
<c>emerge --sync</c>が、これを行います。
</p>

<pre caption="Portageツリーの更新">
# <i>emerge --sync</i>
</pre>

<p>
Portageの新しいバージョンが利用可能で、新しいものに更新すべきであることを警告されても、無視してください。Portageは、後々のインストール作業中にアップデートされます。
</p>

</body>
</subsection>
<subsection>
<title>適切なprofileの選択</title>
<body>

<p>
まずは、定位置にある小さな定義のことについてです。
</p>

<p>
profileは、すべてのGentooシステムにとって基礎的要素の一つです。
CHOST、CFLAGSやその他の重要な変数のための初期設定値を指定しているだけでなく、
システムの状態を特定範囲内のパッケージバージョンに留めておく役目もあります。
これはすべて、Gentoo開発者によって整備されています。
</p>

<p>
このようなprofileをユーザが変更することは、以前はほとんどありませんでした。
ですが最近では、x86、hppa、alphaユーザは二つのprofileのうち一つを選ぶことができます。一つは2.4カーネル用で、もう一つは2.6カーネル用です。
こうした要求は、2.6カーネルの統合を進めるために必要とされました。
</p>

<p>
以下のコマンドを発行することで、現在使用中のprofileが何であるかを確認することができます。
</p>

<pre caption="システムprofileの確認">
# <i>ls -l /etc/make.profile</i>
lrwxrwxrwx  1 root root 48 Mar  7 11:55 /etc/make.profile ->
      ../usr/portage/profiles/default-linux/x86/2005.0
</pre>

<p>
上記三つのアーキテクチャのうちの一つを使用しているなら、<path>make.profile</path>シンボリックリンクが示すところに、以下のように付加的なprofileを確認できるでしょう。
</p>

<pre caption="付加的なprofileが存在するかどうかの確認">
# <i>ls -F /etc/make.profile/</i>
2.4/  packages  parent  virtuals
</pre>

<p>
見て分かるとおり、上記の例では2.4ディレクトリがあります。
これは、今のprofileは2.6カーネル用を使用しているということを示しています。
2.4ベースのシステムがよいなら、以下のようにして<path>make.profile</path>シンボリックリンクを再度リンクしなおすことが必要です。
</p>

<pre caption="profileの再リンク">
# <i>ln -snf /usr/portage/profiles/default-linux/x86/2005.0/2.4 /etc/make.profile</i>
</pre>

</body>
</subsection>
<subsection id="configure_USE">
<title>USE変数の設定</title>
<body>

<p>
<c>USE</c>はGentooがユーザに提供する最もパワフルな変数の一つです。
プログラムの中には、特定のフラグを設定することによって、副次的なサポートを有効にしたり無効にしたりできるものがあります。
たとえばGTKサポートもしくはQtサポートを有効にしてコンパイルすることができるプログラムがあります。他には、SSLサポートを有効にするか無効にするか、
X11サポート(X-server)の替わりにフレームバッファサポート(svgalib)
を有効にするか、などがあります。
</p>

<p>
多くのディストリビューションは、パッケージをありったけのサポートを有効にしてコンパイルしているため、依存関係が膨大になってしまっていることは言うまでもなく、
プログラムのサイズや起動時間までも増大させてしまっています。
Gentooならば、パッケージをコンパイルするときにつけるべきオプションを
自分で定義することができます。これには<c>USE</c>フラグが一役買っています。
</p>

<p>
<c>USE</c>変数には、コンパイルオプションに対応するキーワードを定義します。
たとえば、<e>ssl</e>はプログラムに備わるSSLサポートをコンパイルします。
<e>-X</e>はXサーバのサポートを削除します。(キーワードの前にマイナス記号をつけます。)<e>gnome gtk -kde -qt</e>は、GNOME(とGTK)サポートを有効にし、KDE(とQt)サポートを無効にしてプログラムをコンパイルします。システムを完全にGNOME向けに調整します。
</p>

<p>
初期の<c>USE</c>設定は、使用しているprofileの<path>make.defaults</path>ファイルにあります。
<path>make.defaults</path>は、<path>/etc/make.profile</path>シンボリックリンクが指すディレクトリと、同じくすべてのその親ディレクトリで見つかります。
初期の<c>USE</c>設定は、それら<path>make.defaults</path>ファイルのすべての<c>USE</c>設定を組み合わせたものになります。
<path>/etc/make.conf</path>に記述した内容は、これらの初期設定に反映されます。
もし<c>USE</c>設定に何かを追加した場合、それは初期設定リストに追加されます。
もし何かを(マイナス記号を頭につけることで)USE設定から取り除いた場合、
それは(リストにあれば)初期設定リストから取り除かれます。
<e>決して</e>、<path>/etc/make.profile</path>ディレクトリ以下の内容を変更しないでください。Portageをアップデートするときに、上書きされてしまいます!
</p>

<p>
Gentooハンドブックの第二部にある<uri link="?part=2&amp;chap=2">USEフラグ</uri>に、<c>USE</c>についての詳細な解説があります。また、システムにある<path>/usr/portage/profiles/use.desc</path>に、使用可能なUSEフラグについての詳細な解説があります。
</p>

<pre caption="使用可能なUSEフラグの参照">
# <i>less /usr/portage/profiles/use.desc</i>
<comment>(矢印キーを使用してスクロールし、'q'キーで終了します)</comment>
</pre>

<p>
DVD、ALSA、CD-Rサポートを含むKDEベースのシステムのための<c>USE</c>フラグの例を以下に示します。
</p>

<pre caption="/etc/make.confを開く">
# <i>nano -w /etc/make.conf</i>
</pre>

<pre caption="USEフラグの設定">
USE="-gtk -gnome qt kde dvd alsa cdr"
</pre>

</body>
</subsection>
<subsection>
<title>自由選択: GLIBCのロケール</title>
<body>

<p>
あなたは、おそらくシステムで一つないし二つのロケールだけしか使用しないでしょう。これまでは<c>glibc</c>のコンパイルの後で、全ての使用可能なロケールのフルセットが生成されていました。現在は、<c>userlocales</c> USEフラグを有効にして、<path>/etc/locales.build</path>に必要とするロケールだけを指定できます。これは、どのロケールを選択すべきかが分かっている場合にだけ、行ってください。
</p>

<pre caption="glibc用のuserlocales USEフラグを有効にする">
# <i>mkdir /etc/portage</i>
# <i>echo "sys-libs/glibc userlocales" >> /etc/portage/package.use</i>
</pre>

<p>
それでは、以下のように使用したいロケールを指定してください。
</p>

<pre caption="/etc/locales.buildを開く">
# <i>nano -w /etc/locales.build</i>
</pre>

<p>
以下のロケール指定は、関連する文字符号(UTF-8のような)を含む、英語(アメリカ)とドイツ語(ドイツ)ロケールを生成する例です。(訳注: 日本語訳には日本語に関するロケールも追加しています。)
</p>

<pre caption="ロケールの指定">
en_US/ISO-8859-1
en_US.UTF-8/UTF-8
de_DE/ISO-8859-1
de_DE@euro/ISO-8859-15
ja_JP.EUC-JP/EUC-JP
ja_JP.UTF-8/UTF-8
ja_JP/EUC-JP
</pre>

</body>
</subsection>
</section>
<section>
<title>stage1、stage2、stage3の違い</title>
<body>

<p>
さて、腰を落ち着けて、これまでのインストール工程について思い出してみてください。
私たちは、あなたに<e>stage1</e>、<e>stage2</e>、<e>stage3</e>から一つ選ぶようにといいました。そしてそれは、後々のインストール工程にとって、とても重要な選択だと警告しました。そう。今ここが、あなたの選択によって、後に続くインストール工程を決定する最初の場面です。
</p>

<ul>
<li>
<e>stage1</e>を選択したなら、この章の<e>両方の</e>ステップに従ってください。
(<uri link="#doc_chap3">stage1からstage2に進む</uri>から始めます。)
</li>
<li>
<e>stage2</e>を選択したなら、最初のステップを飛ばして、すぐに2番目のステップ
(<uri link="#doc_chap4">stage2からstage3へ進む</uri>)から始められます。
</li>
<li>
<e>stage3</e>を選んだのなら、両方のステップを飛ばして、<uri link="?part=1&amp;chap=7">カーネルの設定</uri>に進んでください。
</li>
</ul>

</body>
</section>
<section>
<title>stage1からstage2に進む</title>
<subsection>
<title>ブートストラップ概説</title>
<body>

<p>
このステップに進んできたあなたは、何もかもスクラッチからコンパイルしたいことでしょう。わかりました。:-)
</p>

<p>
このステップではあなたのGentooシステムを<e>ブートストラップ</e>します。
これは非常に長い時間がかかります。しかしその結果、システムはあなたのマシンに特化し、あなたの要求を満たした根底からの最適化がなされます。
</p>

<p>
<e>ブートストラップ</e>とは、GNU Cライブラリや、GNUコンパイラコレクションや、
いくつかの重要なシステムプログラムをビルドすることを意味します。
</p>

<p>
ブートストラップを開始する前に、まず全ての必要なソースコードをダウンロードしたいかもしれません。もししたくなければ、<uri link="#bootstrap">システムのブートストラップ</uri>に進んでください。
</p>

</body>
</subsection>
<subsection>
<title>自由選択: 最初にソースコードをダウンロードする</title>
<body>

<p>
以前にすべてのソースコードを取得していない場合、bootstrapスクリプトが必要なファイルすべてをダウンロードしてくれます。最初にソースコードをダウンロードして、その後システムをブートストラップしたいなら(例えば、コンパイル中にインターネットに接続しっぱなしにしたくないという理由で)、bootstrapスクリプトの<e>-f</e>オプションを使用してください。このオプションは、全てのソースコードを取ってきます(fetchしてきます:<e>f</e>オプションの由来)。
</p>

<pre caption = "必要なソースコードを最初にダウンロード">
# <i>cd /usr/portage</i>
# <i>scripts/bootstrap.sh -f</i>
</pre>

</body>
</subsection>
<subsection id="bootstrap">
<title>システムをブートストラップする</title>
<body>

<p>
OKです。では、キーボードから次のコマンドを打ち、ブートストラップを始めてください。このステップは終了まで非常に長い時間がかかるので、何か他のことをして楽しんでいてください。
</p>

<pre caption = "システムをブートストラップする">
# <i>cd /usr/portage</i>
# <i>scripts/bootstrap.sh</i>
</pre>

<p>
さあ、次のステップ、<uri link="#doc_chap4">stage2からstage3へ進む</uri>に進みましょう。
</p>

</body>
</subsection>
</section>
<section>
<title>stage2からstage3へ進む</title>
<subsection>
<title>概説</title>
<body>

<p>
あなたがこの章を読んでいるということは、すでにブートストラップが完了したシステム(事前にブートストラップを行ったか、もしくは<e>stage2</e>を使った)ができあがっているのだと思います。では、いよいよすべてのシステムのパッケージをビルドします。
</p>

<p>
本当に<e>全部の</e>システムパッケージをビルドしなければいけないのですか?
いいえ。正確にはその必要はありません。このステップでは、選択肢が他にないシステムパッケージをビルドします。システムパッケージの中には、いくつか選択の幅があるパッケージ(例えばシステムロガー)がありますが、選択あってのGentooですから、あなたにどのパッケージをインストールしなさいというような強制はしたくありません。
</p>

</body>
</subsection>
<subsection>
<title>自由選択: あらかじめ何が行われるのかを見てみる</title>
<body>

<p>
どんなパッケージがインストールされるのかを知りたければ、<c>emerge --pretend --emptytree system</c>を実行します。
これは、これからビルドされるすべてのパッケージのリストを表示します。このリストは非常に大きいので、上下にスライドさせて見るために<c>less</c>や<c>more</c>などのページャーも使用すべきです。
</p>

<pre caption = "'emerge system'が何をするかを見てみる">
# <i>emerge --pretend --emptytree system | less</i>
</pre>

<p>
CFLAGS/CXXFLAGSの初期設定を変更していないなら、<c>emerge --pretend --newuse system</c>を使うだけで十分です。さらにUSEフラグも変更していないなら、どうしてstage2インストールをしているのでしょうか(訳注: stage3インストールをお勧めしますという意味)。
</p>

</body>
</subsection>
<subsection>
<title>自由選択: ソースコードのダウンロード</title>
<body>

<p>
このまま続ける前に、ソースコードをダウンロードするために<c>emerge</c>したいなら((例えば、すべてのパッケージをビルドしている間中、インターネットに接続しっぱなしにしたくないという理由で)、<c>emerge</c>の<e>--fetchonly</e>を使用できます。このオプションは、全てのソースコードを取ってきます(fetchしてきます)。
</p>

<pre caption = "ソースコードを取ってくる">
# <i>emerge --fetchonly --emptytree system</i>
</pre>

</body>
</subsection>
<subsection>
<title>システムのビルド</title>
<body>

<p>
システムのビルドを開始するには<c>emerge --emptytree system</c>を実行してください。このステップは終了するまで大変時間がかかるので、なにか退屈しのぎでもしていてください。
</p>

<pre caption = "システムのビルド">
# <i>emerge --emptytree system</i>
</pre>

<p>
繰り返しますが、CFLAGSとCXXFLAGSの初期設定を変更していないなら、<c>--newuse</c>を使用するだけで十分です。
</p>

<p>
更新された設定ファイル(と<c>etc-update</c>の実行)に関するすべての警告は、今のところ無視してもかまいません。ただし、Gentooシステムが完全にインストールされたら、必ず<uri
link="?part=3&amp;chap=2#doc_chap3">ファイルの保護設定</uri>を読んでください。
</p>

<p>
ビルドが完了したら、<uri
link="?part=1&amp;chap=7">カーネルの設定</uri>へ進んでください。
</p>

</body>
</subsection>
</section>

</sections>

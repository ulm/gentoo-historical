<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sections SYSTEM "/dtd/book.dtd">

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/1.0 -->

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/handbook/hb-install-system.xml,v 1.21 2006/02/05 13:35:47 idani Exp $ -->

<!-- Original revision: 1.88 -->
<!-- Translator: igarashi -->

<sections>

<version>2.15</version>
<date>2006-01-19</date>

<section>
<title>chrootする</title>
<subsection>
<title>自由選択: ミラーサイトの選択</title>
<body>

<p>
すばやくソースコードをダウンロードするために、一番回線速度が速いミラーサイトを選択することをお勧めします。
Portageは、GENTOO_MIRRORS変数を<path>make.conf</path>ファイルから参照し、その変数に羅列されいているミラーサイトを使用します。
Gentooサイトの<uri link="/main/en/mirrors.xml">mirror list</uri>
<uri link="/main/ja/mirrors.xml">(日本語訳)</uri>を参照し、(高確率で一番速いサイトとしての)一番近い一つのミラーサイト(もしくは複数のミラーサイト)を探すことができます。
しかし、お望みのミラーサイトを選択するのに使いやすいインターフェースを備える<c>mirrorselect</c>というすばらしいツールを提供しています。
</p>

<pre caption="GENTOO_MIRRORS変数用にmirrorselectを使用する">
# <i>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<warn>
どのIPv6ミラーサイトも選択してはいけません。現在stageファイルは、IPv6をサポートしていません。
</warn>

<p>
<path>make.conf</path>での2番目に重要な設定は、SYNC変数の設定です。
この変数には、Portageツリーを更新するときに使用したいrsyncサーバを設定します。
(Portageツリーとは、Portageがソフトウェアをダウンロードしてインストールのに必要な情報の全てが書かれているebuildや、スクリプトの集まりです。)
自分でSYNCサーバを手作業で指定できますが、<c>mirrorselect</c>はその作業を以下のように簡単にします。
</p>

<pre caption="mirrorselectを使ってrsyncミラーを選択する">
# <i>mirrorselect -i -r -o &gt;&gt; /mnt/gentoo/etc/make.conf</i>
</pre>

<p>
<c>mirrorselect</c>を実行した後、<path>/mnt/gentoo/etc/make.conf</path>内の設定が重複していないかを確認したほうがよいでしょう。
</p>

</body>
</subsection>
<subsection>
<title>DNS情報をコピーする</title>
<body>

<p>
新しい環境に入る前にしなければならないことが、まだ一つ残っています。
それは、新しい環境でもネットワーク環境が確実に動くようにするために、
<path>/etc/resolv.conf</path>にあるDNS情報を、新しい環境にコピーすることです。
<path>/etc/resolv.conf</path>にはあなたのネットワーク環境における
ネームサーバーの情報が含まれています。
</p>

<pre caption="DNS情報をコピーする">
<comment>("-L"オプションは、シンボリックリンクをコピーしないようにするために必要です)</comment>
# <i>cp -L /etc/resolv.conf /mnt/gentoo/etc/resolv.conf</i>
</pre>

</body>
</subsection>
<subsection>
<title>/procと/devファイルシステムのマウント</title>
<body>

<p>
chroot後の環境でもカーネルが提供する情報を参照できるようにするために、<path>/mnt/gentoo/proc</path>に<path>/proc</path>ファイルシステムをマウントしてください。
そして、<path>/dev</path>ファイルシステムをbindマウントします。
</p>

<pre caption="/procと/devのマウント">
# <i>mount -t proc none /mnt/gentoo/proc</i>
# <i>mount -o bind /dev /mnt/gentoo/dev</i>
</pre>

</body>
</subsection>
<subsection>
<title>新しい環境に入る</title>
<body>

<p>
さて、全てのパーティションは初期化され、ベース環境はインストールされました。
ついに、あなたは<e>chroot</e>により新たにインストールされた環境に入ります。
これは、現在のインストーラの環境(インストールCDやその他のインストールメディア)から、
あなたのインストールした環境(すなわち初期化されたパーティション)に移行することを意味します。
</p>

<p>
このchrootの過程は3段階のステップからなります。
まず最初に、<c>chroot</c>によって、ルートディレクトリを(インストールメディア上の)<path>/</path> から、(あなたのパーティション上にある)<path>/mnt/gentoo</path>に変更します。次に、システムファイルの環境変数を更新するコマンドenv-updateを使って、新しい環境をつくります。最後に、<c>source</c>コマンドでこれらの変数をメモリ上に読み込みます。
</p>

<pre caption = "新しい環境にchrootする">
# <i>chroot /mnt/gentoo /bin/bash</i>
# <i>env-update</i>
 * Caching service dependencies...
# <i>source /etc/profile</i>
# <i>export PS1="(chroot) $PS1"</i>
</pre>

<p>
おめでとうございます!あなたは自分のGentoo Linux環境に入ることができました。
もちろん、まだいくつかのセクションが残っており、完了までは程遠いのですが:-)
</p>

</body>
</subsection>
</section>

<section>
<title>Portageシステムの設定</title>
<subsection>
<title>Portageツリーの更新</title>
<body>

<p>
ここで、Portageツリーを最新状態に更新すべきです。
<c>emerge --sync</c>が、これを行います。
</p>

<pre caption="Portageツリーの更新">
# <i>emerge --sync</i>
<comment>(一部のフレームバッファやシリアルコンソールなどの低速な端末を使用している場合、この工程にかかる時間を短くするために、--quietオプションを以下のように追加してもよいです。)</comment>
# <i>emerge --sync --quiet</i>
</pre>

<p>
rsync通信を遮断してしまうファイアウォールの環境内にいる場合は、代わりに<c>emerge-webrsync</c>を使用します。それは、portageのスナップショットをダウンロードしてインストールします。
</p>

<p>
Portageの新しいバージョンが利用可能で、新しいものに更新すべきであることを警告されても、無視してください。Portageは、後々のインストール作業中にアップデートされます。
</p>

</body>
</subsection>
<subsection>
<title>適切なprofileの選択</title>
<body>

<p>
まず、所定の位置にあるちょっとした定義について説明します。
</p>

<p>
profileは、すべてのGentooシステムにとって根幹を成すものです。
CHOST、CFLAGSやその他の重要な変数の初期設定値を指定しているだけでなく、
システムの状態を特定範囲内のパッケージバージョンに留めておく役目もあります。
これは、Gentoo開発者によってすべて整備されています。
</p>

<p>
以前は、ユーザがprofileを変更することは、ほとんどありませんでした。
しかし、現在はx86、hppa、alphaユーザは二つのprofileのうち一つを選ぶことができます。
一つは2.4カーネル用で、もう一つは2.6カーネル用です。
この要件は、2.6カーネルの統合を整備するために必要とされました。
ppcとppc64アーキテクチャも同様にいくつかのprofileが利用可能です。
これについては後で説明します。
</p>

<p>
以下のコマンドで、現在使用中のprofileが何であるかを確認することができます。
</p>

<pre caption="システムprofileの確認">
# <i>ls -FGg /etc/make.profile</i>
lrwxrwxrwx  1 48 Apr  8 18:51 /etc/make.profile -> ../usr/portage/profiles/default-linux/x86/2005.1/
</pre>

<p>
上記三つのアーキテクチャのうちの一つを使用しているなら、デフォルトのprofileはLinux 2.6系システムのものを提供します。
これは推奨設定ですが、もちろん別のprofileを使うこともできます。
</p>

<p>
より古いLinux 2.4系のprofileを使用したシステムをインストールしたいと思うユーザもいるでしょう。
このようにするもっともな理由があるユーザは、添付されているprofileの存在を最初に確認してください。x86上では、以下のコマンドで確認できます。
</p>

<pre caption="添付されているprofileが存在するかどうかの確認">
# <i>ls -d /usr/portage/profiles/default-linux/x86/no-nptl/2.4</i>
/usr/portage/profiles/default-linux/x86/no-nptl/2.4
</pre>

<p>
上記の例では、2.4系のprofileがあることを示しています
(つまり、ファイルやディレクトリが見つからないというエラーは表示されていません)。
デフォルトのままにしておくことが推奨されますが、変更したいなら、以下のようにします。
</p>

<pre caption="2.4 profileに変更する">
<comment>(使用しているアーキテクチャであることを確認してください。以下の例はx86向けです。)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/x86/no-nptl/2.4 /etc/make.profile</i>
<comment>(2.4 profileにあるファイルの表示)</comment>
# <i>ls -FGg /etc/make.profile/</i>
total 12
-rw-r--r--  1 939 Dec 10 14:06 packages
-rw-r--r--  1 347 Dec  3  2004 parent
-rw-r--r--  1 573 Dec  3  2004 virtuals
</pre>

<p>
2005.1には、ppc用に複数の新しいprofileがあります。
</p>

<pre caption="PPCのprofile">
<comment>(一般的なPPCのprofileで、すべてのPPCマシン用です)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc /etc/make.profile</i>
<comment>(G3のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G3 /etc/make.profile</i>
<comment>(G3 Pegasosのprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G3/Pegasos/ /etc/make.profile</i>
<comment>(G4 (Altivec)のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G4 /etc/make.profile</i>
<comment>(G4 Pegasosのprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc/G4/Pegasos/ /etc/make.profile</i>
</pre>

<p>
2005.1には、ppc64用に複数の新しいprofileがあります。
</p>

<pre caption="PPC64のprofile">
<comment>(一般的な64bitユーザランドPPC64のprofileで、すべてのPPC64マシン用です)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/64bit-userland /etc/make.profile</i>
<comment>(一般的な32bitユーザランドPPC64のprofileで、すべてのPPC64マシン用です)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/32bit-userland /etc/make.profile</i>
<comment>(各ユーザランド用には以下のようにサブprofileがあり、上記から選んだユーザランドで(userland)を置き換えます)</comment>
<comment>(JS20用の970のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/970 /etc/make.profile</i>
<comment>(G5のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/970/pmac /etc/make.profile</i>
<comment>(POWER3のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/power3 /etc/make.profile</i>
<comment>(POWER4のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/power4 /etc/make.profile</i>
<comment>(POWER5のprofile)</comment>
# <i>ln -snf /usr/portage/profiles/default-linux/ppc/2005.1/ppc64/(userland)/power5 /etc/make.profile</i>
<comment>(multilibのprofileは、現在のリリースの時点では安定版ではありません。)</comment>
</pre>

</body>
</subsection>
<subsection id="configure_USE">
<title>USE変数の設定</title>
<body>

<p>
<c>USE</c>はGentooがユーザに提供する最もパワフルな変数の一つです。
プログラムの中には、特定のフラグを設定することによって、副次的なサポートを有効にしたり無効にしたりできるものがあります。
たとえばGTKサポートもしくはQtサポートを有効にしてコンパイルすることができるプログラムがあります。他には、SSLサポートを有効にするか無効にするか、
X11サポート(X-server)の替わりにフレームバッファサポート(svgalib)
を有効にするか、などがあります。
</p>

<p>
多くのディストリビューションは、パッケージをありったけのサポートを有効にしてコンパイルしているため、依存関係が膨大になってしまっていることは言うまでもなく、
プログラムのサイズや起動時間までも増大させてしまっています。
Gentooならば、パッケージをコンパイルするときにつけるべきオプションを
自分で定義することができます。これには<c>USE</c>フラグが一役買っています。
</p>

<p>
<c>USE</c>変数には、コンパイルオプションに対応するキーワードを定義します。
たとえば、<e>ssl</e>はプログラムに備わるSSLサポートをコンパイルします。
<e>-X</e>はXサーバのサポートを削除します。(キーワードの前にマイナス記号をつけます。)<e>gnome gtk -kde -qt</e>は、GNOME(とGTK)サポートを有効にし、KDE(とQt)サポートを無効にしてプログラムをコンパイルします。システムを完全にGNOME向けに調整します。
</p>

<p>
初期の<c>USE</c>設定は、使用しているprofileの<path>make.defaults</path>ファイルにあります。
<path>make.defaults</path>は、<path>/etc/make.profile</path>シンボリックリンクが指すディレクトリと、同じくすべてのその親ディレクトリで見つかります。
初期の<c>USE</c>設定は、それら<path>make.defaults</path>ファイルのすべての<c>USE</c>設定を組み合わせたものになります。
<path>/etc/make.conf</path>に記述した内容は、これらの初期設定に反映されます。
もし<c>USE</c>設定に何かを追加した場合、それは初期設定リストに追加されます。
もし何かを(マイナス記号を頭につけることで)USE設定から取り除いた場合、
それは(リストにあれば)初期設定リストから取り除かれます。
<e>決して</e>、<path>/etc/make.profile</path>ディレクトリ以下の内容を変更しないでください。Portageをアップデートするときに、上書きされてしまいます!
</p>

<p>
Gentooハンドブックの第二部にある<uri link="?part=2&amp;chap=2">USEフラグ</uri>に、<c>USE</c>についての詳細な解説があります。また、システムにある<path>/usr/portage/profiles/use.desc</path>に、使用可能なUSEフラグについての詳細な解説があります。
</p>

<pre caption="使用可能なUSEフラグの参照">
# <i>less /usr/portage/profiles/use.desc</i>
<comment>(矢印キーを使用してスクロールし、'q'キーで終了します)</comment>
</pre>

<p>
DVD、ALSA、CD-Rサポートを含むKDEベースのシステムのための<c>USE</c>フラグの例を以下に示します。
</p>

<pre caption="/etc/make.confを開く">
# <i>nano -w /etc/make.conf</i>
</pre>

<pre caption="USEフラグの設定">
USE="-gtk -gnome qt kde dvd alsa cdr"
</pre>

</body>
</subsection>
<subsection>
<title>自由選択: GLIBCのロケール</title>
<body>

<p>
あなたは、おそらくシステムで一つないし二つのロケールだけしか使用しないでしょう。これまでは<c>glibc</c>のコンパイルの後で、全ての使用可能なロケールのフルセットが生成されていました。現在は、<c>userlocales</c> USEフラグを有効にして、<path>/etc/locales.build</path>に必要とするロケールだけを指定できます。これは、どのロケールを選択すべきかが分かっている場合にだけ、行ってください。
</p>

<pre caption="glibc用のuserlocales USEフラグを有効にする">
# <i>mkdir -p /etc/portage</i>
# <i>echo "sys-libs/glibc userlocales" >> /etc/portage/package.use</i>
</pre>

<p>
それでは、以下のように使用したいロケールを指定してください。
</p>

<pre caption="/etc/locales.buildを開く">
# <i>nano -w /etc/locales.build</i>
</pre>

<p>
以下のロケール指定は、関連する文字符号(UTF-8のような)を含む、英語(アメリカ)とドイツ語(ドイツ)ロケールを生成する例です。(訳注: 日本語訳には日本語に関するロケールも追加しています。)
</p>

<pre caption="ロケールの指定">
en_US/ISO-8859-1
en_US.UTF-8/UTF-8
de_DE/ISO-8859-1
de_DE@euro/ISO-8859-15
ja_JP.EUC-JP/EUC-JP
ja_JP.UTF-8/UTF-8
ja_JP/EUC-JP
</pre>

<p>
では、<uri link="?part=1&amp;chap=7">カーネル設定</uri>へ進んでください。
</p>

</body>
</subsection>
</section>

</sections>

<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/rsync.xml,v 1.3 2004/03/11 23:30:11 nakano Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/ja/rsync.xml">
<title>Gentoo Linux rsyncミラーリングポリシー</title>
<author title="Author">
  <mail link="mirror-admin@gentoo.org">Gentoo Mirror Administrators</mail>
</author>
<author title="翻訳">
  <mail link="hiro@extreme.jpseed.jp">武田洋之</mail>
</author>

<abstract>
  このドキュメントは、公式なrsyncミラーの構築の仕方を説明しています．
</abstract>
  	 
<license/>

<version>1.3</version>
<date>February 23, 2004</date>
<!-- Original revision: 1.24 -->


<chapter>
<title>必要なもの</title>
<section>
<title>最低限の帯域</title>
<body>
<p>
ミラーが正しく機能する為には、最低でも5Mbpsのフルデュプレックスな帯域幅が必要です。
</p>
</body>
</section>
<section>
<title>最低限のユーザー接続数</title>
<body>
<p>
わたしたちは、最低でも同時に15人分のユーザー接続のサポートを要求します。
</p>
</body>
</section>
<section>
<title>最低限のハードウェア</title>
<body>
<p>
少なくとも同時に15人分のユーザー接続を効果的に提供する為には、わたしたちは、少なくとも次の最低限のハードウェアを要求します:
</p>
<ul>
	<li>PIII 500 Processor</li>
	<li>256MB RAM</li>
</ul>
</body>
</section>
<section>
<title>更新頻度</title>
<body>
<p>
更新は、一日24時間、毎時00分と30分に行われなければなりません。このスケージュールに厳密に従う事が<e>とても</e>重要です。というのは、ユーザーがrsyncサーバーを選択するのにラウンドロビンなDNSを使用しているからです。
</p> 
</body>
</section>
<section>
<title>MOTD (<path>/etc/rsync/rsyncd.motd</path>)</title>
<body>
<p>
あなたのrsync MOTDファイルに次の情報を含めてください:
</p>
<ul>
	<li>サーバー名</li>
	<li>サーバーのIPアドレス</li>
	<li>サーバーのスペック(CPUとRAM)</li>
	<li>サーバーの利用可能な帯域幅</li>
	<li>もしあればユーザー接続数の制限</li>
	<li>サーバーの場所(街や国)</li>
	<li>連絡するときの名前とemailアドレス</li>
</ul>
<p>
上記の情報をMOTDファイルに書き込んでおけば、問題があったときに、それがあなたのミラーだと簡単に特定することができます。
</p>
</body>
</section>
</chapter>
<chapter>
<title>実施するにあたっての詳細</title>
<section>
<body>
<p>
新しいミラーを立ち上げるために、次の手順を実施してください:
</p>
<ul>
<li>
  あなたのミラーを存在する、公式のGentoo Linux rsyncミラーと同期するよう設定してください。どこと同期させてもかまいません。前述した<e>更新周期</e>に確実に従うようにしてください。
</li>
<li>
  サーバー名、IPアドレス、連絡方法、そして新しいrsyncミラーになりたい旨を含むバクレポートを<uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri>で記入してください。わたしたちは、あなたのサーバーが適切に同期できているか確認します。1時間に2回同期を取ることが重要です。1度目は00分から10分の間、2度目は30分から40分の間に同期するようにします。この10分の間であれば好きな時刻で同期をとるように設定してかまいません。
</li>
<li>
  もしミラーが適切に同期されていることが確認できたら、サーバーのIPアドレスをrsync1.us.gentoo.orgのアクセスリストに追加します。
</li>
<li>
  rsync cronジョブが<path>rsync1.us.gentoo.org</path>を指すように更新してください。わたしたちは、次の48-72時間の間、適切に同期がとれているかどうか、あなたのサーバーを監視します。
</li>
</ul>

<p>
もしすべての手順が順調にいったら、公式のrsync[num].[countrycode].gentoo.org DNSエントリを作成し、あなたのサーバーをrsync.[continentcode].gentoo.orgとrsync.[countrycode].gentoo.orgに対するDNSラウンドロビンとして追加します。簡単に言うと、わたしたちのDNSに追加された後は、あなたのサーバーでrsyncトラフィックを観測するようになるでしょう。
</p>

<p>
さらに、ミラーの管理者であるあなたは、rsyncミラーに関係するあらゆる問題に追従することができるように、gentoo-mirrorsメーリングリスト(それほど流量はない)に追加されます。
</p>
<note>
Gentoo Linuxユーザーと開発者を支援していただけることに感謝します! :) rsyncの管理上の問題がある場合、それがどんなものであっても、http://bugs.gentoo.orgを訪れて"Rsync"カテゴリにバグとして記入してください。
</note>
</body>
</section>
</chapter>
<chapter>
<title>関連事項</title>
<section>
<body>
<p>
わたしたちは、簡潔な、公式のrsyncサーバーの稼動状況のグラフ(地域、国、サーバーの順に並べられた)へリンクを持つページをもうじきrrdtoolによって作成するつもりです。 (これらのグラフは、spingによって生成されるでしょう(訳注:spingは、ベクターグラフィックス生成用のpythonモジュールの一つ)。)
わたしたちは、これらのグラフを少なくとも1日1回はチェックする予定で、到達不可能な装置は問題が解決するまでRR DNSスキーマから外すようにします。
30分ごとにすべてのミラーが実際に同期が取れているかどうかをチェックするスクリプトを作る予定です。
</p>
<warn>
もしミラーが何度もに問題があるような動作をするなら、その管理者に連絡を取り、状況が改善されないようなら、そのミラーサイトはラウンドロビンスキーマからずっと外してしまうでしょう。
</warn>
</body>
</section>
</chapter>
<chapter>
<title>ちょっとしたFAQ</title>
<section>
<title>Q: rsyncに関する問題や保守について、誰に連絡を取ればよいでしょうか?</title>
<body>
<p>A: http://bugs.gentoo.orgを訪れて、"Rsync"カテゴリにバグとして記入してください。</p>
</body>
</section>
<section>
<title>Q: プライベートなrsyncミラーを自社の為に運用しているのですが、それでも、わたしはrsync1.us.gentoo.org?にアクセス可能でしょうか?</title>
<body>
<p>A: わたしたちの資源は限られていますので、ユーザーに最大限の利益を提供する為に、その限られた中で資源を割り振っていく必要があります。
その為、マスターrsyncおよびdistfileミラーへの接続を一般公開mirrorだけに制限しています。
ユーザーがプライベートなrsyncミラーを設置する為に、正規のミラーシステムを使用することは歓迎しますが、基本的に<uri link="http://www.gentoo.org/news/ja/gwn/20030505-newsletter.xml#doc_chap1_sect3">rsyncの利用に関するガイドライン</uri>に従うことが求められます。
</p>
</body>
</section>
<section>
<title>Q: 1時簡に2回、ミラーを同期させることは重要なのでしょうか?</title>
<body>
<p>A: はい、重要です。 00分、30分きっかりに同期させる必要はありませんが、次の2つの期間に同期するようにしなければなりません。
</p>
<ol>
	<li>00分と10分の間</li>
	<li>30分と40分の間</li>
</ol>
<p>さらに、30分ごとに同期をとるようにしてください。もし最初の同期を08分にとることにしたら、次の同期は38分にとるようにしてください。
</p>
</body>
</section>
<section>
<title>Q: 最も近いミラーをどのように探せばよいでしょうか?</title>
<body>
<p>A: これを実現する為にnetselectが開発されました。まだ<c>emerge netselect</c>を実行していないのなら、実行してみてください。
そして、<c>netselect rsync.gentoo.org</c>と実行してみてください。1分程度でnetselectはIP addressを表示するでしょう。
このIPアドレスを控えておき、コロン(:)を二つ付け加えてrsyncの唯一のパラメータとして使用してください。例えば:<c>rsync 1.2.3.4::</c>
バナーメッセージからどのミラーなのか知ることができるでしょう。/etc/make.confの方も相応に更新してください。
</p>
</body>
</section>
<section>
<title>Q: rsync1.us.gentoo.orgと同期するときに圧縮転送を使うことができますか?</title>
<body>
<p>A: いいえ。圧縮転送はサーバーの資源を消費しすぎるので、<path>rsync1.us.gentoo.org</path>では強制的に無効にしています。このサーバーに対して同期するときに、圧縮転送をしようと<b>しないで</b>ください。
</p>
</body>
</section>
<section>
<title>Q: 古い、あるいは、恐らく死んだrsyncプロセスをたくさん参照しているようです。どうすればこれを取り除けますか?</title>
<body>
<p>A: スクリプトの例のセクションを見てください。
</p>
</body>
</section>
<section>
<title>Q: rsyncサーバーに<b>非常に</b>頻繁に接続してくるユーザーがたくさんいます。これが原因で、私のミラーは、ときどきサービスが正常に提供できなくなる場合があります。これを回避する方法はありますか?</title>
<body>
<p>A: スクリプトの例のセクションを見てください。
</p>
</body>
</section>
</chapter>
<chapter>
<title>スクリプトの例</title>
<section>
<body>
<p>現在のところ、わたしたちのPortageツリーをミラーリングするのには250MB程度が必要ですが、これはそれほど大した容量ではありません。容量が増えたときの為に、少なくとも500MBの空きがあったほうが良いでしょう。portageツリーのミラーを構築するのは簡単です -- まず、ミラーにrsyncがインストールされていることを確認してください。次に、後に示すようにrsyncd.confファイルを編集します:</p>
<pre caption="rsyncd.conf">
uid = nobody
gid = nobody
use chroot = yes
max connections = 15
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
log file = /var/log/rsync.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#このエントリは互換性の為にあります
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree


[gentoo-portage]
#最近のバージョンのportageはこのエントリを使います
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>
<p>上記で、gentoo-x86-portageミラーは、gentoo-portageと同じデータを指しています。
わたしたちは、最近ミラーの公式な名前をgentoo-portageに変えましたが、gentoo-x86-portageは後方互換性の為にまだ必要ですので、両方のエントリーを書いておいてください。</p>
<p>セキュリティ的な理由から、chroot環境を使うことが必須です!</p>
<p>Gentoo Linux portageツリーのミラーが必要です。次のスクリプトを使うことができます: </p>
<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=300"
#rsync1.us.gentoo.orgへのアクセスを許されたときだけ、次の行のコメントを外してください。
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#もし、わたしたちのマスターミラーへのアクセス許可を待っているなら、どこからミラーするのか、わたしたちのミラーのひとつから選択してください:
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>
<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2 or later
# $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/rsync.xml,v 1.3 2004/03/11 23:30:11 nakano Exp $

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --timeout=300"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>
<p>あなたのrsyncd.motdには、あなたのIPアドレスやportageミラーを提供している旨、管理者への連絡方法等のあなたのミラーに関係する情報が含まれているでしょう。
公式なrsyncミラーとして承認されたら、あなたのホストは、次の形式の名前でエイリアスされるでしょう:
<path>rsync[num].[country code].gentoo.org</path>
</p>
<p>次のコマンドは、接続の問題などが原因でときどき残ってしまう古いrsyncプロセスを殺すのに役立つでしょう。古いプロセスは、'max connections'オプションで指定した最大値を計算する際に、正常な接続として数えられてしまうので、これらを殺すことは重要です。このコマンドを1時間に1回、cronで実行すれば、1時間以上前の古いrsyncプロセスを探し出して殺してくれます。
</p>
<pre>
/bin/kill -9 `/bin/ps --no-headers -Crsync -o etime,user,pid,command|/bin/grep nobody | \
	/bin/grep "[0-9]\{2\}:[0-9]\{2\}:" |/bin/awk '{print $3}'`
</pre>
<p>1日に1-2回以上も同期するような、rsyncミラーを乱用している非常識なユーザーも時々います。極端な場合では、15分程度に1回、cronでスケージューリングしている場合もあります。他のユーザーに割り当てられるはずのrsyncの接続を占有してしまうことによって、DoS攻撃のようになってしまう場合があります。これを避けるには、次の<uri link="/proj/en/infrastructure/mirrors/rsyncd.conf_pl.txt">perlスクリプト</uri>を試してみることができます。このスクリプトは、rsyncログを捜査し、その日に<c>N</c>回以上既に接続しているIPアドレスを抜き出して、'hosts deny'ディレクティブにその不愉快なIPアドレスを追加したrsyncd.confファイルを動的に生成します。次の行で、<c>N</c>回の部分を設定できます。
</p>
<pre>
@badhosts=grep {$hash{$_}>4} keys %hash;
</pre>
<p>このスクリプトを使う場合には、忘れずにrsyncログファイルを毎日ローテートするようにし、スクリプト内でrsyncd.confの適切な場所を指定してください。このスクリプトはGentoo Linuxでテストされましたが、rsyncとperlが動作する他のマシンでもうまく動作するでしょう。
</p>
</body>
</section>
</chapter>
</guide>

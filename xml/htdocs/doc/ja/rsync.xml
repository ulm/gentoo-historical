<?xml version='1.0' encoding="UTF-8"?>
<?xml-stylesheet href="/xsl/guide.xsl" type="text/xsl"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/rsync.xml,v 1.1 2004/02/28 14:00:06 nakano Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/ja/rsync.xml">
<title>Gentoo Linux rsyncミラーリングポリシー</title>
<author title="Author">
  <mail link="mirror-admin@gentoo.org">Gentoo Mirror Administrators</mail>
</author>
<author title="翻訳">
  <mail link="hiro@extreme.jpseed.jp">武田洋之</mail>
</author>

<abstract>
  このドキュメントは、公式なrsyncミラーの構築の仕方を説明しています．
</abstract>
  	 
<license/>

<version>1.2</version>
<date>December 28, 2003</date>
<!-- Original revision: 1.22 -->


<chapter>
<title>必要なもの</title>
<section>
<title>最低限の帯域</title>
<body>
<p>
ミラーが正しく機能する為には、最低でも5Mbpsのフルデュプレックスな帯域幅が必要です。
</p>
</body>
</section>
<section>
<title>最低限のユーザー接続数</title>
<body>
<p>
わたしたちは、最低でも同時に15人分のユーザー接続のサポートを要求します。
</p>
</body>
</section>
<section>
<title>最低限のハードウェア</title>
<body>
<p>
少なくとも同時に15人分のユーザー接続を効果的に提供する為には、わたしたちは、少なくとも次の最低限のハードウェアを要求します:
</p>
<ul>
	<li>PIII 500 Processor</li>
	<li>256MB RAM</li>
</ul>
</body>
</section>
<section>
<title>更新頻度</title>
<body>
<p>
更新は、一日24時間、毎時00分と30分に行われなければなりません。このスケージュールに厳密に従う事が<e>とても</e>重要です。というのは、ユーザーがrsyncサーバーを選択するのにラウンドロビンなDNSを使用しているからです。
</p> 
<impo>これは厳格に実施されなければなりません。この種の設定がずれた同期サーバーは、その処理過程において、すべてのサーバーを巻き込み、極めて巨大なトラフィックを生み出します。(詳細は、後述される<uri link="rsync.xml#doc_chap4_sect3">FAQ</uri>を見てください。)
</impo>
</body>
</section>
<section>
<title>MOTD (<path>/etc/rsync/rsyncd.motd</path>)</title>
<body>
<p>
あなたのrsync MOTDファイルに次の情報を含めてください:
</p>
<ul>
	<li>サーバー名</li>
	<li>サーバーのIPアドレス</li>
	<li>サーバーのスペック(CPUとRAM)</li>
	<li>サーバーの利用可能な帯域幅</li>
	<li>もしあればユーザー接続数の制限</li>
	<li>サーバーの場所(街や国)</li>
	<li>連絡するときの名前とemailアドレス</li>
</ul>
<p>
上記の情報をMOTDファイルに書き込んでおけば、問題があったときに、それがあなたのミラーだと簡単に特定することができます。
</p>
</body>
</section>
</chapter>
<chapter>
<title>実施するにあたっての詳細</title>
<section>
<body>
<p>
新しいミラーを立ち上げるために、次の手順を実施してください:
</p>
<ul>
<li>
  あなたのミラーを存在する、公式のGentoo Linux rsyncミラーと同期するよう設定してください。どこと同期させてもかまいません。前述した<e>更新周期</e>に確実に従うようにしてください。
</li>
<li>
  サーバー名、IPアドレス、連絡方法、そして新しいrsyncミラーになりたい旨を含むバクレポートを<uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri>で記入してください。わたしたちは、あなたのサーバーが適切に同期できているか確認します。もしあなたのサーバーが00分と30分に正確に同期できていない場合、あなたに連絡を取り、更新スケージュールを適切なものに修正するよう要請します。
</li>
<li>
  もしミラーが適切に同期されていることが確認できたら、サーバーのIPアドレスをrsync1.us.gentoo.orgのアクセスリストに追加します。
</li>
<li>
  rsync cronジョブが<path>rsync1.us.gentoo.org</path>を指すように更新してください。わたしたちは、次の48-72時間の間、適切に同期がとれているかどうか、あなたのサーバーを監視します。
</li>
</ul>

<p>
もしすべての手順が順調にいったら、公式のrsync[num].[countrycode].gentoo.org DNSエントリを作成し、あなたのサーバーをrsync.gentoo.orgとrsync.[countrycode].gentoo.orgに対するDNSラウンドロビンとして追加します。簡単に言うと、わたしたちのDNSに追加された後は、あなたのサーバーでrsyncトラフィックを観測するようになるでしょう。
</p>

<p>
さらに、ミラーの管理者であるあなたは、rsyncミラーに関係するあらゆる問題に追従することができるように、gentoo-mirrorsメーリングリスト(それほど流量はない)に追加されます。
</p>
<note>
Gentoo Linuxユーザーと開発者を支援していただけることに感謝します! :) rsyncの管理上の問題がある場合、それがどんなものであっても、http://bugs.gentoo.orgを訪れて"Rsync"カテゴリにバグとして記入してください。
</note>
</body>
</section>
</chapter>
<chapter>
<title>関連事項</title>
<section>
<body>
<p>
わたしたちは、簡潔な、公式のrsyncサーバーの稼動状況のグラフ(地域、国、サーバーの順に並べられた)へリンクを持つページをもうじきrrdtoolによって作成するつもりです。 (これらのグラフは、spingによって生成されるでしょう(訳注:spingは、ベクターグラフィックス生成用のpythonモジュールの一つ)。)
わたしたちは、これらのグラフを少なくとも1日1回はチェックする予定で、到達不可能な装置は問題が解決するまでRR DNSスキーマから外すようにします。
30分ごとにすべてのミラーが実際に同期が取れているかどうかをチェックするスクリプトを作る予定です。
</p>
<warn>
もしミラーが何度もに問題があるような動作をするなら、その管理者に連絡を取り、状況が改善されないようなら、そのミラーサイトはラウンドロビンスキーマからずっと外してしまうでしょう。
</warn>
</body>
</section>
</chapter>
<chapter>
<title>ちょっとしたFAQ</title>
<section>
<title>Q: rsyncに関する問題や保守について、誰に連絡を取ればよいでしょうか?</title>
<body>
<p>A: http://bugs.gentoo.orgを訪れて、"Rsync"カテゴリにバグとして記入してください。</p>
</body>
</section>
<section>
<title>Q: プライベートなrsyncミラーを自社の為に運用しているのですが、それでも、わたしはrsync1.us.gentoo.org?にアクセス可能でしょうか?</title>
<body>
<p>A: わたしたちの資源は限られていますので、ユーザーに最大限の利益を提供する為に、その限られた中で資源を割り振っていく必要があります。
その為、マスターrsyncおよびdistfileミラーへの接続を一般公開mirrorだけに制限しています。
ユーザーがプライベートなrsyncミラーを設置する為に、正規のミラーシステムを使用することは歓迎しますが、基本的に<uri link="http://www.gentoo.org/news/ja/gwn/20030505-newsletter.xml#doc_chap1_sect3">rsyncの利用に関するガイドライン</uri>に従うことが求められます。
</p>
</body>
</section>
<section>
<title>Q: 毎時00分と30分にミラーを同期させることは重要なのでしょうか?</title>
<body>
<p>A: はい、重要です。 各ユーザーはrsyncミラーとrsyncし、ファイルシステムとミラーの差分を転送します。
もしあなたのミラーが同期が取れておらず、ユーザーがラウンドロビンなホスト名を使用している場合、ユーザー、あなたのミラーおよび他のすべてのミラーが必要とする帯域幅を増加させてしまいます。

例えば:

あるユーザーが<path>rsync://rsync.gentoo.org/gentoo-portage</path>とrsyncする設定をしていたとします。

<path>rsync.gentoo.org</path>は、<path>rsync1.gentoo.org</path>、<path>rsync2.gentoo.org</path>、<path>rsync3.gentoo.org</path>へのDNSラウンドロビンである事にします。

そして、rsync1とrsync3は推奨される時間に同期していますが、rsync2だけが夜中に1度しか同期を取らないものとし、今が午後だとします。
</p>
<ol>
<li>rsync1同期したあるユーザーが、/usr/portageツリーの最新を取得します。これに5MBの帯域を使うものとします。</li>
<li>そのユーザーが再び、このときはrsync2に対して同期したとします。このときは、portageをもはや最新ではないものにしてしまうだけで、ステップ1でportageを最新にする使用された帯域は無かったことに(無駄に)なってしまします。その差は5MBです。</li>
<li>そのユーザーが、今度はrsync3に同期したとすると、portageツリーを再び最新のものにしてしまいます。これは、rsync2が古いバージョンのportageツリーを持っているせいで、ユーザーは5MBをもう一度転送しなければなりません。</li>
</ol>
<p>上記の例では、ユーザーは必要な量の３倍である、5MB * 3 = 15MBの帯域を使用しました。そして、そのユーザーのGentoo Portageシステムに対する全体的な印象派悪くなるでしょう。

また、もしrsync2が現在同期しているサーバーだとすると、rsync2およびrsync3は共に必要な量より5MBも多く転送したことになります。

これはユーザーが使用しているDNSラウンドロビンの数だけ乗算され、ただ多くの帯域を浪費することになるのです。
そして、あなたのミラーだけでなく他のすべてのミラーの帯域を増大させることになります。

わたしたちは各ミラー間で常にいくらかの時差があり、各ミラーが厳密に同時には同期し得ないことは理解しています。
その時差をできるだけ小さくする為に、NTPデーモンを起動しておくことをお薦めします。

それでもntpdを起動しないというなら、同期が取れていないと責められた場合に、あなたのサーバーの時刻が正確で、世界と同期が取れているということを示す為には、ログファイルが極めて重要になるということは知っておいた方が良いでしょう。

もし、常時ntpdを起動していたくないならば、ntpdateをcronによって少なくとも１日１度は実行することを考えてください。
</p>
</body>
</section>
<section>
<title>Q: 最も近いミラーをどのように探せばよいでしょうか?</title>
<body>
<p>A: これを実現する為にnetselectが開発されました。まだ<c>emerge netselect</c>を実行していないのなら、実行してみてください。
そして、<c>netselect rsync.gentoo.org</c>と実行してみてください。1分程度でnetselectはIP addressを表示するでしょう。
このIPアドレスを控えておき、コロン(:)を二つ付け加えてrsyncの唯一のパラメータとして使用してください。例えば:<c>rsync 1.2.3.4::</c>
バナーメッセージからどのミラーなのか知ることができるでしょう。/etc/make.confの方も相応に更新してください。
</p>
</body>
</section>
<section>
<title>Q: rsync1.us.gentoo.orgと同期するときに圧縮転送を使うことができますか?</title>
<body>
<p>A: いいえ。圧縮転送はサーバーの資源を消費しすぎるので、<path>rsync1.us.gentoo.org</path>では強制的に無効にしています。このサーバーに対して同期するときに、圧縮転送をしようと<b>しないで</b>ください。
</p>
</body>
</section>
</chapter>
<chapter>
<title>スクリプトの例</title>
<section>
<body>
<p>現在のところ、わたしたちのPortageツリーをミラーリングするのには60MB程度が必要ですが、これはそれほど大した容量ではありません。容量が増えたときの為に、少なくとも200MBの空きがあったほうが良いでしょう。portageツリーのミラーを構築するのは簡単です -- まず、ミラーにrsyncがインストールされていることを確認してください。次に、後に示すようにrsyncd.confファイルを編集します:</p>
<pre caption="rsyncd.conf">
#uid = nobody
#gid = nobody
max connections = 20
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#このエントリは互換性の為にあります
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree


[gentoo-portage]
#最近のバージョンのportageはこのエントリを使います
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>
<p>上記で、gentoo-x86-portageミラーは、gentoo-portageと同じデータを指しています。
わたしたちは、最近ミラーの公式な名前をgentoo-portageに変えましたが、gentoo-x86-portageは後方互換性の為にまだ必要ですので、両方のエントリーを書いておいてください。</p>
<p>セキュリティ的な理由から、chroot環境を使うことが推奨されます!</p>
<p>Gentoo Linux portageツリーのミラーが必要です。次のスクリプトを使うことができます: </p>
<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=600"
#rsync1.us.gentoo.orgへのアクセスを許されたときだけ、次の行のコメントを外してください。
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#もし、わたしたちのマスターミラーへのアクセス許可を待っているなら、どこからミラーするのか、わたしたちのミラーのひとつから選択してください:
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>
<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2 or later
# $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/rsync.xml,v 1.1 2004/02/28 14:00:06 nakano Exp $

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --timeout=1800"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>
<p>あなたのrsyncd.motdには、あなたのIPアドレスやportageミラーを提供している旨、管理者への連絡方法等のあなたのミラーに関係する情報が含まれているでしょう。
公式なrsyncミラーとして承認されたら、あなたのホストは、次の形式の名前でエイリアスされるでしょう:
<path>rsync[num].[country code].gentoo.org</path>
</p>
</body>
</section>
</chapter>
</guide>

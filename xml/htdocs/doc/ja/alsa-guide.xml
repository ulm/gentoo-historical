<?xml version="1.0" encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/ja/alsa-guide.xml,v 1.10 2004/01/03 05:24:18 nakano Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/ja/alsa-guide.xml">
<title>Gentoo Linux ALSA ガイド</title>
<author title="Author">
  <mail link="zu@pandora.be">Vincent Verleye</mail>
</author>
<author title="Author">
  <mail link="g2boojum@gentoo.org">Grant Goodyear</mail>
</author>
<author title="Author">
  <mail link="agenkin@gentoo.org">Arcady Genkin</mail>
</author>
<author title="Editor"><!-- zhen@gentoo.org -->
	John P. Davis
</author>
<author title="Editor">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Editor">
  <mail link="bennyc@gentoo.org">Benny Chuang</mail>
</author>
<author title="Editor">
  <mail link="blubber@gentoo.org">Tiemo Kieft</mail>
</author>
<author title="翻訳">
  <mail link="iwaki_iwaki@hotmail.com">Masanori Iwasaki</mail>
</author>
<author title="翻訳">
  <mail link="yasumichi@users.sourceforge.jp">Yasumichi Akahoshi</mail>
</author>

<license/>

<abstract>
このガイドはGentooLinux上でAdvanced Linux Sound Architecture
(ALSA)の設定方法を解説するものです。
Gentoo Linux Desktop Configuration Guide
はこの題材についてさらなる情報を提供します。
</abstract>

<version>1.3.5</version>
<date>December 31, 2003</date>
<!-- Original revision: 1.24 -->

<chapter>
<title>イントロダクション</title>
<section>
<title>ALSAとは何か？</title>
<body>

<p>
ALSA(Advanced Linux Sound Architecture)とはLinuxのサウンドサブシステムを大幅に書き直すことにより改善するプロジェクトです。
ALSAはLinux kernel 2.6または3.0の早く出荷されたほうに取り込まれると思われます。
</p>

<p>
ALSAはオーディオとMIDIの再生機能をLinuxに提供します。
</p>
 
<p>
<uri>http://www.alsa-project.org</uri>からの引用。
ALSAは次の特徴を持っています。
</p>

<ul>
  <li>
    コンシューマ向けサウンドカードからプロ用のマルチチャンネルオーディオインターフェースまで全てのオーディオインターフェースの効率的サポート
  </li>
  <li>完全にモジュール化されたサウンド・ドライバ</li>
  <li>SMP と thread-safe の設計</li>
  <li>
    アプリケーション・プログラミングを単純化し、
    より高レベルな機能性を提供するユーザ・スペース・ライブラリー(alsa-lib)
  </li>
  <li>
    古いOSS APIのサポートによる大部分のOSSプログラムとのバイナリー互換
  </li> 
</ul>

<p>
その他には、全二重の再生・録音を完全サポート、複数のサウンドカードサポート、
ストリームのハードウェアミキシング、
新しいサウンドカード機能をサポートする広範囲のミキサー …などがあります。
</p>

</body>
</section>
<section>
<title>なぜALSAを利用するのか?</title>
<body>

<p>
もしあなたのサウンドカードがLinuxのカーネルサウンドシステム、
または2.4.xにある商用OSS/4Frontサウンドカードドライバでサポートされているなら、
あなたはサウンドカード用にモジュールをビルドすることができます。
もしそうしたければ<uri link="http://www.tldp.org/HOWTO/Sound-HOWTO/index.html">Linux Sound HOWTO</uri>を読んでください。
</p> 

<p>
しかし、OSS/4Frontドライバーは商用のためなどの理由から、いくつかかの制限があります。
ALSAとは、これらの制限以上の事をオープンソーススタイルですることです。
ALSAはGPLとLGPLに完全に従い、録音、再生、
MIDIシークエンスに高いシステムクオリティーを提供するサウンドドライバシステムです。
</p> 

</body>
</section>
<section>
<title>ALSAはどのカードをサポートしてるの？</title>
<body>

<p>
ALSAはオープンソースのドライバの提供によりできるかぎり新しいものも含め多くのカードをサポートしようとしてます。
しかし、いくつかのベンダーはバイナリのみしか提供しません。
</p>

<p>
あなたのカードがサポートされているか知るには、
<uri>http://www.alsa-project.org/alsa-doc/</uri>を確かめてください。
</p>

</body>
</section>
</chapter>

<chapter>
<title>インストール</title>
<section>
<title>Gentoo USE flags</title>
<body>

<p>
コンパイル時にALSAサポートをプログラムに組み込むには、
必ず<e>alsa</e>をUSEフラグに追加します。
しかし、いくつかのツールはまだalsaをサポートしておらず、OSSを必要とします。
始める前に<e>oss</e>をUSEフラグに定義しておけば、
ALSAはOSSエミュレーションを提供します。
</p>

</body>
</section>
<section>
<title>カーネルモジュール</title>
<body>

<p>
私達はまだ2.4.xカーネルソースを使っているので、
カーネールモジュールとALSAモジュールを分けてコンパイルしなくてはいけません。
2.5.xカーネルを使用している人は、ALSAモジュールがカーネルソースに含まれており、
カーネルソースとともに構築されるので、
カーネルコンフィギュレーションで制御できます。
</p>

<p>
最初にカーネルコンフィギュレーションがALSAを使う準備ができているか確認します。
やらなければいけないことはSound Card Supportをモジュール（M）としてビルドすることです。
これは<path>soundcore.o</path>を作成します。
</p>

<note>
Sound Card Supportをモジュール（M）の代わりにカーネルに組み込む（Y）こともできます。
しかしALSAのドキュメントは、ALSAがSound Card Supportモジュールをロードしようとするので、
Sound Card Supportをモジュールとしてビルドすることを提案しています。
</note>

<p>
もしすでに作業済みのカーネルコンフィギュレーションがあるなら、
Sound Card Support以外のすべてのサウンドカードドライバを外してあるか確認してください。
もしリブートせずにこの作業をしたい場合、以下の手順ですることができます。
</p>

<pre caption="カーネルコンフィギュレーション">
# <i>cd /usr/src/linux</i>
# <i>cp .config ~/</i>
# <i>make mrproper</i>
# <i>cp ~/.config .</i>
# <i>make menuconfig</i>
</pre>

<p>
それでは<e>Sound Card Support</e>をモジュール（M）にして、
すべてのサウンドカードドライバーを外してください。
終了してカネールコンフィギュレーションを保存（Y）してください。
そしてモジュールをビルドします。
</p>

<pre caption="カーネルの構築">
# <i>make dep clean</i>
# <i>make modules modules_install</i>
</pre>

<p>
最後の行は新しいモジュールをインストールする前に以前のモジュールをすべて消します。以前にインストールしたALSAも同様です。
</p>

<impo>
これが意味するのは、カーネルを再構築するたびに<c>alsa-driver</c>も再構築しなければいけないということです。
</impo>

</body>
</section>
<section>
<title>ALSAモジュール</title>
<body>

<p>
それではあなたのサウンドカードのためのALSAドライバーをインストールする準備ができました。
もしあなたのサウンドカードがPCIなら<path>/proc/pci</path>の出力からサウンドカードの種類を特定することができます。
</p>

<pre caption="サウンドカード情報の検索">
# <i>grep audio /proc/pci</i>
</pre>

<warn>
もし以前にサウンドを設定していてALSAではないサウンドモジュールがロードされているなら、<e>今すぐ</e>外してください。
<c>lsmod</c>で確認をして、サウンド関連のモジュールをすべて外すために<c>rmmod</c>を使用してください。
</warn>

<p>
それでは単純に <c>emerge alsa-driver</c>をしましょう。
これは<e>すべての</e>ALSAサウンドドライバをコンパイルしてインストールします。
</p>

<p>
しかし時間の節約のため、
<uri link="http://www.alsa-project.org/alsa-doc">ALSA Soundcard Matrix</uri>であなたのカードの行の<e>Driver &amp; Docs</e>の列にある<e>Details</e>というリンクをたどり、あなたのサウンドカードの<e>モジュール名</e>を探しましょう。
(訳注：まず、Choose manufacturer for more detailsからあなたのカードのチップセットのベンダーを見つけてGoボタンをクリックしてください。)
私の場合は<e>EMU10K1</e>チップセットを搭載したSBlive!を持っているのでモジュール名は<c>snd-emu10k1</c>でした。
emergeする前に環境変数にALSA_CARDS値をセットします。そうすればemergeはそのドライバーのみをコンパイルします。
(訳注：実際には、モジュール名から<e>snd-</e>を除いた部分をセットします。)
</p>

<pre caption="Compile correct modules">
# <i>env ALSA_CARDS='emu10k1' emerge alsa-driver</i> 
</pre>

<note>
<path>/etc/make.conf</path>にこの値を追加する事もできます。そうすれば、以後、
alsa-driverをemergeする際に<c>emerge alsa-driver</c>を実行するだけで済みます。
例えば、<c>echo 'ALSA_CARDS="emu10k1"' &gt;&gt; /etc/make.conf</c>の様にします。
</note>

<note>
ALSAドライバを２個以上のサウンドカードにインストールしたい場合、
<c>env ALSA_CARDS='emu10k1 intel8x0 ens1370' emerge alsa-driver</c>のようにスペースで区切られたドライバーのリストをALSA_CARDにセットすることができます。
</note>

<note>
もしOSS互換が必要なら、emerge <i>alsa-oss</i>をしてください。
これはALSA/OSS互換ラッパーです。
</note>

<note>
もし、度々カーネルを再構築する事を予定しているなら、
emerge <c>alsa-drive</c>に<c>--buildpkg</c>オプションをつける事を提案します。
これは、バイナリパッケージを作成する事ができます。
以降、カーネルを再構築した後、
<c>emerge --usepkg alsa-driver</c>を実行するだけで再びコンパイルする事なくバイナリパッケージをインストールする事ができます。
</note>

<p>
この後、ALSAモジュールはシステムにインストールされたはずです。
</p>

</body>
</section>
<section>
<title>ALSAのコンフィギュレーション</title>
<body>

<p>
ALSAをただしく動かすためにコンフィギュレーションをはじめましょう。
新しくインストールされたALSAをシステムに知らせるためにいくつかのファイルを編集する必要があります。
</p>

<p>
最初に<c>alsa-utils</c>をあなたのシステムにインストールします。
</p>

<pre caption="Emerging alsa-utils">
# <i>emerge alsa-utils</i>
</pre>

<p>
この後、<path>/etc/modules.d/alsa</path>を編集します。
</p>

<warn>
<path>/etc/modules.conf</path>を編集する必要はありません。
その代わり<path>/etc/modules.d</path>の中のファイルをいつも編集します。
</warn>

<p>
<e>そのファイル最後の</e>「ALSA portion」をチェックしてください。
下に示す行であなたのサウンドカードの数を設定できます。(通常は1です)
</p>

<pre caption="/etc/modules.d/alsaの最後">
<comment>正確なカードの数を設定してください。</comment>
options snd cards_limit=1
</pre>

<p>
どのサウンドドライバーをALSAが使うか明記します。
同じファイルをこのように編集してください。
</p>

<pre caption="/etc/modules.d/alsaの抜粋">
## and then run `modules-update' command.
## Read alsa-driver's INSTALL file in /usr/share/doc for more info.
##
##  ALSA portion
alias snd-card-0 snd-emu10k1
<comment>## もし複数のサウンドカードがあるなら、追加してください。</comment>
## alias snd-card-1 snd-intel8x0
## alias snd-card-2 snd-ens1370
##  OSS/Free portion
## alias sound-slot-0 snd-card-0
## alias sound-slot-1 snd-card-1
##
</pre>

<note>
もし複数のサウンドカードがあるならsnd_cards_limitの値を合わせsnd-card aliasesをこのファイルに追加してください。
私はこの設定をした経験はありませんが、複数サウンドカードの設定例が、
<uri link="http://www.alsa-project.org/alsa-doc/alsa-howto/alsa-howto.html">
ALSA Howto</uri>の<uri link="http://www.alsa-project.org/alsa-doc/alsa-howto/c1660.htm">Chapter 6</uri>にあります。
</note>

<p>
このファイルで最後にすることは、ほぼ終わりの方に以下の行があるので、
コメントアウトされていないかチェックしてください。
</p>

<pre caption="/etc/modules.d/alsaの終わりの方">
alias /dev/mixer snd-mixer-oss
alias /dev/dsp snd-pcm-oss
alias /dev/midi snd-seq-oss
</pre>

<p>
<path>/etc/modules.d/alsa</path>をもう一度確認してください。
すべての準備ができたら<c>modules-update</c>を実行しましょう。
</p>

<pre caption="modules-updateの実行">
# <i>modules-update</i>
</pre>

<note>
ここで<c>modules-update</c>を実行するのは<path>/etc/modules.d/alsa</path>の内容を<path>/etc/modules.conf</path>に書き込むためです。
</note>

<p>
<path>/etc/devfsd.conf</path>にALSAデバイスとパーミッションが正しく登録されているか確認してください。
</p>

<pre caption="/etc/devfsd.conf">
# ALSA/OSS stuff
# Comment/change these if you want to change the permissions on
# the audio devices
LOOKUP          snd          MODLOAD ACTION snd
LOOKUP          dsp          MODLOAD
LOOKUP          mixer        MODLOAD
LOOKUP          midi         MODLOAD
REGISTER        sound/.*     PERMISSIONS root.audio 660
REGISTER        snd/.*       PERMISSIONS root.audio 660
</pre>

<note>
devfsd.confが<path>/dev/sound</path>のパーミッションをroot.audioにしていることに注目してください。
このようにrootでないユーザーがaudioを使うにはaudioグループに所属していなければいけません。
</note>

</body>
</section>
</chapter>

<chapter>
<title>ALSAの起動</title>
<section>
<title>alsasoundをランレベルに追加する</title>
<body>

<p>
最初にすることは下記のようにboot時ALSAが起動するように設定してください。
</p>

<pre caption="ALSAをboot runlevelに追加">
# <i>rc-update add alsasound boot</i>
</pre>

<warn>
	alsasoundスクリプトは"boot"ランレベルに追加すべきです。
	"default"ではありません。
</warn>

</body>
</section>
<section>
<title>起動とミュートの解除</title>
<body>

<p>
我々はLinuxユーザーです。再起動はしたくありません。
alsasoundスクリプトを手動でスタートさせましょう。
</p>

<pre caption="ALSAの起動">
# <i>/etc/init.d/alsasound start</i>
</pre>

<p>
ALSAは起動しました。
<c>lsmod</c>を実行した場合ALSAモジュールがロードされているのが見えるはずです。
しかしチャンネルがミュートになっているため、まだ音は鳴りません。
このために<c>amixer</c>が必要です。
</p>

<pre caption="amixerの実行">
# <i>amixer</i>
</pre>

<warn>
"amixer: Mixer attach default error: No such file or directory"のエラーは出るべきではないですが、
<e>もし</e>出てしまったら一度手動で<c>snd-mixer-oss</c>と<c>snd-pcm-oss</c>をmodprobeしてください。
その後もう一度amxierを起動しましょう。
</warn>

<pre caption="万が一、amixerの実行時にエラーが出た場合">
# <i>modprobe snd-mixer-oss</i>
# <i>modprobe snd-pcm-oss</i>
# <i>amixer</i>
</pre>

<p>
ここまできたらMasterとPCMチャンネルのミュートを解除します。
ハードウェアによってはCenterチャンネル、
場合によってはSorroundチャンネルもミュートの解除が必要です。
</p>

<pre caption="チャンネルのミュート解除">
# <i>amixer set Master 100 unmute</i>
# <i>amixer set PCM 100 unmute</i>
<comment>もし上記では成功しない場合のみ:</comment>
# <i>amixer set Center 100 unmute</i>
# <i>amixer set Surround 100 unmute</i>
<comment>サウンドのテスト:</comment>
# <i>aplay $KDEDIR/share/sounds/pop.wav</i> <codenote>(pop.wavはKDEに含まれています)</codenote>
</pre>

<p>
サウンドが働くかどうかaplay(alsa play)コマンドを使って確認します。
音が聞こえたらサウンドは正常に機能しています。
音量を好みにきちんと設定するには調節するには、
ncursesベースの<c>alsamixer</c>を使うのがいいでしょう。
</p>

<p>
XMMSをALSAに対応させたい場合は、emerge <c>alsa-xmms</c>を実行します。
</p>

<p>
システムをrebootした場合、
<c>alsasound</c> initスクリプトは音量の設定を正しく保存します。
</p>

</body>
</section>
</chapter>

<chapter>
<title>最後に</title>
<section>
<title>カーネルアップグレード後に...</title>
<body>

<p>
カーネルを再構築したり、他のカーネルにアップグレードした時には、ALSAモジュールも再構築しなければいけません。
</p>

<p>
前回は<c>alsa-driver</c>、<c>alsa-lib</c>、<c>alsa-utils</c>をインストールしたかもしれませんが、
<path>/lib/modules/*/kernel/sound/pci/</path>に置かれるのはALSAモジュールのみなので、
<c>alsa-driver</c>のみを再インストールする必要があります。
</p>

<pre caption="カーネルを再構築するたびに必要">
# <i>emerge alsa-driver</i>
</pre>

</body>
</section>
<section>
<title>/etc/modules.autoload</title>
<body>

<p>
ALSAを使用するためにこのファイルを編集する必要はありません。
<c>rc-update add alsasound boot</c>の後、
システムはスタート時に正しいモジュールをロードします。
</p>

<p>
<c>snd-pcm-oss</c> または <c>snd-mixer-oss</c>をこのファイルに追加する必要はありません。
詳細は<uri link="http://www.djcj.org/LAU/guide/alsbook/faq1.html">このFAQ</uri>をチェックしてください。
</p>

</body>
</section>
<section>
<title>既知のバグ</title>
<body>

<note>
このガイドはalsaの開発よりはるかに遅れています。
あなたがこれを読む頃にはこれらのバグは既に解決しているかもしれません。
</note>

<ul>
  <li>
    もし、<b>OSS</b>エミュレーション時に<b>多くの雑音</b>が聞こえるなら、
    <path>/etc/modules.d/alsa</path>に<e>options snd-pcm-oss dsp_map=1</e>を追加してください。
  </li>
</ul>

</body>
</section>
<section>
<title>ジョイ・スティックサポートの有効化</title>
<body>

<p>
もし、あなたのサウンドカードにジョイ・スティック用のプラグがあるなら、
ジョイ・スティックサポートの有効化に興味があるかもしれません。
もしそうならば、サウンドカードドライバにジョイ・スティック向けのパラメータがないか探してみてください。
<c>modinfo</c>を<path>snd-&lt;your chipset&gt;</path>に対して実行する事で探せます。
<c>snd-via82xx</c>の場合は次の例のようになります。
</p>

<pre caption="modinfoの実行">
# <i>modinfo snd-via82xx</i>
filename:    /lib/modules/2.4.22-ck2/snd-via82xx.o
description: "VIA VT82xx audio"
author:      "Jaroslav Kysela &lt;perex@suse.cz&gt;"
license:     "GPL"
parm:        index int array (min = 1, max = 8), description "Index value for VIA 82xx bridge."
parm:        id string array (min = 1, max = 8), description "ID string for VIA 82xx bridge."
parm:        enable int array (min = 1, max = 8), description "Enable audio part of VIA 82xx bridge."
parm:        mpu_port long array (min = 1, max = 8), description "MPU-401 port. (VT82C686x only)"
<i>parm:        joystick int array (min = 1, max = 8), description "Enable joystick. (VT82C686x only)"</i>
parm:        ac97_clock int array (min = 1, max = 8), description "AC'97 codec clock (default 48000Hz)."
parm:        dxs_support int array (min = 1, max = 8), description "Support for DXS channels 
             (0 = auto, 1 = enable, 2 = disable, 3 = 48k only, 4 = no VRA)"
</pre>

<p>
もし、<c>joystick</c>というパラメータがあるなら、
<path>/etc/modules.d/alsa</path>の<c>options</c>行に<c>joystick=1</c>を加えます。
<c>snd-via82xx</c>の場合は次のようにします。
</p>

<pre caption="ジョイ・スティック向けのパラメータの追加">
alias snd-card-0 snd-via82xx
options snd-via82xx joystick=1
</pre>

</body>
</section>
<section>
<title>さらなるリンク...</title>
<body>

<p>
さらなる情報はこちらで確認してください:
</p>

<ul>
  <li>
    <uri link="http://www.gentoo.org/doc/en/desktop.xml">The Gentoo Linux Desktop Configuration Guide</uri>
    <uri link="http://www.gentoo.org/doc/ja/desktop.xml">（日本語訳）</uri>
  </li>
  <li>
    <uri link="http://www.alsa-project.org">ALSA Project Homepage</uri>
  </li>
  <li>
    <uri link="http://www.alsa-project.org/documentation.php3">ALSA Users 
    Documentation</uri>
  </li>
  <li>
    <uri link="http://www.djcj.org">ALSA Howto's and FAQ's</uri>
  </li>
  <li>
    <uri link="http://tldp.org/HOWTO/Sound-HOWTO/index.html">Linux Sound 
    HOWTO</uri>
  </li>
  <li>
    <uri link="http://linux-sound.org/">Sound and MIDI Software For Linux</uri>
  </li>
</ul>

</body>
</section>
</chapter>
</guide>

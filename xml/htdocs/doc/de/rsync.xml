<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/de/rsync.xml,v 1.6 2004/05/08 16:25:03 dertobi123 Exp $ -->

<!-- English CVS Version: 1.25 -->

<guide link="/doc/de/rsync.xml">
<title>Gentoo Linux Rsync-Mirror-Politik</title>
<author title="Autor">
  <mail link="mirror-admin@gentoo.org">Gentoo Mirror Administratoren</mail>
</author>
<author title="Übersetzung">
  <mail link="moixa@users.berlios.de">Tobias Sager</mail>
</author>
<author title="Übersetzung">
  <mail link="SirSeoman@gmx.de">Tobias Matzat</mail>
</author>  

<abstract>
Dieses Dokument beschreibt, wie Sie einen offiziellen Rsync Mirror aufsetzen.
</abstract>

<license/>

<version>1.3</version>
<date>23. Februar 2004</date>

<chapter>
<title>Anforderungen</title>
<section>
<title>Minimale Bandbreite</title>
<body>

<p>
Sie sollten mindestens eine Bandbreite von 5Mbps (Full-Duplex) haben, um
einen Mirror angemessen betreiben zu können.
</p>

</body>
</section>
<section>
<title>Minimale Useranzahl</title>
<body>

<p>
Wir setzen voraus, dass Sie mindestens 15 gleichzeitige User-Verbindungen
tragen können.
</p>

</body>
</section>
<section>
<title>Minimale Hardware</title>

<body>

<p>
Um gleichzeitig 15 User effizient bedienen zu können, bitten wir Sie,
die folgenden Hardware-Mindestanforderungen zu erfüllen:
</p>

<ul>
  <li>PIII 500 Prozessor</li>
  <li>256MB RAM</li>
</ul>

</body>
</section>
<section>
<title>Update-Häufigkeit</title>

<body>

<p>
Updates müssen 24 Stunden am Tag um :00 und :30 jeder Stunde erfolgen.
Es ist <e>sehr</e> wichtig, dass dieser Zeitplan exakt eingehalten wird,
weil wir ein Round-Robin DNS-System einsetzen, um den aktuellen
User-Rsync-Server zu bestimmen.
</p>

</body>
</section>
<section>
<title>MOTD (/etc/rsync/rsyncd.motd)</title>
<body>

<p>
Folgende Informationen sollten in Ihrem Rsync-MOTD (Spruch des Tages)
enthalten sein:
</p>

<ul>
  <li>Server Name</li>
  <li>Server IP-Adresse</li>
  <li>Server Spezifikationen (CPU und RAM)</li>
  <li>Verfügbare Bandbreite</li>
  <li>User-Verbindungs-Limiten, falls vorhanden</li>
  <li>Server Standort (Stadt und Land)</li>
  <li>Kontaktinformationen: Name und eMail-Adresse</li>
</ul>

<p>
Wenn Sie die obigen Informationen in Ihr MOTD einschliessen, ist
es einfacher, den Mirror im Falle eines Problems zu identifizieren.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Details zur Implementierung</title>
<section>
<body>

<p>
Um einen neuen Mirror aufzusetzen, befolgen Sie bitte die folgenden Schritte:
</p>

<ul>
<li>
  Konfigurieren Sie Ihren Mirror so, dass er zu einem bereits existierenden
  öffentlichen Gentoo Linux - Mirror synchronisiert. Es spielt keine Rolle,
  welchen Mirror Sie wählen. Stellen Sie aber bitte sicher, dass Sie gemäss
  unseren <e>Update Häufigkeits</e>-Angaben oben synchronisieren.
</li>
<li>
  Füllen Sie einen Bug-Report auf
  <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> aus, der Ihren
  Server-Namen, die IP-Adresse, Kontaktinformationen und die Tatsache enthält,
  dass Sie neuer Rsync-Mirror werden wollen. Wir werden überprüfen,
  ob Ihr Server korrekt synchronisiert. Es ist wichtig, daß Ihr Sever sich
  zwei Mal die Stunde synchronisiert, einmal zwischen :00 und :10 und ein
  zweites Mal zwischen :30 und :40. Sie können jeden Zeitpunkt in diesen beiden
  10-Minuten-Fenstern wählen.
</li>
<li>
  Sobald wir sichergestellt haben, dass der Server korrekt läuft, fügen wir
  die IP-Adresse zur rsync1.us.gentoo.org-Zugriffsliste hinzu.
</li>
<li>
  Ändern Sie ihren Rsync-Cronjob, damit er auf
  <path>rsync1.us.gentoo.org</path> zeigt. Wir beobachten Ihren Server über
  die nächsten 48 bis 72 Stunden, um sicherzustellen, dass er korrekt
  synchronisiert.
</li>
</ul>

<p>
Wenn dies alles problemlos vonstatten ging, erstellen wir einen offiziellen
rsync[nummer].[ländercode].gentoo.org DNS-Eintrag und fügen Ihren Server
zum DNS Round-Robin für rsync.gentoo.org und rsync.[ländercode].gentoo.org
hinzu. Kurz nachdem Sie zu unserem DNS hinzugefügt wurden, sollten Sie
den ersten Rsync-Verkehr sehen.
</p>

<p>
Daneben werden Sie, der Mirror-Administrator, zur gentoo-mirrors Mailingliste
(wenig Mailverkehr) hinzugefügt, um Sie bei eventuellen Problemen mit
Rsync-Mirrors auf dem Laufenden zu halten.
</p>

<note>
Danke, dass Sie den Gentoo Linux - Benutzern und -Entwicklern helfen! :)
Für jegliche Probleme mit der Rsync-Administration, besuchen Sie bitte
<uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> 
und füllen einen Bug zum Produkt "Rsync" aus.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Parallele Aufgaben</title>
<section>
<body>

<p>
Wir werden in Kürze eine mit dem rrdtool erzeugte Seite haben, welche Links
zu Graphen (sortiert nach Kontinent, dann nach Land und dann nach Server)
der offiziellen Rsync-Mirror - Verfügbarkeit enthalten wird (diese Graphen
werden mittels sping erzeugt). Wir werden diese Graphen mindestens einmal
am Tag überprüfen und unerreichbare Computer aus userem RR DNS-System
entfernen bis etwaige Probleme gelöst wurden. Ebenfalls werden wir Skripts
einsetzen, welche alle 30 Minuten überprüfen, ob die Mirrors wirklich
synchronisieren.
</p>

<warn>
Falls ein Mirror regelmässig Probleme bereitet, der Administrator kontaktiert
wurde und sich die Situation nicht verbessert, wird dieser Mirror dauerhaft 
aus dem RR-Schema entfernt.
</warn>

</body>
</section>
</chapter>

<chapter>
<title>Kurze FAQ</title>
<section>
<title>Q: Wen sollte ich betreffend Rsync-Problemen und -Unterhalt kontaktieren?</title>
<body>

<p>
A: Gehen Sie auf <uri link="http://bugs.gentoo.org">bugs.gentoo.org</uri> 
und füllen Sie einen Bug-Report zum Produkt "Rsync" aus.
</p>

</body>
</section>
<section>
<title>Q: Ich betreibe einen privaten Rsync-Mirror für meine Firma. Darf ich
trotzdem auf rsync1.us.gentoo.org zugreifen?</title>
<body>

<p>
Weil unsere verfügbaren Ressourcen limitiert sind, müssen wir sicherstellen,
dass wir sie so verteilen, dass wir den grössten Ertrag für unsere User
erreichen können. Demgemäss limitieren wir die Verbindung zu unserem
Haupt-Rsync-Server und den Distfiles-Server auf offizielle öffentliche
Mirrors. Anwender sind dazu aufgefordert, unser reguläres
Mirror-System zu benutzen, um einen privaten Rsync-Mirror zu erstellen.
Es sollten aber gewisse grundlegende
<uri link="http://www.gentoo.org/news/de/gwn/20030505-newsletter.xml#doc_chap1_sect3">
Rsync Verhaltensregeln
</uri> eingehalten werden.
</p>

</body>
</section>
<section>
<title>
Q: Ist es wichtig, dass ich meinen Mirror zwei Mal die Stunde synchronisiere?
</title>
<body>

<p>
A: Ja, es ist wichtig. Sie müssen nicht genau um :00 und :30 synchronisieren,
aber es sollte in folgenden beiden Intervallen geschehen:
</p>

<ol>
	<li>:00 and :10</li>
	<li>:30 and :40</li>
</ol>

<p>
Zusätzlich sollten Sie sicherstellen, daß Ihre Synchronisationen genau 30
Minuten voneinander entfernt liegen. Wenn der Erste gegen :08 stattfindet,
sollte der Zweite um :38 geschehen.
</p>
</body>
</section>
<section>
<title>Q: Wie finde ich den nächsten Mirror?</title>
<body>

<p>
A: Dazu wurde netselect entwickelt. Wenn Sie <c>emerge netselect</c> noch
nicht gemacht haben, machen Sie dies jetzt. Danach führen Sie
<c>netselect rsync.gentoo.org</c> aus. Nach etwa einer Minute gibt netselect
eine IP-Adresse aus. Nehmen Sie diese Adresse und benutzen Sie sie als
einzigen Parameter für Rsync mit zwei Doppelpunkten am Ende. Z.B.:
<c>rsync 1.2.3.4::</c>. Sie sollten nun anhand der Banner-Nachricht sehen,
welcher Mirror es ist. Ändern Sie ihre /etc/make.conf dementsprechend.
</p>

</body>
</section>
<section>
<title>Q: Kann ich Kompression benutzen, wenn ich mit rsync1.us.gentoo.org
synchronisiere?</title>
<body>

<p>
A: Nein. Kompression benötigt zuviele Server-Ressourcen, deshalb haben
wir sie auf rsync1.us.gentoo.org absichtlich deaktiviert. Bitte
<b>probieren Sie nicht</b> Kompression während der Synchronisation mit
diesem Server zu benutzen.
</p>

</body>
</section>

<section>
<title>Q: Ich sehe viele alte und wahrscheinlich tote rsync Prozesse, wie werde
ich die los?</title>
<body>

<p>
A: Sehen Sie bitte im Abschnitt für Beispielskripte nach.
</p>

</body>
</section>

<section>
<title>Q: Es gibt viele User die sich sehr häufig mit meinem rsync Server
sehr häufig verbinden, was manchmal sogar eine DoS für meinen Mirror
bedeutet. Wie kann ich das verhindern?
</title>
<body>

<p>
A: Sehen Sie bitte wiederum im Abschnitt für Beispielskripte nach.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Beispiel-Skripte</title>
<section>
<body>

<p>
Momentan benötigt ein Mirror des Portage-Trees etwa 250MB an Speicherplatz,
also nicht sehr viel. Es sollten jedoch mindestens weitere 500MB Platz
für allfälliges Wachstum vorhanden sein. Einen Portage-Tree-Mirror
aufzusetzen ist einfach. Als erstes stellen Sie sicher, dass Rsync
installiert ist. Danach ändern Sie ihre rsyncd.conf, dass sie etwa
so aussieht:
</p>

<pre caption="rsyncd.conf">
uid = nobody
gid = nobody
use chroot = yes
max connections = 15
pid file = /var/run/rsyncd.pid
motd file = /etc/rsync/rsyncd.motd
log file = /var/log/rsync.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300

[gentoo-x86-portage]
#Dieser Eintrag ist für Kompatibilität
path = /space/gentoo/rsync
comment = Gentoo Linux Portage tree

[gentoo-portage]
#Moderen Versionen von Portage nutzen diesen Eintrag
path = /gentoo/rsync
comment = Gentoo Linux Portage tree mirror
exclude = distfiles
</pre>

<p>
Oben zeigt der gentoo-x86-portage Mirror auf dieselben Daten wie
gentoo-portage. Obwohl wir letzthin den offiziellen Namen unseres
Mirrors nach gentoo-portage geändert haben, wird gentoo-x86-portage noch
immer für Rückwärts-Kompatibilität benötigt. Tragen Sie also beide
Namen ein.
</p>

<p>
Wegen Sicherheit-Aspekten, wird eine chroot-Umgebung wärmstens empfohlen!
</p>

<p>
Nun müssen Sie den Gentoo Linux Portage Tree spiegeln. Sie sollten das
folgende Skript benutzen, um dies zu machen:
</p>

<pre caption="rsync-gentoo-portage.sh">
#!/bin/bash

RSYNC="/usr/bin/rsync"
OPTS="--quiet --recursive --links --perms --times --devices --delete --timeout=300"
#Unkommentieren Sie folgende Linie nur, wenn Sie Zugriff
#  auf rsync1.us.gentoo.org haben
#SRC="rsync://rsync1.us.gentoo.org/gentoo-portage"
#Wenn Sie noch auf Zugriff auf den Master-Mirror warten,
#  wählen Sie irgendeinen unserer Mirrors
SRC="rsync://rsync2.de.gentoo.org/gentoo-portage"
DST="/space/gentoo/rsync/"

echo "Started update at" `date` >> $0.log 2>&amp;1
logger -t rsync "re-rsyncing the gentoo-portage tree"
${RSYNC} ${OPTS} ${SRC} ${DST} >> $0.log 2>&amp;1

echo "End: "`date` >> $0.log 2>&amp;1 
</pre>

<pre caption="/etc/init.d/rsyncd">
#!/sbin/runscript
# Copyright 1999-2002 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2
or later
# $Header: /var/cvsroot/gentoo/xml/htdocs/doc/de/rsync.xml,v 1.6 2004/05/08 16:25:03 dertobi123 Exp $

depend() {
need net
}

# FYI: --sparce seems to cause problems.
RSYNCOPTS="--daemon --safe-links --timeout=300"

start() {
ebegin "Starting rsync daemon"
start-stop-daemon --start --quiet --pidfile /var/run/rsyncd.pid --nicelevel 15 --exec /usr/bin/rsync -- ${RSYNCOPTS}
eend $?
}

stop() {
ebegin "Stopping rsync daemon"
start-stop-daemon --stop --quiet --pidfile /var/run/rsyncd.pid
eend $?
} 
</pre>

<p>
Ihr rsyncd.motd sollte Ihre IP-Adresse und andere relevante Informationen
über Ihren Mirror enthalten. Zum Beispiel Hinweise über den Host, der
den Mirror zur Verfügung stellt und einen administrativen Kontakt.
Nachdem Sie als offizieller Rsync-Mirror anerkannt wurden, wird
Ihr Host einen Alias in der Form
<path>rsync[nummer].[ländercode].gentoo.org</path> bekommen.
</p>

<p>
Diese Kommando wird Ihnen dabei helfen, alte rsync Prozesse, die manchmal wegen
Verbindungsprolemen auftreten zu beenden. Es ist wichtig diese Prozesse zu
beenden, da sie zu den gültigen Verbindungen für die 'max connections' Option
zählen.

Sie können dieses Kommado via Crontab jede Stunde laufen lassen, es
wird alle rsync Prozesse, die älter als eine Stunde sind beenden.
</p>

<pre>
/bin/kill -9 `/bin/ps --no-headers -Crsync -o etime,user,pid,command|/bin/grep nobody | \
             /bin/grep "[0-9]\{2\}:[0-9]\{2\}:" |/bin/awk '{print $3}'` 
</pre>

<p>
In einigen Fällen gibt es einige rücksichtslose User, die das rsync
Mirror-System missbrauchen, indem sie sich mehr als 1-2 Mal am Tag verbinden.
Im extremsten Falle verbinden sich User alle 15 Minuten oder noch kürzer. Das
führt häufig zu einer DoS - Attacke, da ein rsync Platz durchgehend für andere
User blockiert ist. Um dies zu verhindern können Sie folgendes
<uri link="/proj/en/infrastructure/mirrors/rsyncd.conf_pl.txt">Perl Skript</uri>
versuchen, welches Ihre rsync Log-Dateien scanned, IP-Adressen findet, die mehr
als <c>N</c> - Mal an diesem Tag verbunden waren findet und dynamisch eine
rsyncd.conf - Datei erstellt, die die betroffenen IP - Adressen in die 'hosts
deny' Richtlinie schreibt. Die folgende Zeile steuert, was <c>N</c>
entspricht:
</p>

<pre>
@badhosts=grep {$hash{$_}>4} keys %hash;
</pre>

<p>
Bitte denken Sie daran, Ihre Log - Dateien täglich zu rotieren und das Skript
so zu modifizieren, daß es weiß, wo Ihre rsyncd.conf Datei liegt, falls Sie
das Skript verwenden wollen. Es ist auf Gentoo Linux getestet, sollte aber
auf allen anderen Systemen funktionieren, die rsync und Perl unterstützen. 
</p>

</body>
</section>
</chapter>
</guide>

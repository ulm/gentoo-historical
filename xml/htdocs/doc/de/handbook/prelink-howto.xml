<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/de/handbook/Attic/prelink-howto.xml,v 1.1 2004/05/16 21:02:58 dertobi123 Exp $ -->

<!-- English CVS Version: 1.25 -->

<guide link="doc/de/prelink-howto.xml">
<title>Gentoo Linux Prelink Einführung</title>

<author title="Author">
  <mail link="cretin@gentoo.org">Stefan Jones</mail>
</author>
<author title="Editor"><!-- zhen@gentoo.org -->
  John P. Davis
</author>
<author title="Editor">
  <mail link="peesh@gentoo.org">Jorge Paulo</mail>
</author>
<author title="Editor">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Editor">
  <mail link="erwin@gentoo.org">Erwin</mail>
</author>
<author title="Übersetzer">
  <mail link="tevers@onlinehome.de">Torsten Evers</mail>
</author>

<abstract>
Diese Einführung informiert darüber, wie man die prelink Unterstützung
in der Portage 2.0.46 und später verwendet.
</abstract>

<license/>

<version>1.4</version>
<date>September 7, 2003</date>


<chapter>
<title>Einleitung</title>
<section>
<title>Was ist Prelink, und wie kann es mir helfen ?</title>
<body>

<p>
Die meisten, gebräuchlichen Programme verwenden shared libraries. Diese
shared libraries müssen während der Laufzeit in den Speicher geladen
und vielfältige Symbolreferenzen aufgelöst werden. Fr die meisten, kleineren
Anwendungen geschieht dies sehr schnell. Für Programme die in C++ geschrieben
worden sind und die zudem viele Bibliotheks-Abhängigkeiten haben, kann das
Linken eine nicht unerhebliche Zeit in Anspruch nehmen.
</p>

<p>
Auf den meisten Systemen werden Bibliotheken nicht sehr oft gewechselt. Daher
sind die Operationen, die zum Linken des Programms ausgeführt werden, immer
dieselben. Prelink nutzt diesen Umstand aus, indem es das Linken durchführt
und in der Programmdatei abspeichert, es also eigentlich bereits vor dem
Ausführen linkt (daher <c>prelink</c>). Für den Linker benötigen Sie
ld-linux.so in der glibc; um das Prelinking zu erkennen, benötigen Sie 
&gt;=glibc-2.3.1-r2.
</p>

<p>
Prelinking kann die Startzeit von Anwendungen stark verkürzen. Zum Beispiel 
kann die Ladezeit für ein typisches KDE-Programm um bis zu 50% verkürzt werden.
Lediglich beim Ersetzen von Bibliotheken muss durch erneutes Ausführen von 
Prelink eine neue Programmdatei erzeugt werden.
</p>

</body>
</section>
<section>
<title>Zusammenfassung</title>
<body>

<ul>
  <li>
    Prelinking wird mit einem Programm durchgeführt, das Überaschender Weise
    <path>prelink</path> heißt. Es verändert die Programmdatei, um sie schneller
    starten zu lassen. 
  </li>
  <li>
    Wenn Sie Bibliotheken verändern, die in mit Prelink beschleunigten 
    Anwendungen verwendet werden, so müssen Sie diese nochmals mit Prelink
    bearbeiten. Andernfalls verlieren Sie den Geschwindigkeitsvorteil.
    Das heißt, jedesmal wenn Sie ein Paket mittels der Portage updaten, 
    müssen Sie diese erneut mit Prelink bearbeiten.
  </li>
  <li>
    Die Veränderung an der Programmdatei kann vollständig wieder rückgängig
    gemacht werden. <path>prelink</path> besitzt eine Wiederherstellungsoption.
  </li>
  <li>
    Neuere Versionen der Portage können mittels <path>prelink</path>  die sich
    verändernden MD5-Summen und mtimes der Programmdateien bearbeiten.
  </li>
  <li>
    Sie müssen die glibc-2.3.1-r2 oder größer installiert haben und die 
    Programmdateien mit den binutils-2.13.90.0.xx oder größer Übersetzt haben.
  </li>
</ul>

</body>
</section>
</chapter>

<chapter>
<title>Prelink einrichten</title>
<section>
<title>Installation des Programms</title>
<body>

<note>
Ich setze voraus, daß Sie ein Gentoo-1.4 System besitzen, welches mit gcc-3.2 
oder besser und den binutils-2.13.90.0.xx oder besser übersetzt wurde.Dies muss
so sein, damit Ihre Programmdateien Prelink-fähig sind.
</note>

<warn>
Sie müssen glibc-2.3.1-r2 oder neuer installiert habenm, andernfalls wird
<path>prelink</path> Ihre Programmdateien zerstören !
</warn>

<p>
Als erstes bringen Sie Ihren Portage-Baum auf einen aktuellen Stand, da viele
der benötigten Dateien neu sind und ununterbrochen Fehlerbereinigungen 
hinzugefügt werden.
</p>

<pre caption = "Updaten Ihres Portage-Baums">
# <i>emerge sync</i>
</pre>

<p>
Anschließend stellen Sie sicher, daß Sie portage 2.0.46 oder neuer installiert
haben. Dies ist notwendig, damit die Portage Ihre mit Prelink erzeugten 
Programmdateien erkennen und, wenn verlangt, ordnungsgemäß löschen kann. Dies
ist erforderlich, da die Behandlung mit Prelink die MD5-Summe der Programmdatei
verändert.
</p>

<pre caption = "Portage-Version überprüfen">
# <i>emerge ">=portage-2.0.46"</i>
</pre>

<p>
Nun können Sie das Prelink-Tool emergen. Der emerge-Prozess stellt automatisch
sicher, daß Ihr System Prelink sicher benutzen kann.
</p>

<pre caption = "Installation von Prelink">
# <i>emerge prelink</i>
</pre>

<p>
Einige Benutzer erhalten Fehlermeldungen beim emergen von Prelink, weil diese
Tests fehlschlagen. Diese Tests wurden aus Sicherheitsgründen hinzugefügt. 
Prelink's Verhalten ist nicht definiert, wenn Sie sie ausschalten. Die Fehler
beim Ausführen von emerge hängen gewöhnlich von den Kern-Paketen binutils, gcc
und glibc ab. Versuchen Sie, diese Pakete in der angegebenen Reihenfolge zu
emergen.
</p>

<note>
Tipp: Wenn Sie einen Fehler erhalten, versuchen Sie <c>Prelink</c> selbst
zu compilieren (<c>./configure</c> ; <c>make</c> ; <c>make check</c>). Bei
einem Fehler sehen Sie sich bitte die *.log Dateien im testsuite-Verzeichnis
an, sie können wertvolle Hinweise enthalten.
</note>

<p>
Wenn Sie eine bestimmte, zu einem Fehler führende Vorgehensweise anhand von
einzelnen Schritten beschreiben können, schicken Sie diese bitte per Email
an <mail link="cretin@gentoo.org">Stefan Jones</mail>.
</p>

</body>
</section>
<section>
<title>Konfiguration</title>
<body>

<p>
Portage generiert automatisch die Datei <path>/etc/prelink.conf</path>,
die <path>Prelink</path> anweist, welche Dateien zu bearbeiten sind.
</p>

<p>
Unglücklicherweise kann man Dateien, die mit alten Versionen der binutils
compiliert wurden, nicht mit Prelink bearbeiten. Die meisten dieser Dateien
stammen aus Programmen, die nur als fertig gelinkte Versionen geliefert werden,
die unter <path>/opt</path> installiert werden.  Durch das Erstellen folgender
Dateien weisen Sie Prelink an, nicht zu versuchen, diese Dateien zu bearbeiten.
</p>

<pre caption="/etc/env.d/99prelink">
PRELINK_PATH_MASK="/opt"
</pre>

<note>
Sie können ein oder mehrere Verzeichnisse zu der durch Doppelpunkt getrennten
Liste hinzufügen.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Prelinking</title>
<section>
<title>Verwendung von Prelink</title>
<body>

<p>
Ich verwende das folgende Kommando um alle Programmdateien in den in 
<path>/etc/prelink.conf</path> angegebenen Verzeichnissen zu bearbeiten.
</p>

<pre caption = "Angegebene Dateien mit Prelink bearbeiten">
# <i>prelink -afmR</i>
</pre>

<warn>
Es ist beobachtet worden, dass wenn Sie nicht mehr viel Festplattenplatz zur
Verfügung haben und Sie das ganze System mit Prelink bearbeiten, Programmdateien
verstümmelt werden können.Das Ergebnis ist ein zerstörtes System. Verwenden Sie
<c>file</c> oder <c>readelf</c> Kommando um den Zustand der Programmdateien zu 
überprüfen. Alternativ können Sie die Menge an freiem Speicher auf Ihrer 
Festplatte mit <c>df -h</c> überprüfen.
</warn>

<table>
<tr>
  <th>Erläuterung der Optionen:</th>
</tr>
<tr>
  <th>-a</th>
  <ti>"All": bearbeitet alle Programmdateien mit Prelink</ti>
</tr>
<tr>
  <th>-f</th>
  <ti>
    Zwingt <path>Prelink</path>, bereits bearbeitete Programmdateien
    nochmals zu bearbeiten. Dies ist notwendig, da <path>prelink</path>
    abbricht, wenn es alte, bereits mit Prelink bearbeitete Dateien findet
    und deren Bibliotheksabhängigkeiten sich geändert haben.
  </ti>
</tr>
<tr>
  <th>-m</th>
  <ti>
    Beibehalten des virtuellen Speicherbereichs. Dies ist notwendig,
    wenn Sie eine größere Menge an Bibliotheken haben, die mit Prelink
    bearbeitet werden sollen.
  </ti>
</tr>
<tr>
  <th>-R</th>
  <ti>
    Zufall -- zufällige Anordnung der Adressen, dies erhöht die Sicherheit
    gegen Pufferüberläufe.
  </ti>
</tr>
</table>

<note>
Für weitere Optionen und Details siehe <c>man prelink</c>.
</note>

</body>
</section>
</chapter>

<chapter>
<title>Bekannte Probleme und Bereinigungen</title>
<section>
<title>&quot;Prelink gegen non-PIC shared library nicht möglich&quot;</title>
<body>

<p>
Der Grund für dieses Problem sind fehlerhaft compilierte shared libraries,
die ohne die -fPIC Option für alle Objekt-Dateien erstellt wurden.
</p>

<p>
Die folgende Liste enthält Bibliotheken, die diesesProblem verursachen. 
Wiederholen Sie emerge dieser Pakete, wenn Sie den obigen Fehler erhalten.
</p>

<pre caption = "Bereinigungen:">
<codenote>Für die ORBit Bibliothek /usr/lib/libIIOP.so.0.5.17</codenote>
# <i>emerge ">=sys-apps/tcp-wrappers-7.6-r4" ORBit</i>

<codenote>Für die zlib Bibliothek usr/lib/libz.so.1.1.4</codenote>
# <i>emerge ">=sys-libs/zlib-1.1.4"</i>

<codenote>Für die svgalib, /usr/lib/libsvga.so.xx</codenote>
# <i>emerge ">=media-libs/svgalib-1.9.16"</i>

<codenote>Für die XFree openGL Bibliothek, libGLU.so.1</codenote>
# <i>emerge ">=x11-base/xfree-4.2.1-r2"</i>

<codenote>Für die libpcap.so.0.6</codenote>
# <i>emerge ">=net-libs/libpcap-0.7.1-r2"</i>

<codenote>Für die lcms Bibliothek, /usr/lib/liblcms.so.1</codenote>
# <i>emerge ">=media-libs/lcms-1.09"</i>
</pre>

<note>
Viele Bibliotheken linken statisch auf die zlib und/oder die tcp-wrappers,
also versuchen Sie bitte zuerst diese erneut zu emergen.
</note>

<p>
Wenn Sie Probleme damnit haben, Prelink für QT/KDE zu nutzen, versuchen Sie
zuerst auf >=x11-base/xfree-4.2.1-r2 zu aktualisieren. Wenn QT dann immer noch
fehlschlägt, versuchen Sie es ohne xinerama Unterstützung zu compilieren, indem
Sie myconf="-no-xinerama ${myconf}" im QT-ebuild hinzufügen.
</p>

<p>
Hier ist eine Liste von Bibliotheken, die nicht korrigiert wurden oder nicht
korrigierbar sind:
</p>

<ul>
  <li>
    Die Bibliotheken im Wine-Paket, inklusive WineX. Die Verwendung von
    Prelink würde MS Windows Programme sowieso nicht beschleunigen.
  </li>
  <li>
    Die Bibliothek in media-video/mjpegtools,
    <path>/usr/lib/liblavfile-1.6.so.0</path>.
  </li>
</ul>

<p>
Wenn Ihre, Probleme verursachende Bibliothek hier nicht aufgeführt wurde,
benachrichtigen Sie uns bitte, Vorzugsweise mit einem Patch, der das 
<c>-fPIC</c> zu den relevanten CFLAGS hinzufügt.
</p>

</body>
</section>
<section>
<title>Abbruch während Prelink eine Datei bearbeitet, wie z.B. &quot;1631 
Aborted ....&quot;</title>
<body>

<p>
Sie müssen die <c>-f</c> Option für <path>Prelink</path> verwenden;
z.B. Sie bearbeiten das ganze System mit Prelink, von Anfang an. 
Versuchen Sie <c>prelink -af</c>.
</p>

</body>
</section>
<section>
<title>&quot;&lt;file&gt;: error while loading shared libraries: unexpected
reloc type...&quot;</title>
<body>

<p>
Dies wurde in <c>sys-libs/glibc-2.3.1-r2</c> am 18.11.2002 korrigiert.
Wenn Ihre glibc älter ist, emergen Sie sie erneut.
</p>

<p>
Auch die Durchführung von <c>prelink -u -a -m</c> ; <c>prelink -a -m</c>
hat sich in vielen Fällen als hilfreich erwiesen. Wenn alles fehlschlägt,
versuchen Sie einfach <c>prelink -u &lt;file&gt;</c>.
</p>

</body>
</section>
<section>
<title>Ich habe Probleme mit den Nvidia openGL Bibliotheken</title>
<body>

<p>
Die beschleunigten openGL Bibliotheken, die mit dem nvidia-glx Paket kommen,
sind auf eine nicht standardgemäße Art und Weise compiliert worden, daher wird
<path>Prelink</path> Warnungen ausgeben. Dies ist kein Grund zur Beunruhigung
und kann von niemandem außer Nvidia beseitigt werden. Sie können jederzeit zur
XFree-Version der libGL.so zurückkehren, wenn Sie keine Hardwarebeschleunigung
benötigen. Der Nvidia-XFree-Treiber funktioniert übrigens sehr gut.
</p>

</body>
</section>
<section>
<title>Wenn ich mein System mit Prelink bearbeite, funktionieren statische 
Programmdateien nicht mehr.</title>
<body>

<p>
Soweit es die glibc angeht, gibt es kein 100% statisches Programm. Wenn Sie
ein Programm statisch mit der glibc compilen, können immer noch Abhänigkeiten
zu anderen Systemdateien bestehen. Unten finden Sie eine Erläuterung von Dick
Howell,
</p>

<p>
&quot;Ich vermute die dahinter stehende Idee ist, daß Alles in der
heruntergeladenen Datei enthalten ist und somit keine Abhängigkeiten von den
lokalen Bibliotheken des Zielsystems vorhanden sein sollen. Unglücklicherweise
ist dies bei Linux, und ich vermute bei jedem anderen System, welches die 
GLIBC verwendet, nicht korrekt. Da ist die "libnss" (name service switch, manche
Leute nennen sie network security system), welche Funktionen zum Zugriff auf
diverse Datenbanken mit Authentifikations- und Netzwerk-Informationen, sowie
anderen Informationen. Sie ist dafür gedacht, Anwendungen unabhängig vom
getrennt davon konfigurierten Netzwerk zu machen. Eine gute Idee, jedoch können
Änderungen an der GLIBC zu Problemen beim Laden dieser Bibliothek führen. 
Zudem kann man die "libnss" nicht statisch linken, da sie für jede Maschine 
individuell konfiguriert wird. Das Problem rührt meiner Meinung nach 
hauptsächlich daher, daß andere GLIBC Bibliotheken, insbesondere "libpthread",
"libm" and libc", statisch gelinkt werden, was zu inkompatiblen Aufrufen von 
Funktionen der "libnss" führt.&quot;
</p>

</body>
</section>
<section>
<title>Prelink bricht mit &quot;prelink: dso.c:306: fdopen_dso: Assertion
`j == k' failed.&quot; ab</title>
<body>

<p>
Dies ist ein bekanntes Problem, freundlicherweise  <uri
link="http://bugs.gentoo.org/show_bug.cgi?id=13878">hier</uri> diagnostiziert.
Prelink kann nicht mit UPX-komprimierten Programmdateien umgehen. 
Seit prelink-20021213 ist ein Fix erhältlich, der die ausführbaren
Dateien versteckt, während Prelink läuft. Siehe hierzu in die 
<uri link="#doc_chap2_sect2">Kapitel Konfiguration</uri> bezüglich eines
einfachen Wegs, dies zu tun.
</p>

</body>
</section>
<section>
<title>Ich verwende grsecurity und es hat den Anschein, daß Prelink nicht
funktioniert.</title>
<body>

<p>
Um auf einem System mit grsecurity Prelink benutzen zu können, welches
eine zufällige mmap() Basis verwendet, muss man die "randomized mmap() base"
für <path>/lib/ld-2.3.*.so</path> ausschalten. Dies kann man mit dem 
In order to prelink on a system with grsecurity using a <c>chpax</c> Tool.
Es muß jedoch verwendet werden, wenn die Dateien nicht in Benutzung sind
(z.B. von einer Rettungs-CD aus).
</p>

</body>
</section>    
</chapter>

<chapter>
<title>Zusammenfassung</title>
<section>
<body>

<p>
Die Verwendung von Prelink kann die Startzeiten von großen Anwendungen drastisch
verkürzen. Die Unterstützung dafür ist in Portage enthalten. Es ist also sicher,
da man die Änderungen jederzeit rückgängig machen kann, wenn Probleme auftreten.
Sie müssen lediglich darauf achten, daß Sie die Programmdateien neu mit Prelink
bearbeiten müssen, wenn Sie die glibc oder andere Bibliotheken mit denen Sie 
Prelink verwendet haben, updaten.  Dazu müssen Sie <path>prelink</path> erneut
starten !
Kurz: Viel Glück !
</p>

</body>
</section>
</chapter>
</guide>

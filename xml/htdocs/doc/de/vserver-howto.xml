<?xml version='1.0' encoding="UTF-8"?>
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/de/vserver-howto.xml,v 1.2 2005/08/03 23:46:29 grahl Exp $ -->
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<!-- English CVS Version: 1.1 -->

<guide link="/doc/de/vserver-howto.xml">
<title>Gentoo Linux-VServer Howto</title>

<author title="Autor">
  <mail link="hollow@gentoo.org">Benedikt Boehm</mail>
</author>
<author title="Bearbeiter">
  <mail link="fox2mike@gentoo.org">Shyam Mani</mail>
</author>
<author title="Übersetzer">
  <mail link="lonex@rthwlr.net">Timo Rothweiler</mail>
</author>

<abstract>
In diesem Howto lernen Sie, einen einfachen virtuellen Server unter
Zuhilfenahme der Linux-VServer-Technologie einzurichten
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.5 -->
<license/>

<version>1.0</version>
<date>2005-06-17</date>

<chapter>
<title>Einführung</title>
<section>
<title>Das Linux-VServer-Konzept</title>
<body>

<p>
Das grundlegende Konzept der Linux-VServer-Lösung ist es, die Umgebung des
User-Space in verschiedene Einheiten aufzuteilen (manchmal auch Virtuelle
Private Server genannt), und zwar in einer Art und Weise, dass jeder VPS
für die darin enthaltenen Prozesse so aussieht und sich so anfühlt wie ein
realer Server.
</p>

</body>
</section>
<section>
<title>Begriffe, die in diesem Howto verwendet werden</title>
<body>

<table>
<tr>
  <th>Begriff</th>
  <th>Beschreibung</th>
</tr>
<tr>
  <th>Linux-VServer, VServer</th>
  <ti>Linux-VServer ist der offizielle Name des Projekts und wird in diesem
    Howto so genutzt</ti>
</tr>
<tr>
  <th>virtueller Server, vserver, Gastsystem</th>
  <ti>Alle diese Begriffe sind austauschbar und beziehen sich auf eine Instanz
    eines Servers (d.h. ein virtueller Server)</ti>
</tr>
<tr>
  <th>Hostsystem, Host</th>
  <ti>Die physische Maschine, die Ihr Gentoo Linux ausführt, wird alle
    virtuellen Server hosten.</ti>
</tr>
<tr>
  <th>util-vserver, vserver-Dienstprogramme</th>
  <ti>Das <c>util-vserver</c>-Paket beinhaltet alle nötigen Programme, um Ihre
  virtuellen Server zu warten.</ti>
</tr>
</table>

</body>
</section>
</chapter>

<chapter>
<title>Ein VServer-Template erstellen</title>
<section>
<title>Einen VServer-Kernel installieren</title>
<body>

<pre caption="Installieren der vserver-sources">
# <i>emerge vserver-sources</i>
</pre>

<p>
Nach der Installation der vserver-sources, konfigurieren Sie diese mit Hilfe von
<c>make menuconfig</c>:
</p>

<pre caption="Konfigurieren der vserver-sources">
# <i>cd /usr/src/linux-&lt;KERNELVERSION&gt;-vserver-&lt;VSERVERVERSION&gt;</i>
# <i>make menuconfig</i>

Linux VServer ---&gt;
<comment>(Benötigt von den aktuellen Dienstprogrammen)</comment>
  [*] Enable Legacy Kernel API
<comment>(Nicht aktivieren!)</comment>
  [ ] Disable Legacy Networking Kernel API
<comment>(Dringend empfohlen)</comment>
  [*] Enable Proc Security
  [ ] Enable Hard CPU Limits
  Persistent Inode Context Tagging (UID24/GID24)  ---&gt;
  [ ] Tag NFSD User Auth and Files
  [ ] Compile Debugging Code
</pre>

<p>
Nachdem Sie den Kernel erstellt und installiert haben, aktualisieren Sie Ihren
Bootloader und rebooten letztlich, um zu sehen, ob der Kernel korrekt
startet.
</p>

<pre caption="Installieren des Kernels">
<comment>(Erstellen des Kernels)</comment>
# <i>make</i>
<comment>(Installieren)</comment>
# <i>make modules_install</i>
# <i>cp arch/i386/boot/bzImage /boot/kernel-&lt;KERNELVERSION&gt;-vs&lt;VSERVERVERSION&gt;</i>
<comment>(Bearbeiten der Bootloader-Konfigurationsdatei wie benötigt und)</comment>
# <i>reboot</i>
</pre>

</body>
</section>
<section>
<title>Einrichten der Host-Umgebung</title>
<body>

<p>
Um Ihre virtuellen Server zu warten benötigen Sie das util-vserver-Paket,
welches alle nötigen Programme und viele nützliche Features beinhaltet.
</p>

<pre caption="Installieren der vserver-Dienstprogramme">
# <i>emerge util-vserver</i>
</pre>

<p>
Wenn Sie Proc Security verwenden, müssen Sie bestimmte Dateien in Ihrem
<path>/proc</path>-Verzeichnis "aufdecken", um sie in virtuellen Servern
verfügbar zu machen. In <path>/usr/lib/util-vserver</path> ist ein Skript
namens <c>vprocunhide</c>, welches die in
<path>/usr/lib/util-vserver/defaults/vprocunhide-files</path> angegebenen
Dateien sichtbar macht. Das util-vserver-Ebuild hat ein Init-Skript
installiert, das den <c>vprocunhide</c>-Befehl verwendet. Fügen Sie es Ihrem
Runlevel hinzu:
</p>

<pre caption="vprocunhide Init-Skript">
# <i>rc-update add vprocunhide default</i>
# <i>/etc/init.d/vprocunhide start</i>
</pre>

<p>
Das vshelper-Skript wird benötigt, um virtuelle Server korrekt zu stoppen und
neu zu starten. Sie müssen dem Kernel mitteilen, wo das vshelper-Skript zu
finden ist:
</p>

<pre caption="vshelper-Einrichtung">
# <i>echo 'kernel.vshelper = /usr/lib/util-vserver/vshelper' &gt;&gt; /etc/sysctl.conf</i>
# <i>sysctl -p</i>
</pre>

</body>
</section>
<section>
<title>Grundlegende Skeleton-Konfiguration</title>
<body>

<p>
Sie müssen einige Konfigurationsdateien und -verzeichnisse anlegen, um Ihre
virtuellen Server zum Laufen zu bringen. Wir verwenden den Skeleton-Buildmodus
des util-vserver-Pakets, um die grundlegende Konfiguration zu erstellen.
</p>

<p>
Das util-vserver-Paket verwendet standardmäßig <path>/vservers</path> um alle
virtuellen Server abzulegen. Sie können Ihre Server an anderer Stelle ablegen,
wenn Sie dem Build-Befehl weiter unten <c>--rootdir=/path/to/vserver/root</c>
hinzufügen.
</p>

<p>
In Portage befindet sich ein neues baselayout-vserver-Ebuild, das den normalen
Init-Style verwendet, d.h. Sie müssen nicht mehr den Gentoo-Init-Style
verwenden. Der normale Init-Style verwendet <c>init</c> und
<path>/etc/inittab</path> um Runlevels und Init-Skripte zu verwalten
(wird als zuverlässiger betrachtet und ist jetzt Standard).
</p>

<p>
Sie müssen eine Context-ID für Ihren VServer wählen (von dynamische Context-IDs
wird abgeraten), ebenso wie die notwendigen Netzwerk-Informationen (in diesem
Beispiel ist eth0 auf 192.168.1.254/24 konfiguriert und die Context-ID ist
äquivalent zu den letzten beiden Teilen der IP des virtuellen Servers).
</p>

<pre caption="Grundkonfiguration">
# <i>vserver gentoo build -m skeleton \</i>
  <i>--hostname gentoo \</i>
  <i>--initstyle plain \</i>
  <i>--context 1253</i>
  <i>--interface gentoo=eth0:192.168.1.253/24</i>
</pre>

<impo>
Standardmäßig darf der virtuelle Server den Hostnamen selbst setzen. Stellen
Sie sicher, dass Sie später im virtuellen Server
<path>/etc/conf.d/hostname</path> auf obigen Hostnamen abändern.
</impo>

</body>
</section>
<section>
<title>Installieren der Gentoo-Installationsdateien</title>
<body>

<p>
Wir erstellen ein Gentoo-Template, das wir später kopieren können, um einfacher
mehrere virtuelle Server zu bekommen. Das VServer-Build-Skript hat ein paar
grundlegende Verzeichnisse in <path>/vservers/gentoo</path> erstellt, die
sowieso durch eine Stage installiert werden, also löschen wir sie zuerst.
</p>

<pre caption="Entfernen der Rohbau-Dateien">
# <i>rm -rf /vservers/gentoo/*</i>
</pre>

<p>
Sie müssen nun ein reguläres Gentoo-System installieren. Dazu können Sie bis
auf ein paar Einschränkungen und Ergänzungen dem Gentoo-Handbuch folgen:
</p>

<ul>
  <li>Ersetzen von <path>/mnt/gentoo</path> durch
    <path>/vservers/gentoo</path>
  </li>
  <li>Wählen des <path>vserver/x86</path>-Profils in
  <uri link="http://www.gentoo.org/doc/de/handbook/handbook-x86.xml?part=1&amp;chap=6#doc_chap1_sect6">Kapitel 6.a</uri>
  </li>
  <li>Benutzen der
  <uri link="http://dev.gentoo.org/~hollow/vserver/stages/">hier</uri> verfügbaren VServer-Stages.
  </li>
</ul>

<p>
Nun folgen Sie dem Gentoo-Handbuch von <uri
link="http://www.gentoo.org/doc/de/handbook/handbook-x86.xml?part=1&amp;chap=5#doc_chap2">Kapitel
5.b</uri> bis Kapitel 7.a und <uri
link="http://www.gentoo.org/doc/de/handbook/handbook-x86.xml?part=1&amp;chap=8#doc_chap3">Kapitel
8.c</uri> bis Kapitel 9.c
</p>

<note>
Um Ihre Netzwerkeinstellungen widerzuspiegeln sollten Sie
<path>/etc/conf.d/hostname</path>, <path>/etc/conf.d/domainname</path> und
<path>/etc/hosts</path> nach Ihren Bedürfnissen anpassen. Siehe <uri
link="http://www.gentoo.org/doc/de/handbook/handbook-x86.xml?part=1&amp;chap=8#doc_chap2_sect1">Kapitel
8.b.1</uri> und <uri
link="http://www.gentoo.org/doc/de/handbook/handbook-x86.xml?part=1&amp;chap=8#doc_chap2_sect4">Kapitel
8.b.4</uri>. Der Rest des Netzwerksetups Ihres virtuellen Servers wird auf dem
Host gemacht.
</note>
</body>
</section>

<section>
<title>Notwendige Änderungen an den Konfigurationsdateien</title>
<body>

<p>
Ändern Sie den Source-Eintrag in <path>/etc/syslog-ng/syslog-ng.conf</path>,
da wir aus Sicherheitsgründen keine Berechtigung haben, um
<path>/proc/kmsg</path> lesen zu können und entfernen Sie die Console-Destination:
</p>

<pre caption="Bearbeiten von /etc/syslog-ng/syslog-ng.conf">
<comment>(Ändern von)</comment>
source src { unix-stream("/dev/log"); internal(); pipe("/proc/kmsg"); };
<comment>(auf)</comment>
source src { unix-stream("/dev/log"); internal(); };

<comment>(Entfernen Sie diese Zeilen)</comment>
# By default messages are logged to tty12...
destination console_all { file("/dev/tty12"); };
# ...if you intend to use /dev/console for programs like xconsole
# you can comment out the destination line above that references /dev/tty12
# and uncomment the line below.
#destination console_all { file("/dev/console"); };

log { source(src); destination(console_all); };
</pre>

</body>
</section>
<section>
<title>Verlassen der Chroot-Umgebung</title>
<body>

<p>
Ihr System sollte fertig sein. Verlassen Sie das Chroot und unmounten Sie das
proc-Dateisystem.
</p>

<pre caption="Verlassen der Chroot-Umgebung">
# <i>exit</i>
# <i>umount /vservers/gentoo/proc/</i>
</pre>

</body>
</section>
<section>
<title>Testen des virtuellen Servers</title>
<body>

<p>
Sie sollten nun durch die untenstehenden Befehle den VServer starten und
benutzen können. Sollten Sie Befehle wie <c>mount</c> oder <c>dmesg</c>
vermissen, sollten sie <c>emerge util-linux</c> im virtuellen Server ausführen,
da das VServer-Profil dieses Paket standardmäßig nicht beinhaltet.
</p>

<pre caption="Testen des virtuellen Servers">
# <i>vserver gentoo start</i>
# <i>vserver-stat</i>
CTX   PROC    VSZ    RSS  userTIME   sysTIME    UPTIME NAME
0       90   1.4G 153.4K  14m00s11   6m45s17   2h59m59 root server
1253     2     3M   286    0m00s45   0m00s42   0m02s91 gentoo
# <i>vserver gentoo enter</i>
# <i>ps ax</i>
PID   TTY      STAT   TIME COMMAND
    1 ?        S      0:00 init [3]
22887 ?        Ss     0:00 /usr/sbin/syslog-ng
20496 pts/0    S      0:00 /bin/bash -login
20508 pts/0    R+     0:00 ps ax
# <i>halt</i>
Killed
</pre>

</body>
</section>
<section>
<title>Kontakt</title>
<body>

<p>
Im Falle von Problemen können Sie gerne den Autor kontaktieren, oder einen
Bug in <uri link="http://bugs.gentoo.org">Bugzilla</uri> eintragen.
</p>

</body>
</section>
</chapter>
</guide>

<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/de/power-management-guide.xml,v 1.7 2006/03/18 23:43:42 grahl Exp $ -->

<!-- English CVS Version: 1.18 -->

<guide link="/doc/de/power-management-guide.xml" lang="de">
<title>Power Management Anleitung</title>

<author title="Autor">
  <mail link="earthwings@gentoo.org">Dennis Nienhüser</mail>
</author>

<abstract>
Der Schlüssel zur Verlängerung der Batterielaufzeit mobiler Endgeräte
(insbesondere Laptops) heißt Power Management. Diese Anleitung hilft bei der
Einrichtung.
</abstract>

<!-- The content of this document is licensed under the CC-BY-SA license -->
<!-- See http://creativecommons.org/licenses/by-sa/2.0 -->
<license/>

<version>1.27</version>
<date>2006-02-16</date>

<chapter>
<title>Einführung</title>
<section>
<body>

<p>
In den vergangenen Jahren hat sich sowohl Kapazität als auch Lebenszeit von
Laptopbatterien deutlich verbessert. Auf der anderen Seite verbrauchen moderne
Prozessoren viel mehr Energie als ihre Vorfahren und jede neue
Laptopgeneration bringt neue, energiehungrige Komponenten mit sich. Aus diesem
Grund ist Power Management wichtiger denn je. Man muss nicht unbedingt eine neue
Batterie kaufen, um die Laufzeit eines Laptops zu verlängern. Bereits durch eine
intelligente Einrichtung des Power Managements kann man viel erreichen.
</p>

</body>
</section>

<section>
<title>Kurzübersicht</title>
<body>

<p>
Es sei darauf hingewiesen, das diese Anleitung die Einrichtung von Power
Management für <e>Laptops</e> beschreibt. Zwar können manche Teile davon auf
Server übertragen werden, nicht jedoch alle und manche können dort sogar Schaden
anrichten. Bitte versuchen Sie nicht, anhand dieser Anleitung einen Server
einzurichten.
</p>

<p>
Da diese Anleitung etwas länger geworden ist, gibt es zunächst eine
Kurzübersicht:
</p>

<p>
Das Kapitel <e>Voraussetzungen</e> behandelt einige Voraussetzungen, die
erfüllt sein müssen, bevor Sie sich in den nächsten Kapiteln an die
Konfiguration einzelner Geräte machen. Hier sind BIOS Einstellungen und die
Kernelkonfiguration zu überprüfen sowie einige Vereinfachungen im System
vorzunehmen. Die folgenden drei Kapitel konzentrieren sich auf die drei
Komponenten, die normalerweise am meisten Energie verbrauchen: Prozessor,
Bildschirm und Festplatte. Alle können unabhängig voneinander konfiguriert
werden.
<e>CPU Power Management</e> zeigt, wie man die Prozessorgeschwindigkeit
dynamisch so einstellt, das ein Maximum an Energie eingespart wird, ohne allzu
viel Leistung zu verlieren. Mit verschiedenen Tricks sorgt man in
<e>Fesplatten Power Management</e> dafür, dass die Festplatte möglichst lange
Zeit im Schlafzustand bleibt - und dämpft als angenehmen Nebeneffekt die
Geräuschentwicklung. Mit einigen Hinweisen zu Graphikkarten, WLAN und USB wird
der Abschnitt über einzelne Geräte in <e>Power Management für andere Geräte</e>
abgeschlossen. Ein weiteres Kapitel ist den (noch recht experimentellen)
Schlafzuständen gewidmet, bevor zuletzt in <e>Probleme und Lösungen</e> typische
Fallstricke und Stolpersteine behandelt werden.
</p>

</body>
</section>

<section>
<title>Power Budget für jede Komponente</title>
<body>

<figure link="http://www.gentoo.org/images/energy-budget.png" short="Welche
Komponente verbraucht wieviel Energie?" caption="Power Budget für jede
Komponente"/>

<p>
Fast alle Geräte kennen verschiedene Betriebszustände - schlafend, untätig,
aktiv um ein paar zu nennen. In jedem Zustand wird unterschiedlich viel
Energie verbraucht. Absolut gesehen verbrauchen LCD Bildschirm, Prozessor,
Chipsatz und Festplatte am meisten. Ein paar Einstellungen zum Power Management
kann man meistens bereits im BIOS vornehmen, doch mit einer vernünftigen, sich
an verschiedene Situationen anpassenden Einrichtung des Betriebssystems erreicht
man noch viel mehr.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Voraussetzungen</title>
<section>
<body>

<p>
Einige Voraussetzungen wollen erfüllt sein, bevor es an die Einrichtung der
einzelnen Komponenten geht. Nach der Kontrolle der BIOS Einstellungen geht
es an die Konfiguration des Kernels, wo ACPI, Schlafzustände und dynamische
Frequenzänderung des Prozessors aktiviert werden. Da Energiesparen meist mit
weniger Leistung oder schlechteren Reaktionszeiten einhergeht, sollte das
Power Management nur im Batteriemodus aktiviert werden. Hier erweist sich ein
neues Runlevel <e>battery</e> nützlich.
</p>

</body>
</section>
<section>
<title>BIOS Einrichtung</title>
<body>

<p>
Als erstes überprüfen Sie die Power Management Einstellungen im BIOS. Das BIOS
erreicht man durch Neustarten des Laptops und anschließendes Drücken der Taste
<e>Entfernen</e>, <e>F1</e> oder anderen Spezialtasten je nach Modell. Am
besten kombiniert man BIOS Einstellungen mit den Regeln, die später im
Betriebssystem erstellt werden. Zunächst ist es aber sinnvoller, im BIOS die
meisten Einstellungen zu deaktivieren. So verhindern Sie, dass Ihnen das BIOS
im Folgenden in die Quere kommt. Vergessen Sie nicht, die BIOS Einstellungen
zum Schluss zu korrigieren.
</p>

</body>
</section>
<section>
<title>Setzen von USE Flags</title>
<body>

<p>
Vergewissern Sie sich, dass das <c>acpi</c> USE Flag in
<path>/etc/make.conf</path>. gesetzt ist. Weitere USE Flags, die für Ihr System
von Interesse sein können, sind <c>apm</c>, <c>lm_sensors</c>, <c>nforce2</c>,
<c>nvidia</c>, <c>pmu</c>. Details zu den USE Flags finden Sie in
<path>/usr/portage/profiles/use*.desc</path>. Falls Sie vergessen haben, eines
dieser Flags zu aktivieren, können Sie mit Hilfe der <c>--newuse</c> Option von
emerge betroffene Pakete neu kompilieren, siehe <c>man 1 emerge</c>.
</p>

</body>
</section>
<section>
<title>Einrichtung des Kernels</title>
<body>

<p>
Die ACPI (Advanced Configuration and Power Interface) Unterstützung im Kernel
ist immer noch in der Entwicklung. Daher sollte man durch die Verwendung eines
aktuellen Kernels sicherstellen, die neuesten Quellen zu haben.
</p>

<p>
Portage enthält verschiedene Kernel Quellen. Ich empfehle die Benutzung von
<c>gentoo-sources</c> oder <c>suspend2-sources</c>. Letzere enthalten Patche
für Software Suspend 2, Details dazu im Kapitel zu Schlafzuständen. Bei der
Konfiguration des Kernels muss man mindestens folgende Optionen aktivieren:
</p>

<pre caption="Minimales Setup für Power Management (Kernel 2.6)">
Power Management Options ---&gt;
  [*] Power Management Support
  [ ] Software Suspend

  ACPI( Advanced Configuration and Power Interface ) Support ---&gt;
    [*] ACPI Support
    [ ]   Sleep States
    [ ]     /proc/acpi/sleep (deprecated)
    [*]   AC Adapter
    [*]   Battery
    &lt;M&gt;   Button
    &lt;M&gt;   Video
    [ ]   Generic Hotkey
    &lt;M&gt;   Fan
    &lt;M&gt;   Processor
    &lt;M&gt;     Thermal Zone
    &lt; &gt;   ASUS/Medion Laptop Extras
    &lt; &gt;   IBM ThinkPad Laptop Extras
    &lt; &gt;   Toshiba Laptop Extras
    (0)   Disable ACPI for systems before Jan 1st this year
    [ ]   Debug Statements
    [*]   Power Management Timer Support
    &lt; &gt;   ACPI0004,PNP0A05 and PNP0A06 Container Driver (EXPERIMENTAL)

  CPU Frequency Scaling ---&gt;
    [*] CPU Frequency scaling
    [ ]   Enable CPUfreq debugging
    &lt; &gt;   CPU frequency translation statistics
    [ ]     CPU frequency translation statistics details
          Default CPUFreq governor (userspace)
    &lt;*&gt;   'performance' governor
    &lt;*&gt;   'powersave' governor
    &lt;*&gt;   'ondemand' cpufreq policy governor
    &lt;*&gt;   'conservative' cpufreq governor
    &lt;*&gt;   CPU frequency table helpers
    &lt;M&gt; ACPI Processor P-States driver
    &lt;*&gt; <i>CPUFreq driver for your processor</i>
</pre>

<p>
Entscheiden Sie selbst, ob Sie die Schlafzustände Software Suspend und
Suspend-to-Disk benutzen wollen (siehe unten). Falls Sie einen ASUS, IBM
Thinkpad oder Toshiba Laptop ihr Eigen nennen, aktivieren Sie die entsprechende
Option.
</p>

<p>
Der Kernel muss wissen, wie Frequenzänderungen bei ihrem Prozessor angesteuert
werden. Da die verschiedenen CPUs unterschiedliche Schnittstellen besitzen,
müssen Sie den richtigen Treiber für ihren Prozessor auswählen. Gehen Sie
sorgfältig vor - die Aktivierung von <e>Intel Pentium 4 clock modulation</e>
auf einem Pentium M System wird sonderbare Ergebnisse erzielen. Ziehen Sie die
Kernel Dokumentation zu Rate, wenn Sie nicht wissen, welcher Treiber der
richtige ist.
</p>

<p>
Kompilieren Sie den Kernel, booten ihn und stellen Sie sicher, dass die
notwendigen Module beim Start geladen werden. Als nächstes führen Sie
<c>emerge sys-apps/acpid</c> aus, um den acpi Dämon zu installieren.
<c>acpid</c> reagiert auf ACPI Ereignisse wie das Schließen des Laptops oder
das Wechseln der Stromquelle. Als nächstes starten Sie acpid per
<c>/etc/init.d/acpid start</c>. Mit <c>rc-update add acpid default</c> wird
acpid fortan automatisch gestartet. Zur Benutzung von acpid kommen wir gleich.
</p>

<pre caption="Installing acpid">
# <i>emerge sys-power/acpid</i>
# <i>/etc/init.d/acpid start</i>
# <i>rc-update add acpid default</i>
</pre>

</body>
</section>
<section>
<title>Ein Runlevel "battery" erstellen</title>
<body>

<p>
Power Management soll nur aktiviert werden, wenn der Laptop von Batterie
läuft. Um die (De-)Aktivierung der verschiedenen Power Management Regeln
komfortabel durchzuführen, erstellen Sie ein neues Runlevel <e>battery</e>, das
alle Skripte zum Starten und Stoppen des Power Managements enthält. Später
konfigurieren Sie <c>acpid</c> so, dass er je nach Stromquelle in das
entsprechende Runlevel wechselt.
</p>

<note>
Wenn Sie kein neues Runlevel erstellen wollen, können Sie diesen Abschnitt
überspringen. Allerdings wird dadurch die übrige Einrichtung etwas schwieriger.
Im folgenden wird davon ausgegangen, dass es ein Runlevel <e>battery</e> gibt.
</note>

<pre caption="Ein Runlevel battery erzeugen">
# <i>cd /etc/runlevels</i>
# <i>cp -a default battery</i>
</pre>

<p>
Fertig. Ihr neues Runlevel <e>battery</e> ist im Moment mit dem Runlevel
<e>default</e> identisch. Die nächste Aufgabe wird sein, <e>battery</e>
anzupassen und je nach Stromquelle automatisch die Runlevel zu wechseln.
</p>

</body>
</section>
<section>
<title>Auf ACPI Ereignisse reagieren</title>
<body>

<p>
Typische ACPI Ereignisse sind das Schließen des Laptops, Wechseln der
Stromquelle oder Drücken der Ruhezustand Taste. Ein wichtiges Ereignis ist das
Wechseln der Stromquelle, das eine Änderung des aktiven Runlevels auslösen
soll. Ein kleines Skript kümmert sich darum.
</p>

<p>
Zunächst brauchen Sie ein Skript, das abhängig von der Stromversorgung in das
Runlevel <c>default</c> bzw. <c>battery</c> wechselt. Das Skript benutzt das
<c>on_ac_power</c> Programm von <c>sys-power/powermgmt-base</c> - stellen Sie
sicher, dass dieses Paket auf ihrem System installiert ist.
</p>

<pre caption="Installation von powermgt-base">
<i># emerge powermgmt-base</i>
</pre>

<p>
Sie sind jetzt in der Lage, durch Aufruf von
<c>on_ac_power &amp;&amp; echo AC available || echo Running on batteries</c> in
einer Konsole den aktuellen Stromzustand anzuzeigen. Das unten aufgelistete
Skript übernimmt den Wechsel des Runlevels. Speichern Sie es als
<path>/etc/acpi/actions/pmg_switch_runlevel.sh</path> ab.
</p>

<pre caption="/etc/acpi/actions/pmg_switch_runlevel.sh">
#!/bin/bash

<comment># Anfang der Konfiguration</comment>
RUNLEVEL_AC="default"
RUNLEVEL_BATTERY="battery"
<comment># Ende der Konfiguration</comment>


if [ ! -d "/etc/runlevels/${RUNLEVEL_AC}" ]
then
        logger "${0}: Runlevel ${RUNLEVEL_AC} does not exist. Aborting."
        exit 1
fi

if [ ! -d "/etc/runlevels/${RUNLEVEL_BATTERY}" ]
then
        logger "${0}: Runlevel ${RUNLEVEL_BATTERY} does not exist. Aborting."
        exit 1
fi

if on_ac_power
then
    if [[ "$(cat /var/lib/init.d/softlevel)" != "${RUNLEVEL_AC}" ]]
  then
            logger "Switching to ${RUNLEVEL_AC} runlevel"
            /sbin/rc ${RUNLEVEL_AC}
        fi
elif [[ "$(cat /var/lib/init.d/softlevel)" != "${RUNLEVEL_BATTERY}" ]]
then
        logger "Switching to ${RUNLEVEL_BATTERY} runlevel"
        /sbin/rc ${RUNLEVEL_BATTERY}
fi
</pre>

<p>
Vergessen Sie nicht, das Skript durch Aufruf von
<c>chmod +x /etc/acpi/actions/pmg_switch_runlevel.sh</c> ausführbar zu machen.
Zuletzt muss noch dafür gesorgt werden, dass dieses Skript aufgerufen wird,
sobald sich die Stromversorgung ändert. Das geschieht durch Abfangen der dabei
ausgelösten ACPI Ereignisse mit Hilfe von <c>acpid</c>. Zunächst müssen Sie
aber wissen, welche Ereignisse beim Wechseln der Stromversorgung ausgelöst
werden. Meistens sind das <e>ac_adapter</e> und <e>battery</e>, es könnte auf
ihrem Laptop aber auch anders sein.
</p>

<pre caption="Welche ACPI Ereignisse werden beim Wechseln der
Stromzufuhr ausgelöst?">
<i># tail -f /var/log/acpid | grep "received event"</i>
</pre>

<p>
Führen Sie obiges Kommando aus und ziehen Sie das Stromkabel ab. Sie sollten
eine Ausgabe ähnlich der folgenden sehen:
</p>

<pre caption="Beispielhafte Ausgabe bei Wechsel der Stromzufuhr">
[Tue Sep 20 17:39:06 2005] received event "ac_adapter AC 00000080 00000000"
[Tue Sep 20 17:39:06 2005] received event "battery BAT0 00000080 00000001"
</pre>

<p>
Uns interessiert dabei der Teil in Anführungszeichen nach <e>received event</e>.
Er wird von der event Zeile abgedeckt, die Sie weiter unten anlegen werden.
Machen Sie sich keine Sorgen, falls ihr System mehrere oder immer dasselbe
Ereignis erzeugt. Solange nur irgendein Ereignis generiert wird, funktioniert
das Wechseln des Runlevels.
</p>

<pre caption="/etc/acpi/events/pmg_ac_adapter">
<comment># Ersetzen Sie "ac_adapter" durch das Ereignis, das auf ihrem Laptop erzeugt wird</comment>
<comment># Beispielsweise trifft ac_adapter.* auf ac_adapter AC 00000080 00000000 zu</comment>
event=ac_adapter.*
action=/etc/acpi/actions/pmg_switch_runlevel.sh %e
</pre>

<pre caption="/etc/acpi/events/pmg_battery">
<comment># Ersetzen Sie "battery" durch das Ereignis, das auf ihrem Laptop erzeugt wird</comment>
<comment># Beispielsweise trifft battery.* auf battery BAT0 00000080 00000001 zu</comment>
event=battery.*
action=/etc/acpi/actions/pmg_switch_runlevel.sh %e
</pre>

<p>
Abschließend muss acpid neu gestartet werden, um die Änderungen zu erkennen.
</p>

<pre caption="Abschluss der Einrichtung des automatischen Wechselns des
Runlevels">
<i># /etc/init.d/acpid restart</i>
</pre>

<p>
Probieren Sie es aus: Trennen Sie Ihren Laptop vom Stromnetz und beobachten
Sie die Meldung "Switching to battery mode" im syslog.
</p>

<p>
Ein Problem gilt es noch zu lösen: Beim Booten wird unabhängig von der
Stromquelle das Runlevel default gestartet. Das liegt daran, dass beim Booten
kein ACPI Ereignis ausgelöst wird. Eine Möglichkeit wäre, einen neuen Eintrag
in den Bootloader aufzunehmen, der über den Kernelparameter
<e>softlevel=battery</e> das Runlevel battery starten würde. Einfacher ist es
aber, beim Booten ein ACPI Ereignis vorzutäuschen.
<path>pmg_switch_runlevel.sh</path>entscheidet dann, ob ein Wechsel des
Runlevels nötig ist. Öffnen Sie <path>/etc/conf.d/local.start</path> in Ihrem
Lieblingseditor und ergänzen Sie folgende Zeilen:
</p>

<pre caption="local.start bearbeiten, um richtiges Runlevel beim Booten zu
starten">
<comment># Vortäuschung des ACPI Ereignisses battery/battery</comment>
/etc/acpi/actions/pmg_switch_runlevel.sh "battery/battery"
</pre>

<p>
Nach diesen Vorbereitungen können die einzelnen Geräte konfiguriert werden.
</p>

</body>
</section>
</chapter>

<chapter>
<title>CPU Power Management</title>
<section>
<body>

<p>
Mobile Prozessoren können Ihre Taktfrequenz variieren. Einige erlauben sogar
eine Anpassung der Spannung. Da ihre CPU die meiste Zeit nicht vollständig
ausgelastet ist, muss sie auch nicht auf der höchsten Frequenz laufen und
eine Verringerung selbiger wird viel Energie sparen - meist ohne
Leistungseinbußen.
</p>

</body>
</section>
<section>
<title>Erklärung einiger technischer Begriffe</title>
<body>

<p>
Im Zusammenhang mit Freqenzänderungen der CPU tauchen Begriffe, die Ihnen
möglicherweise unbekannt sind. Hier ist eine kleine Übersicht.
</p>

<p>
Zunächst einmal muss der Kernel in der Lage sein, die Frequenz der CPU
anzupassen. Der CPUfreq Prozessortreiber kümmert sich bei ihrer CPU darum. Aus
diesem Grund ist es wichtig, im Kernel den richtigen Treiber auszuwählen. Sie
sollten das bereits weiter oben erledigt haben. Hat der Kernel nun die
Möglichkeit, verschiedene Frequenzen auszuwählen, muss er sich zu einem
Zeitpunkt für eine davon entscheiden. Die Auswahl der Frequenz erfolgt gemäß
einer <e>Taktik</e> (englisch policy), die wiederum aus einer <e>CPUfreq
Taktik</e> und einem <e>Regler</e> (englisch governor) besteht. Eine CPUfreq
Taktik ist lediglich eine minimale und eine maximale Taktfrequenz, zwischen
denen die gewählte Frequenz liegen muss. Der Regler entscheidet dann, welche der
in diesem Bereich verfügbaren Frequenzen verwendet wird. Beispielsweise
entscheidet sich der <e>powersave Regler</e> immer für die kleinste mögliche
Frequenz und der <e>performance Regler</e> für die größtmögliche. Der
<e>userspace Regler</e> trifft keine eigenmächtige Entscheidung, sondern
übernimmt die Vorgabe des Benutzers (oder eines Programms im userspace). Das
heißt praktisch, dass er die Frequenz aus der Datei
<path>/sys/devices/system/cpu/cpu0/cpufreq/scaling_setspeed</path> ausliest.
</p>

<p>
Bisher hört sich das ganze noch nicht unbedingt nach dynamischer
Frequenzänderung an und in der Tat ist es das auch noch nicht. Dynamik erreicht
man aber durch unterschiedliche Ansätze. Beispielsweise trifft der <e>ondemand
Regler</e> seine Entscheidung in Abhängigkeit von der Auslastung der CPU.
Gleiches erledigen verschiedene Programme wie <c>cpudyn</c>,
<c>cpufreqd</c>, <c>powernowd</c>. ACPI Ereignisse können dazu benutzt werden,
dynamische Frequenzänderungen zu aktivieren oder abzuschalten.
</p>

</body>
</section>
<section>
<title>Manuelles Setzen der Frequenz</title>
<body>

<p>
Eine Verminderung der Prozessorgeschwindigkeit bringt zwei Vorteile: Zum einen
wird weniger Energie verbraucht, zum anderen entwickelt sich weniger Wärme.
Demgegenüber steht natürlich ein Verlust an Performanz. Der Trick ist nun,
eine Prozessorgeschwindigkeit auszuwählen, die hoch genug ist, um flüssiges
Arbeiten zu ermöglichen, gleichzeitig aber so niedrig, dass der Prozessor
maximal ausgelastet ist.
</p>

<note>
Das Ändern der Prozessorgeschwindigkeit (engl. frequency scaling,
speedstepping) wird nicht von jedem Laptop unterstützt. Das Kapitel <e>Probleme
und Lösungen</e> enthält eine Liste der unterstützten Prozessoren.
</note>

<p>
Es ist an der Zeit, das Ändern der Prozessorgeschwindigkeit zu testen. Zum
Einstieg ein paar manuelle Änderungen:
</p>

<pre caption="Checking CPU frequency">
# <i>emerge cpufrequtils</i>
# <i>cpufreq-info</i>
</pre>

<p>
Hier ist eine beispielhafte Ausgabe:
</p>

<pre caption="Beispielsausgabe von cpufreq-info">
cpufrequtils 0.3: cpufreq-info (C) Dominik Brodowski 2004
Bitte melden Sie Fehler an linux@brodo.de.
analysiere CPU 0:
  Treiber: centrino
  Folgende CPUs können nur gleichzeitig ihre Frequenz variieren: 0
  Hardwarebedingte Grenzen der Taktfrequenz: 600 MHz - 1.40 GHz
  mögliche Taktfrequenzen: 600 MHz, 800 MHz, 1000 MHz, 1.20 GHz, 1.40 GHz
  mögliche Regler: conservative, ondemand, powersave, userspace, performance
  momentane Taktik: die Frequenz soll innerhalb 1.40 GHz und 1.40 GHz.
    liegen. Der Regler "performance" kann frei entscheiden,
    welche Taktfrequenz innerhalb dieser Grenze verwendet wird.
  momentane Taktfrequenz ist 1.40 GHz  (verifiziert durch Nachfrage bei der
  Hardware).
</pre>

<p>
Probieren Sie ein paar Optionen von <c>cpufreq-set</c> aus, um sicherzugehen,
das die Änderung der CPU Frequenz richtig funktioniert. Beispielsweise können
Sie durch Aufruf von <c>cpufreq-set -g ondemand</c> den ondemand Regler
aktivieren und die Änderung durch <c>cpufreq-info</c> überprüfen. Das Kapitel
Probleme und Lösungen hilft bei eventuell auftretenden Schwierigkeiten weiter.
</p>

</body>
</section>
<section>
<title>Automatische Anpassung der Prozessorgeschwindigkeit</title>
<body>

<p>
Das manuelle Setzen der Geschwindigkeit ist keine Lösung für den Alltag. Es
gibt eine Reihe unterschiedlicher Ansätze, diese Aufgabe zu automatisieren. Die
folgende Tabelle stellt einige kurz vor. Sie ist grob eingeteilt in die drei
Kategorien <e>Kernel</e> für Ansätze, die Kernelunterstützung benötigen,
<e>Daemon</e> für Programme, die unsichtbar im Hintergrund arbeiten und
<e>GUI</e> für Programme, die eine grafische Oberfläche zur einfachen
Konfiguration bieten.
</p>

<table>
<tr>
  <th>Name</th>
  <th>Kategorie</th>
  <th>Entscheidung über Frequenzwechsel</th>
  <th>Kernel Regler</th>
  <th>Eigene Regler</th>
  <th>Kommentare</th>
</tr>
<tr>
  <ti>'ondemand' Regler</ti>
  <ti>Kernel</ti>
  <ti>CPU Auslastung</ti>
  <ti>N.A.</ti>
  <ti>N.A.</ti>
  <ti>
    Wählt die größtmögliche Frequenz bei Auslastung der CPU und reduziert die
    Frequenz andernfalls. Weitere Einstellungen können in
    <path>/sys/devices/system/cpu/cpu0/cpufreq/ondemand/</path> vorgenommen
    werden. Es werden weitere Programme oder Skripte benötigt, wenn ein Wechseln
    des Reglers oder ähnliches gewünscht wird.
  </ti>
</tr>
<tr>
  <ti>'conservative' governor</ti>
  <ti>Kernel</ti>
  <ti>CPU load</ti>
  <ti>N.A.</ti>
  <ti>N.A.</ti>
  <ti>
    Im Gegensatz zum ondemand Regler wird nicht zur größtmöglichen Frequenz
    gesprungen, wenn die CPU ausgelastet ist, sondern eine stufenweise
    Frequnzerhöhung vorgenommen.
    Wählt die größtmögliche Frequenz bei Auslastung der CPU und reduziert die
    Frequenz andernfalls. Weitere Einstellungen können in
    <path>/sys/devices/system/cpu/cpu0/cpufreq/conservative/</path> vorgenommen
    werden. Es werden weitere Programme oder Skripte benötigt, wenn ein Wechseln
    des Reglers oder ähnliches gewünscht wird.
  </ti>
</tr>
<tr>
  <ti><uri link="http://mnm.uib.es/~gallir/cpudyn/">cpudyn</uri></ti>
  <ti>Daemon</ti>
  <ti>CPU Auslastung</ti>
  <ti>Performance, powersave</ti>
  <ti>Dynamic</ti>
  <ti>
    Unterstütz auch Standby für die Festplatte - normalerweise erreicht man
    aber durch den <e>laptop mode</e> bessere Ergebnisse.
  </ti>
</tr>
<tr>
  <ti><uri link="http://sourceforge.net/projects/cpufreqd/">cpufreqd</uri></ti>
  <ti>Daemon</ti>
  <ti>Batteriezustand, CPU Auslastung, Temperatur, laufende Programme und mehr</ti>
  <ti>Alle verfügbaren</ti>
  <ti>Keine</ti>
  <ti>
    Ausgefeilte (damit aber auch komplizierte) Konfigurationsmöglichkeiten.
    Erweiterbar durch Plugins wie Überwachung von Sensoren (lm_sensors) oder
    Abstimming einiger Grafikkarten von NVidia. Cpufreqd kann mit 
    Multiprozessorsystemen (SMP) umgehen und besitzt einen manuellen Modus.
  </ti>
</tr>
<tr>
  <ti>
    <uri link="http://www.deater.net/john/powernowd.html">powernowd</uri>
  </ti>
  <ti>Daemon</ti>
  <ti>CPU Auslastung</ti>
  <ti>Keine</ti>
  <ti>Passive, sine, aggressive</ti>
  <ti>
    Unterstützt Mehrprozessorsysteme.
  </ti>
</tr>
<tr>
  <ti>
    <uri link="http://fatcat.ftj.agh.edu.pl/~nelchael/index.php?cat=projs&amp;subcat=ncpufreqd&amp;language=en">ncpufreqd</uri>
  </ti>
  <ti>Daemon</ti>
  <ti>Temperature</ti>
  <ti>Keine</ti>
  <ti>Powersave, performance</ti>
  <ti>
    Wechselt den Regler zwischen performance and powersave je nach
    Temperatur des Systems. Sehr nützlich für Laptops mit notorischen
    Temperaturproblemen.
  </ti>
</tr>
<tr>
  <ti><uri link="http://www.goop.org/~jeremy/speedfreq/">speedfreq</uri></ti>
  <ti>Daemon</ti>
  <ti>CPU Auslastung</ti>
  <ti>Keine</ti>
  <ti>Dynamic, powersave, performance, fixed speed</ti>
  <ti>
    Einfache Konfiguration mit einer schönen Client/Server Schnittstelle. Setzt
    einen Kernel 2.6 voraus. Wird nicht gewartet, enthält Bugs und wurde aus
    diesem  Grund aus Portage entfernt. Wenn Sie speedfreq immer noch einsetzen,
    wechseln  Sie bitte auf cpufreqd.
  </ti>
</tr>
<tr>
  <ti><uri link="http://cpuspeedy.sourceforge.net/">gtk-cpuspeedy</uri></ti>
  <ti>GUI</ti>
  <ti>Keine</ti>
  <ti>Keine</ti>
  <ti>Keine</ti>
  <ti>
    Gnome Applikation, ein grafisches Tool zum manuellen Wechsel der CPU
    Frequenz. Bietet keine Möglichkeiten zur automatischen Anpassung an.
  </ti>
</tr>
<tr>
  <ti>klaptopdaemon</ti>
  <ti>GUI</ti>
  <ti>Batteriezustand</ti>
  <ti>Alle verfügbaren</ti>
  <ti>Keine</ti>
  <ti>
    KDE Applikation, 'ondemand' Regler wird für dynamische
    Freqenzänderungen benötigt.
  </ti>
</tr>
</table>

<p>
Eine automatische Anpassung der Prozessorgeschwindigkeit erscheint auf den
ersten Blick einfach. In der Tat ist es allerdings etwas komplizierter - ein
schlechter Algorithmus kann dazu führen, dass ständig zwischen zwei
Geschwindigkeiten umgeschaltet wird oder die Geschwindigkeit unnötig hoch ist.
</p>

<p>
Sie haben die Qual der Wahl. Falls Sie sich nicht entscheiden können,
probieren Sie zunächst <c>cpufreqd</c> aus.
</p>

<pre caption="Installation von cpufreqd">
# <i>emerge cpufreqd</i>
</pre>

<p>
<c>cpufreqd</c> wird in der Datei <path>/etc/cpufreqd.conf</path> konfiguriert.
Die standardmäßig installierte Konfigurationsdatei sieht auf den ersten Blick
etwas verwirrend aus. Ich empfehle, sie durch die Konfigurationsdatei von
Gentoo Entwickler Henrik Brix Andersen (siehe unten) zu ersetzen. Sie benötigen
dafür cpufreqd-2.0.0 oder neuer. Ältere Versionen setzen eine andere Syntax f+r
die Konfigurationsdatei ein.
</p>

<pre caption="/etc/cpufreqd.conf (cpufreqd-2.0.0 und später)">
[General]
pidfile=/var/run/cpufreqd.pid
poll_interval=3
enable_plugins=acpi_ac, acpi_battery
enable_remote=1
remote_group=wheel
[/General]

[Profile]
name=ondemand
minfreq=0%
maxfreq=100%
policy=ondemand
[/Profile]

[Profile]
name=conservative
minfreq=0%
maxfreq=100%
policy=conservative
[/Profile]

[Profile]
name=powersave
minfreq=0%
maxfreq=100%
policy=powersave
[/Profile]

[Profile]
name=performance
minfreq=0%
maxfreq=100%
policy=performance
[/Profile]

[Rule]
name=battery
ac=off
profile=conservative
[/Rule]

[Rule]
name=battery_low
ac=off
battery_interval=0-10
profile=powersave
[/Rule]

[Rule]
name=ac
ac=on
profile=ondemand
[/Rule]
</pre>

<p>
Jetzt können Sie den cpufreqd Daemon starten. Fügen Sie ihn weiterhin zum
<e>default</e> und zum <e>battery</e> Runlevel hinzu.
</p>

<pre caption="Starten von cpufreqd">
# <i>rc-update add cpufreqd default battery</i>
# <i>rc</i>
</pre>

<p>
Manchmal möchte man eine andere Frequenz wählen als der Daemon, beispielsweise
wenn der Batteriestand niedrig ist, aber in Kürze wieder Stromversorgung
verfügbar sein wird. In diesem Fall kann man den manuellen Modus von cpufreqd
per <c>cpufreqd-set manual</c> aktivieren und eine der konfigurierten Taktiken
(so wie von <c>cpufreqd-get</c> aufgelistet) wählen. Man verlässt den manuellen
Modus durch Aufruf von <c>cpufreqd-set dynamic</c>.
</p>

<warn>
Führen Sie nicht mehrere der oben aufgeführten Programme gleichzeitig aus. Das
kann dazu führen, dass ständig zwischen zwei Geschwindigkeiten hin- und
hergesprungen wird.
</warn>

</body>
</section>

<section>
<title>Verifying the result</title>

<body>

<p>
Zum Schluss sollten Sie überprüfen, dass die neuen Regeln gut funktionieren.
Das kann man auf einfache Weise kontrollieren, indem man die
Prozessorgeschwindigkeit eine Zeitlang überwacht.
</p>

<pre caption="Prozessorgeschwindigkeit überwachen">
# <i>watch grep \"cpu MHz\" /proc/cpuinfo</i>
</pre>

<p>
Falls <path>/proc/cpuinfo</path> bei Ihnen nicht aktualisiert wird (siehe
Probleme und Lösungen), benutzen Sie bitte folgenden Befehl:
</p>

<pre caption="Alternative Überwachung der Prozessorgeschwindigkeit">
# <i>watch x86info -mhz</i>
</pre>

<p>
Abhängig von ihrer Konfiguration sollte die Geschwindigkeit bei starker
Prozessornutzung ansteigen, bei wenig Aktivität sinken oder einfach auf dem
gleichen Niveau bleiben. Wenn Sie cpufreqd benutzen und verbosity in
<path>cpufreqd.conf</path> auf 5 oder höher gesetzt ist, erhalten Sie weitere
Details zu den Vorgängen im syslog.
</p>

</body>
</section>
</chapter>

<chapter>
<title>LCD Power Management</title>
<section>
<body>

<p>
Wie man in <uri link="#doc_chap1_fig1">Bild 1.1</uri> sieht, verbraucht der
LCD Bildschirm typischerweise am meisten Energie. Aus diesem Grund ist es nicht
nur wichtig, den Bildschirm bei Nichtgebrauch abzuschalten, sondern auch eine
Reduzierung der Hintergrundbeleuchtung kann viel Energie einsparen. Die
meisten Laptops bieten diese Möglichkeit ebenfalls an.
</p>

</body>
</section>
<section>
<title>Standby Einstellungen</title>
<body>

<p>
Als ersten sollten Sie die Einstellungen zu Standby/Suspend/Abschalten des
Bildschirms überprüfen. Bitte konsultieren Sie dazu gegebenenfalls das
Handbuch ihres Windowmanagers. Terminals können mit den Befehlen
<c>setterm -blank &lt;anzahl-der-minutenM&gt;</c>, <c>setterm -powersave on</c>
und <c>setterm -powerdown &lt;anzahl-der-minutenM&gt;</c> kontrolliert werden.
In Xorg ändert man <path>/etc/X11/xorg.conf</path>:
</p>

<pre caption="LCD-Suspend Einstellungen in X.org und XFree86">
Section "ServerLayout"
  Identifier  [...]
  [...]
  Option  "BlankTime"  "5"  <comment># Schwärzt den Bildschirm nach 5 Minuten (unecht)</comment>
  Option  "StandbyTime"  "10"  <comment># Stellt den Bildschirm nach 10 Minuten aus (DPMS)</comment>
  Option  "SuspendTime"  "20"  <comment># Komplettes Suspend nach 20 Minuten</comment>
  Option  "OffTime"  "30"  <comment># Ausschalten nach einer halben Stunde</comment>
  [...]
EndSection

[...]

Section "Monitor"
  Identifier  [...]
  Option  "DPMS"  "true"
  [...]
EndSection
</pre>

<p>
In XFree86 sieht es genauso aus, nur heißt die Datei
<path>/etc/X11/XF86Config</path>.
</p>

</body>
</section>
<section>
<title>Dimmen der Hintergrundbeleuchtung</title>
<body>

<p>
Wohl noch wichtiger ist es, die Hintergrundbeleuchtung zu dimmen. Falls Sie
die Einstellungen mit einem Programm steuern können, schreiben Sie ein
einfaches Skript und platzieren es im <e>battery</e> Runlevel. Das folgende
Skript sollte auf den meisten IBM Thinkpads und Toshiba Laptops funktionieren.
Sie müssen dafür die entsprechende Option im Kernel aktivieren (nur IBM
Thinkpads). Bei Toshiba Laptops muss zunächst das <c>app-laptop/acpitool</c>
Paket installiert werden. Überspringen Sie die Konfiguration von ibm_acpi
(siehe unten) in diesem Fall.
</p>

<warn>
Die Unterstützung zum Einstellen der Hintergrundbeleuchtung ist in ibm-acpi als
experimentell markiert. Es wird direkt auf die Hardware zugegriffen und kann
ernsthaften Schaden im System anrichten. Bitte informieren Sie sich auf der
<uri link="http://ibm-acpi.sourceforge.net/">ibm-acpi Internetseite</uri>
</warn>

<p>
Um die Hintergrundbeleuchtung verändern zu können, muss das ibm_acpi Modul mit
dem Parameter experimental geladen werden.
</p>

<pre caption="Automatisches Laden des ibm_acpi Moduls">
<comment>(Bitte beachten Sie obige Warnungen!)</comment>
<i># echo "options ibm_acpi experimental=1" >> /etc/modules.d/ibm_acpi</i>
<i># /sbin/modules-update</i>
<i># echo ibm_acpi >> /etc/modules.autoload.d/kernel-2.6</i>
<i># modprobe ibm_acpi</i>
</pre>

<p>
Obige Kommandos sollten ohne Fehlermeldungen ausgeführt werden und eine Datei
<path>/proc/acpi/ibm/brightness</path> erzeugt werden. Ein Init Skript
übernimmt die Einstellung der Hintergrundbeleuchtung passend zum Stromzustand.
</p>

<pre caption="/etc/conf.d/lcd-brightness">
<comment># /proc/acpi/ibm/brightness listet mögliche Werte auf</comment>
<comment># Bitte lesen Sie /usr/src/linux/Documentation/ibm-acpi.txt</comment>

<comment># Level der Hintergrundbeleuchtung bei Netzstrom. Standardmäßig 7.</comment>
BRIGHTNESS_AC=7

<comment># Level der Hintergrundbeleuchtung im Batteriemodus. Standardmäßig 4.</comment>
BRIGHTNESS_BATTERY=4
</pre>

<pre caption="/etc/init.d/lcd-brightness">
#!/sbin/runscript

set_brightness() {
    if on_ac_power
    then
        LEVEL=${BRIGHTNESS_AC:-7}
    else
        LEVEL=${BRIGHTNESS_BATTERY:-4}
    fi

    if [ -f /proc/acpi/ibm/brightness ]
    then
        ebegin "Setting LCD brightness"
        echo "level ${LEVEL}" > /proc/acpi/ibm/brightness
        eend $?
    elif [[ -e /usr/bin/acpitool &amp;&amp; -n $(acpitool -T | grep "LCD brightness") ]]
        then
        ebegin "Setting LCD brightness"
        acpitool -l $LEVEL >/dev/null || ewarn "Unable to set lcd brightness"
        eend $?
    else
        ewarn "Setting LCD brightness is not supported."
        ewarn "For IBM Thinkpads, check that ibm_acpi is loaded into the kernel"
        ewarn "For Toshiba laptops, you've got to install app-laptop/acpitool"
    fi
}

start() {
    set_brightness
}

stop () {
    set_brightness
}
</pre>

<p>
Nach dem Abspeichern des Skripts fügen Sie es dem battery Runlevel hinzu.
</p>

<pre caption="Aktivieren der automatischen Anpassung der
Hintergrundbeleuchtung">
<i># chmod +x /etc/init.d/lcd-brightness</i>
<i># rc-update add lcd-brightness battery</i>
<i># rc</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Festplatten Power Management</title>
<section>
<body>
<p>
Festplatten verbrauchen im Ruhezustand weniger Energie. Aus diesem Grund sollte
man Ruhezustände aktivieren, sobald die Festplatte eine bestimmte Zeit lang
nicht benutzt wird. Ich zeige Ihnen zwei Möglichkeiten, wie man das
bewerkstelligen kann. Zunächst kann man mit Hilfe des sogenannten laptop-mode
am meisten Energie sparen, da verschiedene Maßnahmen dafür sorgen, dass 
Schreibzugriffe nicht oder zumindest später ausgeführt werden. Der Nachteil
ist, dass ein Stromausfall oder Kernelabsturz eine höhere Gefahr für
Datenverlust darstellt als sonst. Wenn Sie dieses Risiko nicht eingehen wollen,
müssen Sie besonders darauf achten, dass keine Prozesse häufig schreibend auf
die Festplatte zugreifen. Danach können Sie als zweite Alternative die
Stromsparmaßnahmen ihrer Festplatte per hdparm aktivieren.
</p>

</body>
</section>

<section>
<title>Mehr idle Zeit - laptop-mode</title>
<body>

<p>
Aktuelle Kernel (2.6.6 und neuer, aktuelle Kernel der 2.4 Serie und weitere mit
Patches) beinhalten den sogenannten <e>laptop-mode</e>. Einmal aktiviert, werden
"dirty buffers" (veränderte Speicherstellen) bei Lesezugriffen oder erst nach 
10 Minuten (anstelle der sonstigen 30 Sekunden) auf die Festplatte geschrieben.
Dadurch wird die Zeit minimiert, während der die Festplatte aktiv sein muss.
</p>

<pre caption="Automatischer Start von laptop-mode">
# <i>emerge laptop-mode-tools</i>
</pre>

<p>
<c>laptop-mode-tools</c> wird in <path>/etc/laptop-mode/laptop-mode.conf</path>
konfiguriert. Passen Sie die Datei nach Ihren Wünschen an, sie ist sehr
ausführlich dokumentiert. Durch Aufruf von
<c>rc-update add laptop_mode battery</c> wird der laptop-mode automatisch im 
Batteriezustand aktiviert.
</p>

<p>
Neuere Versionen (ab 1.11) der laptop-mode-tools kommen mit einem neuen
Programm <c>lm-profiler</c>. Damit können Sie die Auslastung von Festplatte
und Netzwerk überwachen lassen und Empfehlungen erhalten, gewisse Dienste zu
deaktiveren. Die Dienste können entweder durch die in laptop-mode-tools
eingebaute Runlevelunterstützung deaktiviert werden (was von Gentoos 
<c>/sbin/rc</c> rückgängig gemacht würde) oder durch Manipulation Ihrer
<e>default</e>/<e>battery</e> Runlevel (empfohlen).
</p>

<pre caption="Beispielsausgabe von lm-profiler">
# lm-profiler
Profiling session started.
Time remaining: 600 seconds
[4296896.602000] amarokapp
Time remaining: 599 seconds
[4296897.714000] sort
[4296897.970000] mv
Time remaining: 598 seconds
Time remaining: 597 seconds
[4296900.482000] reiserfs/0
</pre>

<p>
Nachdem es 10 Minuten lang Ihr System analysiert hat, wird lm-profiler eine
Liste von Diensten ausgeben, die in diesem Zeitraum Festplattenzugriffe
verursacht haben könnten.
</p>

<pre caption="lm-profiler schlägt vor, Dienste zu deaktiveren">
Program:     "atd"
Reason:      standard recommendation (program may not be running)
Init script: /etc/init.d/atd (GUESSED)

Do you want to disable this service in battery mode? [y/N]: n
</pre>

<p>
Um atd wie in obigem Beispiel zu deaktivieren, führen Sie <c>rc-update
del atd battery</c> aus. Passen Sie auf, dass Sie keine Dienste deaktivieren,
die das System benötigt - lm-profiler wird normalerweise den einen oder anderen
Fehlalarm generieren. Deaktivieren Sie keine Dienste, über deren Aufgabe Sie
sich im Unklaren sind.
</p>

</body>
</section>

<section>
<title>Schreibzugriffe verringern</title>
<body>

<p>
Wenn Sie laptop-mode nicht benutzen wollen, müssen Sie besonders darauf achten,
dass Dienste mit häufigen Festplattenzugriffen deaktiviert werden - der
<c>syslogd</c> ist ein typischer Kandidat. Normalerweise werden Sie ihn nicht
komplett abschalten wollen. Sie können ihn aber so einrichten, dass "unnötige"
Ereignisse nicht protokolliert werden und damit keine Festplattenaktivität
auslösen. Cups schreibt periodisch auf die Festplatte, überlegen Sie sich,
cups auszuschalten und nur bei Bedarf zu starten.
</p>

<pre caption="cups im Batteriezustand deaktivieren">
# <i>rc-update del cupsd battery</i>
</pre>

<p>
Sie können auch den <c>lm-profiler</c> der laptop-mode-tools (siehe oben)
benutzen, um Diensten mit häufigen Festplattenzugriffen auf die Schliche zu 
kommen. Nachdem Sie sie alle abgeschaltet haben, können Sie mit der Einrichtung
von hdparm fortfahren.
</p>

</body>
</section>

<section>
<title>hdparm</title>
<body>

<p>
Die zweite Alternative ist, hdparm in Kombination mit einem kleinen Skript
einzusetzen. Überschlagen Sie diesen Teil, falls Sie laptop-mode benutzen.
Andernfalls erzeugen Sie <path>/etc/init.d/pmg_hda</path>:
</p>

<pre caption="hdparm zur Aktivierung von Ruhezuständen der Fesplatte verwenden">
#!/sbin/runscript

depend() {
after hdparm
}

start() {
ebegin "Activating Power Management for Hard Drives"
hdparm -q -S12 /dev/hda
eend $?
}

stop () {
ebegin "Deactivating Power Management for Hard Drives"
hdparm -q -S253 /dev/hda
eend $?
}
</pre>

<p>
Die einzelnen Optionen werden in <c>man hdparm</c> erklärt. Ist Ihr Skript
fertig, fügen Sie es dem battery Runlevel hinzu.
</p>

<pre caption="Festplatten Power Management automatisieren">
# <i>chmod +x /etc/init.d/pmg_hda</i>
# <i>/sbin/depscan.sh</i>
# <i>rc-update add pmg_hda battery</i>
</pre>

<impo>
Seien Sie vorsichtig mit den Schlafzuständen der Festplatte. Die Benutzung von
zu kleinen Intervallen kann sich schädlich auf die Lebensdauer der Festplatte
auswirken und sogar zum Garantieverlust führen.
</impo>

</body>
</section>

<section>
<title>Sonstige Tricks</title>
<body>

<p>
Sie können sogar so weit gehen und den Auslagerungsspeicher im Batteriebetrieb
abschalten. Das kann aber nur dann funktionieren, wenn genügend
Arbeitsspeicher vorhanden ist, so dass der Auslagerungsspeicher kaum genutzt
wird. Andernfalls stehen Sie vor einem großen Problem.
</p>

<p>
Selbst wenn Sie auf den <e>laptop-mode</e> verzichten möchten, können Sie die
Zahl der Festplattenzugriffe verringern. Einige Verzeichnisse kann man als
<e>tmpfs</e> mounten - dieses spezielle Dateisystem speichert Daten nicht auf
der Festplatte, sonderm im Arbeitsspeicher. Beim unmounten gehen die Daten
verloren. Das <path>/tmp</path> Verzeichnis bietet sich beispielsweise dafür
an - Persistenz von Daten über einen Neustart hinaus ist dort sowieso nicht
garantiert. Wichtig ist, dass Sie über ausreichend viel Arbeitsspeicher
verfügen und kein Programm (beispielsweise ein Downloadmanager oder
Komprimierungsprogramm) außergewöhnlich viel Platz in <path>/tmp</path>
benötigt. Um <path>/tmp</path> von der Festplatte in den Arbeitsspeicher zu
verschieben, benötigen Sie tmpfs Unterstützung im Kernel und fügen dann
folgende Zeile in <path>/etc/fstab</path> ein:
</p>

<pre caption="Ändern von /etc/fstab um /tmp in den Arbeitsspeicher zu
verschieben">
none  /tmp  tmpfs  size=32m  0 0
</pre>

<warn>
Wählen Sie den size (Größe des Verzeichnisses) Parameter mit besonderer
Vorsicht. Falls Sie unsicher sind, überspringen Sie diesen Tipp, es kann bei
falscher Konfiguration leicht zu Leistungseinbußen kommen. Falls Sie
<path>/var/log</path> auf diese Weise mounten möchten, sorgen Sie dafür, dass
die Logdateien vor dem unmounten auf die Festplatte geschrieben werden.
Logdateien sind wichtig. Versuchen Sie nicht, <path>/var/tmp</path> in den
Arbeitsspeicher zu verlagern. Portage benutzt es, um Programme zu
kompilieren...
</warn>	

</body>
</section>
</chapter>

<chapter>
<title>Power Management für andere Geräte</title>
<section>
<title>Graphikkarten</title>
<body>

<p>
Wenn Sie eine Graphikkarte ihr Eigen nennen, die PowerPlay (dynamische
Taktänderungen für den Graphikprozessor GPU) unterstützt, können Sie dieses
Merkmal in X.org aktivieren. Öffnen Sie <path>/etc/X11/xorg.conf</path> and
fügen Sie die <c>DynamicClocks</c> Option im Device Abschnitt hinzu (bzw.
aktivieren Sie die Option). Bitte beachten Sie, dass DynamicClocks auf einigen
Systemen zu Abstürzen führt.
</p>

<pre caption="Aktivieren der  ATI PowerPlay Unterstützung in X.org">
Section "Device"
  [...]
  Option      "DynamicClocks" "on"
EndSection
</pre>

</body>
</section>
<section>
<title>Wireless Power Management</title>
<body>

<p>
Auch WLAN-Karten verbrauchen einiges an Energie. Analog zum pmg_hda Skript kann
man deren Power Management Eigenschaften aktivieren.
</p>

<pre caption="WLAN Power Management automatisiert">
#!/sbin/runscript
start() {
  ebegin "Activating Power Management for Wireless LAN"
  iwconfig wlan0 power on
  eend $?
}

stop () {
  ebegin "Deactivating Power Management for Wireless LAN"
  iwconfig wlan0 power off
  eend $?
}
</pre>

<p>
Der Aufruf dieses Skripts aktiviert den Power Management Modus der WLAN-Karte
wlan0. Speichern Sie das Skript als <path>/etc/init.d/pmg_wlan0</path> und
fügen Sie es wie gehabt zum <e>battery</e> Runlevel hinzu. Erläuterungen zu den
verwendeten Optionen hält <c>man iwconfig</c> bereit. Falls der Treiber ihrer
WLAN-Karte und ihr Access Point ein Ändern der "beacon time" zulässt, ist das
ein guter Ausgangspunkt, um noch mehr Energie einzusparen.
</p>

<note>
Das Skript geht davon aus, dass ihre WLAN-Karte <c>wlan0</c> ist. Setzen Sie
dort den Namen ihres WLAN-Interfaces ein.
</note>

<pre caption="Power Management for WLAN">
# <i>chmod +x /etc/init.d/pmg_wlan0</i>
# <i>/sbin/depscan.sh</i>
# <i>rc-update add pmg_wlan0 battery</i>
</pre>

</body>
</section>
<section>
<title>USB Power Management</title>
<body>

<p>
Mit USB Geräten gibt es aus Sicht des Energiesparens zwei Probleme. Zum einen
verbrauchen Geräte wie USB Mäuse, Digitalkameras oder USB Sticks Energie, wenn
sie an den Laptop angeschlossen sind. Auch wenn man das nicht vermeiden kann,
sollten Sie sie bei Nichtgebrauch dennoch entfernen. Zum anderen greift der
USB Host Controller periodisch auf den Bus zu und verhindert dadurch, das der
Prozessor in den C3/4 Schlafzustand schalten kann. Im Kernel gibt es eine
experimentelle Option zur Aktivierung des Schlafzustands von USB Geräten durch
Treiberaufrufe oder über die <path>power/state</path> Dateien in
<path>/sys</path>.
</p>

<pre caption="Aktivierung der USB Schlafzustand Unterstützung im Kernel">
Device Drivers
  USB support
    [*]   Support for Host-side USB
      [*]   USB suspend/resume (EXPERIMENTAL)
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Schlafzustände: Sleep, Standby, Suspend to Disk</title>
<section>
<body>

<p>
ACPI legt verschiedene Schlafzustände fest. Die wichtigen sind
</p>

<ul> 
  <li>S1 oder Standby</li>
  <li>S3 oder Suspend to RAM oder Sleep</li>
  <li>S4 oder Suspend to Disk oder Hibernate</li>
</ul>

<p>
Sie werden dann eingesetzt, wenn das System nicht benutzt wird, aber ein
Herunterfahren wegen der langen Bootzeit unerwünscht ist.
</p>

</body>
</section>
<section>
<title>Sleep (S3)</title>
<body>

<p>
Aus gutem Grund ist die Unterstützung der verschiedenen Schlafzustände als
experimentell markiert. APM Schlafzustände scheinen stabiler zu sein, leider
kann man ACPI und APM aber nicht gleichzeitig einsetzen.
</p>

<pre caption="Kernel configuration for the various suspend types">
  Power Management Options ---&gt;
    [*]  Power Management support
      ACPI (Advanced Configuration and Power Interface) Support ---&gt;
        [*]  ACPI Support
          [*]   Sleep States
</pre>

<p>
Sobald ihr Kernel wie oben abgebildet eingerichtet ist, können Sie das
<c>hibernate-script</c>zum Aktivieren der verschiedenen Schlafzustände
benutzen. Installieren wir es zuerst.
</p>

<pre caption="Installation von hibernate-script">
<i># emerge hibernate-script</i>
</pre>

<p>
In <path>/etc/hibernate</path> müssen einige Einstellungen vorgenommen werden.
Das hibernate-script Paket bringt zwei Konfigurationsdateien
<path>hibernate.conf</path> und <path>ram.conf</path> mit.
</p>

<p>
Zur Konfiguration von Sleep bearbeiten Sie <path>ram.conf</path> im Verzeichnis
<path>/etc/hibernate</path>. <c>UseSysfsPowerState mem</c> ist bereits
ausgewählt. Sie müssen allerdings noch den Rest der Datei an Ihr System
anpassen. Die Kommentare und Namen der Optionen sind Ihnen dabei behilflich.
</p>

<p>
Fertig? Jetzt ist die letzte Chance, ein Backup der Daten anzulegen, die Sie
nach Ausführung des nächsten Kommandos noch verwenden wollen. Beachten Sie,
dass Sie zum Aufwecken des Laptops meist eine spezielle Taste wie <e>Fn</e>
drücken müssen.
</p>

<pre caption="Sleep aufrufen">
<i># hibernate-ram</i>
</pre>

<p>
Wenn Sie das hier lesen, scheint Sleep zu funktionieren. Sie können Standby
(S1) auf ähnliche Weise einrichten, indem Sie <path>ram.conf</path> nach
<path>standby.conf</path> kopieren und einen symbolischen Link von
<path>/usr/sbin/hibernate-standby</path> auf <path>/usr/sbin/hibernate</path>
anlegen. S3 and S4 sind allerdings die interessanteren Schlafzustände, da Sie
größere Energieeinsparungen erzielen.
</p>

</body>
</section>
<section>
<title>Hibernate (S4)</title>
<body>

<p>
Dieser Abschnitt beschreibt die Einrichtung des hibernate Modus, bei dem ein
Schnappschuss des Systems auf Festplatte gesichert wird und das System
anschließend abgeschaltet wird. Beim Aufwecken wird dieser Schnappschuss wieder
eingelesen und Sie können Ihre Arbeit an genau der Stelle fortsetzen, an der
Sie zuvor hibernate aufgerufen haben.
</p>

<p>
Es gibt zwei verschiedene Implementierungen von S4. Zuerst gab es swsusp und
neuerdings suspend2 mit einer verbesserten Schnittstelle (inklusive fbsplash
Unterstützung). Ein <uri
link="http://suspend2.net/features.html#compare">Vergleich der Features</uri>
ist auf der <uri link="http://suspend2.net">suspend2 Homepage</uri> verfügbar.
Es gab auch eine Zeitlang Suspend-to-Disk (pmdisk), eine Abspaltung von swsusp,
die allerdings wieder mit swsusp verschmolzen wurde.
</p>

<p>
Suspend2 ist noch nicht in den Hauptzweig des Kernels aufgenommen worden. Aus
diesem Grund müssen Sie entweder ihren Kernel Quellen mit dem auf
<uri link="http://suspend2.net">suspend2.net</uri> bereitgestellten Änderungen
patchen oder <c>sys-kernel/suspend2-sources</c> benutzen.
</p>

<p>
Die Kernelkonfiguration für swsusp wie auch suspend2 sieht folgendermaßen aus:
</p>

<pre caption="Kernelkonfiguration für die verschiedenen hibernate Typen">
Power Management Options ---&gt;
  <comment>(hibernate mit swsusp)</comment>
  [*] Software Suspend
      <comment>(Ersetzen Sie /dev/SWAP durch ihre swap Partition)</comment>
      (/dev/SWAP)      Default resume partition

  <comment>(hibernate mit suspend2)</comment>
  Software Suspend 2
    --- Image Storage (you need at least one writer)
    [*]     File Writer
    [*]     Swap Writer
    ---   General Options
    [*]    LZF image compression
    <comment>(Ersetzen Sie /dev/SWAP durch ihre swap Partition)</comment>
    (swap:/dev/SWAP)   Default resume device name
    [ ]     Allow Keep Image Mode
</pre>

<p>
Die Konfiguration von swsusp ist relativ einfach. Wenn Sie den Pfad zur
Auslagerungsdatei nicht im Kernel abgespeichert haben, können Sie sie als
Kernelparameter mit der <c>resume=/dev/SWAP</c> Direktive übergeben. Falls
durch einen defekten Schnappschuss kein Booten möglich ist, übergeben Sie den
<c>noresume</c> Kernelparameter.
</p>

<p>
Benutzen Sie das hibernate Skript, um hibernate mit swsusp aufzurufen. Setzen
Sie <c>UseSysfsPowerState disk</c> in
<path>/etc/hibernate/hibernate.conf</path>.
</p>

<warn>
Legen Sie vorher ein Backup ihrer Daten an. Rufen Sie <c>sync</c> vor der
Ausführung von hibernate aus, um zwischengespeicherte Daten auf die
Festplatte zu schreiben. Probieren Sie es zunächst außerhalb von X aus,
dann bei laufendem X-Server, aber ausgeloggt.
</warn>

<p>
Falls es zu durch uhci oder ähnlichem verursachten Kernelpaniken kommt, können
Sie die USB Unterstützung als Modul kompilieren und vor Aktivierung des
Schlafzustands aus dem Kernel entfernen.
</p>

<pre caption="Hibernate mit swsusp">
<i># nano -w /etc/hibernate.conf</i>
<comment>(Legen Sie bitte vorher ein Backup ihrer Daten an)</comment>
<i># hibernate</i>
</pre>

<p>
Der nächste Abschnitt diskutiert die Einrichtung von suspend2 inklusive
fbsplash Unterstützung für einen netten grafischen Fortschrittsbalken während
des hibernate Vorgangs.
</p>

<p>
Der erste Teil der Konfiguration ähnelt der von swsusp. Falls Sie den Pfad zu
ihrer Auslagerungsdatei nicht im Kernel gespeichert haben, können Sie ihn durch
den <c>resume2=swap:/dev/SWAP</c> Parameter übergeben. Wenn durch einen
defekten Schnappschuss kein Booten möglich ist, hängen Sie den <c>noresume2</c>
Parameter an. Bearbeiten Sie <path>/etc/hibernate/hibernate.conf</path>,
aktivieren den <e>suspend2</e>Abschnitt und kommentieren alles im
<e>sysfs_power_state</e> sowie im <e>acpi_sleep</e> Abschnitt. Aktivieren Sie
die Optionen für fbsplash noch nicht.
</p>

<pre caption="Hibernate mit suspend2">
<i># nano -w /etc/hibernate.conf</i>
<comment>(Legen Sie bitte vorher ein Backup ihrer Daten an)</comment>
<i># hibernate</i>
</pre>

<p>
Bitte konfigurieren Sie fbplash jetzt, falls Sie das nicht schon erledigt
haben. Die Unterstützung für fbsplash während des hibernate Vorgangs wird vom
<c>sys-apps/suspend2-userui</c> bereitgestellt. Es muss mit
aktiviertem <e>fbsplash</e> USE Flag installiert werden.
</p>

<pre caption="Installation von suspend2-userui">
<i># mkdir -p /etc/portage</i>
<i># echo sys-apps/suspend2-userui fbsplash >> /etc/portage/package.use</i>
<i># emerge suspend2-userui</i>
</pre>

<p>
Das Ebuild weist Sie an, einen symbolischen Link auf das Thema ihrer Wahl zu
erstellen. Um beispielsweise das <c>livecd-2005.1</c> Thema zu verwenden,
lautet der Befehl:
</p>

<pre caption="Benutzung des livecd-2005.1 Themas während des hibernate
Vorgangs">
<i># ln -sfn /etc/splash/livecd-2005.1 /etc/splash/suspend2</i>
</pre>

<p>
Mit untenstehendem Aufruf können Sie einen Testlauf ohne eigentliches
hibernate starten.
</p>

<pre caption="Testlauf für fbsplash hibernate">
<i># suspend2ui_fbsplash -t</i>
</pre>

<p>
Danach öffnen Sie <path>/etc/hibernate/hibernate.conf</path> erneut und
aktivieren die fbsplash Optionen. Rufen Sie <c>hibernate</c> auf und Sie
erhalten eine nette grafische Fortschrittsanzeige
</p>

</body>
</section>
</chapter>

<chapter>
<title>Probleme und Lösungen</title>
<section>
<body>

<p>
<e>F:</e> Ich versuche die CPU Frequenz zu ändern, aber
<path>/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</path> existiert
nicht.
</p>

<p>
<e>A:</e> Stellen Sie sicher, dass ihr Prozessor das Ändern der Frequenz
unterstützt und das Sie den richtigen Treiber für ihren Prozessor ausgewählt
haben. Hier ist eine Liste der Prozessoren, die von cpufreq unterstützt werden
(Kernel 2.6.7): ARM Integrator, ARM-SA1100, ARM-SA1110, AMD Elan - SC400, SC410,
AMD mobile K6-2+, AMD mobile K6-3+, AMD mobile Duron, AMD mobile Athlon, AMD
Opteron, AMD Athlon 64, Cyrix Media GXm, Intel mobile PIII und Intel mobile
PIII-M bei bestimmten Chipsätzen, Intel Pentium 4, Intel Xeon, Intel Pentium M
(Centrino), National Semiconductors Geode GX, Transmeta Crusoe, VIA Cyrix 3 /
C3, UltraSPARC-III, SuperH SH-3, SH-4, mehrere "PowerBook" und "iBook2" sowie
verschiedene Prozessoren in ACPI 2.0-kompatiblen Systemen (nur wenn "ACPI
Processor Performance States" über die ACPI/BIOS Schnittstelle verfügbar sind).
</p>

<p>
<e>F:</e> Mein Laptop unterstützt Frequenzänderungen des Prozessors, aber
<path>/sys/devices/system/cpu/cpu0/cpufreq/</path> ist leer.
</p>

<p>
<e>A:</e> Schauen Sie nach ACPI Fehlermeldungen per <c>dmesg | grep ACPI</c>.
Eventuell ist das Problem mit einem BIOS Update in den Griff zu bekommen,
insbesondere wenn eine falsche DSDT angezeigt wird. Falls kein BIOS Update zur
Verfügung steht, kann man DSDT Fehler auch selber beheben - das wird an anderer
Stelle beschrieben.
</p>

<p>
<e>F:</e> Mein Laptop unterstützt Frequenzänderungen des Prozessors, aber
<path>/proc/cpuinfo</path> meldet keine Änderungen.
</p>

<p>
<e>A:</e> Hierbei scheint es sich um einen Bug im Kernel zu handeln. Führen Sie
<c>emerge x86info</c> aus, konfigurieren Sie ihren Kernel wie angegeben und
überprüfen Sie die aktuelle Prozessorgeschwindigkeit mit <c>x86info -mhz</c>.
</p>

<p>
<e>F:</e> Ich kann die Prozessorgeschwindigkeit ändern, erreiche in einem
anderen Betriebssystem aber tiefere Werte.
</p>

<p>
<e>A:</e> Sie können das Ändern der Prozessorgeschwindigkeit mit ACPI Drosselung
(throttling) kombinieren, um eine geringere Minimalfrequenz zu erhalten.
Allerdings spart man dadurch kaum mehr Energie. Drosselung ist am ehesten
sinnvoll, um die Temperatur niedrig zu halten. Den aktuellen Status erhält man
mit <c>cat /proc/acpi/processor/CPU/throttling</c>. Änderungen können Sie durch
<c>echo -n "0:x" > /proc/acpi/processor/CPU/limit</c> vornehmen, wobei x einer
der in <path>/proc/acpi/processor/CPU/throttling</path> aufgelisteten Zustände
ist.
</p>

<p>
<e>F:</e> Die Batteriezeit ist geringer als vorher.
</p>

<p>
<e>A:</e> Überprüfen Sie die BIOS Einstellungen. Vielleicht haben Sie vergessen,
einige Einstellungen wieder zu aktivieren.
</p>

<p>
<e>F:</e> Meine Batterie ist voll geladen, KDE geht allerdings von 0% aus und
fährt das System herunter.
</p>

<p>
<e>A:</e> Stellen Sie sicher, dass Unterstützung für die Batterie in den Kernel
kompiliert ist. Falls Sie es als Modul kompiliert haben, laden Sie das Modul,
bevor sie KDE starten.
</p>

<p>
<e>F:</e> Im Systemprotokoll erhalte ich Meldungen wie "logger: ACPI group
battery / action battery is not defined".
</p>

<p>
<e>A:</e> Diese Meldung wird vom <path>/etc/acpi/default.sh script</path>
erzeugt, welches mit acpid ausgeliefert wird. Sie können die Meldung gefahrlos
ignorieren. Möchten Sie sie loswerden, kommentieren Sie die entsprechende Zeile
in <path>/etc/acpi/default.sh</path> wie folgt:
</p>

<pre caption="Warnung über unbekannte acpi Events abschalten">
    *)      # logger "ACPI action $action is not defined"
</pre>

<p>
<e>F:</e> Ich habe einen Dell Inspiron 51XX und erhalte keine ACPI Ereignisse.
</p>

<p>
<e>A:</e> Das scheint ein Bug im Kernel zu sein. Weitere Informationen gibt es
<uri link="http://bugme.osdl.org/show_bug.cgi?id=1752">hier</uri>.
</p>

<p>
<e>Q:</e>Ich habe die DynamicClocks Option in <path>xorg.conf</path>
aktiviert und jetzt stürzt X.org dauernd ab / der Bildschirm bleibt
schwarz / mein Laptop fährt nicht mehr richtig herunter.
</p>

<p>
<e>A:</e> DynamicClocks funktioniert nicht auf allen Systemen zuverlässig.
Schalten Sie die Option ab.
</p>

<p>
<e>Q:</e> Ich möchte suspend2 verwenden, aber es beschwert sich über eine zu
kleine Auslagerungsdatei. Ein Vergrößern der Auslagerungsdatei ist nicht
möglich.
</p>

<p>
<e>A:</e> Wenn Sie genug freien Speicherplatz auf ihrem System haben, können
Sie anstelle der Auslagerungsdatei eine reguläre Datei verwenden. Das
<c>hibernate-script</c> unterstützt diese Option. Weitere Informationen gibt es
in <path>/usr/src/linux/Documentation/power/suspend2.txt</path>.
</p>

<p>
<e>F:</e> Ich habe eine neue Batterie gekauft - sie hält aber nur ein paar
Minuten! Was mache ich falsch?
</p>

<p>
<e>A:</e> Folgen Sie den Anweisungen des Herstellers und laden Sie die Batterie
vollständig auf.
</p>

<p>
<e>F:</e> Obiges hilft nicht. Was soll ich jetzt tun?
</p>

<p>
<e>A:</e> Einige als "neu" verkaufte Batterie liegen schon mehrere Monate auf
Lager und sind nicht mehr zu gebrauchen. Probieren Sie folgendes:
</p>

<pre caption="Batteriestatus überprüfen">
$ <i>grep capacity /proc/acpi/battery/BAT0/info</i>
design capacity:     47520 mWh
last full capacity:  41830 mWh
</pre>

<p>
Wenn die "last full capacity", also die beim letzten vollständigen Laden
erreichte Kapazität, sich signifikant von der "design capacity" unterscheidet,
ist die Batterie wahrscheinlich kaputt. Machen Sie ihre Garantieansprüche
geltend.
</p>

<p>
<e>F:</e> Mein Problem ist hier nicht aufgelistet. Wo bekomme ich Hilfe?
</p>

<p>
<e>A:</e> Sie können mich, <mail link="earthwings@gentoo.org">Dennis
Nienhüser</mail>, direkt kontaktieren. Die <uri
link="http://forums.gentoo.org">Gentoo Foren</uri> sind ebenfalls ein
sehr guter Anlaufpunkt. Es gibt dort auch ein deutsches Forum. Wenn Sie IRC
vorziehen, probieren Sie es im <e>#gentoo-laptop</e> Kanal auf
<e>irc.freenode.net</e>.
</p>


</body>
</section>
</chapter>

</guide>

<?xml version="1.0" encoding="iso-8859-1"?>

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/da/dri-howto.xml">
<title>Hardware 3D Accelerationsvejledning</title>
<author title="Forfatter">
	<mail link="spyderous@gentoo.org">Donnie Berkholz</mail>
</author>
<author title="Redaktør">
	<mail link="peesh@gentoo.org">Jorge Paulo</mail>
</author>
<author title="Oversætter">
	<mail link="broeman@gentoo.org">Jesper Brodersen</mail>
</author>
<author title="Korrektur">
	<mail link="aaby@gentoo.org">Arne Mejlholm</mail>
</author>
<author title="Korrektur">
	<mail link="broeman@gentoo.org">Jesper Brodersen</mail>
</author>

<abstract>
Dette dokument er en vejledning for at få 3D acceleration til at virke
ved at bruge XFree-DRM med XFree86 i Gentoo Linux.  
</abstract>

<license/>

<version>1.0.3</version>
<date>21. Juni 2004</date>

<chapter>
<title>Introduktion</title>
<section>
<title>Hvad er hardware 3D acceleration og hvorfor vil jeg have det?</title>
<body>

<p>
Med hardware 3D acceleration, bruger du den tre-dimensionelle
gengivelsesgrafik-processor på dit grafikkort i stedet for at optage
værdifulde CPU-ressourcer for at tegne 3D-billeder. Det er også
refereret til, som "hardware acceleration" i stedet for "software
acceleration", fordi at uden denne 3D acceleration ville din CPU være
tvunget til at tegne alt, selv ved at bruge
Mesa-softwaregengivelsesbiblioteker, som tager en stor del af
processorydelsen. Imens XFree86 typisk understøtter 2D hardware
acceleration, mangler den ofte hardware 3D
acceleration. Tre-dimensionel hardware acceleration er værdifuldt i
situationer, hvor det kræver gengivelse af 3D objekter, såsom spil, 3D
CAD og modelering.
</p> 
</body> 
</section>

<section>
<title>Hvordan får jeg hardware 3D acceleration?</title>
<body>
<p>
I mange situationer, eksisterer både binære og open-source (frie)
drivere. Open-source drivere ses helst, da vi bruger Linux og
open-source er en af de underliggende principper. Somme tider er
binære drivere det eneste valg, det er f.eks tilfældet med nVidias
grafikkorte.  Binære drivere inkluderer media-video/mgavideo til
Matrox og media-video/ati-drivers til ATI kort. Andre open-source
drivere inkluderer media-video/kyro-kernel til KyroII kort og
media-video/ati-gatos til ATI cards, hvis mål er at understøtte ATI's
video færdigheder i større grad.
</p> 
</body> 
</section>


	<section>
		<title>Hvad er DRI?</title>
		<body>
		
<p>
Direct Rendering Infrastructure (<uri
link="http://dri.sourceforge.net">dri.sourceforge.net</uri>), også
kendt som DRI, er et framework for at tillade direkte adgang til
grafik-hardwaren på en sikker og effektiv metode. Det inkluderer
ændringer til X-serveren med nogle klient-biblioteker og til
kernen. Den første og brugbare løsning af DRI er at skabe hurtige
OpenGL-gennemførsler.
</p>
</body>
</section>


	<section>
		<title>Hvad er XFree-DRM og hvordan relaterer den sig til normalt XFree86?</title>
		<body>
		
<p>
XFree-DRM er en <e>forøgelse</e> af XFree86  som tilføjer 3D
acceleration til grafikkorte, ved at tilføje de moduler der er
nødvendige for direct rendering til kernen.
</p>
</body>
</section>


	<section>
		<title>Formålet</title>
		<body>
		
<p>
Denne vejledning er for folk der ikke kan få deres direct rendering
til at virke med XFree alene. XFree-DRM virker til 3dfx, gamma, i8x0,
matrox, rage128, radeon, mach64 (fra og med xfree-drm-4.3.0-r7) og
sis300 driver serierne. 2.4 kernernes Direct Rendering Manager (DRM)
understøtter ikke fra XFree 4.3, så der er brug for xfree-drm
pakken. Hvis du bruger 2.6 kernen, så understøtter den XFree 4.3;
Gentoo's XFree-DRM pakke virker endnu ikke til 2.6 kerner. Se <uri
link="http://dri.sourceforge.net">DRI hjemmesiden</uri> for mere info
og dokumentation.
</p>
</body>
</section>


	<section>
		<title>Feedback</title>
		<body>
<p>
For forslag, spørgsmål etc., email <mail
link="spyderous@gentoo.org">Donnie Berkholz</mail>.
</p> 
</body> 
</section> 
</chapter>

<chapter>
	<title>Installation af XFree86 og opsætning af din kerne</title>
	<section>
		<title>Installation af XFree86</title>
		<body>
<pre caption="At installere XFree86">
# <i>emerge x11-base/xfree</i>
</pre>
</body>
</section>


<section>
<title>Opsætning af din kerne</title>
<body>

<p>
Undersøg dit chipset og aktiver kun dette.
</p>

<pre caption="Undersøgelse af dit AGP chipset">
# <i>emerge pciutils; lspci | grep AGP</i>
# <i>00:01.0 PCI bridge: Intel Corp. 440BX/ZX/DX - 82443BX/ZX/DX AGP bridge (rev 03)</i>
<codenote>Dit output er måske ikke det samme som foroven, pga. af forskellig hardware.</codenote>
</pre>

<p>
De fleste, hvis ikke alle, kerner skulle have disse
indstillinger. Dette var opsat ved at bruge gentoo-sources-2.4.20-r5:
</p>

<pre caption="At konfigurere kernen">
# <i>ls -l /usr/src/linux </i>
lrwxrwxrwx    1 root     root           22 May 29 18:20 /usr/src/linux -> linux-2.4.20-gentoo-r5
<codenote>Vær sikker på at /usr/src/linux peger mod din nuværende kerne.</codenote>
# <i>cd /usr/src/linux</i>
# <i>make menuconfig</i>
</pre>

<pre caption="make menuconfig muligheder">
Processor type and features ---&gt;
  &lt;*&gt; MTRR (Memory Type Range Register) support
Character devices ---&gt;
&lt;M&gt; /dev/agpgart (AGP Support)
 [*] Intel 440LX/BX/GX and I815/I820/I830M/I830MP/I840/I845/I850/I860 support
<codenote>Aktivér dit chipset i stedet for ovenstående.</codenote>
  [ ] Direct Rendering Manager (XFree86 DRI support)
</pre>
<p>
Vær sikker på at Direct Rendering Manager (DRM) er <e>slået
fra</e>. XFree-DRM pakken vil sørge for sin egen. Kerne-versionen er
til XFree 4.2.
</p>
</body>
</section>


<section>
<title>At kompilere og installere din kerne</title>
<body>
<pre caption="Kompilere og installere kerne">
# <i>make dep &amp;&amp; make clean bzImage modules modules_install</i>
# <i>mount /boot</i>
# <i>cp arch/i386/boot/bzImage /boot</i>
</pre>

<p>
Hvis du vil have at din kerne skal kaldes noget andet end bzImage,
vær sikker på at kopiere det til /boot/yourname i stedet for. Glem
ikke at opsætte grub.conf eller lilo.conf og køre /sbin/lilo hvis du
bruger LILO.
</p>
</body>
</section>
</chapter>


<chapter>
        <title>Installation af XFree-DRM og opsætning af direct rendering</title>
        <section>
                <title>Installation af XFree-DRM</title>
                <body>

<pre caption="At installere XFree-DRM">
# <i>ACCEPT_KEYWORDS="~x86" emerge xfree-drm</i>
</pre>
		</body>
	</section>


        <section>
                <title>Opsætning af XF86Config</title>
                <body>
		
<p>
Åben <path>/etc/X11/XF86Config</path> med din
yndlings-redigeringsprogram og rediger det til at aktivere DRI og GLX.
</p>
<pre caption="XF86Config">
...
Section "Module"
     Load "dri"
     Load "glx"
     ...
EndSection
...
Section "Device"
     Driver "radeon"
     ...
EndSection
...
Section "dri"
     Mode 0666
EndSection
</pre>
		
<p>
Hvis du bruger en anden driver, erstat "radeon" med din driver.
</p>

</body>
</section>
</chapter>


<chapter>
	<title>Testning af 3D acceleration</title>
	<section>
		<title>Genstart til din nye kerne</title>
		<body>
		
<p>
Genstart din computer for at køre den nye kerne. Det er tid til at se
om du har direct rendering og hvor god den er.
</p>

<pre caption="Test af gengivelse">
# <i>startx</i>
<codenote>Det er ikke nødvendig at køre modulerne for din</codenote> 
<codenote>driver eller agpgart, hvis du har kompileret agpgart som et modul.</codenote>
<codenote>De vil køre af sig selv, helt automatisk.</codenote>
# <i>glxinfo | grep rendering</i>
direct rendering: Yes
<codenote>Hvis den siger "No", så har du ikke 3D acceleration.</codenote>
# <i>glxgears</i>
<codenote>Test dine frames pr. sekund (FPS) som standardstørrelsen.</codenote>
<codenote>Dette tal burde være mærkbart højere end før du installerede xfree-drm.</codenote>
<codenote>Dette vil tage et stykke tid, idet CPUen er så ubeskæftiget som muligt.</codenote>
</pre>
</body>
</section>
</chapter>


<chapter>
	<title>Brug af CVS-kildekoderne</title>
	<section>
		<body>
<warn>
Gør ikke dette hvis din pakke virkede.
</warn>

<note>
Fra deres natur, er CVS-kildekoder altid i ændring. Din opsætning vil
måske ikke se præcis ud som den forneden.  
</note>

</body>
</section>
	<section>
		<title>Behøver jeg CVS-kildekoderne?</title>
		<body>
		
<p>
Først skal du se efter om xfree-drm pakken virker. Hvis det ikke gør
og tjekket dine log filer for at verificere at det ikke er en
konfigurationsfejl, så skal du måske overveje CVS kildekoderne. Der er
også daglige snapshots af driverne til rådighed, hvis du ikke har lydt
til at bygge hele den fulde CVS.
</p>

</body>
</section>
	<section>
		<title>Understøtter CVS-kilderne dit kort?</title>
		<body>
		
<p>
Se efter på DRIs <uri
link="http://dri.sourceforge.net/cgi-bin/moin.cgi/Status">understøttede
grafikkort-liste</uri> for at se om CVS understøtter dit kort. Selvom
den ikke gør, men understøtter en lignende grafikkort, prøv det
alligevel.
</p>
<warn>
"Linux 2.4 understøtter ikke agp 8x, så jeg måtte finde en
bagdør. Denne bagdør virker .... den lapper ikke helt rigtigt, og den
kræver 2.4.21 (Jeg har kun fået den til at virke med vanilla, lige fra
tarball'en (ikke en ebuild)). Først, få fat i 2.4.20-2.4.21 patch'en
fra kernel.org .... (og så hent patch'en,) Det var på en maillist et
eller andet sted. Den lapper ikke ordentligt -- en fil fejler,
pci_ids.h filen, men hvis du faktisk læser filen og afvisnings-listen,
er det meget let at ordne. Men den kører, og det giver mig 1600x1200
med video (selvom lidt langsomt b/c af mangel på dga) med xfree-drm."
(SanityInAnarchy on #gentoo)
</warn>

<impo>
Patch'en er lidt tricky at arbejde med, men <uri
link="http://www.ussg.iu.edu/hypermail/linux/kernel/0302.2/att-1618/01-agp3.diff.bz2">her
er et link</uri>. Hvis du fravælger 8X AGP i din BIOS, ændre det til
4X og så behøver du måske slet ikke bruge patch'en.
</impo>

</body>
</section>

	<section>
		<title>Installation af CVS-kildekoder</title>
		<body>

<p>
Følg denne vejledning "Kompilering og installation af din kerne." Så
vil vi gå til trin 6 i <uri
link="http://dri.sourceforge.net/cgi-bin/moin.cgi/Building">DRI
kompilationsvejledning</uri> og følge den til trin 8.3.
</p>
</body>
</section>

	
	<section>
		<title>Anonym CVS download</title>
		<body>
		
<p>
Lav et bibliotek til at gemme CVS-filerne:
</p>
<pre caption="Lav et bibliotek til CVS">
# <i>cd ~</i>
# <i>mkdir DRI-CVS</i>
		</pre>
		
<p>
Se på CVS-kildekoder
</p>

<pre caption="Tjek CVS kildekoderne ud">
# <i>cd ~/DRI-CVS</i>
# <i>cvs -d:pserver:anonymous@cvs.dri.sourceforge.net:/cvsroot/dri login</i>
<codenote>(tryk ENTER når den spørger efter et kodeord)</codenote>
# <i>cvs -z3 -d:pserver:anonymous@cvs.dri.sourceforge.net:/cvsroot/dri co xc</i>
<codenote>-z3 flaget sørger for at kompression bliver brugt for at nedsætte download-tiden</codenote>
</pre>
		</body>
	</section>


	<section>
		<title>Opdatering af dine CVS-kildekoder</title>
		<body>
		
<p>
I fremtiden, bør du, en gang imellem, opdatere din lokale kopi af
DRI-kildekoder for at få de sidste nye ændringer. Dette kan gøres
således:
</p>

<pre caption="Opdater den lokale kopi">
# <i>cd ~/DRI-CVS</i>
# <i>cvs -z3 update -dA xc</i>
<codenote>-d flaget sørger for at alle nye underbiblioteker bliver lavet.</codenote>
<codenote>-A flaget sørger for at de sidste nye hoved-kildekoder vil
		blive hentet, ikke den enkelte grens kildekoder.</codenote>
</pre>
</body>
</section>


	<section>
		<title>Skabe et bygge-træ (build tree)</title>
		<body>
<p>
I stedet for at placere objekt- og biblioteks-filer direkte i
kilde-træet, er de i stedet puttet ind i et parallelt <e>build</e>
træ. Dette bygge-træ er lavet med <c>lndir</c> kommandoen:
</p>
		
<pre caption="At lave et parallelt bygge træ">
# <i>cd ~/DRI-CVS</i>
# <i>ln -s xc XFree40</i>
# <i>mkdir build; cd build</i>
# <i>lndir -silent -ignorelinks ../XFree40</i>
		</pre>
		
<p>
Bygge-træet vil blive befolket af symbolske henvisninger, som peger
tilbage ind i CVS-kildekode-træet. Avancerede brugere kan have flere
bygge-træer for a kompilere og teste forskellige metoder.
</p>
</body>
</section>


	<section>
		<title>Redigering af host.def filen</title>
		<body>
<p>
<path>~/DRI-CVS/build/xc/config/cf/host.def</path> filen bliver brugt
til at opsætte XFree86-byggeprocessen. Du kan ændre det ved at vælge
dine bygge-valg eller lave justeringer til din særlige
system-opsætning. Standardfilen host.def vil se ud som dette:
</p>

<pre caption="host.def">
            #define DefaultCCOptions -Wall
<codenote>Til i386:</codenote>
            #define DefaultGcc2i386Opt -O2
<codenote>Til Alpha:</codenote>
            #define DefaultGcc2AxpOpt -O2 -mcpu=ev6 (or similar)
<codenote>Til alle arkitekturer</codenote>
            #define LibraryCDebugFlags -O2
            #define BuildServersOnly YES
            #define XF86CardDrivers vga tdfx mga ati i810
            #define LinuxDistribution LinuxRedHat
            #define DefaultCCOptions -ansi GccWarningOptions -pipe
            #define BuildXF86DRI YES
            /* Optionally turn these on for debugging */
            /* #define GlxBuiltInTdfx YES */
            /* #define GlxBuiltInMga YES */
            /* #define GlxBuiltInR128 YES */
            /* #define GlxBuiltInRadeon YES */
            /* #define DoLoadableServer NO */
            #define SharedLibFont NO
</pre>
		

<pre caption="host.def fortsat">
#define ProjectRoot stien/Til/Din/XFree86installation
<codenote>Notér at XF86CardDrivers linien viser dit grafikkorts driver.</codenote>
<codenote>Hvis du vil aktivere 3DNow!-optimeringer i Mesa og i DRI-driverne, burde du tilføje følgende:</codenote>
#define MesaUse3DNow YES
<codenote>Du behøver ikke at bruge en AMD processor for at aktivere dette valg.</codenote>
<codenote>DRI vil kigge efter 3DNow! understøttelse når den kører og kun aktivere den, hvis muligt.</codenote>
</pre>
		
<p>
Hvis du vil aktivere SSE-optimeringer i Mesa og i DRI-driverne, skal
du opgradere til en Linux 2.4.x kerne. Mesa vil verificere at SSE er
understøttet både af din processor og dit styresystem, men for at
byggeMesa inde i DRIen, bliver du nødt til at have Linux 2.4.x
kerne-headers i <path>/usr/src/linux</path>. Hvis du aktiverer
SSE-optimeringer med en tidligere version af Linux kernen i
<path>/usr/src/linux</path>, vil Mesa ikke kompilere. Du er blevet
advaret. Hvis du har en 2.4.x kerne, burde du tilføje følgende:
</p>

<pre caption="Opdater host.def">
#define MesaUseKatmai YES
</pre>

</body>
</section>


	<section>
		<title>Kompilering af XFree86/DRI-træet</title>
		<body>
		<p>At kompilere et komplet DRI-træ:</p>
<pre caption="Kompilér DRI træet">
# <i>cd ~/DRI-CVS/build/xc/</i>
# <i>make World &gt;&amp; world.log</i>
</pre>

<p>
Det er måske også nødvendigt at gøre det følgende, afhængigt af hvad
du placerede i host.def:
</p>

<pre caption="Yderligere skridt i kompileringen">
# <i>cd ~/DRI-CVS/build/xc/programs/Xserver/hw/xfree86/os-support/linux/drm/kernel</i>
# <i>make -f Makefile.linux radeon.o</i>
<codenote>Udskift radeon med din driver.</codenote>
</pre>

<p>Med standard kompileringsflag, er det normalt at få en hel del
advarsler når kompileringen foregår. Bygningen vil tage nogen tid, så
du burde måske tjekke din email eller besøge slashdot. 
</p>

<warn>Brug ikke -j valget med make (altså, brug ikke distcc). Det er
blevet rapporteret at det ikke virker med XFree86/DRI.
</warn>

<p>
Ved brug af dit redigeringsprogram, eksaminér world.log for fejl
ved at søge for mønstret ***.
</p>

</body>
</section>


	<section>
<title>Installation af CVS</title>
		<body>

<p>
Verificer at DRI-kerne-modul(er) er blevet bygget til dit system:
</p>

<pre caption="Verifikation">
# <i>cd ~/DRI-CVS/build/xc/programs/Xserver/hw/xfree86/os-support/linux/drm/kernel; ls</i>
</pre>

<p>Til 3dfx Voodoo, bør du se <path>tdfx.o</path>. Til Matrox
G200/G400, bør du se <path>mga.o</path>. Til ATI Rage 128, bør du se
<path>r128.o</path>. Til ATI Radeon, bør du se
<path>radeon.o</path>. Til Intel i810, bør du se
<path>i810.o</path>. Hvis DRI-kerne-modul(er) fejler ved bygningen,
bør du verificere at du bruger den rigtige version af
Linux-kernen. Den sidste nye kerne er ikke altid understøttet.
</p>

<p>
Installer hen over din XFree86 installation. Du vil måske sørge for at
lave en sikkerhedskopi af xfree.
</p>

<pre caption="At backe XFree op">
# <i>quickpkg xfree</i>
<codenote>Dette backer din XFree86 pakke op.</codenote>
# <i>make install</i>
</pre>

<p>
Følg "Konfigurer XF86Config" sektionen ovenfor.
</p>

<p>
For at hente det rigtige DRM modul i din kørende kerne, skal du
kopiere kerne modulet til <path>/lib/modules/`uname
-r`/kernel/drivers/char/drm/</path> og kør <c>modules-update</c> og
genstart din X server. Hvis du ikke kører den kerne som du vil bruge
det i, så skal du i stedet for <c>`uname -r`,</c> bruge den kernes navn.
</p>

<warn>
Vær sikker på at du fjerner et ældre DRI kerne modul, der måske
allerede er hentet. Bemærk at nogle DRM moduler kræver at agpgard
modulet bliver hentet først.
</warn>


</body>
</section>
</chapter>


<chapter>
	<title>Fusk lidt med din ydelse</title>
	<section>
		<title>Få mest ud af direct rendering (direkte gengivelse)</title>
		<body>
		
<p>
Et par få valg kan forbedre ydelsen med op til 30 procent (eller mere)
end standarden. Sæt dem i <path>/etc/X11/XF86Config</path>.
</p>

<pre caption="XF86Config">
Section "Device"
     Option     "AGPMode" "4"
<codenote>Dette forbedrer FPS fra 609 til 618.</codenote>
     Option     "AGPFastWrite" "True"
<codenote>Dette havde ingen målbar effekt, men kan forbedrer ustabilitet på din computer.</codenote>
<codenote>Du burde måske også sætte det i din BIOS.</codenote>
     Option     "EnablePageFlip" "True"
<codenote>Dette forbedrede FPS fra 618 til 702. Det er også "risikabel", men få folk har rapporteret problemer.</codenote>
     ...
EndSection
</pre>

<p>
Hvis du vil have et sæt på endnu flere egenskaber, tag et kig på <uri
link="http://dri.sourceforge.net/doc/dri_driver_features.phtml">features
listing</uri> på DRIs hjemmeside.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Fejlfinding</title>
<section>

<title>Det virker ikke. Jeg har lige rekompileret min kerne eller
skiftet til en ny en.</title>
<body>
  	 
<p>
Hver gang du bygger din kerne om eller skifter til en anden kerne
bliver du nødt til at bygge dit kerne modul igen. Bemærk at du ikke er
nødt til at emerge xfree igen, men at du bliver nødt til at emerge
xfree-drm igen.
</p>
  	 
</body>
</section>
  	 
<section>

		<title>Det virker ikke. Jeg har ikke rendering, og jeg ved ikke hvorfor.</title>
		<body>
		
<p>Prøv <c>insmod radeon</c> før du starter X-serveren. Prøv også at
bygge agpgart som en modul i stedet for ind i kernen.
</p>
		</body>
	</section>
	<section>
		<title>Når jeg kører startx, får jeg følgende fejlbesked: "[drm] failed to load kernel module agpgart"</title>
		<body>

<p>
Det er fordi du har kompileret agpgart ind i kernen, i stedet for som
et modul. Ignorér det medmindre du har problemer.
</p>

		</body>
	</section>
	<section>
		<title>Direct rendering virker ikke, og i /var/log/XFree86.0.log har jeg en fejl om at driver-versionerne er for lille.</title>
		<body>
		
<p>
Du bruger ikke xfree-drm driveren. Se efter om du har kompileret DRM
og driveren ind i kernen, som du ikke skulle.
</p>
		</body>
	</section>
	<section>
		<title>Jeg har et Radeon grafikkort, og jeg vil gerne have TV-Out.</title>
		<body>
		
<p>
Kig efter ati-gatos driverne. <c>emerge -s gatos</c>.
</p>
		</body>
	</section>
	<section>
		<title>Det virker ikke. Mit kort er så utroligt nyt og sej, at det ikke er understøttet overhovedet.</title>
		<body>
		
<p>
Prøv at brug de binære drivere. Til ati-driverne, er der en liste på
<uri>http://www.schneider-digital.de/html/download_ati.html</uri>.
Hvis de ikke understøtter det, brug fbdev. Det er langsomt, men det
virker.
</p>
		</body>
	</section>
	<section>
		<title>Jeg har et PCI-grafikkort og det virker ikke.  Hjælp!</title>
		<body>
		
<p>
I sektionen "Device" aktivér ForcePCIMode. 
</p>

<pre caption="At slå ForcePCIMode til">
Option "ForcePCIMode" "True"
</pre>
		</body>
	</section>
	 
</chapter>

<chapter>
<title>Anerkendelse</title>
<section>
<body>
  	 
<ol>
 <li>
   Christopher Webber for at foreslå et fejlfindings spørgsmål omkring
   at skifte eller rekompilere kerner
 </li>
 <li>
   Steve, for at foreslå konsistens mellem tilfældene af dri og DRI i 
   XF86Config
 </li>
</ol>
  	 
</body>
</section>
</chapter>

<chapter>
	<title>Referencer</title>
	<section>
		<body>
			<ol>
				<li>http://forums.gentoo.org/viewtopic.php?t=46681</li>
				<li>http://forums.gentoo.org/viewtopic.php?t=29264</li>
				<li>http://dri.sourceforge.net/</li>
				<li>http://www.retinalburn.net/linux/dri_status.html</li>
			</ol>
		</body>
	</section>
</chapter>
</guide>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/pl/uml.xml,v 1.5 2005/09/29 01:42:32 rane Exp $ -->

<guide link="/doc/pl/uml.xml" lang="pl">

<title>Testowanie środowiska z jądrem w trybie użytkownika (UML)</title>

<author title="Redaktor">
  <mail link="g2boojum@gentoo.org">Grant Goodyear</mail>
</author>
<author title="Redaktor"><!-- zhen@gentoo.org -->
  John Davis
</author>
<author title="Redaktor">
    <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>
<author title="Redaktor">
  <mail link="bennyc@gentoo.org">Benny Chuang</mail>
</author>
<author title="Tłumacz">
  Paweł Drobek
</author>

<abstract>
Poradnik przedstawia problematykę wirtualnego systemu oraz prezentuje sposób
instalacji i wykrywania potencjalnie niebezpiecznych dla systemu błędów.
</abstract>

<license/>

<version>0.10</version>
<date>2005-02-05</date>

<chapter>
<title>Skąd można pobrać uml?</title>
<section>
<body>

<p>
Źródła można pobrać ze strony internetowej projektu
(<uri>http://user-mode-linux.sourceforge.net</uri>). Wirtualny system umożliwia
użytkownikowi uruchomienie drugiego systemu operacyjnego na systemie gospodarza.
Ponadto może służyć do testowania nowych wersji jądra, innych dystrybucji oraz
oprogramowania w wersjach rozwojowych. Eksperymentowanie z pakietami Gentoo
takimi jak <e>sys-apps/baselayout</e> albo <e>sys-libs/glibc</e> może wiązać się
z możliwością uszkodzenia systemu i uczynienia go niebotowalnym. Wirtualny
system zapewnia środowisko testowe odizolowane od systemu gospodarza przez co
użytkownik ma pewność, że eksperymenty nie wprowadzą żadnych szkodliwych zmian.
</p>

<p>
Instalowanie wirtualnego systemu sprowadza się do postępowania zgodnie z
poradnikiem do standardowej kompilacji. Pierwszą potrzebną rzeczą będzie jądro z
naniesionymi odpowiednimi łatami umożliwiającymi współpracę pomiędzy oboma
systemami. Od jądra w wersji 2.6.9 obsługa wirtualnego Linuksa jest wbudowana.
</p>

<pre caption="Instalowanie źródeł z obsługą UML">
<comment>(W poradniku będzie używane czyste jądro 2.6, można również użyć źródeł "usermode")</comment>
# <i>emerge sys-kernel/development-sources</i>
# <i>cd /usr/src/linux</i>
# <i>make menuconfig <comment>ARCH=um</comment></i>
# <i>make linux <comment>ARCH=um</comment></i>
# <i>cp linux /usr/local/bin/linux</i>
</pre>

<warn>
Fragment <e>ARCH=um</e> jest <e>niezmiernie</e> ważny!
</warn>

<p>
Przystępując do pracy należy upewnić się czy zmiennej PATH nadano odpowiednią
wartość. W tym celu przeprowadza się edycję pliku
<path>/etc/env.d/00basic</path> i dodać do tej zmiennej (jeżeli konieczne są
zmiany) katalog <path>/usr/local/bin</path>. Po przeprowadzonych zmianach
uruchamia się <c>env-update</c> w celu przeładowania skryptów.
</p>

<pre caption="Edytowanie 00basic">
# <i>nano -w /etc/env.d/00basic</i>
# <i>env-update</i>
# <i>source /etc/profile</i>
</pre>

<p>
Aby wirtualny system uruchomił się musi być tak skonfigurowany, aby <e>nie</e>
montował automatycznie  <path>/dev</path> (devfs). Drugą istotną rzeczą jest
<e>tmpfs</e>. Wirtualny system plików powinien być wkompilowany w system aby
skrypty startowe Gentoo miały możliwość przechowywania tam swoich danych. Wersja
binarna jądra jest dostępna ze strony www podanej wyżej. Jądro automatycznie
montuje <path>/dev</path> o ile nie posiada wkompilowanej obsługi tmpfs.
</p>

<p>
Przed rozpoczęciem zaleca się przeczytanie dokumentacji dostępnej do omawianego
tematu. Podstawowym założeniem uruchomienie <path>/usr/local/bin/linux</path>. Program
uruchamiając się próbuje uruchomić system zawarty w pliku
<path>root_fs</path>, który powinien znajdować się w katalogu domowym.
</p>

<p>
Nie wymaganą czynnością, lecz pożyteczną jest zainstalowanie narzędzi do
wirtualnego systemu.
</p>

<pre caption="Instalowanie narzędzi UML">
# <i>emerge sys-apps/usermode-utilities</i>
</pre>

<p>
Narzędzia te umożliwiają komunikację pomiędzy wirtualnym systemem, a systemem
gospodarza oraz ustawiają kilka innych rzeczy.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Tworzenie root_fs</title>
<section>
<title>Tworzenie chrootowalnego Gentoo</title>
<body>

<p>
Plik <path>root_fs</path> zawiera w sobie cały system plików Gentoo. Aby go
utworzyć będzie potrzebna obsługa urządzeń "loopback" wkompiolowana w jądro
systemu gospodarza (nie w jądro systemu wirtualnego).
</p>

<p>
Pierwszym krokiem będzie stworzenie drzewa katalogów Gentoo poprzez standardowe
chrootowanie. Najprościej będzie użyć odpowiedniego pliku etapu z płyty liveCD
bądź to z jej obrazu. Innym rozwiązaniem będzie pobranie go z Internetu.
</p>

<pre caption="Montowanie obrazu iso płyty instalacyjnej">
# <i>mkdir /mnt/loop</i>
# <i>mount -o loop /ścieżka/do/instalacji-&lt;TAB&gt;.iso /mnt/loop</i>
</pre>

<p>
Ustawienia środowiska chrootowalengo są identyczne jak standardowej kompilacji Gentoo.
</p>

<pre caption="Creating the Gentoo chroot mount">
# <i>mkdir /mnt/gentoo</i>
# <i>cd /mnt/gentoo</i>
# <i>tar xvjpf /path/to/stage&lt;TAB&gt;.tar.bz2</i>
</pre>

<p>
Na tym etapie można juz odmontować obraz .iso - nie będzie już używany.
</p>

<p>
Bootstrap i kompilacja systemu przebiega w krokach opisanych w Podręczniku
instalacji Gentoo. Należy po prostu postępować zgodnie z instrukcjami tam
spisanymi.
</p>

<p>
Użytkownik ma wolną rękę jeżeli chodzi o dobór instalowanych na wirtualnym
serwerze pakietów Wirtualny system można również nazwać dowolnie, według
własnego uznania. Kolejnym krokiem będzie poprawne ustawienie pliku
<path>/etc/fstab</path> <path>/dev/ROOT</path> zmienia sie na
<path>/dev/ubd/0</path>, obsługiwane typy  systemów plików to: ext2, ext3, or
reiserfs. <path>/dev/SWAP</path> zmienia się na <path>/dev/ubd/1</path>, należy
również odkomentować ścieżkę <path>/dev/BOOT</path> jeżeli posiadamy osobną
partycję rozruchową.
</p>

<p>
Na tym etapie instalacji ustawia się hasło roota. Służy do tego polecenie:
</p>

<pre caption="Ustawianie hasła roota">
# <i>passwd</i>
</pre>

<p>
Po ustawieniu hasła roota możemy przystąpić do zmian w skryptach startowych.
Należy usunąć consolefont i keymaps z poziomu uruchomieniowego "boot":
</p>

<pre caption="Usuwanie niepotrzebnych skryptów startowych">
# <i>rc-update del consolefont boot</i>
# <i>rc-update del keymaps boot</i>
</pre>

<p>
Teraz można wyjść ze środowiska chrootowalengo, odmontować wszystkie dublujące
się napędy i oczyścić cały system.
</p>

<pre caption="Finalizowanie instalacji">
# <i>cd /mnt/gentoo</i>
# <i>tar cvjpf ~/gentoo.tbz2 *</i>
# <i>cd</i>
# <i>rm -rf /mnt/gentoo</i>
</pre>

</body>
</section>
<section>
<title>Tworzenie root_fs</title>
<body>

<p>
Nasze środowisko zajmuje prawie 300 MB, dlatego warto zarezerwować co najmniej
500 MB dla <path>root_fs</path>.
</p>

<pre caption="Tworzenie plików UML">
# <i>dd if=/dev/zero of=root_fs seek=500 count=1 bs=1M</i>
# <i>mke2fs -F root_fs</i>
# <i>mount -o loop root_fs /mnt/loop</i>
# <i>tar xvjpf gentoo.tbz2 -C /mnt/loop</i>
# <i>umount /mnt/loop</i>
</pre>

<p>
Bardzo przydatny jest również plik wymiany - także w rozmiarze 500 MB. Tworzy
się go poprzez wydanie następujących komend:
</p>

<pre caption="Tworzenie partycji wymianyCreate swap partition">
# <i>dd if=/dev/zero of=swap_fs seek=500 count=1 bs=1M</i>
# <i>mkswap -f swap_fs</i>
</pre>

<p>
Teraz testujemy ustawienia i sprawdzamy czy nie popełniliśmy w nich błędu.
</p>

<pre caption="Uruchamianie wątka jądra UML">
# <i>linux ubd0=root_fs ubd1=swap_fs</i>
</pre>

<p>
Jeżeli nie pojawi się żaden komunikat świadczący o błędzie przechodzimy do
ustawienia wirtualnej konsoli. Wirtualny system używa xterma jako konsoli, która
będzie uruchamiana w trakcie startu systemu, dlatego należy się upewnić czy
zmienna $DISPLAY jest odpowiednio ustawiona oraz czy użytkownik posiada
odpowiednie prawa do xhost/xauth.
</p>

<p>
Przy odrobinie szczęścia będzie możliwe zalogowanie się do systemu.
Jedyną niedogodnością w systemie wirtualnym jest nie w pełni sprawna sieć.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Sieć</title>
<section>
<body>

<p>
Należy się upewnić czy system gospodarza ma odpowiednie pozycje wkompilowane w
jądro jako moduły:
</p>

<pre caption="Konfiguracja jądra systemu gospodarza">
Networking --&gt;
  IP: Netfilter Configuration --&gt;
    IP tables support --&gt;
      Full NAT --&gt;
        &lt;M&gt; MASQUERADE target support

    Network Device Support --&gt;
      &lt;M&gt; TUN/TAP Support
</pre>

<p>
Po sprawdzeniu odpowiednich modułów ładujemy je poprzez wydanie następujących
poleceń:
</p>

<pre caption="Konfigurowanie sieci">
# <i>modprobe tun</i>
<comment>(Jeżeli otrzymamy krytyczny błąd, to zawsze będzie można skasować /dev/net/tun i spróbować jeszcze raz)</comment>
# <i>modprobe iptable_nat</i>
# <i>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</i>
# <i>echo 1 > /proc/sys/net/ipv4/ip_forward</i>
</pre>

<p>
Polecenie iptables wprowadza regułę filtrowania pakietów, a w tym konkretnym
przypadku maskowanie IP pomiędzy prywatną siecią, na której będzie działał
wirtualny system, a internetem (osiąganym przez interfejs <c>eth0</c>). W tym
procesie będzie brała udział brama sieciowa.
</p>

<p>
Tak ustawiony system powinien działać poprawnie.
</p>

<pre caption="Get UML up and running">
# <i>linux ubd0=root_fs ubd1=swap_fs eth0=tuntap,,,192.168.0.254</i>
<comment>(logowanie do systemu wirtualnego)</comment>
# <i>ifconfig eth0 192.168.0.1 up</i>
# <i>ping -c 2 192.168.0.254</i>
PING 192.168.0.254 (192.168.0.254): 56 octets data
64 octets from 192.168.0.254: icmp_seq=0 ttl=255 time=0.8 ms
64 octets from 192.168.0.254: icmp_seq=1 ttl=255 time=0.6 ms

--- 192.168.0.254 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.6/0.7/0.8 ms
# <i>route add default gw 192.168.0.254</i>
# <i>netstat -rn</i>
Kernel IP routing table
Destination  Gateway        Genmask        Flags MSS Window irtt Iface
192.168.0.0  0.0.0.0        255.255.255.0  U      40 0         0 eth0
0.0.0.0      192.168.0.254  0.0.0.0        UG     40 0         0 eth0
# <i>scp user@192.168.0.254:/etc/resolv.conf /etc/resolv.conf</i> <comment>(if needed)</comment>
# <i>ping -c 2 www.gentoo.org</i>
PING www.gentoo.org (207.170.82.202): 56 octets data
64 octets from 207.170.82.202: icmp_seq=0 ttl=240 time=119.6 ms
64 octets from 207.170.82.202: icmp_seq=1 ttl=240 time=92.0 ms

--- www.gentoo.org ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 92.0/105.8/119.6 ms
</pre>

<p>
Wirtualny system reprezentowany jest przez urządzenie eth0 o adresie IP
192.168.0.1. System gospodarza posiada adres 192.168.0.254, wysyłamy ping, aby
upewnić się czy sieć pomiędzy systemami funkcjonuje poprawnie.  Po dodaniu
domyślnej bramy można użyć "scp" w celu ściągnięcia działającego
<path>/etc/resolv.conf</path>. Po wgraniu go do /etc wysyłamy ping na
www.gentoo.org, aby upewnić się czy mamy dostęp do Internetu. Na tym etapie system
wirtualny można emergować w dowolnym momencie!
</p>

</body>
</section>
</chapter>
<chapter>
<title>Testowanie .iso</title>
<section>
<body>
<p>
Uruchomienie .iso, albo initrd z obrazu .iso, jest całkiem proste.
</p>

<pre caption="Uruchamianie ISO">
# <i>mount -o loop /path/to/install-&lt;TAB&gt;.iso /mnt/loop</i>
# <i>cp /mnt/loop/isolinux/gentoo.igz .</i>
# <i>linux load_ramdisk=1 prompt_ramdisk=0 ramdisk_size=22000 \</i>
&gt; <i>initrd=rescue.gz root=/dev/ram0 ubd0=root_fs ubd1=swap_fs \</i>
&gt; <i>ubd2=/dev/cdroms/cdrom0 eth0=tuntap,,,192.168.0.254</i>
</pre>

<p>
Od tej pory wszystkie czynności wykonuje się tak jak opisano to w Podręczniku
instalacji Gentoo. Warto przy tym pamiętać, które urządzenia odpowiadają którym
systemom plików: główny system to <path>/dev/ubd/0</path>, plik wymiany
<path>/dev/ubd/1</path>, a napęd CDROM to <path>/dev/ubd/2</path>.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Źródło</title>
<section>
<body>

<ul>
  <li>
    <uri link="http://edeca.net/articles/bridging/index.html">Mostkowanie z
    wykorzystaniem UML</uri>
  </li>
  <li>
    <uri link="http://user-mode-linux.sourceforge.net/">Strona domowa UML</uri>
  </li>
  <li>
    <uri link="http://www.theshore.net/~caker/uml/">Notatki UML Caker-a</uri>
  </li>
  <li>
    <uri link="http://sourceforge.net/mailarchive/forum.php?forum_id=3647">
    Archiwum listy dyskusyjnej UML</uri>
  </li>
</ul>

</body>
</section>
</chapter>

</guide>

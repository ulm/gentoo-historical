<?xml version='1.0' encoding="UTF-8"?>
<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">
<!-- $Header: /var/cvsroot/gentoo/xml/htdocs/doc/pl/lvm2.xml,v 1.2 2005/08/17 22:45:35 rane Exp $ -->

<guide link = "/doc/pl/lvm2.xml" lang="pl">
<title>Instalacja LVM2 w Gentoo</title>
<author title="Autor">
  <mail link="avi@CFFtechnologies.com">Avi Schwartz</mail>
</author>
<author title="Współpracownik">
  <mail link="rajiv@gentoo.org">Rajiv Manglani</mail>
</author>
<author title="Redaktor">
  <mail link="neysx@gentoo.org">Xavier Neys</mail>
</author>

<abstract>
Ten poradnik opisuje konfigurację Gentoo używającego "Logical Volume
Manager" w wersji drugiej (LVM2).
</abstract>

<license/>

<version>2.0.10</version>
<date>2005-08-17</date>

<chapter>
<title>Wstęp</title>
<section>
<body>

<p>
Przewodnik ten bazuje na przykładzie komputera z dwoma dyskami twardymi
IDE. To znaczy tyle, że musisz dostosować swoją konfigurację 
(dyski, nazwy partycji oraz ich rozmiary) do posiadanego sprzętu.
</p>

<warn>
Należy tu zaznaczyć, że ten dokument nie miał być pełnym wykładem na temat LVM2.
Powstał on jedynie jako uzupełnienie procedury instalacji Gentoo opisanej w <uri
link="/doc/pl/handbook/handbook-x86.xml?part=1&amp;chap=0">Handbook,
Part 1</uri>. Pamiętaj, aby <c>przeczytać</c> przewodnik po instalacji Gentoo, 
<c>zanim</c> zaczniesz proces instalacji.
</warn>

<note>
W celu przejrzenia kompletnego przewodnika o LVM, skieruj swoją przeglądarkę na
stronę <uri>http://tldp.org/HOWTO/LVM-HOWTO</uri>
</note>

</body>
</section>
<section>
<title>Podstawowe wymagania</title>
<body>

<p>
Jeżeli przeprowadzasz nową instalację Gentoo, konieczne będzie użycie botowalnej
płyty z obsługą LVM2 takiej jak np. Gentoo LiveCD. LiveCd dla architektury x86
możesz odnaleźć na naszych <uri
link="/main/en/mirrors.xml">mirrorach</uri> w
katalogu <path>/releases/x86/2004.3/livecd</path>. Pozostałe architektury także
powinny być obsługiwane.
</p>

<p>
Jeżeli instalujesz LVM2 na części wolnego dysku działającego już systemu, 
musisz mieć skompilowany moduł LVM2 (<path>dm-mod</path>). Moduł ten jest
dostępny w <path>gentoo-sources</path> i w <path>vanilla-sources</path>.
Kompilacja jądra i konfiguracja LVM2 jest opisana w dalszej części tego
przewodnika.
</p>

<p>
Nie każde jądro z serii 2.4 dostępne w Gentoo posiada obsługę LVM2!
</p>

<warn>
LVM2 dostępne na płytach instalacyjnych wydania 2005.0 jest błędnie połączone z
biblioteką (libgpm) znajdującą się w <path>/usr</path>. Oznacza to, że w
środowisku LVM nie może znajdować się katalog <path>/usr</path>. Należy albo
zainstalować najnowszą wersję albo wersję 2.0.33 (nie -r1), obie są budowane
statycznie.
</warn>

</body>
</section>
<section>
<title>Partycje</title>
<body>

<p>
Nasz przykładowy system posiada 2 dyski twarde IDE podzielone na partycje
następująco:  
</p>

<ul>
  <li>/dev/hda1  --  /boot</li>
  <li>/dev/hda2  --  (swap)</li>
  <li>/dev/hda3  --  /</li>
  <li>/dev/hda4  --  Będzie używane przez LVM2</li>
  <li>/dev/hdb1  --  Będzie używane przez LVM2</li>
</ul>

<impo>
Zwracaj szczególną uwagę na nazwy partycji, ponieważ bardzo łatwo jest pokręcić
te literki i cyferki. Jeden fałszywy ruch może zniszczyć Twoją przypadkowo źle
wskazaną partycję. Pamiętaj, że Cię oszczegaliśmy!
</impo>

<p>
Pora zaczynać...  
</p>

</body>
</section>
</chapter>

<chapter>
<title>Instalacja</title>
<section>
<body>

<p>
Postępuj zgodnie z instrukcjami podręcznika instalacji uwzględniając poprawkę do
rozdziału <c>4. Przygotowanie dysków</c>:
</p>

<p>
Używaj programu <c>fdisk</c> tak jak to opisano w podręczniku instalacji, ale
używając schematu podziału na partycje przedstawionego w powyższym przykładzie.
Pamiętaj, że to tylko <e>przykład</e>, a więc dostosuj go do swoich potrzeb.
</p>

<p>
Stwórz małą fizyczną partycję /boot (hda1). W tym przykładzie, /boot nie będzie
partycją zarządzaną przez LVM2. Partycja ta będzie zawierała bootloader oraz
Twoje jądro. 64MB partycja powinna w zupełności wystarczyć nawet dla kilku
jąder.
</p>

<p>
Stwórz partycję swap (hda2) i ustaw ją jako aktywną.
</p>

<pre caption="Tworzenie partycji swap">
# <i>mkswap /dev/hda2</i>
# <i>swapon /dev/hda2</i>
</pre>

<p>
Stwórz teraz partycję / (hda3). Jeżeli interesuje Cię zarządzanie partycją root
przez LVM2 (co nie jest zalecane), zobacz sekcję dotyczącą zasobów dokumentacji
na końcu tego przewodnika, znajduję się tam odnośnik do mini-przewodnika
opisującego jak to zrobić. Partycja root nie musi być wcale duża, jeżeli
zamierzasz trzymać <path>/opt /usr /home /var</path> oraz <path>/tmp</path> na
grupie wolumenów (vg), to 1GB miejsca powinno być wystarczające.
</p>

<note>
<b>Nie jest</b> zalecanym, trzymanie następujących katalogów na LVM2:
<path>/etc</path>, <path>/lib</path>, <path>/mnt</path>,
<path>/proc</path>, <path>/sbin</path>, <path>/dev</path>, <path>/root</path>.
Trzymając się tej reguły ciągle będzie isniała możliwośc logowania się do 
systemu (co prawda troche okaleczonego, ale ciągle dostępnego przynajmniej 
jako root) jeżeli coś by poszło niezgodnie z planem.
</note>

<p>
W tym momencie partycje /boot, swap oraz root nie używają całego dysku, stwórzmy
więc czwartą partycję na tym dysku i ustawmy jej typ na 8e (Linux LVM). Jeżeli
posiadasz więcej fizycznych dysków które masz zamiar użyć z LVM, stwórz jedną
partycję na każdym i ustaw im ten sam typ (8e).
</p>

<note>
Wobec tego, że dzisiejsze dyski mają ogromne pojemności, możesz wziąć pod uwagę
podział swoich dysków na mniejsze partycje, zamiast tworzyć jedną dużą, która
będzie dodana do wolumenu grup jako jeden blok. LVM2 umożliwia łatwe
rozszerzanie wolumenów. W ten sposób pozostanie Ci miejsce, które możesz kiedyś
użyć np. do czegoś innego niż kolejna partycja LVM2. W skrócie, nie używaj
całości swojego dysku, chyba że naprawdę wiesz, że będzie Ci potrzebny. Na
przykład jeden z moich współpracowników podzielił swój 160 Gb dysk na 8 partycji
po 20 Gb każda.
</note>

<p>
Ładowanie modułu LVM2 <path>dm-mod</path>.
</p>

<pre caption="Ładowanie modułu LVM2">
# <i>modprobe dm-mod</i>
</pre>

<p>
Skanowanie i aktywacja LVM:
</p>

<pre caption="Aktywacja LVM">
<comment>(Zapobiegamy skanowaniu cdromu)</comment>
# <i>mkdir -p /etc/lvm</i>
# <i>echo 'devices { filter=["r/cdrom/"] }' >/etc/lvm/lvm.conf</i>
# <i>vgscan</i>
  Reading all physical volumes.  This may take a while...
  No volume groups found
<comment>(Pozwalamy na dostęp do wszystkich stworzonych wolumenów grup)</comment>
# <i>vgchange -a y</i>
</pre>

<p>
Przygotowanie partycji.
</p>

<pre caption="Przygotowanie partycji">
# <i>pvcreate /dev/hda4 /dev/hdb1</i>
  No physical volume label read from /dev/hda4
  Physical volume "/dev/hda4" successfully created
  No physical volume label read from /dev/hdb1
  Physical volume "/dev/hdb1" successfully created
</pre>

<p>
Konfigurujemy wolumen grup. Wolumen grup jest rezultatem połączenia wielu
fizycznych części dysku, bądź dysków w jedno logiczne urządzenie.
</p>

<p>
W naszym przykładzie, <path>/dev/hda1</path>, <path>/dev/hda2</path> i
<path>/dev/hda3</path> są partycjami <path>/boot</path>, swap oraz root, więc
musimy połączyć <path>/dev/hda4</path> oraz <path>/dev/hdb1</path>. Możemy
tego dokonać wydając jedną komendę, jednak, ponieważ to przykład, utworzymy nasz
wolumen grup, a następnie roszerzymy go.
</p>

<pre caption="Tworzenie i rozszerzanie wolumenu grup">
<comment>(Tworzymy wolumen grup i nazywamy go vg)</comment>
# <i>vgcreate vg /dev/hda4</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Zignoruj to ostrzeżenie)</comment>
  Volume group "vg" successfully created
<comment>(Rozszerzamy istniejący wolumen grup)</comment>
# <i>vgextend vg /dev/hdb1</i>
  /etc/lvm/backup: fsync failed: Invalid argument <comment>(Ignorujemy to ostrzeżenie ponownie i kolejne podobne także)</comment>
  Volume group "vg" successfully extended
</pre>

<p>
Tworzymy logiczne wolumeny. Logiczne wolumeny są odpowiednikami partycji
tworzonych za pomocą programu fdisk poza środowiskiem LVM2. W naszym przykładzie
stworzymy następujące partycje:
</p>

<table>
<tr>
  <th>Katalog</th>
  <th>Wielkość</th>
</tr>
<tr>
  <ti>/usr</ti>
  <ti>10 GB</ti>
</tr>
<tr>
  <ti>/home</ti>
  <ti>5 GB</ti>
</tr>
<tr>
  <ti>/opt</ti>
  <ti>5 GB</ti>
</tr>
<tr>
  <ti>/var</ti>
  <ti>10 GB</ti>
</tr>
<tr>
  <ti>/tmp</ti>
  <ti>2 GB</ti>
</tr>
</table>

<p>
Odkąd planujemy używać LVM2, nie musimy się zbytnio obawiać o wielkość tych
partycji, ponieważ mogą one być łatwo rozszerzone w razie potrzeby.
</p>

<note>
Jak to skomentował Terje Kvernes, łatwiej jest zwiększyć pojemność partycji niż
ją pomniejszyć. Zatem możesz zacząć z mniejszymi rozmiarami partycji i
rozszerzać je w miarę potrzeb.
</note>

<pre caption="Tworzenie i rozszerzanie logicznych wolumenów">
# <i>lvcreate -L10G -nusr  vg</i>
  Logical volume "usr" created <comment>(Następne podone wiadomości pomijamy)</comment>
# <i>lvcreate -L5G  -nhome vg</i>
# <i>lvcreate -L5G  -nopt  vg</i>
# <i>lvcreate -L10G -nvar  vg</i>
# <i>lvcreate -L2G  -ntmp  vg</i>
<comment>(Ponieważ to przykład, pokażmy jak rozszerzyć nasz locziczny wolumen o 5 Gb)</comment>
# <i>lvextend -L+5G /dev/vg/home</i>
</pre>

<p>
Na utworzonych logicznych wolumenach tworzymy systemy plików dokładnie tak samo
jak na zwykłych partycjach. Użyjemy systemu plików ext3 na naszych logicznych
wolumenach, jednak każdy inny który wybierzesz będzie działał tak samo dobrze:
</p>

<pre caption="Tworzenie systemów plików">
# <i>mke2fs -j /dev/vg/usr</i>
# <i>mke2fs -j /dev/vg/home</i>
# <i>mke2fs -j /dev/vg/opt</i>
# <i>mke2fs -j /dev/vg/var</i>
# <i>mke2fs -j /dev/vg/tmp</i>
</pre>

<p>
Podmontuj swoje partycje tak jak to opisuje podręcznik instalacji i podmontuj
swoje logiczne wolumeny LVM2 tak jakby były one partycjami. Zamień tylko zwykłe
<path>/dev/hdxx</path> na <path>/dev/vg/logical_volumename</path>.  
</p>

<pre caption="Montujemy logiczne wolumeny">
<comment>(Upewnij się, że masz podmontowaną partycję root tak jak to opisuje podręcznik instalacji)</comment>
# <i>mkdir /mnt/gentoo/usr</i>
# <i>mount /dev/vg/usr /mnt/gentoo/usr</i>
# <i>mkdir /mnt/gentoo/home</i>
# <i>mount /dev/vg/home /mnt/gentoo/home</i>
# <i>mkdir /mnt/gentoo/opt</i>
# <i>mount /dev/vg/opt /mnt/gentoo/opt</i>
# <i>mkdir /mnt/gentoo/var</i>
# <i>mount /dev/vg/var /mnt/gentoo/var</i>
# <i>mkdir /mnt/gentoo/tmp</i>
# <i>mount /dev/vg/tmp /mnt/gentoo/tmp</i>
</pre>

<note>
Pozostała część podręcznika instalacji pozostaje w większości niezmieniona, więc
wskażemy tu tylko różnice.
</note>

<p>
Kiedy konfigurujesz swoje jądro, pamiętaj aby zaznaczyć obsługę LVM2 (nie
wszystkie jądra serii 2.4 mają taką opcję). Zaznacz moduł LVM2 jak w
przykładzie:
</p>

<pre caption="Zaznaczamy moduł LVM2 w jądrach serii 2.4.x">
Multi-device support (RAID and LVM)  ---&gt;
  [*] Multiple devices driver support (RAID and LVM)
  &lt; &gt;  RAID support
<comment>(Zwróć uwagę, że nie zaznaczamy LVM ponieważ dotyczy on LVM1)</comment>
  &lt; &gt;  Logical volume manager (LVM) support
  &lt;M&gt;  Device-mapper support
  &lt; &gt;   Mirror (RAID-1) support
</pre>

<pre caption="Zaznaczamy moduł LVM2 w jądrach serii 2.6.x">
Device Drivers  ---&gt;
 Multi-device support (RAID and LVM)  ---&gt;
   [*] Multiple devices driver support (RAID and LVM)
   &lt; &gt;   RAID support
   &lt;M&gt;   Device mapper support
</pre>

<p>
Skompilowany moduł będzie miał nazwę <path>dm-mod.ko</path>
</p>

<p>
Kiedy już przebrniesz przez budowę jądra, dodaj następującą linię do
<path>/etc/modules.autoload.d/kernel-{KV}</path>, gdzie {KV} reprezentuje wersję
Twojego jądra (2.4 lub 2.4), tak aby moduł LVM2 był ładowany w momencie startu
systemu:
</p>

<pre caption="Dodajemy moduł LVM2 do /etc/modules.autoload.d/kernel-2.6">
# <i>nano -w /etc/modules.autoload.d/kernel-2.6</i>
<comment>(Dodaj następującą linię)</comment>
dm-mod
</pre>

<p>
Teraz, zainstalujmy paczkę lvm2.
</p>

<impo>
Upewnij się, że <path>/usr/src/linux</path> jest dowiązaniem do źródeł Twojego
jądra, którego używasz ponieważ ebuild lvm2 zależy od ebuildu device-mapper,
który z koleji sprawdza obecność wymaganych plików źródłowych w
katalogu <path>/usr/src/linux/include/linux</path>.
</impo>

<pre caption="Emergujemy paczkę LVM2">
# <i>emerge lvm2</i>
<comment>(W czasie pisania tego poradniku, najnowszą stabilną wersją jest wersja 2.00.08.
Pracując z wersją 2.00.08, należy zapobiedz wykrywaniu cdromu przez lvm2 poprzez:</comment>
# <i>echo 'devices { filter=["r/cdrom/"] }' >> /etc/lvm/lvm.conf</i>

<comment>(Wersja 2.00.15 i późniejsze udostępniają nam plik /etc/lvm/lvm.conf
Edytuj go i podążaj za komentarzami</comment>
# <i>nano -w /etc/lvm/lvm.conf</i>
</pre>

<p>
Podczas edycji pliku <path>/etc/fstab</path>, postępuj według instrukcji
podręcznika instalacji i dodaj swoje logiczne wolumeny LVM2. Podajemy tu kilka
linijek stosownych do naszego przykładu:
</p>

<pre caption="Listing pliku /etc/fstab">
/dev/hda1     /boot   ext3    noauto,noatime 1 1
/dev/hda2     none    swap    sw             0 0
/dev/hda3     /       ext3    noatime        0 0
# Logical volumes
/dev/vg/usr   /usr    ext3    noatime        0 0
/dev/vg/home  /home   ext3    noatime        0 0
/dev/vg/opt   /opt    ext3    noatime        0 0
/dev/vg/var   /var    ext3    noatime        0 0
/dev/vg/tmp   /tmp    ext3    noatime        0 0
</pre>

<p>
Kiedy dobrniesz do końca przewodnika instalacji nie zapomnij odmontować
wszystkich logicznych wolumenów LVM2 i w dobrej mierze uruchom następujące
komendy przed ponownym uruchomieniem:
</p>

<pre caption="Zakańczanie pracy z LVM2">
# <i>vgchange -a n</i>
</pre>

<p>
Uruchom ponownie komputer i wszystkie partycje powinny być widziane i
podmontowane.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Continuing After a Reboot</title>
<section>
<body>

<p>
Aby wznowić instalację po przerwaniu należy najpierw utworzyć odpowiednie
wezły dla urządzeń.
</p>
 
<pre caption="Reaktywowanie woluminów">
# <i>vgscan --mknodes</i>
</pre>

<p>
Płyty instalacyjne ze starszymi narzędziami czasem wymagają przy odzyskiwaniu
następującej procedury:
</p>

<pre caption="Reaktywowanie woluminów">
<comment>(Po pierwsze wszystkie deaktywujemy)</comment>
# <i>vgchange -a n</i>
<comment>(Eksportujemy je)</comment>
# <i>vgexport -a vg</i>
<comment>(Importujemy wszystkie woluminy)</comment>
# <i>vgimport -a vg</i>
<comment>(Reaktywujemy wszystkie woluminy)</comment>
# <i>vgchange -a y</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Zasoby</title>
<section>
<body>

<ul>
  <li>
    Oficjalna <uri link="http://sources.redhat.com/lvm2">strona domowa LVM2</uri>
  </li>
  <li>
    <uri link="http://tldp.org/HOWTO/LVM-HOWTO">Przewodnik po LVM</uri>
  </li>
  <li>
    Artykuły Daniela Robbins'a na temat LVM:
    <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm/?dwzone=linux</uri>
    oraz 
    <uri>http://www-106.ibm.com/developerworks/linux/library/l-lvm2.html?dwzone=linux</uri>
  </li>
  <li>
    Jak umieścić partycje /boot i root pod kontrolą LVM1:
    <uri>http://www.the-infinite.org/archive/docs/lvm/howto-boot-off-root-lv.txt</uri>
  </li>
</ul>

</body>
</section>
</chapter>

<chapter>
<title>Podziękowania</title>
<section>
<body>

<p>
Dziękuję <mail link="bangert@gentoo.org">Thilo Bangert</mail> oraz
<mail link="terjekv@math.uio.no">Terje Kvernes</mail> za ich pomoc i uwagi
dotyczące tego dokumentu.
</p>

</body>
</section>
</chapter>
</guide>

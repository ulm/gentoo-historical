<?xml version='1.0' encoding='UTF-8'?>

<!DOCTYPE guide SYSTEM "/dtd/guide.dtd">

<guide link="/doc/hu/ldap-howto.xml">
<title>OpenLDAP hitelesítési útmutató</title>

<author title="Author">
  <mail link="sj7trunks@gentoo.org">Benjamin Coles</mail>
</author>

<author title="Editor">
  <mail link="swift@gentoo.org">Sven Vermeulen</mail>
</author>

<author title="Editor">
  <mail link="tseng@gentoo.org">Brandon Hale</mail>
</author>

<author title="Hungarian Translator">
  Barak Tamás
</author>

<abstract>
Ez a leírás bevezet az LDAP alapjaiba és megmutatja, hogyan állítsd be az 
OpenLDAP-ot hitelesítési céllal.
</abstract>

<license/>

<version>0.1</version>
<date>2003.11.17.</date>

<chapter>
<title>Bevezetés az OpenLDAP-ba</title>
<section>
<title>Mi az az LDAP?</title>
<body>

<p>
Az LDAP a <e>Lightweight Directory Access Protocol</e> rövidítése. Az
X.500-ra alapulva átfogja annak a legtöbb fő funkcióját, de hiányzik belőle néhány olyan titokzatos
funkció, amivel az X.500 rendelkezik. Mi ez a X.500 és miért van LDAP?
</p>

<p>
Az X.500 egy modell a könyvtár szolgáltatásokra az OSI definiciója szerint. Ez tartalmaz
névterület definiciókat és protokollokat a lekérdezésekhez és a könyvtárak frissítéséhez.
Az X.500 azonban sok szituációban túlzásnak talált. Nézzünk bele az LDAP-ba.
Az X.500-hoz hasonlóan biztosítja az adat/névterület modelleket a könyvtárakhoz és egy protokollat is.
Habár az LDAP úgy lett tervezve, hogy közvetlenül a TCP/IP verem felett fusson. Tekints úgy az LDAP-ra,
mint az X.500 karcsúsított változatára.
</p>

</body>
</section>

<section>
<title>Nem értem. Mi az a könyvtár?</title>
<body>

<p>
A könyvtár egy speciális adatbázis, amit gyakori lekérdezésekre de nem gyakori frissítésekre terveztek.
A szokványos adatbázisokkal ellentétben nem tartalmaznak támogatást a tranzakciókhoz vagy a visszaforgatáshoz.
A könyvtárakat könnyen lehet többszörözni, az elérhetőség és megbízhatóság növelése végett. Amikor többszörösítik
a könyvtárakat, előfordulhatnak ideiglenes inkonzisztenciák (ellentmondások, belső hibák) addig, amíg a szinkronizálás
be nem fejeződik.
</p>

</body>
</section>

<section>
<title>Hogy épül fel az információ szerkezete?</title>
<body>

<p>
Minden információ egy hierarchikusan rendezett könyvtárban van. Ha adatot akarsz bevinni egy könyvtárba, a könyvtárnak
tudnia kell, hogyan kell a fa-szerkezetben adatot tárolni.
Most nézzünk meg egy kitalált vállalatot és egy internetszerû fát:
</p>

<pre caption = "A GenFic, egy kitalált Gentoo társaság szerkezeti felépítése">
dc:         com
             |
dc:        genfic         <comment>(Szervezet)</comment>
          /      \
ou:   people   servers    <comment>(Szervezeti egységek)</comment>
      /    \     ..
uid: ..   jhon            <comment>(a felhasználók adatai)</comment>
</pre>

<p>
Mivel ezen az ábrán nem küldünk adatot egy adatbázisnak, a fa-szerkezet minden pontját meg kell határozni.
Az ilyen pontok elnevezésére az LDAP egy név-sémát alkalmaz. A legtöbb LDAP terjesztés (beleértve az
OpenLDAP-ot is) máris tartalmaz nagyszámú előre definiált (és általában elfogadott) sémát, mint az inetorgperson,
ami egy gyakran használt séma a felhasználók meghatározására.
</p>

<p>
Az érdekelt felhasználók olvassák el az <uri link="http://www.openldap.org/doc/admin21/">OpenLDAP Adminisztrációs Leírást</uri>.
</p>

</body>
</section>

</chapter>


<chapter>
<title>OpenLDAP beállítása</title>
<section>
<title>Kezdeti beállítások</title>
<body>

<note>
Ez a dokumentum a genfic.com címet használja példának.
Neked természetesen ki kell cserélned ezt. Azonban győződj meg arról, hogy a legfelső csomópont egy hivatalos
TLD (top level domain - legfelsőbb szintű domain, pl: net, com, cc, be..).
</note>

<p>
Elöször is emergeljük a szükséges komponenseket:
</p>

<pre caption="OpenLDAP telepítése">
# <i>emerge openldap pam_ldap nss_ldap migrationtools</i>
</pre>

<p>
Szerkesszük az <path>/etc/openldap/slapd.conf</path> fájlt és adjuk hozzá a következõt a
<c>core.schema</c> után:
</p>

<pre caption="/etc/openldap/slapd.conf">
<comment># include-old a szükséges adatsémákat</comment>
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/nis.schema

<comment># Használj titkosítást a jelszavak elrejtésére</comment>
password-hash {crypt}

<comment># Definiáld az SSL és TLS tulajdonságait (opcionális)</comment>
TLSCertificateFile /etc/ssl/ldap.pem
TLSCertificateKeyFile /etc/openldap/ssl/ldap.pem
TLSCACertificateFile /etc/ssl/ldap.pem

<comment>(Lejjebb...)</comment>

database        ldbm
suffix          "dc=genfic,dc=com"
rootdn          "cn=Manager,dc=genfic,dc=com"
rootpw          <i>{MD5}Xr4ilOzQ4PCOq3aQ0qbuaQ==</i>
directory       /var/lib/openldap-ldbm
index           objectClass     eq

<comment>(Most kaptál egy titkosított jelszót a slappasswd -h {Md5} segítségével)</comment>
</pre>

<p>
Következõnek szerkesszük az LDAP konfigurációs fájlt:
</p>

<pre caption="/etc/openldap/ldap.conf">
# <i>nano -w /etc/openldap/ldap.conf</i>
<comment>(Adjuk hozzá a következõt...)</comment>

BASE    dc=genfic, dc=com
URI     ldaps://auth.genfic.com:636/
</pre>

<p>
Most generálni fogsz egy SSL hitelesítő kódot a könyvtárad biztosításához.
Válaszolj olyan jól a kérdésre, ahogy csak lehet. Amikor a rendes nevet
(<e>Common Name</e>) kéri, add meg azt a nevet, amit a kliensek akkor fognak használni, amikor a szerverhez kapcsolódnak.
Ez általában a teljes domainnév (pl:
<path>auth.genfic.com</path>).
</p>

<pre caption="SSL tanusítvány generálása">
# <i>cd /etc/ssl</i>
# <i>openssl req -config /etc/ssl/openssl.cnf -new -x509 -nodes -out \
ldap.pem -keyout /etc/openldap/ssl/ldap.pem -days 999999</i>
</pre>

<p>
Most szerkeszd az <path>/etc/conf.d/slapd</path> fájlt és add hozzá a következőt, a már létező sor kommentjelének törlésével:
</p>

<pre caption="/etc/conf.d/slapd">
OPTS="-h ldaps:// ldapi://%2fvar%2frun%2fopenldap%2fslapd.sock"
</pre>

<p>
Indítsd el a Slapd-t:
</p>

<pre caption = "SLAPd indítása">
# <i>/etc/init.d/slapd start</i>
</pre>

<p>
A következő paranccsal tesztelheted:
</p>

<pre caption = "SLAPd démon tesztelése">
# <i>ldapsearch -D "cn=Manager,dc=genfic,dc=com" -W</i>
</pre>

<p>
Ha hibát kapsz, próbáld hozzáadni a <c>-d 255</c> -t a részletesség növelésére, és oldd
meg a problémát.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Létezõ adatok felhasználása</title>
<section>
<title>Létezõ felhasználók használata</title>
<body>

<p>
Most felhasználjuk a létezõ felhasználókat. Nyissuk meg a
<path>/usr/share/migrationtools/migrate_common.ph</path> fájlt, és szerkesszük a következõképpen:
</p>

<pre caption="/usr/share/migrationtools/migrate_common.ph">
$DEFAULT_BASE = "dc=genfic,dc=com";
$EXTENDED_SCHEMA = 1;
<comment># Kommentezd ki a következő sorokat, hacsak nincs betöltve valamilyen levelező séma</comment>
<comment>#$DEFAULT_MAIL_DOMAIN = "genfic.com";</comment>
<comment>#$DEFAULT_MAIL_HOST = "mail.genfic.com";</comment>
</pre>

<p>
Most futtasuk a migration scriptet:
</p>

<pre caption="migration script futtatása">
# <i>export ETC_SHADOW=/etc/shadow</i>
# <i>cd /usr/share/migrationtools</i>
# <i>./migrate_base.pl > /tmp/base.ldif</i>
# <i>./migrate_group.pl /etc/group /tmp/group.ldif</i>
# <i>./migrate_hosts.pl /etc/hosts /tmp/hosts.ldif</i>
# <i>./migrate_passwd.pl /etc/passwd /tmp/passwd.ldif</i>
</pre>

<p>
Ez az utolsó lépés. Importáljuk az ldif filokat. Most adjuk hozzá a fájlokat a könyvtárhoz:
</p>

<pre caption="Adatok importálása a könyvtárba">
# <i>ldapadd -D "cn=Manager,dc=gentoo,dc=org" -W -f /tmp/base.ldif</i>
# <i>ldapadd -D "cn=Manager,dc=gentoo,dc=org" -W -f /tmp/group.ldif</i>
# <i>ldapadd -D "cn=Manager,dc=gentoo,dc=org" -W -f /tmp/passwd.ldif</i>
# <i>ldapadd -D "cn=Manager,dc=gentoo,dc=org" -W -f /tmp/hosts.ldif</i>
</pre>

</body>
</section>
</chapter>

<chapter>
<title>Hitelesítés beállítása</title>
<section>
<title>PAM beállítása</title>
<body>

<p>
Most be kell állítanod a PAM-ot, hogy engedje az LDAP hitelesítést. Add hozzá a
következõ sorokat a <path>/etc/pam.d/system-auth</path> fájlhoz:
</p>

<pre caption="/etc/pam.d/system-auth">
auth        sufficient    /lib/security/pam_ldap.so use_first_pass
account     sufficient    /lib/security/pam_ldap.so
password    sufficient    /lib/security/pam_ldap.so use_authtok
session     required      /lib/security/pam_mkhomedir.so skel=/etc/skel/ umask=0
session     optional      /lib/security/pam_ldap.so
</pre>

<p>
Most változtasd meg a <path>/etc/ldap.conf</path> fájlt:
</p>

<pre caption="/etc/ldap.conf">
<comment>#host 127.0.0.1</comment>
<comment>#base dc=padl,dc=com</comment>

ssl start_tls
ssl on
suffix          "dc=genfic,dc=com"
<comment>#rootbinddn uid=root,ou=People,dc=genfic,dc=com</comment>

uri ldaps://auth.genfic.com/
pam_password exop

ldap_version 3
pam_filter objectclass=posixAccount
pam_login_attribute uid
pam_member_attribute memberuid
nss_base_passwd ou=People,dc=genfic,dc=com
nss_base_shadow ou=People,dc=genfic,dc=com
nss_base_group  ou=Group,dc=genfic,dc=com
nss_base_hosts  ou=Hosts,dc=genfic,dc=com

scope one
</pre>

<p>
Végül a klienseket, hogy ellenõrizni tudják az LDAP rendszer felhasználóit:
</p>

<pre caption="/etc/nsswitch.conf">
passwd:         files ldap
group:          files ldap
</pre>

<p>
A változások teszteléséhez írd be:
</p>

<pre caption="LDAP hitelesítés tesztelése">
# <i>getent passwd|grep 0:0</i>

<comment>(Két bejegyzést kell visszakapnod:)</comment>
root:x:0:0:root:/root:/bin/bash 
root:x:0:0:root:/root:/bin/bash
</pre>

<p>
Talán észrevetted már, hogy az egyik sor, amit bemásoltál az <path>/etc/ldap.conf</path>-ba, ki volt
kommentezve (a <c>rootbinddn</c> sor): nincs erre szükséged, hacsak nem akarod valamelyik felhasználó
jelszavát rendszergazdaként megváltoztatni. Ebben az esetben nyers szövegként kell  echozni a rendszergazdai jelszót az
<path>/etc/ldap.secret</path> fájlba. Ez
<brite>VESZÉLYES</brite> és a fájlt érdemes 600-ra chmodozni. Én (a cikk eredeti írója) mindig üresen hagyom azt a fájlt,
 és ha valakinek a jelszavát meg kell változtatnom, ami mind az ldap-ban, mind az
<path>/etc/passwd</path>-ben szerepel, a jelszót arra a 10 másodpercre teszem oda, amíg megváltoztatom a jelszót, utána kitörlöm.
</p>

</body>
</section>

<section>
<title>OpenLDAP jogok</title>
<body>

<p>
Ha megnézed <path>/etc/openldap/slapd.conf</path> fájlt meg fogod látni, hogy meghatározhatod az adatok
 ACL-jeit (Access Control List, hozzáférési lista), hogy a felhasználók mit olvashatnak/írhatnak:
tudod írni és/vagy olvasni:
</p>

<pre caption="/etc/openldap/slapd.conf">
access to *
  by self write
  by users read
  by anonymous auth
</pre>

<p>
Ez MINDENHEZ hozzáférést ad. Ha az a te információd, akkor írni is tudod, ha másé, akkor csak olvasni.
A névtelenek küldhetnek azonosítót és jelszót, hogy bejelentkezzenek. Négy szint van, a legalacsonyabbtól
a legmagasabbig: <c>hitelesítés keresés olvasás írás (auth search read write)</c>.
</p>

<p>
A következõ ACL egy kicsit biztonságosabb, mert nem engedi a normális felhasználóknak, hogy más titkosított jelszavát olvassák:
</p>

<pre caption="/etc/openldap/slapd.conf">
access to dn=".*,dc=genfic,dc=com" attr="userPassword"
  by dn="uid=root,ou=people,dc=genfic,dc=com" write
  by dn="uid=John, ou=People,dc=genfic,dc=com" write
  by anonymous auth
  by self write
  by * search
  
access to *
  by dn="uid=root,ou=People,dc=genfic,dc=com" write
  by * read
</pre>

<p>
Ez a példa a root-nak és John-nak hozzáférést ad az olvasás/írás/kereséshez a fa szerkezetben <path>dc=genfic,dc=com</path>
-nél lejjebb. Továbbá lehetővé teszik a felhasználóknak, hogy megváltoztassák a saját <path>userPassword</path>-jüket.
A végén szereplő kijelentés mindenkinek lehetővé teszi a keresést, ami azt jelenti, hogy alkalmazhatnak egy kereső szűrőt, de nem
olvashatják el az eredményeket. Most több ACL is van, de a szabályok értelmében ezek alulról felfelé érvényesülnek, így a
legfelső szinnek kell a legkorlátozobbnak lennie.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Munka az OpenLDAP-pal</title>
<section>
<title>A könyvtár karbantartása</title>
<body>

<p>
Elkezdheted használni a könyvtárat a felhasználók hitelesítésére az apache/proftpd/qmail/samba-ban.
Ezt kezelheted a Webminen keresztül, ami egy igazán könnyû beállító felületet nyújt. Továbbá használhatod a gq-t vagy
directory_administrator-t is.
</p>

</body>
</section>
</chapter>

<chapter>
<title>Köszönetnyilvánítások</title>
<section>
<body>

<p>
Szeretnénk köszönetet mondani Matt Heler-nek, hogy kölcsönadta a gépét ennek a leírásnak az elkészítéséhez.
Köszönetet mondunk még a srácoknak az #ldap @ irc.freenode.net-en
</p>

</body>
</section>

</chapter>
</guide>

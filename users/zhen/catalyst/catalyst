#!/bin/bash
# Copyright 1999-2003 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo/users/zhen/catalyst/catalyst,v 1.28 2003/10/11 19:28:46 drobbins Exp $

VERSION="2.1"

source /sbin/functions.sh
source include/functions.sh
source include/build_functions.sh
[ -e files/catalyst.conf ] && source files/catalyst.conf || die "Config file files/catalyst.conf not found."


rm -f /tmp/catalyst-subarches
include/catalyst-subarches > /tmp/catalyst-subarches
source /tmp/catalyst-subarches


SNAPBALL=${SNAPDIR}/portage-${4}.tar.bz2

# unset so chroot doesn't get our custom setting
unset PORTDIR DISTDIR
[ ! -e "$MY_PORTDIR" ] && die "Portage dir $MY_PORTDIR not found, exiting."
[ ! -e "$MY_DISTDIR" ] && die "Distdir $MY_DISTDIR not found; exiting."

MY_DIST_LOCALS=${BASEDIR}/dists/${4}
install -d $MY_DIST_LOCALS
[ "$TMPDIR" = "" ] && CHROOTDIR="/var/tmp/catalyst/build/stage-${2}-${4}" || CHROOTDIR="$TMPDIR/stage-${2}-${4}"

MYPROFILEDIR="/usr/portage/profiles/${BUILDTYPE}-${MAINARCH}-${MAINVERSION}"

snap() {
	[ "$TMPDIR" = "" ] && CHROOTDIR="/var/tmp/catalyst/build/snap-${1}" || CHROOTDIR="$TMPDIR/snap-${1}"
	SNAPBALL=${SNAPDIR}/portage-${1}.tar.bz2

	install -d ${SNAPDIR}
	einfo "Cleaning up build directory..."
	rm -rf ${CHROOTDIR}
	install -d ${CHROOTDIR}
	einfo "Creating Portage tree snapshot..."	
	rsync -a --exclude /packages/ --exclude /distfiles/ --exclude CVS/ ${MY_PORTDIR}/ ${CHROOTDIR}/portage/ || die
	einfo "Creating Portage tree tarball..."
	( cd $CHROOTDIR; tar cjf ${SNAPBALL} portage ) || die
	einfo "done!"

} #end snap

#umount() {
#	einfo "Unmounting..."
#	umount_all

#} #end umount
	
enter_chroot() {
	install -d ${CHROOTDIR}
	cd ${CHROOTDIR}
	mount_all
	einfo "Chrooting to ${CHROOTDIR}..."
	$CHROOT ${CHROOTDIR}
	umount_all

} #end enter


if [ "`whoami`" != "root" ]
then
	eerror "$0: This script requires root privileges to operate."
	exit 1
fi
	
if [ -z ${MYPROFILEDIR} ]
then
	eerror "!!! Profile missing! You must 'emerge sync'"
	exit 1
fi

case "$1" in
	"-h"|"--help")
		usage
		exit 1
	;;

	"snap")
		snap $2
		exit 0
	;;
	
	"umount")
		umount
		exit 0
	;;

	"enter")
		enter_chroot
		exit 0
	;;

	*)
		usage
	;;
esac

## START MAIN PROGRAM ##

# more or less a sanity check
SUBARCH=$1
DESTSTAGE="${2}"
DESTVER="${3}"
SRCFORTAR=${CHROOTDIR}
rm -f /tmp/catalyst.settings
include/catalyst-settings $SUBARCH > /tmp/catalyst.settings
source /tmp/catalyst.settings
CFLAGS="${CFLAGS} -pipe"
echo $CFLAGS
pre_build $2 $3 $4
build $2
post_build $2

# vim ts=4

Index: widget/src/gtk2/nsWidgetFactory.cpp
===================================================================
RCS file: /home/bzbarsky/mozilla/cvs-mirror/mozilla/widget/src/gtk2/nsWidgetFactory.cpp,v
retrieving revision 1.32
diff -u -p -d -8 -r1.32 nsWidgetFactory.cpp
--- widget/src/gtk2/nsWidgetFactory.cpp	23 Feb 2006 01:01:29 -0000	1.32
+++ widget/src/gtk2/nsWidgetFactory.cpp	12 Apr 2006 00:37:36 -0000
@@ -51,16 +51,18 @@
 #include "nsClipboardHelper.h"
 #include "nsHTMLFormatConverter.h"
 #include "nsClipboard.h"
 #include "nsDragService.h"
 #include "nsFilePicker.h"
 #include "nsSound.h"
 #include "nsBidiKeyboard.h"
 #include "nsNativeKeyBindings.h"
+#include "nsIPrefService.h"
+#include "nsIPrefBranch.h"
 
 #include "nsIComponentRegistrar.h"
 #include "nsComponentManagerUtils.h"
 #include "nsAutoPtr.h"
 #include <gtk/gtk.h>
 
 /* from nsFilePicker.js */
 #define XULFILEPICKER_CID \
@@ -98,19 +100,30 @@ static NS_IMETHODIMP
 nsFilePickerConstructor(nsISupports *aOuter, REFNSIID aIID,
                         void **aResult)
 {
   *aResult = nsnull;
   if (aOuter != nsnull) {
     return NS_ERROR_NO_AGGREGATION;
   }
 
+  PRBool allowPlatformPicker = PR_TRUE;
+  nsCOMPtr<nsIPrefBranch> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
+  if (prefs) {
+    PRBool prefAllow;
+    nsresult rv = prefs->GetBoolPref("ui.allow_platform_file_picker",
+                                     &prefAllow);
+    if (NS_SUCCEEDED(rv)) {
+        allowPlatformPicker = prefAllow;
+    }
+  }
+  
   nsCOMPtr<nsIFilePicker> picker;
-  if (gtk_check_version(2,6,3) == NULL) {
-    picker = new nsFilePicker;
+  if (allowPlatformPicker && gtk_check_version(2,6,3) == NULL) {
+      picker = new nsFilePicker;
   } else {
     picker = do_CreateInstance(kXULFilePickerCID);
   }
 
   if (!picker) {
     return NS_ERROR_OUT_OF_MEMORY;
   }
 
Index: modules/libpref/src/init/all.js
===================================================================
RCS file: /home/bzbarsky/mozilla/cvs-mirror/mozilla/modules/libpref/src/init/all.js,v
retrieving revision 3.628
diff -u -p -d -8 -r3.628 all.js
--- modules/libpref/src/init/all.js	8 Apr 2006 02:35:16 -0000	3.628
+++ modules/libpref/src/init/all.js	12 Apr 2006 00:47:42 -0000
@@ -1829,16 +1829,20 @@ pref("layout.word_select.stop_at_punctua
 
 // autocomplete keyboard grab workaround
 pref("autocomplete.grab_during_popup", true);
 pref("autocomplete.ungrab_during_mode_switch", true);
 
 // turn off scrollbar snapping
 pref("slider.snapMultiplier", 0);
 
+// Default to using the system filepicker if possible, but allow
+// toggling to use the XUL filepicker
+pref("ui.allow_platform_file_picker", true);
+
 pref("helpers.global_mime_types_file", "/etc/mime.types");
 pref("helpers.global_mailcap_file", "/etc/mailcap");
 pref("helpers.private_mime_types_file", "~/.mime.types");
 pref("helpers.private_mailcap_file", "~/.mailcap");
 pref("java.global_java_version_file", "/etc/.java/versions");
 pref("java.private_java_version_file", "~/.java/versions");
 pref("java.default_java_location_solaris", "/usr/j2se");
 pref("java.default_java_location_others", "/usr/java");

#!/sbin/runscript
# Copyright 1999-2005 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo/src/embedded/baselayout-lite/image/etc/init.d/Attic/checkroot,v 1.2 2005/03/06 06:28:08 iggy Exp $

depend() {
	before *
}

start() {
	local retval=0
	
	if [ ! -f /fastboot ] ; then
		ebegin "Remounting root filesystem read-only (if necessary)"
		mount -n -o remount,ro / &>/dev/null
		eend $?

		if [ -f /forcefsck ] || get_bootparam "forcefsck" ; then
			ebegin "Checking root filesystem (full fsck forced)"
			[ -x /sbin/fsck ] && fsck -C -a -f / || einfo "No /sbin/fsck"
			# /forcefsck isn't deleted because checkfs needs it.
			# it'll be deleted in that script.
			retval=$?
		else
			if ! is_net_fs / ; then
				# Obey the fs_passno setting for / (see fstab(5))
				# - find the / entry
				# - make sure we have 6 fields
				# - see if fs_passno is something other than 0
				if [ "$(awk '/^[^#]*\/[[:space:]]/ { print $6 }' /etc/fstab)" -eq "0" ] ; then
					ebegin "Checking root filesystem"
					[ -x /sbin/fsck ] && fsck -C -T -a / || einfo "No /sbin/fsck"
					retval=$?
				else
					ebegin "Skipping root filesystem check (fstab's passno == 0)"
					retval=0
				fi
			else
				ebegin "Skipping root filesystem check (networked)"
				retval=0
			fi
		fi

		if [ ${retval} -eq 0 ] ; then
			eend 0
		elif [ ${retval} -eq 1 ] ; then
			ewend 1 "Filesystem repaired"
		elif [ ${retval} -eq 2 ] || [ ${retval} -eq 3 ] ; then
			ewend 1 "Filesystem repaired, but reboot needed!"
			echo -ne "\a"; sleep 1; echo -ne "\a"; sleep 1
			echo -ne "\a"; sleep 1; echo -ne "\a"; sleep 1
			ewarn "Rebooting in 10 seconds ..."
			sleep 10
			einfo "Rebooting"
			/sbin/reboot -d 1
		else
			eend 2 "Filesystem couldn't be fixed :("
			/sbin/sulogin ${CONSOLE}
			einfo "Unmounting filesystems"
			/bin/mount -n -a -o remount,ro &>/dev/null
			einfo "Rebooting"
			/sbin/reboot -d 1
		fi
	fi

	# Should we mount root rw ?
	mount -n -t proc proc /proc
	if [ "$(grep rootfs /proc/mounts | cut -f4 -d' ')" = "rw" ] ; then
		ebegin "Remounting root filesystem read/write"
		mount -n -o remount,rw / &>/dev/null

		# FIXME should this be here?
		rm -rf /var/lib/init.d/started/*

		if [ "$?" -ne 0 ]
		then
			eend 2 "Root filesystem could not be mounted read/write :("
			/sbin/sulogin ${CONSOLE}
		else
			eend 0
		fi
	fi
}


# vim:ts=4

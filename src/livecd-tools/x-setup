#!/bin/bash
# Copyright 1999-2004 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo/src/livecd-tools/x-setup,v 1.11 2005/03/01 01:26:08 wolf31o2 Exp $

# Check for an xorg.conf
if [ ! -e /etc/X11/xorg.conf ]
then
	echo "ERROR: /etc/X11/xorg.conf cannot be found! Exiting"
	exit 1
fi

#first, get paths right if we're getting started b4 login
source /etc/profile

echo "0" > /proc/sys/kernel/printk
CMDLINE="`cat /proc/cmdline`"
for x in $CMDLINE
do
        if [ "$x" = "agpgart" ]
        then
			modprobe agpgart > /dev/null 2>&1
        fi
done

no_gl() {
	echo "No OpenGL-capable card found."
	GLTYPE=xorg-x11
}

get_video_cards() {
	VIDEO_CARDS=`/sbin/lspci | grep VGA`
	NUM_CARDS=`echo ${VIDEO_CARDS} | wc -l`
	if [ ${NUM_CARDS} -eq 1 ]; then
		NVIDIA=`echo ${VIDEO_CARDS} | grep "nVidia Corporation"`
		ATI=`echo ${VIDEO_CARDS} | grep "ATI Technologies"`
		if [ -n "${NVIDIA}" ]; then
			NVIDIA_CARD=`echo ${NVIDIA} | awk 'BEGIN {RS=" "} /NV[0-9]+/ {print $1}'`
			if [ -n "${NVIDIA_CARD}" ]; then
				if [ `echo ${NVIDIA_CARD} | cut -dV -f2` -ge 4 ]; then
					echo "NVIDIA card detected."
					GLTYPE=nvidia
				else
					no_gl
				fi
			else
				no_gl
			fi
		elif [ -n "${ATI}" ]; then
			ATI_CARD=`echo ${ATI} | awk 'BEGIN {RS=" "} /(R|RV|RS)\d{3}/ {print $1}'`
			if [ -n "${ATI_CARD}" ]; then
				if [ `echo ${ATI_CARD} | cut -dS -f2` -ge 350 ] || \
					[ `echo ${ATI_CARD} | cut -dV -f2` -ge 250 ] || \
					[ `echo ${ATI_CARD} | cut -dR -f2` -ge 200 ]; then
						echo "ATI card detected."
						GLTYPE=ati
				else
					no_gl
				fi
			else
				no_gl
			fi
		else
			no_gl
		fi
	fi
}

get_video_cards

if [ -x /usr/sbin/opengl-update-livecd ]
then
	/usr/sbin/opengl-update-livecd $GLTYPE
else
	opengl-update $GLTYPE
fi

#exec /usr/bin/xinit

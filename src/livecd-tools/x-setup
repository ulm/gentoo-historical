#!/bin/bash
# Copyright 1999-2004 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo/src/livecd-tools/x-setup,v 1.12 2005/03/01 18:13:51 wolf31o2 Exp $

# Check for an xorg.conf
if [ ! -e /etc/X11/xorg.conf ]
then
	echo "ERROR: /etc/X11/xorg.conf cannot be found! Exiting"
	exit 1
fi

#first, get paths right if we're getting started b4 login
source /etc/profile

echo "0" > /proc/sys/kernel/printk
CMDLINE="`cat /proc/cmdline`"
for x in $CMDLINE
do
        if [ "$x" = "agpgart" ]
        then
			modprobe agpgart > /dev/null 2>&1
        fi
done

no_gl() {
	echo "No OpenGL-capable card found."
	GLTYPE=xorg-x11
}

ati_gl() {
	echo "ATI card detected."
	GLTYPE=ati
}

nv_gl() {
	echo "NVIDIA card detected."
	GLTYPE=nvidia
}

get_video_cards() {
	VIDEO_CARDS=`/sbin/lspci | grep VGA`
	NUM_CARDS=`echo ${VIDEO_CARDS} | wc -l`
	if [ ${NUM_CARDS} -eq 1 ]; then
		NVIDIA=`echo ${VIDEO_CARDS} | grep "nVidia Corporation"`
		ATI=`echo ${VIDEO_CARDS} | grep "ATI Technologies"`
		if [ -n "${NVIDIA}" ]; then
			NVIDIA_CARD=`echo ${NVIDIA} | awk 'BEGIN {RS=" "} /NV[0-9]+/ {print $1}'`
			if [ -n "${NVIDIA_CARD}" ]; then
				if [ `echo ${NVIDIA_CARD} | cut -dV -f2` -ge 4 ]; then
					nv_gl
				else
					no_gl
				fi
			else
				no_gl
			fi
		elif [ -n "${ATI}" ]; then
			ATI_CARD=`echo ${ATI} | awk 'BEGIN {RS=" "} /(R|RV|RS)[0-9]+/ {print $1}'`
			if [ `echo ${ATI_CARD} | grep S` ]; then
				ATI_CARD_S=`echo ${ATI_CARD} | cut -dS -f2`
			elif [ `echo ${ATI_CARD} | grep V` ]; then
				ATI_CARD_V=`echo ${ATI_CARD} | cut -dV -f2`
			else
				ATI_CARD=`echo ${ATI_CARD} | cut -dR -f2`
			fi
			if [ -n "${ATI_CARD_S}" ] && [ ${ATI_CARD_S} -ge 350 ]; then
				ati_gl
			elif [ -n "${ATI_CARD_V}" ] && [ ${ATI_CARD_V} -ge 250 ]; then
				ati_gl
			elif [ -n "${ATI_CARD}" ] && [ ${ATI_CARD} -ge 200 ]; then
				ati_gl
			else
				no_gl
			fi
		else
			no_gl
		fi
	fi
}

get_video_cards

if [ -x /usr/sbin/opengl-update-livecd ]
then
	/usr/sbin/opengl-update-livecd $GLTYPE
elif [ -x /usr/sbin/opengl-update ]
then
	opengl-update $GLTYPE
else
	echo "ERROR: no opengl-update script can be located"
	exit 1
fi

#exec /usr/bin/xinit
